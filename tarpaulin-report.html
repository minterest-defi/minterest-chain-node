<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
}

.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","lut1k","Projects","minterest-chain-node","cli","build.rs"],"content":"use substrate_build_script_utils::{generate_cargo_keys, rerun_if_git_head_changed};\n\nfn main() {\n\tgenerate_cargo_keys();\n\n\trerun_if_git_head_changed();\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","cli","src","cli.rs"],"content":"use sc_cli::RunCmd;\nuse structopt::StructOpt;\n\n#[derive(Debug, StructOpt)]\npub struct Cli {\n\t#[structopt(subcommand)]\n\tpub subcommand: Option\u003cSubcommand\u003e,\n\n\t#[structopt(flatten)]\n\tpub run: RunCmd,\n}\n\n#[derive(Debug, StructOpt)]\npub enum Subcommand {\n\t/// Build a chain specification.\n\tBuildSpec(sc_cli::BuildSpecCmd),\n\n\t/// Validate blocks.\n\tCheckBlock(sc_cli::CheckBlockCmd),\n\n\t/// Export blocks.\n\tExportBlocks(sc_cli::ExportBlocksCmd),\n\n\t/// Export the state of a given block into a chain spec.\n\tExportState(sc_cli::ExportStateCmd),\n\n\t/// Import blocks.\n\tImportBlocks(sc_cli::ImportBlocksCmd),\n\n\t/// Remove the whole chain.\n\tPurgeChain(sc_cli::PurgeChainCmd),\n\n\t/// Revert the chain to a previous state.\n\tRevert(sc_cli::RevertCmd),\n\n\t/// The custom benchmark subcommmand benchmarking runtime pallets.\n\t#[structopt(name = \"benchmark\", about = \"Benchmark runtime pallets.\")]\n\tBenchmark(frame_benchmarking_cli::BenchmarkCmd),\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","cli","src","command.rs"],"content":"// This file is part of Substrate.\n\n// Copyright (C) 2017-2020 Parity Technologies (UK) Ltd.\n// SPDX-License-Identifier: Apache-2.0\n\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// \thttp://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nuse crate::cli::{Cli, Subcommand};\nuse node_minterest_runtime::Block;\nuse sc_cli::{ChainSpec, Role, RuntimeVersion, SubstrateCli};\nuse sc_service::PartialComponents;\nuse service::{self, chain_spec};\n\nimpl SubstrateCli for Cli {\n\tfn impl_name() -\u003e String {\n\t\t\"Substrate Node\".into()\n\t}\n\n\tfn impl_version() -\u003e String {\n\t\tenv!(\"SUBSTRATE_CLI_IMPL_VERSION\").into()\n\t}\n\n\tfn description() -\u003e String {\n\t\tenv!(\"CARGO_PKG_DESCRIPTION\").into()\n\t}\n\n\tfn author() -\u003e String {\n\t\tenv!(\"CARGO_PKG_AUTHORS\").into()\n\t}\n\n\tfn support_url() -\u003e String {\n\t\t\"support.anonymous.an\".into()\n\t}\n\n\tfn copyright_start_year() -\u003e i32 {\n\t\t2017\n\t}\n\n\tfn load_spec(\u0026self, id: \u0026str) -\u003e Result\u003cBox\u003cdyn sc_service::ChainSpec\u003e, String\u003e {\n\t\tOk(match id {\n\t\t\t\"dev\" =\u003e Box::new(chain_spec::development_config()?),\n\t\t\t\"local\" =\u003e Box::new(chain_spec::local_testnet_config()?),\n\t\t\t\"\" | \"turbo-latest\" =\u003e Box::new(chain_spec::minterest_turbo_testnet_config()?),\n\t\t\tpath =\u003e Box::new(chain_spec::ChainSpec::from_json_file(std::path::PathBuf::from(path))?),\n\t\t})\n\t}\n\n\tfn native_runtime_version(_: \u0026Box\u003cdyn ChainSpec\u003e) -\u003e \u0026'static RuntimeVersion {\n\t\t\u0026node_minterest_runtime::VERSION\n\t}\n}\n\n/// Parse and run command line arguments\npub fn run() -\u003e sc_cli::Result\u003c()\u003e {\n\tlet cli = Cli::from_args();\n\n\tmatch \u0026cli.subcommand {\n\t\tSome(Subcommand::BuildSpec(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.sync_run(|config| cmd.run(config.chain_spec, config.network))\n\t\t}\n\t\tSome(Subcommand::CheckBlock(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient,\n\t\t\t\t\ttask_manager,\n\t\t\t\t\timport_queue,\n\t\t\t\t\t..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, import_queue), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::ExportBlocks(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient, task_manager, ..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, config.database), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::ExportState(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient, task_manager, ..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, config.chain_spec), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::ImportBlocks(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient,\n\t\t\t\t\ttask_manager,\n\t\t\t\t\timport_queue,\n\t\t\t\t\t..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, import_queue), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::PurgeChain(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.sync_run(|config| cmd.run(config.database))\n\t\t}\n\t\tSome(Subcommand::Revert(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient,\n\t\t\t\t\ttask_manager,\n\t\t\t\t\tbackend,\n\t\t\t\t\t..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, backend), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::Benchmark(cmd)) =\u003e {\n\t\t\tif cfg!(feature = \"runtime-benchmarks\") {\n\t\t\t\tlet runner = cli.create_runner(cmd)?;\n\n\t\t\t\trunner.sync_run(|config| cmd.run::\u003cBlock, service::Executor\u003e(config))\n\t\t\t} else {\n\t\t\t\tErr(\"Benchmarking wasn't enabled when building the node. \\\n\t\t\t\tYou can enable it with `--features runtime-benchmarks`.\"\n\t\t\t\t\t.into())\n\t\t\t}\n\t\t}\n\t\tNone =\u003e {\n\t\t\tlet runner = cli.create_runner(\u0026cli.run)?;\n\t\t\trunner.run_node_until_exit(|config| match config.role {\n\t\t\t\tRole::Light =\u003e service::new_light(config),\n\t\t\t\t_ =\u003e service::new_full(config),\n\t\t\t})\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","cli","src","lib.rs"],"content":"#[cfg(feature = \"cli\")]\nmod cli;\n#[cfg(feature = \"cli\")]\nmod command;\n\n#[cfg(feature = \"cli\")]\npub use cli::*;\n\n#[cfg(feature = \"cli\")]\npub use command::*;\n\n#[cfg(feature = \"cli\")]\npub use sc_cli::{Error, Result};\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","auction","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn bid_collateral_auction() -\u003e Weight {\n\t\t(493_957_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(12 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(12 as Weight))\n\t}\n\tfn bid_surplus_auction() -\u003e Weight {\n\t\t(257_830_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(6 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(5 as Weight))\n\t}\n\tfn bid_debit_auction() -\u003e Weight {\n\t\t(287_271_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(7 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(8 as Weight))\n\t}\n\tfn on_finalize(c: u32) -\u003e Weight {\n\t\t(50_992_000 as Weight)\n\t\t\t.saturating_add((171_653_000 as Weight).saturating_mul(c as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads((4 as Weight).saturating_mul(c as Weight)))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes((3 as Weight).saturating_mul(c as Weight)))\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","auction","src","lib.rs"],"content":"//! # Auction\n//!\n//! ## Overview\n//!\n//! This module provides a basic abstraction to implement on-chain auctioning\n//! feature.\n//!\n//! The auction logic can be customized by implement and supplying\n//! `AuctionHandler` trait.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// Disable the following two lints since they originate from an external macro (namely decl_storage)\n#![allow(clippy::string_lit_as_bytes)]\n\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, ensure, weights::Weight, IterableStorageDoubleMap, Parameter,\n};\nuse frame_system::ensure_signed;\nuse orml_traits::{Auction, AuctionHandler, AuctionInfo, Change};\nuse sp_runtime::{\n\ttraits::{AtLeast32BitUnsigned, Bounded, MaybeSerializeDeserialize, Member, One, Zero},\n\tDispatchError, DispatchResult,\n};\nuse sp_std::result;\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn bid_collateral_auction() -\u003e Weight;\n\tfn bid_surplus_auction() -\u003e Weight;\n\tfn bid_debit_auction() -\u003e Weight;\n\tfn on_finalize(c: u32) -\u003e Weight;\n}\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// The balance type for bidding\n\ttype Balance: Parameter + Member + AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize;\n\n\t/// The auction ID type\n\ttype AuctionId: Parameter + Member + AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize + Bounded;\n\n\t/// The `AuctionHandler` that allow custom bidding logic and handles auction\n\t/// result\n\ttype Handler: AuctionHandler\u003cSelf::AccountId, Self::Balance, Self::BlockNumber, Self::AuctionId\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\t\u003cT as Trait\u003e::Balance,\n\t\t\u003cT as Trait\u003e::AuctionId,\n\t{\n\t\t/// A bid is placed. [auction_id, bidder, bidding_amount]\n\t\tBid(AuctionId, AccountId, Balance),\n\t}\n);\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Auction {\n\t\t/// Stores on-going and future auctions. Closed auction are removed.\n\t\tpub Auctions get(fn auctions): map hasher(twox_64_concat) T::AuctionId =\u003e Option\u003cAuctionInfo\u003cT::AccountId, T::Balance, T::BlockNumber\u003e\u003e;\n\n\t\t/// Track the next auction ID.\n\t\tpub AuctionsIndex get(fn auctions_index): T::AuctionId;\n\n\t\t/// Index auctions by end time.\n\t\tpub AuctionEndTime get(fn auction_end_time): double_map hasher(twox_64_concat) T::BlockNumber, hasher(twox_64_concat) T::AuctionId =\u003e Option\u003c()\u003e;\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Bid an auction.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t///     - T::Handler is module_auction_manager of Acala\n\t\t///     - Indirectly needs orml_currencies and module_cdp_treasury of Acala\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads:\n\t\t///     - collateral auction:\n\t\t///             - best cases: 7\n\t\t///             - worst cases: 14\n\t\t///     - surplus auction:\n\t\t///             - best cases: 5\n\t\t///             - worst cases: 6\n\t\t///     - debit auction:\n\t\t///             - best cases: 8\n\t\t///             - worst cases: 7\n\t\t/// - Db writes:\n\t\t///     - collateral auction:\n\t\t///             - best cases: 7\n\t\t///             - worst cases: 14\n\t\t///     - surplus auction:\n\t\t///             - best cases: 3\n\t\t///             - worst cases: 5\n\t\t///     - debit auction:\n\t\t///             - best cases: 8\n\t\t///             - worst cases: 8\n\t\t/// -------------------\n\t\t/// Base Weight:\n\t\t///     - collateral auction:\n\t\t///             - best cases: 134 µs\n\t\t///             - worst cases: 300.4 µs\n\t\t///     - surplus auction:\n\t\t///             - best cases: 97.9 µs\n\t\t///             - worst cases: 157.6 µs\n\t\t///     - debit auction:\n\t\t///             - best cases: 140.7 µs\n\t\t///             - worst cases: 142.8 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::bid_collateral_auction()]\n\t\tpub fn bid(origin, id: T::AuctionId, #[compact] value: T::Balance) {\n\t\t\tlet from = ensure_signed(origin)?;\n\n\t\t\t\u003cAuctions\u003cT\u003e\u003e::try_mutate_exists(id, |auction| -\u003e DispatchResult {\n\t\t\t\tlet mut auction = auction.as_mut().ok_or(Error::\u003cT\u003e::AuctionNotExist)?;\n\n\t\t\t\tlet block_number = \u003cframe_system::Module\u003cT\u003e\u003e::block_number();\n\n\t\t\t\t// make sure auction is started\n\t\t\t\tensure!(block_number \u003e= auction.start, Error::\u003cT\u003e::AuctionNotStarted);\n\n\t\t\t\tif let Some(ref current_bid) = auction.bid {\n\t\t\t\t\tensure!(value \u003e current_bid.1, Error::\u003cT\u003e::InvalidBidPrice);\n\t\t\t\t} else {\n\t\t\t\t\tensure!(!value.is_zero(), Error::\u003cT\u003e::InvalidBidPrice);\n\t\t\t\t}\n\t\t\t\tlet bid_result = T::Handler::on_new_bid(\n\t\t\t\t\tblock_number,\n\t\t\t\t\tid,\n\t\t\t\t\t(from.clone(), value),\n\t\t\t\t\tauction.bid.clone(),\n\t\t\t\t);\n\n\t\t\t\tensure!(bid_result.accept_bid, Error::\u003cT\u003e::BidNotAccepted);\n\t\t\t\tmatch bid_result.auction_end_change {\n\t\t\t\t\tChange::NewValue(new_end) =\u003e {\n\t\t\t\t\t\tif let Some(old_end_block) = auction.end {\n\t\t\t\t\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::remove(\u0026old_end_block, id);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif let Some(new_end_block) = new_end {\n\t\t\t\t\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::insert(\u0026new_end_block, id, ());\n\t\t\t\t\t\t}\n\t\t\t\t\t\tauction.end = new_end;\n\t\t\t\t\t},\n\t\t\t\t\tChange::NoChange =\u003e {},\n\t\t\t\t}\n\t\t\t\tauction.bid = Some((from.clone(), value));\n\n\t\t\t\tOk(())\n\t\t\t})?;\n\n\t\t\tSelf::deposit_event(RawEvent::Bid(id, from, value));\n\t\t}\n\n\t\t/// dummy `on_initialize` to return the weight used in `on_finalize`.\n\t\tfn on_initialize(now: T::BlockNumber) -\u003e Weight {\n\t\t\tT::WeightInfo::on_finalize(\u003cAuctionEndTime\u003cT\u003e\u003e::iter_prefix(\u0026now).count() as u32)\n\t\t}\n\n\t\tfn on_finalize(now: T::BlockNumber) {\n\t\t\tSelf::_on_finalize(now);\n\t\t}\n\t}\n}\n\ndecl_error! {\n\t/// Error for auction module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\tAuctionNotExist,\n\t\tAuctionNotStarted,\n\t\tBidNotAccepted,\n\t\tInvalidBidPrice,\n\t\tNoAvailableAuctionId,\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tfn _on_finalize(now: T::BlockNumber) {\n\t\tfor (auction_id, _) in \u003cAuctionEndTime\u003cT\u003e\u003e::drain_prefix(\u0026now) {\n\t\t\tif let Some(auction) = \u003cAuctions\u003cT\u003e\u003e::take(\u0026auction_id) {\n\t\t\t\tT::Handler::on_auction_ended(auction_id, auction.bid);\n\t\t\t}\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e Auction\u003cT::AccountId, T::BlockNumber\u003e for Module\u003cT\u003e {\n\ttype AuctionId = T::AuctionId;\n\ttype Balance = T::Balance;\n\n\tfn auction_info(id: Self::AuctionId) -\u003e Option\u003cAuctionInfo\u003cT::AccountId, Self::Balance, T::BlockNumber\u003e\u003e {\n\t\tSelf::auctions(id)\n\t}\n\n\tfn update_auction(\n\t\tid: Self::AuctionId,\n\t\tinfo: AuctionInfo\u003cT::AccountId, Self::Balance, T::BlockNumber\u003e,\n\t) -\u003e DispatchResult {\n\t\tlet auction = \u003cAuctions\u003cT\u003e\u003e::get(id).ok_or(Error::\u003cT\u003e::AuctionNotExist)?;\n\t\tif let Some(old_end) = auction.end {\n\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::remove(\u0026old_end, id);\n\t\t}\n\t\tif let Some(new_end) = info.end {\n\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::insert(\u0026new_end, id, ());\n\t\t}\n\t\t\u003cAuctions\u003cT\u003e\u003e::insert(id, info);\n\t\tOk(())\n\t}\n\n\tfn new_auction(\n\t\tstart: T::BlockNumber,\n\t\tend: Option\u003cT::BlockNumber\u003e,\n\t) -\u003e result::Result\u003cSelf::AuctionId, DispatchError\u003e {\n\t\tlet auction = AuctionInfo { bid: None, start, end };\n\t\tlet auction_id = \u003cAuctionsIndex\u003cT\u003e\u003e::try_mutate(|n| -\u003e result::Result\u003cSelf::AuctionId, DispatchError\u003e {\n\t\t\tlet id = *n;\n\t\t\tensure!(id != Self::AuctionId::max_value(), Error::\u003cT\u003e::NoAvailableAuctionId);\n\t\t\t*n += One::one();\n\t\t\tOk(id)\n\t\t})?;\n\t\t\u003cAuctions\u003cT\u003e\u003e::insert(auction_id, auction);\n\t\tif let Some(end_block) = end {\n\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::insert(\u0026end_block, auction_id, ());\n\t\t}\n\n\t\tOk(auction_id)\n\t}\n\n\tfn remove_auction(id: Self::AuctionId) {\n\t\tif let Some(auction) = \u003cAuctions\u003cT\u003e\u003e::take(\u0026id) {\n\t\t\tif let Some(end_block) = auction.end {\n\t\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::remove(end_block, id);\n\t\t\t}\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","auction","src","mock.rs"],"content":"//! Mocks for the auction module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse orml_traits::OnNewBidResult;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod auction {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\tauction\u003cT\u003e,\n\t}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\npub type Balance = u64;\npub type BlockNumber = u64;\npub type AuctionId = u64;\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = ();\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\npub struct Handler;\n\nimpl AuctionHandler\u003cAccountId, Balance, BlockNumber, AuctionId\u003e for Handler {\n\tfn on_new_bid(\n\t\tnow: BlockNumber,\n\t\t_id: AuctionId,\n\t\tnew_bid: (AccountId, Balance),\n\t\t_last_bid: Option\u003c(AccountId, Balance)\u003e,\n\t) -\u003e OnNewBidResult\u003cBlockNumber\u003e {\n\t\tif new_bid.0 == ALICE {\n\t\t\tOnNewBidResult {\n\t\t\t\taccept_bid: true,\n\t\t\t\tauction_end_change: Change::NewValue(Some(now + BID_EXTEND_BLOCK)),\n\t\t\t}\n\t\t} else {\n\t\t\tOnNewBidResult {\n\t\t\t\taccept_bid: false,\n\t\t\t\tauction_end_change: Change::NoChange,\n\t\t\t}\n\t\t}\n\t}\n\n\tfn on_auction_ended(_id: AuctionId, _winner: Option\u003c(AccountId, Balance)\u003e) {}\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype AuctionId = AuctionId;\n\ttype Handler = Handler;\n\ttype WeightInfo = ();\n}\npub type AuctionModule = Module\u003cRuntime\u003e;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const BID_EXTEND_BLOCK: BlockNumber = 10;\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","auction","src","tests.rs"],"content":"//! Unit tests for the tokens module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok, traits::OnFinalize};\nuse mock::*;\n\n#[test]\nfn new_auction_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t});\n}\n\n#[test]\nfn update_auction_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_noop!(\n\t\t\tAuctionModule::update_auction(\n\t\t\t\t1,\n\t\t\t\tAuctionInfo {\n\t\t\t\t\tbid: Some((ALICE, 100)),\n\t\t\t\t\tstart: 10,\n\t\t\t\t\tend: Some(100)\n\t\t\t\t}\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::AuctionNotExist,\n\t\t);\n\t\tassert_ok!(AuctionModule::update_auction(\n\t\t\t0,\n\t\t\tAuctionInfo {\n\t\t\t\tbid: Some((ALICE, 100)),\n\t\t\t\tstart: 10,\n\t\t\t\tend: Some(100)\n\t\t\t}\n\t\t));\n\t});\n}\n\n#[test]\nfn auction_info_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_eq!(\n\t\t\tAuctionModule::auction_info(0),\n\t\t\tSome(AuctionInfo {\n\t\t\t\tbid: None,\n\t\t\t\tstart: 10,\n\t\t\t\tend: Some(100)\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn bid_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\t\tassert_ok!(AuctionModule::new_auction(0, Some(5)), 0);\n\t\tassert_eq!(\n\t\t\tAuctionModule::auction_info(0),\n\t\t\tSome(AuctionInfo {\n\t\t\t\tbid: None,\n\t\t\t\tstart: 0,\n\t\t\t\tend: Some(5)\n\t\t\t})\n\t\t);\n\t\tassert_ok!(AuctionModule::bid(Origin::signed(ALICE), 0, 20));\n\t\tlet bid_event = TestEvent::auction(RawEvent::Bid(0, ALICE, 20));\n\t\tassert!(System::events().iter().any(|record| record.event == bid_event));\n\t\tassert_eq!(\n\t\t\tAuctionModule::auction_info(0),\n\t\t\tSome(AuctionInfo {\n\t\t\t\tbid: Some((ALICE, 20)),\n\t\t\t\tstart: 0,\n\t\t\t\tend: Some(11)\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn bid_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_ok!(AuctionModule::new_auction(0, Some(100)), 1);\n\t\tassert_noop!(\n\t\t\tAuctionModule::bid(Origin::signed(ALICE), 0, 20),\n\t\t\tError::\u003cRuntime\u003e::AuctionNotStarted\n\t\t);\n\t\tassert_noop!(\n\t\t\tAuctionModule::bid(Origin::signed(BOB), 1, 20),\n\t\t\tError::\u003cRuntime\u003e::BidNotAccepted,\n\t\t);\n\t\tassert_noop!(\n\t\t\tAuctionModule::bid(Origin::signed(ALICE), 1, 0),\n\t\t\tError::\u003cRuntime\u003e::InvalidBidPrice,\n\t\t);\n\t});\n}\n\n#[test]\nfn remove_auction_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_eq!(AuctionModule::auctions_index(), 1);\n\t\tassert_eq!(AuctionModule::auctions(0).is_some(), true);\n\t\tassert_eq!(AuctionModule::auction_end_time(100, 0), Some(()));\n\t\tAuctionModule::remove_auction(0);\n\t\tassert_eq!(AuctionModule::auctions(0), None);\n\t\tassert_eq!(AuctionModule::auction_end_time(100, 0), None);\n\t});\n}\n\n#[test]\nfn cleanup_auction_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_eq!(AuctionModule::auctions_index(), 1);\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(50)), 1);\n\t\tassert_eq!(AuctionModule::auctions_index(), 2);\n\t\tassert_eq!(AuctionModule::auctions(0).is_some(), true);\n\t\tassert_eq!(AuctionModule::auctions(1).is_some(), true);\n\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(0).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(50).count(), 1);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(100).count(), 1);\n\n\t\tAuctionModule::on_finalize(50);\n\t\tassert_eq!(AuctionModule::auctions(0).is_some(), true);\n\t\tassert_eq!(AuctionModule::auctions(1).is_some(), false);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(0).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(50).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(100).count(), 1);\n\n\t\tAuctionModule::on_finalize(100);\n\t\tassert_eq!(AuctionModule::auctions(0).is_some(), false);\n\t\tassert_eq!(AuctionModule::auctions(1).is_some(), false);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(0).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(50).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(100).count(), 0);\n\t});\n}\n\n#[test]\nfn cannot_add_new_auction_when_no_available_id() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t\u003cAuctionsIndex\u003cRuntime\u003e\u003e::put(AuctionId::max_value());\n\t\tassert_noop!(\n\t\t\tAuctionModule::new_auction(0, None),\n\t\t\tError::\u003cRuntime\u003e::NoAvailableAuctionId\n\t\t);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","authority","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn dispatch_as() -\u003e Weight {\n\t\t(43_132_000 as Weight)\n\t}\n\tfn schedule_dispatch_without_delay() -\u003e Weight {\n\t\t(123_715_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n\tfn schedule_dispatch_with_delay() -\u003e Weight {\n\t\t(116_719_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n\tfn fast_track_scheduled_dispatch() -\u003e Weight {\n\t\t(59_055_000 as Weight)\n\t}\n\tfn delay_scheduled_dispatch() -\u003e Weight {\n\t\t(44_796_000 as Weight)\n\t}\n\tfn cancel_scheduled_dispatch() -\u003e Weight {\n\t\t(140_123_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","authority","src","lib.rs"],"content":"//! # Authority\n//! A module to provide features for governance including dispatch method on\n//! behalf of other accounts and schedule dispatchables.\n//!\n//! - [`Trait`](./trait.Trait.html)\n//! - [`Call`](./enum.Call.html)\n//! - [`Module`](./struct.Module.html)\n//!\n//! ## Overview\n//!\n//! Two functionalities are provided by this module:\n//! - schedule a dispatchable\n//! - dispatch method with on behalf of other origins\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// Disable the following three lints since they originate from an external macro\n#![allow(clippy::string_lit_as_bytes)]\n#![allow(clippy::boxed_local)]\n#![allow(clippy::borrowed_box)]\n\nuse codec::{Decode, Encode};\nuse frame_support::weights::Weight;\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage,\n\tdispatch::PostDispatchInfo,\n\ttraits::{\n\t\tschedule::{DispatchTime, Named as ScheduleNamed, Priority},\n\t\tEnsureOrigin, Get, IsType, OriginTrait,\n\t},\n\tweights::GetDispatchInfo,\n\tParameter,\n};\nuse sp_runtime::{\n\ttraits::{CheckedSub, Dispatchable, Saturating},\n\tDispatchError, DispatchResult, RuntimeDebug,\n};\nuse sp_std::prelude::*;\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn dispatch_as() -\u003e Weight;\n\tfn schedule_dispatch_without_delay() -\u003e Weight;\n\tfn schedule_dispatch_with_delay() -\u003e Weight;\n\tfn fast_track_scheduled_dispatch() -\u003e Weight;\n\tfn delay_scheduled_dispatch() -\u003e Weight;\n\tfn cancel_scheduled_dispatch() -\u003e Weight;\n}\n\n/// A delayed origin. Can only be dispatched via `dispatch_as` with a delay.\n#[derive(PartialEq, Eq, Clone, RuntimeDebug, Encode, Decode)]\npub struct DelayedOrigin\u003cBlockNumber, PalletsOrigin\u003e {\n\t/// Number of blocks that this call have been delayed.\n\tpub delay: BlockNumber,\n\t/// The initial origin.\n\tpub origin: Box\u003cPalletsOrigin\u003e,\n}\n\n/// Ensure the origin have a minimum amount of delay.\npub struct EnsureDelayed\u003cDelay, Inner, BlockNumber, PalletsOrigin\u003e(\n\tsp_std::marker::PhantomData\u003c(Delay, Inner, BlockNumber, PalletsOrigin)\u003e,\n);\nimpl\u003c\n\t\tPalletsOrigin: Into\u003cO\u003e,\n\t\tO: Into\u003cResult\u003cDelayedOrigin\u003cBlockNumber, PalletsOrigin\u003e, O\u003e\u003e + From\u003cDelayedOrigin\u003cBlockNumber, PalletsOrigin\u003e\u003e,\n\t\tDelay: Get\u003cBlockNumber\u003e,\n\t\tInner: EnsureOrigin\u003cO\u003e,\n\t\tBlockNumber: PartialOrd,\n\t\u003e EnsureOrigin\u003cO\u003e for EnsureDelayed\u003cDelay, Inner, BlockNumber, PalletsOrigin\u003e\n{\n\ttype Success = Inner::Success;\n\n\tfn try_origin(o: O) -\u003e Result\u003cSelf::Success, O\u003e {\n\t\to.into().and_then(|delayed_origin| {\n\t\t\tif delayed_origin.delay \u003e= Delay::get() {\n\t\t\t\tlet pallets_origin = *delayed_origin.origin;\n\t\t\t\tInner::try_origin(pallets_origin.into())\n\t\t\t} else {\n\t\t\t\tErr(delayed_origin.into())\n\t\t\t}\n\t\t})\n\t}\n\n\t#[cfg(feature = \"runtime-benchmarks\")]\n\tfn successful_origin() -\u003e O {\n\t\tunimplemented!()\n\t}\n}\n\n/// Origin for the authority module.\npub type Origin\u003cT\u003e = DelayedOrigin\u003c\u003cT as frame_system::Trait\u003e::BlockNumber, \u003cT as Trait\u003e::PalletsOrigin\u003e;\n\n/// Config for orml-authority\npub trait AuthorityConfig\u003cOrigin, PalletsOrigin, BlockNumber\u003e {\n\t/// Check if the `origin` is allowed to schedule a dispatchable call with a\n\t/// given `priority`.\n\tfn check_schedule_dispatch(origin: Origin, priority: Priority) -\u003e DispatchResult;\n\t/// Check if the `origin` is allow to fast track a scheduled task that\n\t/// initially created by `initial_origin`. `new_delay` is number of blocks\n\t/// this dispatchable will be dispatched from now after fast track.\n\tfn check_fast_track_schedule(\n\t\torigin: Origin,\n\t\tinitial_origin: \u0026PalletsOrigin,\n\t\tnew_delay: BlockNumber,\n\t) -\u003e DispatchResult;\n\t/// Check if the `origin` is allow to delay a scheduled task that initially\n\t/// created by `inital_origin`.\n\tfn check_delay_schedule(origin: Origin, initial_origin: \u0026PalletsOrigin) -\u003e DispatchResult;\n\t/// Check if the `origin` is allow to cancel a scheduled task that initially\n\t/// created by `inital_origin`.\n\tfn check_cancel_schedule(origin: Origin, initial_origin: \u0026PalletsOrigin) -\u003e DispatchResult;\n}\n\n/// Represent an origin that can be dispatched by other origins with permission\n/// check.\npub trait AsOriginId\u003cOrigin, PalletsOrigin\u003e {\n\t/// Convert into `PalletsOrigin`\n\tfn into_origin(self) -\u003e PalletsOrigin;\n\t/// Check if the `origin` is allow to dispatch call on behalf of this\n\t/// origin.\n\tfn check_dispatch_from(\u0026self, origin: Origin) -\u003e DispatchResult;\n}\n\ntype CallOf\u003cT\u003e = \u003cT as Trait\u003e::Call;\n\n/// The schedule task index type.\npub type ScheduleTaskIndex = u32;\n\n/// orml-authority configuration trait.\npub trait Trait: frame_system::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// The outer origin type.\n\ttype Origin: From\u003cDelayedOrigin\u003cSelf::BlockNumber, \u003cSelf as Trait\u003e::PalletsOrigin\u003e\u003e\n\t\t+ IsType\u003c\u003cSelf as frame_system::Trait\u003e::Origin\u003e\n\t\t+ OriginTrait\u003cPalletsOrigin = Self::PalletsOrigin\u003e;\n\n\t/// The caller origin, overarching type of all pallets origins.\n\ttype PalletsOrigin: Parameter + Into\u003c\u003cSelf as frame_system::Trait\u003e::Origin\u003e;\n\n\t/// The aggregated call type.\n\ttype Call: Parameter\n\t\t+ Dispatchable\u003cOrigin = \u003cSelf as frame_system::Trait\u003e::Origin, PostInfo = PostDispatchInfo\u003e\n\t\t+ GetDispatchInfo;\n\n\t/// The Scheduler.\n\ttype Scheduler: ScheduleNamed\u003cSelf::BlockNumber, \u003cSelf as Trait\u003e::Call, Self::PalletsOrigin\u003e;\n\n\t/// The type represent origin that can be dispatched by other origins.\n\ttype AsOriginId: Parameter + AsOriginId\u003c\u003cSelf as frame_system::Trait\u003e::Origin, Self::PalletsOrigin\u003e;\n\n\t/// Additional permission config.\n\ttype AuthorityConfig: AuthorityConfig\u003c\u003cSelf as frame_system::Trait\u003e::Origin, Self::PalletsOrigin, Self::BlockNumber\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Calculation overflow.\n\t\tOverflow,\n\t\t/// Failed to schedule a task.\n\t\tFailedToSchedule,\n\t\t/// Failed to cancel a task.\n\t\tFailedToCancel,\n\t}\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Authority {\n\t\t/// Track the next task ID.\n\t\tpub NextTaskIndex get(fn next_task_index): ScheduleTaskIndex;\n\t}\n}\n\ndecl_event! {\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as Trait\u003e::PalletsOrigin,\n\t\t\u003cT as frame_system::Trait\u003e::BlockNumber,\n\t{\n\t\t/// A call is dispatched. [result]\n\t\tDispatched(DispatchResult),\n\t\t/// A call is scheduled. [origin, index]\n\t\tScheduled(PalletsOrigin, ScheduleTaskIndex),\n\t\t/// A scheduled call is fast tracked. [origin, index, when]\n\t\tFastTracked(PalletsOrigin, ScheduleTaskIndex, BlockNumber),\n\t\t/// A scheduled call is delayed. [origin, index, when]\n\t\tDelayed(PalletsOrigin, ScheduleTaskIndex, BlockNumber),\n\t\t/// A scheduled call is cancelled. [origin, index]\n\t\tCancelled(PalletsOrigin, ScheduleTaskIndex),\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: \u003cT as frame_system::Trait\u003e::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Dispatch a dispatchable on behalf of other origin\n\t\t#[weight = (T::WeightInfo::dispatch_as().saturating_add(call.get_dispatch_info().weight), call.get_dispatch_info().class)]\n\t\tpub fn dispatch_as(\n\t\t\torigin,\n\t\t\tas_origin: T::AsOriginId,\n\t\t\tcall: Box\u003cCallOf\u003cT\u003e\u003e,\n\t\t) {\n\t\t\tas_origin.check_dispatch_from(origin)?;\n\n\t\t\tlet e = call.dispatch(as_origin.into_origin().into());\n\n\t\t\tSelf::deposit_event(RawEvent::Dispatched(e.map(|_| ()).map_err(|e| e.error)));\n\t\t}\n\n\t\t/// Schedule a dispatchable to be dispatched at later block.\n\t\t/// This is the only way to dispatch a call with `DelayedOrigin`.\n\t\t#[weight = T::WeightInfo::schedule_dispatch_without_delay()]\n\t\tpub fn schedule_dispatch(\n\t\t\torigin,\n\t\t\twhen: DispatchTime\u003cT::BlockNumber\u003e,\n\t\t\tpriority: Priority,\n\t\t\twith_delayed_origin: bool,\n\t\t\tcall: Box\u003cCallOf\u003cT\u003e\u003e,\n\t\t) {\n\t\t\tT::AuthorityConfig::check_schedule_dispatch(origin.clone(), priority)?;\n\n\t\t\tlet id = NextTaskIndex::mutate(|id| -\u003e sp_std::result::Result\u003cScheduleTaskIndex, DispatchError\u003e {\n\t\t\t\tlet current_id = *id;\n\t\t\t\t*id = id.checked_add(1).ok_or(Error::\u003cT\u003e::Overflow)?;\n\t\t\t\tOk(current_id)\n\t\t\t})?;\n\n\t\t\tlet now = frame_system::Module::\u003cT\u003e::block_number();\n\n\t\t\tlet delay = match when {\n\t\t\t\tDispatchTime::At(x) =\u003e x.checked_sub(\u0026now).ok_or(Error::\u003cT\u003e::Overflow)?,\n\t\t\t\tDispatchTime::After(x) =\u003e x\n\t\t\t};\n\n\t\t\tlet schedule_origin = if with_delayed_origin {\n\t\t\t\tlet origin: \u003cT as Trait\u003e::Origin = From::from(origin);\n\t\t\t\tlet origin: \u003cT as Trait\u003e::Origin = From::from(DelayedOrigin::\u003cT::BlockNumber, T::PalletsOrigin\u003e {\n\t\t\t\t\tdelay,\n\t\t\t\t\torigin: Box::new(origin.caller().clone())\n\t\t\t\t});\n\t\t\t\torigin\n\t\t\t} else {\n\t\t\t\t\u003cT as Trait\u003e::Origin::from(origin)\n\t\t\t};\n\n\t\t\tlet pallets_origin = schedule_origin.caller().clone();\n\n\t\t\tT::Scheduler::schedule_named(\n\t\t\t\tEncode::encode(\u0026(\u0026pallets_origin, id)),\n\t\t\t\twhen,\n\t\t\t\tNone,\n\t\t\t\tpriority,\n\t\t\t\tpallets_origin.clone(),\n\t\t\t\t*call,\n\t\t\t).map_err(|_| Error::\u003cT\u003e::FailedToSchedule)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Scheduled(pallets_origin, id));\n\t\t}\n\n\t\t/// Fast track a scheduled dispatchable.\n\t\t/// WARN: This is not fully implemented.\n\t\t#[weight = T::WeightInfo::fast_track_scheduled_dispatch()]\n\t\tpub fn fast_track_scheduled_dispatch(\n\t\t\torigin,\n\t\t\tinitial_origin: T::PalletsOrigin,\n\t\t\ttask_id: ScheduleTaskIndex,\n\t\t\twhen: DispatchTime\u003cT::BlockNumber\u003e,\n\t\t) {\n\t\t\tlet now = frame_system::Module::\u003cT\u003e::block_number();\n\n\t\t\tlet new_delay = match when {\n\t\t\t\tDispatchTime::At(x) =\u003e x.checked_sub(\u0026now).ok_or(Error::\u003cT\u003e::Overflow)?,\n\t\t\t\tDispatchTime::After(x) =\u003e x\n\t\t\t};\n\n\t\t\tT::AuthorityConfig::check_fast_track_schedule(origin, \u0026initial_origin, new_delay)?;\n\n\t\t\tlet now = frame_system::Module::\u003cT\u003e::block_number();\n\n\t\t\tlet when = match when {\n\t\t\t\tDispatchTime::At(x) =\u003e x,\n\t\t\t\tDispatchTime::After(x) =\u003e now.saturating_add(x)\n\t\t\t};\n\n\t\t\t// TODO: depends https://github.com/paritytech/substrate/issues/6774\n\n\t\t\tSelf::deposit_event(RawEvent::FastTracked(initial_origin, task_id, when));\n\t\t}\n\n\t\t/// Delay a scheduled dispatchable.\n\t\t/// WARN: This is not fully implemented.\n\t\t#[weight = T::WeightInfo::delay_scheduled_dispatch()]\n\t\tpub fn delay_scheduled_dispatch(\n\t\t\torigin,\n\t\t\tinitial_origin: T::PalletsOrigin,\n\t\t\ttask_id: ScheduleTaskIndex,\n\t\t\t_additional_delay: T::BlockNumber,\n\t\t) {\n\t\t\tT::AuthorityConfig::check_delay_schedule(origin, \u0026initial_origin)?;\n\n\t\t\t// TODO: depends https://github.com/paritytech/substrate/issues/6774\n\n\t\t\tSelf::deposit_event(RawEvent::Delayed(initial_origin, task_id, 0.into()));\n\t\t}\n\n\t\t/// Cancel a scheduled dispatchable.\n\t\t#[weight = T::WeightInfo::cancel_scheduled_dispatch()]\n\t\tpub fn cancel_scheduled_dispatch(\n\t\t\torigin,\n\t\t\tinitial_origin: T::PalletsOrigin,\n\t\t\ttask_id: ScheduleTaskIndex,\n\t\t) {\n\t\t\tT::AuthorityConfig::check_cancel_schedule(origin, \u0026initial_origin)?;\n\n\t\t\tT::Scheduler::cancel_named((\u0026initial_origin, task_id).encode()).map_err(|_| Error::\u003cT\u003e::FailedToCancel)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Cancelled(initial_origin, task_id));\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","authority","src","mock.rs"],"content":"//! Mocks for the authority module.\n\n#![cfg(test)]\n\nuse frame_support::{\n\tparameter_types,\n\ttraits::{OnFinalize, OnInitialize},\n};\nuse frame_system::{ensure_root, ensure_signed, EnsureRoot};\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{BadOrigin, Block as BlockT, IdentityLookup},\n\tPerbill,\n};\n\nuse super::*;\npub use crate as authority;\n\npub type AccountId = u128;\npub type BlockNumber = u64;\n\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = Call;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = Event;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub MaximumSchedulerWeight: u32 = Perbill::from_percent(80) * MaximumBlockWeight::get();\n}\nimpl pallet_scheduler::Trait for Runtime {\n\ttype Event = Event;\n\ttype Origin = Origin;\n\ttype PalletsOrigin = OriginCaller;\n\ttype Call = Call;\n\ttype MaximumWeight = MaximumSchedulerWeight;\n\ttype ScheduleOrigin = EnsureRoot\u003cu128\u003e;\n\ttype MaxScheduledPerBlock = ();\n\ttype WeightInfo = ();\n}\n\n#[derive(Clone, Encode, Decode, Eq, PartialEq, Ord, PartialOrd, Debug)]\npub enum MockAsOriginId {\n\tRoot,\n\tAccount1,\n\tAccount2,\n}\n\npub struct AuthorityConfigImpl;\n\nimpl AuthorityConfig\u003cOrigin, OriginCaller, BlockNumber\u003e for AuthorityConfigImpl {\n\tfn check_schedule_dispatch(origin: Origin, _priority: Priority) -\u003e DispatchResult {\n\t\tlet origin: Result\u003cframe_system::RawOrigin\u003cu128\u003e, _\u003e = origin.into();\n\t\tmatch origin {\n\t\t\tOk(frame_system::RawOrigin::Root)\n\t\t\t| Ok(frame_system::RawOrigin::Signed(1))\n\t\t\t| Ok(frame_system::RawOrigin::Signed(2)) =\u003e Ok(()),\n\t\t\t_ =\u003e Err(BadOrigin.into()),\n\t\t}\n\t}\n\tfn check_fast_track_schedule(\n\t\torigin: Origin,\n\t\t_initial_origin: \u0026OriginCaller,\n\t\t_new_delay: BlockNumber,\n\t) -\u003e DispatchResult {\n\t\tensure_root(origin)?;\n\t\tOk(())\n\t}\n\tfn check_delay_schedule(origin: Origin, initial_origin: \u0026OriginCaller) -\u003e DispatchResult {\n\t\tensure_root(origin.clone()).or_else(|_| {\n\t\t\tif origin.caller() == initial_origin {\n\t\t\t\tOk(())\n\t\t\t} else {\n\t\t\t\tErr(BadOrigin.into())\n\t\t\t}\n\t\t})\n\t}\n\tfn check_cancel_schedule(origin: Origin, initial_origin: \u0026OriginCaller) -\u003e DispatchResult {\n\t\tensure_root(origin.clone()).or_else(|_| {\n\t\t\tif origin.caller() == initial_origin {\n\t\t\t\tOk(())\n\t\t\t} else {\n\t\t\t\tErr(BadOrigin.into())\n\t\t\t}\n\t\t})\n\t}\n}\n\nimpl AsOriginId\u003cOrigin, OriginCaller\u003e for MockAsOriginId {\n\tfn into_origin(self) -\u003e OriginCaller {\n\t\tmatch self {\n\t\t\tMockAsOriginId::Root =\u003e Origin::root().caller().clone(),\n\t\t\tMockAsOriginId::Account1 =\u003e Origin::signed(1).caller().clone(),\n\t\t\tMockAsOriginId::Account2 =\u003e Origin::signed(2).caller().clone(),\n\t\t}\n\t}\n\tfn check_dispatch_from(\u0026self, origin: Origin) -\u003e DispatchResult {\n\t\tensure_root(origin.clone()).or_else(|_| {\n\t\t\tif let OriginCaller::authority(ref sign) = origin.caller() {\n\t\t\t\tif sign.origin == Box::new(Origin::root().caller().clone()) {\n\t\t\t\t\treturn Ok(());\n\t\t\t\t} else {\n\t\t\t\t\treturn Err(BadOrigin.into());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet ok = match self {\n\t\t\t\tMockAsOriginId::Root =\u003e false,\n\t\t\t\tMockAsOriginId::Account1 =\u003e ensure_signed(origin)? == 1,\n\t\t\t\tMockAsOriginId::Account2 =\u003e ensure_signed(origin)? == 2,\n\t\t\t};\n\t\t\treturn if ok { Ok(()) } else { Err(BadOrigin.into()) };\n\t\t})\n\t}\n}\n\nimpl Trait for Runtime {\n\ttype Event = Event;\n\ttype Origin = Origin;\n\ttype PalletsOrigin = OriginCaller;\n\ttype Scheduler = Scheduler;\n\ttype Call = Call;\n\ttype AsOriginId = MockAsOriginId;\n\ttype AuthorityConfig = AuthorityConfigImpl;\n\ttype WeightInfo = ();\n}\n\npub type Block = sp_runtime::generic::Block\u003cHeader, UncheckedExtrinsic\u003e;\npub type UncheckedExtrinsic = sp_runtime::generic::UncheckedExtrinsic\u003cu32, u64, u64, ()\u003e;\n\nframe_support::construct_runtime!(\n\tpub enum Runtime where\n\t\tBlock = Block,\n\t\tNodeBlock = Block,\n\t\tUncheckedExtrinsic = UncheckedExtrinsic\n\t{\n\t\tSystem: frame_system::{Module, Call, Event\u003cT\u003e},\n\t\tAuthority: authority::{Module, Call, Origin\u003cT\u003e, Event\u003cT\u003e},\n\t\tScheduler: pallet_scheduler::{Module, Call, Storage, Event\u003cT\u003e},\n\t}\n);\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n\npub fn run_to_block(n: u64) {\n\twhile System::block_number() \u003c n {\n\t\tScheduler::on_finalize(System::block_number());\n\t\tSystem::set_block_number(System::block_number() + 1);\n\t\tScheduler::on_initialize(System::block_number());\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","authority","src","tests.rs"],"content":"//! Unit tests for the authority module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok};\nuse frame_system::RawOrigin;\nuse mock::{\n\tauthority, run_to_block, Authority, BlockNumber, Call, ExtBuilder, MockAsOriginId, Origin, OriginCaller, Runtime,\n\tSystem,\n};\nuse sp_runtime::{traits::BadOrigin, Perbill};\n\n#[test]\nfn dispatch_as_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet ensure_root_call = Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\tlet ensure_signed_call = Call::System(frame_system::Call::remark(vec![]));\n\t\tassert_ok!(Authority::dispatch_as(\n\t\t\tOrigin::root(),\n\t\t\tMockAsOriginId::Root,\n\t\t\tBox::new(ensure_root_call.clone())\n\t\t));\n\t\tassert_ok!(Authority::dispatch_as(\n\t\t\tOrigin::root(),\n\t\t\tMockAsOriginId::Account1,\n\t\t\tBox::new(ensure_signed_call.clone())\n\t\t));\n\t\tassert_noop!(\n\t\t\tAuthority::dispatch_as(\n\t\t\t\tOrigin::signed(1),\n\t\t\t\tMockAsOriginId::Root,\n\t\t\t\tBox::new(ensure_signed_call.clone())\n\t\t\t),\n\t\t\tBadOrigin,\n\t\t);\n\t\tassert_ok!(Authority::dispatch_as(\n\t\t\tOrigin::signed(1),\n\t\t\tMockAsOriginId::Account1,\n\t\t\tBox::new(ensure_signed_call.clone())\n\t\t));\n\t\tassert_noop!(\n\t\t\tAuthority::dispatch_as(\n\t\t\t\tOrigin::signed(1),\n\t\t\t\tMockAsOriginId::Account2,\n\t\t\t\tBox::new(ensure_signed_call.clone())\n\t\t\t),\n\t\t\tBadOrigin,\n\t\t);\n\t});\n}\n\n#[test]\nfn schedule_dispatch_at_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet ensure_root_call = Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\tlet call = Call::Authority(authority::Call::dispatch_as(\n\t\t\tMockAsOriginId::Root,\n\t\t\tBox::new(ensure_root_call.clone()),\n\t\t));\n\t\trun_to_block(1);\n\t\tassert_eq!(\n\t\t\tAuthority::schedule_dispatch(Origin::root(), DispatchTime::At(1), 0, true, Box::new(call.clone())),\n\t\t\tErr(Error::\u003cRuntime\u003e::FailedToSchedule.into())\n\t\t);\n\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::At(2),\n\t\t\t0,\n\t\t\ttrue,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(\n\t\t\tOriginCaller::authority(DelayedOrigin {\n\t\t\t\tdelay: 1,\n\t\t\t\torigin: Box::new(OriginCaller::system(RawOrigin::Root)),\n\t\t\t}),\n\t\t\t1,\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\trun_to_block(2);\n\t\tlet event = mock::Event::pallet_scheduler(pallet_scheduler::RawEvent::Dispatched(\n\t\t\t(2, 0),\n\t\t\tSome([1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0].to_vec()),\n\t\t\tOk(()),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\t// with_delayed_origin = false\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::At(3),\n\t\t\t0,\n\t\t\tfalse,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(OriginCaller::system(RawOrigin::Root), 2));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\trun_to_block(3);\n\t\tlet event = mock::Event::pallet_scheduler(pallet_scheduler::RawEvent::Dispatched(\n\t\t\t(3, 0),\n\t\t\tSome([0, 0, 2, 0, 0, 0].to_vec()),\n\t\t\tOk(()),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\t});\n}\n\n#[test]\nfn schedule_dispatch_after_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet ensure_root_call = Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\tlet call = Call::Authority(authority::Call::dispatch_as(\n\t\t\tMockAsOriginId::Root,\n\t\t\tBox::new(ensure_root_call.clone()),\n\t\t));\n\t\trun_to_block(1);\n\t\tassert_eq!(\n\t\t\tAuthority::schedule_dispatch(Origin::root(), DispatchTime::After(0), 0, true, Box::new(call.clone())),\n\t\t\tErr(Error::\u003cRuntime\u003e::FailedToSchedule.into())\n\t\t);\n\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::After(1),\n\t\t\t0,\n\t\t\ttrue,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(\n\t\t\tOriginCaller::authority(DelayedOrigin {\n\t\t\t\tdelay: 1,\n\t\t\t\torigin: Box::new(OriginCaller::system(RawOrigin::Root)),\n\t\t\t}),\n\t\t\t1,\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\trun_to_block(2);\n\t\tlet event = mock::Event::pallet_scheduler(pallet_scheduler::RawEvent::Dispatched(\n\t\t\t(2, 0),\n\t\t\tSome([1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0].to_vec()),\n\t\t\tOk(()),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\t// with_delayed_origin = false\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::After(1),\n\t\t\t0,\n\t\t\tfalse,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(OriginCaller::system(RawOrigin::Root), 2));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\trun_to_block(3);\n\t\tlet event = mock::Event::pallet_scheduler(pallet_scheduler::RawEvent::Dispatched(\n\t\t\t(3, 0),\n\t\t\tSome([0, 0, 2, 0, 0, 0].to_vec()),\n\t\t\tOk(()),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\t});\n}\n\n#[test]\nfn fast_track_scheduled_dispatch_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\t\t//let ensure_root_call =\n\t\t// Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\t// let ensure_signed_call = Call::System(frame_system::Call::remark(vec![]));\n\t\tassert_ok!(Authority::fast_track_scheduled_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tframe_system::RawOrigin::Root.into(),\n\t\t\t0,\n\t\t\tDispatchTime::At(4),\n\t\t));\n\t});\n}\n\n#[test]\nfn delay_scheduled_dispatch_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t//let ensure_root_call =\n\t\t// Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\t// let ensure_signed_call = Call::System(frame_system::Call::remark(vec![]));\n\t\tassert_ok!(Authority::delay_scheduled_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tframe_system::RawOrigin::Root.into(),\n\t\t\t0,\n\t\t\t5,\n\t\t));\n\t});\n}\n\n#[test]\nfn cancel_scheduled_dispatch_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet ensure_root_call = Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\tlet call = Call::Authority(authority::Call::dispatch_as(\n\t\t\tMockAsOriginId::Root,\n\t\t\tBox::new(ensure_root_call.clone()),\n\t\t));\n\t\trun_to_block(1);\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::At(2),\n\t\t\t0,\n\t\t\ttrue,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(\n\t\t\tOriginCaller::authority(DelayedOrigin {\n\t\t\t\tdelay: 1,\n\t\t\t\torigin: Box::new(OriginCaller::system(RawOrigin::Root)),\n\t\t\t}),\n\t\t\t0,\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\tlet schedule_origin = {\n\t\t\tlet origin: \u003cRuntime as Trait\u003e::Origin = From::from(Origin::root());\n\t\t\tlet origin: \u003cRuntime as Trait\u003e::Origin =\n\t\t\t\tFrom::from(DelayedOrigin::\u003cBlockNumber, \u003cRuntime as Trait\u003e::PalletsOrigin\u003e {\n\t\t\t\t\tdelay: 1,\n\t\t\t\t\torigin: Box::new(origin.caller().clone()),\n\t\t\t\t});\n\t\t\torigin\n\t\t};\n\n\t\tlet pallets_origin = schedule_origin.caller().clone();\n\t\tassert_ok!(Authority::cancel_scheduled_dispatch(Origin::root(), pallets_origin, 0));\n\t\tlet event = mock::Event::authority(RawEvent::Cancelled(\n\t\t\tOriginCaller::authority(DelayedOrigin {\n\t\t\t\tdelay: 1,\n\t\t\t\torigin: Box::new(OriginCaller::system(RawOrigin::Root)),\n\t\t\t}),\n\t\t\t0,\n\t\t));\n\t\tprintln!(\"{:?}\", System::events());\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::At(2),\n\t\t\t0,\n\t\t\tfalse,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(OriginCaller::system(RawOrigin::Root), 1));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\tassert_ok!(Authority::cancel_scheduled_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tframe_system::RawOrigin::Root.into(),\n\t\t\t1\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Cancelled(OriginCaller::system(RawOrigin::Root), 1));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","benchmarking","src","lib.rs"],"content":"//! Macro for benchmarking a Substrate runtime. A fork of `frame-benchmarking`\n//! pallet.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nmod tests;\n\npub use frame_benchmarking::{\n\tbenchmarking, BenchmarkBatch, BenchmarkConfig, BenchmarkParameter, BenchmarkResults, Benchmarking,\n\tBenchmarkingSetup, TrackedStorageKey,\n};\n#[cfg(feature = \"std\")]\npub use frame_benchmarking::{Analysis, BenchmarkSelector};\npub use frame_support;\npub use paste;\n#[doc(hidden)]\npub use sp_io::storage::root as storage_root;\npub use sp_runtime::traits::Zero;\n\n/// Construct pallet benchmarks for weighing dispatchables.\n///\n/// Works around the idea of complexity parameters, named by a single letter\n/// (which is usually upper cased in complexity notation but is lower-cased for\n/// use in this macro).\n///\n/// Complexity parameters (\"parameters\") have a range which is a `u32` pair.\n/// Every time a benchmark is prepared and run, this parameter takes a concrete\n/// value within the range. There is an associated instancing block, which is a\n/// single expression that is evaluated during preparation. It may use `?`\n/// (`i.e. `return Err(...)`) to bail with a string error. Here's a\n/// few examples:\n///\n/// ```ignore\n/// // These two are equivalent:\n/// let x in 0 .. 10;\n/// let x in 0 .. 10 =\u003e ();\n/// // This one calls a setup function and might return an error (which would be terminal).\n/// let y in 0 .. 10 =\u003e setup(y)?;\n/// // This one uses a code block to do lots of stuff:\n/// let z in 0 .. 10 =\u003e {\n///   let a = z * z / 5;\n///   let b = do_something(a)?;\n///   combine_into(z, b);\n/// }\n/// ```\n///\n/// Note that due to parsing restrictions, if the `from` expression is not a\n/// single token (i.e. a literal or constant), then it must be parenthesised.\n///\n/// The macro allows for a number of \"arms\", each representing an individual\n/// benchmark. Using the simple syntax, the associated dispatchable function\n/// maps 1:1 with the benchmark and the name of the benchmark is the same as\n/// that of the associated function. However, extended syntax allows\n/// for arbitrary expresions to be evaluated in a benchmark (including for\n/// example, `on_initialize`).\n///\n/// The macro allows for common parameters whose ranges and instancing\n/// expressions may be drawn upon (or not) by each arm. Syntax is available to\n/// allow for only the range to be drawn upon if desired, allowing an\n/// alternative instancing expression to be given.\n///\n/// Note that the ranges are *inclusive* on both sides. This is in contrast to\n/// ranges in Rust which are left-inclusive right-exclusive.\n///\n/// Each arm may also have a block of code which is run prior to any instancing\n/// and a block of code which is run afterwards. All code blocks may draw upon\n/// the specific value of each parameter at any time. Local variables are shared\n/// between the two pre- and post- code blocks, but do not leak from the\n/// interior of any instancing expressions.\n///\n/// Any common parameters that are unused in an arm do not have their instancing\n/// expressions evaluated.\n///\n/// Example:\n/// ```ignore\n/// use path_to_node_runtime::MyRuntime;\n/// use path_to_account_id::AccountId;\n/// use frame_benchmarking::account;\n/// use orml_benchmarking::runtime_benchmarks;\n///\n/// runtime_benchmarks! {\n///   // The constructed runtime struct, and the pallet to benchmark.\n///   { MyRuntime, my_pallet }\n///\n///\n///   // first dispatchable: foo; this is a user dispatchable and operates on a `u8` vector of\n///   // size `l`, which we allow to be initialized as usual.\n///   foo {\n///     let caller = account::\u003cAccountId\u003e(b\"caller\", 0, benchmarks_seed);\n///     let l = ...;\n///   }: _(Origin::Signed(caller), vec![0u8; l])\n///\n///   // second dispatchable: bar; this is a root dispatchable and accepts a `u8` vector of size\n///   // `l`. We don't want it pre-initialized like before so we override using the `=\u003e ()` notation.\n///   // In this case, we explicitly name the call using `bar` instead of `_`.\n///   bar {\n///     let l = _ .. _ =\u003e ();\n///   }: bar(Origin::Root, vec![0u8; l])\n///\n///   // third dispatchable: baz; this is a user dispatchable. It isn't dependent on length like the\n///   // other two but has its own complexity `c` that needs setting up. It uses `caller` (in the\n///   // pre-instancing block) within the code block. This is only allowed in the param instancers\n///   // of arms. Instancers of common params cannot optimistically draw upon hypothetical variables\n///   // that the arm's pre-instancing code block might have declared.\n///   baz1 {\n///     let caller = account::\u003cAccountId\u003e(b\"caller\", 0, benchmarks_seed);\n///     let c = 0 .. 10 =\u003e setup_c(\u0026caller, c);\n///   }: baz(Origin::Signed(caller))\n///\n///   // this is a second benchmark of the baz dispatchable with a different setup.\n///   baz2 {\n///     let caller = account::\u003cAccountId\u003e(b\"caller\", 0, benchmarks_seed);\n///     let c = 0 .. 10 =\u003e setup_c_in_some_other_way(\u0026caller, c);\n///   }: baz(Origin::Signed(caller))\n///\n///   // this is benchmarking some code that is not a dispatchable.\n///   populate_a_set {\n///     let x in 0 .. 10_000;\n///     let mut m = Vec::\u003cu32\u003e::new();\n///     for i in 0..x {\n///       m.insert(i);\n///     }\n///   }: { m.into_iter().collect::\u003cBTreeSet\u003e() }\n/// }\n/// ```\n///\n/// Test functions are automatically generated for each benchmark and are\n/// accessible to you when you run `cargo test`. All tests are named\n/// `test_benchmark_\u003cbenchmark_name\u003e`, expect you to pass them the Runtime\n/// Trait, and run them in a test externalities environment. The test function\n/// runs your benchmark just like a regular benchmark, but only testing at the\n/// lowest and highest values for each component. The function will return\n/// `Ok(())` if the benchmarks return no errors.\n///\n/// You can optionally add a `verify` code block at the end of a benchmark to\n/// test any final state of your benchmark in a unit test. For example:\n///\n/// ```ignore\n/// sort_vector {\n///     let x in 1 .. 10000;\n///     let mut m = Vec::\u003cu32\u003e::new();\n///     for i in (0..x).rev() {\n///         m.push(i);\n///     }\n/// }: {\n///     m.sort();\n/// } verify {\n///     ensure!(m[0] == 0, \"You forgot to sort!\")\n/// }\n/// ```\n///\n/// These `verify` blocks will not affect your benchmark results!\n///\n/// You can construct benchmark tests like so:\n///\n/// ```ignore\n/// #[test]\n/// fn test_benchmarks() {\n///   new_test_ext().execute_with(|| {\n///     assert_ok!(test_benchmark_dummy());\n///     assert_err!(test_benchmark_other_name(), \"Bad origin\");\n///     assert_ok!(test_benchmark_sort_vector());\n///     assert_err!(test_benchmark_broken_benchmark(), \"You forgot to sort!\");\n///   });\n/// }\n/// ```\n#[macro_export]\nmacro_rules! runtime_benchmarks {\n\t(\n\t\t{ $runtime:ident, $pallet:ident }\n\t\t_ {\n\t\t\t$(\n\t\t\t\tlet $common:ident in $common_from:tt .. $common_to:expr =\u003e $common_instancer:expr;\n\t\t\t)*\n\t\t}\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter!(\n\t\t\t{ }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( { $common , $common_from , $common_to , $common_instancer } )* }\n\t\t\t( )\n\t\t\t( )\n\t\t\t$( $rest )*\n\t\t);\n\t}\n}\n\n/// Same as [`benchmarks`] but for instantiable module.\n#[macro_export]\nmacro_rules! runtime_benchmarks_instance {\n\t(\n\t\t{ $runtime:ident, $pallet:ident, $instance:ident }\n\t\t_ {\n\t\t\t$(\n\t\t\t\tlet $common:ident in $common_from:tt .. $common_to:expr =\u003e $common_instancer:expr;\n\t\t\t)*\n\t\t}\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter!(\n\t\t\t{ $instance }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( { $common , $common_from , $common_to , $common_instancer } )* }\n\t\t\t( )\n\t\t\t( )\n\t\t\t$( $rest )*\n\t\t);\n\t}\n}\n\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! benchmarks_iter {\n\t// detect and extract extra tag:\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t#[extra]\n\t\t$name:ident\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* $name )\n\t\t\t$name\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// mutation arm:\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* ) // This contains $( $( { $instance } )? $name:ident )*\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: _ ( $origin:expr $( , $arg:expr )* )\n\t\tverify $postcode:block\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: $name ( $origin $( , $arg )* )\n\t\t\tverify $postcode\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// mutation arm:\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: $dispatch:ident ( $origin:expr $( , $arg:expr )* )\n\t\tverify $postcode:block\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: {\n\t\t\t\t\u003c\n\t\t\t\t\t$pallet::Call\u003c$runtime $(, $instance)? \u003e as $crate::frame_support::traits::UnfilteredDispatchable\n\t\t\t\t\u003e\n\t\t\t\t::dispatch_bypass_filter(\n\t\t\t\t\t$pallet::Call::\u003c$runtime $(, $instance)? \u003e::$dispatch($($arg),*), $origin.into()\n\t\t\t\t)?;\n\t\t\t}\n\t\t\tverify $postcode\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// iteration arm:\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: $eval:block\n\t\tverify $postcode:block\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? }\n\t\t\t$name\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t{ }\n\t\t\t{ $eval }\n\t\t\t{ $( $code )* }\n\t\t\t$postcode\n\t\t}\n\n\t\t#[cfg(test)]\n\t\t$crate::impl_benchmark_test!(\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $instance)? }\n\t\t\t$name\n\t\t);\n\n\t\t$crate::benchmarks_iter!(\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* { $( $instance )? } $name )\n\t\t\t( $( $names_extra )* )\n\t\t\t$( $rest )*\n\t\t);\n\t};\n\t// iteration-exit arm\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t) =\u003e {\n\t\t$crate::selected_benchmark!(\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $instance)? }\n\t\t\t$( $names )*\n\t\t);\n\t\t$crate::impl_benchmark!(\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $instance)? }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra ),* )\n\t\t);\n\t};\n\t// add verify block to _() format\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: _ ( $origin:expr $( , $arg:expr )* )\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: _ ( $origin $( , $arg )* )\n\t\t\tverify { }\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// add verify block to name() format\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: $dispatch:ident ( $origin:expr $( , $arg:expr )* )\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: $dispatch ( $origin $( , $arg )* )\n\t\t\tverify { }\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// add verify block to {} format\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: $eval:block\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter!(\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: $eval\n\t\t\tverify { }\n\t\t\t$( $rest )*\n\t\t);\n\t};\n}\n\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! benchmark_backend {\n\t// parsing arms\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( PRE { $( $pre_parsed:tt )* } )*\n\t} { $eval:block } {\n\t\t\tlet $pre_id:tt : $pre_ty:ty = $pre_ex:expr;\n\t\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? } $name $runtime $pallet { $( $common )* } {\n\t\t\t\t$( PRE { $( $pre_parsed )* } )*\n\t\t\t\tPRE { $pre_id , $pre_ty , $pre_ex }\n\t\t\t} { $eval } { $( $rest )* } $postcode\n\t\t}\n\t};\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in ( $param_from:expr ) .. $param_to:expr =\u003e $param_instancer:expr;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? } $name $runtime $pallet { $( $common )* } {\n\t\t\t\t$( $parsed )*\n\t\t\t\tPARAM { $param , $param_from , $param_to , $param_instancer }\n\t\t\t} { $eval } { $( $rest )* } $postcode\n\t\t}\n\t};\n\t// mutation arm to look after defaulting to a common param\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( { $common:ident , $common_from:tt , $common_to:expr , $common_instancer:expr } )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in ...;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? } $name $runtime $pallet {\n\t\t\t\t$( { $common , $common_from , $common_to , $common_instancer } )*\n\t\t\t} {\n\t\t\t\t$( $parsed )*\n\t\t\t} { $eval } {\n\t\t\t\tlet $param\n\t\t\t\t\tin ({ $( let $common = $common_from; )* $param })\n\t\t\t\t\t.. ({ $( let $common = $common_to; )* $param })\n\t\t\t\t\t=\u003e ({ $( let $common = || -\u003e Result\u003c(), \u0026'static str\u003e { $common_instancer ; Ok(()) }; )* $param()? });\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// mutation arm to look after defaulting only the range to common param\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( { $common:ident , $common_from:tt , $common_to:expr , $common_instancer:expr } )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in _ .. _ =\u003e $param_instancer:expr ;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? } $name $runtime $pallet {\n\t\t\t\t$( { $common , $common_from , $common_to , $common_instancer } )*\n\t\t\t} {\n\t\t\t\t$( $parsed )*\n\t\t\t} { $eval } {\n\t\t\t\tlet $param\n\t\t\t\t\tin ({ $( let $common = $common_from; )* $param })\n\t\t\t\t\t.. ({ $( let $common = $common_to; )* $param })\n\t\t\t\t\t=\u003e $param_instancer ;\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// mutation arm to look after a single tt for param_from.\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in $param_from:tt .. $param_to:expr =\u003e $param_instancer:expr ;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? }\n\t\t\t$name $runtime $pallet { $( $common )* } { $( $parsed )* } { $eval } {\n\t\t\t\tlet $param in ( $param_from ) .. $param_to =\u003e $param_instancer;\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// mutation arm to look after the default tail of `=\u003e ()`\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in $param_from:tt .. $param_to:expr;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? }\n\t\t\t$name $runtime $pallet { $( $common )* } { $( $parsed )* } { $eval } {\n\t\t\t\tlet $param in $param_from .. $param_to =\u003e ();\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// mutation arm to look after `let _ =`\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $pre_id:tt = $pre_ex:expr;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? }\n\t\t\t$name $runtime $pallet { $( $common )* } { $( $parsed )* } { $eval } {\n\t\t\t\tlet $pre_id : _ = $pre_ex;\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// actioning arm\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( { $common:ident , $common_from:tt , $common_to:expr , $common_instancer:expr } )*\n\t} {\n\t\t$( PRE { $pre_id:tt , $pre_ty:ty , $pre_ex:expr } )*\n\t\t$( PARAM { $param:ident , $param_from:expr , $param_to:expr , $param_instancer:expr } )*\n\t} { $eval:block } { $( $post:tt )* } $postcode:block) =\u003e {\n\t\t#[allow(non_camel_case_types)]\n\t\tstruct $name;\n\t\t#[allow(unused_variables)]\n\t\timpl $crate::BenchmarkingSetup\u003c$runtime $(, $instance)?\u003e for $name {\n\t\t\tfn components(\u0026self) -\u003e Vec\u003c($crate::BenchmarkParameter, u32, u32)\u003e {\n\t\t\t\tvec! [\n\t\t\t\t\t$(\n\t\t\t\t\t\t($crate::BenchmarkParameter::$param, $param_from, $param_to)\n\t\t\t\t\t),*\n\t\t\t\t]\n\t\t\t}\n\n\t\t\tfn instance(\n\t\t\t\t\u0026self,\n\t\t\t\tcomponents: \u0026[($crate::BenchmarkParameter, u32)],\n\t\t\t\tverify: bool\n\t\t\t)\n\t\t\t\t-\u003e Result\u003cBox\u003cdyn FnOnce() -\u003e Result\u003c(), \u0026'static str\u003e\u003e, \u0026'static str\u003e\n\t\t\t{\n\t\t\t\t$(\n\t\t\t\t\tlet $common = $common_from;\n\t\t\t\t)*\n\t\t\t\t$(\n\t\t\t\t\t// Prepare instance\n\t\t\t\t\tlet $param = components.iter()\n\t\t\t\t\t\t.find(|\u0026c| c.0 == $crate::BenchmarkParameter::$param)\n\t\t\t\t\t\t.ok_or(\"Could not find component in benchmark preparation.\")?\n\t\t\t\t\t\t.1;\n\t\t\t\t)*\n\t\t\t\t$(\n\t\t\t\t\tlet $pre_id : $pre_ty = $pre_ex;\n\t\t\t\t)*\n\t\t\t\t$( $param_instancer ; )*\n\t\t\t\t$( $post )*\n\n\t\t\t\tOk(Box::new(move || -\u003e Result\u003c(), \u0026'static str\u003e {\n\t\t\t\t\t$eval;\n\t\t\t\t\tif verify {\n\t\t\t\t\t\t$postcode;\n\t\t\t\t\t}\n\t\t\t\t\tOk(())\n\t\t\t\t}))\n\t\t\t}\n\t\t}\n\t};\n}\n\n// Creates a `SelectedBenchmark` enum implementing `BenchmarkingSetup`.\n//\n// Every variant must implement [`BenchmarkingSetup`].\n//\n// ```nocompile\n// \n// struct Transfer;\n// impl BenchmarkingSetup for Transfer { ... }\n//\n// struct SetBalance;\n// impl BenchmarkingSetup for SetBalance { ... }\n//\n// selected_benchmark!({} Transfer {} SetBalance);\n// ```\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! selected_benchmark {\n\t(\n\t\t$runtime:ident $pallet:ident\n\t\t{ $( $instance:ident )? }\n\t\t$( { $( $bench_inst:ident )? } $bench:ident )*\n\t) =\u003e {\n\t\t// The list of available benchmarks for this pallet.\n\t\t#[allow(non_camel_case_types)]\n\t\tenum SelectedBenchmark {\n\t\t\t$( $bench, )*\n\t\t}\n\n\t\t// Allow us to select a benchmark from the list of available benchmarks.\n\t\timpl $crate::BenchmarkingSetup\u003c$runtime $(, $instance)?\u003e for SelectedBenchmark {\n\t\t\tfn components(\u0026self) -\u003e Vec\u003c($crate::BenchmarkParameter, u32, u32)\u003e {\n\t\t\t\tmatch self {\n\t\t\t\t\t$(\n\t\t\t\t\t\tSelf::$bench =\u003e \u003c\n\t\t\t\t\t\t\t$bench as $crate::BenchmarkingSetup\u003c$runtime $(, $bench_inst)? \u003e\n\t\t\t\t\t\t\u003e::components(\u0026$bench),\n\t\t\t\t\t)*\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfn instance(\n\t\t\t\t\u0026self,\n\t\t\t\tcomponents: \u0026[($crate::BenchmarkParameter, u32)],\n\t\t\t\tverify: bool\n\t\t\t)\n\t\t\t\t-\u003e Result\u003cBox\u003cdyn FnOnce() -\u003e Result\u003c(), \u0026'static str\u003e\u003e, \u0026'static str\u003e\n\t\t\t{\n\t\t\t\tmatch self {\n\t\t\t\t\t$(\n\t\t\t\t\t\tSelf::$bench =\u003e \u003c\n\t\t\t\t\t\t\t$bench as $crate::BenchmarkingSetup\u003c$runtime $(, $bench_inst)? \u003e\n\t\t\t\t\t\t\u003e::instance(\u0026$bench, components, verify),\n\t\t\t\t\t)*\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}\n\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! impl_benchmark {\n\t(\n\t\t$runtime:ident $pallet:ident\n\t\t{ $( $instance:ident )? }\n\t\t( $( { $( $name_inst:ident )? } $name:ident )* )\n\t\t( $( $name_extra:ident ),* )\n\t) =\u003e {\n\t\t#[cfg(feature=\"runtime-benchmarks\")]\n\t\tpub struct Benchmark;\n\n\t\t#[cfg(feature=\"runtime-benchmarks\")]\n\t\timpl $crate::Benchmarking\u003c$crate::BenchmarkResults\u003e for Benchmark {\n\t\t\tfn benchmarks(extra: bool) -\u003e Vec\u003c\u0026'static [u8]\u003e {\n\t\t\t\tlet mut all = vec![ $( stringify!($name).as_ref() ),* ];\n\t\t\t\tif !extra {\n\t\t\t\t\tlet extra = [ $( stringify!($name_extra).as_ref() ),* ];\n\t\t\t\t\tall.retain(|x| !extra.contains(x));\n\t\t\t\t}\n\t\t\t\tall\n\t\t\t}\n\n\t\t\tfn run_benchmark(\n\t\t\t\textrinsic: \u0026[u8],\n\t\t\t\tlowest_range_values: \u0026[u32],\n\t\t\t\thighest_range_values: \u0026[u32],\n\t\t\t\tsteps: \u0026[u32],\n\t\t\t\trepeat: u32,\n\t\t\t\twhitelist: \u0026[$crate::TrackedStorageKey],\n\t\t\t\tverify: bool,\n\t\t\t) -\u003e Result\u003cVec\u003c$crate::BenchmarkResults\u003e, \u0026'static str\u003e {\n\t\t\t\t// Map the input to the selected benchmark.\n\t\t\t\tlet extrinsic = sp_std::str::from_utf8(extrinsic)\n\t\t\t\t\t.map_err(|_| \"`extrinsic` is not a valid utf8 string!\")?;\n\t\t\t\tlet selected_benchmark = match extrinsic {\n\t\t\t\t\t$( stringify!($name) =\u003e SelectedBenchmark::$name, )*\n\t\t\t\t\t_ =\u003e return Err(\"Could not find extrinsic.\"),\n\t\t\t\t};\n\n\t\t\t\tlet mut results: Vec\u003c$crate::BenchmarkResults\u003e = Vec::new();\n\t\t\t\tif repeat == 0 {\n\t\t\t\t\treturn Ok(results);\n\t\t\t\t}\n\n\t\t\t\t// Add whitelist to DB\n\t\t\t\t$crate::benchmarking::set_whitelist(whitelist.to_vec());\n\n\t\t\t\t// Warm up the DB\n\t\t\t\t$crate::benchmarking::commit_db();\n\t\t\t\t$crate::benchmarking::wipe_db();\n\n\t\t\t\tlet components = \u003c\n\t\t\t\t\tSelectedBenchmark as $crate::BenchmarkingSetup\u003c$runtime $(, $instance)?\u003e\n\t\t\t\t\u003e::components(\u0026selected_benchmark);\n\n\t\t\t\t// Default number of steps for a component.\n\t\t\t\tlet mut prev_steps = 10;\n\n\t\t\t\tlet repeat_benchmark = |\n\t\t\t\t\trepeat: u32,\n\t\t\t\t\tc: \u0026[($crate::BenchmarkParameter, u32)],\n\t\t\t\t\tresults: \u0026mut Vec\u003c$crate::BenchmarkResults\u003e,\n\t\t\t\t\tverify: bool,\n\t\t\t\t| -\u003e Result\u003c(), \u0026'static str\u003e {\n\t\t\t\t\t// Run the benchmark `repeat` times.\n\t\t\t\t\tfor _ in 0..repeat {\n\t\t\t\t\t\t// Set up the externalities environment for the setup we want to\n\t\t\t\t\t\t// benchmark.\n\t\t\t\t\t\tlet closure_to_benchmark = \u003c\n\t\t\t\t\t\t\tSelectedBenchmark as $crate::BenchmarkingSetup\u003c$runtime $(, $instance)?\u003e\n\t\t\t\t\t\t\u003e::instance(\u0026selected_benchmark, c, verify)?;\n\n\t\t\t\t\t\t// Set the block number to at least 1 so events are deposited.\n\t\t\t\t\t\tif $crate::Zero::is_zero(\u0026frame_system::Module::\u003c$runtime\u003e::block_number()) {\n\t\t\t\t\t\t\tframe_system::Module::\u003c$runtime\u003e::set_block_number(1u8.into());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Commit the externalities to the database, flushing the DB cache.\n\t\t\t\t\t\t// This will enable worst case scenario for reading from the database.\n\t\t\t\t\t\t$crate::benchmarking::commit_db();\n\n\t\t\t\t\t\t// Reset the read/write counter so we don't count operations in the setup process.\n\t\t\t\t\t\t$crate::benchmarking::reset_read_write_count();\n\n\t\t\t\t\t\tif verify {\n\t\t\t\t\t\t\tclosure_to_benchmark()?;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Time the extrinsic logic.\n\t\t\t\t\t\t\tframe_support::debug::trace!(\n\t\t\t\t\t\t\t\ttarget: \"benchmark\",\n\t\t\t\t\t\t\t\t\"Start Benchmark: {:?}\", c\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tlet start_extrinsic = $crate::benchmarking::current_time();\n\t\t\t\t\t\t\tclosure_to_benchmark()?;\n\t\t\t\t\t\t\tlet finish_extrinsic = $crate::benchmarking::current_time();\n\t\t\t\t\t\t\tlet elapsed_extrinsic = finish_extrinsic - start_extrinsic;\n\t\t\t\t\t\t\t// Commit the changes to get proper write count\n\t\t\t\t\t\t\t$crate::benchmarking::commit_db();\n\t\t\t\t\t\t\tframe_support::debug::trace!(\n\t\t\t\t\t\t\t\ttarget: \"benchmark\",\n\t\t\t\t\t\t\t\t\"End Benchmark: {} ns\", elapsed_extrinsic\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tlet read_write_count = $crate::benchmarking::read_write_count();\n\t\t\t\t\t\t\tframe_support::debug::trace!(\n\t\t\t\t\t\t\t\ttarget: \"benchmark\",\n\t\t\t\t\t\t\t\t\"Read/Write Count {:?}\", read_write_count\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t// Time the storage root recalculation.\n\t\t\t\t\t\t\tlet start_storage_root = $crate::benchmarking::current_time();\n\t\t\t\t\t\t\t$crate::storage_root();\n\t\t\t\t\t\t\tlet finish_storage_root = $crate::benchmarking::current_time();\n\t\t\t\t\t\t\tlet elapsed_storage_root = finish_storage_root - start_storage_root;\n\n\t\t\t\t\t\t\tresults.push($crate::BenchmarkResults {\n\t\t\t\t\t\t\t\tcomponents: c.to_vec(),\n\t\t\t\t\t\t\t\textrinsic_time: elapsed_extrinsic,\n\t\t\t\t\t\t\t\tstorage_root_time: elapsed_storage_root,\n\t\t\t\t\t\t\t\treads: read_write_count.0,\n\t\t\t\t\t\t\t\trepeat_reads: read_write_count.1,\n\t\t\t\t\t\t\t\twrites: read_write_count.2,\n\t\t\t\t\t\t\t\trepeat_writes: read_write_count.3,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Wipe the DB back to the genesis state.\n\t\t\t\t\t\t$crate::benchmarking::wipe_db();\n\t\t\t\t\t}\n\n\t\t\t\t\tOk(())\n\t\t\t\t};\n\n\t\t\t\tif components.is_empty() {\n\t\t\t\t\tif verify {\n\t\t\t\t\t\t// If `--verify` is used, run the benchmark once to verify it would complete.\n\t\t\t\t\t\trepeat_benchmark(repeat, Default::default(), \u0026mut Vec::new(), true)?;\n\t\t\t\t\t}\n\t\t\t\t\trepeat_benchmark(repeat, Default::default(), \u0026mut results, false)?;\n\t\t\t\t} else {\n\t\t\t\t\t// Select the component we will be benchmarking. Each component will be benchmarked.\n\t\t\t\t\tfor (idx, (name, low, high)) in components.iter().enumerate() {\n\t\t\t\t\t\t// Get the number of steps for this component.\n\t\t\t\t\t\tlet steps = steps.get(idx).cloned().unwrap_or(prev_steps);\n\t\t\t\t\t\tprev_steps = steps;\n\n\t\t\t\t\t\t// Skip this loop if steps is zero\n\t\t\t\t\t\tif steps == 0 { continue }\n\n\t\t\t\t\t\tlet lowest = lowest_range_values.get(idx).cloned().unwrap_or(*low);\n\t\t\t\t\t\tlet highest = highest_range_values.get(idx).cloned().unwrap_or(*high);\n\n\t\t\t\t\t\tlet diff = highest - lowest;\n\n\t\t\t\t\t\t// Create up to `STEPS` steps for that component between high and low.\n\t\t\t\t\t\tlet step_size = (diff / steps).max(1);\n\t\t\t\t\t\tlet num_of_steps = diff / step_size + 1;\n\n\t\t\t\t\t\tfor s in 0..num_of_steps {\n\t\t\t\t\t\t\t// This is the value we will be testing for component `name`\n\t\t\t\t\t\t\tlet component_value = lowest + step_size * s;\n\n\t\t\t\t\t\t\t// Select the max value for all the other components.\n\t\t\t\t\t\t\tlet c: Vec\u003c($crate::BenchmarkParameter, u32)\u003e = components.iter()\n\t\t\t\t\t\t\t\t.enumerate()\n\t\t\t\t\t\t\t\t.map(|(idx, (n, _, h))|\n\t\t\t\t\t\t\t\t\tif n == name {\n\t\t\t\t\t\t\t\t\t\t(*n, component_value)\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t(*n, *highest_range_values.get(idx).unwrap_or(h))\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.collect();\n\n\t\t\t\t\t\t\tif verify {\n\t\t\t\t\t\t\t\t// If `--verify` is used, run the benchmark once to verify it would complete.\n\t\t\t\t\t\t\t\trepeat_benchmark(1, \u0026c, \u0026mut Vec::new(), true)?;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\trepeat_benchmark(repeat, \u0026c, \u0026mut results, false)?;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Ok(results);\n\t\t\t}\n\t\t}\n\t};\n}\n\n// This creates a unit test for one benchmark of the main benchmark macro.\n// It runs the benchmark using the `high` and `low` value for each component\n// and ensure that everything completes successfully.\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! impl_benchmark_test {\n\t(\n\t\t$runtime:ident $pallet:ident\n\t\t{ $( $instance:ident )? }\n\t\t$name:ident\n\t) =\u003e {\n\t\t$crate::paste::item! {\n\t\t\tfn [\u003ctest_benchmark_ $name\u003e] () -\u003e Result\u003c(), \u0026'static str\u003e\n\t\t\t{\n\t\t\t\tlet selected_benchmark = SelectedBenchmark::$name;\n\t\t\t\tlet components = \u003c\n\t\t\t\t\tSelectedBenchmark as $crate::BenchmarkingSetup\u003c$runtime, _\u003e\n\t\t\t\t\u003e::components(\u0026selected_benchmark);\n\n\t\t\t\tlet execute_benchmark = |\n\t\t\t\t\tc: Vec\u003c($crate::BenchmarkParameter, u32)\u003e\n\t\t\t\t| -\u003e Result\u003c(), \u0026'static str\u003e {\n\t\t\t\t\t// Set up the benchmark, return execution + verification function.\n\t\t\t\t\tlet closure_to_verify = \u003c\n\t\t\t\t\t\tSelectedBenchmark as $crate::BenchmarkingSetup\u003c$runtime, _\u003e\n\t\t\t\t\t\u003e::instance(\u0026selected_benchmark, \u0026c, true)?;\n\n\t\t\t\t\t// Set the block number to at least 1 so events are deposited.\n\t\t\t\t\tif $crate::Zero::is_zero(\u0026frame_system::Module::\u003c$runtime\u003e::block_number()) {\n\t\t\t\t\t\tframe_system::Module::\u003c$runtime\u003e::set_block_number(1u8.into());\n\t\t\t\t\t}\n\n\t\t\t\t\t// Run execution + verification\n\t\t\t\t\tclosure_to_verify()?;\n\n\t\t\t\t\t// Reset the state\n\t\t\t\t\t$crate::benchmarking::wipe_db();\n\n\t\t\t\t\tOk(())\n\t\t\t\t};\n\n\t\t\t\tif components.is_empty() {\n\t\t\t\t\texecute_benchmark(Default::default())?;\n\t\t\t\t} else {\n\t\t\t\t\tfor (_, (name, low, high)) in components.iter().enumerate() {\n\t\t\t\t\t\t// Test only the low and high value, assuming values in the middle won't break\n\t\t\t\t\t\tfor component_value in vec![low, high] {\n\t\t\t\t\t\t\t// Select the max value for all the other components.\n\t\t\t\t\t\t\tlet c: Vec\u003c($crate::BenchmarkParameter, u32)\u003e = components.iter()\n\t\t\t\t\t\t\t\t.enumerate()\n\t\t\t\t\t\t\t\t.map(|(_, (n, _, h))|\n\t\t\t\t\t\t\t\t\tif n == name {\n\t\t\t\t\t\t\t\t\t\t(*n, *component_value)\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t(*n, *h)\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.collect();\n\n\t\t\t\t\t\t\texecute_benchmark(c)?;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tOk(())\n\t\t\t}\n\t\t}\n\t};\n}\n\n/// This macro adds pallet benchmarks to a `Vec\u003cBenchmarkBatch\u003e` object.\n///\n/// First create an object that holds in the input parameters for the benchmark:\n///\n/// ```ignore\n/// let params = (\u0026config, \u0026whitelist);\n/// ```\n///\n/// The `whitelist` is a parameter you pass to control the DB read/write\n/// tracking. We use a vector of [TrackedStorageKey], which is a simple struct\n/// used to set if a key has been read or written to.\n///\n/// For values that should be skipped entirely, we can just pass `key.into()`.\n/// For example:\n///\n/// ```\n/// use frame_benchmarking::TrackedStorageKey;\n/// use hex_literal;\n/// let whitelist: Vec\u003cTrackedStorageKey\u003e = vec![\n///     // Block Number\n///     hex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef702a5c1b19ab7a04f536c519aca4983ac\").to_vec().into(),\n///     // Total Issuance\n///     hex_literal::hex!(\"c2261276cc9d1f8598ea4b6a74b15c2f57c875e4cff74148e4628f264b974c80\").to_vec().into(),\n///     // Execution Phase\n///     hex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef7ff553b5a9862a516939d82b3d3d8661a\").to_vec().into(),\n///     // Event Count\n///     hex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef70a98fdbe9ce6c55837576c60c7af3850\").to_vec().into(),\n/// ];\n/// ```\n///\n/// Then define a mutable local variable to hold your `BenchmarkBatch` object:\n/// ```ignore\n/// let mut batches = Vec::\u003cBenchmarkBatch\u003e::new();\n/// ````\n///\n/// Then add the pallets you want to benchmark to this object, using their crate\n/// name and generated module struct:\n/// ```ignore\n/// add_benchmark!(params, batches, pallet_balances, Balances);\n/// add_benchmark!(params, batches, pallet_session, SessionBench::\u003cRuntime\u003e);\n/// add_benchmark!(params, batches, frame_system, SystemBench::\u003cRuntime\u003e);\n/// ...\n/// ```\n///\n/// At the end of `dispatch_benchmark`, you should return this batches object.\n#[macro_export]\nmacro_rules! add_benchmark {\n\t( $params:ident, $batches:ident, $name:ident, $( $location:tt )* ) =\u003e (\n\t\tlet name_string = stringify!($name).as_bytes();\n\t\tlet (config, whitelist) = $params;\n\t\tlet $crate::BenchmarkConfig {\n\t\t\tpallet,\n\t\t\tbenchmark,\n\t\t\tlowest_range_values,\n\t\t\thighest_range_values,\n\t\t\tsteps,\n\t\t\trepeat,\n\t\t\tverify,\n\t\t\textra,\n\t\t} = config;\n\t\tif \u0026pallet[..] == \u0026name_string[..] || \u0026pallet[..] == \u0026b\"*\"[..] {\n\t\t\tif \u0026pallet[..] == \u0026b\"*\"[..] || \u0026benchmark[..] == \u0026b\"*\"[..] {\n\t\t\t\tfor benchmark in $( $location )*::Benchmark::benchmarks(*extra).into_iter() {\n\t\t\t\t\t$batches.push($crate::BenchmarkBatch {\n\t\t\t\t\t\tresults: $( $location )*::Benchmark::run_benchmark(\n\t\t\t\t\t\t\tbenchmark,\n\t\t\t\t\t\t\t\u0026lowest_range_values[..],\n\t\t\t\t\t\t\t\u0026highest_range_values[..],\n\t\t\t\t\t\t\t\u0026steps[..],\n\t\t\t\t\t\t\t*repeat,\n\t\t\t\t\t\t\twhitelist,\n\t\t\t\t\t\t\t*verify,\n\t\t\t\t\t\t)?,\n\t\t\t\t\t\tpallet: name_string.to_vec(),\n\t\t\t\t\t\tbenchmark: benchmark.to_vec(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$batches.push($crate::BenchmarkBatch {\n\t\t\t\t\tresults: $( $location )*::Benchmark::run_benchmark(\n\t\t\t\t\t\t\u0026benchmark[..],\n\t\t\t\t\t\t\u0026lowest_range_values[..],\n\t\t\t\t\t\t\u0026highest_range_values[..],\n\t\t\t\t\t\t\u0026steps[..],\n\t\t\t\t\t\t*repeat,\n\t\t\t\t\t\twhitelist,\n\t\t\t\t\t\t*verify\n\t\t\t\t\t)?,\n\t\t\t\t\tpallet: name_string.to_vec(),\n\t\t\t\t\tbenchmark: benchmark.clone(),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t)\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","benchmarking","src","tests.rs"],"content":"//! Tests for the module.\n\n#![cfg(test)]\n\nuse super::*;\nuse codec::Decode;\nuse frame_benchmarking::account;\nuse frame_support::{\n\tassert_err, assert_ok, decl_module, decl_storage, dispatch::DispatchResult, ensure, impl_outer_origin,\n};\nuse frame_system::{ensure_none, ensure_signed, RawOrigin};\nuse sp_runtime::{\n\ttesting::{Header, H256},\n\ttraits::{BlakeTwo256, IdentityLookup},\n};\nuse sp_std::prelude::*;\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Test {\n\t\tValue get(fn value): Option\u003cu32\u003e;\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\t#[weight = 0]\n\t\tfn set_value(origin, n: u32) -\u003e DispatchResult {\n\t\t\tlet _sender = ensure_signed(origin)?;\n\t\t\tValue::put(n);\n\t\t\tOk(())\n\t\t}\n\n\t\t#[weight = 0]\n\t\tfn dummy(origin, _n: u32) -\u003e DispatchResult {\n\t\t\tlet _sender = ensure_none(origin)?;\n\t\t\tOk(())\n\t\t}\n\t}\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\npub trait Trait {\n\ttype Event;\n\ttype BlockNumber;\n\ttype AccountId: 'static + Default + Decode;\n\ttype Origin: From\u003cframe_system::RawOrigin\u003cSelf::AccountId\u003e\u003e + Into\u003cResult\u003cRawOrigin\u003cSelf::AccountId\u003e, Self::Origin\u003e\u003e;\n}\n\ntype AccountId = u128;\n\n#[derive(Clone, Eq, PartialEq)]\npub struct Test;\n\nimpl frame_system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Call = ();\n\ttype Hashing = BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = ();\n\ttype BlockHashCount = ();\n\ttype MaximumBlockWeight = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = ();\n\ttype AvailableBlockRatio = ();\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nimpl Trait for Test {\n\ttype Event = ();\n\ttype BlockNumber = u32;\n\ttype Origin = Origin;\n\ttype AccountId = u128;\n}\n\n// This function basically just builds a genesis storage key/value store\n// according to our desired mockup.\nfn new_test_ext() -\u003e sp_io::TestExternalities {\n\tframe_system::GenesisConfig::default()\n\t\t.build_storage::\u003cTest\u003e()\n\t\t.unwrap()\n\t\t.into()\n}\n\nruntime_benchmarks! {\n\t{ Test, self }\n\n\t_ {\n\t\t// Define a common range for `b`.\n\t\tlet b in 1 .. 1000 =\u003e ();\n\t}\n\n\tset_value {\n\t\tlet b in ...;\n\t\tlet caller = account::\u003cAccountId\u003e(\"caller\", 0, 0);\n\t}: _ (RawOrigin::Signed(caller), b.into())\n\tverify {\n\t\tassert_eq!(Value::get(), Some(b));\n\t}\n\n\tother_name {\n\t\tlet b in ...;\n\t}: dummy (RawOrigin::None, b.into())\n\n\tsort_vector {\n\t\tlet x in 1 .. 10000;\n\t\tlet mut m = Vec::\u003cu32\u003e::new();\n\t\tfor i in (0..x).rev() {\n\t\t\tm.push(i);\n\t\t}\n\t}: {\n\t\tm.sort();\n\t} verify {\n\t\tensure!(m[0] == 0, \"You forgot to sort!\")\n\t}\n\n\tbad_origin {\n\t\tlet b in ...;\n\t\tlet caller = account::\u003cAccountId\u003e(\"caller\", 0, 0);\n\t}: dummy (RawOrigin::Signed(caller), b.into())\n\n\tbad_verify {\n\t\tlet x in 1 .. 10000;\n\t\tlet mut m = Vec::\u003cu32\u003e::new();\n\t\tfor i in (0..x).rev() {\n\t\t\tm.push(i);\n\t\t}\n\t}: { }\n\tverify {\n\t\tensure!(m[0] == 0, \"You forgot to sort!\")\n\t}\n}\n\n#[test]\nfn benchmarks_macro_works() {\n\t// Check benchmark creation for `set_value`.\n\tlet selected_benchmark = SelectedBenchmark::set_value;\n\n\tlet components = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::components(\u0026selected_benchmark);\n\tassert_eq!(components, vec![(BenchmarkParameter::b, 1, 1000)]);\n\n\tlet closure = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\n\t\t\u0026selected_benchmark,\n\t\t\u0026[(BenchmarkParameter::b, 1)],\n\t\ttrue,\n\t)\n\t.expect(\"failed to create closure\");\n\n\tnew_test_ext().execute_with(|| {\n\t\tassert_eq!(closure(), Ok(()));\n\t});\n}\n\n#[test]\nfn benchmarks_macro_rename_works() {\n\t// Check benchmark creation for `other_dummy`.\n\tlet selected_benchmark = SelectedBenchmark::other_name;\n\tlet components = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::components(\u0026selected_benchmark);\n\tassert_eq!(components, vec![(BenchmarkParameter::b, 1, 1000)]);\n\n\tlet closure = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\n\t\t\u0026selected_benchmark,\n\t\t\u0026[(BenchmarkParameter::b, 1)],\n\t\ttrue,\n\t)\n\t.expect(\"failed to create closure\");\n\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(closure());\n\t});\n}\n\n#[test]\nfn benchmarks_macro_works_for_non_dispatchable() {\n\tlet selected_benchmark = SelectedBenchmark::sort_vector;\n\n\tlet components = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::components(\u0026selected_benchmark);\n\tassert_eq!(components, vec![(BenchmarkParameter::x, 1, 10000)]);\n\n\tlet closure = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\n\t\t\u0026selected_benchmark,\n\t\t\u0026[(BenchmarkParameter::x, 1)],\n\t\ttrue,\n\t)\n\t.expect(\"failed to create closure\");\n\n\tassert_eq!(closure(), Ok(()));\n}\n\n#[test]\nfn benchmarks_macro_verify_works() {\n\t// Check postcondition for benchmark `set_value` is valid.\n\tlet selected_benchmark = SelectedBenchmark::set_value;\n\n\tlet closure = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\n\t\t\u0026selected_benchmark,\n\t\t\u0026[(BenchmarkParameter::b, 1)],\n\t\ttrue,\n\t)\n\t.expect(\"failed to create closure\");\n\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(closure());\n\t});\n\n\t// Check postcondition for benchmark `bad_verify` is invalid.\n\tlet selected = SelectedBenchmark::bad_verify;\n\n\tlet closure =\n\t\t\u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\u0026selected, \u0026[(BenchmarkParameter::x, 10000)], true)\n\t\t\t.expect(\"failed to create closure\");\n\n\tnew_test_ext().execute_with(|| {\n\t\tassert_err!(closure(), \"You forgot to sort!\");\n\t});\n}\n\n#[test]\nfn benchmarks_generate_unit_tests() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(test_benchmark_set_value());\n\t\tassert_ok!(test_benchmark_other_name());\n\t\tassert_ok!(test_benchmark_sort_vector());\n\t\tassert_err!(test_benchmark_bad_origin(), \"Bad origin\");\n\t\tassert_err!(test_benchmark_bad_verify(), \"You forgot to sort!\");\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","currencies","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn transfer_non_native_currency() -\u003e Weight {\n\t\t(172_011_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(5 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n\tfn transfer_native_currency() -\u003e Weight {\n\t\t(43_023_000 as Weight)\n\t}\n\tfn update_balance_non_native_currency() -\u003e Weight {\n\t\t(137_440_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(5 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n\tfn update_balance_native_currency_creating() -\u003e Weight {\n\t\t(64_432_000 as Weight)\n\t}\n\tfn update_balance_native_currency_killing() -\u003e Weight {\n\t\t(62_595_000 as Weight)\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","currencies","src","lib.rs"],"content":"//! # Currencies Module\n//!\n//! ## Overview\n//!\n//! The currencies module provides a mixed currencies system, by configuring a\n//! native currency which implements `BasicCurrencyExtended`, and a\n//! multi-currency which implements `MultiCurrency`.\n//!\n//! It also provides an adapter, to adapt `frame_support::traits::Currency`\n//! implementations into `BasicCurrencyExtended`.\n//!\n//! The currencies module provides functionality of both `MultiCurrencyExtended`\n//! and `BasicCurrencyExtended`, via unified interfaces, and all calls would be\n//! delegated to the underlying multi-currency and base currency system.\n//! A native currency ID could be set by `Trait::GetNativeCurrencyId`, to\n//! identify the native currency.\n//!\n//! ### Implementations\n//!\n//! The currencies module provides implementations for following traits.\n//!\n//! - `MultiCurrency` - Abstraction over a fungible multi-currency system.\n//! - `MultiCurrencyExtended` - Extended `MultiCurrency` with additional helper\n//!   types and methods, like updating balance\n//! by a given signed integer amount.\n//!\n//! ## Interface\n//!\n//! ### Dispatchable Functions\n//!\n//! - `transfer` - Transfer some balance to another account, in a given\n//!   currency.\n//! - `transfer_native_currency` - Transfer some balance to another account, in\n//!   native currency set in\n//! `Trait::NativeCurrency`.\n//! - `update_balance` - Update balance by signed integer amount, in a given\n//!   currency, root origin required.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::Codec;\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage,\n\ttraits::{\n\t\tCurrency as PalletCurrency, ExistenceRequirement, Get, LockableCurrency as PalletLockableCurrency,\n\t\tReservableCurrency as PalletReservableCurrency, WithdrawReasons,\n\t},\n\tweights::Weight,\n};\nuse frame_system::{ensure_root, ensure_signed};\nuse sp_runtime::{\n\ttraits::{CheckedSub, MaybeSerializeDeserialize, StaticLookup, Zero},\n\tDispatchError, DispatchResult,\n};\nuse sp_std::{\n\tconvert::{TryFrom, TryInto},\n\tfmt::Debug,\n\tmarker, result,\n};\n\nuse orml_traits::{\n\tarithmetic::{Signed, SimpleArithmetic},\n\tBalanceStatus, BasicCurrency, BasicCurrencyExtended, BasicLockableCurrency, BasicReservableCurrency,\n\tLockIdentifier, MultiCurrency, MultiCurrencyExtended, MultiLockableCurrency, MultiReservableCurrency,\n};\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn transfer_non_native_currency() -\u003e Weight;\n\tfn transfer_native_currency() -\u003e Weight;\n\tfn update_balance_non_native_currency() -\u003e Weight;\n\tfn update_balance_native_currency_creating() -\u003e Weight;\n\tfn update_balance_native_currency_killing() -\u003e Weight;\n}\n\ntype BalanceOf\u003cT\u003e = \u003c\u003cT as Trait\u003e::MultiCurrency as MultiCurrency\u003c\u003cT as frame_system::Trait\u003e::AccountId\u003e\u003e::Balance;\ntype CurrencyIdOf\u003cT\u003e =\n\t\u003c\u003cT as Trait\u003e::MultiCurrency as MultiCurrency\u003c\u003cT as frame_system::Trait\u003e::AccountId\u003e\u003e::CurrencyId;\n\ntype AmountOf\u003cT\u003e =\n\t\u003c\u003cT as Trait\u003e::MultiCurrency as MultiCurrencyExtended\u003c\u003cT as frame_system::Trait\u003e::AccountId\u003e\u003e::Amount;\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\ttype MultiCurrency: MultiCurrencyExtended\u003cSelf::AccountId\u003e\n\t\t+ MultiLockableCurrency\u003cSelf::AccountId\u003e\n\t\t+ MultiReservableCurrency\u003cSelf::AccountId\u003e;\n\ttype NativeCurrency: BasicCurrencyExtended\u003cSelf::AccountId, Balance = BalanceOf\u003cSelf\u003e, Amount = AmountOf\u003cSelf\u003e\u003e\n\t\t+ BasicLockableCurrency\u003cSelf::AccountId, Balance = BalanceOf\u003cSelf\u003e\u003e\n\t\t+ BasicReservableCurrency\u003cSelf::AccountId, Balance = BalanceOf\u003cSelf\u003e\u003e;\n\ttype GetNativeCurrencyId: Get\u003cCurrencyIdOf\u003cSelf\u003e\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Currencies {}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\tAmount = AmountOf\u003cT\u003e,\n\t\tBalance = BalanceOf\u003cT\u003e,\n\t\tCurrencyId = CurrencyIdOf\u003cT\u003e\n\t{\n\t\t/// Currency transfer success. [currency_id, from, to, amount]\n\t\tTransferred(CurrencyId, AccountId, AccountId, Balance),\n\t\t/// Update balance success. [currency_id, who, amount]\n\t\tBalanceUpdated(CurrencyId, AccountId, Amount),\n\t\t/// Deposit success. [currency_id, who, amount]\n\t\tDeposited(CurrencyId, AccountId, Balance),\n\t\t/// Withdraw success. [currency_id, who, amount]\n\t\tWithdrawn(CurrencyId, AccountId, Balance),\n\t}\n);\n\ndecl_error! {\n\t/// Error for currencies module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Unable to convert the Amount type into Balance.\n\t\tAmountIntoBalanceFailed,\n\t\t/// Balance is too low.\n\t\tBalanceTooLow,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tconst NativeCurrencyId: CurrencyIdOf\u003cT\u003e = T::GetNativeCurrencyId::get();\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Transfer some balance to another account under `currency_id`.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::MultiCurrency is orml_tokens\n\t\t///\t\t- T::NativeCurrency is pallet_balances\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 5\n\t\t/// - Db writes: 2\n\t\t/// -------------------\n\t\t/// Base Weight:\n\t\t///\t\t- non-native currency: 90.23 µs\n\t\t///\t\t- native currency in worst case: 70 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::transfer_non_native_currency()]\n\t\tpub fn transfer(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: CurrencyIdOf\u003cT\u003e,\n\t\t\t#[compact] amount: BalanceOf\u003cT\u003e,\n\t\t) {\n\t\t\tlet from = ensure_signed(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\t\u003cSelf as MultiCurrency\u003cT::AccountId\u003e\u003e::transfer(currency_id, \u0026from, \u0026to, amount)?;\n\t\t}\n\n\t\t/// Transfer some native currency to another account.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::MultiCurrency is orml_tokens\n\t\t///\t\t- T::NativeCurrency is pallet_balances\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 2 * `Accounts`\n\t\t/// - Db writes: 2 * `Accounts`\n\t\t/// -------------------\n\t\t/// Base Weight: 70 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::transfer_native_currency()]\n\t\tpub fn transfer_native_currency(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\t#[compact] amount: BalanceOf\u003cT\u003e,\n\t\t) {\n\t\t\tlet from = ensure_signed(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\tT::NativeCurrency::transfer(\u0026from, \u0026to, amount)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Transferred(T::GetNativeCurrencyId::get(), from, to, amount));\n\t\t}\n\n\t\t/// update amount of account `who` under `currency_id`.\n\t\t///\n\t\t/// The dispatch origin of this call must be _Root_.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::MultiCurrency is orml_tokens\n\t\t///\t\t- T::NativeCurrency is pallet_balances\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads:\n\t\t/// \t- non-native currency: 5\n\t\t/// - Db writes:\n\t\t/// \t- non-native currency: 2\n\t\t/// -------------------\n\t\t/// Base Weight:\n\t\t/// \t- non-native currency: 66.24 µs\n\t\t///\t\t- native currency and killing account: 26.33 µs\n\t\t///\t\t- native currency and create account: 27.39 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::update_balance_non_native_currency()]\n\t\tpub fn update_balance(\n\t\t\torigin,\n\t\t\twho: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: CurrencyIdOf\u003cT\u003e,\n\t\t\tamount: AmountOf\u003cT\u003e,\n\t\t) {\n\t\t\tensure_root(origin)?;\n\t\t\tlet dest = T::Lookup::lookup(who)?;\n\t\t\t\u003cSelf as MultiCurrencyExtended\u003cT::AccountId\u003e\u003e::update_balance(currency_id, \u0026dest, amount)?;\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {}\n\nimpl\u003cT: Trait\u003e MultiCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype CurrencyId = CurrencyIdOf\u003cT\u003e;\n\ttype Balance = BalanceOf\u003cT\u003e;\n\n\tfn total_issuance(currency_id: Self::CurrencyId) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::total_issuance()\n\t\t} else {\n\t\t\tT::MultiCurrency::total_issuance(currency_id)\n\t\t}\n\t}\n\n\tfn total_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::total_balance(who)\n\t\t} else {\n\t\t\tT::MultiCurrency::total_balance(currency_id, who)\n\t\t}\n\t}\n\n\tfn free_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::free_balance(who)\n\t\t} else {\n\t\t\tT::MultiCurrency::free_balance(currency_id, who)\n\t\t}\n\t}\n\n\tfn ensure_can_withdraw(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::ensure_can_withdraw(who, amount)\n\t\t} else {\n\t\t\tT::MultiCurrency::ensure_can_withdraw(currency_id, who, amount)\n\t\t}\n\t}\n\n\tfn transfer(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tfrom: \u0026T::AccountId,\n\t\tto: \u0026T::AccountId,\n\t\tamount: Self::Balance,\n\t) -\u003e DispatchResult {\n\t\tif amount.is_zero() || from == to {\n\t\t\treturn Ok(());\n\t\t}\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::transfer(from, to, amount)?;\n\t\t} else {\n\t\t\tT::MultiCurrency::transfer(currency_id, from, to, amount)?;\n\t\t}\n\t\tSelf::deposit_event(RawEvent::Transferred(currency_id, from.clone(), to.clone(), amount));\n\t\tOk(())\n\t}\n\n\tfn deposit(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::deposit(who, amount)?;\n\t\t} else {\n\t\t\tT::MultiCurrency::deposit(currency_id, who, amount)?;\n\t\t}\n\t\tSelf::deposit_event(RawEvent::Deposited(currency_id, who.clone(), amount));\n\t\tOk(())\n\t}\n\n\tfn withdraw(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::withdraw(who, amount)?;\n\t\t} else {\n\t\t\tT::MultiCurrency::withdraw(currency_id, who, amount)?;\n\t\t}\n\t\tSelf::deposit_event(RawEvent::Withdrawn(currency_id, who.clone(), amount));\n\t\tOk(())\n\t}\n\n\tfn can_slash(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e bool {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::can_slash(who, amount)\n\t\t} else {\n\t\t\tT::MultiCurrency::can_slash(currency_id, who, amount)\n\t\t}\n\t}\n\n\tfn slash(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::slash(who, amount)\n\t\t} else {\n\t\t\tT::MultiCurrency::slash(currency_id, who, amount)\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiCurrencyExtended\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype Amount = AmountOf\u003cT\u003e;\n\n\tfn update_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId, by_amount: Self::Amount) -\u003e DispatchResult {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::update_balance(who, by_amount)?;\n\t\t} else {\n\t\t\tT::MultiCurrency::update_balance(currency_id, who, by_amount)?;\n\t\t}\n\t\tSelf::deposit_event(RawEvent::BalanceUpdated(currency_id, who.clone(), by_amount));\n\t\tOk(())\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiLockableCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype Moment = T::BlockNumber;\n\n\tfn set_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::set_lock(lock_id, who, amount);\n\t\t} else {\n\t\t\tT::MultiCurrency::set_lock(lock_id, currency_id, who, amount);\n\t\t}\n\t}\n\n\tfn extend_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::extend_lock(lock_id, who, amount);\n\t\t} else {\n\t\t\tT::MultiCurrency::extend_lock(lock_id, currency_id, who, amount);\n\t\t}\n\t}\n\n\tfn remove_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId) {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::remove_lock(lock_id, who);\n\t\t} else {\n\t\t\tT::MultiCurrency::remove_lock(lock_id, currency_id, who);\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiReservableCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\tfn can_reserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::can_reserve(who, value)\n\t\t} else {\n\t\t\tT::MultiCurrency::can_reserve(currency_id, who, value)\n\t\t}\n\t}\n\n\tfn slash_reserved(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::slash_reserved(who, value)\n\t\t} else {\n\t\t\tT::MultiCurrency::slash_reserved(currency_id, who, value)\n\t\t}\n\t}\n\n\tfn reserved_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::reserved_balance(who)\n\t\t} else {\n\t\t\tT::MultiCurrency::reserved_balance(currency_id, who)\n\t\t}\n\t}\n\n\tfn reserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::reserve(who, value)\n\t\t} else {\n\t\t\tT::MultiCurrency::reserve(currency_id, who, value)\n\t\t}\n\t}\n\n\tfn unreserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::unreserve(who, value)\n\t\t} else {\n\t\t\tT::MultiCurrency::unreserve(currency_id, who, value)\n\t\t}\n\t}\n\n\tfn repatriate_reserved(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tslashed: \u0026T::AccountId,\n\t\tbeneficiary: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::repatriate_reserved(slashed, beneficiary, value, status)\n\t\t} else {\n\t\t\tT::MultiCurrency::repatriate_reserved(currency_id, slashed, beneficiary, value, status)\n\t\t}\n\t}\n}\n\npub struct Currency\u003cT, GetCurrencyId\u003e(marker::PhantomData\u003cT\u003e, marker::PhantomData\u003cGetCurrencyId\u003e);\n\nimpl\u003cT, GetCurrencyId\u003e BasicCurrency\u003cT::AccountId\u003e for Currency\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cCurrencyIdOf\u003cT\u003e\u003e,\n{\n\ttype Balance = BalanceOf\u003cT\u003e;\n\n\tfn total_issuance() -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e\u003e::total_issuance(GetCurrencyId::get())\n\t}\n\n\tfn total_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e\u003e::total_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn free_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e\u003e::free_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn ensure_can_withdraw(who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e\u003e::ensure_can_withdraw(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn transfer(from: \u0026T::AccountId, to: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e as MultiCurrency\u003cT::AccountId\u003e\u003e::transfer(GetCurrencyId::get(), from, to, amount)\n\t}\n\n\tfn deposit(who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e\u003e::deposit(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn withdraw(who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e\u003e::withdraw(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn can_slash(who: \u0026T::AccountId, amount: Self::Balance) -\u003e bool {\n\t\t\u003cModule\u003cT\u003e\u003e::can_slash(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn slash(who: \u0026T::AccountId, amount: Self::Balance) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e\u003e::slash(GetCurrencyId::get(), who, amount)\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e BasicCurrencyExtended\u003cT::AccountId\u003e for Currency\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cCurrencyIdOf\u003cT\u003e\u003e,\n{\n\ttype Amount = AmountOf\u003cT\u003e;\n\n\tfn update_balance(who: \u0026T::AccountId, by_amount: Self::Amount) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e as MultiCurrencyExtended\u003cT::AccountId\u003e\u003e::update_balance(GetCurrencyId::get(), who, by_amount)\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e BasicLockableCurrency\u003cT::AccountId\u003e for Currency\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cCurrencyIdOf\u003cT\u003e\u003e,\n{\n\ttype Moment = T::BlockNumber;\n\n\tfn set_lock(lock_id: LockIdentifier, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\t\u003cModule\u003cT\u003e as MultiLockableCurrency\u003cT::AccountId\u003e\u003e::set_lock(lock_id, GetCurrencyId::get(), who, amount);\n\t}\n\n\tfn extend_lock(lock_id: LockIdentifier, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\t\u003cModule\u003cT\u003e as MultiLockableCurrency\u003cT::AccountId\u003e\u003e::extend_lock(lock_id, GetCurrencyId::get(), who, amount);\n\t}\n\n\tfn remove_lock(lock_id: LockIdentifier, who: \u0026T::AccountId) {\n\t\t\u003cModule\u003cT\u003e as MultiLockableCurrency\u003cT::AccountId\u003e\u003e::remove_lock(lock_id, GetCurrencyId::get(), who);\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e BasicReservableCurrency\u003cT::AccountId\u003e for Currency\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cCurrencyIdOf\u003cT\u003e\u003e,\n{\n\tfn can_reserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::can_reserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn slash_reserved(who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::slash_reserved(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn reserved_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::reserved_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn reserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::reserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn unreserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::unreserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn repatriate_reserved(\n\t\tslashed: \u0026T::AccountId,\n\t\tbeneficiary: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::repatriate_reserved(\n\t\t\tGetCurrencyId::get(),\n\t\t\tslashed,\n\t\t\tbeneficiary,\n\t\t\tvalue,\n\t\t\tstatus,\n\t\t)\n\t}\n}\n\npub type NativeCurrencyOf\u003cT\u003e = Currency\u003cT, \u003cT as Trait\u003e::GetNativeCurrencyId\u003e;\n\n/// Adapt other currency traits implementation to `BasicCurrency`.\npub struct BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e(marker::PhantomData\u003c(T, Currency, Amount, Moment)\u003e);\n\ntype PalletBalanceOf\u003cA, Currency\u003e = \u003cCurrency as PalletCurrency\u003cA\u003e\u003e::Balance;\n\n// Adapt `frame_support::traits::Currency`\nimpl\u003cT, AccountId, Currency, Amount, Moment\u003e BasicCurrency\u003cAccountId\u003e\n\tfor BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e\nwhere\n\tCurrency: PalletCurrency\u003cAccountId\u003e,\n\tT: Trait,\n{\n\ttype Balance = PalletBalanceOf\u003cAccountId, Currency\u003e;\n\n\tfn total_issuance() -\u003e Self::Balance {\n\t\tCurrency::total_issuance()\n\t}\n\n\tfn total_balance(who: \u0026AccountId) -\u003e Self::Balance {\n\t\tCurrency::total_balance(who)\n\t}\n\n\tfn free_balance(who: \u0026AccountId) -\u003e Self::Balance {\n\t\tCurrency::free_balance(who)\n\t}\n\n\tfn ensure_can_withdraw(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tlet new_balance = Self::free_balance(who)\n\t\t\t.checked_sub(\u0026amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::BalanceTooLow)?;\n\n\t\tCurrency::ensure_can_withdraw(who, amount, WithdrawReasons::all(), new_balance)\n\t}\n\n\tfn transfer(from: \u0026AccountId, to: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tCurrency::transfer(from, to, amount, ExistenceRequirement::AllowDeath)\n\t}\n\n\tfn deposit(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tlet _ = Currency::deposit_creating(who, amount);\n\t\tOk(())\n\t}\n\n\tfn withdraw(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tCurrency::withdraw(who, amount, WithdrawReasons::all(), ExistenceRequirement::AllowDeath).map(|_| ())\n\t}\n\n\tfn can_slash(who: \u0026AccountId, amount: Self::Balance) -\u003e bool {\n\t\tCurrency::can_slash(who, amount)\n\t}\n\n\tfn slash(who: \u0026AccountId, amount: Self::Balance) -\u003e Self::Balance {\n\t\tlet (_, gap) = Currency::slash(who, amount);\n\t\tgap\n\t}\n}\n\n// Adapt `frame_support::traits::Currency`\nimpl\u003cT, AccountId, Currency, Amount, Moment\u003e BasicCurrencyExtended\u003cAccountId\u003e\n\tfor BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e\nwhere\n\tAmount: Signed\n\t\t+ TryInto\u003cPalletBalanceOf\u003cAccountId, Currency\u003e\u003e\n\t\t+ TryFrom\u003cPalletBalanceOf\u003cAccountId, Currency\u003e\u003e\n\t\t+ SimpleArithmetic\n\t\t+ Codec\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ Default,\n\tCurrency: PalletCurrency\u003cAccountId\u003e,\n\tT: Trait,\n{\n\ttype Amount = Amount;\n\n\tfn update_balance(who: \u0026AccountId, by_amount: Self::Amount) -\u003e DispatchResult {\n\t\tlet by_balance = by_amount\n\t\t\t.abs()\n\t\t\t.try_into()\n\t\t\t.map_err(|_| Error::\u003cT\u003e::AmountIntoBalanceFailed)?;\n\t\tif by_amount.is_positive() {\n\t\t\tSelf::deposit(who, by_balance)\n\t\t} else {\n\t\t\tSelf::withdraw(who, by_balance)\n\t\t}\n\t}\n}\n\n// Adapt `frame_support::traits::LockableCurrency`\nimpl\u003cT, AccountId, Currency, Amount, Moment\u003e BasicLockableCurrency\u003cAccountId\u003e\n\tfor BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e\nwhere\n\tCurrency: PalletLockableCurrency\u003cAccountId\u003e,\n\tT: Trait,\n{\n\ttype Moment = Moment;\n\n\tfn set_lock(lock_id: LockIdentifier, who: \u0026AccountId, amount: Self::Balance) {\n\t\tCurrency::set_lock(lock_id, who, amount, WithdrawReasons::all());\n\t}\n\n\tfn extend_lock(lock_id: LockIdentifier, who: \u0026AccountId, amount: Self::Balance) {\n\t\tCurrency::extend_lock(lock_id, who, amount, WithdrawReasons::all());\n\t}\n\n\tfn remove_lock(lock_id: LockIdentifier, who: \u0026AccountId) {\n\t\tCurrency::remove_lock(lock_id, who);\n\t}\n}\n\n// Adapt `frame_support::traits::ReservableCurrency`\nimpl\u003cT, AccountId, Currency, Amount, Moment\u003e BasicReservableCurrency\u003cAccountId\u003e\n\tfor BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e\nwhere\n\tCurrency: PalletReservableCurrency\u003cAccountId\u003e,\n\tT: Trait,\n{\n\tfn can_reserve(who: \u0026AccountId, value: Self::Balance) -\u003e bool {\n\t\tCurrency::can_reserve(who, value)\n\t}\n\n\tfn slash_reserved(who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tlet (_, gap) = Currency::slash_reserved(who, value);\n\t\tgap\n\t}\n\n\tfn reserved_balance(who: \u0026AccountId) -\u003e Self::Balance {\n\t\tCurrency::reserved_balance(who)\n\t}\n\n\tfn reserve(who: \u0026AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\tCurrency::reserve(who, value)\n\t}\n\n\tfn unreserve(who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tCurrency::unreserve(who, value)\n\t}\n\n\tfn repatriate_reserved(\n\t\tslashed: \u0026AccountId,\n\t\tbeneficiary: \u0026AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\tCurrency::repatriate_reserved(slashed, beneficiary, value, status)\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","currencies","src","mock.rs"],"content":"//! Mocks for the currencies module.\n\n#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse pallet_balances;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse tokens;\n\nuse super::*;\n\nmod currencies {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\tcurrencies\u003cT\u003e,\n\t\ttokens\u003cT\u003e,\n\t\tpallet_balances\u003cT\u003e,\n\t}\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = pallet_balances::AccountData\u003cu64\u003e;\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\ntype CurrencyId = u32;\ntype Balance = u64;\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n}\n\nimpl pallet_balances::Trait for Runtime {\n\ttype Balance = Balance;\n\ttype DustRemoval = ();\n\ttype Event = TestEvent;\n\ttype ExistentialDeposit = ExistentialDeposit;\n\ttype AccountStore = frame_system::Module\u003cRuntime\u003e;\n\ttype MaxLocks = ();\n\ttype WeightInfo = ();\n}\n\npub type PalletBalances = pallet_balances::Module\u003cRuntime\u003e;\n\nimpl tokens::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = i64;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\npub type Tokens = tokens::Module\u003cRuntime\u003e;\n\npub const NATIVE_CURRENCY_ID: CurrencyId = 1;\npub const X_TOKEN_ID: CurrencyId = 2;\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = NATIVE_CURRENCY_ID;\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = Tokens;\n\ttype NativeCurrency = AdaptedBasicCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\npub type Currencies = Module\u003cRuntime\u003e;\npub type NativeCurrency = NativeCurrencyOf\u003cRuntime\u003e;\npub type AdaptedBasicCurrency = BasicCurrencyAdapter\u003cRuntime, PalletBalances, i64, u64\u003e;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const EVA: AccountId = 5;\npub const ID_1: LockIdentifier = *b\"1       \";\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t}\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn balances(mut self, endowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e) -\u003e Self {\n\t\tself.endowed_accounts = endowed_accounts;\n\t\tself\n\t}\n\n\tpub fn one_hundred_for_alice_n_bob(self) -\u003e Self {\n\t\tself.balances(vec![\n\t\t\t(ALICE, NATIVE_CURRENCY_ID, 100),\n\t\t\t(BOB, NATIVE_CURRENCY_ID, 100),\n\t\t\t(ALICE, X_TOKEN_ID, 100),\n\t\t\t(BOB, X_TOKEN_ID, 100),\n\t\t])\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tpallet_balances::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tbalances: self\n\t\t\t\t.endowed_accounts\n\t\t\t\t.clone()\n\t\t\t\t.into_iter()\n\t\t\t\t.filter(|(_, currency_id, _)| *currency_id == NATIVE_CURRENCY_ID)\n\t\t\t\t.map(|(account_id, _, initial_balance)| (account_id, initial_balance))\n\t\t\t\t.collect::\u003cVec\u003c_\u003e\u003e(),\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\ttokens::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self\n\t\t\t\t.endowed_accounts\n\t\t\t\t.into_iter()\n\t\t\t\t.filter(|(_, currency_id, _)| *currency_id != NATIVE_CURRENCY_ID)\n\t\t\t\t.collect::\u003cVec\u003c_\u003e\u003e(),\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","currencies","src","tests.rs"],"content":"//! Unit tests for the currencies module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok};\nuse mock::{\n\tAccountId, AdaptedBasicCurrency, Currencies, ExtBuilder, NativeCurrency, Origin, PalletBalances, System, TestEvent,\n\tTokens, ALICE, BOB, EVA, ID_1, NATIVE_CURRENCY_ID, X_TOKEN_ID,\n};\nuse sp_runtime::traits::BadOrigin;\n\n#[test]\nfn multi_lockable_currency_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tCurrencies::set_lock(ID_1, X_TOKEN_ID, \u0026ALICE, 50);\n\t\t\tassert_eq!(Tokens::locks(\u0026ALICE, X_TOKEN_ID).len(), 1);\n\t\t\tCurrencies::set_lock(ID_1, NATIVE_CURRENCY_ID, \u0026ALICE, 50);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 1);\n\t\t});\n}\n\n#[test]\nfn multi_reservable_currency_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Currencies::total_issuance(NATIVE_CURRENCY_ID), 200);\n\t\t\tassert_eq!(Currencies::total_issuance(X_TOKEN_ID), 200);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 100);\n\n\t\t\tassert_ok!(Currencies::reserve(X_TOKEN_ID, \u0026ALICE, 30));\n\t\t\tassert_ok!(Currencies::reserve(NATIVE_CURRENCY_ID, \u0026ALICE, 40));\n\t\t\tassert_eq!(Currencies::reserved_balance(X_TOKEN_ID, \u0026ALICE), 30);\n\t\t\tassert_eq!(Currencies::reserved_balance(NATIVE_CURRENCY_ID, \u0026ALICE), 40);\n\t\t});\n}\n\n#[test]\nfn native_currency_lockable_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tNativeCurrency::set_lock(ID_1, \u0026ALICE, 10);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 1);\n\t\t\tNativeCurrency::remove_lock(ID_1, \u0026ALICE);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 0);\n\t\t});\n}\n\n#[test]\nfn native_currency_reservable_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(NativeCurrency::reserve(\u0026ALICE, 50));\n\t\t\tassert_eq!(NativeCurrency::reserved_balance(\u0026ALICE), 50);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_lockable() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tAdaptedBasicCurrency::set_lock(ID_1, \u0026ALICE, 10);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 1);\n\t\t\tAdaptedBasicCurrency::remove_lock(ID_1, \u0026ALICE);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 0);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_reservable() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::reserve(\u0026ALICE, 50));\n\t\t\tassert_eq!(AdaptedBasicCurrency::reserved_balance(\u0026ALICE), 50);\n\t\t});\n}\n\n#[test]\nfn multi_currency_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Currencies::transfer(Some(ALICE).into(), BOB, X_TOKEN_ID, 50));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026BOB), 150);\n\t\t});\n}\n\n#[test]\nfn multi_currency_extended_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrencyExtended\u003cAccountId\u003e\u003e::update_balance(\n\t\t\t\tX_TOKEN_ID, \u0026ALICE, 50\n\t\t\t));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 150);\n\t\t});\n}\n\n#[test]\nfn native_currency_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Currencies::transfer_native_currency(Some(ALICE).into(), BOB, 50));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 50);\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026BOB), 150);\n\n\t\t\tassert_ok!(NativeCurrency::transfer(\u0026ALICE, \u0026BOB, 10));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 40);\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026BOB), 160);\n\n\t\t\tassert_eq!(Currencies::slash(NATIVE_CURRENCY_ID, \u0026ALICE, 10), 0);\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 30);\n\t\t\tassert_eq!(NativeCurrency::total_issuance(), 190);\n\t\t});\n}\n\n#[test]\nfn native_currency_extended_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(NativeCurrency::update_balance(\u0026ALICE, 10));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 110);\n\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrencyExtended\u003cAccountId\u003e\u003e::update_balance(\n\t\t\t\tNATIVE_CURRENCY_ID,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t10\n\t\t\t));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 120);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_transfer() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::transfer(\u0026ALICE, \u0026BOB, 50));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 50);\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026BOB), 150);\n\n\t\t\t// creation fee\n\t\t\tassert_ok!(AdaptedBasicCurrency::transfer(\u0026ALICE, \u0026EVA, 10));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 40);\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026EVA), 10);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_deposit() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::deposit(\u0026EVA, 50));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026EVA), 50);\n\t\t\tassert_eq!(PalletBalances::total_issuance(), 250);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_withdraw() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::withdraw(\u0026ALICE, 100));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 0);\n\t\t\tassert_eq!(PalletBalances::total_issuance(), 100);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_slash() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(AdaptedBasicCurrency::slash(\u0026ALICE, 101), 1);\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 0);\n\t\t\tassert_eq!(PalletBalances::total_issuance(), 100);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_update_balance() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::update_balance(\u0026ALICE, -10));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 90);\n\t\t\tassert_eq!(PalletBalances::total_issuance(), 190);\n\t\t});\n}\n\n#[test]\nfn update_balance_call_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Currencies::update_balance(\n\t\t\t\tOrigin::root(),\n\t\t\t\tALICE,\n\t\t\t\tNATIVE_CURRENCY_ID,\n\t\t\t\t-10\n\t\t\t));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 90);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_ok!(Currencies::update_balance(Origin::root(), ALICE, X_TOKEN_ID, 10));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 110);\n\t\t});\n}\n\n#[test]\nfn update_balance_call_fails_if_not_root_origin() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_noop!(\n\t\t\tCurrencies::update_balance(Some(ALICE).into(), ALICE, X_TOKEN_ID, 100),\n\t\t\tBadOrigin\n\t\t);\n\t});\n}\n\n#[test]\nfn call_event_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Currencies::transfer(Some(ALICE).into(), BOB, X_TOKEN_ID, 50));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026BOB), 150);\n\n\t\t\tlet transferred_event = TestEvent::currencies(RawEvent::Transferred(X_TOKEN_ID, ALICE, BOB, 50));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrency\u003cAccountId\u003e\u003e::transfer(\n\t\t\t\tX_TOKEN_ID, \u0026ALICE, \u0026BOB, 10\n\t\t\t));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 40);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026BOB), 160);\n\n\t\t\tlet transferred_event = TestEvent::currencies(RawEvent::Transferred(X_TOKEN_ID, ALICE, BOB, 10));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrency\u003cAccountId\u003e\u003e::deposit(\n\t\t\t\tX_TOKEN_ID, \u0026ALICE, 100\n\t\t\t));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 140);\n\n\t\t\tlet transferred_event = TestEvent::currencies(RawEvent::Deposited(X_TOKEN_ID, ALICE, 100));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrency\u003cAccountId\u003e\u003e::withdraw(\n\t\t\t\tX_TOKEN_ID, \u0026ALICE, 20\n\t\t\t));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 120);\n\n\t\t\tlet transferred_event = TestEvent::currencies(RawEvent::Withdrawn(X_TOKEN_ID, ALICE, 20));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\t\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","gradually-update","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn gradually_update() -\u003e Weight {\n\t\t(57_922_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(1 as Weight))\n\t}\n\tfn cancel_gradually_update() -\u003e Weight {\n\t\t(66_687_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(1 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(1 as Weight))\n\t}\n\tfn on_finalize(u: u32) -\u003e Weight {\n\t\t(37_067_000 as Weight)\n\t\t\t.saturating_add((20_890_000 as Weight).saturating_mul(u as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","gradually-update","src","lib.rs"],"content":"//! # Gradually Update\n//! A module for scheduling gradually updates to storage values.\n//!\n//! - [`Trait`](./trait.Trait.html)\n//! - [`Call`](./enum.Call.html)\n//! - [`Module`](./struct.Module.html)\n//!\n//! ## Overview\n//!\n//! This module exposes capabilities for scheduling updates to storage values\n//! gradually. This is useful to change parameter values gradually to ensure a\n//! smooth transition. It is also possible to cancel an update before it reaches\n//! to target value.\n//!\n//! NOTE: Only unsigned integer value up to 128 bits are supported. But a\n//! \"newtype\" pattern struct that wraps an unsigned integer works too such as\n//! `Permill` and `FixedU128`.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// Disable the following two lints since they originate from an external macro (namely decl_storage)\n#![allow(clippy::string_lit_as_bytes)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, ensure, storage,\n\ttraits::{EnsureOrigin, Get},\n\tweights::Weight,\n};\nuse frame_system::ensure_root;\n\nuse sp_runtime::{traits::SaturatedConversion, DispatchResult, RuntimeDebug};\nuse sp_std::prelude::Vec;\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn gradually_update() -\u003e Weight;\n\tfn cancel_gradually_update() -\u003e Weight;\n\tfn on_finalize(u: u32) -\u003e Weight;\n}\n\ntype StorageKey = Vec\u003cu8\u003e;\ntype StorageValue = Vec\u003cu8\u003e;\n\n/// Gradually update a value stored at `key` to `target_value`,\n/// change `per_block` * `T::UpdateFrequency` per `T::UpdateFrequency` blocks.\n#[derive(Encode, Decode, Clone, Eq, PartialEq, RuntimeDebug)]\npub struct GraduallyUpdate {\n\t/// The storage key of the value to update\n\tpub key: StorageKey,\n\t/// The target value\n\tpub target_value: StorageValue,\n\t/// The amount of the value to update per one block\n\tpub per_block: StorageValue,\n}\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\t/// The frequency of updating values between blocks\n\ttype UpdateFrequency: Get\u003cSelf::BlockNumber\u003e;\n\t/// The origin that can schedule an update\n\ttype DispatchOrigin: EnsureOrigin\u003cSelf::Origin\u003e;\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as GraduallyUpdate {\n\t\t/// All the on-going updates\n\t\tpub GraduallyUpdates get(fn gradually_updates): Vec\u003cGraduallyUpdate\u003e;\n\t\t/// The last updated block number\n\t\tpub LastUpdatedAt get(fn last_updated_at): T::BlockNumber;\n\t}\n}\n\ndecl_event!(\n\t/// Event for gradually-update module.\n\tpub enum Event\u003cT\u003e where\n\t\u003cT as frame_system::Trait\u003e::BlockNumber,\n\t{\n\t\t/// Gradually update added. [key, per_block, target_value]\n\t\tGraduallyUpdateAdded(StorageKey, StorageValue, StorageValue),\n\t\t/// Gradually update cancelled. [key]\n\t\tGraduallyUpdateCancelled(StorageKey),\n\t\t/// Gradually update applied. [block_number, key, target_value]\n\t\tUpdated(BlockNumber, StorageKey, StorageValue),\n\t}\n);\n\ndecl_error! {\n\t/// Error for gradually-update module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The `per_block` or `target_value` is invalid.\n\t\tInvalidPerBlockOrTargetValue,\n\t\t/// The `target_value` is invalid.\n\t\tInvalidTargetValue,\n\t\t/// Another update is already been scheduled for this key.\n\t\tGraduallyUpdateHasExisted,\n\t\t/// No update exists to cancel.\n\t\tGraduallyUpdateNotFound,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\tconst UpdateFrequency: T::BlockNumber = T::UpdateFrequency::get();\n\n\t\t/// Add gradually_update to adjust numeric parameter.\n\t\t#[weight = T::WeightInfo::gradually_update()]\n\t\tpub fn gradually_update(origin, update: GraduallyUpdate) {\n\t\t\tT::DispatchOrigin::try_origin(origin).map(|_| ()).or_else(ensure_root)?;\n\n\t\t\t// Support max value is u128, ensure per_block and target_value \u003c= 16 bytes.\n\t\t\tensure!(update.per_block.len() == update.target_value.len() \u0026\u0026 update.per_block.len() \u003c= 16, Error::\u003cT\u003e::InvalidPerBlockOrTargetValue);\n\n\t\t\tif storage::unhashed::exists(\u0026update.key) {\n\t\t\t\tlet current_value = storage::unhashed::get::\u003cStorageValue\u003e(\u0026update.key).unwrap();\n\t\t\t\tensure!(current_value.len() == update.target_value.len(), Error::\u003cT\u003e::InvalidTargetValue);\n\t\t\t}\n\n\t\t\tGraduallyUpdates::try_mutate(|gradually_updates| -\u003e DispatchResult {\n\t\t\t\tensure!(!gradually_updates.contains(\u0026update), Error::\u003cT\u003e::GraduallyUpdateHasExisted);\n\n\t\t\t\tgradually_updates.push(update.clone());\n\n\t\t\t\tOk(())\n\t\t\t})?;\n\n\t\t\tSelf::deposit_event(RawEvent::GraduallyUpdateAdded(update.key, update.per_block, update.target_value));\n\t\t}\n\n\t\t/// Cancel gradually_update to adjust numeric parameter.\n\t\t#[weight = T::WeightInfo::cancel_gradually_update()]\n\t\tpub fn cancel_gradually_update(origin, key: StorageKey) {\n\t\t\tT::DispatchOrigin::try_origin(origin).map(|_| ()).or_else(ensure_root)?;\n\n\t\t\tGraduallyUpdates::try_mutate(|gradually_updates| -\u003e DispatchResult {\n\t\t\t\tlet old_len = gradually_updates.len();\n\t\t\t\tgradually_updates.retain(|item| item.key != key);\n\n\t\t\t\tensure!(gradually_updates.len() != old_len, Error::\u003cT\u003e::GraduallyUpdateNotFound);\n\n\t\t\t\tOk(())\n\t\t\t})?;\n\n\t\t\tSelf::deposit_event(RawEvent::GraduallyUpdateCancelled(key));\n\t\t}\n\n\t\t/// `on_initialize` to return the weight used in `on_finalize`.\n\t\tfn on_initialize() -\u003e Weight {\n\t\t\tlet now = \u003cframe_system::Module\u003cT\u003e\u003e::block_number();\n\t\t\tif Self::_need_update(now) {\n\t\t\t\tT::WeightInfo::on_finalize(GraduallyUpdates::get().len() as u32)\n\t\t\t} else {\n\t\t\t\t0\n\t\t\t}\n\t\t}\n\n\t\t/// Update gradually_update to adjust numeric parameter.\n\t\tfn on_finalize(now: T::BlockNumber) {\n\t\t\tSelf::_on_finalize(now);\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tfn _need_update(now: T::BlockNumber) -\u003e bool {\n\t\tnow \u003e= Self::last_updated_at() + T::UpdateFrequency::get()\n\t}\n\n\tfn _on_finalize(now: T::BlockNumber) {\n\t\tif !Self::_need_update(now) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet mut gradually_updates = GraduallyUpdates::get();\n\t\tlet initial_count = gradually_updates.len();\n\n\t\tgradually_updates.retain(|update| {\n\t\t\tlet mut keep = true;\n\t\t\tlet current_value = storage::unhashed::get::\u003cStorageValue\u003e(\u0026update.key).unwrap_or_default();\n\t\t\tlet current_value_u128 = u128::from_le_bytes(Self::convert_vec_to_u8(\u0026current_value));\n\n\t\t\tlet frequency_u128: u128 = T::UpdateFrequency::get().saturated_into();\n\n\t\t\tlet step = u128::from_le_bytes(Self::convert_vec_to_u8(\u0026update.per_block));\n\t\t\tlet step_u128 = step.checked_mul(frequency_u128).unwrap();\n\n\t\t\tlet target_u128 = u128::from_le_bytes(Self::convert_vec_to_u8(\u0026update.target_value));\n\n\t\t\tlet new_value_u128 = if current_value_u128 \u003e target_u128 {\n\t\t\t\t(current_value_u128.checked_sub(step_u128).unwrap()).max(target_u128)\n\t\t\t} else {\n\t\t\t\t(current_value_u128.checked_add(step_u128).unwrap()).min(target_u128)\n\t\t\t};\n\n\t\t\t// current_value equal target_value, remove gradually_update\n\t\t\tif new_value_u128 == target_u128 {\n\t\t\t\tkeep = false;\n\t\t\t}\n\n\t\t\tlet mut value = new_value_u128.encode();\n\t\t\tvalue.truncate(update.target_value.len());\n\n\t\t\tstorage::unhashed::put(\u0026update.key, \u0026value);\n\n\t\t\tSelf::deposit_event(RawEvent::Updated(now, update.key.clone(), value));\n\n\t\t\tkeep\n\t\t});\n\n\t\t// gradually_update has finished. Remove it from GraduallyUpdates.\n\t\tif gradually_updates.len() \u003c initial_count {\n\t\t\tGraduallyUpdates::put(gradually_updates);\n\t\t}\n\n\t\tLastUpdatedAt::\u003cT\u003e::put(now);\n\t}\n\n\t#[allow(clippy::ptr_arg)]\n\tfn convert_vec_to_u8(input: \u0026StorageValue) -\u003e [u8; 16] {\n\t\tlet mut array: [u8; 16] = [0; 16];\n\t\tfor (i, v) in input.iter().enumerate() {\n\t\t\tarray[i] = *v;\n\t\t}\n\t\tarray\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","gradually-update","src","mock.rs"],"content":"//! Mocks for the gradually-update module.\n\n#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse frame_system as system;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod gradually_update {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\tgradually_update\u003cT\u003e,\n\t}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\npub type BlockNumber = u64;\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = ();\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = system::Module\u003cRuntime\u003e;\n\nparameter_types! {\n\tpub const UpdateFrequency: BlockNumber = 10;\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype UpdateFrequency = UpdateFrequency;\n\ttype DispatchOrigin = system::EnsureRoot\u003cAccountId\u003e;\n\ttype WeightInfo = ();\n}\npub type GraduallyUpdateModule = Module\u003cRuntime\u003e;\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","gradually-update","src","tests.rs"],"content":"//! Unit tests for the gradually-update module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok, traits::OnFinalize};\nuse mock::{ExtBuilder, GraduallyUpdateModule, Origin, Runtime, System, TestEvent};\nuse sp_runtime::{FixedPointNumber, FixedU128, Permill};\n\nfn storage_set(key: \u0026Vec\u003cu8\u003e, value: \u0026Vec\u003cu8\u003e) {\n\tstorage::unhashed::put(key, value);\n}\n\nfn storage_get(key: \u0026Vec\u003cu8\u003e) -\u003e Vec\u003cu8\u003e {\n\tstorage::unhashed::get::\u003cStorageValue\u003e(key).unwrap_or_default()\n}\n\n#[test]\nfn gradually_update_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: vec![9],\n\t\t\tper_block: vec![1],\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\n\t\tlet gradually_update_event = TestEvent::gradually_update(RawEvent::GraduallyUpdateAdded(\n\t\t\tupdate.key,\n\t\t\tupdate.per_block,\n\t\t\tupdate.target_value,\n\t\t));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_event));\n\t});\n}\n\n#[test]\nfn gradually_update_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 9u32.encode(),\n\t\t\tper_block: 1u64.encode(),\n\t\t};\n\t\tassert_noop!(\n\t\t\tGraduallyUpdateModule::gradually_update(Origin::root(), update.clone()),\n\t\t\tError::\u003cRuntime\u003e::InvalidPerBlockOrTargetValue\n\t\t);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 90u32.encode(),\n\t\t\tper_block: 1u32.encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\n\t\tGraduallyUpdateModule::on_finalize(20);\n\n\t\tlet new_update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 9u64.encode(),\n\t\t\tper_block: 1u64.encode(),\n\t\t};\n\t\tassert_noop!(\n\t\t\tGraduallyUpdateModule::gradually_update(Origin::root(), new_update.clone()),\n\t\t\tError::\u003cRuntime\u003e::InvalidTargetValue\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tGraduallyUpdateModule::gradually_update(Origin::root(), update.clone()),\n\t\t\tError::\u003cRuntime\u003e::GraduallyUpdateHasExisted\n\t\t);\n\t});\n}\n\n#[test]\nfn cancel_gradually_update_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: vec![9],\n\t\t\tper_block: vec![1],\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tlet gradually_update_event = TestEvent::gradually_update(RawEvent::GraduallyUpdateAdded(\n\t\t\tupdate.key.clone(),\n\t\t\tupdate.per_block,\n\t\t\tupdate.target_value,\n\t\t));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_event));\n\n\t\tassert_ok!(GraduallyUpdateModule::cancel_gradually_update(\n\t\t\tOrigin::root(),\n\t\t\tupdate.key.clone()\n\t\t));\n\t\tlet cancel_gradually_update_event = TestEvent::gradually_update(RawEvent::GraduallyUpdateCancelled(update.key));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == cancel_gradually_update_event));\n\t});\n}\n\n#[test]\nfn cancel_gradually_update_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 9u32.encode(),\n\t\t\tper_block: 1u32.encode(),\n\t\t};\n\t\tassert_noop!(\n\t\t\tGraduallyUpdateModule::cancel_gradually_update(Origin::root(), update.key.clone()),\n\t\t\tError::\u003cRuntime\u003e::GraduallyUpdateNotFound\n\t\t);\n\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\n\t\tassert_ok!(GraduallyUpdateModule::cancel_gradually_update(\n\t\t\tOrigin::root(),\n\t\t\tupdate.key.clone()\n\t\t));\n\t});\n}\n\n#[test]\nfn add_on_finalize_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: vec![30],\n\t\t\tper_block: vec![1],\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(10, update.key.clone(), vec![10]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t\tassert_eq!(System::events().len(), 2);\n\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tassert_eq!(System::events().len(), 2);\n\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(20, update.key.clone(), vec![20]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t\tassert_eq!(System::events().len(), 3);\n\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(40, update.key.clone(), vec![30]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t});\n}\n\n#[test]\nfn sub_on_finalize_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: vec![5],\n\t\t\tper_block: vec![1],\n\t\t};\n\n\t\tstorage_set(\u0026update.key, \u0026vec![30]);\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30]);\n\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(10, update.key.clone(), vec![20]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t\tassert_eq!(System::events().len(), 2);\n\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20]);\n\t\tassert_eq!(System::events().len(), 2);\n\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(20, update.key.clone(), vec![10]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t\tassert_eq!(System::events().len(), 3);\n\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![5]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(40, update.key.clone(), vec![5]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t});\n}\n\n#[test]\nfn u32_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 30u32.encode(),\n\t\t\tper_block: 1u32.encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10, 0, 0, 0]);\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10, 0, 0, 0]);\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20, 0, 0, 0]);\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30, 0, 0, 0]);\n\t});\n}\n\n#[test]\nfn u128_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 30u128.encode(),\n\t\t\tper_block: 1u128.encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![20, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t});\n}\n\n#[test]\nfn permill_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: Permill::from_percent(30).encode(),\n\t\t\tper_block: Permill::from_percent(1).encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![160, 134, 1, 0]);\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![160, 134, 1, 0]);\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![64, 13, 3, 0]);\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![224, 147, 4, 0]);\n\t});\n}\n\n#[test]\nfn fixedu128_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: FixedU128::saturating_from_rational(30, 1).encode(),\n\t\t\tper_block: FixedU128::saturating_from_rational(1, 1).encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![0, 0, 232, 137, 4, 35, 199, 138, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![0, 0, 232, 137, 4, 35, 199, 138, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![0, 0, 208, 19, 9, 70, 142, 21, 1, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![0, 0, 184, 157, 13, 105, 85, 160, 1, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t});\n}\n\n#[test]\nfn finish_multiple_on_finalize_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![10],\n\t\t\ttarget_value: vec![30],\n\t\t\tper_block: vec![1],\n\t\t};\n\t\tlet update2 = GraduallyUpdate {\n\t\t\tkey: vec![20],\n\t\t\ttarget_value: vec![60],\n\t\t\tper_block: vec![2],\n\t\t};\n\t\tlet update3 = GraduallyUpdate {\n\t\t\tkey: vec![30],\n\t\t\ttarget_value: vec![100],\n\t\t\tper_block: vec![3],\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update2.clone()));\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update3.clone()));\n\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![20]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![30]);\n\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![20]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![30]);\n\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![40]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![60]);\n\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![60]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![90]);\n\n\t\tGraduallyUpdateModule::on_finalize(50);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![60]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![100]);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","nft","src","lib.rs"],"content":"//! # Non Fungible Token\n//! The module provides implementations for non-fungible-token.\n//!\n//! - [`Trait`](./trait.Trait.html)\n//! - [`Call`](./enum.Call.html)\n//! - [`Module`](./struct.Module.html)\n//!\n//! ## Overview\n//!\n//! This module provides basic functions to create and manager\n//! NFT(non fungible token) such as `create_class`, `transfer`, `mint`, `burn`.\n\n//! ### Module Functions\n//!\n//! - `create_class` - Create NFT(non fungible token) class\n//! - `transfer` - Transfer NFT(non fungible token) to another account.\n//! - `mint` - Mint NFT(non fungible token)\n//! - `burn` - Burn NFT(non fungible token)\n//! - `destroy_class` - Destroy NFT(non fungible token) class\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{decl_error, decl_module, decl_storage, ensure, Parameter};\nuse sp_runtime::{\n\ttraits::{AtLeast32BitUnsigned, CheckedAdd, CheckedSub, Member, One, Zero},\n\tDispatchError, DispatchResult, RuntimeDebug,\n};\nuse sp_std::vec::Vec;\n\nmod mock;\nmod tests;\n\n/// Class info\n#[derive(Encode, Decode, Clone, Eq, PartialEq, RuntimeDebug)]\npub struct ClassInfo\u003cTokenId, AccountId, Data\u003e {\n\t/// Class metadata\n\tpub metadata: Vec\u003cu8\u003e,\n\t/// Total issuance for the class\n\tpub total_issuance: TokenId,\n\t/// Class owner\n\tpub owner: AccountId,\n\t/// Class Properties\n\tpub data: Data,\n}\n\n/// Token info\n#[derive(Encode, Decode, Clone, Eq, PartialEq, RuntimeDebug)]\npub struct TokenInfo\u003cAccountId, Data\u003e {\n\t/// Token metadata\n\tpub metadata: Vec\u003cu8\u003e,\n\t/// Token owner\n\tpub owner: AccountId,\n\t/// Token Properties\n\tpub data: Data,\n}\n\npub trait Trait: frame_system::Trait {\n\t/// The class ID type\n\ttype ClassId: Parameter + Member + AtLeast32BitUnsigned + Default + Copy;\n\t/// The token ID type\n\ttype TokenId: Parameter + Member + AtLeast32BitUnsigned + Default + Copy;\n\t/// The class properties type\n\ttype ClassData: Parameter + Member;\n\t/// The token properties type\n\ttype TokenData: Parameter + Member;\n}\n\ndecl_error! {\n\t/// Error for non-fungible-token module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// No available class ID\n\t\tNoAvailableClassId,\n\t\t/// No available token ID\n\t\tNoAvailableTokenId,\n\t\t/// Token(ClassId, TokenId) not found\n\t\tTokenNotFound,\n\t\t/// Class not found\n\t\tClassNotFound,\n\t\t/// The operator is not the owner of the token and has no permission\n\t\tNoPermission,\n\t\t/// Arithmetic calculation overflow\n\t\tNumOverflow,\n\t\t/// Can not destroy class\n\t\t/// Total issuance is not 0\n\t\tCannotDestroyClass,\n\t}\n}\n\npub type ClassInfoOf\u003cT\u003e =\n\tClassInfo\u003c\u003cT as Trait\u003e::TokenId, \u003cT as frame_system::Trait\u003e::AccountId, \u003cT as Trait\u003e::ClassData\u003e;\npub type TokenInfoOf\u003cT\u003e = TokenInfo\u003c\u003cT as frame_system::Trait\u003e::AccountId, \u003cT as Trait\u003e::TokenData\u003e;\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as NonFungibleToken {\n\t\t/// Next available class ID.\n\t\tpub NextClassId get(fn next_class_id): T::ClassId;\n\t\t/// Next available token ID.\n\t\tpub NextTokenId get(fn next_token_id): T::TokenId;\n\t\t/// Store class info.\n\t\t///\n\t\t/// Returns `None` if class info not set or removed.\n\t\tpub Classes get(fn classes): map hasher(twox_64_concat) T::ClassId =\u003e Option\u003cClassInfoOf\u003cT\u003e\u003e;\n\t\t/// Store token info.\n\t\t///\n\t\t/// Returns `None` if token info not set or removed.\n\t\tpub Tokens get(fn tokens): double_map hasher(twox_64_concat) T::ClassId, hasher(twox_64_concat) T::TokenId =\u003e Option\u003cTokenInfoOf\u003cT\u003e\u003e;\n\t\t/// Token existence check by owner and class ID.\n\t\tpub TokensByOwner get(fn tokens_by_owner): double_map hasher(twox_64_concat) T::AccountId, hasher(twox_64_concat) (T::ClassId, T::TokenId) =\u003e Option\u003c()\u003e;\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Create NFT(non fungible token) class\n\tpub fn create_class(\n\t\towner: \u0026T::AccountId,\n\t\tmetadata: Vec\u003cu8\u003e,\n\t\tdata: T::ClassData,\n\t) -\u003e Result\u003cT::ClassId, DispatchError\u003e {\n\t\tlet class_id = NextClassId::\u003cT\u003e::try_mutate(|id| -\u003e Result\u003cT::ClassId, DispatchError\u003e {\n\t\t\tlet current_id = *id;\n\t\t\t*id = id.checked_add(\u0026One::one()).ok_or(Error::\u003cT\u003e::NoAvailableClassId)?;\n\t\t\tOk(current_id)\n\t\t})?;\n\n\t\tlet info = ClassInfo {\n\t\t\tmetadata,\n\t\t\ttotal_issuance: Default::default(),\n\t\t\towner: owner.clone(),\n\t\t\tdata,\n\t\t};\n\t\tClasses::\u003cT\u003e::insert(class_id, info);\n\n\t\tOk(class_id)\n\t}\n\n\t/// Transfer NFT(non fungible token) from `from` account to `to` account\n\tpub fn transfer(from: \u0026T::AccountId, to: \u0026T::AccountId, token: (T::ClassId, T::TokenId)) -\u003e DispatchResult {\n\t\tif from == to {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\tTokensByOwner::\u003cT\u003e::try_mutate_exists(from, token, |token_by_owner| -\u003e DispatchResult {\n\t\t\tensure!(token_by_owner.take().is_some(), Error::\u003cT\u003e::NoPermission);\n\t\t\tTokensByOwner::\u003cT\u003e::insert(to, token, ());\n\n\t\t\tTokens::\u003cT\u003e::try_mutate_exists(token.0, token.1, |token_info| -\u003e DispatchResult {\n\t\t\t\tlet mut info = token_info.as_mut().ok_or(Error::\u003cT\u003e::TokenNotFound)?;\n\t\t\t\tinfo.owner = to.clone();\n\t\t\t\tOk(())\n\t\t\t})\n\t\t})\n\t}\n\n\t/// Mint NFT(non fungible token) to `owner`\n\tpub fn mint(\n\t\towner: \u0026T::AccountId,\n\t\tclass_id: T::ClassId,\n\t\tmetadata: Vec\u003cu8\u003e,\n\t\tdata: T::TokenData,\n\t) -\u003e Result\u003cT::TokenId, DispatchError\u003e {\n\t\tNextTokenId::\u003cT\u003e::try_mutate(|id| -\u003e Result\u003cT::TokenId, DispatchError\u003e {\n\t\t\tlet token_id = *id;\n\t\t\t*id = id.checked_add(\u0026One::one()).ok_or(Error::\u003cT\u003e::NoAvailableTokenId)?;\n\n\t\t\tClasses::\u003cT\u003e::try_mutate(class_id, |class_info| -\u003e DispatchResult {\n\t\t\t\tlet info = class_info.as_mut().ok_or(Error::\u003cT\u003e::ClassNotFound)?;\n\t\t\t\tinfo.total_issuance = info\n\t\t\t\t\t.total_issuance\n\t\t\t\t\t.checked_add(\u0026One::one())\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\tOk(())\n\t\t\t})?;\n\n\t\t\tlet token_info = TokenInfo {\n\t\t\t\tmetadata,\n\t\t\t\towner: owner.clone(),\n\t\t\t\tdata,\n\t\t\t};\n\t\t\tTokens::\u003cT\u003e::insert(class_id, token_id, token_info);\n\t\t\tTokensByOwner::\u003cT\u003e::insert(owner, (class_id, token_id), ());\n\n\t\t\tOk(token_id)\n\t\t})\n\t}\n\n\t/// Burn NFT(non fungible token) from `owner`\n\tpub fn burn(owner: \u0026T::AccountId, token: (T::ClassId, T::TokenId)) -\u003e DispatchResult {\n\t\tTokens::\u003cT\u003e::try_mutate_exists(token.0, token.1, |token_info| -\u003e DispatchResult {\n\t\t\tensure!(token_info.take().is_some(), Error::\u003cT\u003e::TokenNotFound);\n\n\t\t\tTokensByOwner::\u003cT\u003e::try_mutate_exists(owner, token, |info| -\u003e DispatchResult {\n\t\t\t\tensure!(info.take().is_some(), Error::\u003cT\u003e::NoPermission);\n\n\t\t\t\tClasses::\u003cT\u003e::try_mutate(token.0, |class_info| -\u003e DispatchResult {\n\t\t\t\t\tlet info = class_info.as_mut().ok_or(Error::\u003cT\u003e::ClassNotFound)?;\n\t\t\t\t\tinfo.total_issuance = info\n\t\t\t\t\t\t.total_issuance\n\t\t\t\t\t\t.checked_sub(\u0026One::one())\n\t\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\t\tOk(())\n\t\t\t\t})\n\t\t\t})\n\t\t})\n\t}\n\n\t/// Destroy NFT(non fungible token) class\n\tpub fn destroy_class(owner: \u0026T::AccountId, class_id: T::ClassId) -\u003e DispatchResult {\n\t\tClasses::\u003cT\u003e::try_mutate_exists(class_id, |class_info| -\u003e DispatchResult {\n\t\t\tlet info = class_info.take().ok_or(Error::\u003cT\u003e::ClassNotFound)?;\n\t\t\tensure!(info.owner == *owner, Error::\u003cT\u003e::NoPermission);\n\t\t\tensure!(info.total_issuance == Zero::zero(), Error::\u003cT\u003e::CannotDestroyClass);\n\t\t\tOk(())\n\t\t})\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","nft","src","mock.rs"],"content":"//! Mocks for the gradually-update module.\n\n#![cfg(test)]\n\nuse frame_support::{impl_outer_origin, parameter_types};\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\npub type BlockNumber = u64;\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = ();\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = ();\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\nimpl Trait for Runtime {\n\ttype ClassId = u64;\n\ttype TokenId = u64;\n\ttype ClassData = ();\n\ttype TokenData = ();\n}\npub type NonFungibleTokenModule = Module\u003cRuntime\u003e;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const CLASS_ID: \u003cRuntime as Trait\u003e::ClassId = 0;\npub const CLASS_ID_NOT_EXIST: \u003cRuntime as Trait\u003e::ClassId = 1;\npub const TOKEN_ID: \u003cRuntime as Trait\u003e::TokenId = 0;\npub const TOKEN_ID_NOT_EXIST: \u003cRuntime as Trait\u003e::TokenId = 1;\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","nft","src","tests.rs"],"content":"//! Unit tests for the non-fungible-token module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok};\nuse mock::{\n\tExtBuilder, NonFungibleTokenModule, Runtime, ALICE, BOB, CLASS_ID, CLASS_ID_NOT_EXIST, TOKEN_ID, TOKEN_ID_NOT_EXIST,\n};\n\n#[test]\nfn create_class_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t});\n}\n\n#[test]\nfn create_class_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tNextClassId::\u003cRuntime\u003e::mutate(|id| *id = \u003cRuntime as Trait\u003e::ClassId::max_value());\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()),\n\t\t\tError::\u003cRuntime\u003e::NoAvailableClassId\n\t\t);\n\t});\n}\n\n#[test]\nfn mint_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t});\n}\n\n#[test]\nfn mint_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tClasses::\u003cRuntime\u003e::mutate(CLASS_ID, |class_info| {\n\t\t\tclass_info.as_mut().unwrap().total_issuance = \u003cRuntime as Trait\u003e::TokenId::max_value();\n\t\t});\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\tNextTokenId::\u003cRuntime\u003e::mutate(|id| *id = \u003cRuntime as Trait\u003e::TokenId::max_value());\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()),\n\t\t\tError::\u003cRuntime\u003e::NoAvailableTokenId\n\t\t);\n\t});\n}\n\n#[test]\nfn transfer_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::transfer(\u0026BOB, \u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t\tassert_ok!(NonFungibleTokenModule::transfer(\u0026BOB, \u0026ALICE, (CLASS_ID, TOKEN_ID)));\n\t\tassert_ok!(NonFungibleTokenModule::transfer(\u0026ALICE, \u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t});\n}\n\n#[test]\nfn transfer_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::transfer(\u0026BOB, \u0026ALICE, (CLASS_ID, TOKEN_ID_NOT_EXIST)),\n\t\t\tError::\u003cRuntime\u003e::NoPermission\n\t\t);\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::transfer(\u0026ALICE, \u0026BOB, (CLASS_ID, TOKEN_ID)),\n\t\t\tError::\u003cRuntime\u003e::NoPermission\n\t\t);\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::mint(\u0026BOB, CLASS_ID_NOT_EXIST, vec![1], ()),\n\t\t\tError::\u003cRuntime\u003e::ClassNotFound\n\t\t);\n\t});\n}\n\n#[test]\nfn burn_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t});\n}\n\n#[test]\nfn burn_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID_NOT_EXIST)),\n\t\t\tError::\u003cRuntime\u003e::TokenNotFound\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::burn(\u0026ALICE, (CLASS_ID, TOKEN_ID)),\n\t\t\tError::\u003cRuntime\u003e::NoPermission\n\t\t);\n\t});\n\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\n\t\tClasses::\u003cRuntime\u003e::mutate(CLASS_ID, |class_info| {\n\t\t\tclass_info.as_mut().unwrap().total_issuance = 0;\n\t\t});\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID)),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn destroy_class_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t\tassert_ok!(NonFungibleTokenModule::destroy_class(\u0026ALICE, CLASS_ID));\n\t});\n}\n\n#[test]\nfn destroy_class_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::destroy_class(\u0026ALICE, CLASS_ID_NOT_EXIST),\n\t\t\tError::\u003cRuntime\u003e::ClassNotFound\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::destroy_class(\u0026BOB, CLASS_ID),\n\t\t\tError::\u003cRuntime\u003e::NoPermission\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::destroy_class(\u0026ALICE, CLASS_ID),\n\t\t\tError::\u003cRuntime\u003e::CannotDestroyClass\n\t\t);\n\n\t\tassert_ok!(NonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t\tassert_ok!(NonFungibleTokenModule::destroy_class(\u0026ALICE, CLASS_ID));\n\t\tassert_eq!(Classes::\u003cRuntime\u003e::contains_key(CLASS_ID), false);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","rpc","runtime-api","src","lib.rs"],"content":"//! Runtime API definition for oracle module.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// The `too_many_arguments` warning originates from `decl_runtime_apis` macro.\n#![allow(clippy::too_many_arguments)]\n// The `unnecessary_mut_passed` warning originates from `decl_runtime_apis` macro.\n#![allow(clippy::unnecessary_mut_passed)]\n\nuse codec::Codec;\nuse sp_std::prelude::Vec;\n\nsp_api::decl_runtime_apis! {\n\tpub trait OracleApi\u003cProviderId, Key, Value\u003e where\n\t\tProviderId: Codec,\n\t\tKey: Codec,\n\t\tValue: Codec,\n\t{\n\t\tfn get_value(provider_id: ProviderId, key: Key) -\u003e Option\u003cValue\u003e;\n\t\tfn get_all_values(provider_id: ProviderId) -\u003e Vec\u003c(Key, Option\u003cValue\u003e)\u003e;\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","rpc","src","lib.rs"],"content":"use std::sync::Arc;\n\nuse codec::Codec;\nuse jsonrpc_core::{Error as RpcError, ErrorCode, Result};\nuse jsonrpc_derive::rpc;\nuse sp_api::ProvideRuntimeApi;\nuse sp_blockchain::HeaderBackend;\nuse sp_runtime::{generic::BlockId, traits::Block as BlockT};\n\npub use self::gen_client::Client as OracleClient;\npub use orml_oracle_rpc_runtime_api::OracleApi as OracleRuntimeApi;\n\n#[rpc]\npub trait OracleApi\u003cBlockHash, ProviderId, Key, Value\u003e {\n\t#[rpc(name = \"oracle_getValue\")]\n\tfn get_value(\u0026self, provider_id: ProviderId, key: Key, at: Option\u003cBlockHash\u003e) -\u003e Result\u003cOption\u003cValue\u003e\u003e;\n\t#[rpc(name = \"oracle_getAllValues\")]\n\tfn get_all_values(\u0026self, provider_id: ProviderId, at: Option\u003cBlockHash\u003e) -\u003e Result\u003cVec\u003c(Key, Option\u003cValue\u003e)\u003e\u003e;\n}\n\n/// A struct that implements the [`OracleApi`].\npub struct Oracle\u003cC, B\u003e {\n\tclient: Arc\u003cC\u003e,\n\t_marker: std::marker::PhantomData\u003cB\u003e,\n}\n\nimpl\u003cC, B\u003e Oracle\u003cC, B\u003e {\n\t/// Create new `Oracle` with the given reference to the client.\n\tpub fn new(client: Arc\u003cC\u003e) -\u003e Self {\n\t\tOracle {\n\t\t\tclient,\n\t\t\t_marker: Default::default(),\n\t\t}\n\t}\n}\n\npub enum Error {\n\tRuntimeError,\n}\n\nimpl From\u003cError\u003e for i64 {\n\tfn from(e: Error) -\u003e i64 {\n\t\tmatch e {\n\t\t\tError::RuntimeError =\u003e 1,\n\t\t}\n\t}\n}\n\nimpl\u003cC, Block, ProviderId, Key, Value\u003e OracleApi\u003c\u003cBlock as BlockT\u003e::Hash, ProviderId, Key, Value\u003e for Oracle\u003cC, Block\u003e\nwhere\n\tBlock: BlockT,\n\tC: Send + Sync + 'static + ProvideRuntimeApi\u003cBlock\u003e + HeaderBackend\u003cBlock\u003e,\n\tC::Api: OracleRuntimeApi\u003cBlock, ProviderId, Key, Value\u003e,\n\tProviderId: Codec,\n\tKey: Codec,\n\tValue: Codec,\n{\n\tfn get_value(\n\t\t\u0026self,\n\t\tprovider_id: ProviderId,\n\t\tkey: Key,\n\t\tat: Option\u003c\u003cBlock as BlockT\u003e::Hash\u003e,\n\t) -\u003e Result\u003cOption\u003cValue\u003e\u003e {\n\t\tlet api = self.client.runtime_api();\n\t\tlet at = BlockId::hash(at.unwrap_or(\n\t\t\t// If the block hash is not supplied assume the best block.\n\t\t\tself.client.info().best_hash,\n\t\t));\n\t\tapi.get_value(\u0026at, provider_id, key).map_err(|e| RpcError {\n\t\t\tcode: ErrorCode::ServerError(Error::RuntimeError.into()),\n\t\t\tmessage: \"Unable to get value.\".into(),\n\t\t\tdata: Some(format!(\"{:?}\", e).into()),\n\t\t})\n\t}\n\n\tfn get_all_values(\n\t\t\u0026self,\n\t\tprovider_id: ProviderId,\n\t\tat: Option\u003c\u003cBlock as BlockT\u003e::Hash\u003e,\n\t) -\u003e Result\u003cVec\u003c(Key, Option\u003cValue\u003e)\u003e\u003e {\n\t\tlet api = self.client.runtime_api();\n\t\tlet at = BlockId::hash(at.unwrap_or(\n\t\t\t// If the block hash is not supplied assume the best block.\n\t\t\tself.client.info().best_hash,\n\t\t));\n\t\tapi.get_all_values(\u0026at, provider_id).map_err(|e| RpcError {\n\t\t\tcode: ErrorCode::ServerError(Error::RuntimeError.into()),\n\t\t\tmessage: \"Unable to get all values.\".into(),\n\t\t\tdata: Some(format!(\"{:?}\", e).into()),\n\t\t})\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","default_combine_data.rs"],"content":"use crate::{DefaultInstance, Instance, MomentOf, TimestampedValueOf, Trait};\nuse frame_support::traits::{Get, Time};\nuse orml_traits::CombineData;\nuse sp_std::{marker, prelude::*};\n\n/// Sort by value and returns median timestamped value.\n/// Returns prev_value if not enough valid values.\npub struct DefaultCombineData\u003cT, MinimumCount, ExpiresIn, I = DefaultInstance\u003e(\n\tmarker::PhantomData\u003c(T, I, MinimumCount, ExpiresIn)\u003e,\n);\n\nimpl\u003cT, I, MinimumCount, ExpiresIn\u003e CombineData\u003c\u003cT as Trait\u003cI\u003e\u003e::OracleKey, TimestampedValueOf\u003cT, I\u003e\u003e\n\tfor DefaultCombineData\u003cT, MinimumCount, ExpiresIn, I\u003e\nwhere\n\tT: Trait\u003cI\u003e,\n\tI: Instance,\n\tMinimumCount: Get\u003cu32\u003e,\n\tExpiresIn: Get\u003cMomentOf\u003cT, I\u003e\u003e,\n{\n\tfn combine_data(\n\t\t_key: \u0026\u003cT as Trait\u003cI\u003e\u003e::OracleKey,\n\t\tmut values: Vec\u003cTimestampedValueOf\u003cT, I\u003e\u003e,\n\t\tprev_value: Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e,\n\t) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tlet expires_in = ExpiresIn::get();\n\t\tlet now = T::Time::now();\n\n\t\tvalues.retain(|x| x.timestamp + expires_in \u003e now);\n\n\t\tlet count = values.len() as u32;\n\t\tlet minimum_count = MinimumCount::get();\n\t\tif count \u003c minimum_count {\n\t\t\treturn prev_value;\n\t\t}\n\n\t\tvalues.sort_by(|a, b| a.value.cmp(\u0026b.value));\n\n\t\tlet median_index = count / 2;\n\t\tSome(values[median_index as usize].clone())\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn feed_values(c: u32) -\u003e Weight {\n\t\t(74_792_000 as Weight)\n\t\t\t.saturating_add((11_208_000 as Weight).saturating_mul(c as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(1 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes((2 as Weight).saturating_mul(c as Weight)))\n\t}\n\tfn on_finalize() -\u003e Weight {\n\t\t(15_881_000 as Weight).saturating_add(DbWeight::get().writes(1 as Weight))\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","lib.rs"],"content":"//! # Oracle\n//! A module to allow oracle operators to feed external data.\n//!\n//! - [`Trait`](./trait.Trait.html)\n//! - [`Call`](./enum.Call.html)\n//! - [`Module`](./struct.Module.html)\n//!\n//! ## Overview\n//!\n//! This module exposes capabilities for oracle operators to feed external\n//! offchain data. The raw values can be combined to provide an aggregated\n//! value.\n//!\n//! The data are submitted with unsigned transaction so it does not incure a\n//! transaction fee. However the data still needs to be signed by a session key\n//! to prevent spam and ensure the integrity.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// Disable the following two lints since they originate from an external macro (namely decl_storage)\n#![allow(clippy::string_lit_as_bytes)]\n\nmod default_combine_data;\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn feed_values(c: u32) -\u003e Weight;\n\tfn on_finalize() -\u003e Weight;\n}\n\nuse codec::{Decode, Encode};\npub use default_combine_data::DefaultCombineData;\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage,\n\tdispatch::DispatchResultWithPostInfo,\n\tensure,\n\ttraits::{ChangeMembers, Get, InitializeMembers, Time},\n\tweights::{DispatchClass, Pays, Weight},\n\tIterableStorageMap, Parameter,\n};\nuse frame_system::{ensure_root, ensure_signed};\npub use orml_traits::{CombineData, DataFeeder, DataProvider, DataProviderExtended, OnNewData};\nuse orml_utilities::OrderedSet;\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::{traits::Member, DispatchResult, RuntimeDebug};\nuse sp_std::{prelude::*, vec};\n\ntype MomentOf\u003cT, I = DefaultInstance\u003e = \u003c\u003cT as Trait\u003cI\u003e\u003e::Time as Time\u003e::Moment;\npub type TimestampedValueOf\u003cT, I = DefaultInstance\u003e = TimestampedValue\u003c\u003cT as Trait\u003cI\u003e\u003e::OracleValue, MomentOf\u003cT, I\u003e\u003e;\n\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Clone, Copy, Ord, PartialOrd)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub struct TimestampedValue\u003cValue, Moment\u003e {\n\tpub value: Value,\n\tpub timestamp: Moment,\n}\n\npub trait Trait\u003cI: Instance = DefaultInstance\u003e: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf, I\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// Hook on new data received\n\ttype OnNewData: OnNewData\u003cSelf::AccountId, Self::OracleKey, Self::OracleValue\u003e;\n\n\t/// Provide the implementation to combine raw values to produce aggregated\n\t/// value\n\ttype CombineData: CombineData\u003cSelf::OracleKey, TimestampedValueOf\u003cSelf, I\u003e\u003e;\n\n\t/// Time provider\n\ttype Time: Time;\n\n\t/// The data key type\n\ttype OracleKey: Parameter + Member;\n\n\t/// The data value type\n\ttype OracleValue: Parameter + Member + Ord;\n\n\t/// The root operator account id, recorad all sudo feeds on this account.\n\ttype RootOperatorAccountId: Get\u003cSelf::AccountId\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003cI\u003e, I: Instance\u003e {\n\t\t/// Sender does not have permission\n\t\tNoPermission,\n\t\t/// Feeder has already feeded at this block\n\t\tAlreadyFeeded,\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT, I=DefaultInstance\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\t\u003cT as Trait\u003cI\u003e\u003e::OracleKey,\n\t\t\u003cT as Trait\u003cI\u003e\u003e::OracleValue,\n\t{\n\t\t/// New feed data is submitted. [sender, values]\n\t\tNewFeedData(AccountId, Vec\u003c(OracleKey, OracleValue)\u003e),\n\t}\n);\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003cI\u003e, I: Instance=DefaultInstance\u003e as Oracle {\n\n\t\t/// Raw values for each oracle operators\n\t\tpub RawValues get(fn raw_values): double_map hasher(twox_64_concat) T::AccountId, hasher(twox_64_concat) T::OracleKey =\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e;\n\n\t\t/// True if Self::values(key) is up to date, otherwise the value is stale\n\t\tpub IsUpdated get(fn is_updated): map hasher(twox_64_concat) \u003cT as Trait\u003cI\u003e\u003e::OracleKey =\u003e bool;\n\n\t\t/// Combined value, may not be up to date\n\t\tpub Values get(fn values): map hasher(twox_64_concat) \u003cT as Trait\u003cI\u003e\u003e::OracleKey =\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e;\n\n\t\t/// If an oracle operator has feed a value in this block\n\t\tHasDispatched: OrderedSet\u003cT::AccountId\u003e;\n\n\t\t// TODO: this shouldn't be required https://github.com/paritytech/substrate/issues/6041\n\t\t/// The current members of the collective. This is stored sorted (just by value).\n\t\tpub Members get(fn members) config(): OrderedSet\u003cT::AccountId\u003e;\n\n\t\tpub Nonces get(fn nonces): map hasher(twox_64_concat) T::AccountId =\u003e u32;\n\t}\n\n\tadd_extra_genesis {\n\t\tconfig(phantom): sp_std::marker::PhantomData\u003cI\u003e;\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003cI\u003e, I: Instance=DefaultInstance\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT, I\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Feed the external value.\n\t\t///\n\t\t/// Require unsigned. However a valid signature signed by session key is required along with payload.\n\t\t#[weight = (T::WeightInfo::feed_values(values.len() as u32), DispatchClass::Operational)]\n\t\tpub fn feed_values(\n\t\t\torigin,\n\t\t\tvalues: Vec\u003c(T::OracleKey, T::OracleValue)\u003e,\n\t\t) -\u003e DispatchResultWithPostInfo {\n\t\t\tlet feeder = ensure_signed(origin.clone()).or_else(|_| ensure_root(origin).map(|_| T::RootOperatorAccountId::get()))?;\n\t\t\tSelf::do_feed_values(feeder, values)?;\n\t\t\tOk(Pays::No.into())\n\t\t}\n\n\t\t/// `on_initialize` to return the weight used in `on_finalize`.\n\t\tfn on_initialize() -\u003e Weight {\n\t\t\tT::WeightInfo::on_finalize()\n\t\t}\n\n\t\tfn on_finalize(_n: T::BlockNumber) {\n\t\t\t// cleanup for next block\n\t\t\t\u003cHasDispatched\u003cT, I\u003e\u003e::kill();\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e Module\u003cT, I\u003e {\n\tpub fn read_raw_values(key: \u0026T::OracleKey) -\u003e Vec\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tSelf::members()\n\t\t\t.0\n\t\t\t.iter()\n\t\t\t.chain(vec![T::RootOperatorAccountId::get()].iter())\n\t\t\t.filter_map(|x| Self::raw_values(x, key))\n\t\t\t.collect()\n\t}\n\n\t/// Returns fresh combined value if has update, or latest combined value.\n\t///\n\t/// Note this will update values storage if has update.\n\tpub fn get(key: \u0026T::OracleKey) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tif Self::is_updated(key) {\n\t\t\t\u003cValues\u003cT, I\u003e\u003e::get(key)\n\t\t} else {\n\t\t\tlet timestamped = Self::combined(key)?;\n\t\t\t\u003cValues\u003cT, I\u003e\u003e::insert(key, timestamped.clone());\n\t\t\tIsUpdated::\u003cT, I\u003e::insert(key, true);\n\t\t\tSome(timestamped)\n\t\t}\n\t}\n\n\t/// Returns fresh combined value if has update, or latest combined value.\n\t///\n\t/// This is a no-op function which would not change storage.\n\tpub fn get_no_op(key: \u0026T::OracleKey) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tif Self::is_updated(key) {\n\t\t\tSelf::values(key)\n\t\t} else {\n\t\t\tSelf::combined(key)\n\t\t}\n\t}\n\n\t#[allow(clippy::complexity)]\n\tpub fn get_all_values() -\u003e Vec\u003c(T::OracleKey, Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e)\u003e {\n\t\t\u003cValues\u003cT, I\u003e\u003e::iter()\n\t\t\t.map(|(key, _)| key)\n\t\t\t.map(|key| {\n\t\t\t\tlet v = Self::get_no_op(\u0026key);\n\t\t\t\t(key, v)\n\t\t\t})\n\t\t\t.collect()\n\t}\n\n\tfn combined(key: \u0026T::OracleKey) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tlet values = Self::read_raw_values(key);\n\t\tT::CombineData::combine_data(key, values, Self::values(key))\n\t}\n\n\tfn do_feed_values(who: T::AccountId, values: Vec\u003c(T::OracleKey, T::OracleValue)\u003e) -\u003e DispatchResult {\n\t\t// ensure feeder is authorized\n\t\tensure!(\n\t\t\tSelf::members().contains(\u0026who) || who == T::RootOperatorAccountId::get(),\n\t\t\tError::\u003cT, I\u003e::NoPermission\n\t\t);\n\n\t\t// ensure account hasn't dispatched an updated yet\n\t\tensure!(\n\t\t\tHasDispatched::\u003cT, I\u003e::mutate(|set| set.insert(who.clone())),\n\t\t\tError::\u003cT, I\u003e::AlreadyFeeded\n\t\t);\n\n\t\tlet now = T::Time::now();\n\t\tfor (key, value) in \u0026values {\n\t\t\tlet timestamped = TimestampedValue {\n\t\t\t\tvalue: value.clone(),\n\t\t\t\ttimestamp: now,\n\t\t\t};\n\t\t\tRawValues::\u003cT, I\u003e::insert(\u0026who, \u0026key, timestamped);\n\t\t\tIsUpdated::\u003cT, I\u003e::remove(\u0026key);\n\n\t\t\tT::OnNewData::on_new_data(\u0026who, \u0026key, \u0026value);\n\t\t}\n\t\tSelf::deposit_event(RawEvent::NewFeedData(who, values));\n\t\tOk(())\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e InitializeMembers\u003cT::AccountId\u003e for Module\u003cT, I\u003e {\n\tfn initialize_members(members: \u0026[T::AccountId]) {\n\t\tif !members.is_empty() {\n\t\t\tassert!(Members::\u003cT, I\u003e::get().0.is_empty(), \"Members are already initialized!\");\n\t\t\tMembers::\u003cT, I\u003e::put(OrderedSet::from_sorted_set(members.into()));\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e ChangeMembers\u003cT::AccountId\u003e for Module\u003cT, I\u003e {\n\tfn change_members_sorted(_incoming: \u0026[T::AccountId], outgoing: \u0026[T::AccountId], new: \u0026[T::AccountId]) {\n\t\t// remove session keys and its values\n\t\tfor removed in outgoing {\n\t\t\tRawValues::\u003cT, I\u003e::remove_prefix(removed);\n\t\t}\n\n\t\tMembers::\u003cT, I\u003e::put(OrderedSet::from_sorted_set(new.into()));\n\n\t\t// not bothering to track which key needs recompute, just update all\n\t\tIsUpdated::\u003cT, I\u003e::remove_all();\n\t}\n\n\tfn set_prime(_prime: Option\u003cT::AccountId\u003e) {\n\t\t// nothing\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e DataProvider\u003cT::OracleKey, T::OracleValue\u003e for Module\u003cT, I\u003e {\n\tfn get(key: \u0026T::OracleKey) -\u003e Option\u003cT::OracleValue\u003e {\n\t\tSelf::get(key).map(|timestamped_value| timestamped_value.value)\n\t}\n}\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e DataProviderExtended\u003cT::OracleKey, TimestampedValueOf\u003cT, I\u003e\u003e for Module\u003cT, I\u003e {\n\tfn get_no_op(key: \u0026T::OracleKey) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tSelf::get_no_op(key)\n\t}\n\t#[allow(clippy::complexity)]\n\tfn get_all_values() -\u003e Vec\u003c(T::OracleKey, Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e)\u003e {\n\t\tSelf::get_all_values()\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e DataFeeder\u003cT::OracleKey, T::OracleValue, T::AccountId\u003e for Module\u003cT, I\u003e {\n\tfn feed_value(who: T::AccountId, key: T::OracleKey, value: T::OracleValue) -\u003e DispatchResult {\n\t\tSelf::do_feed_values(who, vec![(key, value)])?;\n\t\tOk(())\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","mock.rs"],"content":"#![cfg(test)]\n\nuse super::*;\n\nuse frame_support::{impl_outer_dispatch, impl_outer_event, impl_outer_origin, parameter_types, weights::Weight};\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{BlakeTwo256, IdentityLookup},\n\tPerbill,\n};\n\nuse std::cell::RefCell;\n\nmod oracle {\n\tpub use super::super::*;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\toracle\u003cT\u003e,\n\t}\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\nimpl_outer_dispatch! {\n\tpub enum Call for Test where origin: Origin {\n\t\toracle::ModuleOracle,\n\t}\n}\n\npub type AccountId = u128;\ntype Key = u32;\ntype Value = u32;\n\n// For testing the module, we construct most of a mock runtime. This means\n// first constructing a configuration type (`Test`) which `impl`s each of the\n// configuration traits of modules we want to use.\n#[derive(Clone, Eq, PartialEq, Debug)]\npub struct Test;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: Weight = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n}\nimpl frame_system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Call = Call;\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cTest\u003e;\n\nthread_local! {\n\tstatic TIME: RefCell\u003cu32\u003e = RefCell::new(0);\n}\n\npub struct Timestamp;\nimpl Time for Timestamp {\n\ttype Moment = u32;\n\n\tfn now() -\u003e Self::Moment {\n\t\tTIME.with(|v| *v.borrow())\n\t}\n}\n\nimpl Timestamp {\n\tpub fn set_timestamp(val: u32) {\n\t\tTIME.with(|v| *v.borrow_mut() = val);\n\t}\n}\n\nparameter_types! {\n\tpub const MinimumCount: u32 = 3;\n\tpub const ExpiresIn: u32 = 600;\n\tpub const RootOperatorAccountId: AccountId = 4;\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype OnNewData = ();\n\ttype CombineData = DefaultCombineData\u003cSelf, MinimumCount, ExpiresIn\u003e;\n\ttype Time = Timestamp;\n\ttype OracleKey = Key;\n\ttype OracleValue = Value;\n\ttype RootOperatorAccountId = RootOperatorAccountId;\n\ttype WeightInfo = ();\n}\n\npub type ModuleOracle = Module\u003cTest\u003e;\n// This function basically just builds a genesis storage key/value store\n// according to our desired mockup.\npub fn new_test_ext() -\u003e sp_io::TestExternalities {\n\tlet mut storage = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\tlet _ = GenesisConfig::\u003cTest\u003e {\n\t\tmembers: vec![1, 2, 3].into(),\n\t\tphantom: Default::default(),\n\t}\n\t.assimilate_storage(\u0026mut storage);\n\n\tlet mut t: sp_io::TestExternalities = storage.into();\n\n\tt.execute_with(|| {\n\t\tTimestamp::set_timestamp(12345);\n\t});\n\n\tt\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","tests.rs"],"content":"#![cfg(test)]\n\nuse crate::{\n\tmock::{new_test_ext, AccountId, ModuleOracle, Origin, RootOperatorAccountId, System, Test, TestEvent, Timestamp},\n\tError, RawEvent, TimestampedValue,\n};\nuse frame_support::{\n\tassert_noop, assert_ok,\n\ttraits::{ChangeMembers, OnFinalize},\n\tweights::Pays,\n};\n\n#[test]\nfn should_feed_values_from_member() {\n\tnew_test_ext().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\t\tlet account_id: AccountId = 1;\n\n\t\tassert_noop!(\n\t\t\tModuleOracle::feed_values(Origin::signed(5), vec![(50, 1000), (51, 900), (52, 800)]),\n\t\t\tError::\u003cTest, _\u003e::NoPermission,\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::feed_values(Origin::signed(account_id), vec![(50, 1000), (51, 900), (52, 800)])\n\t\t\t\t.unwrap()\n\t\t\t\t.pays_fee,\n\t\t\tPays::No\n\t\t);\n\n\t\tlet new_feed_data_event = TestEvent::oracle(RawEvent::NewFeedData(1, vec![(50, 1000), (51, 900), (52, 800)]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == new_feed_data_event));\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026account_id, \u002650),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 1000,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026account_id, \u002651),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 900,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026account_id, \u002652),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 800,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn should_feed_values_from_root() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet root_feeder: AccountId = RootOperatorAccountId::get();\n\n\t\tassert_ok!(ModuleOracle::feed_values(\n\t\t\tOrigin::root(),\n\t\t\tvec![(50, 1000), (51, 900), (52, 800)]\n\t\t));\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026root_feeder, \u002650),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 1000,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026root_feeder, \u002651),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 900,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026root_feeder, \u002652),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 800,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn should_update_is_updated() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet key: u32 = 50;\n\t\tassert_eq!(ModuleOracle::is_updated(key), false);\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(key, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(key, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(key, 1000)]));\n\t\tassert_eq!(ModuleOracle::is_updated(key), false);\n\t\tassert_eq!(\n\t\t\tModuleOracle::get(\u0026key).unwrap(),\n\t\t\tTimestampedValue {\n\t\t\t\tvalue: 1000,\n\t\t\t\ttimestamp: 12345\n\t\t\t}\n\t\t);\n\t\tassert_eq!(ModuleOracle::is_updated(key), true);\n\t\tModuleOracle::on_finalize(1);\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(key, 1000)]));\n\t\tassert_eq!(ModuleOracle::is_updated(key), false);\n\t});\n}\n\n#[test]\nfn should_read_raw_values() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet key: u32 = 50;\n\n\t\tlet raw_values = ModuleOracle::read_raw_values(\u0026key);\n\t\tassert_eq!(raw_values, vec![]);\n\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(key, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(key, 1200)]));\n\n\t\tlet raw_values = ModuleOracle::read_raw_values(\u0026key);\n\t\tassert_eq!(\n\t\t\traw_values,\n\t\t\tvec![\n\t\t\t\tTimestampedValue {\n\t\t\t\t\tvalue: 1000,\n\t\t\t\t\ttimestamp: 12345,\n\t\t\t\t},\n\t\t\t\tTimestampedValue {\n\t\t\t\t\tvalue: 1200,\n\t\t\t\t\ttimestamp: 12345,\n\t\t\t\t},\n\t\t\t]\n\t\t);\n\t});\n}\n\n#[test]\nfn should_combined_data() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet key: u32 = 50;\n\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(key, 1300)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(key, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(key, 1200)]));\n\n\t\tlet expected = Some(TimestampedValue {\n\t\t\tvalue: 1200,\n\t\t\ttimestamp: 12345,\n\t\t});\n\n\t\tassert_eq!(ModuleOracle::get(\u0026key), expected);\n\n\t\tTimestamp::set_timestamp(23456);\n\n\t\tassert_eq!(ModuleOracle::get(\u0026key), expected);\n\t});\n}\n\n#[test]\nfn should_return_none_for_non_exist_key() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_eq!(ModuleOracle::get(\u002650), None);\n\t});\n}\n\n#[test]\nfn multiple_calls_should_fail() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(50, 1300)]));\n\t\tassert_noop!(\n\t\t\tModuleOracle::feed_values(Origin::signed(1), vec![(50, 1300)]),\n\t\t\tError::\u003cTest, _\u003e::AlreadyFeeded,\n\t\t);\n\n\t\tModuleOracle::on_finalize(1);\n\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(50, 1300)]));\n\t});\n}\n\n#[test]\nfn get_all_values_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet eur: u32 = 1;\n\t\tlet jpy: u32 = 2;\n\n\t\tassert_eq!(ModuleOracle::get_all_values(), vec![]);\n\n\t\t// feed eur \u0026 jpy\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(eur, 1300)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(eur, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(jpy, 9000)]));\n\n\t\t// not enough eur \u0026 jpy prices\n\t\tassert_eq!(ModuleOracle::get(\u0026eur), None);\n\t\tassert_eq!(ModuleOracle::get(\u0026jpy), None);\n\t\tassert_eq!(ModuleOracle::get_all_values(), vec![]);\n\n\t\t// finalize block\n\t\tModuleOracle::on_finalize(1);\n\n\t\t// feed eur \u0026 jpy\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(eur, 1200)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(jpy, 8000)]));\n\n\t\t// enough eur prices\n\t\tlet eur_price = Some(TimestampedValue {\n\t\t\tvalue: 1200,\n\t\t\ttimestamp: 12345,\n\t\t});\n\t\tassert_eq!(ModuleOracle::get(\u0026eur), eur_price);\n\n\t\t// not enough jpy prices\n\t\tassert_eq!(ModuleOracle::get(\u0026jpy), None);\n\n\t\tassert_eq!(ModuleOracle::get_all_values(), vec![(eur, eur_price)]);\n\n\t\t// feed jpy\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(jpy, 7000)]));\n\n\t\t// enough jpy prices\n\t\tlet jpy_price = Some(TimestampedValue {\n\t\t\tvalue: 8000,\n\t\t\ttimestamp: 12345,\n\t\t});\n\t\tassert_eq!(ModuleOracle::get(\u0026jpy), jpy_price);\n\n\t\tassert_eq!(ModuleOracle::get_all_values(), vec![(eur, eur_price), (jpy, jpy_price)]);\n\t});\n}\n\n#[test]\nfn change_member_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\t\u003cModuleOracle as ChangeMembers\u003cAccountId\u003e\u003e::change_members_sorted(\u0026[4], \u0026[1], \u0026[2, 3, 4]);\n\t\tassert_noop!(\n\t\t\tModuleOracle::feed_values(Origin::signed(1), vec![(50, 1000)]),\n\t\t\tError::\u003cTest, _\u003e::NoPermission,\n\t\t);\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(50, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(4), vec![(50, 1000)]));\n\t});\n}\n\n#[test]\nfn should_clear_is_updated_on_change_member() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(50, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(50, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(50, 1000)]));\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::get(\u002650).unwrap(),\n\t\t\tTimestampedValue {\n\t\t\t\tvalue: 1000,\n\t\t\t\ttimestamp: 12345\n\t\t\t}\n\t\t);\n\t\tassert_eq!(ModuleOracle::is_updated(50), true);\n\n\t\tModuleOracle::change_members_sorted(\u0026[4], \u0026[1], \u0026[2, 3, 4]);\n\n\t\tassert_eq!(ModuleOracle::is_updated(50), false);\n\t});\n}\n\n#[test]\nfn should_clear_data_for_removed_members() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(50, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(50, 1000)]));\n\n\t\tModuleOracle::change_members_sorted(\u0026[4], \u0026[1], \u0026[2, 3, 4]);\n\n\t\tassert_eq!(ModuleOracle::raw_values(\u00261, 50), None);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","rewards","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn on_initialize(c: u32) -\u003e Weight {\n\t\t(33_360_000 as Weight)\n\t\t\t.saturating_add((23_139_000 as Weight).saturating_mul(c as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads((1 as Weight).saturating_mul(c as Weight)))\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","rewards","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode, FullCodec, HasCompact};\nuse frame_support::{decl_module, decl_storage, weights::Weight, Parameter};\nuse orml_traits::RewardHandler;\nuse sp_runtime::{\n\ttraits::{AtLeast32BitUnsigned, MaybeSerializeDeserialize, Member, Saturating, Zero},\n\tFixedPointNumber, FixedPointOperand, FixedU128, RuntimeDebug,\n};\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tfmt::Debug,\n};\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn on_initialize(c: u32) -\u003e Weight;\n}\n\n/// The Reward Pool Info.\n#[derive(Clone, Encode, Decode, PartialEq, Eq, RuntimeDebug, Default)]\npub struct PoolInfo\u003cShare: HasCompact, Balance: HasCompact\u003e {\n\t/// Total shares amount\n\t#[codec(compact)]\n\tpub total_shares: Share,\n\t/// Total rewards amount\n\t#[codec(compact)]\n\tpub total_rewards: Balance,\n\t/// Total withdrawn rewards amount\n\t#[codec(compact)]\n\tpub total_withdrawn_rewards: Balance,\n}\n\npub trait Trait: frame_system::Trait {\n\t/// The share type of pool.\n\ttype Share: Parameter\n\t\t+ Member\n\t\t+ AtLeast32BitUnsigned\n\t\t+ Default\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ FixedPointOperand;\n\n\t/// The reward balance type.\n\ttype Balance: Parameter\n\t\t+ Member\n\t\t+ AtLeast32BitUnsigned\n\t\t+ Default\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ FixedPointOperand;\n\n\t/// The reward pool ID type.\n\ttype PoolId: Parameter + Member + Copy + FullCodec;\n\n\t/// The `RewardHandler`\n\ttype Handler: RewardHandler\u003c\n\t\tSelf::AccountId,\n\t\tSelf::BlockNumber,\n\t\tShare = Self::Share,\n\t\tBalance = Self::Balance,\n\t\tPoolId = Self::PoolId,\n\t\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Rewards {\n\t\t/// Stores reward pool info.\n\t\tpub Pools get(fn pools): map hasher(twox_64_concat) T::PoolId =\u003e PoolInfo\u003cT::Share, T::Balance\u003e;\n\n\t\t/// Record share amount and withdrawn reward amount for specific `AccountId` under `PoolId`.\n\t\tpub ShareAndWithdrawnReward get(fn share_and_withdrawn_reward): double_map hasher(twox_64_concat) T::PoolId, hasher(twox_64_concat) T::AccountId =\u003e (T::Share, T::Balance);\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\n\t\tfn on_initialize(now: T::BlockNumber) -\u003e Weight {\n\t\t\tlet mut count = 0;\n\t\t\tT::Handler::accumulate_reward(now, | pool, reward_to_accumulate | {\n\t\t\t\tif !reward_to_accumulate.is_zero() {\n\t\t\t\t\tcount += 1;\n\t\t\t\t\tPools::\u003cT\u003e::mutate(pool, | pool_info | pool_info.total_rewards = pool_info.total_rewards.saturating_add(reward_to_accumulate));\n\t\t\t\t}\n\t\t\t});\n\t\t\tT::WeightInfo::on_initialize(count)\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tpub fn add_share(who: \u0026T::AccountId, pool: T::PoolId, add_amount: T::Share) {\n\t\tif add_amount.is_zero() {\n\t\t\treturn;\n\t\t}\n\n\t\tPools::\u003cT\u003e::mutate(pool, |pool_info| {\n\t\t\tlet proportion = FixedU128::checked_from_rational(add_amount, pool_info.total_shares).unwrap_or_default();\n\t\t\tlet reward_inflation = proportion.saturating_mul_int(pool_info.total_rewards);\n\n\t\t\tpool_info.total_shares = pool_info.total_shares.saturating_add(add_amount);\n\t\t\tpool_info.total_rewards = pool_info.total_rewards.saturating_add(reward_inflation);\n\t\t\tpool_info.total_withdrawn_rewards = pool_info.total_withdrawn_rewards.saturating_add(reward_inflation);\n\n\t\t\tShareAndWithdrawnReward::\u003cT\u003e::mutate(pool, who, |(share, withdrawn_rewards)| {\n\t\t\t\t*share = share.saturating_add(add_amount);\n\t\t\t\t*withdrawn_rewards = withdrawn_rewards.saturating_add(reward_inflation);\n\t\t\t});\n\t\t});\n\t}\n\n\tpub fn remove_share(who: \u0026T::AccountId, pool: T::PoolId, remove_amount: T::Share) {\n\t\tif remove_amount.is_zero() {\n\t\t\treturn;\n\t\t}\n\n\t\t// claim rewards firstly\n\t\tSelf::claim_rewards(who, pool);\n\n\t\tShareAndWithdrawnReward::\u003cT\u003e::mutate(pool, who, |(share, withdrawn_rewards)| {\n\t\t\tlet remove_amount = remove_amount.min(*share);\n\n\t\t\tif remove_amount.is_zero() {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPools::\u003cT\u003e::mutate(pool, |pool_info| {\n\t\t\t\tlet proportion = FixedU128::checked_from_rational(remove_amount, *share).unwrap_or_default();\n\t\t\t\tlet withdrawn_rewards_to_remove = proportion.saturating_mul_int(*withdrawn_rewards);\n\n\t\t\t\tpool_info.total_shares = pool_info.total_shares.saturating_sub(remove_amount);\n\t\t\t\tpool_info.total_rewards = pool_info.total_rewards.saturating_sub(withdrawn_rewards_to_remove);\n\t\t\t\tpool_info.total_withdrawn_rewards = pool_info\n\t\t\t\t\t.total_withdrawn_rewards\n\t\t\t\t\t.saturating_sub(withdrawn_rewards_to_remove);\n\n\t\t\t\t*withdrawn_rewards = withdrawn_rewards.saturating_sub(withdrawn_rewards_to_remove);\n\t\t\t});\n\n\t\t\t*share = share.saturating_sub(remove_amount);\n\t\t});\n\t}\n\n\tpub fn set_share(who: \u0026T::AccountId, pool: T::PoolId, new_share: T::Share) {\n\t\tlet (share, _) = Self::share_and_withdrawn_reward(pool, who);\n\n\t\tif new_share \u003e share {\n\t\t\tSelf::add_share(who, pool, new_share.saturating_sub(share));\n\t\t} else {\n\t\t\tSelf::remove_share(who, pool, share.saturating_sub(new_share));\n\t\t}\n\t}\n\n\tpub fn claim_rewards(who: \u0026T::AccountId, pool: T::PoolId) {\n\t\tShareAndWithdrawnReward::\u003cT\u003e::mutate(pool, who, |(share, withdrawn_rewards)| {\n\t\t\tif share.is_zero() {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPools::\u003cT\u003e::mutate(pool, |pool_info| {\n\t\t\t\tlet proportion = FixedU128::checked_from_rational(*share, pool_info.total_shares).unwrap_or_default();\n\t\t\t\tlet reward_to_withdraw = proportion\n\t\t\t\t\t.saturating_mul_int(pool_info.total_rewards)\n\t\t\t\t\t.saturating_sub(*withdrawn_rewards)\n\t\t\t\t\t.min(\n\t\t\t\t\t\tpool_info\n\t\t\t\t\t\t\t.total_rewards\n\t\t\t\t\t\t\t.saturating_sub(pool_info.total_withdrawn_rewards),\n\t\t\t\t\t);\n\n\t\t\t\tif reward_to_withdraw.is_zero() {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tpool_info.total_withdrawn_rewards =\n\t\t\t\t\tpool_info.total_withdrawn_rewards.saturating_add(reward_to_withdraw);\n\t\t\t\t*withdrawn_rewards = withdrawn_rewards.saturating_add(reward_to_withdraw);\n\n\t\t\t\t// pay reward to `who`\n\t\t\t\tT::Handler::payout(who, pool, reward_to_withdraw);\n\t\t\t});\n\t\t});\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","rewards","src","mock.rs"],"content":"//! Mocks for the rewards module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{impl_outer_origin, parameter_types};\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\nuse sp_std::cell::RefCell;\nuse std::collections::HashMap;\n\npub type AccountId = u128;\npub type Balance = u64;\npub type Share = u64;\npub type PoolId = u32;\npub type BlockNumber = u64;\npub type CurrencyId = u32;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const CAROL: AccountId = 3;\npub const DOT_POOL: PoolId = 1;\npub const BTC_POOL: PoolId = 2;\npub const XBTC_POOL: PoolId = 3;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\n\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = ();\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = ();\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nthread_local! {\n\tpub static RECEIVED_PAYOUT: RefCell\u003cHashMap\u003c(PoolId, AccountId), Balance\u003e\u003e = RefCell::new(HashMap::new());\n}\n\npub struct Handler;\nimpl RewardHandler\u003cAccountId, BlockNumber\u003e for Handler {\n\ttype Share = Share;\n\ttype Balance = Balance;\n\ttype PoolId = PoolId;\n\ttype CurrencyId = CurrencyId;\n\n\tfn accumulate_reward(\n\t\tnow: BlockNumber,\n\t\tmut callback: impl FnMut(Self::PoolId, Self::Balance),\n\t) -\u003e Vec\u003c(Self::CurrencyId, Self::Balance)\u003e {\n\t\tif now % 2 == 0 {\n\t\t\tlet mut total_accumulated_rewards = 0;\n\t\t\tlet valid_pool_ids = vec![DOT_POOL, BTC_POOL];\n\n\t\t\tfor (pool, _) in Pools::\u003cRuntime\u003e::iter() {\n\t\t\t\tif valid_pool_ids.contains(\u0026pool) {\n\t\t\t\t\tlet rewards: Balance = 100;\n\t\t\t\t\tcallback(pool, rewards);\n\t\t\t\t\ttotal_accumulated_rewards += rewards;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvec![(1, total_accumulated_rewards)]\n\t\t} else {\n\t\t\tvec![]\n\t\t}\n\t}\n\n\tfn payout(who: \u0026AccountId, pool: Self::PoolId, amount: Self::Balance) {\n\t\tRECEIVED_PAYOUT.with(|v| {\n\t\t\tlet mut old_map = v.borrow().clone();\n\t\t\tif let Some(before) = old_map.get_mut(\u0026(pool, *who)) {\n\t\t\t\t*before += amount;\n\t\t\t} else {\n\t\t\t\told_map.insert((pool, *who), amount);\n\t\t\t};\n\n\t\t\t*v.borrow_mut() = old_map;\n\t\t});\n\t}\n}\n\nimpl Trait for Runtime {\n\ttype Share = Share;\n\ttype Balance = Balance;\n\ttype PoolId = PoolId;\n\ttype Handler = Handler;\n\ttype WeightInfo = ();\n}\npub type RewardsModule = Module\u003cRuntime\u003e;\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","rewards","src","tests.rs"],"content":"//! Unit tests for the rewards module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::traits::OnInitialize;\nuse mock::*;\n\n#[test]\nfn add_share_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (0, 0));\n\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 0);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (0, 0));\n\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 100);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 5000;\n\t\t\tpool_info.total_withdrawn_rewards += 2000;\n\t\t});\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 5000,\n\t\t\t\ttotal_withdrawn_rewards: 2000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (0, 0));\n\n\t\tRewardsModule::add_share(\u0026BOB, DOT_POOL, 50);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 150,\n\t\t\t\ttotal_rewards: 7500,\n\t\t\t\ttotal_withdrawn_rewards: 4500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (50, 2500));\n\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 150);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 300,\n\t\t\t\ttotal_rewards: 15000,\n\t\t\t\ttotal_withdrawn_rewards: 12000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (250, 7500));\n\t});\n}\n\n#[test]\nfn claim_rewards_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 100);\n\t\tRewardsModule::add_share(\u0026BOB, DOT_POOL, 100);\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 5000;\n\t\t});\n\t\tRewardsModule::add_share(\u0026CAROL, DOT_POOL, 200);\n\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 400,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 5000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (100, 0));\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, CAROL), (200, 5000));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, BOB)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, CAROL)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\tRewardsModule::claim_rewards(\u0026ALICE, DOT_POOL);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 400,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 7500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 2500));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t2500\n\t\t);\n\n\t\tRewardsModule::claim_rewards(\u0026CAROL, DOT_POOL);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 400,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 7500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, CAROL), (200, 5000));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, CAROL)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\tRewardsModule::claim_rewards(\u0026BOB, DOT_POOL);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 400,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 10000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (100, 2500));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, BOB)).unwrap_or(\u00260)),\n\t\t\t2500\n\t\t);\n\t});\n}\n\n#[test]\nfn remove_share_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 100);\n\t\tRewardsModule::add_share(\u0026BOB, DOT_POOL, 100);\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 10000;\n\t\t});\n\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 200,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (100, 0));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, BOB)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\t// remove amount is zero, do not claim interest\n\t\tRewardsModule::remove_share(\u0026ALICE, DOT_POOL, 0);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 200,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\tRewardsModule::remove_share(\u0026BOB, DOT_POOL, 50);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 150,\n\t\t\t\ttotal_rewards: 7500,\n\t\t\t\ttotal_withdrawn_rewards: 2500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (50, 2500));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, BOB)).unwrap_or(\u00260)),\n\t\t\t5000\n\t\t);\n\n\t\tRewardsModule::remove_share(\u0026ALICE, DOT_POOL, 101);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 50,\n\t\t\t\ttotal_rewards: 2501,\n\t\t\t\ttotal_withdrawn_rewards: 2500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (0, 0));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t4999\n\t\t);\n\t});\n}\n\n#[test]\nfn set_share_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (0, 0));\n\n\t\tRewardsModule::set_share(\u0026ALICE, DOT_POOL, 100);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 10000;\n\t\t});\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\n\t\tRewardsModule::set_share(\u0026ALICE, DOT_POOL, 500);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 500,\n\t\t\t\ttotal_rewards: 50000,\n\t\t\t\ttotal_withdrawn_rewards: 40000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (500, 40000));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\tRewardsModule::set_share(\u0026ALICE, DOT_POOL, 100);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 10000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 10000));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t10000\n\t\t);\n\t});\n}\n\n#[test]\nfn on_initialize_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 100;\n\t\t});\n\t\tPools::\u003cRuntime\u003e::mutate(BTC_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 200;\n\t\t});\n\t\tPools::\u003cRuntime\u003e::mutate(XBTC_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 300;\n\t\t});\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 100,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(BTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 200,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(XBTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 300,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\n\t\tRewardsModule::on_initialize(1);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 100,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(BTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 200,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(XBTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 300,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\n\t\tRewardsModule::on_initialize(2);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 200,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(BTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 300,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(XBTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 300,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn transfer() -\u003e Weight {\n\t\t(158_835_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(4 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n\tfn transfer_all() -\u003e Weight {\n\t\t(162_545_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(4 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","imbalances.rs"],"content":"// wrapping these imbalances in a private module is necessary to ensure absolute\n// privacy of the inner member.\nuse crate::{TotalIssuance, Trait};\nuse frame_support::storage::StorageMap;\nuse frame_support::traits::{Get, Imbalance, TryDrop};\nuse sp_runtime::traits::{Saturating, Zero};\nuse sp_std::{marker, mem, result};\n\n/// Opaque, move-only struct with private fields that serves as a token\n/// denoting that funds have been created without any equal and opposite\n/// accounting.\n#[must_use]\npub struct PositiveImbalance\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e(\n\tT::Balance,\n\tmarker::PhantomData\u003cGetCurrencyId\u003e,\n);\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e PositiveImbalance\u003cT, GetCurrencyId\u003e {\n\t/// Create a new positive imbalance from a balance.\n\tpub fn new(amount: T::Balance) -\u003e Self {\n\t\tPositiveImbalance(amount, marker::PhantomData::\u003cGetCurrencyId\u003e)\n\t}\n}\n\n/// Opaque, move-only struct with private fields that serves as a token\n/// denoting that funds have been destroyed without any equal and opposite\n/// accounting.\n#[must_use]\npub struct NegativeImbalance\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e(\n\tT::Balance,\n\tmarker::PhantomData\u003cGetCurrencyId\u003e,\n);\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e NegativeImbalance\u003cT, GetCurrencyId\u003e {\n\t/// Create a new negative imbalance from a balance.\n\tpub fn new(amount: T::Balance) -\u003e Self {\n\t\tNegativeImbalance(amount, marker::PhantomData::\u003cGetCurrencyId\u003e)\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e TryDrop for PositiveImbalance\u003cT, GetCurrencyId\u003e {\n\tfn try_drop(self) -\u003e result::Result\u003c(), Self\u003e {\n\t\tself.drop_zero()\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e Imbalance\u003cT::Balance\u003e for PositiveImbalance\u003cT, GetCurrencyId\u003e {\n\ttype Opposite = NegativeImbalance\u003cT, GetCurrencyId\u003e;\n\n\tfn zero() -\u003e Self {\n\t\tSelf::new(Zero::zero())\n\t}\n\tfn drop_zero(self) -\u003e result::Result\u003c(), Self\u003e {\n\t\tif self.0.is_zero() {\n\t\t\tOk(())\n\t\t} else {\n\t\t\tErr(self)\n\t\t}\n\t}\n\tfn split(self, amount: T::Balance) -\u003e (Self, Self) {\n\t\tlet first = self.0.min(amount);\n\t\tlet second = self.0 - first;\n\n\t\tmem::forget(self);\n\t\t(Self::new(first), Self::new(second))\n\t}\n\tfn merge(mut self, other: Self) -\u003e Self {\n\t\tself.0 = self.0.saturating_add(other.0);\n\t\tmem::forget(other);\n\n\t\tself\n\t}\n\tfn subsume(\u0026mut self, other: Self) {\n\t\tself.0 = self.0.saturating_add(other.0);\n\t\tmem::forget(other);\n\t}\n\tfn offset(self, other: Self::Opposite) -\u003e result::Result\u003cSelf, Self::Opposite\u003e {\n\t\tlet (a, b) = (self.0, other.0);\n\t\tmem::forget((self, other));\n\n\t\tif a \u003e= b {\n\t\t\tOk(Self::new(a - b))\n\t\t} else {\n\t\t\tErr(NegativeImbalance::new(b - a))\n\t\t}\n\t}\n\tfn peek(\u0026self) -\u003e T::Balance {\n\t\tself.0\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e TryDrop for NegativeImbalance\u003cT, GetCurrencyId\u003e {\n\tfn try_drop(self) -\u003e result::Result\u003c(), Self\u003e {\n\t\tself.drop_zero()\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e Imbalance\u003cT::Balance\u003e for NegativeImbalance\u003cT, GetCurrencyId\u003e {\n\ttype Opposite = PositiveImbalance\u003cT, GetCurrencyId\u003e;\n\n\tfn zero() -\u003e Self {\n\t\tSelf::new(Zero::zero())\n\t}\n\tfn drop_zero(self) -\u003e result::Result\u003c(), Self\u003e {\n\t\tif self.0.is_zero() {\n\t\t\tOk(())\n\t\t} else {\n\t\t\tErr(self)\n\t\t}\n\t}\n\tfn split(self, amount: T::Balance) -\u003e (Self, Self) {\n\t\tlet first = self.0.min(amount);\n\t\tlet second = self.0 - first;\n\n\t\tmem::forget(self);\n\t\t(Self::new(first), Self::new(second))\n\t}\n\tfn merge(mut self, other: Self) -\u003e Self {\n\t\tself.0 = self.0.saturating_add(other.0);\n\t\tmem::forget(other);\n\n\t\tself\n\t}\n\tfn subsume(\u0026mut self, other: Self) {\n\t\tself.0 = self.0.saturating_add(other.0);\n\t\tmem::forget(other);\n\t}\n\tfn offset(self, other: Self::Opposite) -\u003e result::Result\u003cSelf, Self::Opposite\u003e {\n\t\tlet (a, b) = (self.0, other.0);\n\t\tmem::forget((self, other));\n\n\t\tif a \u003e= b {\n\t\t\tOk(Self::new(a - b))\n\t\t} else {\n\t\t\tErr(PositiveImbalance::new(b - a))\n\t\t}\n\t}\n\tfn peek(\u0026self) -\u003e T::Balance {\n\t\tself.0\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e Drop for PositiveImbalance\u003cT, GetCurrencyId\u003e {\n\t/// Basic drop handler will just square up the total issuance.\n\tfn drop(\u0026mut self) {\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(GetCurrencyId::get(), |v| *v = v.saturating_add(self.0));\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e Drop for NegativeImbalance\u003cT, GetCurrencyId\u003e {\n\t/// Basic drop handler will just square up the total issuance.\n\tfn drop(\u0026mut self) {\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(GetCurrencyId::get(), |v| *v = v.saturating_sub(self.0));\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","lib.rs"],"content":"//! # Tokens Module\n//!\n//! ## Overview\n//!\n//! The tokens module provides fungible multi-currency functionality that\n//! implements `MultiCurrency` trait.\n//!\n//! The tokens module provides functions for:\n//!\n//! - Querying and setting the balance of a given account.\n//! - Getting and managing total issuance.\n//! - Balance transfer between accounts.\n//! - Depositing and withdrawing balance.\n//! - Slashing an account balance.\n//!\n//! ### Implementations\n//!\n//! The tokens module provides implementations for following traits.\n//!\n//! - `MultiCurrency` - Abstraction over a fungible multi-currency system.\n//! - `MultiCurrencyExtended` - Extended `MultiCurrency` with additional helper\n//!   types and methods, like updating balance\n//! by a given signed integer amount.\n//!\n//! ## Interface\n//!\n//! ### Dispatchable Functions\n//!\n//! - `transfer` - Transfer some balance to another account.\n//! - `transfer_all` - Transfer all balance to another account.\n//!\n//! ### Genesis Config\n//!\n//! The tokens module depends on the `GenesisConfig`. Endowed accounts could be\n//! configured in genesis configs.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, ensure,\n\ttraits::Get,\n\ttraits::{\n\t\tBalanceStatus as Status, Currency as PalletCurrency, ExistenceRequirement, Imbalance,\n\t\tLockableCurrency as PalletLockableCurrency, ReservableCurrency as PalletReservableCurrency, SignedImbalance,\n\t\tWithdrawReasons,\n\t},\n\tweights::Weight,\n\tParameter, StorageMap,\n};\nuse frame_system::ensure_signed;\nuse sp_runtime::{\n\ttraits::{\n\t\tAtLeast32BitUnsigned, Bounded, CheckedAdd, CheckedSub, MaybeSerializeDeserialize, Member, Saturating,\n\t\tStaticLookup, Zero,\n\t},\n\tDispatchError, DispatchResult, RuntimeDebug,\n};\nuse sp_std::{\n\tconvert::{TryFrom, TryInto},\n\tmarker,\n\tprelude::*,\n\tresult,\n};\n\n#[cfg(feature = \"std\")]\nuse sp_std::collections::btree_map::BTreeMap;\n\npub use crate::imbalances::{NegativeImbalance, PositiveImbalance};\nuse orml_traits::{\n\tarithmetic::{self, Signed},\n\tBalanceStatus, LockIdentifier, MultiCurrency, MultiCurrencyExtended, MultiLockableCurrency,\n\tMultiReservableCurrency, OnReceived,\n};\n\nmod default_weight;\nmod imbalances;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn transfer() -\u003e Weight;\n\tfn transfer_all() -\u003e Weight;\n}\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// The balance type\n\ttype Balance: Parameter + Member + AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize;\n\n\t/// The amount type, should be signed version of `Balance`\n\ttype Amount: Signed\n\t\t+ TryInto\u003cSelf::Balance\u003e\n\t\t+ TryFrom\u003cSelf::Balance\u003e\n\t\t+ Parameter\n\t\t+ Member\n\t\t+ arithmetic::SimpleArithmetic\n\t\t+ Default\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize;\n\n\t/// The currency ID type\n\ttype CurrencyId: Parameter + Member + Copy + MaybeSerializeDeserialize + Ord;\n\n\t/// Hook when some fund is deposited into an account\n\ttype OnReceived: OnReceived\u003cSelf::AccountId, Self::CurrencyId, Self::Balance\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\n/// A single lock on a balance. There can be many of these on an account and\n/// they \"overlap\", so the same balance is frozen by multiple locks.\n#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug)]\npub struct BalanceLock\u003cBalance\u003e {\n\t/// An identifier for this lock. Only one lock may be in existence for each\n\t/// identifier.\n\tpub id: LockIdentifier,\n\t/// The amount which the free balance may not drop below when this lock is\n\t/// in effect.\n\tpub amount: Balance,\n}\n\n/// balance information for an account.\n#[derive(Encode, Decode, Clone, PartialEq, Eq, Default, RuntimeDebug)]\npub struct AccountData\u003cBalance\u003e {\n\t/// Non-reserved part of the balance. There may still be restrictions on\n\t/// this, but it is the total pool what may in principle be transferred,\n\t/// reserved.\n\t///\n\t/// This is the only balance that matters in terms of most operations on\n\t/// tokens.\n\tpub free: Balance,\n\t/// Balance which is reserved and may not be used at all.\n\t///\n\t/// This can still get slashed, but gets slashed last of all.\n\t///\n\t/// This balance is a 'reserve' balance that other subsystems use in order\n\t/// to set aside tokens that are still 'owned' by the account holder, but\n\t/// which are suspendable.\n\tpub reserved: Balance,\n\t/// The amount that `free` may not drop below when withdrawing.\n\tpub frozen: Balance,\n}\n\nimpl\u003cBalance: Saturating + Copy + Ord\u003e AccountData\u003cBalance\u003e {\n\t/// The amount that this account's free balance may not be reduced beyond.\n\tfn frozen(\u0026self) -\u003e Balance {\n\t\tself.frozen\n\t}\n\t/// The total balance in this account including any that is reserved and\n\t/// ignoring any frozen.\n\tfn total(\u0026self) -\u003e Balance {\n\t\tself.free.saturating_add(self.reserved)\n\t}\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Tokens {\n\t\t/// The total issuance of a token type.\n\t\tpub TotalIssuance get(fn total_issuance) build(|config: \u0026GenesisConfig\u003cT\u003e| {\n\t\t\tconfig\n\t\t\t\t.endowed_accounts\n\t\t\t\t.iter()\n\t\t\t\t.map(|(_, currency_id, initial_balance)| (currency_id, initial_balance))\n\t\t\t\t.fold(BTreeMap::\u003cT::CurrencyId, T::Balance\u003e::new(), |mut acc, (currency_id, initial_balance)| {\n\t\t\t\t\tif let Some(issuance) = acc.get_mut(currency_id) {\n\t\t\t\t\t\t*issuance = issuance.checked_add(initial_balance).expect(\"total issuance cannot overflow when building genesis\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\tacc.insert(*currency_id, *initial_balance);\n\t\t\t\t\t}\n\t\t\t\t\tacc\n\t\t\t\t})\n\t\t\t\t.into_iter()\n\t\t\t\t.collect::\u003cVec\u003c_\u003e\u003e()\n\t\t}): map hasher(twox_64_concat) T::CurrencyId =\u003e T::Balance;\n\n\t\t/// Any liquidity locks of a token type under an account.\n\t\t/// NOTE: Should only be accessed when setting, changing and freeing a lock.\n\t\tpub Locks get(fn locks): double_map hasher(blake2_128_concat) T::AccountId, hasher(twox_64_concat) T::CurrencyId =\u003e Vec\u003cBalanceLock\u003cT::Balance\u003e\u003e;\n\n\t\t/// The balance of a token type under an account.\n\t\t///\n\t\t/// NOTE: If the total is ever zero, decrease account ref account.\n\t\t///\n\t\t/// NOTE: This is only used in the case that this module is used to store balances.\n\t\tpub Accounts get(fn accounts): double_map hasher(blake2_128_concat) T::AccountId, hasher(twox_64_concat) T::CurrencyId =\u003e AccountData\u003cT::Balance\u003e;\n\t}\n\tadd_extra_genesis {\n\t\tconfig(endowed_accounts): Vec\u003c(T::AccountId, T::CurrencyId, T::Balance)\u003e;\n\n\t\tbuild(|config: \u0026GenesisConfig\u003cT\u003e| {\n\t\t\tconfig.endowed_accounts.iter().for_each(|(account_id, currency_id, initial_balance)| {\n\t\t\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(account_id, currency_id, |account_data| account_data.free = *initial_balance)\n\t\t\t})\n\t\t})\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\t\u003cT as Trait\u003e::CurrencyId,\n\t\t\u003cT as Trait\u003e::Balance\n\t{\n\t\t/// Token transfer success. [currency_id, from, to, amount]\n\t\tTransferred(CurrencyId, AccountId, AccountId, Balance),\n\t}\n);\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Transfer some balance to another account.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 4\n\t\t/// - Db writes: 2\n\t\t/// -------------------\n\t\t/// Base Weight: 84.08 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::transfer()]\n\t\tpub fn transfer(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: T::CurrencyId,\n\t\t\t#[compact] amount: T::Balance,\n\t\t) {\n\t\t\tlet from = ensure_signed(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\t\u003cSelf as MultiCurrency\u003c_\u003e\u003e::transfer(currency_id, \u0026from, \u0026to, amount)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Transferred(currency_id, from, to, amount));\n\t\t}\n\n\t\t/// Transfer all remaining balance to the given account.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 4\n\t\t/// - Db writes: 2\n\t\t/// -------------------\n\t\t/// Base Weight: 87.71 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::transfer_all()]\n\t\tpub fn transfer_all(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: T::CurrencyId,\n\t\t) {\n\t\t\tlet from = ensure_signed(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\tlet balance = \u003cSelf as MultiCurrency\u003cT::AccountId\u003e\u003e::free_balance(currency_id, \u0026from);\n\t\t\t\u003cSelf as MultiCurrency\u003cT::AccountId\u003e\u003e::transfer(currency_id, \u0026from, \u0026to, balance)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Transferred(currency_id, from, to, balance));\n\t\t}\n\t}\n}\n\ndecl_error! {\n\t/// Error for token module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The balance is too low\n\t\tBalanceTooLow,\n\t\t/// This operation will cause balance to overflow\n\t\tBalanceOverflow,\n\t\t/// This operation will cause total issuance to overflow\n\t\tTotalIssuanceOverflow,\n\t\t/// Cannot convert Amount into Balance type\n\t\tAmountIntoBalanceFailed,\n\t\t/// Failed because liquidity restrictions due to locking\n\t\tLiquidityRestrictions,\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Set free balance of `who` to a new value.\n\t///\n\t/// Note this will not maintain total issuance.\n\tfn set_free_balance(currency_id: T::CurrencyId, who: \u0026T::AccountId, balance: T::Balance) {\n\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(who, currency_id, |account_data| account_data.free = balance);\n\t}\n\n\t/// Set reserved balance of `who` to a new value, meanwhile enforce\n\t/// existential rule.\n\t///\n\t/// Note this will not maintain total issuance, and the caller is expected\n\t/// to do it.\n\tfn set_reserved_balance(currency_id: T::CurrencyId, who: \u0026T::AccountId, balance: T::Balance) {\n\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(who, currency_id, |account_data| account_data.reserved = balance);\n\t}\n\n\t/// Update the account entry for `who` under `currency_id`, given the locks.\n\tfn update_locks(currency_id: T::CurrencyId, who: \u0026T::AccountId, locks: \u0026[BalanceLock\u003cT::Balance\u003e]) {\n\t\t// update account data\n\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(who, currency_id, |account_data| {\n\t\t\taccount_data.frozen = Zero::zero();\n\t\t\tfor lock in locks.iter() {\n\t\t\t\taccount_data.frozen = account_data.frozen.max(lock.amount);\n\t\t\t}\n\t\t});\n\n\t\t// update locks\n\t\tlet existed = \u003cLocks\u003cT\u003e\u003e::contains_key(who, currency_id);\n\t\tif locks.is_empty() {\n\t\t\t\u003cLocks\u003cT\u003e\u003e::remove(who, currency_id);\n\t\t\tif existed {\n\t\t\t\t// decrease account ref count when destruct lock\n\t\t\t\tframe_system::Module::\u003cT\u003e::dec_ref(who);\n\t\t\t}\n\t\t} else {\n\t\t\t\u003cLocks\u003cT\u003e\u003e::insert(who, currency_id, locks);\n\t\t\tif !existed {\n\t\t\t\t// increase account ref count when initialize lock\n\t\t\t\tframe_system::Module::\u003cT\u003e::inc_ref(who);\n\t\t\t}\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype CurrencyId = T::CurrencyId;\n\ttype Balance = T::Balance;\n\n\tfn total_issuance(currency_id: Self::CurrencyId) -\u003e Self::Balance {\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::get(currency_id)\n\t}\n\n\tfn total_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tSelf::accounts(who, currency_id).total()\n\t}\n\n\tfn free_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tSelf::accounts(who, currency_id).free\n\t}\n\n\t// Ensure that an account can withdraw from their free balance given any\n\t// existing withdrawal restrictions like locks and vesting balance.\n\t// Is a no-op if amount to be withdrawn is zero.\n\tfn ensure_can_withdraw(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\tlet new_balance = Self::free_balance(currency_id, who)\n\t\t\t.checked_sub(\u0026amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::BalanceTooLow)?;\n\t\tensure!(\n\t\t\tnew_balance \u003e= Self::accounts(who, currency_id).frozen(),\n\t\t\tError::\u003cT\u003e::LiquidityRestrictions\n\t\t);\n\t\tOk(())\n\t}\n\n\t/// Transfer some free balance from `from` to `to`.\n\t/// Is a no-op if value to be transferred is zero or the `from` is the same\n\t/// as `to`.\n\tfn transfer(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tfrom: \u0026T::AccountId,\n\t\tto: \u0026T::AccountId,\n\t\tamount: Self::Balance,\n\t) -\u003e DispatchResult {\n\t\tif amount.is_zero() || from == to {\n\t\t\treturn Ok(());\n\t\t}\n\t\tSelf::ensure_can_withdraw(currency_id, from, amount)?;\n\n\t\tlet from_balance = Self::free_balance(currency_id, from);\n\t\tlet to_balance = Self::free_balance(currency_id, to)\n\t\t\t.checked_add(\u0026amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::BalanceOverflow)?;\n\t\t// Cannot underflow because ensure_can_withdraw check\n\t\tSelf::set_free_balance(currency_id, from, from_balance - amount);\n\t\tSelf::set_free_balance(currency_id, to, to_balance);\n\t\tT::OnReceived::on_received(to, currency_id, amount);\n\n\t\tOk(())\n\t}\n\n\t/// Deposit some `amount` into the free balance of account `who`.\n\t///\n\t/// Is a no-op if the `amount` to be deposited is zero.\n\tfn deposit(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\tlet new_total = Self::total_issuance(currency_id)\n\t\t\t.checked_add(\u0026amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::TotalIssuanceOverflow)?;\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::insert(currency_id, new_total);\n\t\tSelf::set_free_balance(currency_id, who, Self::free_balance(currency_id, who) + amount);\n\t\tT::OnReceived::on_received(who, currency_id, amount);\n\n\t\tOk(())\n\t}\n\n\tfn withdraw(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\t\tSelf::ensure_can_withdraw(currency_id, who, amount)?;\n\n\t\t// Cannot underflow because ensure_can_withdraw check\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(currency_id, |v| *v -= amount);\n\t\tSelf::set_free_balance(currency_id, who, Self::free_balance(currency_id, who) - amount);\n\n\t\tOk(())\n\t}\n\n\t// Check if `value` amount of free balance can be slashed from `who`.\n\tfn can_slash(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tif value.is_zero() {\n\t\t\treturn true;\n\t\t}\n\t\tSelf::free_balance(currency_id, who) \u003e= value\n\t}\n\n\t/// Is a no-op if `value` to be slashed is zero.\n\t///\n\t/// NOTE: `slash()` prefers free balance, but assumes that reserve balance\n\t/// can be drawn from in extreme circumstances. `can_slash()` should be used\n\t/// prior to `slash()` to avoid having to draw from reserved funds, however\n\t/// we err on the side of punishment if things are inconsistent\n\t/// or `can_slash` wasn't used appropriately.\n\tfn slash(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e Self::Balance {\n\t\tif amount.is_zero() {\n\t\t\treturn amount;\n\t\t}\n\n\t\tlet account = Self::accounts(who, currency_id);\n\t\tlet free_slashed_amount = account.free.min(amount);\n\t\t// Cannot underflow becuase free_slashed_amount can never be greater than amount\n\t\tlet mut remaining_slash = amount - free_slashed_amount;\n\n\t\t// slash free balance\n\t\tif !free_slashed_amount.is_zero() {\n\t\t\t// Cannot underflow becuase free_slashed_amount can never be greater than\n\t\t\t// account.free\n\t\t\tSelf::set_free_balance(currency_id, who, account.free - free_slashed_amount);\n\t\t}\n\n\t\t// slash reserved balance\n\t\tif !remaining_slash.is_zero() {\n\t\t\tlet reserved_slashed_amount = account.reserved.min(remaining_slash);\n\t\t\t// Cannot underflow due to above line\n\t\t\tremaining_slash -= reserved_slashed_amount;\n\t\t\tSelf::set_reserved_balance(currency_id, who, account.reserved - reserved_slashed_amount);\n\t\t}\n\n\t\t// Cannot underflow because the slashed value cannot be greater than total\n\t\t// issuance\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(currency_id, |v| *v -= amount - remaining_slash);\n\t\tremaining_slash\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiCurrencyExtended\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype Amount = T::Amount;\n\n\tfn update_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId, by_amount: Self::Amount) -\u003e DispatchResult {\n\t\tif by_amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\t// Ensure this doesn't overflow. There isn't any traits that exposes\n\t\t// `saturating_abs` so we need to do it manually.\n\t\tlet by_amount_abs = if by_amount == Self::Amount::min_value() {\n\t\t\tSelf::Amount::max_value()\n\t\t} else {\n\t\t\tby_amount.abs()\n\t\t};\n\n\t\tlet by_balance =\n\t\t\tTryInto::\u003cSelf::Balance\u003e::try_into(by_amount_abs).map_err(|_| Error::\u003cT\u003e::AmountIntoBalanceFailed)?;\n\t\tif by_amount.is_positive() {\n\t\t\tSelf::deposit(currency_id, who, by_balance)\n\t\t} else {\n\t\t\tSelf::withdraw(currency_id, who, by_balance).map(|_| ())\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiLockableCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype Moment = T::BlockNumber;\n\n\t// Set a lock on the balance of `who` under `currency_id`.\n\t// Is a no-op if lock amount is zero.\n\tfn set_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\tif amount.is_zero() {\n\t\t\treturn;\n\t\t}\n\t\tlet mut new_lock = Some(BalanceLock { id: lock_id, amount });\n\t\tlet mut locks = Self::locks(who, currency_id)\n\t\t\t.into_iter()\n\t\t\t.filter_map(|lock| {\n\t\t\t\tif lock.id == lock_id {\n\t\t\t\t\tnew_lock.take()\n\t\t\t\t} else {\n\t\t\t\t\tSome(lock)\n\t\t\t\t}\n\t\t\t})\n\t\t\t.collect::\u003cVec\u003c_\u003e\u003e();\n\t\tif let Some(lock) = new_lock {\n\t\t\tlocks.push(lock)\n\t\t}\n\t\tSelf::update_locks(currency_id, who, \u0026locks[..]);\n\t}\n\n\t// Extend a lock on the balance of `who` under `currency_id`.\n\t// Is a no-op if lock amount is zero\n\tfn extend_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\tif amount.is_zero() {\n\t\t\treturn;\n\t\t}\n\t\tlet mut new_lock = Some(BalanceLock { id: lock_id, amount });\n\t\tlet mut locks = Self::locks(who, currency_id)\n\t\t\t.into_iter()\n\t\t\t.filter_map(|lock| {\n\t\t\t\tif lock.id == lock_id {\n\t\t\t\t\tnew_lock.take().map(|nl| BalanceLock {\n\t\t\t\t\t\tid: lock.id,\n\t\t\t\t\t\tamount: lock.amount.max(nl.amount),\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\tSome(lock)\n\t\t\t\t}\n\t\t\t})\n\t\t\t.collect::\u003cVec\u003c_\u003e\u003e();\n\t\tif let Some(lock) = new_lock {\n\t\t\tlocks.push(lock)\n\t\t}\n\t\tSelf::update_locks(currency_id, who, \u0026locks[..]);\n\t}\n\n\tfn remove_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId) {\n\t\tlet mut locks = Self::locks(who, currency_id);\n\t\tlocks.retain(|lock| lock.id != lock_id);\n\t\tSelf::update_locks(currency_id, who, \u0026locks[..]);\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiReservableCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\t/// Check if `who` can reserve `value` from their free balance.\n\t///\n\t/// Always `true` if value to be reserved is zero.\n\tfn can_reserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tif value.is_zero() {\n\t\t\treturn true;\n\t\t}\n\t\tSelf::ensure_can_withdraw(currency_id, who, value).is_ok()\n\t}\n\n\t/// Slash from reserved balance, returning any amount that was unable to be\n\t/// slashed.\n\t///\n\t/// Is a no-op if the value to be slashed is zero.\n\tfn slash_reserved(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tif value.is_zero() {\n\t\t\treturn value;\n\t\t}\n\n\t\tlet reserved_balance = Self::reserved_balance(currency_id, who);\n\t\tlet actual = reserved_balance.min(value);\n\t\tSelf::set_reserved_balance(currency_id, who, reserved_balance - actual);\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(currency_id, |v| *v -= actual);\n\t\tvalue - actual\n\t}\n\n\tfn reserved_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tSelf::accounts(who, currency_id).reserved\n\t}\n\n\t/// Move `value` from the free balance from `who` to their reserved balance.\n\t///\n\t/// Is a no-op if value to be reserved is zero.\n\tfn reserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\tif value.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\t\tSelf::ensure_can_withdraw(currency_id, who, value)?;\n\n\t\tlet account = Self::accounts(who, currency_id);\n\t\tSelf::set_free_balance(currency_id, who, account.free - value);\n\t\t// Cannot overflow becuase total issuance is using the same balance type and\n\t\t// this doesn't increase total issuance\n\t\tSelf::set_reserved_balance(currency_id, who, account.reserved + value);\n\t\tOk(())\n\t}\n\n\t/// Unreserve some funds, returning any amount that was unable to be\n\t/// unreserved.\n\t///\n\t/// Is a no-op if the value to be unreserved is zero.\n\tfn unreserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tif value.is_zero() {\n\t\t\treturn value;\n\t\t}\n\n\t\tlet account = Self::accounts(who, currency_id);\n\t\tlet actual = account.reserved.min(value);\n\t\tSelf::set_reserved_balance(currency_id, who, account.reserved - actual);\n\t\tSelf::set_free_balance(currency_id, who, account.free + actual);\n\t\tT::OnReceived::on_received(who, currency_id, actual);\n\t\tvalue - actual\n\t}\n\n\t/// Move the reserved balance of one account into the balance of another,\n\t/// according to `status`.\n\t///\n\t/// Is a no-op if:\n\t/// - the value to be moved is zero; or\n\t/// - the `slashed` id equal to `beneficiary` and the `status` is\n\t///   `Reserved`.\n\tfn repatriate_reserved(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tslashed: \u0026T::AccountId,\n\t\tbeneficiary: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\tif value.is_zero() {\n\t\t\treturn Ok(value);\n\t\t}\n\n\t\tif slashed == beneficiary {\n\t\t\treturn match status {\n\t\t\t\tBalanceStatus::Free =\u003e Ok(Self::unreserve(currency_id, slashed, value)),\n\t\t\t\tBalanceStatus::Reserved =\u003e Ok(value.saturating_sub(Self::reserved_balance(currency_id, slashed))),\n\t\t\t};\n\t\t}\n\n\t\tlet from_account = Self::accounts(slashed, currency_id);\n\t\tlet to_account = Self::accounts(beneficiary, currency_id);\n\t\tlet actual = from_account.reserved.min(value);\n\t\tmatch status {\n\t\t\tBalanceStatus::Free =\u003e {\n\t\t\t\tSelf::set_free_balance(currency_id, beneficiary, to_account.free + actual);\n\t\t\t\tT::OnReceived::on_received(beneficiary, currency_id, actual);\n\t\t\t}\n\t\t\tBalanceStatus::Reserved =\u003e {\n\t\t\t\tSelf::set_reserved_balance(currency_id, beneficiary, to_account.reserved + actual);\n\t\t\t}\n\t\t}\n\t\tSelf::set_reserved_balance(currency_id, slashed, from_account.reserved - actual);\n\t\tOk(value - actual)\n\t}\n}\n\npub struct CurrencyAdapter\u003cT, GetCurrencyId\u003e(marker::PhantomData\u003c(T, GetCurrencyId)\u003e);\n\nimpl\u003cT, GetCurrencyId\u003e PalletCurrency\u003cT::AccountId\u003e for CurrencyAdapter\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cT::CurrencyId\u003e,\n{\n\ttype Balance = T::Balance;\n\ttype PositiveImbalance = PositiveImbalance\u003cT, GetCurrencyId\u003e;\n\ttype NegativeImbalance = NegativeImbalance\u003cT, GetCurrencyId\u003e;\n\n\tfn total_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::total_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn can_slash(who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tModule::\u003cT\u003e::can_slash(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn total_issuance() -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::total_issuance(GetCurrencyId::get())\n\t}\n\n\tfn minimum_balance() -\u003e Self::Balance {\n\t\tZero::zero()\n\t}\n\n\tfn burn(mut amount: Self::Balance) -\u003e Self::PositiveImbalance {\n\t\tif amount.is_zero() {\n\t\t\treturn PositiveImbalance::zero();\n\t\t}\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(GetCurrencyId::get(), |issued| {\n\t\t\t*issued = issued.checked_sub(\u0026amount).unwrap_or_else(|| {\n\t\t\t\tamount = *issued;\n\t\t\t\tZero::zero()\n\t\t\t});\n\t\t});\n\t\tPositiveImbalance::new(amount)\n\t}\n\n\tfn issue(mut amount: Self::Balance) -\u003e Self::NegativeImbalance {\n\t\tif amount.is_zero() {\n\t\t\treturn NegativeImbalance::zero();\n\t\t}\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(GetCurrencyId::get(), |issued| {\n\t\t\t*issued = issued.checked_add(\u0026amount).unwrap_or_else(|| {\n\t\t\t\tamount = Self::Balance::max_value() - *issued;\n\t\t\t\tSelf::Balance::max_value()\n\t\t\t})\n\t\t});\n\t\tNegativeImbalance::new(amount)\n\t}\n\n\tfn free_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::free_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn ensure_can_withdraw(\n\t\twho: \u0026T::AccountId,\n\t\tamount: Self::Balance,\n\t\t_reasons: WithdrawReasons,\n\t\t_new_balance: Self::Balance,\n\t) -\u003e DispatchResult {\n\t\tModule::\u003cT\u003e::ensure_can_withdraw(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn transfer(\n\t\tsource: \u0026T::AccountId,\n\t\tdest: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\t_existence_requirement: ExistenceRequirement,\n\t) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e as MultiCurrency\u003cT::AccountId\u003e\u003e::transfer(GetCurrencyId::get(), \u0026source, \u0026dest, value)\n\t}\n\n\tfn slash(who: \u0026T::AccountId, value: Self::Balance) -\u003e (Self::NegativeImbalance, Self::Balance) {\n\t\tif value.is_zero() {\n\t\t\treturn (Self::NegativeImbalance::zero(), value);\n\t\t}\n\n\t\tlet currency_id = GetCurrencyId::get();\n\t\tlet account = Module::\u003cT\u003e::accounts(who, currency_id);\n\t\tlet free_slashed_amount = account.free.min(value);\n\t\tlet mut remaining_slash = value - free_slashed_amount;\n\n\t\t// slash free balance\n\t\tif !free_slashed_amount.is_zero() {\n\t\t\tModule::\u003cT\u003e::set_free_balance(currency_id, who, account.free - free_slashed_amount);\n\t\t}\n\n\t\t// slash reserved balance\n\t\tif !remaining_slash.is_zero() {\n\t\t\tlet reserved_slashed_amount = account.reserved.min(remaining_slash);\n\t\t\tremaining_slash -= reserved_slashed_amount;\n\t\t\tModule::\u003cT\u003e::set_reserved_balance(currency_id, who, account.reserved - reserved_slashed_amount);\n\t\t\t(\n\t\t\t\tSelf::NegativeImbalance::new(free_slashed_amount + reserved_slashed_amount),\n\t\t\t\tremaining_slash,\n\t\t\t)\n\t\t} else {\n\t\t\t(Self::NegativeImbalance::new(value), remaining_slash)\n\t\t}\n\t}\n\n\tfn deposit_into_existing(\n\t\twho: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t) -\u003e result::Result\u003cSelf::PositiveImbalance, DispatchError\u003e {\n\t\tif value.is_zero() {\n\t\t\treturn Ok(Self::PositiveImbalance::zero());\n\t\t}\n\t\tlet currency_id = GetCurrencyId::get();\n\t\tlet new_total = Module::\u003cT\u003e::free_balance(currency_id, who)\n\t\t\t.checked_add(\u0026value)\n\t\t\t.ok_or(Error::\u003cT\u003e::TotalIssuanceOverflow)?;\n\t\tModule::\u003cT\u003e::set_free_balance(currency_id, who, new_total);\n\n\t\tOk(Self::PositiveImbalance::new(value))\n\t}\n\n\tfn deposit_creating(who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::PositiveImbalance {\n\t\tSelf::deposit_into_existing(who, value).unwrap_or_else(|_| Self::PositiveImbalance::zero())\n\t}\n\n\tfn withdraw(\n\t\twho: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\t_reasons: WithdrawReasons,\n\t\t_liveness: ExistenceRequirement,\n\t) -\u003e result::Result\u003cSelf::NegativeImbalance, DispatchError\u003e {\n\t\tif value.is_zero() {\n\t\t\treturn Ok(Self::NegativeImbalance::zero());\n\t\t}\n\t\tlet currency_id = GetCurrencyId::get();\n\t\tModule::\u003cT\u003e::ensure_can_withdraw(currency_id, who, value)?;\n\t\tModule::\u003cT\u003e::set_free_balance(currency_id, who, Module::\u003cT\u003e::free_balance(currency_id, who) - value);\n\n\t\tOk(Self::NegativeImbalance::new(value))\n\t}\n\n\tfn make_free_balance_be(\n\t\twho: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t) -\u003e SignedImbalance\u003cSelf::Balance, Self::PositiveImbalance\u003e {\n\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(\n\t\t\twho,\n\t\t\tGetCurrencyId::get(),\n\t\t\t|account| -\u003e Result\u003cSignedImbalance\u003cSelf::Balance, Self::PositiveImbalance\u003e, ()\u003e {\n\t\t\t\tlet imbalance = if account.free \u003c= value {\n\t\t\t\t\tSignedImbalance::Positive(PositiveImbalance::new(value - account.free))\n\t\t\t\t} else {\n\t\t\t\t\tSignedImbalance::Negative(NegativeImbalance::new(account.free - value))\n\t\t\t\t};\n\t\t\t\taccount.free = value;\n\t\t\t\tOk(imbalance)\n\t\t\t},\n\t\t)\n\t\t.unwrap_or_else(|_| SignedImbalance::Positive(Self::PositiveImbalance::zero()))\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e PalletReservableCurrency\u003cT::AccountId\u003e for CurrencyAdapter\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cT::CurrencyId\u003e,\n{\n\tfn can_reserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tModule::\u003cT\u003e::can_reserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn slash_reserved(who: \u0026T::AccountId, value: Self::Balance) -\u003e (Self::NegativeImbalance, Self::Balance) {\n\t\tlet actual = Module::\u003cT\u003e::slash_reserved(GetCurrencyId::get(), who, value);\n\t\t(Self::NegativeImbalance::zero(), actual)\n\t}\n\n\tfn reserved_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::reserved_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn reserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\tModule::\u003cT\u003e::reserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn unreserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::unreserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn repatriate_reserved(\n\t\tslashed: \u0026T::AccountId,\n\t\tbeneficiary: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: Status,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\tModule::\u003cT\u003e::repatriate_reserved(GetCurrencyId::get(), slashed, beneficiary, value, status)\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e PalletLockableCurrency\u003cT::AccountId\u003e for CurrencyAdapter\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cT::CurrencyId\u003e,\n{\n\ttype Moment = T::BlockNumber;\n\ttype MaxLocks = ();\n\n\tfn set_lock(id: LockIdentifier, who: \u0026T::AccountId, amount: Self::Balance, _reasons: WithdrawReasons) {\n\t\tModule::\u003cT\u003e::set_lock(id, GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn extend_lock(id: LockIdentifier, who: \u0026T::AccountId, amount: Self::Balance, _reasons: WithdrawReasons) {\n\t\tModule::\u003cT\u003e::extend_lock(id, GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn remove_lock(id: LockIdentifier, who: \u0026T::AccountId) {\n\t\tModule::\u003cT\u003e::remove_lock(id, GetCurrencyId::get(), who)\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","mock.rs"],"content":"//! Mocks for the tokens module.\n\n#![cfg(test)]\n\nuse frame_support::{\n\timpl_outer_event, impl_outer_origin, parameter_types,\n\ttraits::{ChangeMembers, Contains, ContainsLengthBound},\n};\nuse frame_system as system;\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{Convert, IdentityLookup},\n\tModuleId, Perbill, Percent, Permill,\n};\nuse sp_std::cell::RefCell;\nuse std::collections::HashMap;\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod tokens {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\ttokens\u003cT\u003e,\n\t\tpallet_treasury\u003cT\u003e,\n\t\tpallet_elections_phragmen\u003cT\u003e,\n\t}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\ntype AccountId = u64;\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = system::Module\u003cRuntime\u003e;\n\ntype CurrencyId = u32;\npub type Balance = u64;\n\nthread_local! {\n\tpub static ACCUMULATED_RECEIVED: RefCell\u003cHashMap\u003c(AccountId, CurrencyId), Balance\u003e\u003e = RefCell::new(HashMap::new());\n}\n\npub struct MockOnReceived;\nimpl OnReceived\u003cAccountId, CurrencyId, Balance\u003e for MockOnReceived {\n\tfn on_received(who: \u0026AccountId, currency_id: CurrencyId, amount: Balance) {\n\t\tACCUMULATED_RECEIVED.with(|v| {\n\t\t\tlet mut old_map = v.borrow().clone();\n\t\t\tif let Some(before) = old_map.get_mut(\u0026(*who, currency_id)) {\n\t\t\t\t*before += amount;\n\t\t\t} else {\n\t\t\t\told_map.insert((*who, currency_id), amount);\n\t\t\t};\n\n\t\t\t*v.borrow_mut() = old_map;\n\t\t});\n\t}\n}\n\nthread_local! {\n\tstatic TEN_TO_FOURTEEN: RefCell\u003cVec\u003cu64\u003e\u003e = RefCell::new(vec![10,11,12,13,14]);\n}\npub struct TenToFourteen;\nimpl Contains\u003cu64\u003e for TenToFourteen {\n\tfn sorted_members() -\u003e Vec\u003cu64\u003e {\n\t\tTEN_TO_FOURTEEN.with(|v| v.borrow().clone())\n\t}\n\t#[cfg(feature = \"runtime-benchmarks\")]\n\tfn add(new: \u0026u64) {\n\t\tTEN_TO_FOURTEEN.with(|v| {\n\t\t\tlet mut members = v.borrow_mut();\n\t\t\tmembers.push(*new);\n\t\t\tmembers.sort();\n\t\t})\n\t}\n}\nimpl ContainsLengthBound for TenToFourteen {\n\tfn max_len() -\u003e usize {\n\t\tTEN_TO_FOURTEEN.with(|v| v.borrow().len())\n\t}\n\tfn min_len() -\u003e usize {\n\t\t0\n\t}\n}\n\nparameter_types! {\n\tpub const ProposalBond: Permill = Permill::from_percent(5);\n\tpub const ProposalBondMinimum: u64 = 1;\n\tpub const TipCountdown: u64 = 1;\n\tpub const TipFindersFee: Percent = Percent::from_percent(20);\n\tpub const TipReportDepositBase: u64 = 1;\n\tpub const DataDepositPerByte: u64 = 1;\n\tpub const SpendPeriod: u64 = 2;\n\tpub const Burn: Permill = Permill::from_percent(50);\n\tpub const TreasuryModuleId: ModuleId = ModuleId(*b\"py/trsry\");\n\tpub const GetTokenId: CurrencyId = TEST_TOKEN_ID;\n}\n\nimpl pallet_treasury::Trait for Runtime {\n\ttype ModuleId = TreasuryModuleId;\n\ttype Currency = CurrencyAdapter\u003cRuntime, GetTokenId\u003e;\n\ttype ApproveOrigin = frame_system::EnsureRoot\u003cu64\u003e;\n\ttype RejectOrigin = frame_system::EnsureRoot\u003cu64\u003e;\n\ttype Tippers = TenToFourteen;\n\ttype TipCountdown = TipCountdown;\n\ttype TipFindersFee = TipFindersFee;\n\ttype TipReportDepositBase = TipReportDepositBase;\n\ttype DataDepositPerByte = DataDepositPerByte;\n\ttype Event = TestEvent;\n\ttype OnSlash = ();\n\ttype ProposalBond = ProposalBond;\n\ttype ProposalBondMinimum = ProposalBondMinimum;\n\ttype SpendPeriod = SpendPeriod;\n\ttype Burn = Burn;\n\ttype BurnDestination = (); // Just gets burned.\n\ttype BountyDepositBase = ();\n\ttype BountyDepositPayoutDelay = ();\n\ttype BountyUpdatePeriod = ();\n\ttype BountyCuratorDeposit = ();\n\ttype BountyValueMinimum = ();\n\ttype MaximumReasonLength = ();\n\ttype WeightInfo = ();\n}\n\npub struct CurrencyToVoteHandler;\nimpl Convert\u003cu64, u64\u003e for CurrencyToVoteHandler {\n\tfn convert(x: u64) -\u003e u64 {\n\t\tx\n\t}\n}\nimpl Convert\u003cu128, u64\u003e for CurrencyToVoteHandler {\n\tfn convert(x: u128) -\u003e u64 {\n\t\tx as u64\n\t}\n}\n\nparameter_types! {\n\tpub const CandidacyBond: u64 = 3;\n}\n\nthread_local! {\n\tstatic VOTING_BOND: RefCell\u003cu64\u003e = RefCell::new(2);\n\tstatic DESIRED_MEMBERS: RefCell\u003cu32\u003e = RefCell::new(2);\n\tstatic DESIRED_RUNNERS_UP: RefCell\u003cu32\u003e = RefCell::new(2);\n\tstatic TERM_DURATION: RefCell\u003cu64\u003e = RefCell::new(5);\n}\n\npub struct VotingBond;\nimpl Get\u003cu64\u003e for VotingBond {\n\tfn get() -\u003e u64 {\n\t\tVOTING_BOND.with(|v| *v.borrow())\n\t}\n}\n\npub struct DesiredMembers;\nimpl Get\u003cu32\u003e for DesiredMembers {\n\tfn get() -\u003e u32 {\n\t\tDESIRED_MEMBERS.with(|v| *v.borrow())\n\t}\n}\n\npub struct DesiredRunnersUp;\nimpl Get\u003cu32\u003e for DesiredRunnersUp {\n\tfn get() -\u003e u32 {\n\t\tDESIRED_RUNNERS_UP.with(|v| *v.borrow())\n\t}\n}\n\npub struct TermDuration;\nimpl Get\u003cu64\u003e for TermDuration {\n\tfn get() -\u003e u64 {\n\t\tTERM_DURATION.with(|v| *v.borrow())\n\t}\n}\n\nthread_local! {\n\tpub static MEMBERS: RefCell\u003cVec\u003cu64\u003e\u003e = RefCell::new(vec![]);\n\tpub static PRIME: RefCell\u003cOption\u003cu64\u003e\u003e = RefCell::new(None);\n}\n\npub struct TestChangeMembers;\nimpl ChangeMembers\u003cu64\u003e for TestChangeMembers {\n\tfn change_members_sorted(incoming: \u0026[u64], outgoing: \u0026[u64], new: \u0026[u64]) {\n\t\t// new, incoming, outgoing must be sorted.\n\t\tlet mut new_sorted = new.to_vec();\n\t\tnew_sorted.sort();\n\t\tassert_eq!(new, \u0026new_sorted[..]);\n\n\t\tlet mut incoming_sorted = incoming.to_vec();\n\t\tincoming_sorted.sort();\n\t\tassert_eq!(incoming, \u0026incoming_sorted[..]);\n\n\t\tlet mut outgoing_sorted = outgoing.to_vec();\n\t\toutgoing_sorted.sort();\n\t\tassert_eq!(outgoing, \u0026outgoing_sorted[..]);\n\n\t\t// incoming and outgoing must be disjoint\n\t\tfor x in incoming.iter() {\n\t\t\tassert!(outgoing.binary_search(x).is_err());\n\t\t}\n\n\t\tlet mut old_plus_incoming = MEMBERS.with(|m| m.borrow().to_vec());\n\t\told_plus_incoming.extend_from_slice(incoming);\n\t\told_plus_incoming.sort();\n\n\t\tlet mut new_plus_outgoing = new.to_vec();\n\t\tnew_plus_outgoing.extend_from_slice(outgoing);\n\t\tnew_plus_outgoing.sort();\n\n\t\tassert_eq!(\n\t\t\told_plus_incoming, new_plus_outgoing,\n\t\t\t\"change members call is incorrect!\"\n\t\t);\n\n\t\tMEMBERS.with(|m| *m.borrow_mut() = new.to_vec());\n\t\tPRIME.with(|p| *p.borrow_mut() = None);\n\t}\n\n\tfn set_prime(who: Option\u003cu64\u003e) {\n\t\tPRIME.with(|p| *p.borrow_mut() = who);\n\t}\n}\n\nparameter_types! {\n\tpub const ElectionsPhragmenModuleId: LockIdentifier = *b\"phrelect\";\n}\n\nimpl pallet_elections_phragmen::Trait for Runtime {\n\ttype ModuleId = ElectionsPhragmenModuleId;\n\ttype Event = TestEvent;\n\ttype Currency = CurrencyAdapter\u003cRuntime, GetTokenId\u003e;\n\ttype CurrencyToVote = CurrencyToVoteHandler;\n\ttype ChangeMembers = TestChangeMembers;\n\ttype InitializeMembers = ();\n\ttype CandidacyBond = CandidacyBond;\n\ttype VotingBond = VotingBond;\n\ttype TermDuration = TermDuration;\n\ttype DesiredMembers = DesiredMembers;\n\ttype DesiredRunnersUp = DesiredRunnersUp;\n\ttype LoserCandidate = ();\n\ttype KickedMember = ();\n\ttype BadReport = ();\n\ttype WeightInfo = ();\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = i64;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = MockOnReceived;\n\ttype WeightInfo = ();\n}\n\npub type Tokens = Module\u003cRuntime\u003e;\npub type TreasuryCurrencyAdapter = \u003cRuntime as pallet_treasury::Trait\u003e::Currency;\n\npub const TEST_TOKEN_ID: CurrencyId = 1;\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const TREASURY_ACCOUNT: AccountId = 3;\npub const ID_1: LockIdentifier = *b\"1       \";\npub const ID_2: LockIdentifier = *b\"2       \";\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n\ttreasury_genesis: bool,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t\ttreasury_genesis: false,\n\t\t}\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn balances(mut self, endowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e) -\u003e Self {\n\t\tself.endowed_accounts = endowed_accounts;\n\t\tself\n\t}\n\n\tpub fn one_hundred_for_alice_n_bob(self) -\u003e Self {\n\t\tself.balances(vec![(ALICE, TEST_TOKEN_ID, 100), (BOB, TEST_TOKEN_ID, 100)])\n\t}\n\n\tpub fn one_hundred_for_treasury_account(mut self) -\u003e Self {\n\t\tself.treasury_genesis = true;\n\t\tself.balances(vec![(TREASURY_ACCOUNT, TEST_TOKEN_ID, 100)])\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tGenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tif self.treasury_genesis {\n\t\t\tpallet_treasury::GenesisConfig::default()\n\t\t\t\t.assimilate_storage::\u003cRuntime, _\u003e(\u0026mut t)\n\t\t\t\t.unwrap();\n\n\t\t\tpallet_elections_phragmen::GenesisConfig::\u003cRuntime\u003e {\n\t\t\t\tmembers: vec![(TREASURY_ACCOUNT, 10)],\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\t\t}\n\n\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","tests.rs"],"content":"//! Unit tests for the tokens module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok, traits::WithdrawReason};\nuse mock::{\n\tBalance, ExtBuilder, Runtime, System, TestEvent, Tokens, TreasuryCurrencyAdapter, ACCUMULATED_RECEIVED, ALICE, BOB,\n\tID_1, ID_2, TEST_TOKEN_ID, TREASURY_ACCOUNT,\n};\n\n#[test]\nfn set_lock_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 10);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen(), 10);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 50);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 50);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t\tTokens::set_lock(ID_2, TEST_TOKEN_ID, \u0026ALICE, 60);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 60);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 2);\n\t\t});\n}\n\n#[test]\nfn extend_lock_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 10);\n\t\t\tTokens::extend_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 20);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 20);\n\t\t\tTokens::extend_lock(ID_2, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tTokens::extend_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 20);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 2);\n\t\t});\n}\n\n#[test]\nfn remove_lock_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tTokens::set_lock(ID_2, TEST_TOKEN_ID, \u0026ALICE, 20);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 2);\n\t\t\tTokens::remove_lock(ID_2, TEST_TOKEN_ID, \u0026ALICE);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t});\n}\n\n#[test]\nfn frozen_can_limit_liquidity() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 90);\n\t\t\tassert_noop!(\n\t\t\t\t\u003cTokens as MultiCurrency\u003c_\u003e\u003e::transfer(TEST_TOKEN_ID, \u0026ALICE, \u0026BOB, 11),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions,\n\t\t\t);\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tassert_ok!(\u003cTokens as MultiCurrency\u003c_\u003e\u003e::transfer(TEST_TOKEN_ID, \u0026ALICE, \u0026BOB, 11),);\n\t\t});\n}\n\n#[test]\nfn can_reserve_is_correct() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::can_reserve(TEST_TOKEN_ID, \u0026ALICE, 0), true);\n\t\t\tassert_eq!(Tokens::can_reserve(TEST_TOKEN_ID, \u0026ALICE, 101), false);\n\t\t\tassert_eq!(Tokens::can_reserve(TEST_TOKEN_ID, \u0026ALICE, 100), true);\n\t\t});\n}\n\n#[test]\nfn reserve_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_noop!(\n\t\t\t\tTokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 101),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow,\n\t\t\t);\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::total_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t});\n}\n\n#[test]\nfn unreserve_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::unreserve(TEST_TOKEN_ID, \u0026ALICE, 0), 0);\n\t\t\tassert_eq!(Tokens::unreserve(TEST_TOKEN_ID, \u0026ALICE, 50), 50);\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 30));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 70);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 30);\n\t\t\tassert_eq!(Tokens::unreserve(TEST_TOKEN_ID, \u0026ALICE, 15), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 85);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 15);\n\t\t\tassert_eq!(Tokens::unreserve(TEST_TOKEN_ID, \u0026ALICE, 30), 15);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t});\n}\n\n#[test]\nfn slash_reserved_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\t\t\tassert_eq!(Tokens::slash_reserved(TEST_TOKEN_ID, \u0026ALICE, 0), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\t\t\tassert_eq!(Tokens::slash_reserved(TEST_TOKEN_ID, \u0026ALICE, 100), 50);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 150);\n\t\t});\n}\n\n#[test]\nfn repatriate_reserved_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026ALICE, \u0026ALICE, 0, BalanceStatus::Free),\n\t\t\t\tOk(0)\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026ALICE, \u0026ALICE, 50, BalanceStatus::Free),\n\t\t\t\tOk(50)\n\t\t\t);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 0);\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026BOB, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026BOB, \u0026BOB, 60, BalanceStatus::Reserved),\n\t\t\t\tOk(10)\n\t\t\t);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026BOB, \u0026ALICE, 30, BalanceStatus::Reserved),\n\t\t\t\tOk(0)\n\t\t\t);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 30);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 20);\n\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026BOB, \u0026ALICE, 30, BalanceStatus::Free),\n\t\t\t\tOk(10)\n\t\t\t);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 120);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 30);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 0);\n\t\t});\n}\n\n#[test]\nfn slash_draw_reserved_correct() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\n\t\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 80), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 20);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 120);\n\n\t\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 50), 30);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 100);\n\t\t});\n}\n\n#[test]\nfn genesis_issuance_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 100);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\t\t});\n}\n\n#[test]\nfn transfer_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Tokens::transfer(Some(ALICE).into(), BOB, TEST_TOKEN_ID, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 150);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\t\t\tassert_eq!(\n\t\t\t\tACCUMULATED_RECEIVED.with(|v| *v.borrow().get(\u0026(BOB, TEST_TOKEN_ID)).unwrap()),\n\t\t\t\t50\n\t\t\t);\n\n\t\t\tlet transferred_event = TestEvent::tokens(RawEvent::Transferred(TEST_TOKEN_ID, ALICE, BOB, 50));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\n\t\t\tassert_noop!(\n\t\t\t\tTokens::transfer(Some(ALICE).into(), BOB, TEST_TOKEN_ID, 60),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow,\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn transfer_all_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Tokens::transfer_all(Some(ALICE).into(), BOB, TEST_TOKEN_ID));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 200);\n\n\t\t\tlet transferred_event = TestEvent::tokens(RawEvent::Transferred(TEST_TOKEN_ID, ALICE, BOB, 100));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\t\t});\n}\n\n#[test]\nfn deposit_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::deposit(TEST_TOKEN_ID, \u0026ALICE, 100));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 200);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 300);\n\n\t\t\tassert_noop!(\n\t\t\t\tTokens::deposit(TEST_TOKEN_ID, \u0026ALICE, Balance::max_value()),\n\t\t\t\tError::\u003cRuntime\u003e::TotalIssuanceOverflow,\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn withdraw_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::withdraw(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 150);\n\n\t\t\tassert_noop!(\n\t\t\t\tTokens::withdraw(TEST_TOKEN_ID, \u0026ALICE, 60),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn slash_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// slashed_amount \u003c amount\n\t\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 50), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 150);\n\n\t\t\t// slashed_amount == amount\n\t\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 51), 1);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 100);\n\t\t});\n}\n\n#[test]\nfn update_balance_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::update_balance(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 150);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 250);\n\n\t\t\tassert_ok!(Tokens::update_balance(TEST_TOKEN_ID, \u0026BOB, -50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\n\t\t\tassert_noop!(\n\t\t\t\tTokens::update_balance(TEST_TOKEN_ID, \u0026BOB, -60),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn ensure_can_withdraw_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_noop!(\n\t\t\t\tTokens::ensure_can_withdraw(TEST_TOKEN_ID, \u0026ALICE, 101),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow\n\t\t\t);\n\n\t\t\tassert_ok!(Tokens::ensure_can_withdraw(TEST_TOKEN_ID, \u0026ALICE, 1));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t});\n}\n\n#[test]\nfn no_op_if_amount_is_zero() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(Tokens::ensure_can_withdraw(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t\tassert_ok!(Tokens::transfer(Some(ALICE).into(), BOB, TEST_TOKEN_ID, 0));\n\t\tassert_ok!(Tokens::transfer(Some(ALICE).into(), ALICE, TEST_TOKEN_ID, 0));\n\t\tassert_ok!(Tokens::deposit(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t\tassert_ok!(Tokens::withdraw(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 0), 0);\n\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 1), 1);\n\t\tassert_ok!(Tokens::update_balance(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t});\n}\n\n#[test]\nfn currency_adapter_ensure_currency_adapter_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 100);\n\t\t\tassert_eq!(Tokens::total_balance(TEST_TOKEN_ID, \u0026TREASURY_ACCOUNT), 100);\n\t\t\t// CandidacyBond = 3 VotingBond = 2\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026TREASURY_ACCOUNT), 5);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026TREASURY_ACCOUNT), 95);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t100\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::can_slash(\u0026TREASURY_ACCOUNT, 10),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::minimum_balance(),\n\t\t\t\t0\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::can_reserve(\u0026TREASURY_ACCOUNT, 5),\n\t\t\t\ttrue\n\t\t\t);\n\n\t\t\t// burn\n\t\t\tlet imbalance = \u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::burn(10);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t90\n\t\t\t);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\n\t\t\t// issue\n\t\t\tlet imbalance = \u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::issue(20);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t120\n\t\t\t);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\n\t\t\t// transfer\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t95\n\t\t\t);\n\t\t\tassert_ok!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::ensure_can_withdraw(\n\t\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\t10,\n\t\t\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t\t\t0\n\t\t\t\t)\n\t\t\t);\n\t\t\tassert_ok!(\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t11,\n\t\t\t\tExistenceRequirement::KeepAlive\n\t\t\t));\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t84\n\t\t\t);\n\n\t\t\t// deposit\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\t\t\tlet imbalance = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 11);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t95\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t95\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t111\n\t\t\t);\n\n\t\t\t// withdraw\n\t\t\tlet imbalance = \u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::withdraw(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t10,\n\t\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t\tExistenceRequirement::KeepAlive,\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t85\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t111\n\t\t\t);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t85\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t101\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_burn_must_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tlet init_total_issuance = TreasuryCurrencyAdapter::total_issuance();\n\t\t\tlet imbalance = TreasuryCurrencyAdapter::burn(10);\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), init_total_issuance - 10);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), init_total_issuance);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_reserving_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_balance(\u0026TREASURY_ACCOUNT), 111);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 111);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 69));\n\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_balance(\u0026TREASURY_ACCOUNT), 111);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 42);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 69);\n\t});\n}\n\n#[test]\nfn currency_adapter_balance_transfer_when_reserved_should_not_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 69));\n\t\tassert_noop!(\n\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 69, ExistenceRequirement::AllowDeath),\n\t\t\tError::\u003cRuntime\u003e::BalanceTooLow,\n\t\t);\n\t});\n}\n\n#[test]\nfn currency_adapter_deducting_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 69));\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 42);\n\t});\n}\n\n#[test]\nfn currency_adapter_refunding_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 42);\n\t\tTokens::set_reserved_balance(TEST_TOKEN_ID, \u0026TREASURY_ACCOUNT, 69);\n\t\tTreasuryCurrencyAdapter::unreserve(\u0026TREASURY_ACCOUNT, 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 111);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\t});\n}\n\n#[test]\nfn currency_adapter_slashing_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 69));\n\t\tassert!(TreasuryCurrencyAdapter::slash(\u0026TREASURY_ACCOUNT, 69).1.is_zero());\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 42);\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 42);\n\t});\n}\n\n#[test]\nfn currency_adapter_slashing_incomplete_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 42);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 21));\n\t\tassert_eq!(TreasuryCurrencyAdapter::slash(\u0026TREASURY_ACCOUNT, 69).1, 27);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 0);\n\t});\n}\n\n#[test]\nfn currency_adapter_basic_locking_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// CandidacyBond = 3 VotingBond = 2\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 95);\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 91, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 5, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_partial_locking_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 5, WithdrawReasons::all());\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t1,\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_removal_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, u64::max_value(), WithdrawReasons::all());\n\t\t\tTreasuryCurrencyAdapter::remove_lock(ID_1, \u0026TREASURY_ACCOUNT);\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t1,\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_replacement_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, u64::max_value(), WithdrawReasons::all());\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 5, WithdrawReasons::all());\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t1,\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn currency_adapter_double_locking_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 5, WithdrawReasons::none());\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_2, \u0026TREASURY_ACCOUNT, 5, WithdrawReasons::all());\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t1,\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn currency_adapter_combination_locking_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// withdrawReasons not work\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, u64::max_value(), WithdrawReasons::none());\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_2, \u0026TREASURY_ACCOUNT, 0, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 1, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_value_extension_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 100, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 2, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 8, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 3, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_block_number_extension_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 200, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tSystem::set_block_number(2);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 3, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_reasons_extension_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReason::Transfer.into());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReasons::none());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReason::Reserve.into());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_reward_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 100);\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_balance(\u0026TREASURY_ACCOUNT), 100);\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::deposit_into_existing(\u0026TREASURY_ACCOUNT, 10).map(drop));\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_balance(\u0026TREASURY_ACCOUNT), 110);\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 110);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_slashing_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 111));\n\t\tassert_eq!(TreasuryCurrencyAdapter::slash_reserved(\u0026TREASURY_ACCOUNT, 42).1, 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 69);\n\t});\n}\n\n#[test]\nfn currency_adapter_slashing_incomplete_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 42));\n\t\tassert_eq!(TreasuryCurrencyAdapter::slash_reserved(\u0026TREASURY_ACCOUNT, 69).1, 27);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 69);\n\t});\n}\n\n#[test]\nfn currency_adapter_repatriating_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 110);\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026ALICE, 1);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 110));\n\t\tassert_ok!(\n\t\t\tTreasuryCurrencyAdapter::repatriate_reserved(\u0026TREASURY_ACCOUNT, \u0026ALICE, 41, Status::Free),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026ALICE), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026ALICE), 42);\n\t});\n}\n\n#[test]\nfn currency_adapter_transferring_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 110);\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026ALICE, 1);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 110));\n\t\tassert_ok!(\n\t\t\tTreasuryCurrencyAdapter::repatriate_reserved(\u0026TREASURY_ACCOUNT, \u0026ALICE, 41, Status::Reserved),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026ALICE), 41);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026ALICE), 1);\n\t});\n}\n\n#[test]\nfn currency_adapter_transferring_reserved_balance_to_nonexistent_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 111));\n\t\tassert_ok!(TreasuryCurrencyAdapter::repatriate_reserved(\n\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\u0026ALICE,\n\t\t\t42,\n\t\t\tStatus::Free\n\t\t));\n\t});\n}\n\n#[test]\nfn currency_adapter_transferring_incomplete_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 110);\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026ALICE, 1);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 41));\n\t\tassert_ok!(\n\t\t\tTreasuryCurrencyAdapter::repatriate_reserved(\u0026TREASURY_ACCOUNT, \u0026ALICE, 69, Status::Free),\n\t\t\t28\n\t\t);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026ALICE), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026ALICE), 42);\n\t});\n}\n\n#[test]\nfn currency_adapter_transferring_too_high_value_should_not_panic() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tTreasuryCurrencyAdapter::make_free_balance_be(\u0026TREASURY_ACCOUNT, u64::max_value());\n\t\tTreasuryCurrencyAdapter::make_free_balance_be(\u0026ALICE, 1);\n\n\t\tassert_noop!(\n\t\t\tTreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\tu64::max_value(),\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::BalanceOverflow,\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tTreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\tu64::max_value()\n\t\t);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026ALICE), 1);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","arithmetic.rs"],"content":"pub use num_traits::{\n\tBounded, CheckedAdd, CheckedDiv, CheckedMul, CheckedShl, CheckedShr, CheckedSub, One, Signed, Zero,\n};\nuse sp_std::{\n\tself,\n\tconvert::{TryFrom, TryInto},\n\tops::{Add, AddAssign, Div, DivAssign, Mul, MulAssign, Rem, RemAssign, Shl, Shr, Sub, SubAssign},\n};\n\n/// A meta trait for arithmetic.\n///\n/// Arithmetic types do all the usual stuff you'd expect numbers to do. They are\n/// guaranteed to be able to represent at least `u32` values without loss, hence\n/// the trait implies `From\u003cu32\u003e` and smaller ints. All other conversions are\n/// fallible.\npub trait SimpleArithmetic:\n\tZero\n\t+ One\n\t+ From\u003cu8\u003e\n\t+ From\u003cu16\u003e\n\t+ From\u003cu32\u003e\n\t+ TryInto\u003cu8\u003e\n\t+ TryInto\u003cu16\u003e\n\t+ TryInto\u003cu32\u003e\n\t+ TryFrom\u003cu64\u003e\n\t+ TryInto\u003cu64\u003e\n\t+ TryFrom\u003cu128\u003e\n\t+ TryInto\u003cu128\u003e\n\t+ Add\u003cSelf, Output = Self\u003e\n\t+ AddAssign\u003cSelf\u003e\n\t+ Sub\u003cSelf, Output = Self\u003e\n\t+ SubAssign\u003cSelf\u003e\n\t+ Mul\u003cSelf, Output = Self\u003e\n\t+ MulAssign\u003cSelf\u003e\n\t+ Div\u003cSelf, Output = Self\u003e\n\t+ DivAssign\u003cSelf\u003e\n\t+ Rem\u003cSelf, Output = Self\u003e\n\t+ RemAssign\u003cSelf\u003e\n\t+ Shl\u003cu32, Output = Self\u003e\n\t+ Shr\u003cu32, Output = Self\u003e\n\t+ CheckedShl\n\t+ CheckedShr\n\t+ CheckedAdd\n\t+ CheckedSub\n\t+ CheckedMul\n\t+ CheckedDiv\n\t+ PartialOrd\u003cSelf\u003e\n\t+ Ord\n\t+ Bounded\n\t+ Sized\n{\n}\n\nimpl\u003c\n\t\tT: Zero\n\t\t\t+ One\n\t\t\t+ From\u003cu8\u003e\n\t\t\t+ From\u003cu16\u003e\n\t\t\t+ From\u003cu32\u003e\n\t\t\t+ TryInto\u003cu8\u003e\n\t\t\t+ TryInto\u003cu16\u003e\n\t\t\t+ TryInto\u003cu32\u003e\n\t\t\t+ TryFrom\u003cu64\u003e\n\t\t\t+ TryInto\u003cu64\u003e\n\t\t\t+ TryFrom\u003cu128\u003e\n\t\t\t+ TryInto\u003cu128\u003e\n\t\t\t+ Add\u003cSelf, Output = Self\u003e\n\t\t\t+ AddAssign\u003cSelf\u003e\n\t\t\t+ Sub\u003cSelf, Output = Self\u003e\n\t\t\t+ SubAssign\u003cSelf\u003e\n\t\t\t+ Mul\u003cSelf, Output = Self\u003e\n\t\t\t+ MulAssign\u003cSelf\u003e\n\t\t\t+ Div\u003cSelf, Output = Self\u003e\n\t\t\t+ DivAssign\u003cSelf\u003e\n\t\t\t+ Rem\u003cSelf, Output = Self\u003e\n\t\t\t+ RemAssign\u003cSelf\u003e\n\t\t\t+ Shl\u003cu32, Output = Self\u003e\n\t\t\t+ Shr\u003cu32, Output = Self\u003e\n\t\t\t+ CheckedShl\n\t\t\t+ CheckedShr\n\t\t\t+ CheckedAdd\n\t\t\t+ CheckedSub\n\t\t\t+ CheckedMul\n\t\t\t+ CheckedDiv\n\t\t\t+ PartialOrd\u003cSelf\u003e\n\t\t\t+ Ord\n\t\t\t+ Bounded\n\t\t\t+ Sized,\n\t\u003e SimpleArithmetic for T\n{\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","auction.rs"],"content":"use crate::Change;\nuse codec::FullCodec;\nuse codec::{Decode, Encode};\nuse sp_runtime::{\n\ttraits::{AtLeast32Bit, Bounded, MaybeSerializeDeserialize},\n\tDispatchError, DispatchResult, RuntimeDebug,\n};\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tfmt::Debug,\n\tresult,\n};\n\n/// Auction info.\n#[cfg_attr(feature = \"std\", derive(PartialEq, Eq))]\n#[derive(Encode, Decode, RuntimeDebug)]\npub struct AuctionInfo\u003cAccountId, Balance, BlockNumber\u003e {\n\t/// Current bidder and bid price.\n\tpub bid: Option\u003c(AccountId, Balance)\u003e,\n\t/// Define which block this auction will be started.\n\tpub start: BlockNumber,\n\t/// Define which block this auction will be ended.\n\tpub end: Option\u003cBlockNumber\u003e,\n}\n\n/// Abstraction over a simple auction system.\npub trait Auction\u003cAccountId, BlockNumber\u003e {\n\t/// The id of an AuctionInfo\n\ttype AuctionId: FullCodec + Default + Copy + Eq + PartialEq + MaybeSerializeDeserialize + Bounded + Debug;\n\t/// The price to bid.\n\ttype Balance: AtLeast32Bit + FullCodec + Copy + MaybeSerializeDeserialize + Debug + Default;\n\n\t/// The auction info of `id`\n\tfn auction_info(id: Self::AuctionId) -\u003e Option\u003cAuctionInfo\u003cAccountId, Self::Balance, BlockNumber\u003e\u003e;\n\t/// Update the auction info of `id` with `info`\n\tfn update_auction(id: Self::AuctionId, info: AuctionInfo\u003cAccountId, Self::Balance, BlockNumber\u003e) -\u003e DispatchResult;\n\t/// Create new auction with specific startblock and endblock, return the id\n\t/// of the auction\n\tfn new_auction(start: BlockNumber, end: Option\u003cBlockNumber\u003e) -\u003e result::Result\u003cSelf::AuctionId, DispatchError\u003e;\n\t/// Remove auction by `id`\n\tfn remove_auction(id: Self::AuctionId);\n}\n\n/// The result of bid handling.\npub struct OnNewBidResult\u003cBlockNumber\u003e {\n\t/// Indicates if the bid was accepted\n\tpub accept_bid: bool,\n\t/// The auction end change.\n\tpub auction_end_change: Change\u003cOption\u003cBlockNumber\u003e\u003e,\n}\n\n/// Hooks for auction to handle bids.\npub trait AuctionHandler\u003cAccountId, Balance, BlockNumber, AuctionId\u003e {\n\t/// Called when new bid is received.\n\t/// The return value determines if the bid should be accepted and update\n\t/// auction end time. Implementation should reserve money from current\n\t/// winner and refund previous winner.\n\tfn on_new_bid(\n\t\tnow: BlockNumber,\n\t\tid: AuctionId,\n\t\tnew_bid: (AccountId, Balance),\n\t\tlast_bid: Option\u003c(AccountId, Balance)\u003e,\n\t) -\u003e OnNewBidResult\u003cBlockNumber\u003e;\n\t/// End an auction with `winner`\n\tfn on_auction_ended(id: AuctionId, winner: Option\u003c(AccountId, Balance)\u003e);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","currency.rs"],"content":"use crate::arithmetic;\nuse codec::{Codec, FullCodec};\npub use frame_support::traits::{BalanceStatus, LockIdentifier};\nuse sp_runtime::{\n\ttraits::{AtLeast32BitUnsigned, MaybeSerializeDeserialize},\n\tDispatchError, DispatchResult,\n};\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tconvert::{TryFrom, TryInto},\n\tfmt::Debug,\n\tresult,\n};\n\n/// Abstraction over a fungible multi-currency system.\npub trait MultiCurrency\u003cAccountId\u003e {\n\t/// The currency identifier.\n\ttype CurrencyId: FullCodec + Eq + PartialEq + Copy + MaybeSerializeDeserialize + Debug;\n\n\t/// The balance of an account.\n\ttype Balance: AtLeast32BitUnsigned + FullCodec + Copy + MaybeSerializeDeserialize + Debug + Default;\n\n\t// Public immutables\n\n\t/// The total amount of issuance of `currency_id`.\n\tfn total_issuance(currency_id: Self::CurrencyId) -\u003e Self::Balance;\n\n\t// The combined balance of `who` under `currency_id`.\n\tfn total_balance(currency_id: Self::CurrencyId, who: \u0026AccountId) -\u003e Self::Balance;\n\n\t// The free balance of `who` under `currency_id`.\n\tfn free_balance(currency_id: Self::CurrencyId, who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// A dry-run of `withdraw`. Returns `Ok` iff the account is able to make a\n\t/// withdrawal of the given amount.\n\tfn ensure_can_withdraw(currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t// Public mutables\n\n\t/// Transfer some amount from one account to another.\n\tfn transfer(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tfrom: \u0026AccountId,\n\t\tto: \u0026AccountId,\n\t\tamount: Self::Balance,\n\t) -\u003e DispatchResult;\n\n\t/// Add `amount` to the balance of `who` under `currency_id` and increase\n\t/// total issuance.\n\tfn deposit(currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Remove `amount` from the balance of `who` under `currency_id` and reduce\n\t/// total issuance.\n\tfn withdraw(currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Same result as `slash(currency_id, who, value)` (but without the\n\t/// side-effects) assuming there are no balance changes in the meantime and\n\t/// only the reserved balance is not taken into account.\n\tfn can_slash(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e bool;\n\n\t/// Deduct the balance of `who` by up to `amount`.\n\t///\n\t/// As much funds up to `amount` will be deducted as possible.  If this is\n\t/// less than `amount`,then a non-zero value will be returned.\n\tfn slash(currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance) -\u003e Self::Balance;\n}\n\n/// Extended `MultiCurrency` with additional helper types and methods.\npub trait MultiCurrencyExtended\u003cAccountId\u003e: MultiCurrency\u003cAccountId\u003e {\n\t/// The type for balance related operations, typically signed int.\n\ttype Amount: arithmetic::Signed\n\t\t+ TryInto\u003cSelf::Balance\u003e\n\t\t+ TryFrom\u003cSelf::Balance\u003e\n\t\t+ arithmetic::SimpleArithmetic\n\t\t+ Codec\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ Default;\n\n\t/// Add or remove abs(`by_amount`) from the balance of `who` under\n\t/// `currency_id`. If positive `by_amount`, do add, else do remove.\n\tfn update_balance(currency_id: Self::CurrencyId, who: \u0026AccountId, by_amount: Self::Amount) -\u003e DispatchResult;\n}\n\n/// A fungible multi-currency system whose accounts can have liquidity\n/// restrictions.\npub trait MultiLockableCurrency\u003cAccountId\u003e: MultiCurrency\u003cAccountId\u003e {\n\t/// The quantity used to denote time; usually just a `BlockNumber`.\n\ttype Moment;\n\n\t/// Create a new balance lock on account `who`.\n\t///\n\t/// If the new lock is valid (i.e. not already expired), it will push the\n\t/// struct to the `Locks` vec in storage. Note that you can lock more funds\n\t/// than a user has.\n\t///\n\t/// If the lock `lock_id` already exists, this will update it.\n\tfn set_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance);\n\n\t/// Changes a balance lock (selected by `lock_id`) so that it becomes less\n\t/// liquid in all parameters or creates a new one if it does not exist.\n\t///\n\t/// Calling `extend_lock` on an existing lock `lock_id` differs from\n\t/// `set_lock` in that it applies the most severe constraints of the two,\n\t/// while `set_lock` replaces the lock with the new parameters. As in,\n\t/// `extend_lock` will set:\n\t/// - maximum `amount`\n\tfn extend_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance);\n\n\t/// Remove an existing lock.\n\tfn remove_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026AccountId);\n}\n\n/// A fungible multi-currency system where funds can be reserved from the user.\npub trait MultiReservableCurrency\u003cAccountId\u003e: MultiCurrency\u003cAccountId\u003e {\n\t/// Same result as `reserve(who, value)` (but without the side-effects)\n\t/// assuming there are no balance changes in the meantime.\n\tfn can_reserve(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e bool;\n\n\t/// Deducts up to `value` from reserved balance of `who`. This function\n\t/// cannot fail.\n\t///\n\t/// As much funds up to `value` will be deducted as possible. If the reserve\n\t/// balance of `who` is less than `value`, then a non-zero second item will\n\t/// be returned.\n\tfn slash_reserved(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance;\n\n\t/// The amount of the balance of a given account that is externally\n\t/// reserved; this can still get slashed, but gets slashed last of all.\n\t///\n\t/// This balance is a 'reserve' balance that other subsystems use in order\n\t/// to set aside tokens that are still 'owned' by the account holder, but\n\t/// which are suspendable.\n\tfn reserved_balance(currency_id: Self::CurrencyId, who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// Moves `value` from balance to reserved balance.\n\t///\n\t/// If the free balance is lower than `value`, then no funds will be moved\n\t/// and an `Err` will be returned to notify of this. This is different\n\t/// behavior than `unreserve`.\n\tfn reserve(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e DispatchResult;\n\n\t/// Moves up to `value` from reserved balance to free balance. This function\n\t/// cannot fail.\n\t///\n\t/// As much funds up to `value` will be moved as possible. If the reserve\n\t/// balance of `who` is less than `value`, then the remaining amount will be\n\t/// returned.\n\t///\n\t/// # NOTES\n\t///\n\t/// - This is different from `reserve`.\n\tfn unreserve(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance;\n\n\t/// Moves up to `value` from reserved balance of account `slashed` to\n\t/// balance of account `beneficiary`. `beneficiary` must exist for this to\n\t/// succeed. If it does not, `Err` will be returned. Funds will be placed in\n\t/// either the `free` balance or the `reserved` balance, depending on the\n\t/// `status`.\n\t///\n\t/// As much funds up to `value` will be deducted as possible. If this is\n\t/// less than `value`, then `Ok(non_zero)` will be returned.\n\tfn repatriate_reserved(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tslashed: \u0026AccountId,\n\t\tbeneficiary: \u0026AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e;\n}\n\n/// Abstraction over a fungible (single) currency system.\npub trait BasicCurrency\u003cAccountId\u003e {\n\t/// The balance of an account.\n\ttype Balance: AtLeast32BitUnsigned + FullCodec + Copy + MaybeSerializeDeserialize + Debug + Default;\n\n\t// Public immutables\n\n\t/// The total amount of issuance.\n\tfn total_issuance() -\u003e Self::Balance;\n\n\t/// The combined balance of `who`.\n\tfn total_balance(who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// The free balance of `who`.\n\tfn free_balance(who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// A dry-run of `withdraw`. Returns `Ok` iff the account is able to make a\n\t/// withdrawal of the given amount.\n\tfn ensure_can_withdraw(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t// Public mutables\n\n\t/// Transfer some amount from one account to another.\n\tfn transfer(from: \u0026AccountId, to: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Add `amount` to the balance of `who` and increase total issuance.\n\tfn deposit(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Remove `amount` from the balance of `who` and reduce total issuance.\n\tfn withdraw(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Same result as `slash(who, value)` (but without the side-effects)\n\t/// assuming there are no balance changes in the meantime and only the\n\t/// reserved balance is not taken into account.\n\tfn can_slash(who: \u0026AccountId, value: Self::Balance) -\u003e bool;\n\n\t/// Deduct the balance of `who` by up to `amount`.\n\t///\n\t/// As much funds up to `amount` will be deducted as possible. If this is\n\t/// less than `amount`,then a non-zero value will be returned.\n\tfn slash(who: \u0026AccountId, amount: Self::Balance) -\u003e Self::Balance;\n}\n\n/// Extended `BasicCurrency` with additional helper types and methods.\npub trait BasicCurrencyExtended\u003cAccountId\u003e: BasicCurrency\u003cAccountId\u003e {\n\t/// The signed type for balance related operations, typically signed int.\n\ttype Amount: arithmetic::Signed\n\t\t+ TryInto\u003cSelf::Balance\u003e\n\t\t+ TryFrom\u003cSelf::Balance\u003e\n\t\t+ arithmetic::SimpleArithmetic\n\t\t+ Codec\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ Default;\n\n\t/// Add or remove abs(`by_amount`) from the balance of `who`. If positive\n\t/// `by_amount`, do add, else do remove.\n\tfn update_balance(who: \u0026AccountId, by_amount: Self::Amount) -\u003e DispatchResult;\n}\n\n/// A fungible single currency system whose accounts can have liquidity\n/// restrictions.\npub trait BasicLockableCurrency\u003cAccountId\u003e: BasicCurrency\u003cAccountId\u003e {\n\t/// The quantity used to denote time; usually just a `BlockNumber`.\n\ttype Moment;\n\n\t/// Create a new balance lock on account `who`.\n\t///\n\t/// If the new lock is valid (i.e. not already expired), it will push the\n\t/// struct to the `Locks` vec in storage. Note that you can lock more funds\n\t/// than a user has.\n\t///\n\t/// If the lock `lock_id` already exists, this will update it.\n\tfn set_lock(lock_id: LockIdentifier, who: \u0026AccountId, amount: Self::Balance);\n\n\t/// Changes a balance lock (selected by `lock_id`) so that it becomes less\n\t/// liquid in all parameters or creates a new one if it does not exist.\n\t///\n\t/// Calling `extend_lock` on an existing lock `lock_id` differs from\n\t/// `set_lock` in that it applies the most severe constraints of the two,\n\t/// while `set_lock` replaces the lock with the new parameters. As in,\n\t/// `extend_lock` will set:\n\t/// - maximum `amount`\n\tfn extend_lock(lock_id: LockIdentifier, who: \u0026AccountId, amount: Self::Balance);\n\n\t/// Remove an existing lock.\n\tfn remove_lock(lock_id: LockIdentifier, who: \u0026AccountId);\n}\n\n/// A fungible single currency system where funds can be reserved from the user.\npub trait BasicReservableCurrency\u003cAccountId\u003e: BasicCurrency\u003cAccountId\u003e {\n\t/// Same result as `reserve(who, value)` (but without the side-effects)\n\t/// assuming there are no balance changes in the meantime.\n\tfn can_reserve(who: \u0026AccountId, value: Self::Balance) -\u003e bool;\n\n\t/// Deducts up to `value` from reserved balance of `who`. This function\n\t/// cannot fail.\n\t///\n\t/// As much funds up to `value` will be deducted as possible. If the reserve\n\t/// balance of `who` is less than `value`, then a non-zero second item will\n\t/// be returned.\n\tfn slash_reserved(who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance;\n\n\t/// The amount of the balance of a given account that is externally\n\t/// reserved; this can still get slashed, but gets slashed last of all.\n\t///\n\t/// This balance is a 'reserve' balance that other subsystems use in order\n\t/// to set aside tokens that are still 'owned' by the account holder, but\n\t/// which are suspendable.\n\tfn reserved_balance(who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// Moves `value` from balance to reserved balance.\n\t///\n\t/// If the free balance is lower than `value`, then no funds will be moved\n\t/// and an `Err` will be returned to notify of this. This is different\n\t/// behavior than `unreserve`.\n\tfn reserve(who: \u0026AccountId, value: Self::Balance) -\u003e DispatchResult;\n\n\t/// Moves up to `value` from reserved balance to free balance. This function\n\t/// cannot fail.\n\t///\n\t/// As much funds up to `value` will be moved as possible. If the reserve\n\t/// balance of `who` is less than `value`, then the remaining amount will be\n\t/// returned.\n\t///\n\t/// # NOTES\n\t///\n\t/// - This is different from `reserve`.\n\tfn unreserve(who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance;\n\n\t/// Moves up to `value` from reserved balance of account `slashed` to\n\t/// balance of account `beneficiary`. `beneficiary` must exist for this to\n\t/// succeed. If it does not, `Err` will be returned. Funds will be placed in\n\t/// either the `free` balance or the `reserved` balance, depending on the\n\t/// `status`.\n\t///\n\t/// As much funds up to `value` will be deducted as possible. If this is\n\t/// less than `value`, then `Ok(non_zero)` will be returned.\n\tfn repatriate_reserved(\n\t\tslashed: \u0026AccountId,\n\t\tbeneficiary: \u0026AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e;\n}\n\n/// Handler when an account received some assets\n#[impl_trait_for_tuples::impl_for_tuples(30)]\npub trait OnReceived\u003cAccountId, CurrencyId, Balance\u003e {\n\t/// An account have received some assets\n\tfn on_received(account: \u0026AccountId, currency: CurrencyId, amount: Balance);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","data_provider.rs"],"content":"use sp_runtime::DispatchResult;\nuse sp_std::vec::Vec;\n\n/// Data provider with ability to provide data with no-op, and provide all data.\npub trait DataFeeder\u003cKey, Value, AccountId\u003e: DataProvider\u003cKey, Value\u003e {\n\t/// Provide a new value for a given key from an operator\n\tfn feed_value(who: AccountId, key: Key, value: Value) -\u003e DispatchResult;\n}\n\n/// A simple trait to provide data\npub trait DataProvider\u003cKey, Value\u003e {\n\t/// Get data by key\n\tfn get(key: \u0026Key) -\u003e Option\u003cValue\u003e;\n}\n\n/// Extended data provider to provide timestamped data by key with no-op, and\n/// all data.\npub trait DataProviderExtended\u003cKey, TimestampedValue\u003e {\n\t/// Get timestamped value by key\n\tfn get_no_op(key: \u0026Key) -\u003e Option\u003cTimestampedValue\u003e;\n\t/// Provide a list of tuples of key and timestamped value\n\tfn get_all_values() -\u003e Vec\u003c(Key, Option\u003cTimestampedValue\u003e)\u003e;\n}\n\n#[allow(dead_code)] // rust cannot detect usage in macro_rules\npub fn median\u003cT: Ord + Clone\u003e(mut items: Vec\u003cT\u003e) -\u003e Option\u003cT\u003e {\n\tif items.is_empty() {\n\t\treturn None;\n\t}\n\n\tlet mid_index = items.len() / 2;\n\n\titems.sort();\n\n\t// Won't panic as guarded items not empty case.\n\tSome(items[mid_index as usize].clone())\n}\n\n#[macro_export]\nmacro_rules! create_median_value_data_provider {\n\t($name:ident, $key:ty, $value:ty, $timestamped_value:ty, [$( $provider:ty ),*]) =\u003e {\n\t\tpub struct $name;\n\t\timpl $crate::DataProvider\u003c$key, $value\u003e for $name {\n\t\t\tfn get(key: \u0026$key) -\u003e Option\u003c$value\u003e {\n\t\t\t\tlet mut values = vec![];\n\t\t\t\t$(\n\t\t\t\t\tif let Some(v) = \u003c$provider as $crate::DataProvider\u003c$key, $value\u003e\u003e::get(\u0026key) {\n\t\t\t\t\t\tvalues.push(v);\n\t\t\t\t\t}\n\t\t\t\t)*\n\t\t\t\t$crate::data_provider::median(values)\n\t\t\t}\n\t\t}\n\t\timpl $crate::DataProviderExtended\u003c$key, $timestamped_value\u003e for $name {\n\t\t\tfn get_no_op(key: \u0026$key) -\u003e Option\u003c$timestamped_value\u003e {\n\t\t\t\tlet mut values = vec![];\n\t\t\t\t$(\n\t\t\t\t\tif let Some(v) = \u003c$provider as $crate::DataProviderExtended\u003c$key, $timestamped_value\u003e\u003e::get_no_op(\u0026key) {\n\t\t\t\t\t\tvalues.push(v);\n\t\t\t\t\t}\n\t\t\t\t)*\n\t\t\t\t$crate::data_provider::median(values)\n\t\t\t}\n\t\t\tfn get_all_values() -\u003e Vec\u003c($key, Option\u003c$timestamped_value\u003e)\u003e {\n\t\t\t\tlet mut keys = sp_std::collections::btree_set::BTreeSet::new();\n\t\t\t\t$(\n\t\t\t\t\t\u003c$provider as $crate::DataProviderExtended\u003c$key, $timestamped_value\u003e\u003e::get_all_values()\n\t\t\t\t\t\t.into_iter()\n\t\t\t\t\t\t.for_each(|(k, _)| { keys.insert(k); });\n\t\t\t\t)*\n\t\t\t\tkeys.into_iter().map(|k| (k, Self::get_no_op(\u0026k))).collect()\n\t\t\t}\n\t\t}\n\t}\n}\n\n#[cfg(test)]\nmod tests {\n\tuse super::*;\n\tuse sp_std::cell::RefCell;\n\n\tthread_local! {\n\t\tstatic MOCK_PRICE_1: RefCell\u003cOption\u003cu8\u003e\u003e = RefCell::new(None);\n\t\tstatic MOCK_PRICE_2: RefCell\u003cOption\u003cu8\u003e\u003e = RefCell::new(None);\n\t\tstatic MOCK_PRICE_3: RefCell\u003cOption\u003cu8\u003e\u003e = RefCell::new(None);\n\t\tstatic MOCK_PRICE_4: RefCell\u003cOption\u003cu8\u003e\u003e = RefCell::new(None);\n\t}\n\n\tmacro_rules! mock_data_provider {\n\t\t($provider:ident, $price:ident) =\u003e {\n\t\t\tpub struct $provider;\n\t\t\timpl $provider {\n\t\t\t\tfn set_price(price: Option\u003cu8\u003e) {\n\t\t\t\t\t$price.with(|v| *v.borrow_mut() = price)\n\t\t\t\t}\n\t\t\t}\n\t\t\timpl DataProvider\u003cu8, u8\u003e for $provider {\n\t\t\t\tfn get(_: \u0026u8) -\u003e Option\u003cu8\u003e {\n\t\t\t\t\t$price.with(|v| *v.borrow())\n\t\t\t\t}\n\t\t\t}\n\t\t\timpl DataProviderExtended\u003cu8, u8\u003e for $provider {\n\t\t\t\tfn get_no_op(_: \u0026u8) -\u003e Option\u003cu8\u003e {\n\t\t\t\t\t$price.with(|v| *v.borrow())\n\t\t\t\t}\n\t\t\t\tfn get_all_values() -\u003e Vec\u003c(u8, Option\u003cu8\u003e)\u003e {\n\t\t\t\t\tvec![(0, Self::get_no_op(\u00260))]\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n\n\tmock_data_provider!(Provider1, MOCK_PRICE_1);\n\tmock_data_provider!(Provider2, MOCK_PRICE_2);\n\tmock_data_provider!(Provider3, MOCK_PRICE_3);\n\tmock_data_provider!(Provider4, MOCK_PRICE_4);\n\n\tcreate_median_value_data_provider!(Providers, u8, u8, u8, [Provider1, Provider2, Provider3, Provider4]);\n\n\t#[test]\n\tfn median_value_data_provider_works() {\n\t\tassert_eq!(\u003cProviders as DataProvider\u003c_, _\u003e\u003e::get(\u00260), None);\n\n\t\tlet data = vec![\n\t\t\t(vec![None, None, None, Some(1)], Some(1)),\n\t\t\t(vec![None, None, Some(2), Some(1)], Some(2)),\n\t\t\t(vec![Some(5), Some(2), None, Some(7)], Some(5)),\n\t\t\t(vec![Some(5), Some(13), Some(2), Some(7)], Some(7)),\n\t\t];\n\n\t\tfor (values, target) in data {\n\t\t\tProvider1::set_price(values[0]);\n\t\t\tProvider2::set_price(values[1]);\n\t\t\tProvider3::set_price(values[2]);\n\t\t\tProvider4::set_price(values[3]);\n\n\t\t\tassert_eq!(\u003cProviders as DataProvider\u003c_, _\u003e\u003e::get(\u00260), target);\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","get_by_key.rs"],"content":"/// A trait for querying a value by a key.\npub trait GetByKey\u003cKey, Value\u003e {\n\t/// Return the value.\n\tfn get(k: \u0026Key) -\u003e Value;\n}\n\n/// Create new implementations of the `GetByKey` trait.\n///\n/// The implementation is typically used like a map or set.\n///\n/// Example:\n/// ```ignore\n/// use primitives::CurrencyId;\n/// parameter_type_with_key! {\n///     pub Rates: |currency_id: CurrencyId| -\u003e u32 {\n///         match currency_id {\n///             CurrencyId::DOT =\u003e 1,\n///             CurrencyId::KSM =\u003e 2,\n///             _ =\u003e 3,\n///         }\n///     }\n/// }\n/// ```\n#[macro_export]\nmacro_rules! parameter_type_with_key {\n\t(\n\t\tpub $name:ident: |$k:ident: $key:ty| -\u003e $value:ty $body:block;\n\t) =\u003e {\n\t\tpub struct $name;\n\t\timpl $crate::get_by_key::GetByKey\u003c$key, $value\u003e for $name {\n\t\t\tfn get($k: \u0026$key) -\u003e $value {\n\t\t\t\t$body\n\t\t\t}\n\t\t}\n\t};\n}\n\n#[cfg(test)]\nmod tests {\n\tuse super::*;\n\n\tparameter_type_with_key! {\n\t\tpub Test: |k: u32| -\u003e u32 {\n\t\t\tmatch k {\n\t\t\t\t1 =\u003e 1,\n\t\t\t\t_ =\u003e 2,\n\t\t\t}\n\t\t};\n\t}\n\n\t#[test]\n\tfn get_by_key_should_work() {\n\t\tassert_eq!(Test::get(\u00261), 1);\n\t\tassert_eq!(Test::get(\u00262), 2);\n\t\tassert_eq!(Test::get(\u00263), 2);\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse sp_runtime::RuntimeDebug;\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tprelude::Vec,\n};\n\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\n\npub use auction::{Auction, AuctionHandler, AuctionInfo, OnNewBidResult};\npub use currency::{\n\tBalanceStatus, BasicCurrency, BasicCurrencyExtended, BasicLockableCurrency, BasicReservableCurrency,\n\tLockIdentifier, MultiCurrency, MultiCurrencyExtended, MultiLockableCurrency, MultiReservableCurrency, OnReceived,\n};\npub use data_provider::{DataFeeder, DataProvider, DataProviderExtended};\npub use get_by_key::GetByKey;\npub use price::{DefaultPriceProvider, PriceProvider};\npub use rewards::RewardHandler;\n\npub mod arithmetic;\npub mod auction;\npub mod currency;\npub mod data_provider;\npub mod get_by_key;\npub mod price;\npub mod rewards;\n\n/// New data handler\n#[impl_trait_for_tuples::impl_for_tuples(30)]\npub trait OnNewData\u003cAccountId, Key, Value\u003e {\n\t/// New data is available\n\tfn on_new_data(who: \u0026AccountId, key: \u0026Key, value: \u0026Value);\n}\n\n/// Combine data provided by operators\npub trait CombineData\u003cKey, TimestampedValue\u003e {\n\t/// Combine data provided by operators\n\tfn combine_data(\n\t\tkey: \u0026Key,\n\t\tvalues: Vec\u003cTimestampedValue\u003e,\n\t\tprev_value: Option\u003cTimestampedValue\u003e,\n\t) -\u003e Option\u003cTimestampedValue\u003e;\n}\n\n/// Indicate if should change a value\n#[derive(Encode, Decode, Clone, Eq, PartialEq, RuntimeDebug)]\npub enum Change\u003cValue\u003e {\n\t/// No change.\n\tNoChange,\n\t/// Changed to new value.\n\tNewValue(Value),\n}\n\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Ord, PartialOrd, Clone, Copy)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub struct TimestampedValue\u003cValue: Ord + PartialOrd, Moment\u003e {\n\tpub value: Value,\n\tpub timestamp: Moment,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","price.rs"],"content":"use crate::DataProvider;\nuse frame_support::Parameter;\nuse sp_runtime::traits::{CheckedDiv, MaybeSerializeDeserialize, Member};\nuse sp_std::marker::PhantomData;\n\n/// A trait to provide relative price for two currencies\npub trait PriceProvider\u003cCurrencyId, Price\u003e {\n\tfn get_price(base: CurrencyId, quote: CurrencyId) -\u003e Option\u003cPrice\u003e;\n}\n\n/// A `PriceProvider` implementation based on price data from a `DataProvider`\npub struct DefaultPriceProvider\u003cCurrencyId, Source\u003e(PhantomData\u003c(CurrencyId, Source)\u003e);\n\nimpl\u003cCurrencyId, Source, Price\u003e PriceProvider\u003cCurrencyId, Price\u003e for DefaultPriceProvider\u003cCurrencyId, Source\u003e\nwhere\n\tCurrencyId: Parameter + Member + Copy + MaybeSerializeDeserialize,\n\tSource: DataProvider\u003cCurrencyId, Price\u003e,\n\tPrice: CheckedDiv,\n{\n\tfn get_price(base_currency_id: CurrencyId, quote_currency_id: CurrencyId) -\u003e Option\u003cPrice\u003e {\n\t\tlet base_price = Source::get(\u0026base_currency_id)?;\n\t\tlet quote_price = Source::get(\u0026quote_currency_id)?;\n\n\t\tbase_price.checked_div(\u0026quote_price)\n\t}\n}\n\n#[cfg(test)]\nmod test {\n\tuse super::*;\n\tuse sp_runtime::{FixedPointNumber, FixedU128};\n\n\ttype Price = FixedU128;\n\n\tpub struct MockDataProvider;\n\timpl DataProvider\u003cu32, Price\u003e for MockDataProvider {\n\t\tfn get(currency: \u0026u32) -\u003e Option\u003cPrice\u003e {\n\t\t\tmatch currency {\n\t\t\t\t0 =\u003e Some(Price::from_inner(0)),\n\t\t\t\t1 =\u003e Some(Price::from_inner(1)),\n\t\t\t\t2 =\u003e Some(Price::from_inner(2)),\n\t\t\t\t_ =\u003e None,\n\t\t\t}\n\t\t}\n\t}\n\n\ttype TestPriceProvider = DefaultPriceProvider\u003cu32, MockDataProvider\u003e;\n\n\t#[test]\n\tfn get_price_should_work() {\n\t\tassert_eq!(\n\t\t\tTestPriceProvider::get_price(1, 2),\n\t\t\tSome(Price::saturating_from_rational(1, 2))\n\t\t);\n\t\tassert_eq!(\n\t\t\tTestPriceProvider::get_price(2, 1),\n\t\t\tSome(Price::saturating_from_rational(2, 1))\n\t\t);\n\t}\n\n\t#[test]\n\tfn price_is_none_should_not_panic() {\n\t\tassert_eq!(TestPriceProvider::get_price(3, 3), None);\n\t\tassert_eq!(TestPriceProvider::get_price(3, 1), None);\n\t\tassert_eq!(TestPriceProvider::get_price(1, 3), None);\n\t}\n\n\t#[test]\n\tfn price_is_zero_should_not_panic() {\n\t\tassert_eq!(TestPriceProvider::get_price(0, 0), None);\n\t\tassert_eq!(TestPriceProvider::get_price(1, 0), None);\n\t\tassert_eq!(TestPriceProvider::get_price(0, 1), Some(Price::from_inner(0)));\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","rewards.rs"],"content":"use codec::FullCodec;\nuse sp_runtime::traits::{AtLeast32BitUnsigned, MaybeSerializeDeserialize};\nuse sp_std::{fmt::Debug, vec::Vec};\n\n/// Hooks to manage reward pool\npub trait RewardHandler\u003cAccountId, BlockNumber\u003e {\n\t/// The share type of pool\n\ttype Share: AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize + Debug;\n\n\t/// The reward balance type\n\ttype Balance: AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize + Debug;\n\n\t/// The reward pool ID type\n\ttype PoolId: Copy + FullCodec;\n\n\t/// The currency type\n\ttype CurrencyId: FullCodec + Eq + PartialEq + Copy + MaybeSerializeDeserialize + Debug;\n\n\t/// Accumulate rewards\n\tfn accumulate_reward(\n\t\tnow: BlockNumber,\n\t\tcallback: impl FnMut(Self::PoolId, Self::Balance),\n\t) -\u003e Vec\u003c(Self::CurrencyId, Self::Balance)\u003e;\n\n\t/// Payout the reward to `who`\n\tfn payout(who: \u0026AccountId, pool: Self::PoolId, amount: Self::Balance);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","utilities","src","iterator.rs"],"content":"use codec::{Decode, EncodeLike, FullCodec, FullEncode};\nuse frame_support::{\n\tstorage::{\n\t\tgenerator::{StorageDoubleMap as StorageDoubleMapT, StorageMap as StorageMapT},\n\t\tunhashed, StorageDoubleMap, StorageMap,\n\t},\n\tReversibleStorageHasher,\n};\nuse sp_std::prelude::*;\n\n/// Utility to iterate through items in a storage map.\n/// Forks from substrate, expose previous_key field\npub struct StorageMapIterator\u003cK, V, Hasher\u003e {\n\tprefix: Vec\u003cu8\u003e,\n\tpub previous_key: Vec\u003cu8\u003e,\n\tdrain: bool,\n\t_phantom: sp_std::marker::PhantomData\u003c(K, V, Hasher)\u003e,\n}\n\n/// Forks from substrate\nimpl\u003cK: Decode + Sized, V: Decode + Sized, Hasher: ReversibleStorageHasher\u003e Iterator\n\tfor StorageMapIterator\u003cK, V, Hasher\u003e\n{\n\ttype Item = (K, V);\n\n\tfn next(\u0026mut self) -\u003e Option\u003c(K, V)\u003e {\n\t\tloop {\n\t\t\tlet maybe_next = sp_io::storage::next_key(\u0026self.previous_key).filter(|n| n.starts_with(\u0026self.prefix));\n\t\t\tbreak match maybe_next {\n\t\t\t\tSome(next) =\u003e {\n\t\t\t\t\tself.previous_key = next;\n\t\t\t\t\tmatch unhashed::get::\u003cV\u003e(\u0026self.previous_key) {\n\t\t\t\t\t\tSome(value) =\u003e {\n\t\t\t\t\t\t\tif self.drain {\n\t\t\t\t\t\t\t\tunhashed::kill(\u0026self.previous_key)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tlet mut key_material = Hasher::reverse(\u0026self.previous_key[self.prefix.len()..]);\n\t\t\t\t\t\t\tmatch K::decode(\u0026mut key_material) {\n\t\t\t\t\t\t\t\tOk(key) =\u003e Some((key, value)),\n\t\t\t\t\t\t\t\tErr(_) =\u003e continue,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tNone =\u003e continue,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tNone =\u003e None,\n\t\t\t};\n\t\t}\n\t}\n}\n\n/// Shim for StorageMapIterator, add more features\npub struct StorageMapIteratorShim\u003cK, V, H\u003e {\n\tpub storage_map_iterator: StorageMapIterator\u003cK, V, H\u003e,\n\tpub remain_iterator_count: Option\u003cu32\u003e,\n\tpub finished: bool,\n}\n\nimpl\u003cK: Decode + Sized, V: Decode + Sized, H: ReversibleStorageHasher\u003e Iterator for StorageMapIteratorShim\u003cK, V, H\u003e {\n\ttype Item = \u003cStorageMapIterator\u003cK, V, H\u003e as Iterator\u003e::Item;\n\n\tfn next(\u0026mut self) -\u003e Option\u003cSelf::Item\u003e {\n\t\t// check accumulated iteration count\n\t\tif let Some(remain_iterator_count) = self.remain_iterator_count {\n\t\t\tif remain_iterator_count == 0 {\n\t\t\t\treturn None;\n\t\t\t} else {\n\t\t\t\tself.remain_iterator_count = Some(remain_iterator_count - 1);\n\t\t\t}\n\t\t}\n\n\t\tself.storage_map_iterator.next().or_else(|| {\n\t\t\t// mark this map iterator has already finished\n\t\t\tself.finished = true;\n\t\t\tNone\n\t\t})\n\t}\n}\n\n/// A strongly-typed map in storage whose keys and values can be iterated over.\npub trait IterableStorageMapExtended\u003cK: FullEncode, V: FullCodec\u003e: StorageMap\u003cK, V\u003e {\n\t/// The type that iterates over all `(key, value)`.\n\ttype Iterator: Iterator\u003cItem = (K, V)\u003e;\n\n\t/// Enumerate all elements in the map in no particular order. If you alter\n\t/// the map while doing this, you'll get undefined results.\n\tfn iter(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator;\n\n\t/// Remove all elements from the map and iterate through them in no\n\t/// particular order. If you add elements to the map while doing this,\n\t/// you'll get undefined results.\n\tfn drain(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator;\n}\n\nimpl\u003cK: FullCodec, V: FullCodec, G: StorageMapT\u003cK, V\u003e\u003e IterableStorageMapExtended\u003cK, V\u003e for G\nwhere\n\tG::Hasher: ReversibleStorageHasher,\n{\n\ttype Iterator = StorageMapIteratorShim\u003cK, V, G::Hasher\u003e;\n\n\t/// Enumerate all elements in the map.\n\tfn iter(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator {\n\t\tlet prefix = G::prefix_hash();\n\t\tlet previous_key = start_key\n\t\t\t.filter(|k| k.starts_with(\u0026prefix))\n\t\t\t.unwrap_or_else(|| prefix.clone());\n\t\tlet storage_map_iterator = StorageMapIterator {\n\t\t\tprefix,\n\t\t\tprevious_key,\n\t\t\tdrain: false,\n\t\t\t_phantom: Default::default(),\n\t\t};\n\n\t\tStorageMapIteratorShim {\n\t\t\tstorage_map_iterator,\n\t\t\tremain_iterator_count: max_iterations,\n\t\t\tfinished: false,\n\t\t}\n\t}\n\n\t/// Enumerate all elements in the map.\n\tfn drain(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator {\n\t\tlet prefix = G::prefix_hash();\n\n\t\tlet previous_key = start_key\n\t\t\t.filter(|k| k.starts_with(\u0026prefix))\n\t\t\t.unwrap_or_else(|| prefix.clone());\n\t\tlet storage_map_iterator = StorageMapIterator {\n\t\t\tprefix,\n\t\t\tprevious_key,\n\t\t\tdrain: true,\n\t\t\t_phantom: Default::default(),\n\t\t};\n\n\t\tStorageMapIteratorShim {\n\t\t\tstorage_map_iterator,\n\t\t\tremain_iterator_count: max_iterations,\n\t\t\tfinished: false,\n\t\t}\n\t}\n}\n\n/// Iterate over a prefix and decode raw_key and raw_value into `T`.\n/// Forks from substrate, expose previous_key field\npub struct MapIterator\u003cT\u003e {\n\tprefix: Vec\u003cu8\u003e,\n\tpub previous_key: Vec\u003cu8\u003e,\n\t/// If true then value are removed while iterating\n\tdrain: bool,\n\t/// Function that take `(raw_key_without_prefix, raw_value)` and decode `T`.\n\t/// `raw_key_without_prefix` is the raw storage key without the prefix\n\t/// iterated on.\n\tclosure: fn(\u0026[u8], \u0026[u8]) -\u003e Result\u003cT, codec::Error\u003e,\n}\n\n/// Forks from substrate\nimpl\u003cT\u003e Iterator for MapIterator\u003cT\u003e {\n\ttype Item = T;\n\n\tfn next(\u0026mut self) -\u003e Option\u003cSelf::Item\u003e {\n\t\tloop {\n\t\t\tlet maybe_next = sp_io::storage::next_key(\u0026self.previous_key).filter(|n| n.starts_with(\u0026self.prefix));\n\t\t\tbreak match maybe_next {\n\t\t\t\tSome(next) =\u003e {\n\t\t\t\t\tself.previous_key = next;\n\t\t\t\t\tlet raw_value = match unhashed::get_raw(\u0026self.previous_key) {\n\t\t\t\t\t\tSome(raw_value) =\u003e raw_value,\n\t\t\t\t\t\tNone =\u003e {\n\t\t\t\t\t\t\tframe_support::print(\"ERROR: next_key returned a key with no value in MapIterator\");\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tif self.drain {\n\t\t\t\t\t\tunhashed::kill(\u0026self.previous_key)\n\t\t\t\t\t}\n\t\t\t\t\tlet raw_key_without_prefix = \u0026self.previous_key[self.prefix.len()..];\n\t\t\t\t\tlet item = match (self.closure)(raw_key_without_prefix, \u0026raw_value[..]) {\n\t\t\t\t\t\tOk(item) =\u003e item,\n\t\t\t\t\t\tErr(_e) =\u003e {\n\t\t\t\t\t\t\tframe_support::print(\"ERROR: (key, value) failed to decode in MapIterator\");\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\tSome(item)\n\t\t\t\t}\n\t\t\t\tNone =\u003e None,\n\t\t\t};\n\t\t}\n\t}\n}\n\n/// Shim for MapIterator, add more features\npub struct MapIteratorShim\u003cT\u003e {\n\tpub map_iterator: MapIterator\u003cT\u003e,\n\tpub remain_iterator_count: Option\u003cu32\u003e,\n\tpub finished: bool,\n}\n\nimpl\u003cT\u003e Iterator for MapIteratorShim\u003cT\u003e {\n\ttype Item = \u003cMapIterator\u003cT\u003e as Iterator\u003e::Item;\n\n\tfn next(\u0026mut self) -\u003e Option\u003cSelf::Item\u003e {\n\t\t// check accumulated iteration count\n\t\tif let Some(remain_iterator_count) = self.remain_iterator_count {\n\t\t\tif remain_iterator_count == 0 {\n\t\t\t\treturn None;\n\t\t\t} else {\n\t\t\t\tself.remain_iterator_count = Some(remain_iterator_count - 1);\n\t\t\t}\n\t\t}\n\n\t\tself.map_iterator.next().or_else(|| {\n\t\t\t// mark this map iterator has already finished\n\t\t\tself.finished = true;\n\t\t\tNone\n\t\t})\n\t}\n}\n\n/// A strongly-typed map in storage whose keys and values can be iterated over.\npub trait IterableStorageDoubleMapExtended\u003cK1: FullCodec, K2: FullCodec, V: FullCodec\u003e:\n\tStorageDoubleMap\u003cK1, K2, V\u003e\n{\n\t/// The type that iterates over all `(key2, value)`.\n\ttype PrefixIterator: Iterator\u003cItem = (K2, V)\u003e;\n\n\t/// The type that iterates over all `(key1, key2, value)`.\n\ttype Iterator: Iterator\u003cItem = (K1, K2, V)\u003e;\n\n\t/// Enumerate all elements in the map with first key `k1` in no particular\n\t/// order. If you add or remove values whose first key is `k1` to the map\n\t/// while doing this, you'll get undefined results.\n\tfn iter_prefix(\n\t\tk1: impl EncodeLike\u003cK1\u003e,\n\t\tmax_iterations: Option\u003cu32\u003e,\n\t\tstart_key: Option\u003cVec\u003cu8\u003e\u003e,\n\t) -\u003e Self::PrefixIterator;\n\n\t/// Remove all elements from the map with first key `k1` and iterate through\n\t/// them in no particular order. If you add elements with first key `k1` to\n\t/// the map while doing this, you'll get undefined results.\n\tfn drain_prefix(\n\t\tk1: impl EncodeLike\u003cK1\u003e,\n\t\tmax_iterations: Option\u003cu32\u003e,\n\t\tstart_key: Option\u003cVec\u003cu8\u003e\u003e,\n\t) -\u003e Self::PrefixIterator;\n\n\t/// Enumerate all elements in the map in no particular order. If you add or\n\t/// remove values to the map while doing this, you'll get undefined results.\n\tfn iter(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator;\n\n\t/// Remove all elements from the map and iterate through them in no\n\t/// particular order. If you add elements to the map while doing this,\n\t/// you'll get undefined results.\n\tfn drain(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator;\n}\n\nimpl\u003cK1: FullCodec, K2: FullCodec, V: FullCodec, G: StorageDoubleMapT\u003cK1, K2, V\u003e\u003e\n\tIterableStorageDoubleMapExtended\u003cK1, K2, V\u003e for G\nwhere\n\tG::Hasher1: ReversibleStorageHasher,\n\tG::Hasher2: ReversibleStorageHasher,\n{\n\ttype PrefixIterator = MapIteratorShim\u003c(K2, V)\u003e;\n\ttype Iterator = MapIteratorShim\u003c(K1, K2, V)\u003e;\n\n\tfn iter_prefix(\n\t\tk1: impl EncodeLike\u003cK1\u003e,\n\t\tmax_iterations: Option\u003cu32\u003e,\n\t\tstart_key: Option\u003cVec\u003cu8\u003e\u003e,\n\t) -\u003e Self::PrefixIterator {\n\t\tlet prefix = G::storage_double_map_final_key1(k1);\n\t\tlet previous_key = start_key\n\t\t\t.filter(|k| k.starts_with(\u0026prefix))\n\t\t\t.unwrap_or_else(|| prefix.clone());\n\n\t\tlet map_iterator = MapIterator {\n\t\t\tprefix,\n\t\t\tprevious_key,\n\t\t\tdrain: false,\n\t\t\tclosure: |raw_key_without_prefix, mut raw_value| {\n\t\t\t\tlet mut key_material = G::Hasher2::reverse(raw_key_without_prefix);\n\t\t\t\tOk((K2::decode(\u0026mut key_material)?, V::decode(\u0026mut raw_value)?))\n\t\t\t},\n\t\t};\n\n\t\tMapIteratorShim {\n\t\t\tmap_iterator,\n\t\t\tremain_iterator_count: max_iterations,\n\t\t\tfinished: false,\n\t\t}\n\t}\n\n\tfn drain_prefix(\n\t\tk1: impl EncodeLike\u003cK1\u003e,\n\t\tmax_iterations: Option\u003cu32\u003e,\n\t\tstart_key: Option\u003cVec\u003cu8\u003e\u003e,\n\t) -\u003e Self::PrefixIterator {\n\t\tlet mut shim = Self::iter_prefix(k1, max_iterations, start_key);\n\t\tshim.map_iterator.drain = true;\n\t\tshim\n\t}\n\n\tfn iter(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator {\n\t\tlet prefix = G::prefix_hash();\n\t\tlet previous_key = start_key\n\t\t\t.filter(|k| k.starts_with(\u0026prefix))\n\t\t\t.unwrap_or_else(|| prefix.clone());\n\n\t\tlet map_iterator = MapIterator {\n\t\t\tprefix,\n\t\t\tprevious_key,\n\t\t\tdrain: false,\n\t\t\tclosure: |raw_key_without_prefix, mut raw_value| {\n\t\t\t\tlet mut k1_k2_material = G::Hasher1::reverse(raw_key_without_prefix);\n\t\t\t\tlet k1 = K1::decode(\u0026mut k1_k2_material)?;\n\t\t\t\tlet mut k2_material = G::Hasher2::reverse(k1_k2_material);\n\t\t\t\tlet k2 = K2::decode(\u0026mut k2_material)?;\n\t\t\t\tOk((k1, k2, V::decode(\u0026mut raw_value)?))\n\t\t\t},\n\t\t};\n\n\t\tMapIteratorShim {\n\t\t\tmap_iterator,\n\t\t\tremain_iterator_count: max_iterations,\n\t\t\tfinished: false,\n\t\t}\n\t}\n\n\tfn drain(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator {\n\t\tlet mut shim = Self::iter(max_iterations, start_key);\n\t\tshim.map_iterator.drain = true;\n\t\tshim\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","utilities","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::storage::{with_transaction, TransactionOutcome};\nuse sp_runtime::DispatchError;\nuse sp_std::result::Result;\n\npub mod iterator;\npub mod offchain_worker;\npub mod ordered_set;\n\npub use iterator::{IterableStorageDoubleMapExtended, IterableStorageMapExtended};\npub use offchain_worker::OffchainErr;\npub use ordered_set::OrderedSet;\n\n/// Execute the supplied function in a new storage transaction.\n///\n/// All changes to storage performed by the supplied function are discarded if\n/// the returned outcome is `Result::Err`.\n///\n/// Transactions can be nested to any depth. Commits happen to the parent\n/// transaction.\npub fn with_transaction_result\u003cR\u003e(f: impl FnOnce() -\u003e Result\u003cR, DispatchError\u003e) -\u003e Result\u003cR, DispatchError\u003e {\n\twith_transaction(|| {\n\t\tlet res = f();\n\t\tif res.is_ok() {\n\t\t\tTransactionOutcome::Commit(res)\n\t\t} else {\n\t\t\tTransactionOutcome::Rollback(res)\n\t\t}\n\t})\n}\n\n#[cfg(test)]\nmod tests {\n\tuse super::*;\n\tuse frame_support::{assert_noop, assert_ok, decl_module, decl_storage};\n\tuse sp_io::TestExternalities;\n\tuse sp_runtime::{DispatchError, DispatchResult};\n\n\tpub trait Trait: frame_system::Trait {}\n\n\tdecl_module! {\n\t\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {}\n\t}\n\n\tdecl_storage! {\n\t\ttrait Store for Module\u003cT: Trait\u003e as StorageTransactions {\n\t\t\tpub Value: u32;\n\t\t\tpub Map: map hasher(twox_64_concat) String =\u003e u32;\n\t\t}\n\t}\n\n\t#[test]\n\tfn storage_transaction_basic_commit() {\n\t\tTestExternalities::default().execute_with(|| {\n\t\t\tassert_eq!(Value::get(), 0);\n\t\t\tassert!(!Map::contains_key(\"val0\"));\n\n\t\t\tassert_ok!(with_transaction_result(|| -\u003e DispatchResult {\n\t\t\t\tValue::set(99);\n\t\t\t\tMap::insert(\"val0\", 99);\n\t\t\t\tassert_eq!(Value::get(), 99);\n\t\t\t\tassert_eq!(Map::get(\"val0\"), 99);\n\t\t\t\tOk(())\n\t\t\t}));\n\n\t\t\tassert_eq!(Value::get(), 99);\n\t\t\tassert_eq!(Map::get(\"val0\"), 99);\n\t\t});\n\t}\n\n\t#[test]\n\tfn storage_transaction_basic_rollback() {\n\t\tTestExternalities::default().execute_with(|| {\n\t\t\tassert_eq!(Value::get(), 0);\n\t\t\tassert_eq!(Map::get(\"val0\"), 0);\n\n\t\t\tassert_noop!(\n\t\t\t\twith_transaction_result(|| -\u003e DispatchResult {\n\t\t\t\t\tValue::set(99);\n\t\t\t\t\tMap::insert(\"val0\", 99);\n\t\t\t\t\tassert_eq!(Value::get(), 99);\n\t\t\t\t\tassert_eq!(Map::get(\"val0\"), 99);\n\t\t\t\t\tErr(\"test\".into())\n\t\t\t\t}),\n\t\t\t\tDispatchError::Other(\"test\")\n\t\t\t);\n\n\t\t\tassert_eq!(Value::get(), 0);\n\t\t\tassert_eq!(Map::get(\"val0\"), 0);\n\t\t});\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","utilities","src","offchain_worker","mod.rs"],"content":"/// Error which may occur while executing the off-chain code.\n#[derive(PartialEq)]\npub enum OffchainErr {\n\tOffchainStore,\n\tSubmitTransaction,\n\tNotValidator,\n\tOffchainLock,\n}\n\nimpl sp_std::fmt::Debug for OffchainErr {\n\tfn fmt(\u0026self, fmt: \u0026mut sp_std::fmt::Formatter) -\u003e sp_std::fmt::Result {\n\t\tmatch *self {\n\t\t\tOffchainErr::OffchainStore =\u003e write!(fmt, \"Failed to manipulate offchain store\"),\n\t\t\tOffchainErr::SubmitTransaction =\u003e write!(fmt, \"Failed to submit transaction\"),\n\t\t\tOffchainErr::NotValidator =\u003e write!(fmt, \"Is not validator\"),\n\t\t\tOffchainErr::OffchainLock =\u003e write!(fmt, \"Failed to manipulate offchain lock\"),\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","utilities","src","ordered_set.rs"],"content":"use codec::{Decode, Encode};\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::RuntimeDebug;\nuse sp_std::prelude::*;\n\n/// An ordered set backed by `Vec`\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(RuntimeDebug, PartialEq, Eq, Encode, Decode, Default)]\npub struct OrderedSet\u003cT\u003e(pub Vec\u003cT\u003e);\n\nimpl\u003cT: Ord\u003e OrderedSet\u003cT\u003e {\n\t/// Create a new empty set\n\tpub fn new() -\u003e Self {\n\t\tSelf(Vec::new())\n\t}\n\n\t/// Create a set from a `Vec`.\n\t/// `v` will be sorted and dedup first.\n\tpub fn from(mut v: Vec\u003cT\u003e) -\u003e Self {\n\t\tv.sort();\n\t\tv.dedup();\n\t\tSelf::from_sorted_set(v)\n\t}\n\n\t/// Create a set from a `Vec`.\n\t/// Assume `v` is sorted and contain unique elements.\n\tpub fn from_sorted_set(v: Vec\u003cT\u003e) -\u003e Self {\n\t\tSelf(v)\n\t}\n\n\t/// Insert an element.\n\t/// Return true if insertion happened.\n\tpub fn insert(\u0026mut self, value: T) -\u003e bool {\n\t\tmatch self.0.binary_search(\u0026value) {\n\t\t\tOk(_) =\u003e false,\n\t\t\tErr(loc) =\u003e {\n\t\t\t\tself.0.insert(loc, value);\n\t\t\t\ttrue\n\t\t\t}\n\t\t}\n\t}\n\n\t/// Remove an element.\n\t/// Return true if removal happened.\n\tpub fn remove(\u0026mut self, value: \u0026T) -\u003e bool {\n\t\tmatch self.0.binary_search(\u0026value) {\n\t\t\tOk(loc) =\u003e {\n\t\t\t\tself.0.remove(loc);\n\t\t\t\ttrue\n\t\t\t}\n\t\t\tErr(_) =\u003e false,\n\t\t}\n\t}\n\n\t/// Return if the set contains `value`\n\tpub fn contains(\u0026self, value: \u0026T) -\u003e bool {\n\t\tself.0.binary_search(\u0026value).is_ok()\n\t}\n\n\t/// Clear the set\n\tpub fn clear(\u0026mut self) {\n\t\tself.0.clear();\n\t}\n}\n\nimpl\u003cT: Ord\u003e From\u003cVec\u003cT\u003e\u003e for OrderedSet\u003cT\u003e {\n\tfn from(v: Vec\u003cT\u003e) -\u003e Self {\n\t\tSelf::from(v)\n\t}\n}\n\n#[cfg(test)]\nmod tests {\n\tuse super::*;\n\n\t#[test]\n\tfn from() {\n\t\tlet v = vec![4, 2, 3, 4, 3, 1];\n\t\tlet set: OrderedSet\u003ci32\u003e = v.into();\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 2, 3, 4]));\n\t}\n\n\t#[test]\n\tfn insert() {\n\t\tlet mut set: OrderedSet\u003ci32\u003e = OrderedSet::new();\n\t\tassert_eq!(set, OrderedSet::from(vec![]));\n\n\t\tassert_eq!(set.insert(1), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![1]));\n\n\t\tassert_eq!(set.insert(5), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 5]));\n\n\t\tassert_eq!(set.insert(3), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 3, 5]));\n\n\t\tassert_eq!(set.insert(3), false);\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 3, 5]));\n\t}\n\n\t#[test]\n\tfn remove() {\n\t\tlet mut set: OrderedSet\u003ci32\u003e = OrderedSet::from(vec![1, 2, 3, 4]);\n\n\t\tassert_eq!(set.remove(\u00265), false);\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 2, 3, 4]));\n\n\t\tassert_eq!(set.remove(\u00261), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![2, 3, 4]));\n\n\t\tassert_eq!(set.remove(\u00263), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![2, 4]));\n\n\t\tassert_eq!(set.remove(\u00263), false);\n\t\tassert_eq!(set, OrderedSet::from(vec![2, 4]));\n\n\t\tassert_eq!(set.remove(\u00264), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![2]));\n\n\t\tassert_eq!(set.remove(\u00262), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![]));\n\n\t\tassert_eq!(set.remove(\u00262), false);\n\t\tassert_eq!(set, OrderedSet::from(vec![]));\n\t}\n\n\t#[test]\n\tfn contains() {\n\t\tlet set: OrderedSet\u003ci32\u003e = OrderedSet::from(vec![1, 2, 3, 4]);\n\n\t\tassert_eq!(set.contains(\u00265), false);\n\n\t\tassert_eq!(set.contains(\u00261), true);\n\n\t\tassert_eq!(set.contains(\u00263), true);\n\t}\n\n\t#[test]\n\tfn clear() {\n\t\tlet mut set: OrderedSet\u003ci32\u003e = OrderedSet::from(vec![1, 2, 3, 4]);\n\t\tset.clear();\n\t\tassert_eq!(set, OrderedSet::new());\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","vesting","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn vested_transfer() -\u003e Weight {\n\t\t(310_862_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(4 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(4 as Weight))\n\t}\n\tfn claim(i: u32) -\u003e Weight {\n\t\t(158_614_000 as Weight)\n\t\t\t.saturating_add((958_000 as Weight).saturating_mul(i as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n\tfn update_vesting_schedules(i: u32) -\u003e Weight {\n\t\t(119_811_000 as Weight)\n\t\t\t.saturating_add((2_320_000 as Weight).saturating_mul(i as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","vesting","src","lib.rs"],"content":"//! # Vesting Module\n//!\n//! ## Overview\n//!\n//! Vesting module provides a means of scheduled balance lock on an account. It\n//! uses the *graded vesting* way, which unlocks a specific amount of balance\n//! every period of time, until all balance unlocked.\n//!\n//! ### Vesting Schedule\n//!\n//! The schedule of a vesting is described by data structure `VestingSchedule`:\n//! from the block number of `start`, for every `period` amount of blocks,\n//! `per_period` amount of balance would unlocked, until number of periods\n//! `period_count` reached. Note in vesting schedules, *time* is measured by\n//! block number. All `VestingSchedule`s under an account could be queried in\n//! chain state.\n//!\n//! ## Interface\n//!\n//! ### Dispatchable Functions\n//!\n//! - `vested_transfer` - Add a new vesting schedule for an account.\n//! - `claim` - Claim unlocked balances.\n//! - `update_vesting_schedules` - Update all vesting schedules under an\n//!   account, `root` origin required.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode, HasCompact};\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, ensure,\n\ttraits::{Currency, EnsureOrigin, ExistenceRequirement, Get, LockIdentifier, LockableCurrency, WithdrawReasons},\n\ttransactional,\n\tweights::Weight,\n};\nuse frame_system::{ensure_root, ensure_signed};\nuse sp_runtime::{\n\ttraits::{AtLeast32Bit, CheckedAdd, Saturating, StaticLookup, Zero},\n\tDispatchResult, RuntimeDebug,\n};\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tvec::Vec,\n};\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn vested_transfer() -\u003e Weight;\n\tfn claim(i: u32) -\u003e Weight;\n\tfn update_vesting_schedules(i: u32) -\u003e Weight;\n}\n\n/// The maximum number of vesting schedules an account can have.\npub const MAX_VESTINGS: usize = 20;\n\n/// The vesting schedule.\n///\n/// Benefits would be granted gradually, `per_period` amount every `period` of\n/// blocks after `start`.\n#[derive(Clone, Encode, Decode, PartialEq, Eq, RuntimeDebug)]\npub struct VestingSchedule\u003cBlockNumber, Balance: HasCompact\u003e {\n\t/// Vesting starting block\n\tpub start: BlockNumber,\n\t/// Number of blocks between vest\n\tpub period: BlockNumber,\n\t/// Number of vest\n\tpub period_count: u32,\n\t/// Amount of tokens to release per vest\n\t#[codec(compact)]\n\tpub per_period: Balance,\n}\n\nimpl\u003cBlockNumber: AtLeast32Bit + Copy, Balance: AtLeast32Bit + Copy\u003e VestingSchedule\u003cBlockNumber, Balance\u003e {\n\t/// Returns the end of all periods, `None` if calculation overflows.\n\tpub fn end(\u0026self) -\u003e Option\u003cBlockNumber\u003e {\n\t\t// period * period_count + start\n\t\tself.period\n\t\t\t.checked_mul(\u0026self.period_count.into())?\n\t\t\t.checked_add(\u0026self.start)\n\t}\n\n\t/// Returns all locked amount, `None` if calculation overflows.\n\tpub fn total_amount(\u0026self) -\u003e Option\u003cBalance\u003e {\n\t\tself.per_period.checked_mul(\u0026self.period_count.into())\n\t}\n\n\t/// Returns locked amount for a given `time`.\n\t///\n\t/// Note this func assumes schedule is a valid one(non-zero period and\n\t/// non-overflow total amount), and it should be guaranteed by callers.\n\tpub fn locked_amount(\u0026self, time: BlockNumber) -\u003e Balance {\n\t\t// full = (time - start) / period\n\t\t// unrealized = period_count - full\n\t\t// per_period * unrealized\n\t\tlet full = time\n\t\t\t.saturating_sub(self.start)\n\t\t\t.checked_div(\u0026self.period)\n\t\t\t.expect(\"ensured non-zero period; qed\");\n\t\tlet unrealized = self.period_count.saturating_sub(full.unique_saturated_into());\n\t\tself.per_period\n\t\t\t.checked_mul(\u0026unrealized.into())\n\t\t\t.expect(\"ensured non-overflow total amount; qed\")\n\t}\n}\n\npub type BalanceOf\u003cT\u003e = \u003c\u003cT as Trait\u003e::Currency as Currency\u003c\u003cT as frame_system::Trait\u003e::AccountId\u003e\u003e::Balance;\npub type VestingScheduleOf\u003cT\u003e = VestingSchedule\u003c\u003cT as frame_system::Trait\u003e::BlockNumber, BalanceOf\u003cT\u003e\u003e;\npub type ScheduledItem\u003cT\u003e = (\n\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\u003cT as frame_system::Trait\u003e::BlockNumber,\n\t\u003cT as frame_system::Trait\u003e::BlockNumber,\n\tu32,\n\tBalanceOf\u003cT\u003e,\n);\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\ttype Currency: LockableCurrency\u003cSelf::AccountId, Moment = Self::BlockNumber\u003e;\n\n\t/// The minimum amount transferred to call `vested_transfer`.\n\ttype MinVestedTransfer: Get\u003cBalanceOf\u003cSelf\u003e\u003e;\n\n\t/// Required origin for vested transfer.\n\ttype VestedTransferOrigin: EnsureOrigin\u003cSelf::Origin, Success = Self::AccountId\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Vesting {\n\t\t/// Vesting schedules of an account.\n\t\tpub VestingSchedules get(fn vesting_schedules) build(|config: \u0026GenesisConfig\u003cT\u003e| {\n\t\t\tconfig.vesting.iter()\n\t\t\t\t.map(|\u0026(ref who, start, period, period_count, per_period)| {\n\t\t\t\t\tlet total = per_period * Into::\u003cBalanceOf\u003cT\u003e\u003e::into(period_count);\n\t\t\t\t\tassert!(T::Currency::free_balance(who) \u003e= total, \"Account do not have enough balance\");\n\t\t\t\t\tT::Currency::set_lock(VESTING_LOCK_ID, who, total, WithdrawReasons::all());\n\t\t\t\t\t(who.clone(), vec![VestingSchedule {start, period, period_count, per_period}])\n\t\t\t\t})\n\t\t\t\t.collect::\u003cVec\u003c_\u003e\u003e()\n\t\t}): map hasher(blake2_128_concat) T::AccountId =\u003e Vec\u003cVestingScheduleOf\u003cT\u003e\u003e;\n\t}\n\n\tadd_extra_genesis {\n\t\tconfig(vesting): Vec\u003cScheduledItem\u003cT\u003e\u003e;\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\tBalance = BalanceOf\u003cT\u003e,\n\t\tVestingSchedule = VestingScheduleOf\u003cT\u003e\n\t{\n\t\t/// Added new vesting schedule. [from, to, vesting_schedule]\n\t\tVestingScheduleAdded(AccountId, AccountId, VestingSchedule),\n\t\t/// Claimed vesting. [who, locked_amount]\n\t\tClaimed(AccountId, Balance),\n\t\t/// Updated vesting schedules. [who]\n\t\tVestingSchedulesUpdated(AccountId),\n\t}\n);\n\ndecl_error! {\n\t/// Error for vesting module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Vesting period is zero\n\t\tZeroVestingPeriod,\n\t\t/// Number of vests is zero\n\t\tZeroVestingPeriodCount,\n\t\t/// Arithmetic calculation overflow\n\t\tNumOverflow,\n\t\t/// Insufficient amount of balance to lock\n\t\tInsufficientBalanceToLock,\n\t\t/// This account have too many vesting schedules\n\t\tTooManyVestingSchedules,\n\t\t/// The vested transfer amount is too low\n\t\tAmountLow,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\t/// The minimum amount to be transferred to create a new vesting schedule.\n\t\tconst MinVestedTransfer: BalanceOf\u003cT\u003e = T::MinVestedTransfer::get();\n\n\t\tfn deposit_event() = default;\n\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::Currency is orml_currencies\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 3\n\t\t/// - Db writes: 3\n\t\t/// -------------------\n\t\t/// Base Weight: 65.23 µs\n\t\t/// # \u003c/weight\u003e\n\t\t// can not get VestingSchedule count from `who`, so use `MAX_VESTINGS / 2`\n\t\t#[weight = T::WeightInfo::claim((MAX_VESTINGS / 2) as u32)]\n\t\tpub fn claim(origin) {\n\t\t\tlet who = ensure_signed(origin)?;\n\t\t\tlet locked_amount = Self::do_claim(\u0026who);\n\n\t\t\tSelf::deposit_event(RawEvent::Claimed(who, locked_amount));\n\t\t}\n\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::Currency is orml_currencies\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 4\n\t\t/// - Db writes: 4\n\t\t/// -------------------\n\t\t/// Base Weight: 150.4 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::vested_transfer()]\n\t\tpub fn vested_transfer(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tschedule: VestingScheduleOf\u003cT\u003e,\n\t\t) {\n\t\t\tlet from = T::VestedTransferOrigin::ensure_origin(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\tSelf::do_vested_transfer(\u0026from, \u0026to, schedule.clone())?;\n\n\t\t\tSelf::deposit_event(RawEvent::VestingScheduleAdded(from, to, schedule));\n\t\t}\n\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::Currency is orml_currencies\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 2\n\t\t/// - Db writes: 3\n\t\t/// -------------------\n\t\t/// Base Weight: 61.87 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::update_vesting_schedules(vesting_schedules.len() as u32)]\n\t\tpub fn update_vesting_schedules(\n\t\t\torigin,\n\t\t\twho: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tvesting_schedules: Vec\u003cVestingScheduleOf\u003cT\u003e\u003e\n\t\t) {\n\t\t\tensure_root(origin)?;\n\n\t\t\tlet account = T::Lookup::lookup(who)?;\n\t\t\tSelf::do_update_vesting_schedules(\u0026account, vesting_schedules)?;\n\n\t\t\tSelf::deposit_event(RawEvent::VestingSchedulesUpdated(account));\n\t\t}\n\t}\n}\n\nconst VESTING_LOCK_ID: LockIdentifier = *b\"ormlvest\";\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tfn do_claim(who: \u0026T::AccountId) -\u003e BalanceOf\u003cT\u003e {\n\t\tlet locked = Self::locked_balance(who);\n\t\tif locked.is_zero() {\n\t\t\tT::Currency::remove_lock(VESTING_LOCK_ID, who);\n\t\t} else {\n\t\t\tT::Currency::set_lock(VESTING_LOCK_ID, who, locked, WithdrawReasons::all());\n\t\t}\n\t\tlocked\n\t}\n\n\t/// Returns locked balance based on current block number.\n\tfn locked_balance(who: \u0026T::AccountId) -\u003e BalanceOf\u003cT\u003e {\n\t\tlet now = \u003cframe_system::Module\u003cT\u003e\u003e::block_number();\n\t\t\u003cVestingSchedules\u003cT\u003e\u003e::mutate_exists(who, |maybe_schedules| {\n\t\t\tlet total = if let Some(schedules) = maybe_schedules.as_mut() {\n\t\t\t\tlet mut total: BalanceOf\u003cT\u003e = Zero::zero();\n\t\t\t\tschedules.retain(|s| {\n\t\t\t\t\tlet amount = s.locked_amount(now);\n\t\t\t\t\ttotal = total.saturating_add(amount);\n\t\t\t\t\t!amount.is_zero()\n\t\t\t\t});\n\t\t\t\ttotal\n\t\t\t} else {\n\t\t\t\tZero::zero()\n\t\t\t};\n\t\t\tif total.is_zero() {\n\t\t\t\t*maybe_schedules = None;\n\t\t\t}\n\t\t\ttotal\n\t\t})\n\t}\n\n\tfn _do_vested_transfer(from: \u0026T::AccountId, to: \u0026T::AccountId, schedule: VestingScheduleOf\u003cT\u003e) -\u003e DispatchResult {\n\t\tlet schedule_amount = Self::ensure_valid_vesting_schedule(\u0026schedule)?;\n\n\t\tensure!(\n\t\t\t\u003cVestingSchedules\u003cT\u003e\u003e::decode_len(to).unwrap_or(0) \u003c MAX_VESTINGS,\n\t\t\tError::\u003cT\u003e::TooManyVestingSchedules\n\t\t);\n\n\t\tlet total_amount = Self::locked_balance(to)\n\t\t\t.checked_add(\u0026schedule_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tT::Currency::transfer(from, to, schedule_amount, ExistenceRequirement::AllowDeath)?;\n\t\tT::Currency::set_lock(VESTING_LOCK_ID, to, total_amount, WithdrawReasons::all());\n\t\t\u003cVestingSchedules\u003cT\u003e\u003e::append(to, schedule);\n\n\t\tOk(())\n\t}\n\n\t#[transactional]\n\tfn do_vested_transfer(from: \u0026T::AccountId, to: \u0026T::AccountId, schedule: VestingScheduleOf\u003cT\u003e) -\u003e DispatchResult {\n\t\t// workaround bug of #[transactional] does not handle return in body correctly.\n\t\t// TODO: Update once https://github.com/paritytech/substrate/pull/7188 is available.\n\t\tSelf::_do_vested_transfer(from, to, schedule)\n\t}\n\n\tfn do_update_vesting_schedules(who: \u0026T::AccountId, schedules: Vec\u003cVestingScheduleOf\u003cT\u003e\u003e) -\u003e DispatchResult {\n\t\tlet total_amount = schedules.iter().try_fold::\u003c_, _, Result\u003cBalanceOf\u003cT\u003e, Error\u003cT\u003e\u003e\u003e(\n\t\t\tZero::zero(),\n\t\t\t|acc_amount, schedule| {\n\t\t\t\tlet amount = Self::ensure_valid_vesting_schedule(schedule)?;\n\t\t\t\tOk(acc_amount + amount)\n\t\t\t},\n\t\t)?;\n\t\tensure!(\n\t\t\tT::Currency::free_balance(who) \u003e= total_amount,\n\t\t\tError::\u003cT\u003e::InsufficientBalanceToLock,\n\t\t);\n\n\t\tT::Currency::set_lock(VESTING_LOCK_ID, who, total_amount, WithdrawReasons::all());\n\t\t\u003cVestingSchedules\u003cT\u003e\u003e::insert(who, schedules);\n\n\t\tOk(())\n\t}\n\n\t/// Returns `Ok(amount)` if valid schedule, or error.\n\tfn ensure_valid_vesting_schedule(schedule: \u0026VestingScheduleOf\u003cT\u003e) -\u003e Result\u003cBalanceOf\u003cT\u003e, Error\u003cT\u003e\u003e {\n\t\tensure!(!schedule.period.is_zero(), Error::\u003cT\u003e::ZeroVestingPeriod);\n\t\tensure!(!schedule.period_count.is_zero(), Error::\u003cT\u003e::ZeroVestingPeriodCount);\n\t\tensure!(schedule.end().is_some(), Error::\u003cT\u003e::NumOverflow);\n\n\t\tlet total = schedule.total_amount().ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tensure!(total \u003e= T::MinVestedTransfer::get(), Error::\u003cT\u003e::AmountLow);\n\n\t\tOk(total)\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","vesting","src","mock.rs"],"content":"//! Mocks for the vesting module.\n\n#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse frame_system::RawOrigin;\nuse pallet_balances;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod vesting {\n\tpub use crate::Event;\n}\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\tvesting\u003cT\u003e,\n\t\tpallet_balances\u003cT\u003e,\n\t}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = pallet_balances::AccountData\u003cu64\u003e;\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\ntype Balance = u64;\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n\tpub const MinVestedTransfer: u64 = 5;\n}\n\nimpl pallet_balances::Trait for Runtime {\n\ttype Balance = Balance;\n\ttype DustRemoval = ();\n\ttype Event = TestEvent;\n\ttype ExistentialDeposit = ExistentialDeposit;\n\ttype AccountStore = frame_system::Module\u003cRuntime\u003e;\n\ttype MaxLocks = ();\n\ttype WeightInfo = ();\n}\npub type PalletBalances = pallet_balances::Module\u003cRuntime\u003e;\n\npub struct EnsureAliceOrBob;\nimpl EnsureOrigin\u003cOrigin\u003e for EnsureAliceOrBob {\n\ttype Success = AccountId;\n\n\tfn try_origin(o: Origin) -\u003e Result\u003cSelf::Success, Origin\u003e {\n\t\tInto::\u003cResult\u003cRawOrigin\u003cAccountId\u003e, Origin\u003e\u003e::into(o).and_then(|o| match o {\n\t\t\tRawOrigin::Signed(ALICE) =\u003e Ok(ALICE),\n\t\t\tRawOrigin::Signed(BOB) =\u003e Ok(BOB),\n\t\t\tr =\u003e Err(Origin::from(r)),\n\t\t})\n\t}\n\n\t#[cfg(feature = \"runtime-benchmarks\")]\n\tfn successful_origin() -\u003e Origin {\n\t\tOrigin::from(RawOrigin::Signed(Default::default()))\n\t}\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Currency = PalletBalances;\n\ttype MinVestedTransfer = MinVestedTransfer;\n\ttype VestedTransferOrigin = EnsureAliceOrBob;\n\ttype WeightInfo = ();\n}\npub type Vesting = Module\u003cRuntime\u003e;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const CHARLIE: AccountId = 3;\n\n#[derive(Default)]\npub struct ExtBuilder;\n\nimpl ExtBuilder {\n\tpub fn build() -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tpallet_balances::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tbalances: vec![(ALICE, 100), (CHARLIE, 30)],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tGenesisConfig::\u003cRuntime\u003e {\n\t\t\tvesting: vec![(CHARLIE, 2, 3, 4, 5)], // who, start, period, period_count, per_period\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","vesting","src","tests.rs"],"content":"//! Unit tests for the vesting module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok, error::BadOrigin, traits::WithdrawReason};\nuse mock::{ExtBuilder, Origin, PalletBalances, Runtime, System, TestEvent, Vesting, ALICE, BOB, CHARLIE};\nuse pallet_balances::{BalanceLock, Reasons};\n\n#[test]\nfn vesting_from_chain_spec_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tassert_ok!(PalletBalances::ensure_can_withdraw(\n\t\t\t\u0026CHARLIE,\n\t\t\t10,\n\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t20\n\t\t));\n\t\tassert!(PalletBalances::ensure_can_withdraw(\u0026CHARLIE, 11, WithdrawReason::Transfer.into(), 19).is_err());\n\n\t\tassert_eq!(\n\t\t\tVesting::vesting_schedules(\u0026CHARLIE),\n\t\t\tvec![VestingSchedule {\n\t\t\t\tstart: 2u64,\n\t\t\t\tperiod: 3u64,\n\t\t\t\tperiod_count: 4u32,\n\t\t\t\tper_period: 5u64,\n\t\t\t}]\n\t\t);\n\n\t\tSystem::set_block_number(13);\n\n\t\tassert_ok!(Vesting::claim(Origin::signed(CHARLIE)));\n\n\t\tassert_ok!(PalletBalances::ensure_can_withdraw(\n\t\t\t\u0026CHARLIE,\n\t\t\t25,\n\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t5\n\t\t));\n\t\tassert!(PalletBalances::ensure_can_withdraw(\u0026CHARLIE, 26, WithdrawReason::Transfer.into(), 4).is_err());\n\n\t\tSystem::set_block_number(14);\n\n\t\tassert_ok!(Vesting::claim(Origin::signed(CHARLIE)));\n\n\t\tassert_ok!(PalletBalances::ensure_can_withdraw(\n\t\t\t\u0026CHARLIE,\n\t\t\t30,\n\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t0\n\t\t));\n\t});\n}\n\n#[test]\nfn vested_transfer_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\t\tassert_eq!(Vesting::vesting_schedules(\u0026BOB), vec![schedule.clone()]);\n\n\t\tlet vested_event = TestEvent::vesting(RawEvent::VestingScheduleAdded(ALICE, BOB, schedule));\n\t\tassert!(System::events().iter().any(|record| record.event == vested_event));\n\t});\n}\n\n#[test]\nfn add_new_vesting_schedule_merges_with_current_locked_balance_and_until() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule));\n\n\t\tSystem::set_block_number(12);\n\n\t\tlet another_schedule = VestingSchedule {\n\t\t\tstart: 10u64,\n\t\t\tperiod: 13u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 7u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, another_schedule));\n\n\t\tassert_eq!(\n\t\t\tPalletBalances::locks(\u0026BOB).pop(),\n\t\t\tSome(BalanceLock {\n\t\t\t\tid: VESTING_LOCK_ID,\n\t\t\t\tamount: 17u64,\n\t\t\t\treasons: Reasons::All,\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn cannot_use_fund_if_not_claimed() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 10u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 50u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\t\tassert!(PalletBalances::ensure_can_withdraw(\u0026BOB, 1, WithdrawReason::Transfer.into(), 49).is_err());\n\t});\n}\n\n#[test]\nfn vested_transfer_fails_if_zero_period_or_count() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 0u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()),\n\t\t\tError::\u003cRuntime\u003e::ZeroVestingPeriod\n\t\t);\n\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 0u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()),\n\t\t\tError::\u003cRuntime\u003e::ZeroVestingPeriodCount\n\t\t);\n\t});\n}\n\n#[test]\nfn vested_transfer_fails_if_transfer_err() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(BOB), ALICE, schedule.clone()),\n\t\t\tpallet_balances::Error::\u003cRuntime, _\u003e::InsufficientBalance,\n\t\t);\n\t});\n}\n\n#[test]\nfn vested_transfer_fails_if_overflow() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: u64::max_value(),\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(ALICE), BOB, schedule),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\tlet another_schedule = VestingSchedule {\n\t\t\tstart: u64::max_value(),\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 1u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(ALICE), BOB, another_schedule),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn vested_transfer_fails_if_bad_origin() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(CHARLIE), BOB, schedule.clone()),\n\t\t\tBadOrigin\n\t\t);\n\t});\n}\n\n#[test]\nfn claim_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\n\t\tSystem::set_block_number(11);\n\t\t// remain locked if not claimed\n\t\tassert!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 10).is_err());\n\t\t// unlocked after claiming\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\t\tassert_ok!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 10));\n\t\t// more are still locked\n\t\tassert!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 1).is_err());\n\n\t\tSystem::set_block_number(21);\n\t\t// claim more\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\t\tassert_ok!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 10));\n\t\t// all used up\n\t\tassert_eq!(PalletBalances::free_balance(BOB), 0);\n\n\t\t// no locks anymore\n\t\tassert_eq!(PalletBalances::locks(\u0026BOB), vec![]);\n\t});\n}\n\n#[test]\nfn update_vesting_schedules_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\n\t\tlet updated_schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 20u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::update_vesting_schedules(\n\t\t\tOrigin::root(),\n\t\t\tBOB,\n\t\t\tvec![updated_schedule]\n\t\t));\n\n\t\tSystem::set_block_number(11);\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\t\tassert!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 1).is_err());\n\n\t\tSystem::set_block_number(21);\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\t\tassert_ok!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 10));\n\t});\n}\n\n#[test]\nfn update_vesting_schedules_fails_if_unexpected_existing_locks() {\n\tExtBuilder::build().execute_with(|| {\n\t\tassert_ok!(PalletBalances::transfer(Origin::signed(ALICE), BOB, 1));\n\t\tPalletBalances::set_lock(*b\"prelocks\", \u0026BOB, 0u64, WithdrawReasons::all());\n\t});\n}\n\n#[test]\nfn vested_transfer_check_for_min() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 3u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(BOB), ALICE, schedule.clone()),\n\t\t\tError::\u003cRuntime\u003e::AmountLow\n\t\t);\n\t});\n}\n\n#[test]\nfn multiple_vesting_schedule_claim_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\n\t\tlet schedule2 = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 3u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule2.clone()));\n\n\t\tassert_eq!(Vesting::vesting_schedules(\u0026BOB), vec![schedule, schedule2.clone()]);\n\n\t\tSystem::set_block_number(21);\n\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\n\t\tassert_eq!(Vesting::vesting_schedules(\u0026BOB), vec![schedule2]);\n\n\t\tSystem::set_block_number(31);\n\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\n\t\tassert_eq!(VestingSchedules::\u003cRuntime\u003e::contains_key(\u0026BOB), false);\n\n\t\tassert_eq!(PalletBalances::locks(\u0026BOB), vec![]);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","accounts","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::traits::Get;\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, dispatch::DispatchResult, ensure, IterableStorageMap,\n};\nuse frame_system::{self as system, ensure_root, ensure_signed};\nuse sp_std::collections::btree_set::BTreeSet;\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\npub trait Trait: system::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n\n\t/// A maximum number of members. When membership reaches this number, no new members may join.\n\ttype MaxMembers: Get\u003cu32\u003e;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Accounts {\n\t\tAllowedAccounts get(fn allowed_accounts) config(): map hasher(blake2_128_concat) T::AccountId =\u003e ();\n\t\tMemberCount: u32;\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e\n\twhere\n\t\tAccountId = \u003cT as system::Trait\u003e::AccountId,\n\t{\n\t\t/// New account is added to the allow-list: \\[who\\]\n\t\tAccountAdded(AccountId),\n\n\t\t/// Account is removed from the allow-list: \\[who\\]\n\t\tAccountRemoved(AccountId),\n\n\t\t/// The caller is a member: \\[who\\]\n\t\tIsAnAdmin(AccountId),\n\t}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The account cannot be added to the allowed list because it has already been added.\n\t\tAlreadyMember,\n\n\t\t/// The account cannot be removed from the allowed list because it is not a member.\n\t\tNotAnAdmin,\n\n\t\t/// Cannot add another member because the limit is already reached.\n\t\tMembershipLimitReached,\n\n\t\t/// Cannot remove a member because ay least one member must remain.\n\t\tMustBeAtLeastOneMember,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\t\tfn deposit_event() = default;\n\n\t\t/// Adds a new account to the allow-list.\n\t\t///\n\t\t/// The dispatch origin of this call must be _Root_.\n\t\t#[weight = 0]\n\t\tpub fn add_member(origin, new_account: T::AccountId) -\u003e DispatchResult {\n\t\t\tensure_root(origin)?;\n\n\t\t\tlet member_count = MemberCount::get();\n\t\t\tensure!(member_count \u003c T::MaxMembers::get(), Error::\u003cT\u003e::MembershipLimitReached);\n\n\t\t\tensure!(!AllowedAccounts::\u003cT\u003e::contains_key(\u0026new_account), Error::\u003cT\u003e::AlreadyMember);\n\n\t\t\tAllowedAccounts::\u003cT\u003e::insert(\u0026new_account, ());\n\t\t\tMemberCount::put(member_count + 1);\n\t\t\tSelf::deposit_event(RawEvent::AccountAdded(new_account));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Remove an account from the allow-list.\n\t\t///\n\t\t/// The dispatch origin of this call must be _Root_.\n\t\t#[weight = 0]\n\t\tpub fn remove_member(origin, account_to_remove: T::AccountId) -\u003e DispatchResult {\n\t\t\tensure_root(origin)?;\n\n\t\t\tensure!(AllowedAccounts::\u003cT\u003e::contains_key(\u0026account_to_remove), Error::\u003cT\u003e::NotAnAdmin);\n\n\t\t\tlet member_count = MemberCount::get();\n\t\t\tensure!(member_count \u003e 1, Error::\u003cT\u003e::MustBeAtLeastOneMember);\n\n\t\t\tAllowedAccounts::\u003cT\u003e::remove(\u0026account_to_remove);\n\t\t\tMemberCount::mutate(|v| *v -= 1);\n\t\t\tSelf::deposit_event(RawEvent::AccountRemoved(account_to_remove));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Checks whether the caller is a member of the allow-list.\n\t\t/// Emits an event if they are, and errors if not.\n\t\t#[weight = 0]\n\t\tfn is_admin(origin) -\u003e DispatchResult {\n\t\t\tlet caller = ensure_signed(origin)?;\n\t\t\tensure!(AllowedAccounts::\u003cT\u003e::contains_key(\u0026caller), Error::\u003cT\u003e::NotAnAdmin);\n\t\t\tSelf::deposit_event(RawEvent::IsAnAdmin(caller));\n\t\t\tOk(())\n\t\t}\n\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Checks whether the caller is a member of the allow-list.\n\tpub fn is_admin_internal(caller: \u0026T::AccountId) -\u003e bool {\n\t\tlet members = \u003cAllowedAccounts\u003cT\u003e as IterableStorageMap\u003cT::AccountId, ()\u003e\u003e::iter()\n\t\t\t.map(|(acct, _)| acct)\n\t\t\t.collect::\u003cBTreeSet\u003c_\u003e\u003e();\n\n\t\tmembers.contains(\u0026caller)\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","accounts","src","mock.rs"],"content":"/// Mocks for the accounts pallet.\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\nuse sp_io::TestExternalities;\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\nmod accounts {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\taccounts\u003cT\u003e,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Test;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\ntype AccountId = u32;\n\nimpl frame_system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype AccountData = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = 16;\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype MaxMembers = MaxMembers;\n}\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub type TestAccounts = Module\u003cTest\u003e;\npub type System = frame_system::Module\u003cTest\u003e;\n\npub struct ExternalityBuilder;\n\nimpl ExternalityBuilder {\n\tpub fn build() -\u003e TestExternalities {\n\t\tlet storage = system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\t\tlet mut ext = TestExternalities::from(storage);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","accounts","src","tests.rs"],"content":"//! Tests for the accounts pallet.\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_noop, assert_ok, error::BadOrigin};\n\n#[test]\nfn add_member_should_work() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\t// The dispatch origin of this call must be _Root_.\n\t\tassert_noop!(TestAccounts::add_member(Origin::signed(ALICE), BOB), BadOrigin);\n\n\t\t// Add Alice to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), ALICE));\n\t\tlet expected_event = TestEvent::accounts(RawEvent::AccountAdded(ALICE));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert!(\u003cAllowedAccounts\u003cTest\u003e\u003e::contains_key(ALICE));\n\n\t\t// Add Bob to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), BOB));\n\t\tlet expected_event = TestEvent::accounts(RawEvent::AccountAdded(BOB));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert!(\u003cAllowedAccounts\u003cTest\u003e\u003e::contains_key(BOB));\n\n\t\t// Alice cannot be added to the allowed list because she has already been added.\n\t\tassert_noop!(\n\t\t\tTestAccounts::add_member(Origin::root(), ALICE),\n\t\t\tError::\u003cTest\u003e::AlreadyMember\n\t\t);\n\t});\n}\n\n#[test]\nfn cant_exceed_max_members() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\t// Add 16 members, reaching the max\n\t\tfor i in 0..16 {\n\t\t\tassert_ok!(TestAccounts::add_member(Origin::root(), i));\n\t\t}\n\n\t\t// Try to add the 17th member exceeding the max\n\t\tassert_noop!(\n\t\t\tTestAccounts::add_member(Origin::root(), 16),\n\t\t\tError::\u003cTest\u003e::MembershipLimitReached\n\t\t);\n\t})\n}\n\n#[test]\nfn remove_member_should_work() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\t// Add Alice to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), ALICE));\n\n\t\t// Add Bob to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), BOB));\n\n\t\t// Remove Bob from allow-list.\n\t\tassert_ok!(TestAccounts::remove_member(Origin::root(), BOB));\n\n\t\t// Cannot remove Alice, because ay least one member must remain.\n\t\tassert_noop!(\n\t\t\tTestAccounts::remove_member(Origin::root(), ALICE),\n\t\t\tError::\u003cTest\u003e::MustBeAtLeastOneMember\n\t\t);\n\n\t\t// Test that the expected events were emitted.\n\t\tlet our_events = System::events()\n\t\t\t.into_iter()\n\t\t\t.map(|r| r.event)\n\t\t\t.filter_map(|e| {\n\t\t\t\tif let TestEvent::accounts(inner) = e {\n\t\t\t\t\tSome(inner)\n\t\t\t\t} else {\n\t\t\t\t\tNone\n\t\t\t\t}\n\t\t\t})\n\t\t\t.collect::\u003cVec\u003c_\u003e\u003e();\n\n\t\tlet expected_events = vec![\n\t\t\tRawEvent::AccountAdded(1),\n\t\t\tRawEvent::AccountAdded(2),\n\t\t\tRawEvent::AccountRemoved(2),\n\t\t];\n\n\t\tassert_eq!(our_events, expected_events);\n\n\t\t// Check storage changes.\n\t\tassert!(\u003cAllowedAccounts\u003cTest\u003e\u003e::contains_key(ALICE));\n\t\tassert!(!\u003cAllowedAccounts\u003cTest\u003e\u003e::contains_key(BOB));\n\n\t\t// Bob was previously removed from the allow-list.\n\t\tassert_noop!(\n\t\t\tTestAccounts::remove_member(Origin::root(), BOB),\n\t\t\tError::\u003cTest\u003e::NotAnAdmin\n\t\t);\n\t})\n}\n\n#[test]\nfn is_admin_should_work() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\t// Add Alice to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), ALICE));\n\n\t\tassert_ok!(TestAccounts::is_admin(Origin::signed(ALICE)));\n\t\tlet expected_event = TestEvent::accounts(RawEvent::IsAnAdmin(ALICE));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\tassert_noop!(TestAccounts::is_admin(Origin::signed(BOB)), Error::\u003cTest\u003e::NotAnAdmin);\n\t});\n}\n\n#[test]\nfn is_admin_internal_should_work() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), ALICE));\n\n\t\tassert!(TestAccounts::is_admin_internal(\u0026ALICE));\n\t\tassert!(!TestAccounts::is_admin_internal(\u0026BOB));\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","rpc","runtime-api","src","lib.rs"],"content":"//! Runtime API definition for controller pallet.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// The `too_many_arguments` warning originates from `decl_runtime_apis` macro.\n#![allow(clippy::too_many_arguments)]\n// The `unnecessary_mut_passed` warning originates from `decl_runtime_apis` macro.\n#![allow(clippy::unnecessary_mut_passed)]\n\nuse codec::{Decode, Encode};\nuse minterest_primitives::{CurrencyId, Rate};\nuse sp_core::RuntimeDebug;\nuse sp_std::prelude::*;\n\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\n\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, Eq, PartialEq, Default, RuntimeDebug)]\npub struct PoolState {\n\tpub exchange_rate: Rate,\n\tpub borrow_rate: Rate,\n\tpub supply_rate: Rate,\n}\n\n// Here we declare the runtime API. It is implemented it the `impl` block in\n// runtime amalgamator file (the `runtime/src/lib.rs`)\nsp_api::decl_runtime_apis! {\n\tpub trait ControllerApi {\n\t\tfn liquidity_pool_state(pool_id: CurrencyId) -\u003e Option\u003cPoolState\u003e;\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","rpc","src","lib.rs"],"content":"//! RPC interface for the controller module.\n\npub use controller_rpc_runtime_api::{ControllerApi as ControllerRuntimeApi, PoolState};\nuse jsonrpc_core::{Error as RpcError, ErrorCode, Result};\nuse jsonrpc_derive::rpc;\nuse minterest_primitives::CurrencyId;\nuse sp_api::ProvideRuntimeApi;\nuse sp_blockchain::HeaderBackend;\nuse sp_runtime::{generic::BlockId, traits::Block as BlockT};\nuse std::sync::Arc;\n\n#[rpc]\npub trait ControllerApi\u003cBlockHash\u003e {\n\t#[rpc(name = \"controller_liquidityPoolState\")]\n\tfn liquidity_pool_state(\u0026self, pool_id: CurrencyId, at: Option\u003cBlockHash\u003e) -\u003e Result\u003cOption\u003cPoolState\u003e\u003e;\n}\n\n/// A struct that implements the [`ControllerApi`].\npub struct Controller\u003cC, B\u003e {\n\tclient: Arc\u003cC\u003e,\n\t_marker: std::marker::PhantomData\u003cB\u003e,\n}\n\nimpl\u003cC, B\u003e Controller\u003cC, B\u003e {\n\t/// Create new `LiquidityPool` with the given reference to the client.\n\tpub fn new(client: Arc\u003cC\u003e) -\u003e Self {\n\t\tSelf {\n\t\t\tclient,\n\t\t\t_marker: Default::default(),\n\t\t}\n\t}\n}\n\npub enum Error {\n\tRuntimeError,\n}\n\nimpl From\u003cError\u003e for i64 {\n\tfn from(e: Error) -\u003e i64 {\n\t\tmatch e {\n\t\t\tError::RuntimeError =\u003e 1,\n\t\t}\n\t}\n}\n\nimpl\u003cC, Block\u003e ControllerApi\u003c\u003cBlock as BlockT\u003e::Hash\u003e for Controller\u003cC, Block\u003e\nwhere\n\tBlock: BlockT,\n\tC: Send + Sync + 'static + ProvideRuntimeApi\u003cBlock\u003e + HeaderBackend\u003cBlock\u003e,\n\tC::Api: ControllerRuntimeApi\u003cBlock\u003e,\n{\n\tfn liquidity_pool_state(\n\t\t\u0026self,\n\t\tpool_id: CurrencyId,\n\t\tat: Option\u003c\u003cBlock as BlockT\u003e::Hash\u003e,\n\t) -\u003e Result\u003cOption\u003cPoolState\u003e\u003e {\n\t\tlet api = self.client.runtime_api();\n\t\tlet at = BlockId::hash(at.unwrap_or_else(||\n            // If the block hash is not supplied assume the best block.\n            self.client.info().best_hash));\n\t\tapi.liquidity_pool_state(\u0026at, pool_id).map_err(|e| RpcError {\n\t\t\tcode: ErrorCode::ServerError(Error::RuntimeError.into()),\n\t\t\tmessage: \"Unable to get pool state.\".into(),\n\t\t\tdata: Some(format!(\"{:?}\", e).into()),\n\t\t})\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, ensure, traits::Get};\nuse frame_system::{self as system, ensure_signed};\nuse minterest_primitives::{Balance, CurrencyId, Operation, Rate};\nuse orml_traits::MultiCurrency;\nuse orml_utilities::with_transaction_result;\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::traits::CheckedSub;\nuse sp_runtime::{\n\ttraits::{CheckedAdd, CheckedDiv, CheckedMul, Zero},\n\tDispatchError, DispatchResult, FixedPointNumber, RuntimeDebug,\n};\nuse sp_std::{cmp::Ordering, convert::TryInto, prelude::Vec, result};\n\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, Clone, RuntimeDebug, Eq, PartialEq, Default)]\npub struct ControllerData\u003cBlockNumber\u003e {\n\t/// Block number that interest was last accrued at.\n\tpub timestamp: BlockNumber,\n\n\t/// Defines the portion of borrower interest that is converted into insurance.\n\tpub insurance_factor: Rate,\n\n\t/// Maximum borrow rate.\n\tpub max_borrow_rate: Rate,\n\n\t/// Determines how much a user can borrow.\n\tpub collateral_factor: Rate,\n}\n\n/// The Administrator can pause certain actions as a safety mechanism.\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Default)]\npub struct PauseKeeper {\n\t/// Pause mint operation in the pool.\n\tpub deposit_paused: bool,\n\n\t/// Pause redeem operation in the pool.\n\tpub redeem_paused: bool,\n\n\t/// Pause borrow operation in the pool.\n\tpub borrow_paused: bool,\n\n\t/// Pause repay operation in the pool.\n\tpub repay_paused: bool,\n}\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\ntype LiquidityPools\u003cT\u003e = liquidity_pools::Module\u003cT\u003e;\ntype MinterestModel\u003cT\u003e = minterest_model::Module\u003cT\u003e;\ntype Oracle\u003cT\u003e = oracle::Module\u003cT\u003e;\ntype Accounts\u003cT\u003e = accounts::Module\u003cT\u003e;\n\npub trait Trait:\n\tliquidity_pools::Trait + system::Trait + oracle::Trait + accounts::Trait + minterest_model::Trait\n{\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n}\n\ndecl_event! {\n\tpub enum Event {\n\t\t/// InsuranceFactor has been successfully changed\n\t\tInsuranceFactorChanged,\n\n\t\t/// Max Borrow Rate has been successfully changed\n\t\tMaxBorrowRateChanged,\n\n\t\t/// The operation is paused: \\[pool_id, operation\\]\n\t\tOperationIsPaused(CurrencyId, Operation),\n\n\t\t/// The operation is unpaused: \\[pool_id, operation\\]\n\t\tOperationIsUnPaused(CurrencyId, Operation),\n\n\t\t/// Insurance balance replenished: \\[pool_id, amount\\]\n\t\tDepositedInsurance(CurrencyId, Balance),\n\n\t\t/// Insurance balance redeemed: \\[pool_id, amount\\]\n\t\tRedeemedInsurance(CurrencyId, Balance),\n\t}\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as ControllerStorage {\n\t\t/// Controller data information: `(timestamp, insurance_factor, collateral_factor, max_borrow_rate)`.\n\t\tpub ControllerDates get(fn controller_dates) config(): map hasher(blake2_128_concat) CurrencyId =\u003e ControllerData\u003cT::BlockNumber\u003e;\n\n\t\t/// The Pause Guardian can pause certain actions as a safety mechanism\n\t\tpub PauseKeepers get(fn pause_keepers) config(): map hasher(blake2_128_concat) CurrencyId =\u003e PauseKeeper;\n\t}\n}\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Number overflow in calculation.\n\t\tNumOverflow,\n\n\t\t/// Borrow rate is absurdly high.\n\t\tBorrowRateIsTooHight,\n\n\t\t/// Oracle unavailable or price equal 0ю\n\t\tOraclePriceError,\n\n\t\t/// Insufficient available liquidity.\n\t\tInsufficientLiquidity,\n\n\t\t/// Pool not found.\n\t\tPoolNotFound,\n\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\tRequireAdmin,\n\n\t\t/// Not enough balance to deposit or withdraw or repay.\n\t\tNotEnoughBalance,\n\n\t\t/// Balance overflows maximum.\n\t\t///\n\t\t/// Only happened when the balance went wrong and balance overflows the integer type.\n\t\tBalanceOverflowed,\n\n\t\t/// Maximum borrow rate cannot be set to 0.\n\t\tMaxBorrowRateCannotBeZero,\n\n\t\t/// An error occurred in the parameters that were passed to the function.\n\t\tParametersError,\n\t}\n}\n\n// Admin functions\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\t\tfn deposit_event() = default;\n\n\t\t/// Pause specific operation (deposit, redeem, borrow, repay) with the pool.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn pause_specific_operation(origin, pool_id: CurrencyId, operation: Operation) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\t\t\tmatch operation {\n\t\t\t\tOperation::Deposit =\u003e PauseKeepers::mutate(pool_id, |pool| pool.deposit_paused = true),\n\t\t\t\tOperation::Redeem =\u003e PauseKeepers::mutate(pool_id, |pool| pool.redeem_paused = true),\n\t\t\t\tOperation::Borrow =\u003e PauseKeepers::mutate(pool_id, |pool| pool.borrow_paused = true),\n\t\t\t\tOperation::Repay =\u003e PauseKeepers::mutate(pool_id, |pool| pool.repay_paused = true),\n\t\t\t};\n\t\t\tSelf::deposit_event(Event::OperationIsPaused(pool_id, operation));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Unpause specific operation (deposit, redeem, borrow, repay) with the pool.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn unpause_specific_operation(origin, pool_id: CurrencyId, operation: Operation) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\t\t\tmatch operation {\n\t\t\t\tOperation::Deposit =\u003e PauseKeepers::mutate(pool_id, |pool| pool.deposit_paused = false),\n\t\t\t\tOperation::Redeem =\u003e PauseKeepers::mutate(pool_id, |pool| pool.redeem_paused = false),\n\t\t\t\tOperation::Borrow =\u003e PauseKeepers::mutate(pool_id, |pool| pool.borrow_paused = false),\n\t\t\t\tOperation::Repay =\u003e PauseKeepers::mutate(pool_id, |pool| pool.repay_paused = false),\n\t\t\t};\n\t\t\tSelf::deposit_event(Event::OperationIsUnPaused(pool_id, operation));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Replenishes the insurance balance.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn deposit_insurance(origin, pool_id: CurrencyId, #[compact] amount: Balance) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\t\tSelf::do_deposit_insurance(\u0026sender, pool_id, amount)?;\n\t\t\t\tSelf::deposit_event(Event::DepositedInsurance(pool_id, amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Redeem the insurance balance.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn redeem_insurance(origin, pool_id: CurrencyId, #[compact] amount: Balance) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\t\tSelf::do_redeem_insurance(\u0026sender, pool_id, amount)?;\n\t\t\t\tSelf::deposit_event(Event::RedeemedInsurance(pool_id, amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Set insurance factor.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_insurance_factor(origin, pool_id: CurrencyId, new_amount_n: u128, new_amount_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\n\t\t\tlet new_insurance_factor = Rate::checked_from_rational(new_amount_n, new_amount_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\tControllerDates::\u003cT\u003e::mutate(pool_id, |r| r.insurance_factor = new_insurance_factor);\n\t\t\tSelf::deposit_event(Event::InsuranceFactorChanged);\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Set Maximum borrow rate.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_max_borrow_rate(origin, pool_id: CurrencyId, new_amount_n: u128, new_amount_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\n\t\t\tlet new_max_borow_rate = Rate::checked_from_rational(new_amount_n, new_amount_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\tensure!(!new_max_borow_rate.is_zero(), Error::\u003cT\u003e::MaxBorrowRateCannotBeZero);\n\n\t\t\tControllerDates::\u003cT\u003e::mutate(pool_id, |r| r.max_borrow_rate = new_max_borow_rate);\n\t\t\tSelf::deposit_event(Event::MaxBorrowRateChanged);\n\t\t\tOk(())\n\t\t}\n\t}\n}\n\ntype RateResult = result::Result\u003cRate, DispatchError\u003e;\ntype BalanceResult = result::Result\u003cBalance, DispatchError\u003e;\ntype LiquidityResult = result::Result\u003c(Balance, Balance), DispatchError\u003e;\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Applies accrued interest to total borrows and insurances.\n\t/// This calculates interest accrued from the last checkpointed block\n\t/// up to the current block and writes new checkpoint to storage.\n\tpub fn accrue_interest_rate(underlying_asset_id: CurrencyId) -\u003e DispatchResult {\n\t\t//Remember the initial block number.\n\t\tlet current_block_number = \u003cframe_system::Module\u003cT\u003e\u003e::block_number();\n\t\tlet accrual_block_number_previous = Self::controller_dates(underlying_asset_id).timestamp;\n\n\t\t//Short-circuit accumulating 0 interest.\n\t\tif current_block_number == accrual_block_number_previous {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\tlet current_total_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_available_liquidity(underlying_asset_id);\n\t\tlet current_total_borrowed_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_borrowed(underlying_asset_id);\n\t\tlet current_total_insurance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_insurance(underlying_asset_id);\n\t\tlet current_borrow_index = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_borrow_index(underlying_asset_id);\n\n\t\tlet utilization_rate = Self::calculate_utilization_rate(\n\t\t\tcurrent_total_balance,\n\t\t\tcurrent_total_borrowed_balance,\n\t\t\tcurrent_total_insurance,\n\t\t)?;\n\n\t\t// Calculate the current borrow interest rate\n\t\tlet current_borrow_interest_rate =\n\t\t\t\u003cMinterestModel\u003cT\u003e\u003e::calculate_borrow_interest_rate(underlying_asset_id, utilization_rate)?;\n\n\t\tlet max_borrow_rate = Self::get_max_borrow_rate(underlying_asset_id);\n\t\tlet insurance_factor = Self::get_insurance_factor(underlying_asset_id);\n\n\t\tensure!(\n\t\t\tcurrent_borrow_interest_rate \u003c= max_borrow_rate,\n\t\t\tError::\u003cT\u003e::BorrowRateIsTooHight\n\t\t);\n\n\t\t// Calculate the number of blocks elapsed since the last accrual\n\t\tlet block_delta = Self::calculate_block_delta(current_block_number, accrual_block_number_previous)?;\n\n\t\t/*\n\t\tCalculate the interest accumulated into borrows and insurance and the new index:\n\t\t\t*  simpleInterestFactor = borrowRate * blockDelta\n\t\t\t*  interestAccumulated = simpleInterestFactor * totalBorrows\n\t\t\t*  totalBorrowsNew = interestAccumulated + totalBorrows\n\t\t\t*  totalInsuranceNew = interestAccumulated * insuranceFactor + totalInsurance\n\t\t\t*  borrowIndexNew = simpleInterestFactor * borrowIndex + borrowIndex\n\t\t*/\n\n\t\tlet simple_interest_factor = Self::calculate_interest_factor(current_borrow_interest_rate, \u0026block_delta)?;\n\t\tlet interest_accumulated =\n\t\t\tSelf::calculate_interest_accumulated(simple_interest_factor, current_total_borrowed_balance)?;\n\t\tlet new_total_borrow_balance =\n\t\t\tSelf::calculate_new_total_borrow(interest_accumulated, current_total_borrowed_balance)?;\n\t\tlet new_total_insurance =\n\t\t\tSelf::calculate_new_total_insurance(interest_accumulated, insurance_factor, current_total_insurance)?;\n\t\tlet new_borrow_index = Self::calculate_new_borrow_index(simple_interest_factor, current_borrow_index)?;\n\n\t\t// Save new params\n\t\tControllerDates::\u003cT\u003e::mutate(underlying_asset_id, |x| x.timestamp = current_block_number);\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::set_accrual_interest_params(\n\t\t\tunderlying_asset_id,\n\t\t\tnew_total_borrow_balance,\n\t\t\tnew_total_insurance,\n\t\t)?;\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::set_pool_borrow_index(underlying_asset_id, new_borrow_index)?;\n\n\t\tOk(())\n\t}\n\n\t/// Return the borrow balance of account based on stored data.\n\t///\n\t/// - `who`: The address whose balance should be calculated.\n\t/// - `currency_id`: ID of the currency, the balance of borrowing of which we calculate.\n\tpub fn borrow_balance_stored(who: \u0026T::AccountId, underlying_asset_id: CurrencyId) -\u003e BalanceResult {\n\t\tlet user_borrow_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_user_total_borrowed(\u0026who, underlying_asset_id);\n\n\t\t// If borrow_balance = 0 then borrow_index is likely also 0.\n\t\t// Rather than failing the calculation with a division by 0, we immediately return 0 in this case.\n\t\tif user_borrow_balance.is_zero() {\n\t\t\treturn Ok(Balance::zero());\n\t\t};\n\n\t\tlet pool_borrow_index = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_borrow_index(underlying_asset_id);\n\t\tlet user_borrow_index = \u003cLiquidityPools\u003cT\u003e\u003e::get_user_borrow_index(\u0026who, underlying_asset_id);\n\n\t\t// Calculate new borrow balance using the borrow index:\n\t\t// recent_borrow_balance = user_borrow_balance * pool_borrow_index / user_borrow_index\n\t\tlet principal_times_index = Rate::from_inner(user_borrow_balance)\n\t\t\t.checked_mul(\u0026pool_borrow_index)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tlet result = Rate::from_inner(principal_times_index)\n\t\t\t.checked_div(\u0026user_borrow_index)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(result)\n\t}\n\n\t/// Determine what the account liquidity would be if the given amounts were redeemed/borrowed.\n\t///\n\t/// - `account`: The account to determine liquidity.\n\t/// - `underlying_asset_id`: The pool to hypothetically redeem/borrow.\n\t/// - `redeem_amount`: The number of tokens to hypothetically redeem.\n\t/// - `borrow_amount`: The amount of underlying to hypothetically borrow.\n\t/// Returns (hypothetical account liquidity in excess of collateral requirements,\n\t///          hypothetical account shortfall below collateral requirements).\n\tpub fn get_hypothetical_account_liquidity(\n\t\taccount: \u0026T::AccountId,\n\t\tunderlying_to_borrow: CurrencyId,\n\t\tredeem_amount: Balance,\n\t\tborrow_amount: Balance,\n\t) -\u003e LiquidityResult {\n\t\tensure!(!(borrow_amount \u003e 0 \u0026\u0026 redeem_amount \u003e 0), Error::\u003cT\u003e::ParametersError);\n\n\t\tlet m_tokens_ids: Vec\u003cCurrencyId\u003e = \u003cT as liquidity_pools::Trait\u003e::EnabledCurrencyPair::get()\n\t\t\t.iter()\n\t\t\t.map(|currency_pair| currency_pair.wrapped_id)\n\t\t\t.collect();\n\n\t\tlet mut sum_collateral = Balance::zero();\n\t\tlet mut sum_borrow_plus_effects = Balance::zero();\n\n\t\t// For each tokens the account is in\n\t\tfor asset in m_tokens_ids.into_iter() {\n\t\t\tlet underlying_asset = \u003cLiquidityPools\u003cT\u003e\u003e::get_underlying_asset_id_by_wrapped_id(\u0026asset)?;\n\n\t\t\t// Read the balances and exchange rate from the cToken\n\t\t\tlet borrow_balance = Self::borrow_balance_stored(account, underlying_asset)?;\n\t\t\tlet exchange_rate = \u003cLiquidityPools\u003cT\u003e\u003e::get_exchange_rate(underlying_asset)?;\n\t\t\tlet collateral_factor = Self::get_collateral_factor(underlying_asset);\n\n\t\t\t// Get the normalized price of the asset.\n\t\t\tlet oracle_price =\n\t\t\t\t\u003cOracle\u003cT\u003e\u003e::get_underlying_price(underlying_asset).map_err(|_| Error::\u003cT\u003e::OraclePriceError)?;\n\n\t\t\tif oracle_price.is_zero() {\n\t\t\t\treturn Ok((Balance::zero(), Balance::zero()));\n\t\t\t}\n\n\t\t\t// Pre-compute a conversion factor from tokens -\u003e dollars (normalized price value)\n\t\t\t// tokens_to_denom = collateral_factor * exchange_rate * oracle_price\n\t\t\tlet tokens_to_denom = collateral_factor\n\t\t\t\t.checked_mul(\u0026exchange_rate)\n\t\t\t\t.and_then(|v| v.checked_mul(\u0026oracle_price))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\tif \u003cLiquidityPools\u003cT\u003e\u003e::check_user_available_collateral(\u0026account, underlying_asset) {\n\t\t\t\tlet m_token_balance = T::MultiCurrency::free_balance(asset, account);\n\n\t\t\t\t// sum_collateral += tokens_to_denom * m_token_balance\n\t\t\t\tsum_collateral =\n\t\t\t\t\tSelf::mul_price_and_balance_add_to_prev_value(sum_collateral, m_token_balance, tokens_to_denom)?;\n\t\t\t}\n\n\t\t\t// sum_borrow_plus_effects += oracle_price * borrow_balance\n\t\t\tsum_borrow_plus_effects =\n\t\t\t\tSelf::mul_price_and_balance_add_to_prev_value(sum_borrow_plus_effects, borrow_balance, oracle_price)?;\n\n\t\t\t// Calculate effects of interacting with Underlying Asset Modify.\n\t\t\tif underlying_to_borrow == underlying_asset {\n\t\t\t\t// redeem effect\n\t\t\t\tif redeem_amount \u003e 0 {\n\t\t\t\t\t// sum_borrow_plus_effects += tokens_to_denom * redeem_tokens\n\t\t\t\t\tsum_borrow_plus_effects = Self::mul_price_and_balance_add_to_prev_value(\n\t\t\t\t\t\tsum_borrow_plus_effects,\n\t\t\t\t\t\tredeem_amount,\n\t\t\t\t\t\ttokens_to_denom,\n\t\t\t\t\t)?;\n\t\t\t\t};\n\t\t\t\t// borrow effect\n\t\t\t\tif borrow_amount \u003e 0 {\n\t\t\t\t\t// sum_borrow_plus_effects += oracle_price * borrow_amount\n\t\t\t\t\tsum_borrow_plus_effects = Self::mul_price_and_balance_add_to_prev_value(\n\t\t\t\t\t\tsum_borrow_plus_effects,\n\t\t\t\t\t\tborrow_amount,\n\t\t\t\t\t\toracle_price,\n\t\t\t\t\t)?;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tmatch sum_collateral.cmp(\u0026sum_borrow_plus_effects) {\n\t\t\tOrdering::Greater =\u003e Ok((\n\t\t\t\tsum_collateral\n\t\t\t\t\t.checked_sub(sum_borrow_plus_effects)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::InsufficientLiquidity)?,\n\t\t\t\t0,\n\t\t\t)),\n\t\t\t_ =\u003e Ok((\n\t\t\t\t0,\n\t\t\t\tsum_borrow_plus_effects\n\t\t\t\t\t.checked_sub(sum_collateral)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::InsufficientLiquidity)?,\n\t\t\t)),\n\t\t}\n\t}\n\n\t/// Checks if the account should be allowed to redeem tokens in the given pool.\n\t///\n\t/// - `underlying_asset_id` - The CurrencyId to verify the redeem against.\n\t/// - `redeemer` -  The account which would redeem the tokens.\n\t/// - `redeem_amount` - The number of mTokens to exchange for the underlying asset in the\n\t/// pool.\n\t///\n\t/// Return Ok if the redeem is allowed.\n\tpub fn redeem_allowed(\n\t\tunderlying_asset_id: CurrencyId,\n\t\tredeemer: \u0026T::AccountId,\n\t\tredeem_amount: Balance,\n\t) -\u003e DispatchResult {\n\t\tif LiquidityPools::\u003cT\u003e::check_user_available_collateral(\u0026redeemer, underlying_asset_id) {\n\t\t\tlet (_, shortfall) =\n\t\t\t\tSelf::get_hypothetical_account_liquidity(\u0026redeemer, underlying_asset_id, redeem_amount, 0)?;\n\n\t\t\tensure!(!(shortfall \u003e 0), Error::\u003cT\u003e::InsufficientLiquidity);\n\t\t}\n\n\t\tOk(())\n\t}\n\n\t/// Checks if the account should be allowed to borrow the underlying asset of the given pool.\n\t///\n\t/// - `underlying_asset_id` - The CurrencyId to verify the borrow against.\n\t/// - `who` -  The account which would borrow the asset.\n\t/// - `borrow_amount` - The amount of underlying assets the account would borrow.\n\t///\n\t/// Return Ok if the borrow is allowed.\n\tpub fn borrow_allowed(\n\t\tunderlying_asset_id: CurrencyId,\n\t\twho: \u0026T::AccountId,\n\t\tborrow_amount: Balance,\n\t) -\u003e DispatchResult {\n\t\t//FIXME: add borrowCap checking\n\n\t\tlet (_, shortfall) = Self::get_hypothetical_account_liquidity(\u0026who, underlying_asset_id, 0, borrow_amount)?;\n\n\t\tensure!(!(shortfall \u003e 0), Error::\u003cT\u003e::InsufficientLiquidity);\n\n\t\tOk(())\n\t}\n\n\t/// Checks if a specific operation is allowed on a pool.\n\t///\n\t/// Return true - if operation is allowed, false - if operation is unallowed.\n\tpub fn is_operation_allowed(pool_id: CurrencyId, operation: Operation) -\u003e bool {\n\t\tmatch operation {\n\t\t\tOperation::Deposit =\u003e !Self::pause_keepers(pool_id).deposit_paused,\n\t\t\tOperation::Redeem =\u003e !Self::pause_keepers(pool_id).redeem_paused,\n\t\t\tOperation::Borrow =\u003e !Self::pause_keepers(pool_id).borrow_paused,\n\t\t\tOperation::Repay =\u003e !Self::pause_keepers(pool_id).repay_paused,\n\t\t}\n\t}\n}\n\n// RPC methods\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Gets the exchange rate between a mToken and the underlying asset.\n\tpub fn get_liquidity_pool_exchange_rate(pool_id: CurrencyId) -\u003e Option\u003cRate\u003e {\n\t\tlet exchange_rate = \u003cLiquidityPools\u003cT\u003e\u003e::get_exchange_rate(pool_id).ok()?;\n\t\tSome(exchange_rate)\n\t}\n\n\t/// Gets borrow interest rate and supply interest rate.\n\tpub fn get_liquidity_pool_borrow_and_supply_rates(pool_id: CurrencyId) -\u003e Option\u003c(Rate, Rate)\u003e {\n\t\tlet current_total_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_available_liquidity(pool_id);\n\t\tlet current_total_borrowed_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_borrowed(pool_id);\n\t\tlet current_total_insurance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_insurance(pool_id);\n\t\tlet insurance_factor = Self::get_insurance_factor(pool_id);\n\n\t\tlet utilization_rate = Self::calculate_utilization_rate(\n\t\t\tcurrent_total_balance,\n\t\t\tcurrent_total_borrowed_balance,\n\t\t\tcurrent_total_insurance,\n\t\t)\n\t\t.ok()?;\n\n\t\tlet borrow_rate = \u003cMinterestModel\u003cT\u003e\u003e::calculate_borrow_interest_rate(pool_id, utilization_rate).ok()?;\n\n\t\tlet supply_rate = Self::calculate_supply_interest_rate(utilization_rate, borrow_rate, insurance_factor).ok()?;\n\n\t\tSome((borrow_rate, supply_rate))\n\t}\n}\n\n// Private methods\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Calculates the utilization rate of the pool.\n\t/// - `current_total_balance`: The amount of cash in the pool.\n\t/// - `current_total_borrowed_balance`: The amount of borrows in the pool.\n\t/// - `current_total_insurance`: The amount of insurance in the pool (currently unused).\n\t///\n\t/// returns `utilization_rate = total_borrows / (total_cash + total_borrows - total_insurance)`\n\tfn calculate_utilization_rate(\n\t\tcurrent_total_balance: Balance,\n\t\tcurrent_total_borrowed_balance: Balance,\n\t\tcurrent_total_insurance: Balance,\n\t) -\u003e RateResult {\n\t\t// Utilization rate is 0 when there are no borrows\n\t\tif current_total_borrowed_balance.is_zero() {\n\t\t\treturn Ok(Rate::zero());\n\t\t}\n\n\t\t// utilization_rate = current_total_borrowed_balance / (current_total_balance +\n\t\t// + current_total_borrowed_balance - current_total_insurance)\n\t\tlet utilization_rate = Rate::checked_from_rational(\n\t\t\tcurrent_total_borrowed_balance,\n\t\t\tcurrent_total_balance\n\t\t\t\t.checked_add(current_total_borrowed_balance)\n\t\t\t\t.and_then(|v| v.checked_sub(current_total_insurance))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?,\n\t\t)\n\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(utilization_rate)\n\t}\n\n\t/// Calculates the current supply interest rate of the pool.\n\t/// - `utilization_rate`: Current utilization rate.\n\t/// - `borrow_rate`: Current interest rate that users pay for lending assets.\n\t/// - `insurance_factor`: Current insurance factor.\n\t///\n\t/// returns `supply_interest_rate = utilization_rate * (borrow_rate * (1 - insurance_factor))`\n\tfn calculate_supply_interest_rate(utilization_rate: Rate, borrow_rate: Rate, insurance_factor: Rate) -\u003e RateResult {\n\t\tlet supply_interest_rate = Rate::one()\n\t\t\t.checked_sub(\u0026insurance_factor)\n\t\t\t.and_then(|v| v.checked_mul(\u0026borrow_rate))\n\t\t\t.and_then(|v| v.checked_mul(\u0026utilization_rate))\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(supply_interest_rate)\n\t}\n\n\t/// Calculates the number of blocks elapsed since the last accrual.\n\t/// - `current_block_number`: Current block number.\n\t/// - `accrual_block_number_previous`: Number of the last block with accruals.\n\t///\n\t/// returns `current_block_number - accrual_block_number_previous`\n\tfn calculate_block_delta(\n\t\tcurrent_block_number: T::BlockNumber,\n\t\taccrual_block_number_previous: T::BlockNumber,\n\t) -\u003e result::Result\u003cT::BlockNumber, DispatchError\u003e {\n\t\tensure!(\n\t\t\tcurrent_block_number \u003e= accrual_block_number_previous,\n\t\t\tError::\u003cT\u003e::NumOverflow\n\t\t);\n\n\t\tOk(current_block_number - accrual_block_number_previous)\n\t}\n\n\t/// Calculates the simple interest factor.\n\t/// - `current_borrow_interest_rate`: Current interest rate that users pay for lending assets.\n\t/// - `block_delta`: The number of blocks elapsed since the last accrual.\n\t///\n\t/// returns `interest_factor = current_borrow_interest_rate * block_delta`.\n\tfn calculate_interest_factor(\n\t\tcurrent_borrow_interest_rate: Rate,\n\t\tblock_delta: \u0026\u003cT as system::Trait\u003e::BlockNumber,\n\t) -\u003e RateResult {\n\t\tlet block_delta_as_usize = TryInto::try_into(*block_delta)\n\t\t\t.ok()\n\t\t\t.expect(\"blockchain will not exceed 2^32 blocks; qed\");\n\n\t\tlet interest_factor = Rate::saturating_from_rational(block_delta_as_usize as u128, 1)\n\t\t\t.checked_mul(\u0026current_borrow_interest_rate)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(interest_factor)\n\t}\n\n\t/// Calculate the interest accumulated into borrows.\n\t///\n\t/// returns `interest_accumulated = simple_interest_factor * current_total_borrowed_balance`\n\tfn calculate_interest_accumulated(\n\t\tsimple_interest_factor: Rate,\n\t\tcurrent_total_borrowed_balance: Balance,\n\t) -\u003e BalanceResult {\n\t\tlet interest_accumulated = Rate::from_inner(current_total_borrowed_balance)\n\t\t\t.checked_mul(\u0026simple_interest_factor)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(interest_accumulated)\n\t}\n\n\t/// Calculates the new total borrow.\n\t/// - `interest_accumulated`: Accrued interest on the borrower's loan.\n\t/// - `current_total_borrowed_balance`: The amount of borrows in the pool.\n\t///\n\t/// returns `new_total_borrows = interest_accumulated + total_borrows`\n\tfn calculate_new_total_borrow(\n\t\tinterest_accumulated: Balance,\n\t\tcurrent_total_borrowed_balance: Balance,\n\t) -\u003e BalanceResult {\n\t\tlet new_total_borrows = interest_accumulated\n\t\t\t.checked_add(current_total_borrowed_balance)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(new_total_borrows)\n\t}\n\n\t/// Calculates new total insurance.\n\t/// - `interest_accumulated`: Accrued interest on the borrower's loan.\n\t/// - `insurance_factor`: The portion of borrower interest that is converted into insurance\n\t/// - `current_total_insurance`: The amount of insurance in the pool (currently unused).\n\t///\n\t/// returns `total_insurance_new = interest_accumulated * insurance_factor + total_insurance`\n\tfn calculate_new_total_insurance(\n\t\tinterest_accumulated: Balance,\n\t\tinsurance_factor: Rate,\n\t\tcurrent_total_insurance: Balance,\n\t) -\u003e BalanceResult {\n\t\t// insurance_accumulated = interest_accumulated * insurance_factor\n\t\tlet insurance_accumulated = Rate::from_inner(interest_accumulated)\n\t\t\t.checked_mul(\u0026insurance_factor)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t// total_insurance_new = insurance_accumulated + current_total_insurance\n\t\tlet total_insurance_new = insurance_accumulated\n\t\t\t.checked_add(current_total_insurance)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(total_insurance_new)\n\t}\n\n\t/// Calculates new borrow index.\n\t///\n\t/// returns `new_borrow_index = simple_interest_factor * borrow_index + borrow_index`\n\tfn calculate_new_borrow_index(simple_interest_factor: Rate, current_borrow_index: Rate) -\u003e RateResult {\n\t\tlet new_borrow_index = simple_interest_factor\n\t\t\t.checked_mul(\u0026current_borrow_index)\n\t\t\t.and_then(|v| v.checked_add(\u0026current_borrow_index))\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(new_borrow_index)\n\t}\n\n\t/// Performs mathematical calculations.\n\t///\n\t/// returns `value = value + balance_scalar * rate_scalar`\n\tfn mul_price_and_balance_add_to_prev_value(\n\t\tvalue: Balance,\n\t\tbalance_scalar: Balance,\n\t\trate_scalar: Rate,\n\t) -\u003e BalanceResult {\n\t\tlet result = value\n\t\t\t.checked_add(\n\t\t\t\tRate::from_inner(balance_scalar)\n\t\t\t\t\t.checked_mul(\u0026rate_scalar)\n\t\t\t\t\t.map(|x| x.into_inner())\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?,\n\t\t\t)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(result)\n\t}\n}\n\n// Storage getters for Controller Data\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Determines how much a user can borrow.\n\tfn get_collateral_factor(pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::controller_dates(pool_id).collateral_factor\n\t}\n\n\t/// Gets the maximum borrow rate.\n\tfn get_max_borrow_rate(pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::controller_dates(pool_id).max_borrow_rate\n\t}\n\n\t/// Get the insurance factor.\n\tfn get_insurance_factor(pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::controller_dates(pool_id).insurance_factor\n\t}\n}\n\n// Admin functions\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t// FIXME It is possible to remove this function\n\t/// Replenishes the insurance balance.\n\t/// - `who`: Account ID of the administrator who replenishes the insurance.\n\t/// - `pool_id`: Pool ID of the replenishing pool.\n\t/// - `amount`: Amount to replenish insurance in the pool.\n\tfn do_deposit_insurance(who: \u0026T::AccountId, pool_id: CurrencyId, amount: Balance) -\u003e DispatchResult {\n\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\n\t\tensure!(\n\t\t\tamount \u003c= T::MultiCurrency::free_balance(pool_id, \u0026who),\n\t\t\tError::\u003cT\u003e::NotEnoughBalance\n\t\t);\n\n\t\t// transfer amount to this pool\n\t\tT::MultiCurrency::transfer(pool_id, \u0026who, \u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(), amount)?;\n\n\t\t// calculate new insurance balance\n\t\tlet current_insurance_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_insurance(pool_id);\n\n\t\tlet new_insurance_balance = current_insurance_balance\n\t\t\t.checked_add(amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::BalanceOverflowed)?;\n\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::set_pool_total_insurance(pool_id, new_insurance_balance)?;\n\n\t\tOk(())\n\t}\n\n\t/// Burns the insurance balance.\n\t/// - `who`: Account ID of the administrator who burns the insurance.\n\t/// - `pool_id`: Pool ID in which the insurance is decreasing.\n\t/// - `amount`: Amount to redeem insurance in the pool.\n\tfn do_redeem_insurance(who: \u0026T::AccountId, pool_id: CurrencyId, amount: Balance) -\u003e DispatchResult {\n\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\n\t\tensure!(\n\t\t\tamount \u003c= T::MultiCurrency::free_balance(pool_id, \u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id()),\n\t\t\tError::\u003cT\u003e::NotEnoughBalance\n\t\t);\n\n\t\t// calculate new insurance balance\n\t\tlet current_total_insurance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_insurance(pool_id);\n\t\tensure!(amount \u003c= current_total_insurance, Error::\u003cT\u003e::NotEnoughBalance);\n\n\t\tlet new_insurance_balance = current_total_insurance\n\t\t\t.checked_sub(amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NotEnoughBalance)?;\n\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::set_pool_total_insurance(pool_id, new_insurance_balance)?;\n\n\t\t// transfer amount from this pool\n\t\tT::MultiCurrency::transfer(pool_id, \u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(), \u0026who, amount)?;\n\n\t\tOk(())\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","src","mock.rs"],"content":"#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse liquidity_pools::{Pool, PoolUserData};\npub use minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\nuse orml_currencies::Currency;\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{IdentityLookup, Zero},\n\tModuleId, Perbill,\n};\n\nuse super::*;\nuse minterest_model::MinterestModelData;\n\nmod controller {\n\tpub use crate::Event;\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e,\n\t\torml_currencies\u003cT\u003e,\n\t\tliquidity_pools,\n\t\tcontroller,\n\t\toracle,\n\t\taccounts\u003cT\u003e,\n\t\tminterest_model,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\n\n// For testing the module, we construct most of a mock runtime. This means\n// first constructing a configuration type (`Runtime`) which `impl`s each of the\n// configuration traits of modules we want to use.\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n}\n\npub type AccountId = u32;\nimpl system::Trait for Runtime {\n\ttype BaseCallFilter = ();\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n}\n\ntype Amount = i128;\n\nimpl orml_tokens::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\ntype NativeCurrency = Currency\u003cRuntime, GetNativeCurrencyId\u003e;\n\nimpl orml_currencies::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cRuntime\u003e;\n\ttype NativeCurrency = NativeCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl liquidity_pools::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cRuntime\u003e;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\nimpl oracle::Trait for Runtime {\n\ttype Event = TestEvent;\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = MAX_MEMBERS;\n}\n\nimpl accounts::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MaxMembers = MaxMembers;\n}\n\nparameter_types! {\n\tpub const BlocksPerYear: u128 = 5256000u128;\n}\n\nimpl minterest_model::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype BlocksPerYear = BlocksPerYear;\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n}\n\npub type BlockNumber = u64;\n\npub type Controller = Module\u003cRuntime\u003e;\npub type TestPools = liquidity_pools::Module\u003cRuntime\u003e;\npub type System = frame_system::Module\u003cRuntime\u003e;\npub type Currencies = orml_currencies::Module\u003cRuntime\u003e;\npub const MAX_MEMBERS: u32 = 16;\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n\tpools: Vec\u003c(CurrencyId, Pool)\u003e,\n\tpool_user_data: Vec\u003c(CurrencyId, AccountId, PoolUserData)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t\tpools: vec![],\n\t\t\tpool_user_data: vec![],\n\t\t}\n\t}\n}\n\npub const ALICE: AccountId = 1;\npub fn alice() -\u003e Origin {\n\tOrigin::signed(ALICE)\n}\npub const BOB: AccountId = 2;\npub fn bob() -\u003e Origin {\n\tOrigin::signed(BOB)\n}\npub const ONE_HUNDRED: Balance = 100;\npub const DOLLARS: Balance = 1_000_000_000_000_000_000;\npub fn dollars\u003cT: Into\u003cu128\u003e\u003e(d: T) -\u003e Balance {\n\tDOLLARS.saturating_mul(d.into())\n}\n\nimpl ExtBuilder {\n\tpub fn user_balance(mut self, user: AccountId, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts.push((user, currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn pool_balance(mut self, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts\n\t\t\t.push((TestPools::pools_account_id(), currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn pool_total_borrowed(mut self, pool_id: CurrencyId, total_borrowed: Balance) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_total_insurance(mut self, pool_id: CurrencyId, total_insurance: Balance) -\u003e Self {\n\t\tself.endowed_accounts\n\t\t\t.push((TestPools::pools_account_id(), pool_id, total_insurance));\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\ttotal_insurance,\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_mock(mut self, pool_id: CurrencyId) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\tborrow_index: Rate::saturating_from_rational(2, 1),\n\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_user_data(\n\t\tmut self,\n\t\tpool_id: CurrencyId,\n\t\tuser: AccountId,\n\t\ttotal_borrowed: Balance,\n\t\tinterest_index: Rate,\n\t\tcollateral: bool,\n\t) -\u003e Self {\n\t\tself.pool_user_data.push((\n\t\t\tpool_id,\n\t\t\tuser,\n\t\t\tPoolUserData {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tinterest_index,\n\t\t\t\tcollateral,\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn alice_deposit_60_dot(self) -\u003e Self {\n\t\tself.user_balance(ALICE, CurrencyId::DOT, dollars(40_u128))\n\t\t\t.user_balance(ALICE, CurrencyId::MDOT, dollars(60_u128))\n\t\t\t.pool_balance(CurrencyId::DOT, dollars(60_u128))\n\t\t\t.pool_mock(CurrencyId::DOT)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, Balance::zero(), Rate::zero(), false)\n\t}\n\n\tpub fn alice_deposit_20_eth(self) -\u003e Self {\n\t\tself.user_balance(ALICE, CurrencyId::ETH, dollars(80_u128))\n\t\t\t.user_balance(ALICE, CurrencyId::METH, dollars(20_u128))\n\t\t\t.pool_balance(CurrencyId::ETH, dollars(20_u128))\n\t\t\t.pool_mock(CurrencyId::ETH)\n\t\t\t.pool_user_data(CurrencyId::ETH, ALICE, Balance::zero(), Rate::zero(), false)\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tGenesisConfig::\u003cRuntime\u003e {\n\t\t\tcontroller_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpause_keepers: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: true,\n\t\t\t\t\t\tredeem_paused: true,\n\t\t\t\t\t\tborrow_paused: true,\n\t\t\t\t\t\trepay_paused: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tliquidity_pools::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tpools: self.pools,\n\t\t\tpool_user_data: self.pool_user_data,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\taccounts::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tallowed_accounts: vec![(ALICE, ())],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tminterest_model::GenesisConfig {\n\t\t\tminterest_model_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","src","tests.rs"],"content":"//! Tests for the controller pallet.\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_err, assert_noop, assert_ok};\n\n#[test]\nfn accrue_interest_should_work() {\n\tExtBuilder::default()\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(80_u128))\n\t\t.pool_mock(CurrencyId::BTC)\n\t\t.pool_balance(CurrencyId::DOT, dollars(20_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Controller::accrue_interest_rate(CurrencyId::DOT));\n\n\t\t\tassert_eq!(Controller::controller_dates(CurrencyId::DOT).timestamp, 1);\n\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, 57_600_000_000);\n\t\t\tassert_eq!(\n\t\t\t\tController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT),\n\t\t\t\tSome((Rate::from_inner(139_680_000_267), Rate::from_inner(100_569_600_394)))\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t80_000_000_576_000_000_000\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::pools(CurrencyId::DOT).borrow_index,\n\t\t\t\tRate::from_inner(1_000_000_007_200_000_000)\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn accrue_interest_should_not_work() {\n\tExtBuilder::default()\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(80_u128))\n\t\t.pool_balance(CurrencyId::DOT, dollars(20_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Controller::accrue_interest_rate(CurrencyId::DOT));\n\t\t\tassert_eq!(Controller::controller_dates(CurrencyId::DOT).timestamp, 1);\n\n\t\t\tassert_ok!(Controller::set_max_borrow_rate(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\t1,\n\t\t\t\t1_000_000_000\n\t\t\t));\n\n\t\t\tSystem::set_block_number(20);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::accrue_interest_rate(CurrencyId::DOT),\n\t\t\t\tError::\u003cRuntime\u003e::BorrowRateIsTooHight\n\t\t\t);\n\n\t\t\tassert_ok!(Controller::set_max_borrow_rate(alice(), CurrencyId::DOT, 2, 1));\n\n\t\t\tassert_ok!(Controller::accrue_interest_rate(CurrencyId::DOT));\n\t\t});\n}\n\n#[test]\nfn calculate_block_delta_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// block_delta = 10 - 5 = 5\n\t\tassert_eq!(Controller::calculate_block_delta(10, 5), Ok(5));\n\n\t\t// Overflow in calculation: 5 - 10 = -5 \u003c 0\n\t\tassert_noop!(Controller::calculate_block_delta(5, 10), Error::\u003cRuntime\u003e::NumOverflow);\n\t});\n}\n\n#[test]\nfn calculate_interest_factor_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// interest_factor = 0.1 * 25 = 2.5\n\t\tassert_eq!(\n\t\t\tController::calculate_interest_factor(Rate::saturating_from_rational(1, 10), \u002625),\n\t\t\tOk(Rate::saturating_from_rational(25, 10))\n\t\t);\n\n\t\t// Overflow in calculation: block_delta * borrow_interest_rate\n\t\tassert_noop!(\n\t\t\tController::calculate_interest_factor(Rate::from_inner(u128::max_value()), \u002620),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_interest_accumulated_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// interest_accumulated = 0 * 100 = 0\n\t\tassert_eq!(\n\t\t\tController::calculate_interest_accumulated(Rate::from_inner(0), 100),\n\t\t\tOk(0)\n\t\t);\n\n\t\t// interest_accumulated = 0.03 * 200 = 6\n\t\tassert_eq!(\n\t\t\tController::calculate_interest_accumulated(\n\t\t\t\tRate::saturating_from_rational(3, 100), // eq 0.03 == 3%\n\t\t\t\t200\n\t\t\t),\n\t\t\tOk(6)\n\t\t);\n\n\t\t// Overflow in calculation: 1.1 * max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_interest_accumulated(Rate::saturating_from_rational(11, 10), Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_new_total_borrow_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// new_total_borrows = 15 + 100 = 115\n\t\tassert_eq!(Controller::calculate_new_total_borrow(15, 100), Ok(115));\n\n\t\t// Overflow in calculation: 1 + max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_new_total_borrow(1, Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_new_total_insurance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// total_insurance_new = 100 * 1.2 + 250 = 370\n\t\tassert_eq!(\n\t\t\tController::calculate_new_total_insurance(100, Rate::saturating_from_rational(12, 10), 250),\n\t\t\tOk(370)\n\t\t);\n\t\t// Overflow in calculation: max_value() * 1.1\n\t\tassert_noop!(\n\t\t\tController::calculate_new_total_insurance(Balance::max_value(), Rate::saturating_from_rational(11, 10), 1),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t\t// Overflow in calculation: 100 * 1.1 + max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_new_total_insurance(100, Rate::saturating_from_rational(1, 1), Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn borrow_balance_stored_with_zero_balance_should_work() {\n\tExtBuilder::default()\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, Balance::zero(), Rate::from_inner(0), true)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// If borrow_balance = 0 then borrow_index is likely also 0, return Ok(0)\n\t\t\tassert_eq!(\n\t\t\t\tController::borrow_balance_stored(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tOk(Balance::zero())\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn borrow_balance_stored_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, 100, Rate::saturating_from_rational(4, 1), true)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// recent_borrow_balance = 100 * 2 / 4 = 50\n\t\t\tassert_eq!(Controller::borrow_balance_stored(\u0026ALICE, CurrencyId::DOT), Ok(50));\n\t\t});\n}\n\n#[test]\nfn borrow_balance_stored_fails_if_num_overflow() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.pool_user_data(\n\t\t\tCurrencyId::DOT,\n\t\t\tALICE,\n\t\t\tBalance::max_value(),\n\t\t\tRate::saturating_from_rational(2, 1),\n\t\t\ttrue,\n\t\t)\n\t\t.pool_mock(CurrencyId::BTC)\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, 100, Rate::from_inner(0), true)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_noop!(\n\t\t\t\tController::borrow_balance_stored(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn calculate_utilization_rate_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// if current_total_borrowed_balance == 0 then return Ok(0)\n\t\tassert_eq!(\n\t\t\tController::calculate_utilization_rate(100, 0, 60),\n\t\t\tOk(Rate::from_inner(0))\n\t\t);\n\t\t// utilization_rate = 80 / (22 + 80 - 2) = 0.8\n\t\tassert_eq!(\n\t\t\tController::calculate_utilization_rate(22, 80, 2),\n\t\t\tOk(Rate::saturating_from_rational(8, 10))\n\t\t);\n\n\t\t// Overflow in calculation: total_balance + total_borrowed = max_value() + 80\n\t\tassert_noop!(\n\t\t\tController::calculate_utilization_rate(Balance::max_value(), 80, 2),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: total_balance_total_borrowed_sum - total_insurance = ... - max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_utilization_rate(22, 80, Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: total_borrows / 0\n\t\tassert_noop!(\n\t\t\tController::calculate_utilization_rate(100, 70, 170),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_supply_rate_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// supply_rate = 0.75 * 0.23 * (1 - 0.1) = 0.15525\n\t\tassert_eq!(\n\t\t\tController::calculate_supply_interest_rate(\n\t\t\t\tRate::saturating_from_rational(75, 100),\n\t\t\t\tRate::saturating_from_rational(23, 100),\n\t\t\t\tRate::saturating_from_rational(1, 10)\n\t\t\t),\n\t\t\tOk(Rate::saturating_from_rational(15525, 100_000))\n\t\t);\n\n\t\t// Overflow in calculation: one_minus_insurance_factor = 1 - 2\n\t\tassert_noop!(\n\t\t\tController::calculate_supply_interest_rate(\n\t\t\t\tRate::saturating_from_rational(75, 100),\n\t\t\t\tRate::saturating_from_rational(23, 100),\n\t\t\t\tRate::saturating_from_rational(2, 1)\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: max_value() * 2.3 * (1 - 0.1)\n\t\tassert_noop!(\n\t\t\tController::calculate_supply_interest_rate(\n\t\t\t\tRate::from_inner(u128::max_value()),\n\t\t\t\tRate::saturating_from_rational(23, 10),\n\t\t\t\tRate::saturating_from_rational(1, 10)\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_new_borrow_index_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// new_borrow_index = 0.0000063 * 1.28 + 1.28 = 1.280000008064\n\t\tassert_eq!(\n\t\t\tController::calculate_new_borrow_index(\n\t\t\t\tRate::saturating_from_rational(63u128, 10_000_000_000u128),\n\t\t\t\tRate::saturating_from_rational(128, 100)\n\t\t\t),\n\t\t\tOk(Rate::from_inner(1_280_000_008_064_000_000))\n\t\t);\n\n\t\t// Overflow in calculation: simple_interest_factor * max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_new_borrow_index(\n\t\t\t\tRate::saturating_from_rational(12, 10),\n\t\t\t\tRate::from_inner(u128::max_value())\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: simple_interest_factor_mul_borrow_index + max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_new_borrow_index(\n\t\t\t\tRate::saturating_from_rational(1, 1),\n\t\t\t\tRate::from_inner(u128::max_value())\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn mul_price_and_balance_add_to_prev_value_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// 20 + 20 * 0.9 = 38\n\t\tassert_eq!(\n\t\t\tController::mul_price_and_balance_add_to_prev_value(20, 20, Rate::saturating_from_rational(9, 10)),\n\t\t\tOk(38)\n\t\t);\n\t\t// 120_000 + 85_000 * 0.87 = 193_950\n\t\tassert_eq!(\n\t\t\tController::mul_price_and_balance_add_to_prev_value(\n\t\t\t\t120_000,\n\t\t\t\t85_000,\n\t\t\t\tRate::saturating_from_rational(87, 100)\n\t\t\t),\n\t\t\tOk(193950)\n\t\t);\n\n\t\t// Overflow in calculation: max_value() * 1.9\n\t\tassert_noop!(\n\t\t\tController::mul_price_and_balance_add_to_prev_value(\n\t\t\t\t100,\n\t\t\t\tBalance::max_value(),\n\t\t\t\tRate::saturating_from_rational(19, 10)\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: max_value() + 100 * 1.9\n\t\tassert_noop!(\n\t\t\tController::mul_price_and_balance_add_to_prev_value(\n\t\t\t\tBalance::max_value(),\n\t\t\t\t100,\n\t\t\t\tRate::saturating_from_rational(19, 10)\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn get_hypothetical_account_liquidity_when_m_tokens_balance_is_zero_should_work() {\n\tExtBuilder::default()\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, Balance::zero(), Rate::from_inner(0), true)\n\t\t.pool_user_data(CurrencyId::BTC, BOB, Balance::zero(), Rate::from_inner(0), false)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Checking the function when called from redeem.\n\t\t\t// The function should return the shortfall to a large zero.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 5, 0),\n\t\t\t\tOk((0, 9))\n\t\t\t);\n\t\t\t// Checking the function when called from borrow.\n\t\t\t// The function should return the shortfall to a large zero.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 0, 10),\n\t\t\t\tOk((0, 20))\n\t\t\t);\n\t\t\t// Checking scenario: the user tries to take a borrow in a currency which is not\n\t\t\t// pool as available for collateral, and he fails.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026BOB, CurrencyId::BTC, 0, 10),\n\t\t\t\tOk((0, 20))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_hypothetical_account_liquidity_one_currency_from_redeem_should_work() {\n\tExtBuilder::default().alice_deposit_60_dot().build().execute_with(|| {\n\t\t// Checking the function when called from redeem.\n\t\t// collateral parameter is set to false, user can't redeem.\n\t\tassert_eq!(\n\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 5, 0),\n\t\t\tOk((0, 9))\n\t\t);\n\t\tassert_eq!(\n\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 60, 0),\n\t\t\tOk((0, 108))\n\t\t);\n\t\tassert_eq!(\n\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 200, 0),\n\t\t\tOk((0, 360))\n\t\t);\n\t});\n}\n\n#[test]\nfn get_hypothetical_account_liquidity_two_currencies_from_redeem_should_work() {\n\tExtBuilder::default()\n\t\t.alice_deposit_60_dot()\n\t\t.alice_deposit_20_eth()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Checking the function when called from redeem.\n\t\t\t// collateral parameter is set to false, user can't redeem.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::ETH, 15, 0),\n\t\t\t\tOk((0, 27))\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::ETH, 80, 0),\n\t\t\t\tOk((0, 144))\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::ETH, 100, 0),\n\t\t\t\tOk((0, 180))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_hypothetical_account_liquidity_two_currencies_from_borrow_should_work() {\n\tExtBuilder::default()\n\t\t.alice_deposit_20_eth()\n\t\t// ALICE deposit 60 DOT and borrow 30 DOT\n\t\t.user_balance(ALICE, CurrencyId::DOT, 70)\n\t\t.user_balance(ALICE, CurrencyId::MDOT, 60)\n\t\t.pool_balance(CurrencyId::DOT, 60)\n\t\t.pool_total_borrowed(CurrencyId::DOT, 30)\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, 30, Rate::saturating_from_rational(1, 1), false)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Checking the function when called from borrow.\n\t\t\t// collateral parameter for DOT and ETH pool is set to false. User can't borrow.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 0, 30),\n\t\t\t\tOk((0, 120))\n\t\t\t);\n\n\t\t\t// Alice set collateral parameter value to true for DOT pool. Alice can borrow.\n\t\t\tassert_ok!(\u003cLiquidityPools\u003cRuntime\u003e\u003e::enable_as_collateral_internal(\n\t\t\t\t\u0026ALICE,\n\t\t\t\tCurrencyId::DOT\n\t\t\t));\n\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 0, 50),\n\t\t\t\tOk((2, 0))\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 0, 100),\n\t\t\t\tOk((0, 98))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_liquidity_pool_exchange_rate_should_work() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, dollars(100_u128))\n\t\t.user_balance(ALICE, CurrencyId::MDOT, dollars(125_u128))\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(300_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// exchange_rate = (100 - 0 + 300) / 125 = 3.2\n\t\t\tassert_eq!(\n\t\t\t\tController::get_liquidity_pool_exchange_rate(CurrencyId::DOT),\n\t\t\t\tSome(Rate::saturating_from_rational(32, 10))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_liquidity_pool_borrow_and_supply_rates_less_than_kink() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, dollars(100_u128))\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(300_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// utilization_rate = 300 / (100 - 0 + 300) = 0.75 \u003c kink = 0.8\n\t\t\t// borrow_rate = 0.75 * 0.000_000_009 + 0 = 0.00000000675\n\t\t\t// supply_rate = 0.75 * 0.00_000_000_675 * (1 - 0.1) = 0.00000000455625\n\t\t\tassert_eq!(\n\t\t\t\tController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT),\n\t\t\t\tSome((Rate::from_inner(6750000000), Rate::from_inner(4556250000)))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_liquidity_pool_borrow_and_supply_rates_above_kink() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, dollars(100_u128))\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(500_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// utilization_rate = 500 / (100 - 0 + 500) = 0.83 \u003e kink = 0.8\n\t\t\t// borrow_rate = 0.83 * 0.8 * 0.000_000_207  + (0.8 * 0.000_000_009) + 0 = 0.0000001452\n\t\t\t// supply_rate = 0.83 * 0.0000001452 * (1 - 0.1) = 0.00000000455625\n\t\t\tassert_eq!(\n\t\t\t\tController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT),\n\t\t\t\tSome((Rate::from_inner(145199999999), Rate::from_inner(108899999999)))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_allowed_should_work() {\n\tExtBuilder::default().alice_deposit_60_dot().build().execute_with(|| {\n\t\tassert_ok!(Controller::redeem_allowed(CurrencyId::DOT, \u0026ALICE, dollars(40_u128)));\n\n\t\t// collateral parameter is set to true.\n\t\tassert_ok!(\u003cLiquidityPools\u003cRuntime\u003e\u003e::enable_as_collateral_internal(\n\t\t\t\u0026ALICE,\n\t\t\tCurrencyId::DOT\n\t\t));\n\n\t\tassert_err!(\n\t\t\tController::redeem_allowed(CurrencyId::DOT, \u0026ALICE, dollars(100_u128)),\n\t\t\tError::\u003cRuntime\u003e::InsufficientLiquidity\n\t\t);\n\t});\n}\n\n#[test]\nfn borrow_allowed_should_work() {\n\tExtBuilder::default().alice_deposit_60_dot().build().execute_with(|| {\n\t\t// collateral parameter is set to false. User can't borrow\n\t\tassert_err!(\n\t\t\tController::borrow_allowed(CurrencyId::DOT, \u0026ALICE, dollars(10_u128)),\n\t\t\tError::\u003cRuntime\u003e::InsufficientLiquidity\n\t\t);\n\n\t\t// collateral parameter is set to true. User can borrow.\n\t\tassert_ok!(\u003cLiquidityPools\u003cRuntime\u003e\u003e::enable_as_collateral_internal(\n\t\t\t\u0026ALICE,\n\t\t\tCurrencyId::DOT\n\t\t));\n\n\t\tassert_ok!(Controller::borrow_allowed(CurrencyId::DOT, \u0026ALICE, dollars(10_u128)));\n\n\t\tassert_noop!(\n\t\t\tController::borrow_allowed(CurrencyId::DOT, \u0026ALICE, dollars(999_u128)),\n\t\t\tError::\u003cRuntime\u003e::InsufficientLiquidity\n\t\t);\n\t});\n}\n\n#[test]\nfn is_operation_allowed_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Deposit),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Redeem),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Borrow),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Repay),\n\t\t\t\ttrue\n\t\t\t);\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Deposit\n\t\t\t));\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Redeem\n\t\t\t));\n\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Deposit),\n\t\t\t\tfalse\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Redeem),\n\t\t\t\tfalse\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Borrow),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Repay),\n\t\t\t\ttrue\n\t\t\t);\n\t\t});\n}\n\n/* ----------------------------------------------------------------------------------------- */\n\n// Admin functions\n\n#[test]\nfn set_insurance_factor_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE set insurance factor equal 2.0\n\t\t\tassert_ok!(Controller::set_insurance_factor(alice(), CurrencyId::DOT, 20, 10));\n\t\t\tlet expected_event = TestEvent::controller(Event::InsuranceFactorChanged);\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t\tassert_eq!(\n\t\t\t\tController::controller_dates(CurrencyId::DOT).insurance_factor,\n\t\t\t\tRate::saturating_from_rational(20, 10)\n\t\t\t);\n\n\t\t\t// ALICE set insurance factor equal 0.0\n\t\t\tassert_ok!(Controller::set_insurance_factor(alice(), CurrencyId::DOT, 0, 1));\n\t\t\tlet expected_event = TestEvent::controller(Event::InsuranceFactorChanged);\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t\tassert_eq!(\n\t\t\t\tController::controller_dates(CurrencyId::DOT).insurance_factor,\n\t\t\t\tRate::from_inner(0)\n\t\t\t);\n\n\t\t\t// Overflow in calculation: 20 / 0\n\t\t\tassert_noop!(\n\t\t\t\tController::set_insurance_factor(alice(), CurrencyId::DOT, 20, 0),\n\t\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t\t);\n\n\t\t\t// The dispatch origin of this call must be Administrator.\n\t\t\tassert_noop!(\n\t\t\t\tController::set_insurance_factor(bob(), CurrencyId::DOT, 20, 10),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::set_insurance_factor(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn set_max_borrow_rate_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE set max borrow rate equal 2.0\n\t\t\tassert_ok!(Controller::set_max_borrow_rate(alice(), CurrencyId::DOT, 20, 10));\n\t\t\tlet expected_event = TestEvent::controller(Event::MaxBorrowRateChanged);\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t\tassert_eq!(\n\t\t\t\tController::controller_dates(CurrencyId::DOT).max_borrow_rate,\n\t\t\t\tRate::saturating_from_rational(20, 10)\n\t\t\t);\n\n\t\t\t// ALICE can't set max borrow rate equal 0.0\n\t\t\tassert_noop!(\n\t\t\t\tController::set_max_borrow_rate(alice(), CurrencyId::DOT, 0, 1),\n\t\t\t\tError::\u003cRuntime\u003e::MaxBorrowRateCannotBeZero\n\t\t\t);\n\n\t\t\t// Overflow in calculation: 20 / 0\n\t\t\tassert_noop!(\n\t\t\t\tController::set_max_borrow_rate(alice(), CurrencyId::DOT, 20, 0),\n\t\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t\t);\n\n\t\t\t// The dispatch origin of this call must be Administrator.\n\t\t\tassert_noop!(\n\t\t\t\tController::set_max_borrow_rate(bob(), CurrencyId::DOT, 20, 10),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::set_max_borrow_rate(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn pause_specific_operation_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).deposit_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).redeem_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).borrow_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).repay_paused, false);\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Deposit\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsPaused(CurrencyId::DOT, Operation::Deposit));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Redeem\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsPaused(CurrencyId::DOT, Operation::Redeem));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Borrow\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsPaused(CurrencyId::DOT, Operation::Borrow));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Repay\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsPaused(CurrencyId::DOT, Operation::Repay));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).deposit_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).redeem_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).borrow_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).repay_paused, true);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::pause_specific_operation(bob(), CurrencyId::DOT, Operation::Deposit),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\t\t\tassert_noop!(\n\t\t\t\tController::pause_specific_operation(alice(), CurrencyId::MDOT, Operation::Redeem),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn unpause_specific_operation_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.pool_mock(CurrencyId::KSM)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).deposit_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).redeem_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).borrow_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).repay_paused, true);\n\n\t\t\tassert_ok!(Controller::unpause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tOperation::Deposit\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsUnPaused(CurrencyId::KSM, Operation::Deposit));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::unpause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tOperation::Redeem\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsUnPaused(CurrencyId::KSM, Operation::Redeem));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::unpause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tOperation::Borrow\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsUnPaused(CurrencyId::KSM, Operation::Borrow));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::unpause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tOperation::Repay\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsUnPaused(CurrencyId::KSM, Operation::Repay));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).deposit_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).redeem_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).borrow_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).repay_paused, false);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::unpause_specific_operation(bob(), CurrencyId::DOT, Operation::Deposit),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\t\t\tassert_noop!(\n\t\t\t\tController::unpause_specific_operation(alice(), CurrencyId::MDOT, Operation::Redeem),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn deposit_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE deposit 100 DOT in pool insurance\n\t\t\tassert_ok!(Controller::deposit_insurance(alice(), CurrencyId::DOT, 100));\n\t\t\tlet expected_event = TestEvent::controller(Event::DepositedInsurance(CurrencyId::DOT, 100));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 100);\n\n\t\t\t// Bob is not added to the allow-list of admins, so this action is not available for him.\n\t\t\tassert_noop!(\n\t\t\t\tController::deposit_insurance(bob(), CurrencyId::DOT, 101),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn do_deposit_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.user_balance(BOB, CurrencyId::BTC, ONE_HUNDRED)\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.pool_mock(CurrencyId::BTC)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE deposit 60 DOT in pool insurance\n\t\t\tassert_ok!(Controller::do_deposit_insurance(\u0026ALICE, CurrencyId::DOT, 60));\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 60);\n\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 40);\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), 60);\n\n\t\t\t// ALICE deposit 5 DOT in pool insurance\n\t\t\tassert_ok!(Controller::do_deposit_insurance(\u0026ALICE, CurrencyId::DOT, 5));\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 65);\n\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 35);\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), 65);\n\n\t\t\t// Not enough balance to deposit insurance.\n\t\t\tassert_noop!(\n\t\t\t\tController::do_deposit_insurance(\u0026ALICE, CurrencyId::DOT, 101),\n\t\t\t\tError::\u003cRuntime\u003e::NotEnoughBalance\n\t\t\t);\n\n\t\t\t// There is no pool 'MDOT'.\n\t\t\tassert_noop!(\n\t\t\t\tController::do_deposit_insurance(\u0026ALICE, CurrencyId::MDOT, 5),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\n\t\t\t// Set BTC pool total insurance = max_value()\n\t\t\tassert_ok!(TestPools::set_pool_total_insurance(\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tBalance::max_value()\n\t\t\t));\n\n\t\t\t// Overflow in calculation: total_insurance = max_value() + 50\n\t\t\tassert_err!(\n\t\t\t\tController::do_deposit_insurance(\u0026BOB, CurrencyId::BTC, 50),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceOverflowed\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.pool_total_insurance(CurrencyId::DOT, 1000)\n\t\t.pool_balance(CurrencyId::DOT, 1000)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE redeem 100 DOT from pool insurance.\n\t\t\tassert_ok!(Controller::redeem_insurance(alice(), CurrencyId::DOT, 125));\n\t\t\tlet expected_event = TestEvent::controller(Event::RedeemedInsurance(CurrencyId::DOT, 125));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 875);\n\t\t\tassert_eq!(\n\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026TestPools::pools_account_id()),\n\t\t\t\t875,\n\t\t\t);\n\n\t\t\t// Bob is not added to the allow-list of admins, so this action is not available for him.\n\t\t\tassert_noop!(\n\t\t\t\tController::redeem_insurance(bob(), CurrencyId::DOT, 101),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn do_redeem_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.pool_total_insurance(CurrencyId::DOT, 1000)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE redeem 150 DOT from pool insurance\n\t\t\tassert_ok!(Controller::do_redeem_insurance(\u0026ALICE, CurrencyId::DOT, 150));\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 850);\n\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 250);\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), 850);\n\n\t\t\t// ALICE redeem 300 DOT from pool insurance\n\t\t\tassert_ok!(Controller::do_redeem_insurance(\u0026ALICE, CurrencyId::DOT, 300));\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 550);\n\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 550);\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), 550);\n\n\t\t\t// Not enough balance to redeem insurance: 550 - 600 \u003c 0\n\t\t\tassert_noop!(\n\t\t\t\tController::do_redeem_insurance(\u0026ALICE, CurrencyId::DOT, 600),\n\t\t\t\tError::\u003cRuntime\u003e::NotEnoughBalance\n\t\t\t);\n\n\t\t\t// There is no pool 'MDOT'.\n\t\t\tassert_noop!(\n\t\t\t\tController::do_redeem_insurance(\u0026ALICE, CurrencyId::MDOT, 5),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\n\t\t\t// Set DOT pool total insurance = max_value()\n\t\t\tassert_ok!(TestPools::set_pool_total_insurance(\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tBalance::max_value()\n\t\t\t));\n\t\t\t// Overflow in calculation: total_insurance = max_value() + 50\n\t\t\tassert_err!(\n\t\t\t\tController::do_deposit_insurance(\u0026ALICE, CurrencyId::DOT, 50),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceOverflowed\n\t\t\t);\n\t\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\n#[cfg(test)]\nmod tests {\n\tuse frame_support::{assert_noop, assert_ok, impl_outer_origin, parameter_types};\n\tuse frame_system::{self as system};\n\tuse liquidity_pools::{Pool, PoolUserData};\n\tuse minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\n\tuse orml_currencies::Currency;\n\tuse orml_traits::MultiCurrency;\n\tuse pallet_traits::Borrowing;\n\tuse sp_core::H256;\n\tuse sp_runtime::{\n\t\ttesting::Header,\n\t\ttraits::{IdentityLookup, Zero},\n\t\tDispatchResult, FixedPointNumber, ModuleId, Perbill,\n\t};\n\n\tuse controller::{ControllerData, PauseKeeper};\n\tuse minterest_model::MinterestModelData;\n\tuse minterest_protocol::Error as MinterestProtocolError;\n\n\tmod controller_tests;\n\tmod liquidity_pools_tests;\n\tmod minterest_model_tests;\n\tmod minterest_protocol_tests;\n\tmod scenario_tests;\n\n\timpl_outer_origin! {\n\t\tpub enum Origin for Test {}\n\t}\n\n\t#[derive(Clone, PartialEq, Eq)]\n\tpub struct Test;\n\n\tparameter_types! {\n\t\tpub const BlockHashCount: u64 = 250;\n\t\tpub const MaximumBlockWeight: u32 = 1024;\n\t\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\t\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n\n\t}\n\n\tpub type AccountId = u32;\n\timpl system::Trait for Test {\n\t\ttype BaseCallFilter = ();\n\t\ttype Origin = Origin;\n\t\ttype Call = ();\n\t\ttype Index = u64;\n\t\ttype BlockNumber = u64;\n\t\ttype Hash = H256;\n\t\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\t\ttype AccountId = AccountId;\n\t\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\t\ttype Header = Header;\n\t\ttype Event = ();\n\t\ttype BlockHashCount = BlockHashCount;\n\t\ttype MaximumBlockWeight = MaximumBlockWeight;\n\t\ttype DbWeight = ();\n\t\ttype BlockExecutionWeight = ();\n\t\ttype ExtrinsicBaseWeight = ();\n\t\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\t\ttype MaximumBlockLength = MaximumBlockLength;\n\t\ttype AvailableBlockRatio = AvailableBlockRatio;\n\t\ttype Version = ();\n\t\ttype PalletInfo = ();\n\t\ttype AccountData = ();\n\t\ttype OnNewAccount = ();\n\t\ttype OnKilledAccount = ();\n\t\ttype SystemWeightInfo = ();\n\t}\n\n\tparameter_types! {\n\t\tpub const ExistentialDeposit: u64 = 1;\n\t}\n\n\tpub struct MockBorrowing;\n\timpl Borrowing\u003cAccountId\u003e for MockBorrowing {\n\t\tfn update_state_on_borrow(\n\t\t\t_who: \u0026AccountId,\n\t\t\t_underlying_asset_id: CurrencyId,\n\t\t\t_amount_borrowed: Balance,\n\t\t\t_account_borrows: Balance,\n\t\t) -\u003e DispatchResult {\n\t\t\tOk(())\n\t\t}\n\n\t\tfn update_state_on_repay(\n\t\t\t_who: \u0026AccountId,\n\t\t\t_underlying_asset_id: CurrencyId,\n\t\t\t_amount_borrowed: Balance,\n\t\t\t_account_borrows: Balance,\n\t\t) -\u003e DispatchResult {\n\t\t\tOk(())\n\t\t}\n\t}\n\n\ttype Amount = i128;\n\timpl orml_tokens::Trait for Test {\n\t\ttype Event = ();\n\t\ttype Balance = Balance;\n\t\ttype Amount = Amount;\n\t\ttype CurrencyId = CurrencyId;\n\t\ttype OnReceived = ();\n\t\ttype WeightInfo = ();\n\t}\n\n\tparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n\t}\n\n\ttype NativeCurrency = Currency\u003cTest, GetNativeCurrencyId\u003e;\n\n\timpl orml_currencies::Trait for Test {\n\t\ttype Event = ();\n\t\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\t\ttype NativeCurrency = NativeCurrency;\n\t\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\t\ttype WeightInfo = ();\n\t}\n\n\timpl m_tokens::Trait for Test {\n\t\ttype Event = ();\n\t\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\t}\n\n\tparameter_types! {\n\t\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\t\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\t\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t\t];\n\t}\n\n\timpl liquidity_pools::Trait for Test {\n\t\ttype Event = ();\n\t\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\t\ttype ModuleId = LiquidityPoolsModuleId;\n\t\ttype InitialExchangeRate = InitialExchangeRate;\n\t\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n\t}\n\n\timpl minterest_protocol::Trait for Test {\n\t\ttype Event = ();\n\t\ttype Borrowing = MockBorrowing;\n\t}\n\n\timpl controller::Trait for Test {\n\t\ttype Event = ();\n\t}\n\n\timpl oracle::Trait for Test {\n\t\ttype Event = ();\n\t}\n\n\tparameter_types! {\n\t\tpub const MaxMembers: u32 = MAX_MEMBERS;\n\t}\n\n\timpl accounts::Trait for Test {\n\t\ttype Event = ();\n\t\ttype MaxMembers = MaxMembers;\n\t}\n\n\tparameter_types! {\n\t\tpub const BlocksPerYear: u128 = 5256000;\n\t}\n\n\timpl minterest_model::Trait for Test {\n\t\ttype Event = ();\n\t\ttype BlocksPerYear = BlocksPerYear;\n\t}\n\n\tpub const ADMIN: AccountId = 0;\n\tpub const ALICE: AccountId = 1;\n\tpub const BOB: AccountId = 2;\n\tpub const ONE_HUNDRED: Balance = 100_000 * DOLLARS;\n\tpub const BALANCE_ZERO: Balance = 0;\n\tpub const DOLLARS: Balance = 1_000_000_000_000_000_000;\n\tpub const RATE_ZERO: Rate = Rate::from_inner(0);\n\tpub const MAX_MEMBERS: u32 = 16;\n\n\tpub type MinterestProtocol = minterest_protocol::Module\u003cTest\u003e;\n\tpub type TestPools = liquidity_pools::Module\u003cTest\u003e;\n\tpub type TestController = controller::Module\u003cTest\u003e;\n\tpub type Currencies = orml_currencies::Module\u003cTest\u003e;\n\tpub type System = frame_system::Module\u003cTest\u003e;\n\n\tpub fn admin() -\u003e Origin {\n\t\tOrigin::signed(ADMIN)\n\t}\n\tpub fn alice() -\u003e Origin {\n\t\tOrigin::signed(ALICE)\n\t}\n\n\tpub struct ExtBuilder {\n\t\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n\t\tpools: Vec\u003c(CurrencyId, Pool)\u003e,\n\t\tpool_user_data: Vec\u003c(CurrencyId, AccountId, PoolUserData)\u003e,\n\t}\n\n\timpl Default for ExtBuilder {\n\t\tfn default() -\u003e Self {\n\t\t\tSelf {\n\t\t\t\tendowed_accounts: vec![],\n\t\t\t\tpools: vec![],\n\t\t\t\tpool_user_data: vec![],\n\t\t\t}\n\t\t}\n\t}\n\n\timpl ExtBuilder {\n\t\tpub fn user_balance(mut self, user: AccountId, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\t\tself.endowed_accounts.push((user, currency_id, balance));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_balance(mut self, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\t\tself.endowed_accounts\n\t\t\t\t.push((TestPools::pools_account_id(), currency_id, balance));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_total_borrowed(mut self, pool_id: CurrencyId, total_borrowed: Balance) -\u003e Self {\n\t\t\tself.pools.push((\n\t\t\t\tpool_id,\n\t\t\t\tPool {\n\t\t\t\t\ttotal_borrowed,\n\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t},\n\t\t\t));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_total_insurance(mut self, pool_id: CurrencyId, total_insurance: Balance) -\u003e Self {\n\t\t\tself.endowed_accounts\n\t\t\t\t.push((TestPools::pools_account_id(), pool_id, total_insurance));\n\t\t\tself.pools.push((\n\t\t\t\tpool_id,\n\t\t\t\tPool {\n\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\ttotal_insurance,\n\t\t\t\t},\n\t\t\t));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_user_data(\n\t\t\tmut self,\n\t\t\tpool_id: CurrencyId,\n\t\t\tuser: AccountId,\n\t\t\ttotal_borrowed: Balance,\n\t\t\tinterest_index: Rate,\n\t\t\tcollateral: bool,\n\t\t) -\u003e Self {\n\t\t\tself.pool_user_data.push((\n\t\t\t\tpool_id,\n\t\t\t\tuser,\n\t\t\t\tPoolUserData {\n\t\t\t\t\ttotal_borrowed,\n\t\t\t\t\tinterest_index,\n\t\t\t\t\tcollateral,\n\t\t\t\t},\n\t\t\t));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_initial(mut self, pool_id: CurrencyId) -\u003e Self {\n\t\t\tself.pools.push((\n\t\t\t\tpool_id,\n\t\t\t\tPool {\n\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t},\n\t\t\t));\n\t\t\tself\n\t\t}\n\n\t\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\t\tlet mut t = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\t\t\torml_tokens::GenesisConfig::\u003cTest\u003e {\n\t\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\tcontroller::GenesisConfig::\u003cTest\u003e {\n\t\t\t\tcontroller_dates: vec![\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\tControllerData {\n\t\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t\tControllerData {\n\t\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t\tControllerData {\n\t\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t],\n\t\t\t\tpause_keepers: vec![\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\t\tdeposit_paused: true,\n\t\t\t\t\t\t\tredeem_paused: true,\n\t\t\t\t\t\t\tborrow_paused: true,\n\t\t\t\t\t\t\trepay_paused: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t],\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\tliquidity_pools::GenesisConfig::\u003cTest\u003e {\n\t\t\t\tpools: self.pools,\n\t\t\t\tpool_user_data: self.pool_user_data,\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\taccounts::GenesisConfig::\u003cTest\u003e {\n\t\t\t\tallowed_accounts: vec![(ADMIN, ())],\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\tminterest_model::GenesisConfig {\n\t\t\t\tminterest_model_dates: vec![\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t],\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\t\text.execute_with(|| System::set_block_number(1));\n\t\t\text\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","controller_tests.rs"],"content":"///  Integration-tests for controller pallet.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t// Description of the scenario:\n\t// The user cannot disable collateral for a specific asset, if he does not have enough\n\t// collateral in other assets to cover all his borrowing:\n\t//\n\t// Alice has 60 DOT collateral and 40 ETH collateral, and she has 50 BTC borrowing.\n\t// Exchange rate for all assets equal 1.0.\n\t// 1. Alice can't disable DOT as collateral (because 40 ETH won't cover 50 BTC borrowing);\n\t// 2. Alice can disable ETH as collateral (because 60 DOT will cover 50 BTC borrowing);\n\t#[test]\n\tfn disable_collateral_internal_fails_if_not_cover_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.pool_initial(CurrencyId::DOT)\n\t\t\t.pool_initial(CurrencyId::BTC)\n\t\t\t.pool_initial(CurrencyId::ETH)\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::BTC, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::ETH, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// ALICE deposit 60 DOT, 50 BTC, 40 ETH.\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\talice(),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t60 * DOLLARS\n\t\t\t\t));\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\talice(),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t50 * DOLLARS\n\t\t\t\t));\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\talice(),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t40 * DOLLARS\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(11);\n\n\t\t\t\t// Alice enable her assets in pools as collateral.\n\t\t\t\tassert_ok!(MinterestProtocol::enable_as_collateral(alice(), CurrencyId::DOT));\n\t\t\t\tassert_ok!(MinterestProtocol::enable_as_collateral(alice(), CurrencyId::BTC));\n\t\t\t\tassert_ok!(MinterestProtocol::enable_as_collateral(alice(), CurrencyId::ETH));\n\n\t\t\t\tSystem::set_block_number(21);\n\n\t\t\t\t// Alice transfer her 50 MBTC to BOB.\n\t\t\t\tassert_ok!(Currencies::transfer(alice(), BOB, CurrencyId::MBTC, 50 * DOLLARS));\n\n\t\t\t\tSystem::set_block_number(31);\n\n\t\t\t\t// Alice borrow 50 BTC.\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(alice(), CurrencyId::BTC, 50 * DOLLARS));\n\n\t\t\t\tSystem::set_block_number(41);\n\n\t\t\t\t// Alice can't disable DOT as collateral (because ETH won't cover the borrowing).\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::disable_collateral(alice(), CurrencyId::DOT),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::CanotBeDisabledAsCollateral\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(51);\n\n\t\t\t\t// Alice can disable ETH as collateral (because DOT will cover the borrowing);\n\t\t\t\tassert_ok!(MinterestProtocol::disable_collateral(alice(), CurrencyId::ETH));\n\t\t\t});\n\t}\n\n\t// Extrinsic `set_insurance_factor`, description of scenario #2:\n\t// Pool insurance is increased if the insurance_factor is greater than zero.\n\t// 1. Alice deposit 40 DOT;\n\t// 2. Alice borrow 20 DOT;\n\t// 3. Set insurance factor equal 0.5.\n\t// 4. Alice repay full loan in DOTs, pool insurance increased.\n\t#[test]\n\tfn set_insurance_factor_greater_than_zero() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\talice_deposited_amount - alice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total insurance for DOT pool.\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, BALANCE_ZERO);\n\n\t\t\t\tSystem::set_block_number(10);\n\n\t\t\t\t// Set insurance factor equal 0.5.\n\t\t\t\tassert_ok!(TestController::set_insurance_factor(admin(), CurrencyId::DOT, 1, 2));\n\n\t\t\t\t// Alice repay full loan in DOTs.\n\t\t\t\tassert_ok!(MinterestProtocol::repay_all(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\tlet expected_interest_accumulated: Balance = 720_000_000_000_000;\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\talice_deposited_amount + expected_interest_accumulated\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tBALANCE_ZERO + (expected_interest_accumulated / 2)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `set_insurance_factor`, description of scenario #1:\n\t// Pool insurance does not increase if the insurance_factor is zero.\n\t// 1. Alice deposit 40 DOT;\n\t// 2. Alice borrow 20 DOT;\n\t// 3. Set insurance factor equal to zero.\n\t// 4. Alice repay full loan in DOTs, pool total_insurance = 0.\n\t#[test]\n\tfn set_insurance_factor_equal_zero() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\talice_deposited_amount - alice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total insurance for DOT pool.\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, BALANCE_ZERO);\n\n\t\t\t\tSystem::set_block_number(10);\n\n\t\t\t\t// Set insurance factor equal to zero.\n\t\t\t\tassert_ok!(TestController::set_insurance_factor(admin(), CurrencyId::DOT, 0, 1));\n\n\t\t\t\t// Alice repay full loan in DOTs.\n\t\t\t\tassert_ok!(MinterestProtocol::repay_all(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// Checking pool total insurance.\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, BALANCE_ZERO);\n\t\t\t});\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","liquidity_pools_tests.rs"],"content":"///  Integration-tests for luquidity-pools pallet.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #1:\n\t#[test]\n\tfn get_exchange_rate_deposit_without_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after fn accrue_interest_rate called\n\t\t\t\tlet expected_amount_wrapped_tokens = 40_000 * DOLLARS;\n\t\t\t\tlet expected_exchange_rate_mock = Rate::one();\n\n\t\t\t\t// Checking if real exchange rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #2:\n\t#[test]\n\tfn get_exchange_rate_deposit_with_pool_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after fn accrue_interest_rate called\n\t\t\t\tlet expected_amount_wrapped_tokens = 40_000 * DOLLARS;\n\t\t\t\tlet expected_exchange_rate_mock = Rate::one();\n\n\t\t\t\t// Checking if real exchange rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #3:\n\t#[test]\n\tfn get_exchange_rate_deposit_and_borrow_without_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after fn accrue_interest_rate called\n\t\t\t\tlet expected_amount_wrapped_tokens = 40_000 * DOLLARS;\n\t\t\t\tlet expected_exchange_rate_mock = Rate::one();\n\n\t\t\t\t// Checking if real borrow interest rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #4:\n\t#[test]\n\tfn get_exchange_rate_deposit_and_borrow_with_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after fn accrue_interest_rate called\n\t\t\t\tlet expected_amount_wrapped_tokens = 40_000 * DOLLARS;\n\t\t\t\tlet expected_exchange_rate_mock = Rate::one();\n\n\t\t\t\t// Checking if real exchange rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #5:\n\t#[test]\n\tfn get_exchange_rate_few_deposits_and_borrows_with_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::DOT, BOB, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Bob deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Expected exchange rate based on params before fn accrue_interest_rate in block 4 called\n\t\t\t\tlet expected_exchange_rate_mock_block_number_3 = Rate::from_inner(1000000002025000000);\n\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock_block_number_3)\n\t\t\t\t);\n\n\t\t\t\t// Alice try to borrow from DOT pool\n\t\t\t\tlet bob_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after\n\t\t\t\t// fn accrue_interest_rate in block 4 called\n\t\t\t\tlet expected_amount_wrapped_tokens_alice = 40_000 * DOLLARS;\n\t\t\t\t// bob_deposited_amount/expected_exchange_rate_mock_block_number_3 = 59_999_999_878_500_000_246_037\n\t\t\t\tlet expected_amount_wrapped_tokens_bob = 59_999_999_878_500_000_246_037;\n\t\t\t\tlet expected_exchange_rate_mock_block_number_4 = Rate::from_inner(1000000002349000003);\n\n\t\t\t\t// Checking if real exchange rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_alice\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026BOB),\n\t\t\t\t\texpected_amount_wrapped_tokens_bob\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock_block_number_4)\n\t\t\t\t);\n\t\t\t});\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","minterest_model_tests.rs"],"content":"//  Integration-tests for minterest model pallet.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #1:\n\t#[test]\n\tfn calculate_borrow_interest_rate_deposit_without_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit 40 DOT in pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 0 / (40_000 - 0 + 0) = 0 \u003c 0.8\n\t\t\t\t// borrow_rate = 0 * 0.000_000_009 + 0 = 0\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(Rate::zero(), borrow_rate);\n\t\t\t});\n\t}\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #2:\n\t#[test]\n\tfn calculate_borrow_interest_rate_deposit_with_pool_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit 40 DOT in pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 0 / (140_000 - 100_000 + 0) = 0 \u003c 0.8\n\t\t\t\t// borrow_rate = 0 * 0.000_000_009 + 0 = 0\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(Rate::zero(), borrow_rate);\n\t\t\t});\n\t}\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #3:\n\t#[test]\n\tfn calculate_borrow_interest_rate_deposit_and_borrow_without_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 20_000 / (20_000 - 0 + 20_000) = 0.5 \u003c kink = 0.8\n\t\t\t\t// borrow_rate = 0.5 * 0.000_000_009 + 0 = 45 * 10^(-10)\n\t\t\t\tlet expected_borrow_rate_mock = Rate::saturating_from_rational(45_u128, 10_000_000_000_u128);\n\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(expected_borrow_rate_mock, borrow_rate);\n\t\t\t});\n\t}\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #4:\n\t#[test]\n\tfn calculate_borrow_interest_rate_deposit_and_borrow_with_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 20_000 / (120_000 - 100_000 + 20_000) = 0.5 \u003c kink = 0.8\n\t\t\t\t// borrow_rate = 0.5 * 0.000_000_009 + 0 = 45 * 10^(-10)\n\t\t\t\tlet expected_borrow_rate_mock = Rate::saturating_from_rational(45_u128, 10_000_000_000_u128);\n\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(expected_borrow_rate_mock, borrow_rate);\n\t\t\t});\n\t}\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #5:\n\t#[test]\n\tfn calculate_borrow_interest_rate_few_deposits_and_borrows_with_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::DOT, BOB, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Bob deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice try to borrow from DOT pool\n\t\t\t\tlet bob_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 70_000 / (130_000 - 100_000 + 70_000) = 0.7 \u003c kink = 0.8\n\t\t\t\t// borrow_rate = 0.7 * 0.000_000_009 + 0 = 63 * 10^(-10) + accumulated_borrow\n\t\t\t\tlet expected_borrow_rate_mock = Rate::from_inner(6_300_000_004);\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(expected_borrow_rate_mock, borrow_rate);\n\t\t\t});\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","minterest_protocol_tests.rs"],"content":"///  Integration-tests for minterest protocol pallet.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t#[test]\n\tfn deposit_underlying_with_supplied_insurance_should_work() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// Calculate expected amount of wrapped tokens for Alice\n\t\t\t\tlet alice_expected_amount_wrapped_tokens =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount).unwrap();\n\n\t\t\t\t// Checking pool available liquidity increased by 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount\n\t\t\t\t);\n\n\t\t\t\t// Checking current free balance for DOT \u0026\u0026 MDOT\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_expected_amount_wrapped_tokens\n\t\t\t\t);\n\n\t\t\t\t// Checking current total insurance\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, ONE_HUNDRED);\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount = ONE_HUNDRED;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// Calculate expected amount of wrapped tokens for Bob\n\t\t\t\tlet bob_expected_amount_wrapped_tokens =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, bob_deposited_amount).unwrap();\n\n\t\t\t\t// Checking pool available liquidity increased by 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount + bob_deposited_amount\n\t\t\t\t);\n\n\t\t\t\t// Checking current free balance for DOT \u0026\u0026 MDOT\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 40_000 * DOLLARS);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED - bob_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_expected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026BOB),\n\t\t\t\t\tbob_expected_amount_wrapped_tokens\n\t\t\t\t);\n\n\t\t\t\t// Checking current total insurance\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, ONE_HUNDRED);\n\t\t\t});\n\t}\n\n\t#[test]\n\tfn deposit_underlying_overflow_while_convert_underline_to_wrap_should_work() {\n\t\tExtBuilder::default()\n\t\t\t// Set genesis to get exchange rate 0,00000000000000001\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::MDOT, DOLLARS)\n\t\t\t.pool_initial(CurrencyId::DOT)\n\t\t\t.pool_balance(CurrencyId::DOT, 5)\n\t\t\t.pool_total_borrowed(CurrencyId::DOT, 5)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice try to deposit ONE_HUNDRED to DOT pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::deposit_underlying(Origin::signed(ALICE), CurrencyId::DOT, ONE_HUNDRED),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::NumOverflow\n\t\t\t\t);\n\n\t\t\t\t// Alice deposit to DOT pool.\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t100\n\t\t\t\t));\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem_underlying`, description of scenario #1:\n\t// The user The user tries to redeem all assets in the first currency. He has loan in the first\n\t// currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 60 DOT;\n\t// 2. Alice deposit 50 ETH;\n\t// 3. Alice borrow 50 DOT;\n\t// 4. Alice can't `redeem_underlying` 60 DOT: 50 ETH * 0.9 collateral \u003c 50 DOT borrow;\n\t// 5. Alice deposit 10 ETH;\n\t// 6. Alice `redeem_underlying` 60 DOT;\n\t// 7. Alice can't `redeem_underlying` 60 ETH.\n\t#[test]\n\tfn redeem_underlying_with_current_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::ETH, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit 60 DOT to pool.\n\t\t\t\tlet alice_deposited_amount_in_dot = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit 50 ETH to pool.\n\t\t\t\tlet alice_deposited_amount_in_eth = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_deposited_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount_in_dot - alice_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\t// Checking Alice's free balance DOT \u0026\u0026 MDOT.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_eth\n\t\t\t\t);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_dot =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_dot).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_dot\n\t\t\t\t);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_eth =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_eth).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::METH, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Checking total borrow for Alice DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice try to redeem all from DOT pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice add liquidity to ETH pool\n\t\t\t\tlet alice_deposited_amount_in_eth_secondary = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_deposited_amount_in_eth_secondary\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(6);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tlet expected_amount_redeemed_underlying_assets = 60000019601999999880000;\n\t\t\t\tassert_ok!(MinterestProtocol::redeem_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\texpected_amount_redeemed_underlying_assets\n\t\t\t\t));\n\n\t\t\t\t// Checking free balance DOT/MDOT \u0026\u0026 ETH/METH for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t\t\t+ alice_borrowed_amount_in_dot\n\t\t\t\t\t\t+ expected_amount_redeemed_underlying_assets\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_eth - alice_deposited_amount_in_eth_secondary\n\t\t\t\t);\n\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE), 0);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_eth_summary = expected_amount_wrapped_tokens_in_eth\n\t\t\t\t\t+ TestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_eth_secondary).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::METH, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_eth_summary\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for DOT pool\n\t\t\t\tlet expected_borrow_interest_accumulated = 21779999999850000;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot + expected_borrow_interest_accumulated\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(7);\n\n\t\t\t\t// Alice try to redeem all from ETH pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t\talice_deposited_amount_in_eth + alice_deposited_amount_in_eth_secondary\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem_underlying`, description of scenario #2:\n\t// The user tries to redeem all assets in the first currency. He has loan in the second currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 60 DOT;\n\t// 2. Alice borrow 50 ETH;\n\t// 3. Alice can't `redeem` 60 DOT: 0 DOT collateral \u003c 50 ETH borrow;\n\t#[test]\n\tfn redeem_underlying_with_another_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount_in_eth = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// // Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH for user.\n\t\t\t\t// Expected previously values\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem_underlying`, description of scenario #3:\n\t// The user tries to redeem all assets in the first currency. He has loan in the second\n\t// currency and deposit in the third currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 40 DOT;\n\t// 2. Alice deposit 40 BTC;\n\t// 3. Alice borrow 70 ETH;\n\t// 4. Alice can't `redeem_underlying` 40 DOT;\n\t// 5. Alice deposit 40 BTC;\n\t// 6. Alice redeem 40 DOT;\n\t// 7. Alice can't `redeem_underlying` 40 BTC;\n\t#[test]\n\tfn redeem_underlying_with_third_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::BTC, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit to BTC pool\n\t\t\t\tlet alice_deposited_amount_in_btc = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\talice_deposited_amount_in_btc\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount_in_eth = 70_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_btc\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Alice try to redeem all DOTs\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice add liquidity to BTC pool\n\t\t\t\tlet alice_deposited_amount_in_btc_secondary = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\talice_deposited_amount_in_btc_secondary\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(6);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tlet alice_current_balance_amount_in_m_dot = Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE);\n\t\t\t\tlet alice_redeemed_amount_in_dot =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_current_balance_amount_in_m_dot).unwrap();\n\t\t\t\tassert_ok!(MinterestProtocol::redeem_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_redeemed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\talice_deposited_amount_in_dot - alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_btc - alice_deposited_amount_in_btc_secondary\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(7);\n\n\t\t\t\t// Alice try to redeem all BTC.\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t\talice_deposited_amount_in_btc_secondary\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem_underlying`, description of scenario #4:\n\t// It is possible to redeem assets from the pool insurance.\n\t// 1. Deposit 10 DOT to pool insurance;\n\t// 2. Alice deposit 20 DOT;\n\t// 3. Bob deposit 20 BTC;\n\t// 4. Bob deposit 10 DOT;\n\t// 5. Bob borrow 15 DOT;\n\t// 6. Alice redeem 20 DOT;\n\t// 7. DOT pool insurance equal 5 DOT;\n\t#[test]\n\tfn redeem_underlying_over_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::BTC, BOB, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, 10_000 * DOLLARS)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Bob deposit to BTC pool\n\t\t\t\tlet bob_deposited_amount_in_btc = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tbob_deposited_amount_in_btc\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Bob borrow from DOT pool\n\t\t\t\tlet bob_borrowed_amount_in_dot = 15_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Bob deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount_in_dot = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice redeem all DOTs.\n\t\t\t\tlet alice_current_balance_amount_in_m_dot = Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE);\n\t\t\t\t// Expected exchange rate 1000000006581250024\n\t\t\t\tlet alice_redeemed_amount_in_dot =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_current_balance_amount_in_m_dot).unwrap();\n\t\t\t\tassert_ok!(MinterestProtocol::redeem_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_redeemed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\t10_000 * DOLLARS + alice_deposited_amount_in_dot - alice_redeemed_amount_in_dot\n\t\t\t\t\t\t+ bob_deposited_amount_in_dot\n\t\t\t\t\t\t- bob_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED + bob_borrowed_amount_in_dot - bob_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED - bob_deposited_amount_in_btc\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem`, description of scenario #1:\n\t// The user tries to redeem all assets in the first currency. He has loan in the first currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 60 DOT;\n\t// 2. Alice deposit 50 ETH;\n\t// 3. Alice borrow 50 DOT;\n\t// 4. Alice can't `redeem` 60 DOT: 10 DOT * 0.9 + 50 ETH * 0.9 collateral \u003c 60 DOT redeem;\n\t// 5. Alice deposit 10 ETH;\n\t// 6. Alice `redeem` 60 DOT;\n\t// 7. Alice can't `redeem` 60 ETH.\n\t#[test]\n\tfn redeem_with_current_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, 100_000_000 * DOLLARS)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::ETH, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit to ETH pool\n\t\t\t\tlet alice_deposited_amount_in_eth = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_deposited_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount_in_dot - alice_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT in pool.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_eth\n\t\t\t\t);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_dot =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_dot).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_dot\n\t\t\t\t);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_eth =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_eth).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::METH, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Checking total borrow for Alice DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice try to redeem all from DOT pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice add liquidity to ETH pool\n\t\t\t\tlet alice_deposited_amount_in_eth_secondary = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_deposited_amount_in_eth_secondary\n\t\t\t\t));\n\n\t\t\t\t// Bob add liquidity to ETH pool\n\t\t\t\tlet bob_deposited_amount_in_dot = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(6);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tassert_ok!(MinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// Checking free balance DOT/MDOT \u0026\u0026 ETH/METH in pool.\n\t\t\t\t// current_exchange_rate == 1000000221932654817\n\t\t\t\tlet expected_amount_redeemed_underlying_assets = 60000013315959289020000;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t\t\t+ alice_borrowed_amount_in_dot\n\t\t\t\t\t\t+ expected_amount_redeemed_underlying_assets\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_eth - alice_deposited_amount_in_eth_secondary\n\t\t\t\t);\n\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE), 0);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_eth_summary = expected_amount_wrapped_tokens_in_eth\n\t\t\t\t\t+ TestPools::convert_to_wrapped(CurrencyId::ETH, alice_deposited_amount_in_eth_secondary).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::METH, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_eth_summary\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice DOT pool\n\t\t\t\tlet expected_amount_accumulated_in_dot = 14841428697992866;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot + expected_amount_accumulated_in_dot\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(7);\n\n\t\t\t\t// Alice try to redeem all from ETH pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::ETH),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem`, description of scenario #2:\n\t// The user tries to redeem all assets in the first currency. He has loan in the second currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 60 DOT;\n\t// 2. Alice borrow 50 ETH;\n\t// 3. Alice can't `redeem` 60 DOT: 0 DOT collateral \u003c 50 ETH borrow;\n\t#[test]\n\tfn redeem_with_another_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount_in_eth = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// // Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH for user.\n\t\t\t\t// Expected previously values\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem`, description of scenario #3:\n\t// The user tries to redeem all assets in the first currency. He has loan in the second\n\t// currency and deposit in the third currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 40 DOT;\n\t// 2. Alice deposit 40 BTC;\n\t// 3. Alice borrow 70 ETH;\n\t// 4. Alice can't `redeem` 40 DOT: (40 BTC * 0.9) collateral \u003c 70 ETH borrow;\n\t// 5. Alice deposit 40 BTC;\n\t// 6. Alice redeem 40 DOT: (80 BTC * 0.9) collateral \u003e 70 EHT borrow;\n\t// 7. Alice can't `redeem` 40 BTC: (40 BTC * 0.9) collateral \u003c 70 ETH borrow;\n\t#[test]\n\tfn redeem_with_third_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::BTC, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit to BTC pool\n\t\t\t\tlet alice_deposited_amount_in_btc = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\talice_deposited_amount_in_btc\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount_in_eth = 70_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_btc\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice try to redeem all DOTs\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice add liquidity to BTC pool\n\t\t\t\tlet alice_deposited_amount_in_btc_secondary = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\talice_deposited_amount_in_btc_secondary\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(6);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tlet alice_current_balance_amount_in_m_dot = Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE);\n\t\t\t\tlet alice_redeemed_amount_in_dot =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_current_balance_amount_in_m_dot).unwrap();\n\t\t\t\tassert_ok!(MinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_btc - alice_deposited_amount_in_btc_secondary\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(7);\n\n\t\t\t\t// Alice try to redeem all BTC.\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::BTC),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem`, description of scenario #4:\n\t// It is possible to redeem assets from the pool insurance.\n\t// 1. Deposit 10 DOT to pool insurance;\n\t// 2. Alice deposit 20 DOT;\n\t// 3. Bob deposit 20 BTC;\n\t// 4. Bob deposit 10 DOT;\n\t// 5. Bob borrow 15 DOT;\n\t// 6. Alice redeem 20 DOT, pool insurance equal 5 DOT;\n\t#[test]\n\tfn redeem_over_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::DOT, BOB, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::BTC, BOB, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, 10_000 * DOLLARS)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Bob deposit to BTC pool\n\t\t\t\tlet bob_deposited_amount_in_btc = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tbob_deposited_amount_in_btc\n\t\t\t\t));\n\n\t\t\t\t// Bob deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount_in_dot = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Bob borrow from DOT pool\n\t\t\t\tlet bob_borrowed_amount_in_dot = 15_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice redeem all DOTs.\n\t\t\t\tlet alice_current_balance_amount_in_m_dot = Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE);\n\n\t\t\t\tassert_ok!(MinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\tlet alice_redeemed_amount_in_dot =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_current_balance_amount_in_m_dot).unwrap();\n\n\t\t\t\t// Checking pool available liquidity.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\t10_000 * DOLLARS + alice_deposited_amount_in_dot - alice_redeemed_amount_in_dot\n\t\t\t\t\t\t+ bob_deposited_amount_in_dot\n\t\t\t\t\t\t- bob_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED + bob_borrowed_amount_in_dot - bob_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED - bob_deposited_amount_in_btc\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `borrow`, description of scenario #1:\n\t// The user cannot borrow without making a deposit first.\n\t// 1. Alice can't borrow 50 DOT: 0 collateral \u003c 50 DOT borrow;\n\t#[test]\n\tfn borrow_with_insufficient_collateral_no_deposits() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice try to borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::borrow(Origin::signed(ALICE), CurrencyId::DOT, alice_borrowed_amount_in_dot),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::BorrowControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), ONE_HUNDRED);\n\t\t\t});\n\t}\n\n\t// Extrinsic `borrow`, description of scenario #2:\n\t// The user cannot borrow in the second currency unless he has\n\t// not enabled the first currency as collateral.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 50 DOT;\n\t// 2. Alice can't borrow 50 ETH: 0 collateral \u003c 50 ETH borrow;\n\t#[test]\n\tfn borrow_without_collateral_in_second_currency() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice try to borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::borrow(Origin::signed(ALICE), CurrencyId::ETH, alice_borrowed_amount),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::BorrowControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::ETH), ONE_HUNDRED);\n\t\t\t});\n\t}\n\n\t// Extrinsic `borrow`, description of scenario #3:\n\t// The user cannot borrow in the second currency if the collateral in the first currency\n\t// is insufficient.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 50 DOT;\n\t// 2. Alice can't borrow 50 ETH: 50 DOT * 0.9 collateral \u003c 50 ETH borrow;\n\t#[test]\n\tfn borrow_with_insufficient_collateral_in_second_currency() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice try to borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::borrow(Origin::signed(ALICE), CurrencyId::ETH, alice_borrowed_amount),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::BorrowControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::ETH), ONE_HUNDRED);\n\t\t\t});\n\t}\n\n\t// Extrinsic `borrow`, description of scenario #4:\n\t// The user can borrow in the second currency if the collateral in the first currency\n\t// is sufficient.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 50 DOT;\n\t// 2. Alice can borrow 40 ETH: 50 DOT * 0.9 collateral \u003e 40 ETH borrow;\n\t#[test]\n\tfn borrow_with_sufficient_collateral_in_second_currency() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice try to borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::ETH),\n\t\t\t\t\tONE_HUNDRED - alice_borrowed_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::ETH, \u0026ALICE), alice_borrowed_amount);\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::ETH).total_borrowed, alice_borrowed_amount);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, \u0026ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount\n\t\t\t\t);\n\t\t\t});\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","scenario_tests.rs"],"content":"//  Scenario Integration tests.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t// Description of scenario #1:\n\t// In this scenario, user uses four operations in the protocol (deposit, borrow, repay, redeem).\n\t// Changes to the main protocol parameters are also checked here.\n\t#[test]\n\tfn scenario_with_four_operations() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ADMIN, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_initial(CurrencyId::DOT)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// INITIAL PARAMS\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\tlet alice_dot_free_balance_start: Balance = ONE_HUNDRED;\n\t\t\t\tlet alice_m_dot_free_balance_start: Balance = BALANCE_ZERO;\n\t\t\t\tlet alice_dot_total_borrow_start: Balance = BALANCE_ZERO;\n\n\t\t\t\tlet pool_available_liquidity_start: Balance = BALANCE_ZERO;\n\t\t\t\tlet pool_m_dot_total_issuance_start: Balance = BALANCE_ZERO;\n\t\t\t\tlet pool_total_insurance_start: Balance = BALANCE_ZERO;\n\t\t\t\tlet pool_dot_total_borrow_start: Balance = BALANCE_ZERO;\n\n\t\t\t\t// ACTION: DEPOSIT INSURANCE\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Add liquidity to DOT pool from Insurance by Admin\n\t\t\t\tlet admin_deposit_amount_block_number_0: Balance = 100_000 * DOLLARS;\n\t\t\t\tassert_ok!(TestController::deposit_insurance(\n\t\t\t\t\tOrigin::signed(ADMIN),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tadmin_deposit_amount_block_number_0\n\t\t\t\t));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected: 100_000\n\t\t\t\tlet current_pool_available_liquidity_block_number_0: Balance =\n\t\t\t\t\tpool_available_liquidity_start + admin_deposit_amount_block_number_0;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_0\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Admin doesn't have to get wrapped token after adding liquidity from insurance.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_total_issuance_start\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// Checking DOT pool Storage params\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).borrow_index, Rate::one());\n\t\t\t\t// Total insurance changed: 0 -\u003e 100 000\n\t\t\t\tlet pool_total_insurance_block_number_0 =\n\t\t\t\t\tpool_total_insurance_start + admin_deposit_amount_block_number_0;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_0\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\tpool_dot_total_borrow_start\n\t\t\t\t);\n\n\t\t\t\t// Checking controller params\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 0);\n\t\t\t\tassert_eq!(borrow_rate, RATE_ZERO);\n\n\t\t\t\t// Checking DOT pool User params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\talice_dot_total_borrow_start\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(1);\n\n\t\t\t\t// ACTION: DEPOSIT UNDERLYING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// ALICE deposit 60 000 to DOT pool\n\t\t\t\tlet alice_deposit_amount_block_number_1: Balance = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposit_amount_block_number_1\n\t\t\t\t));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected: 160 000\n\t\t\t\tlet pool_available_liquidity_block_number_1: Balance =\n\t\t\t\t\tadmin_deposit_amount_block_number_0 + alice_deposit_amount_block_number_1;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tpool_available_liquidity_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Admin doesn't have to get wrapped token after adding liquidity from insurance.\n\t\t\t\t// Alice gets wrapped token after adding liquidity by exchange rate 1:1\n\t\t\t\t// Expected: 60 000\n\t\t\t\tlet pool_m_dot_free_balance_block_number_1: Balance =\n\t\t\t\t\tpool_m_dot_total_issuance_start + alice_deposit_amount_block_number_1;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// ALICE:\n\t\t\t\tlet alice_dot_free_balance_block_number_1: Balance =\n\t\t\t\t\talice_dot_free_balance_start - alice_deposit_amount_block_number_1;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_1\n\t\t\t\t);\n\t\t\t\tlet alice_m_dot_free_balance_block_number_1: Balance =\n\t\t\t\t\talice_m_dot_free_balance_start + alice_deposit_amount_block_number_1;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking DOT pool Storage params\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).borrow_index, Rate::one());\n\t\t\t\t// Expected: 100 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_0\n\t\t\t\t);\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_borrowed, BALANCE_ZERO);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 1);\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, RATE_ZERO);\n\n\t\t\t\t// Checking DOT pool User params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// ACTION: BORROW\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t//  Alice borrow 30_000 from DOT pool.\n\t\t\t\tlet alice_borrow_amount_block_number_2: Balance = 30_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrow_amount_block_number_2\n\t\t\t\t));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected 130 000\n\t\t\t\tlet current_pool_available_liquidity_block_number_2: Balance =\n\t\t\t\t\tpool_available_liquidity_block_number_1 - alice_borrow_amount_block_number_2;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_2\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// ALICE:\n\t\t\t\t// Expected: 70 000\n\t\t\t\tlet alice_dot_free_balance_block_number_2: Balance =\n\t\t\t\t\talice_dot_free_balance_block_number_1 + alice_borrow_amount_block_number_2;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_2\n\t\t\t\t);\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking pool Storage params\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).borrow_index, Rate::one());\n\t\t\t\t// Expected: 100 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_0\n\t\t\t\t);\n\t\t\t\t// Total borrowed amount changed 0 -\u003e 30 000\n\t\t\t\tlet pool_dot_total_borrow_block_number_2: Balance =\n\t\t\t\t\tpool_dot_total_borrow_start + alice_borrow_amount_block_number_2;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\tpool_dot_total_borrow_block_number_2\n\t\t\t\t);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 2);\n\t\t\t\t// Borrow_rate changed: 0 -\u003e 45 * 10^(-10)\n\t\t\t\tlet expected_borrow_rate_block_number_2: Rate =\n\t\t\t\t\tRate::saturating_from_rational(45u128, 10_000_000_000u128);\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, expected_borrow_rate_block_number_2);\n\n\t\t\t\t// Checking DOT pool User params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\t// User total borrowed changed: 0 -\u003e 30 000\n\t\t\t\tlet alice_dot_total_borrow_block_number_2: Balance =\n\t\t\t\t\talice_dot_total_borrow_start + alice_borrow_amount_block_number_2;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_dot_total_borrow_block_number_2\n\t\t\t\t);\n\t\t\t\t// User interest index changed: 0 -\u003e 1\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tRate::one()\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// ACTION: REPAY\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Alice repay part of her loan(15 000).\n\t\t\t\tlet alice_repay_amount_block_number_3: Balance = 15_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::repay(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_repay_amount_block_number_3\n\t\t\t\t));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected 145 000\n\t\t\t\tlet current_pool_available_liquidity_block_number_3: Balance =\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_2 + alice_repay_amount_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_3\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// ALICE:\n\t\t\t\t// Expected: 55 000\n\t\t\t\tlet alice_dot_free_balance_block_number_3: Balance =\n\t\t\t\t\talice_dot_free_balance_block_number_2 - alice_repay_amount_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_3\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking pool Storage params\n\t\t\t\t// Expected: 1.000000004500000000\n\t\t\t\tlet pool_borrow_index_block_number_3: Rate =\n\t\t\t\t\tRate::saturating_from_rational(10_000_000_045u128, 10_000_000_000u128);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).borrow_index,\n\t\t\t\t\tpool_borrow_index_block_number_3\n\t\t\t\t);\n\t\t\t\t// Expected: 100_000,0000135\n\t\t\t\tlet insurance_accumulated_block_number_3: Balance = 13_500_000_000_000;\n\t\t\t\tlet pool_total_insurance_block_number_3: Balance =\n\t\t\t\t\tadmin_deposit_amount_block_number_0 + insurance_accumulated_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_3\n\t\t\t\t);\n\t\t\t\t// Expected: 15_000,000135\n\t\t\t\tlet borrow_accumulated_block_number_3: Balance = 135_000_000_000_000;\n\t\t\t\tlet pool_dot_total_borrow_block_number_3: Balance = pool_dot_total_borrow_block_number_2\n\t\t\t\t\t+ borrow_accumulated_block_number_3\n\t\t\t\t\t- alice_repay_amount_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\tpool_dot_total_borrow_block_number_3\n\t\t\t\t);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 3);\n\t\t\t\t// Borrow_rate changed: 0,0000000045 -\u003e 0,000000002250000015\n\t\t\t\tlet expected_borrow_rate_block_number_3: Rate =\n\t\t\t\t\tRate::saturating_from_rational(2_250_000_015u128, 1_000_000_000_000_000_000u128);\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, expected_borrow_rate_block_number_3);\n\n\t\t\t\t// Checking DOT pool User params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\tlet alice_dot_total_borrow_block_number_3: Balance = alice_dot_total_borrow_block_number_2\n\t\t\t\t\t+ borrow_accumulated_block_number_3\n\t\t\t\t\t- alice_repay_amount_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_dot_total_borrow_block_number_3\n\t\t\t\t);\n\t\t\t\t// Interest_index changed: 0 -\u003e 1.000000004500000000\n\t\t\t\tlet user_interest_index_block_number_3: Rate = pool_borrow_index_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tuser_interest_index_block_number_3\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// ACTION: REPAY_ALL\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Alice repay all loans.\n\t\t\t\tassert_ok!(MinterestProtocol::repay_all(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Real expected: \t\t160_000,000168750000528750\n\t\t\t\t// Currently expected:\t160_000,000168750000526875\n\t\t\t\t// FIXME: unavailable behavior. That is a reason of error below.\n\t\t\t\t// FIXME: borrow_accumulated_block_number_4 should be 33_750_000_528_750\n\t\t\t\t//\t\t\t\t\t\t\t\t\t\t   instead of 33_750_000_526_875\n\t\t\t\tlet borrow_accumulated_block_number_4: Balance = 33_750_000_526_875;\n\t\t\t\tlet current_pool_available_liquidity_block_number_4: Balance =\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_3\n\t\t\t\t\t\t+ alice_repay_amount_block_number_3\n\t\t\t\t\t\t+ borrow_accumulated_block_number_3\n\t\t\t\t\t\t+ borrow_accumulated_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_4\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT for ADMIN\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// ALICE:\n\t\t\t\tlet alice_dot_free_balance_block_number_4: Balance = alice_dot_free_balance_block_number_3\n\t\t\t\t\t- alice_dot_total_borrow_block_number_3\n\t\t\t\t\t- borrow_accumulated_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_4\n\t\t\t\t);\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\t\t\t\t// Checking pool Storage params\n\t\t\t\t// Borrow_index changed: 1.000000004500000000 -\u003e 1,000000006750000025\n\t\t\t\tlet pool_borrow_index_block_number_4 =\n\t\t\t\t\tRate::saturating_from_rational(1_000_000_006_750_000_025u128, 1_000_000_000_000_000_000u128);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).borrow_index,\n\t\t\t\t\tpool_borrow_index_block_number_4\n\t\t\t\t);\n\t\t\t\tlet insurance_accumulated_block_number_4: Balance = 3_375_000_052_875;\n\t\t\t\tlet pool_total_insurance_block_number_4: Balance =\n\t\t\t\t\tpool_total_insurance_block_number_3 + insurance_accumulated_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_4\n\t\t\t\t);\n\n\t\t\t\t// FIXME: unavailable behavior.\n\t\t\t\t// TODO: should be fixed\n\t\t\t\t// It must be zero, but it is not.\n\t\t\t\t// 1875 left - 0 right\n\t\t\t\t// 15000000168750000528750 new borrow value accrue_interest\n\t\t\t\t// 15000000168750000526875 new user borrow value\n\t\t\t\tlet borrow_accumulated_block_number_4 = 33_750_000_528_750u128;\n\t\t\t\tlet alice_borrow_accumulated_block_number_4 = 33_750_000_526_875u128;\n\t\t\t\tlet pool_dot_total_borrow_block_number_4 = pool_dot_total_borrow_block_number_3\n\t\t\t\t\t+ borrow_accumulated_block_number_4\n\t\t\t\t\t- alice_dot_total_borrow_block_number_3\n\t\t\t\t\t- alice_borrow_accumulated_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\tpool_dot_total_borrow_block_number_4\n\t\t\t\t);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 4);\n\t\t\t\t// Borrow_rate changed: 0,000000002250000015 -\u003e 0,0\n\t\t\t\tlet expected_borrow_rate_block_number_4 = Rate::zero();\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, expected_borrow_rate_block_number_4);\n\n\t\t\t\t// Checking user pool Storage params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tlet user_interest_index_block_number_4: Rate = pool_borrow_index_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tuser_interest_index_block_number_4\n\t\t\t\t);\n\n\t\t\t\t// Check the underline amount before fn accrue_interest called\n\t\t\t\tlet alice_underlining_amount: Balance =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_m_dot_free_balance_block_number_1).unwrap();\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// ACTION: REDEEM\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Alice redeem all assets\n\t\t\t\tassert_ok!(MinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected: 160_000,000016875000046875\n\t\t\t\tlet current_pool_available_liquidity_block_number_5: Balance =\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_4 - alice_underlining_amount;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_5\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Expected: 0\n\t\t\t\tassert_eq!(Currencies::total_issuance(CurrencyId::MDOT), BALANCE_ZERO);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\t// ALICE:\n\t\t\t\t// Expected 99_999,999983124999953125\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_4 + alice_underlining_amount\n\t\t\t\t);\n\t\t\t\t// Expected: 0\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE), BALANCE_ZERO);\n\n\t\t\t\t// Checking pool Storage params\n\t\t\t\t// Expected: 1,000000006750000025\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).borrow_index,\n\t\t\t\t\tpool_borrow_index_block_number_4\n\t\t\t\t);\n\t\t\t\t// Expected: 100_000,000016875000052875\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_4\n\t\t\t\t);\n\t\t\t\t//FIXME: something went wrong.....\n\t\t\t\t//TODO: should be fixed\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_borrowed, 1875);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 5);\n\t\t\t\t// borrow_rate changed: 0,000000002250000015 -\u003e 0\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, Rate::from_inner(0));\n\n\t\t\t\t// Checking user pool Storage params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\t// Expected: 0\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\t// Expected: 1,000000006750000025\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tuser_interest_index_block_number_4\n\t\t\t\t);\n\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\talice(),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t20 * DOLLARS,\n\t\t\t\t));\n\t\t\t});\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","liquidity-pools","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, traits::Get, IterableStorageDoubleMap};\nuse minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\nuse orml_traits::MultiCurrency;\nuse pallet_traits::Borrowing;\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::{\n\ttraits::{AccountIdConversion, CheckedDiv, CheckedMul, Zero},\n\tDispatchError, DispatchResult, FixedPointNumber, ModuleId, RuntimeDebug,\n};\nuse sp_std::{cmp::Ordering, result, vec::Vec};\n\n/// Pool metadata\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Default)]\npub struct Pool {\n\t/// The amount of underlying currently loaned out by the pool, and the amount upon which\n\t/// interest is accumulated to suppliers of the pool.\n\tpub total_borrowed: Balance,\n\n\t/// Accumulator of the total earned interest rate since the opening of the pool.\n\tpub borrow_index: Rate,\n\n\t/// Total amount of insurance of the underlying held in this pool.\n\tpub total_insurance: Balance,\n}\n\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Default)]\npub struct PoolUserData {\n\t/// Total balance (with accrued interest), after applying the most\n\t/// recent balance-changing action.\n\tpub total_borrowed: Balance,\n\n\t/// Global borrow_index as of the most recent balance-changing action.\n\tpub interest_index: Rate,\n\n\t/// Wheter or not pool as a collateral.\n\tpub collateral: bool,\n}\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\npub trait Trait: frame_system::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// The Liquidity Pool's module id, keep all assets in Pools.\n\ttype ModuleId: Get\u003cModuleId\u003e;\n\n\t/// The `MultiCurrency` implementation.\n\ttype MultiCurrency: MultiCurrency\u003cSelf::AccountId, Balance = Balance, CurrencyId = CurrencyId\u003e;\n\n\t/// Start exchange rate.\n\ttype InitialExchangeRate: Get\u003cRate\u003e;\n\n\t/// Enabled currency pairs.\n\ttype EnabledCurrencyPair: Get\u003cVec\u003cCurrencyPair\u003e\u003e;\n}\n\ndecl_event!(\n\tpub enum Event {}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t/// Number overflow in calculation.\n\tNumOverflow,\n\n\t/// The currency is not enabled in protocol.\n\tNotValidUnderlyingAssetId,\n\n\t/// The currency is not enabled in wrapped protocol.\n\tNotValidWrappedTokenId,\n\t}\n}\n\ndecl_storage! {\n\t trait Store for Module\u003cT: Trait\u003e as LiquidityPoolsStorage {\n\t\t /// Liquidity pool information: `(total_borrowed, borrow_index, total_insurance)`.\n\t\tpub Pools get(fn pools) config(): map hasher(blake2_128_concat) CurrencyId =\u003e Pool;\n\n\t\t/// Information about the user of the liquidity pool: `(total_borrowed, interest_index, collateral)`.\n\t\tpub PoolUserDates get(fn pool_user_data) config(): double_map\n\t\t\thasher(blake2_128_concat) CurrencyId,\n\t\t\thasher(blake2_128_concat) T::AccountId =\u003e PoolUserData;\n\t}\n}\n\ndecl_module! {\n\t\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\t\ttype Error = Error\u003cT\u003e;\n\t\t\tfn deposit_event() = default;\n\n\t\t\t/// The Liquidity Pool's module id, keep all assets in Pools.\n\t\t\tconst ModuleId: ModuleId = T::ModuleId::get();\n\n\t\t\t/// The Liquidity Pool's account id, keep all assets in Pools.\n\t\t\tconst PoolAccountId: T::AccountId = T::ModuleId::get().into_account();\n\n\t\t\t/// Enabled underlying asset IDs.\n\t\t\tconst EnabledUnderlyingAssetId: Vec\u003cCurrencyId\u003e = T::EnabledCurrencyPair::get()\n\t\t\t\t.iter()\n\t\t\t\t.map(|currency_pair| currency_pair.underlying_id)\n\t\t\t\t.collect();\n\n\t\t\t/// Enabled wrapped token IDs.\n\t\t\tconst EnabledWrappedTokensId: Vec\u003cCurrencyId\u003e = T::EnabledCurrencyPair::get()\n\t\t\t\t.iter()\n\t\t\t\t.map(|currency_pair| currency_pair.wrapped_id)\n\t\t\t\t.collect();\n\t}\n}\n\ntype RateResult = result::Result\u003cRate, DispatchError\u003e;\ntype CurrencyIdResult = result::Result\u003cCurrencyId, DispatchError\u003e;\ntype BalanceResult = result::Result\u003cBalance, DispatchError\u003e;\n\n// Dispatchable calls implementation\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Converts a specified number of underlying assets into wrapped tokens.\n\t/// The calculation is based on the exchange rate.\n\t///\n\t/// - `underlying_asset_id`: CurrencyId of underlying assets to be converted to wrapped tokens.\n\t/// - `underlying_amount`: The amount of underlying assets to be converted to wrapped tokens.\n\t/// Returns `wrapped_amount = underlying_amount / exchange_rate`\n\tpub fn convert_to_wrapped(underlying_asset_id: CurrencyId, underlying_amount: Balance) -\u003e BalanceResult {\n\t\tlet exchange_rate = Self::get_exchange_rate(underlying_asset_id)?;\n\n\t\tlet wrapped_amount = Rate::from_inner(underlying_amount)\n\t\t\t.checked_div(\u0026exchange_rate)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(wrapped_amount)\n\t}\n\n\t/// Converts a specified number of wrapped tokens into underlying assets.\n\t/// The calculation is based on the exchange rate.\n\t///\n\t/// - `wrapped_id`: CurrencyId of the wrapped tokens to be converted to underlying assets.\n\t/// - `wrapped_amount`: The amount of wrapped tokens to be converted to underlying assets.\n\t///\n\t/// Returns `underlying_amount = wrapped_amount * exchange_rate`\n\tpub fn convert_from_wrapped(wrapped_id: CurrencyId, wrapped_amount: Balance) -\u003e BalanceResult {\n\t\tlet underlying_asset_id = Self::get_underlying_asset_id_by_wrapped_id(\u0026wrapped_id)?;\n\t\tlet exchange_rate = Self::get_exchange_rate(underlying_asset_id)?;\n\n\t\tlet underlying_amount = Rate::from_inner(wrapped_amount)\n\t\t\t.checked_mul(\u0026exchange_rate)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(underlying_amount)\n\t}\n\n\t/// Gets the exchange rate between a mToken and the underlying asset.\n\t/// This function does not accrue interest before calculating the exchange rate.\n\t/// - `underlying_asset_id`: CurrencyId of underlying assets for which the exchange rate\n\t/// is calculated.\n\t///\n\t/// returns `exchange_rate` between a mToken and the underlying asset.\n\tpub fn get_exchange_rate(underlying_asset_id: CurrencyId) -\u003e RateResult {\n\t\tlet wrapped_asset_id = Self::get_wrapped_id_by_underlying_asset_id(\u0026underlying_asset_id)?;\n\t\t// Current the total amount of cash the pool has.\n\t\tlet total_cash = Self::get_pool_available_liquidity(underlying_asset_id);\n\n\t\t// Current total number of tokens in circulation.\n\t\tlet total_supply = T::MultiCurrency::total_issuance(wrapped_asset_id);\n\n\t\t// Current total amount of insurance of the underlying held in this pool.\n\t\tlet total_insurance = Self::get_pool_total_insurance(underlying_asset_id);\n\n\t\t// Current the amount of underlying currently loaned out by the pool.\n\t\tlet total_borrowed = Self::get_pool_total_borrowed(underlying_asset_id);\n\n\t\tlet current_exchange_rate =\n\t\t\tSelf::calculate_exchange_rate(total_cash, total_supply, total_insurance, total_borrowed)?;\n\n\t\tOk(current_exchange_rate)\n\t}\n\n\t/// Calculates the exchange rate from the underlying to the mToken.\n\t/// - `total_cash`: The total amount of cash the pool has.\n\t/// - `total_supply`: Total number of tokens in circulation.\n\t/// - `total_insurance`: Total amount of insurance of the underlying held in the pool.\n\t/// - `total_borrowed`: Total amount of outstanding borrows of the underlying in this pool.\n\t///\n\t/// returns `exchange_rate = (total_cash + total_borrowed - total_insurance) / total_supply`.\n\tfn calculate_exchange_rate(\n\t\ttotal_cash: Balance,\n\t\ttotal_supply: Balance,\n\t\ttotal_insurance: Balance,\n\t\ttotal_borrowed: Balance,\n\t) -\u003e RateResult {\n\t\tlet rate = match total_supply.cmp(\u0026Balance::zero()) {\n\t\t\t// If there are no tokens minted: exchangeRate = InitialExchangeRate.\n\t\t\tOrdering::Equal =\u003e T::InitialExchangeRate::get(),\n\n\t\t\t// Otherwise: exchange_rate = (total_cash + total_borrowed - total_insurance) / total_supply\n\t\t\t_ =\u003e Rate::saturating_from_rational(\n\t\t\t\ttotal_cash\n\t\t\t\t\t.checked_add(total_borrowed)\n\t\t\t\t\t.and_then(|v| v.checked_sub(total_insurance))\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?,\n\t\t\t\ttotal_supply,\n\t\t\t),\n\t\t};\n\n\t\tOk(rate)\n\t}\n\n\t/// Check if enabled underlying asset id.\n\tpub fn is_enabled_underlying_asset_id(underlying_asset_id: CurrencyId) -\u003e bool {\n\t\tT::EnabledCurrencyPair::get()\n\t\t\t.iter()\n\t\t\t.any(|pair| pair.underlying_id == underlying_asset_id)\n\t}\n\n\t/// Gets the wrapped token ID from the underlying asset ID.\n\tpub fn get_wrapped_id_by_underlying_asset_id(asset_id: \u0026CurrencyId) -\u003e CurrencyIdResult {\n\t\tlet enabled_currency_pair = T::EnabledCurrencyPair::get();\n\n\t\tlet currency_pair = *enabled_currency_pair\n\t\t\t.iter()\n\t\t\t.find(|currency_pair| currency_pair.underlying_id == *asset_id)\n\t\t\t.ok_or(Error::\u003cT\u003e::NotValidUnderlyingAssetId)?;\n\n\t\tOk(currency_pair.wrapped_id)\n\t}\n\n\t/// Gets the underlying asset ID from the wrapped token ID.\n\tpub fn get_underlying_asset_id_by_wrapped_id(wrapped_id: \u0026CurrencyId) -\u003e CurrencyIdResult {\n\t\tlet enabled_currency_pair = T::EnabledCurrencyPair::get();\n\n\t\tlet currency_pair = *enabled_currency_pair\n\t\t\t.iter()\n\t\t\t.find(|currency_pair| currency_pair.wrapped_id == *wrapped_id)\n\t\t\t.ok_or(Error::\u003cT\u003e::NotValidWrappedTokenId)?;\n\n\t\tOk(currency_pair.underlying_id)\n\t}\n}\n\n// Storage setters for LiquidityPools\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Sets the total borrowed value in the pool.\n\tfn set_pool_total_borrowed(pool_id: CurrencyId, new_total_borrows: Balance) -\u003e DispatchResult {\n\t\tPools::mutate(pool_id, |pool| pool.total_borrowed = new_total_borrows);\n\t\tOk(())\n\t}\n\n\t/// Sets the borrow index in the pool.\n\tpub fn set_pool_borrow_index(pool_id: CurrencyId, new_borrow_index: Rate) -\u003e DispatchResult {\n\t\tPools::mutate(pool_id, |pool| pool.borrow_index = new_borrow_index);\n\t\tOk(())\n\t}\n\n\t/// Sets the total insurance in the pool.\n\tpub fn set_pool_total_insurance(pool_id: CurrencyId, new_total_insurance: Balance) -\u003e DispatchResult {\n\t\tPools::mutate(pool_id, |r| r.total_insurance = new_total_insurance);\n\t\tOk(())\n\t}\n\n\t/// Sets the total borrowed and interest index for user.\n\tfn set_user_total_borrowed_and_interest_index(\n\t\twho: \u0026T::AccountId,\n\t\tpool_id: CurrencyId,\n\t\tnew_total_borrows: Balance,\n\t\tnew_interest_index: Rate,\n\t) -\u003e DispatchResult {\n\t\tPoolUserDates::\u003cT\u003e::mutate(pool_id, who, |p| {\n\t\t\tp.total_borrowed = new_total_borrows;\n\t\t\tp.interest_index = new_interest_index;\n\t\t});\n\t\tOk(())\n\t}\n\n\t/// Sets the total borrowed and the total insurance in the pool.\n\tpub fn set_accrual_interest_params(\n\t\tunderlying_asset_id: CurrencyId,\n\t\tnew_total_borrow_balance: Balance,\n\t\tnew_total_insurance: Balance,\n\t) -\u003e DispatchResult {\n\t\tPools::mutate(underlying_asset_id, |r| {\n\t\t\tr.total_borrowed = new_total_borrow_balance;\n\t\t\tr.total_insurance = new_total_insurance;\n\t\t});\n\t\tOk(())\n\t}\n\n\t/// Sets the parameter `collateral` to `true`.\n\tpub fn enable_as_collateral_internal(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e DispatchResult {\n\t\tPoolUserDates::\u003cT\u003e::mutate(pool_id, who, |p| p.collateral = true);\n\t\tOk(())\n\t}\n\n\t/// Sets the parameter `collateral` to `false`.\n\tpub fn disable_collateral_internal(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e DispatchResult {\n\t\tPoolUserDates::\u003cT\u003e::mutate(pool_id, who, |p| p.collateral = false);\n\t\tOk(())\n\t}\n}\n\n// Storage getters for LiquidityPools\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Gets module account id.\n\tpub fn pools_account_id() -\u003e T::AccountId {\n\t\tT::ModuleId::get().into_account()\n\t}\n\n\t/// Gets current the total amount of cash the pool has.\n\tpub fn get_pool_available_liquidity(pool_id: CurrencyId) -\u003e Balance {\n\t\tlet module_account_id = Self::pools_account_id();\n\t\tT::MultiCurrency::free_balance(pool_id, \u0026module_account_id)\n\t}\n\n\t/// Gets current the amount of underlying currently loaned out by the pool.\n\tpub fn get_pool_total_borrowed(pool_id: CurrencyId) -\u003e Balance {\n\t\tSelf::pools(pool_id).total_borrowed\n\t}\n\n\t/// Gets current total amount of insurance of the underlying held in this pool.\n\tpub fn get_pool_total_insurance(pool_id: CurrencyId) -\u003e Balance {\n\t\tSelf::pools(pool_id).total_insurance\n\t}\n\n\t/// Accumulator of the total earned interest rate since the opening of the pool\n\tpub fn get_pool_borrow_index(pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::pools(pool_id).borrow_index\n\t}\n\n\t/// Global borrow_index as of the most recent balance-changing action\n\tpub fn get_user_borrow_index(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::pool_user_data(pool_id, who).interest_index\n\t}\n\n\t/// Gets total user borrowing.\n\tpub fn get_user_total_borrowed(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e Balance {\n\t\tSelf::pool_user_data(pool_id, who).total_borrowed\n\t}\n\n\t/// Checks if the user has enabled the pool as collateral.\n\tpub fn check_user_available_collateral(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e bool {\n\t\tSelf::pool_user_data(pool_id, who).collateral\n\t}\n\n\t/// Check if pool exists\n\tpub fn pool_exists(underlying_asset_id: \u0026CurrencyId) -\u003e bool {\n\t\tPools::contains_key(underlying_asset_id)\n\t}\n\n\t// TODO: Maybe implement using a binary tree?\n\tpub fn get_pool_members(underlying_asset_id: CurrencyId) -\u003e result::Result\u003cVec\u003cT::AccountId\u003e, DispatchError\u003e {\n\t\tlet user_vec: Vec\u003cT::AccountId\u003e = PoolUserDates::\u003cT\u003e::iter_prefix(underlying_asset_id)\n\t\t\t.map(|(account, _)| account)\n\t\t\t.collect();\n\t\tOk(user_vec)\n\t}\n}\n\n// Trait Borrowing for LiquidityPools\nimpl\u003cT: Trait\u003e Borrowing\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\t/// Updates the new borrower balance and pool total borrow balances during the borrow operation.\n\t/// Also sets the global borrow_index to user interest index.\n\t/// - `who`: The AccountId whose borrow balance should be calculated.\n\t/// - `pool_id`: PoolID whose total borrow balance should be calculated.\n\t/// - `borrow_amount`: The amount of the underlying asset to borrow.\n\t/// - `account_borrows`: The borrow balance of account.\n\t///\n\t/// calculates: `account_borrows_new = account_borrows + borrow_amount`,\n\t///             `total_borrows_new = total_borrows + borrow_amount`.\n\tfn update_state_on_borrow(\n\t\twho: \u0026T::AccountId,\n\t\tpool_id: CurrencyId,\n\t\tborrow_amount: Balance,\n\t\taccount_borrows: Balance,\n\t) -\u003e DispatchResult {\n\t\tlet pool_borrow_index = Self::get_pool_borrow_index(pool_id);\n\t\tlet pool_total_borrowed = Self::get_pool_total_borrowed(pool_id);\n\n\t\t// Calculate the new borrower and total borrow balances, failing on overflow:\n\t\t// account_borrows_new = account_borrows + borrow_amount\n\t\t// total_borrows_new = total_borrows + borrow_amount\n\t\tlet account_borrow_new = account_borrows\n\t\t\t.checked_add(borrow_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\tlet new_total_borrows = pool_total_borrowed\n\t\t\t.checked_add(borrow_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t// Write the previously calculated values into storage.\n\t\tSelf::set_pool_total_borrowed(pool_id, new_total_borrows)?;\n\n\t\tSelf::set_user_total_borrowed_and_interest_index(\u0026who, pool_id, account_borrow_new, pool_borrow_index)?;\n\n\t\tOk(())\n\t}\n\n\t/// Updates the new borrower balance and pool total borrow balances during the repay operation.\n\t/// Also sets the global borrow_index to user interest index.\n\t/// - `who`: The AccountId whose borrow balance should be calculated.\n\t/// - `pool_id`: PoolID whose total borrow balance should be calculated.\n\t/// - `repay_amount`: The amount of the underlying asset to repay.\n\t/// - `account_borrows`: The borrow balance of account.\n\t///\n\t/// calculates: `account_borrows_new = account_borrows - borrow_amount`,\n\t///             `total_borrows_new = total_borrows - borrow_amount`.\n\tfn update_state_on_repay(\n\t\twho: \u0026T::AccountId,\n\t\tpool_id: CurrencyId,\n\t\trepay_amount: Balance,\n\t\taccount_borrows: Balance,\n\t) -\u003e DispatchResult {\n\t\tlet pool_borrow_index = Self::get_pool_borrow_index(pool_id);\n\n\t\t// Calculate the new borrower and total borrow balances, failing on overflow:\n\t\t// account_borrows_new = account_borrows - repay_amount\n\t\t// total_borrows_new = total_borrows - repay_amount\n\t\tlet account_borrow_new = account_borrows\n\t\t\t.checked_sub(repay_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\tlet total_borrows_new = Self::get_pool_total_borrowed(pool_id)\n\t\t\t.checked_sub(repay_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t// Write the previously calculated values into storage.\n\t\tSelf::set_pool_total_borrowed(pool_id, total_borrows_new)?;\n\t\tSelf::set_user_total_borrowed_and_interest_index(\u0026who, pool_id, account_borrow_new, pool_borrow_index)?;\n\n\t\tOk(())\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","liquidity-pools","src","mock.rs"],"content":"#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\npub use minterest_primitives::{Balance, CurrencyId, CurrencyPair};\nuse orml_currencies::Currency;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\nuse crate::GenesisConfig;\n\nmod liquidity_pools {\n\tpub use crate::Event;\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\tliquidity_pools,\n\t\torml_currencies\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Test;\n\n// For testing the module, we construct most of a mock runtime. This means\n// first constructing a configuration type (`Test`) which `impl`s each of the\n// configuration traits of modules we want to use.\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n}\n\npub type AccountId = u32;\nimpl frame_system::Trait for Test {\n\ttype BaseCallFilter = ();\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\t// type Hash = Hash;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = u32;\n\t// type Lookup = IdentityLookup\u003cAccountId\u003e;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\t// type Header = generic::Header\u003cBlockNumber, BlakeTwo256\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\t// type DbWeight = RocksDbWeight;\n\ttype DbWeight = ();\n\t// type BlockExecutionWeight = BlockExecutionWeight;\n\ttype BlockExecutionWeight = ();\n\t// type ExtrinsicBaseWeight = ExtrinsicBaseWeight;\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\t// type Version = Version;\n\ttype Version = ();\n\t// type PalletInfo = PalletInfo;\n\ttype PalletInfo = ();\n\t// type AccountData = pallet_balances::AccountData\u003cBalance\u003e;\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype SystemWeightInfo = ();\n}\n\nimpl orml_tokens::Trait for Test {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\ntype NativeCurrency = Currency\u003cTest, GetNativeCurrencyId\u003e;\n\nimpl orml_currencies::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype NativeCurrency = NativeCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\n\npub type System = frame_system::Module\u003cTest\u003e;\n\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n\tpools: Vec\u003c(CurrencyId, Pool)\u003e,\n\tpool_user_data: Vec\u003c(CurrencyId, AccountId, PoolUserData)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t\tpools: vec![],\n\t\t\tpool_user_data: vec![],\n\t\t}\n\t}\n}\n\ntype Amount = i128;\npub type TestPools = Module\u003cTest\u003e;\npub const ALICE: AccountId = 1;\npub const DOLLARS: Balance = 1_000_000_000_000_000_000;\npub const ONE_HUNDRED_DOLLARS: Balance = 100 * DOLLARS;\npub const ONE_HUNDRED: Balance = 100;\npub const TEN_THOUSAND: Balance = 10_000 * DOLLARS;\n\nimpl ExtBuilder {\n\tpub fn user_balance(mut self, user: AccountId, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts.push((user, currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn pool_balance(mut self, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts\n\t\t\t.push((TestPools::pools_account_id(), currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn pool_with_params(\n\t\tmut self,\n\t\tpool_id: CurrencyId,\n\t\ttotal_borrowed: Balance,\n\t\tborrow_index: Rate,\n\t\ttotal_insurance: Balance,\n\t) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tborrow_index,\n\t\t\t\ttotal_insurance,\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_user_data_with_params(\n\t\tmut self,\n\t\tpool_id: CurrencyId,\n\t\tuser: AccountId,\n\t\ttotal_borrowed: Balance,\n\t\tinterest_index: Rate,\n\t\tcollateral: bool,\n\t) -\u003e Self {\n\t\tself.pool_user_data.push((\n\t\t\tpool_id,\n\t\t\tuser,\n\t\t\tPoolUserData {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tinterest_index,\n\t\t\t\tcollateral,\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_mock(mut self, pool_id: CurrencyId) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed: Balance::default(),\n\t\t\t\tborrow_index: Rate::default(),\n\t\t\t\ttotal_insurance: Balance::default(),\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_total_borrowed(mut self, pool_id: CurrencyId, total_borrowed: Balance) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tborrow_index: Rate::one(),\n\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cTest\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tGenesisConfig::\u003cTest\u003e {\n\t\t\tpools: self.pools,\n\t\t\tpool_user_data: self.pool_user_data,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","liquidity-pools","src","tests.rs"],"content":"#![cfg(test)]\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_err, assert_noop, assert_ok};\nuse sp_arithmetic::FixedPointNumber;\n\nfn dollars\u003cT: Into\u003cu128\u003e\u003e(d: T) -\u003e Balance {\n\t1_000_000_000_000_000_000_u128.saturating_mul(d.into())\n}\n\n#[test]\nfn set_pool_total_borrowed_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set pool_total_borrowed eq 100 DOT\n\t\tassert_ok!(TestPools::set_pool_total_borrowed(CurrencyId::DOT, ONE_HUNDRED_DOLLARS));\n\t\tassert_eq!(\u003cPools\u003e::get(CurrencyId::DOT).total_borrowed, ONE_HUNDRED_DOLLARS);\n\t});\n}\n\n#[test]\nfn set_pool_borrow_index_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set pool_borrow_index eq 0.25\n\t\tassert_ok!(TestPools::set_pool_borrow_index(\n\t\t\tCurrencyId::DOT,\n\t\t\tRate::saturating_from_rational(25, 100)\n\t\t));\n\t\tassert_eq!(\n\t\t\t\u003cPools\u003e::get(CurrencyId::DOT).borrow_index,\n\t\t\tRate::saturating_from_rational(25, 100)\n\t\t);\n\t});\n}\n\n#[test]\nfn set_pool_total_insurance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set pool_total_insurance eq 100 DOT.\n\t\tassert_ok!(TestPools::set_pool_total_insurance(\n\t\t\tCurrencyId::DOT,\n\t\t\tONE_HUNDRED_DOLLARS\n\t\t));\n\t\tassert_eq!(\u003cPools\u003e::get(CurrencyId::DOT).total_insurance, ONE_HUNDRED_DOLLARS);\n\t});\n}\n\n#[test]\nfn set_user_total_borrowed_and_interest_index_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set user_total_borrowed eq 100 DOT and user_interest_index eq 0.33.\n\t\tassert_ok!(TestPools::set_user_total_borrowed_and_interest_index(\n\t\t\t\u0026ALICE,\n\t\t\tCurrencyId::DOT,\n\t\t\tONE_HUNDRED_DOLLARS,\n\t\t\tRate::saturating_from_rational(33, 100)\n\t\t));\n\t\tassert_eq!(\n\t\t\t\u003cPoolUserDates\u003cTest\u003e\u003e::get(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\tONE_HUNDRED_DOLLARS\n\t\t);\n\t\tassert_eq!(\n\t\t\t\u003cPoolUserDates\u003cTest\u003e\u003e::get(CurrencyId::DOT, ALICE).interest_index,\n\t\t\tRate::saturating_from_rational(33, 100)\n\t\t);\n\t});\n}\n\n#[test]\nfn set_accrual_interest_params_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set pool total_borrowed eq 100 DOT and pool total_insurance eq 10_000 DOT.\n\t\tassert_ok!(TestPools::set_accrual_interest_params(\n\t\t\tCurrencyId::DOT,\n\t\t\tONE_HUNDRED_DOLLARS,\n\t\t\tTEN_THOUSAND\n\t\t));\n\t\tassert_eq!(\u003cPools\u003e::get(CurrencyId::DOT).total_borrowed, ONE_HUNDRED_DOLLARS);\n\t\tassert_eq!(\u003cPools\u003e::get(CurrencyId::DOT).total_insurance, TEN_THOUSAND);\n\t});\n}\n\n#[test]\nfn enable_as_collateral_internal_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice enable as collateral DOT pool.\n\t\tassert_ok!(TestPools::enable_as_collateral_internal(\u0026ALICE, CurrencyId::DOT));\n\n\t\tassert!(\u003cPoolUserDates\u003cTest\u003e\u003e::get(CurrencyId::DOT, ALICE).collateral);\n\t});\n}\n\n#[test]\nfn disable_collateral_internal_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice disable collateral DOT pool.\n\t\tassert_ok!(TestPools::disable_collateral_internal(\u0026ALICE, CurrencyId::DOT));\n\n\t\tassert!(!\u003cPoolUserDates\u003cTest\u003e\u003e::get(CurrencyId::DOT, ALICE).collateral);\n\t});\n}\n\n#[test]\nfn get_pool_available_liquidity_should_work() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, TEN_THOUSAND)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), TEN_THOUSAND);\n\t\t});\n}\n\n#[test]\nfn get_pool_total_borrowed_should_work() {\n\tExtBuilder::default()\n\t\t.pool_with_params(CurrencyId::DOT, TEN_THOUSAND, Rate::default(), Balance::default())\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), TEN_THOUSAND);\n\t\t});\n}\n\n#[test]\nfn get_pool_total_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.pool_with_params(CurrencyId::DOT, Balance::default(), Rate::default(), TEN_THOUSAND)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), TEN_THOUSAND);\n\t\t});\n}\n\n#[test]\nfn get_pool_borrow_index_should_work() {\n\tExtBuilder::default()\n\t\t.pool_with_params(\n\t\t\tCurrencyId::DOT,\n\t\t\tBalance::default(),\n\t\t\tRate::saturating_from_rational(125, 100),\n\t\t\tBalance::default(),\n\t\t)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_pool_borrow_index(CurrencyId::DOT),\n\t\t\t\tRate::saturating_from_rational(125, 100)\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_user_total_borrowed_should_work() {\n\tExtBuilder::default()\n\t\t.pool_user_data_with_params(CurrencyId::DOT, ALICE, ONE_HUNDRED_DOLLARS, Rate::default(), true)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tONE_HUNDRED_DOLLARS\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn check_user_available_collateral_should_work() {\n\tExtBuilder::default()\n\t\t.pool_user_data_with_params(CurrencyId::DOT, ALICE, Balance::default(), Rate::default(), false)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// collateral parameter is set to false\n\t\t\tassert!(!TestPools::check_user_available_collateral(\u0026ALICE, CurrencyId::DOT));\n\n\t\t\t// set collateral parameter to true\n\t\t\tassert_ok!(TestPools::enable_as_collateral_internal(\u0026ALICE, CurrencyId::DOT));\n\n\t\t\tassert!(TestPools::check_user_available_collateral(\u0026ALICE, CurrencyId::DOT));\n\t\t});\n}\n\n#[test]\nfn pool_should_exists() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TestPools::pool_exists(\u0026CurrencyId::DOT), true);\n\t\t\tassert_eq!(TestPools::pool_exists(\u0026CurrencyId::MDOT), false);\n\t\t});\n}\n\n#[test]\nfn update_state_on_borrow_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED_DOLLARS)\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::from_inner(0)\n\t\t\t);\n\n\t\t\t// Alice borrow 60 DOT\n\t\t\tassert_ok!(TestPools::update_state_on_borrow(\u0026ALICE, CurrencyId::DOT, 60, 0));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 60);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 60);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::default()\n\t\t\t);\n\n\t\t\tassert_ok!(TestPools::set_pool_borrow_index(\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tRate::saturating_from_rational(1, 5)\n\t\t\t));\n\n\t\t\t// ALice borrow 30 DOT\n\t\t\tassert_ok!(TestPools::update_state_on_borrow(\u0026ALICE, CurrencyId::DOT, 30, 60));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 90);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 90);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::saturating_from_rational(1, 5)\n\t\t\t);\n\n\t\t\t// Overflow in calculation: account_borrow_new = 90 + max_value()\n\t\t\tassert_noop!(\n\t\t\t\tTestPools::update_state_on_borrow(\u0026ALICE, CurrencyId::DOT, Balance::max_value(), 90),\n\t\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn update_state_on_repay_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::from_inner(0)\n\t\t\t);\n\t\t\tassert_ok!(TestPools::update_state_on_borrow(\u0026ALICE, CurrencyId::DOT, 60, 0));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 60);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 60);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::default()\n\t\t\t);\n\n\t\t\tassert_ok!(TestPools::update_state_on_repay(\u0026ALICE, CurrencyId::DOT, 30, 60));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 30);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 30);\n\n\t\t\tassert_ok!(TestPools::update_state_on_repay(\u0026ALICE, CurrencyId::DOT, 10, 30));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 20);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 20);\n\n\t\t\tassert_noop!(\n\t\t\t\tTestPools::update_state_on_repay(\u0026ALICE, CurrencyId::DOT, 100, 20),\n\t\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn convert_to_wrapped_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.user_balance(ALICE, CurrencyId::MDOT, ONE_HUNDRED)\n\t\t.pool_total_borrowed(CurrencyId::DOT, 40)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// exchange_rate = 40 / 100 = 0.4\n\t\t\tassert_eq!(TestPools::convert_to_wrapped(CurrencyId::DOT, 10), Ok(25));\n\n\t\t\t// Overflow in calculation: wrapped_amount = max_value() / exchange_rate,\n\t\t\t// when exchange_rate \u003c 1\n\t\t\tassert_err!(\n\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, Balance::max_value()),\n\t\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn convert_from_wrapped_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.user_balance(ALICE, CurrencyId::MDOT, ONE_HUNDRED)\n\t\t.user_balance(ALICE, CurrencyId::MBTC, 1)\n\t\t.pool_balance(CurrencyId::BTC, 100)\n\t\t.pool_total_borrowed(CurrencyId::DOT, 40)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// underlying_amount = 10 * 0.4 = 4\n\t\t\tassert_eq!(TestPools::convert_from_wrapped(CurrencyId::MDOT, 10), Ok(4));\n\n\t\t\t// Overflow in calculation: underlying_amount = max_value() * exchange_rate\n\t\t\tassert_err!(\n\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MBTC, Balance::max_value()),\n\t\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn calculate_exchange_rate_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// exchange_rate = (102 - 2 + 20) / 100 = 1.2\n\t\tassert_eq!(\n\t\t\tTestPools::calculate_exchange_rate(102, 100, 2, 20),\n\t\t\tOk(Rate::saturating_from_rational(12, 10))\n\t\t);\n\t\t// If there are no tokens minted: exchangeRate = InitialExchangeRate = 1.0\n\t\tassert_eq!(\n\t\t\tTestPools::calculate_exchange_rate(102, 0, 2, 0),\n\t\t\tOk(Rate::saturating_from_rational(1, 1))\n\t\t);\n\n\t\t// Overflow in calculation: total_cash + total_borrowed\n\t\tassert_noop!(\n\t\t\tTestPools::calculate_exchange_rate(Balance::max_value(), 100, 100, 100),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: cash_plus_borrows - total_insurance\n\t\tassert_noop!(\n\t\t\tTestPools::calculate_exchange_rate(100, 100, Balance::max_value(), 100),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn get_exchange_rate_should_work() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, dollars(100_u128))\n\t\t.user_balance(ALICE, CurrencyId::MDOT, dollars(125_u128))\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(300_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// exchange_rate = (100 - 0 + 300) / 125 = 3.2\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\tOk(Rate::saturating_from_rational(32, 10))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_wrapped_id_by_underlying_asset_id_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_eq!(\n\t\t\tTestPools::get_wrapped_id_by_underlying_asset_id(\u0026CurrencyId::DOT),\n\t\t\tOk(CurrencyId::MDOT)\n\t\t);\n\t\tassert_noop!(\n\t\t\tTestPools::get_wrapped_id_by_underlying_asset_id(\u0026CurrencyId::MDOT),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn get_underlying_asset_id_by_wrapped_id_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_eq!(\n\t\t\tTestPools::get_underlying_asset_id_by_wrapped_id(\u0026CurrencyId::MDOT),\n\t\t\tOk(CurrencyId::DOT)\n\t\t);\n\t\tassert_noop!(\n\t\t\tTestPools::get_underlying_asset_id_by_wrapped_id(\u0026CurrencyId::DOT),\n\t\t\tError::\u003cTest\u003e::NotValidWrappedTokenId\n\t\t);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","m-tokens","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, ensure};\nuse frame_system::{self as system, ensure_signed};\nuse minterest_primitives::{Balance, CurrencyId};\nuse orml_traits::MultiCurrency;\nuse orml_utilities::with_transaction_result;\nuse sp_runtime::traits::StaticLookup;\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\npub trait Trait: system::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n\n\t/// The `MultiCurrency` implementation for wrapped.\n\ttype MultiCurrency: MultiCurrency\u003cSelf::AccountId, Balance = Balance, CurrencyId = CurrencyId\u003e;\n}\n\ndecl_event! {\n\tpub enum Event\u003cT\u003e\n\twhere\n\t\tAccountId = \u003cT as system::Trait\u003e::AccountId,\n\t{\n\t\t/// Approval is made. [currency_id, owner, spender, amount]\n\t\tApproval(CurrencyId, AccountId, AccountId, Balance),\n\t}\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as MTokens {\n\t\t/// Allowance for an account and token.\n\t\tAllowance get(fn allowance): map hasher(blake2_128_concat) (CurrencyId, T::AccountId, T::AccountId) =\u003e Balance;\n\t}\n}\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Overflow in calculating allowance.\n\t\tOverflowAllowance,\n\n\t\t/// Allowance does not exist.\n\t\tAllowanceDoesNotExist,\n\n\t\t/// Not enough allowance.\n\t\tNotEnoughAllowance,\n\n\t\t/// Underflow in calculating allowance.\n\t\tUnderflowAllowance,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\t\tfn deposit_event() = default;\n\n\t\t/// Allows `spender` to withdraw from the caller's account multiple times, up to\n\t\t/// the `value` amount.\n\t\t///\n\t\t/// If this function is called again it overwrites the current allowance with `value`.\n\t\t#[weight = 10_000]\n\t\tfn approve(origin,\n\t\t\tspender: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: CurrencyId,\n\t\t\t#[compact] value: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\t\tlet spender = T::Lookup::lookup(spender)?;\n\n\t\t\t\tlet allowance = Self::allowance((currency_id, sender.clone(), spender.clone()));\n\t\t\t\tlet updated_allowance = allowance.checked_add(value)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::OverflowAllowance)?;\n\t\t\t\t\u003cAllowance\u003cT\u003e\u003e::insert((currency_id, sender.clone(), spender.clone()), updated_allowance);\n\n\t\t\t\tSelf::deposit_event(RawEvent::Approval(currency_id, sender, spender, value));\n\t\t\t\tOk(())\n\t\t\t})?\n\t\t}\n\n\t\t/// Transfers `value` tokens on the behalf of `from` to the account `to`.\n\t\t#[weight = 10_000]\n\t\tfn transfer_from(_origin,\n\t\t\tfrom: T::AccountId,\n\t\t\tto: T::AccountId,\n\t\t\tcurrency_id: CurrencyId,\n\t\t\t#[compact] value: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tensure!(\n\t\t\t\t\t\u003cAllowance\u003cT\u003e\u003e::contains_key((currency_id, from.clone(), to.clone())),\n\t\t\t\t\tError::\u003cT\u003e::AllowanceDoesNotExist\n\t\t\t\t );\n\t\t\t\tlet allowance = Self::allowance((currency_id, from.clone(), to.clone()));\n\t\t\t\tensure!(\n\t\t\t\t\tallowance \u003e= value,\n\t\t\t\t\tError::\u003cT\u003e::NotEnoughAllowance\n\t\t\t\t);\n\n\t\t\t\tlet updated_allowance = allowance.checked_sub(value)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::UnderflowAllowance)?;\n\n\t\t\t\tT::MultiCurrency::transfer(currency_id, \u0026from, \u0026to, value)?;\n\t\t\t\t\u003cAllowance\u003cT\u003e\u003e::insert((currency_id, from.clone(), to.clone()), updated_allowance);\n\n\t\t\t\tSelf::deposit_event(RawEvent::Approval(currency_id, from.clone(), to.clone(), value));\n\t\t\t\tOk(())\n\t\t\t})?\n\t\t}\n\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","m-tokens","src","mock.rs"],"content":"/// Mocks for the m-tokens module.\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\npub use minterest_primitives::{Balance, CurrencyId};\nuse orml_currencies::Currency;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod m_tokens {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e, orml_currencies\u003cT\u003e,\n\t\tm_tokens\u003cT\u003e,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\ntype AccountId = u32;\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype AccountData = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\ntype Amount = i128;\n\nimpl orml_tokens::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\ntype NativeCurrency = Currency\u003cRuntime, GetNativeCurrencyId\u003e;\n\nimpl orml_currencies::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cRuntime\u003e;\n\ttype NativeCurrency = NativeCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_currencies::Module\u003cRuntime\u003e;\n}\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub type MTokens = Module\u003cRuntime\u003e;\npub const ONE_MILL: Balance = 1_000_000;\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t}\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn balances(mut self, endowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e) -\u003e Self {\n\t\tself.endowed_accounts = endowed_accounts;\n\t\tself\n\t}\n\n\tpub fn one_million_mint_and_mdot_for_alice(self) -\u003e Self {\n\t\tself.balances(vec![\n\t\t\t(ALICE, CurrencyId::MINT, ONE_MILL),\n\t\t\t(ALICE, CurrencyId::MDOT, ONE_MILL),\n\t\t])\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut storage = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut storage)\n\t\t.unwrap();\n\n\t\tlet mut ext = sp_io::TestExternalities::new(storage);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","m-tokens","src","tests.rs"],"content":"/// Unit tests for the m-tokens module.\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_noop, assert_ok};\n\n#[test]\nfn approve_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 33));\n\t\tassert_ok!(MTokens::approve(Origin::signed(BOB), ALICE, CurrencyId::MKSM, 45));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 33);\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MKSM, BOB, ALICE)), 45);\n\t});\n}\n\n#[test]\nfn double_approve_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::METH, 33));\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::METH, 67));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::METH, ALICE, BOB)), 100);\n\t});\n}\n\n#[test]\nfn approve_fails_if_overflow() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\tassert_noop!(\n\t\t\tMTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::OverflowAllowance\n\t\t);\n\t});\n}\n\n#[test]\nfn transfer_from_should_work() {\n\tExtBuilder::default()\n\t\t.one_million_mint_and_mdot_for_alice()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\t\tassert_ok!(MTokens::transfer_from(\n\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\tALICE,\n\t\t\t\tBOB,\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\t50\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn transfer_from_not_enough_allowance() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\tassert_noop!(\n\t\t\tMTokens::transfer_from(Origin::signed(ALICE), ALICE, BOB, CurrencyId::MDOT, 101),\n\t\t\tError::\u003cRuntime\u003e::NotEnoughAllowance\n\t\t);\n\t});\n}\n\n#[test]\nfn transfer_from_fails_if_balance_too_low() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\tassert_noop!(\n\t\t\tMTokens::transfer_from(Origin::signed(ALICE), ALICE, BOB, CurrencyId::MDOT, 50),\n\t\t\torml_tokens::Error::\u003cRuntime\u003e::BalanceTooLow\n\t\t);\n\t});\n}\n\n#[test]\nfn transfer_from_fails_if_allowance_does_not_exist() {\n\tExtBuilder::default()\n\t\t.one_million_mint_and_mdot_for_alice()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\t\tassert_noop!(\n\t\t\t\tMTokens::transfer_from(Origin::signed(ALICE), ALICE, BOB, CurrencyId::DOT, 50),\n\t\t\t\tError::\u003cRuntime\u003e::AllowanceDoesNotExist\n\t\t\t);\n\t\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-model","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, ensure, traits::Get};\nuse frame_system::{self as system, ensure_signed};\nuse minterest_primitives::{CurrencyId, Rate};\nuse orml_utilities::with_transaction_result;\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::{\n\ttraits::{CheckedAdd, CheckedDiv, CheckedMul},\n\tDispatchError, DispatchResult, FixedPointNumber, RuntimeDebug,\n};\nuse sp_std::{cmp::Ordering, result};\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, Clone, RuntimeDebug, Eq, PartialEq, Default)]\npub struct MinterestModelData {\n\t/// The utilization point at which the jump multiplier is applied\n\tpub kink: Rate,\n\n\t/// The base interest rate which is the y-intercept when utilization rate is 0\n\tpub base_rate_per_block: Rate,\n\n\t/// The multiplier of utilization rate that gives the slope of the interest rate\n\tpub multiplier_per_block: Rate,\n\n\t/// The multiplierPerBlock after hitting a specified utilization point\n\tpub jump_multiplier_per_block: Rate,\n}\n\ntype Accounts\u003cT\u003e = accounts::Module\u003cT\u003e;\ntype LiquidityPools\u003cT\u003e = liquidity_pools::Module\u003cT\u003e;\n\npub trait Trait: system::Trait + accounts::Trait + liquidity_pools::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n\n\t/// The approximate number of blocks per year\n\ttype BlocksPerYear: Get\u003cu128\u003e;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as MinterestModel {\n\t\t/// The Minterest Model data information: `(kink, base_rate_per_block, multiplier_per_block, jump_multiplier_per_block)`.\n\t\tpub MinterestModelDates get(fn minterest_model_dates) config(): map hasher(blake2_128_concat) CurrencyId =\u003e MinterestModelData;\n\t}\n}\n\ndecl_event!(\n\tpub enum Event {\n\t\t/// JumpMultiplierPerBlock has been successfully changed.\n\t\tJumpMultiplierPerBlockHasChanged,\n\n\t\t/// BaseRatePerBlock has been successfully changed.\n\t\tBaseRatePerBlockHasChanged,\n\n\t\t/// MultiplierPerBlock has been successfully changed.\n\t\tMultiplierPerBlockHasChanged,\n\n\t\t/// Parameter `kink` has been successfully changed.\n\t\tKinkHasChanged,\n\t}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The currency is not enabled in protocol.\n\t\tNotValidUnderlyingAssetId,\n\n\t\t/// Number overflow in calculation.\n\t\tNumOverflow,\n\n\t\t/// Base rate per block cannot be set to 0 at the same time as Multiplier per block.\n\t\tBaseRatePerBlockCannotBeZero,\n\n\t\t/// Multiplier per block cannot be set to 0 at the same time as Base rate per block.\n\t\tMultiplierPerBlockCannotBeZero,\n\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\tRequireAdmin,\n\n\t\t/// Parameter `kink` cannot be more than one.\n\t\tKinkCannotBeMoreThanOne,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Set JumpMultiplierPerBlock from JumpMultiplierPerYear.\n\t\t/// - `pool_id`: PoolID for which the parameter value is being set.\n\t\t/// - `jump_multiplier_rate_per_year_n`: numerator.\n\t\t/// - `jump_multiplier_rate_per_year_d`: divider.\n\t\t///\n\t\t/// `jump_multiplier_per_block = (jump_multiplier_rate_per_year_n / jump_multiplier_rate_per_year_d) / blocks_per_year`\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_jump_multiplier_per_block(origin, pool_id: CurrencyId, jump_multiplier_rate_per_year_n: u128, jump_multiplier_rate_per_year_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\t// jump_multiplier_per_block = (jump_multiplier_rate_per_year_n / jump_multiplier_rate_per_year_d) / blocks_per_year\n\t\t\tlet new_jump_multiplier_per_year = Rate::checked_from_rational(jump_multiplier_rate_per_year_n, jump_multiplier_rate_per_year_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\tlet new_jump_multiplier_per_block = new_jump_multiplier_per_year\n\t\t\t\t.checked_div(\u0026Rate::from_inner(T::BlocksPerYear::get()))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t// Write the previously calculated values into storage.\n\t\t\tMinterestModelDates::mutate(pool_id, |r| r.jump_multiplier_per_block = new_jump_multiplier_per_block);\n\n\t\t\tSelf::deposit_event(Event::JumpMultiplierPerBlockHasChanged);\n\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Set BaseRatePerBlock from BaseRatePerYear.\n\t\t/// - `pool_id`: PoolID for which the parameter value is being set.\n\t\t/// - `base_rate_per_year_n`: numerator.\n\t\t/// - `base_rate_per_year_d`: divider.\n\t\t///\n\t\t/// `base_rate_per_block = base_rate_per_year_n / base_rate_per_year_d`\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_base_rate_per_block(origin, pool_id: CurrencyId, base_rate_per_year_n: u128, base_rate_per_year_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\tlet new_base_rate_per_year = Rate::checked_from_rational(base_rate_per_year_n, base_rate_per_year_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\tlet new_base_rate_per_block = new_base_rate_per_year\n\t\t\t\t.checked_div(\u0026Rate::from_inner(T::BlocksPerYear::get()))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t// Base rate per block cannot be set to 0 at the same time as Multiplier per block.\n\t\t\tif new_base_rate_per_block.is_zero() {\n\t\t\t\tensure!(!Self::minterest_model_dates(pool_id).multiplier_per_block.is_zero(), Error::\u003cT\u003e::BaseRatePerBlockCannotBeZero);\n\t\t\t}\n\n\t\t\t// Write the previously calculated values into storage.\n\t\t\tMinterestModelDates::mutate(pool_id, |r| r.base_rate_per_block = new_base_rate_per_block);\n\n\t\t\tSelf::deposit_event(Event::BaseRatePerBlockHasChanged);\n\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Set MultiplierPerBlock from MultiplierPerYear.\n\t\t/// - `pool_id`: PoolID for which the parameter value is being set.\n\t\t/// - `multiplier_rate_per_year_n`: numerator.\n\t\t/// - `multiplier_rate_per_year_d`: divider.\n\t\t///\n\t\t/// `multiplier_per_block = (multiplier_rate_per_year_n / multiplier_rate_per_year_d) / blocks_per_year`\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_multiplier_per_block(origin, pool_id: CurrencyId, multiplier_rate_per_year_n: u128, multiplier_rate_per_year_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\tlet new_multiplier_per_year = Rate::checked_from_rational(multiplier_rate_per_year_n, multiplier_rate_per_year_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\tlet new_multiplier_per_block = new_multiplier_per_year\n\t\t\t\t.checked_div(\u0026Rate::from_inner(T::BlocksPerYear::get()))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t// Multiplier per block cannot be set to 0 at the same time as Base rate per block .\n\t\t\tif new_multiplier_per_block.is_zero() {\n\t\t\t\tensure!(!Self::minterest_model_dates(pool_id).base_rate_per_block.is_zero(), Error::\u003cT\u003e::MultiplierPerBlockCannotBeZero);\n\t\t\t}\n\n\t\t\t// Write the previously calculated values into storage.\n\t\t\tMinterestModelDates::mutate(pool_id, |r| r.multiplier_per_block = new_multiplier_per_block);\n\t\t\tSelf::deposit_event(Event::MultiplierPerBlockHasChanged);\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Set parameter `kink`.\n\t\t/// - `pool_id`: PoolID for which the parameter value is being set.\n\t\t/// - `kink_nominator`: numerator.\n\t\t/// - `kink_divider`: divider.\n\t\t///\n\t\t/// `kink = kink_nominator / kink_divider`\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_kink(origin, pool_id: CurrencyId, kink_nominator: u128, kink_divider: u128) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\n\t\t\t\tensure!(\n\t\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t\t);\n\n\t\t\t\tensure!(kink_nominator \u003c= kink_divider, Error::\u003cT\u003e::KinkCannotBeMoreThanOne);\n\n\t\t\t\tlet new_kink = Rate::checked_from_rational(kink_nominator, kink_divider)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t\t// Write the previously calculated values into storage.\n\t\t\t\tMinterestModelDates::mutate(pool_id, |r| r.kink = new_kink);\n\t\t\t\tSelf::deposit_event(Event::KinkHasChanged);\n\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\t}\n}\n\ntype RateResult = result::Result\u003cRate, DispatchError\u003e;\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Calculates the current borrow rate per block.\n\t/// - `underlying_asset_id`: Asset ID for which the borrow interest rate is calculated.\n\t/// - `utilization_rate`: Current Utilization rate value.\n\t///\n\t/// returns `borrow_interest_rate`.\n\tpub fn calculate_borrow_interest_rate(underlying_asset_id: CurrencyId, utilization_rate: Rate) -\u003e RateResult {\n\t\tlet kink = Self::minterest_model_dates(underlying_asset_id).kink;\n\t\tlet multiplier_per_block = Self::minterest_model_dates(underlying_asset_id).multiplier_per_block;\n\t\tlet base_rate_per_block = Self::minterest_model_dates(underlying_asset_id).base_rate_per_block;\n\n\t\t// if utilization_rate \u003e kink:\n\t\t// normal_rate = kink * multiplier_per_block + base_rate_per_block\n\t\t// excess_util = utilization_rate * kink\n\t\t// borrow_rate = excess_util * jump_multiplier_per_block + normal_rate\n\t\t//\n\t\t// if utilization_rate \u003c= kink:\n\t\t// borrow_rate = utilization_rate * multiplier_per_block + base_rate_per_block\n\t\tlet borrow_interest_rate = match utilization_rate.cmp(\u0026kink) {\n\t\t\tOrdering::Greater =\u003e {\n\t\t\t\tlet jump_multiplier_per_block =\n\t\t\t\t\tSelf::minterest_model_dates(underlying_asset_id).jump_multiplier_per_block;\n\t\t\t\tlet normal_rate = kink\n\t\t\t\t\t.checked_mul(\u0026multiplier_per_block)\n\t\t\t\t\t.and_then(|v| v.checked_add(\u0026base_rate_per_block))\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\tlet excess_util = utilization_rate.checked_mul(\u0026kink).ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t\texcess_util\n\t\t\t\t\t.checked_mul(\u0026jump_multiplier_per_block)\n\t\t\t\t\t.and_then(|v| v.checked_add(\u0026normal_rate))\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?\n\t\t\t}\n\t\t\t_ =\u003e utilization_rate\n\t\t\t\t.checked_mul(\u0026multiplier_per_block)\n\t\t\t\t.and_then(|v| v.checked_add(\u0026base_rate_per_block))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?,\n\t\t};\n\n\t\tOk(borrow_interest_rate)\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-model","src","mock.rs"],"content":"/// Mocks for the minterest-model pallet.\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, ModuleId, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\nmod minterest_model {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e,\n\t\tminterest_model,\n\t\taccounts\u003cT\u003e,\n\t\tliquidity_pools,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Test;\n\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n}\n\ntype AccountId = u32;\n\nimpl system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype AccountData = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n}\n\nimpl orml_tokens::Trait for Test {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = MAX_MEMBERS;\n}\n\nimpl accounts::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MaxMembers = MaxMembers;\n}\n\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl liquidity_pools::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\nparameter_types! {\n\tpub const BlocksPerYear: u128 = BLOCKS_PER_YEAR;\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype BlocksPerYear = BlocksPerYear;\n}\n\ntype Amount = i128;\n\npub type TestMinterestModel = Module\u003cTest\u003e;\npub type System = frame_system::Module\u003cTest\u003e;\npub const BLOCKS_PER_YEAR: u128 = 5_256_000;\npub const MAX_MEMBERS: u32 = 16;\npub const ALICE: AccountId = 1;\npub fn alice() -\u003e Origin {\n\tOrigin::signed(ALICE)\n}\npub const BOB: AccountId = 2;\npub fn bob() -\u003e Origin {\n\tOrigin::signed(BOB)\n}\n\npub fn new_test_ext() -\u003e sp_io::TestExternalities {\n\tlet mut t = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\tcrate::GenesisConfig {\n\t\tminterest_model_dates: vec![\n\t\t\t(\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tMinterestModelData {\n\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t},\n\t\t\t),\n\t\t\t(\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tMinterestModelData {\n\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t},\n\t\t\t),\n\t\t\t(\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tMinterestModelData {\n\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t},\n\t\t\t),\n\t\t],\n\t}\n\t.assimilate_storage(\u0026mut t)\n\t.unwrap();\n\n\taccounts::GenesisConfig::\u003cTest\u003e {\n\t\tallowed_accounts: vec![(ALICE, ())],\n\t}\n\t.assimilate_storage(\u0026mut t)\n\t.unwrap();\n\n\tlet mut ext: sp_io::TestExternalities = t.into();\n\text.execute_with(|| System::set_block_number(1));\n\text\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-model","src","tests.rs"],"content":"//! Tests for the minterest-model pallet.\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_noop, assert_ok};\n\nfn multiplier_per_block_equal_max_value() -\u003e MinterestModelData {\n\tMinterestModelData {\n\t\tkink: Rate::saturating_from_rational(12, 10),\n\t\tbase_rate_per_block: Rate::from_inner(0),\n\t\tmultiplier_per_block: Rate::from_inner(u128::max_value()),\n\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t}\n}\n\nfn base_rate_per_block_equal_max_value() -\u003e MinterestModelData {\n\tMinterestModelData {\n\t\tkink: Rate::saturating_from_rational(12, 10),\n\t\tbase_rate_per_block: Rate::from_inner(u128::max_value()),\n\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t}\n}\n\n#[test]\nfn set_base_rate_per_block_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\t// Can be set to 0.0\n\t\tassert_ok!(TestMinterestModel::set_base_rate_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t0,\n\t\t\t1\n\t\t));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).base_rate_per_block,\n\t\t\tRate::from_inner(0)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::BaseRatePerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// ALICE set Baser rate per block equal 2.0\n\t\tassert_ok!(TestMinterestModel::set_base_rate_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t20,\n\t\t\t10\n\t\t));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).base_rate_per_block,\n\t\t\tRate::saturating_from_rational(2_000_000_000_000_000_000u128, BLOCKS_PER_YEAR)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::BaseRatePerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// Base rate per block cannot be set to 0 at the same time as Multiplier per block.\n\t\tassert_ok!(TestMinterestModel::set_multiplier_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t0,\n\t\t\t1\n\t\t));\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::DOT, 0, 1),\n\t\t\tError::\u003cTest\u003e::BaseRatePerBlockCannotBeZero\n\t\t);\n\n\t\t// Overflow in calculation: 20 / 0\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::DOT, 20, 0),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// The dispatch origin of this call must be Administrator.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(bob(), CurrencyId::DOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::RequireAdmin\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn set_multiplier_per_block_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\t// Set Base rate per block equal 2.0\n\t\tassert_ok!(TestMinterestModel::set_base_rate_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t20,\n\t\t\t10\n\t\t));\n\n\t\t// Can be set to 0.0\n\t\tassert_ok!(TestMinterestModel::set_multiplier_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t0,\n\t\t\t10\n\t\t));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).multiplier_per_block,\n\t\t\tRate::from_inner(0)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::MultiplierPerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// Alice set Multiplier per block equal 2.0 / 5_256_000\n\t\tassert_ok!(TestMinterestModel::set_multiplier_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t20,\n\t\t\t10\n\t\t));\n\t\tlet expected_event = TestEvent::minterest_model(Event::MultiplierPerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).multiplier_per_block,\n\t\t\tRate::saturating_from_rational(2_000_000_000_000_000_000u128, BLOCKS_PER_YEAR)\n\t\t);\n\n\t\t//  Multiplier per block cannot be set to 0 at the same time as Base rate per block.\n\t\tassert_ok!(TestMinterestModel::set_base_rate_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t0,\n\t\t\t1\n\t\t));\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_multiplier_per_block(alice(), CurrencyId::DOT, 0, 1),\n\t\t\tError::\u003cTest\u003e::MultiplierPerBlockCannotBeZero\n\t\t);\n\n\t\t// Overflow in calculation: 20 / 0\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_multiplier_per_block(alice(), CurrencyId::DOT, 20, 0),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// The dispatch origin of this call must be Administrator.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_multiplier_per_block(bob(), CurrencyId::DOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::RequireAdmin\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn set_jump_multiplier_per_block_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(TestMinterestModel::set_jump_multiplier_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t20,\n\t\t\t10\n\t\t));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).jump_multiplier_per_block,\n\t\t\tRate::saturating_from_rational(2_000_000_000_000_000_000u128, BLOCKS_PER_YEAR)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::JumpMultiplierPerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// Overflow in calculation: 20 / 0\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_jump_multiplier_per_block(alice(), CurrencyId::DOT, 20, 0),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// The dispatch origin of this call must be Administrator.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_jump_multiplier_per_block(bob(), CurrencyId::DOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::RequireAdmin\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn set_kink_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(TestMinterestModel::set_kink(alice(), CurrencyId::DOT, 8, 10));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).kink,\n\t\t\tRate::saturating_from_rational(8, 10)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::KinkHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// Overflow in calculation: 0 / 0\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_kink(alice(), CurrencyId::DOT, 0, 0),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// The dispatch origin of this call must be Administrator.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_kink(bob(), CurrencyId::DOT, 8, 10),\n\t\t\tError::\u003cTest\u003e::RequireAdmin\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_kink(alice(), CurrencyId::MDOT, 8, 10),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// Parameter `kink` cannot be more than one.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_kink(alice(), CurrencyId::DOT, 18, 10),\n\t\t\tError::\u003cTest\u003e::KinkCannotBeMoreThanOne\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_borrow_interest_rate_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\t// Utilization rate less or equal than kink:\n\t\t// utilization_rate = 0.42\n\t\t// borrow_interest_rate = 0,42 * multiplier_per_block + base_rate_per_block\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::calculate_borrow_interest_rate(\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tRate::saturating_from_rational(42, 100)\n\t\t\t),\n\t\t\tOk(Rate::from_inner(3_780_000_000))\n\t\t);\n\n\t\t// Utilization rate larger than kink:\n\t\t// utilization_rate = 0.9\n\t\t// borrow_interest_rate = 0.9 * 0.8 * jump_multiplier_per_block +\n\t\t// + (0.8 * multiplier_per_block) + base_rate_per_block\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::calculate_borrow_interest_rate(CurrencyId::DOT, Rate::saturating_from_rational(9, 10)),\n\t\t\tOk(Rate::from_inner(156_240_000_000))\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_borrow_interest_rate_fails_if_overflow_kink_mul_multiplier() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet minterest_model_data = multiplier_per_block_equal_max_value();\n\t\t\u003cMinterestModelDates\u003e::insert(CurrencyId::KSM, minterest_model_data.clone());\n\t\t// utilization_rate \u003e kink.\n\t\t// Overflow in calculation: kink * multiplier_per_block = 1.01 * max_value()\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::calculate_borrow_interest_rate(\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tRate::saturating_from_rational(101, 100)\n\t\t\t),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_borrow_interest_rate_fails_if_overflow_add_base_rate_per_block() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet minterest_model_data = base_rate_per_block_equal_max_value();\n\t\t\u003cMinterestModelDates\u003e::insert(CurrencyId::KSM, minterest_model_data.clone());\n\t\t// utilization_rate \u003e kink.\n\t\t// Overflow in calculation: kink_mul_multiplier + base_rate_per_block = ... + max_value()\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::calculate_borrow_interest_rate(CurrencyId::KSM, Rate::saturating_from_rational(9, 10)),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-protocol","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, ensure};\nuse frame_system::{self as system, ensure_signed};\nuse minterest_primitives::{Balance, CurrencyId, Operation};\nuse orml_traits::MultiCurrency;\nuse orml_utilities::with_transaction_result;\nuse pallet_traits::Borrowing;\nuse sp_runtime::{traits::Zero, DispatchError, DispatchResult};\nuse sp_std::cmp::Ordering;\nuse sp_std::result;\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\npub trait Trait: liquidity_pools::Trait + controller::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n\n\t/// Basic borrowing functions\n\ttype Borrowing: Borrowing\u003cSelf::AccountId\u003e;\n}\n\ntype LiquidityPools\u003cT\u003e = liquidity_pools::Module\u003cT\u003e;\ntype Controller\u003cT\u003e = controller::Module\u003cT\u003e;\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as MinterestProtocol {\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as system::Trait\u003e::AccountId,\n\t{\n\t\t/// Underlying assets added to pool and wrapped tokens minted: \\[who, underlying_asset_id, underlying_amount, wrapped_currency_id, wrapped_amount\\]\n\t\tDeposited(AccountId, CurrencyId, Balance, CurrencyId, Balance),\n\n\t\t/// Underlying assets and wrapped tokens redeemed: \\[who, underlying_asset_id, underlying_amount, wrapped_currency_id, wrapped_amount\\]\n\t\tRedeemed(AccountId, CurrencyId, Balance, CurrencyId, Balance),\n\n\t\t/// Borrowed a specific amount of the pool currency: \\[who, underlying_asset_id, the_amount_to_be_borrowed\\]\n\t\tBorrowed(AccountId, CurrencyId, Balance),\n\n\t\t/// Repaid a borrow on the specific pool, for the specified amount: \\[who, underlying_asset_id, the_amount_repaid\\]\n\t\tRepaid(AccountId, CurrencyId, Balance),\n\n\t\t/// The user allowed the assets in the pool to be used as collateral: \\[who, pool_id\\]\n\t\tPoolEnabledAsCollateral(AccountId, CurrencyId),\n\n\t\t/// The user denies use the assets in pool as collateral: \\[who, pool_id\\]\n\t\tPoolDisabledCollateral(AccountId, CurrencyId),\n\t}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The currency is not enabled in protocol.\n\t\tNotValidUnderlyingAssetId,\n\n\t\t/// The currency is not enabled in wrapped protocol.\n\t\tNotValidWrappedTokenId,\n\n\t\t/// There is not enough liquidity available in the pool.\n\t\tNotEnoughLiquidityAvailable,\n\n\t\t/// Insufficient wrapped tokens in the user account.\n\t\tNotEnoughWrappedTokens,\n\n\t\t/// User did not make deposit (no mTokens).\n\t\tNumberOfWrappedTokensIsZero,\n\n\t\t/// Insufficient underlying assets in the user account.\n\t\tNotEnoughUnderlyingsAssets,\n\n\t\t/// Number overflow in calculation.\n\t\tNumOverflow,\n\n\t\t/// An internal failure occurred in the execution of the Accrue Interest function.\n\t\tAccrueInterestFailed,\n\n\t\t/// Deposit was blocked due to Controller rejection.\n\t\tDepositControllerRejection,\n\n\t\t/// Redeem was blocked due to Controller rejection.\n\t\tRedeemControllerRejection,\n\n\t\t/// Borrow was blocked due to Controller rejection.\n\t\tBorrowControllerRejection,\n\n\t\t/// Repay was blocked due to Controller rejection.\n\t\tRepayBorrowControllerRejection,\n\n\t\t/// Transaction with zero balance is not allowed.\n\t\tZeroBalanceTransaction,\n\n\t\t/// User is trying repay more than he borrowed.\n\t\tRepayAmountToBig,\n\n\t\t/// This pool is already collateral.\n\t\tAlreadyCollateral,\n\n\t\t/// This pool has already been disabled as a collateral.\n\t\tAlreadyDisabledCollateral,\n\n\t\t/// The user has an outstanding borrow. Cannot be disabled as collateral.\n\t\tCanotBeDisabledAsCollateral,\n\n\t\t/// The user has not deposited funds into the pool.\n\t\tCanotBeEnabledAsCollateral,\n\n\t\t/// Operation (deposit, redeem, borrow, repay) is paused.\n\t\tOperationPaused,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\t\tfn deposit_event() = default;\n\n\t\t/// Transfers an asset into the protocol. The user receives a quantity of mTokens equal\n\t\t/// to the underlying tokens supplied, divided by the current Exchange Rate.\n\t\t///\n\t\t/// - `underlying_asset_id`: CurrencyId of underlying assets to be transferred into the protocol.\n\t\t/// - `underlying_amount`: The amount of the asset to be supplied, in units of the underlying asset.\n\t\t#[weight = 10_000]\n\t\tpub fn deposit_underlying(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t\t#[compact] underlying_amount: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet (_, wrapped_id, wrapped_amount) = Self::do_deposit(\u0026who, underlying_asset_id, underlying_amount)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Deposited(who, underlying_asset_id, underlying_amount, wrapped_id, wrapped_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Converts ALL mTokens into a specified quantity of the underlying asset, and returns them\n\t\t/// to the user. The amount of underlying tokens received is equal to the quantity of\n\t\t/// mTokens redeemed, multiplied by the current Exchange Rate.\n\t\t///\n\t\t/// - `underlying_asset_id`: CurrencyId of underlying assets to be redeemed.\n\t\t#[weight = 10_000]\n\t\tpub fn redeem(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet (underlying_amount, wrapped_id, wrapped_amount) = Self::do_redeem(\u0026who, underlying_asset_id, Balance::zero(), Balance::zero(), true)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Redeemed(who, underlying_asset_id, underlying_amount, wrapped_id, wrapped_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Converts mTokens into a specified quantity of the underlying asset, and returns them to\n\t\t/// the user. The amount of mTokens redeemed is equal to the quantity of underlying tokens\n\t\t/// received, divided by the current Exchange Rate.\n\t\t///\n\t\t/// - `underlying_asset_id`: CurrencyId of underlying assets to be redeemed.\n\t\t/// - `underlying_amount`: The number of underlying assets to be redeemed.\n\t\t#[weight = 10_000]\n\t\tpub fn redeem_underlying(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t\t#[compact] underlying_amount: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet (_, wrapped_id, wrapped_amount) = Self::do_redeem(\u0026who, underlying_asset_id, underlying_amount, Balance::zero(), false)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Redeemed(who, underlying_asset_id, underlying_amount, wrapped_id, wrapped_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Converts a specified quantity of mTokens into the underlying asset, and returns them to the user.\n\t\t/// The amount of underlying tokens received is equal to the quantity of mTokens redeemed,\n\t\t/// multiplied by the current Exchange Rate.\n\t\t///\n\t\t/// - `wrapped_id`: CurrencyId of mTokens to be redeemed.\n\t\t/// - `wrapped_amount`: The number of mTokens to be redeemed.\n\t\t#[weight = 10_000]\n\t\tpub fn redeem_wrapped(origin, wrapped_id: CurrencyId, #[compact] wrapped_amount: Balance) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet underlying_asset_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_underlying_asset_id_by_wrapped_id(\u0026wrapped_id).map_err(|_| Error::\u003cT\u003e::NotValidWrappedTokenId)?;\n\t\t\t\tlet (underlying_amount, wrapped_id, _) = Self::do_redeem(\u0026who, underlying_asset_id, Balance::zero(), wrapped_amount, false)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Redeemed(who, underlying_asset_id, underlying_amount, wrapped_id, wrapped_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Borrowing a specific amount of the pool currency, provided that the borrower already\n\t\t/// deposited enough collateral.\n\t\t///\n\t\t/// - `underlying_asset_id`: The currency ID of the underlying asset to be borrowed.\n\t\t/// - `underlying_amount`: The amount of the underlying asset to be borrowed.\n\t\t#[weight = 10_000]\n\t\tpub fn borrow(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t\t#[compact] borrow_amount: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tSelf::do_borrow(\u0026who, underlying_asset_id, borrow_amount)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Borrowed(who, underlying_asset_id, borrow_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Repays a borrow on the specific pool, for the specified amount.\n\t\t///\n\t\t/// - `underlying_asset_id`: The currency ID of the underlying asset to be repaid.\n\t\t/// - `repay_amount`: The amount of the underlying asset to be repaid.\n\t\t#[weight = 10_000]\n\t\tpub fn repay(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t\t#[compact] repay_amount: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tSelf::do_repay(\u0026who, \u0026who, underlying_asset_id, repay_amount, false)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Repaid(who, underlying_asset_id, repay_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Repays a borrow on the specific pool, for the all amount.\n\t\t///\n\t\t/// - `underlying_asset_id`: The currency ID of the underlying asset to be repaid.\n\t\t#[weight = 10_000]\n\t\tpub fn repay_all(origin, underlying_asset_id: CurrencyId) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet repay_amount = Self::do_repay(\u0026who, \u0026who, underlying_asset_id, Balance::zero(), true)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Repaid(who, underlying_asset_id, repay_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Transfers an asset into the protocol, reducing the target user's borrow balance.\n\t\t///\n\t\t/// - `underlying_asset_id`: The currency ID of the underlying asset to be repaid.\n\t\t/// - `borrower`: The account which borrowed the asset to be repaid.\n\t\t/// - `repay_amount`: The amount of the underlying borrowed asset to be repaid.\n\t\t#[weight = 10_000]\n\t\tpub fn repay_on_behalf(origin, underlying_asset_id: CurrencyId, borrower: T::AccountId, repay_amount: Balance) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet repay_amount = Self::do_repay(\u0026who, \u0026borrower, underlying_asset_id, repay_amount, false)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Repaid(who, underlying_asset_id, repay_amount));\n\t\t\t\tOk(())\n\t\t\t})?\n\t\t}\n\n\t\t/// Sender allowed the assets in the pool to be used as collateral.\n\t\t#[weight = 10_000]\n\t\tpub fn enable_as_collateral(origin, pool_id: CurrencyId) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\tensure!(!\u003cLiquidityPools\u003cT\u003e\u003e::check_user_available_collateral(\u0026sender, pool_id), Error::\u003cT\u003e::AlreadyCollateral);\n\n\t\t\t// If user does not have assets in the pool, then he cannot enable as collateral the pool.\n\t\t\tlet wrapped_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_wrapped_id_by_underlying_asset_id(\u0026pool_id)?;\n\t\t\tlet user_wrapped_balance = T::MultiCurrency::free_balance(wrapped_id, \u0026sender);\n\t\t\tensure!(user_wrapped_balance \u003e 0, Error::\u003cT\u003e::CanotBeEnabledAsCollateral);\n\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::enable_as_collateral_internal(\u0026sender, pool_id)?;\n\t\t\tSelf::deposit_event(RawEvent::PoolEnabledAsCollateral(sender, pool_id));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Sender has denies use the assets in pool as collateral.\n\t\t#[weight = 10_000]\n\t\tpub fn disable_collateral(origin, pool_id: CurrencyId) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::check_user_available_collateral(\u0026sender, pool_id), Error::\u003cT\u003e::AlreadyDisabledCollateral);\n\n\t\t\tlet wrapped_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_wrapped_id_by_underlying_asset_id(\u0026pool_id)?;\n\t\t\tlet user_balance_wrapped_tokens = T::MultiCurrency::free_balance(wrapped_id, \u0026sender);\n\t\t\tlet user_balance_disabled_asset = \u003cLiquidityPools\u003cT\u003e\u003e::convert_from_wrapped(wrapped_id, user_balance_wrapped_tokens)?;\n\n\t\t\t// Check if the user will have enough collateral if he removes one of the collaterals.\n\t\t\tlet (_, shortfall) = \u003cController\u003cT\u003e\u003e::get_hypothetical_account_liquidity(\u0026sender, pool_id, user_balance_disabled_asset, 0)?;\n\t\t\tensure!(!(shortfall \u003e 0), Error::\u003cT\u003e::CanotBeDisabledAsCollateral);\n\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::disable_collateral_internal(\u0026sender, pool_id)?;\n\t\t\tSelf::deposit_event(RawEvent::PoolDisabledCollateral(sender, pool_id));\n\t\t\tOk(())\n\t\t}\n\t}\n}\n\ntype TokensResult = result::Result\u003c(Balance, CurrencyId, Balance), DispatchError\u003e;\ntype BalanceResult = result::Result\u003cBalance, DispatchError\u003e;\n\n// Dispatchable calls implementation\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tfn do_deposit(who: \u0026T::AccountId, underlying_asset_id: CurrencyId, underlying_amount: Balance) -\u003e TokensResult {\n\t\tensure!(\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\tensure!(underlying_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\n\t\tensure!(\n\t\t\tunderlying_amount \u003c= T::MultiCurrency::free_balance(underlying_asset_id, \u0026who),\n\t\t\tError::\u003cT\u003e::NotEnoughLiquidityAvailable\n\t\t);\n\n\t\t\u003cController\u003cT\u003e\u003e::accrue_interest_rate(underlying_asset_id).map_err(|_| Error::\u003cT\u003e::AccrueInterestFailed)?;\n\n\t\t// Fail if deposit not allowed\n\t\tensure!(\n\t\t\t\u003cController\u003cT\u003e\u003e::is_operation_allowed(underlying_asset_id, Operation::Deposit),\n\t\t\tError::\u003cT\u003e::OperationPaused\n\t\t);\n\n\t\tlet wrapped_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_wrapped_id_by_underlying_asset_id(\u0026underlying_asset_id)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NotValidUnderlyingAssetId)?;\n\n\t\tlet wrapped_amount = \u003cLiquidityPools\u003cT\u003e\u003e::convert_to_wrapped(underlying_asset_id, underlying_amount)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tT::MultiCurrency::transfer(\n\t\t\tunderlying_asset_id,\n\t\t\t\u0026who,\n\t\t\t\u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(),\n\t\t\tunderlying_amount,\n\t\t)?;\n\n\t\tT::MultiCurrency::deposit(wrapped_id, \u0026who, wrapped_amount)?;\n\n\t\tOk((underlying_amount, wrapped_id, wrapped_amount))\n\t}\n\n\tfn do_redeem(\n\t\twho: \u0026T::AccountId,\n\t\tunderlying_asset_id: CurrencyId,\n\t\tmut underlying_amount: Balance,\n\t\twrapped_amount: Balance,\n\t\tall_assets: bool,\n\t) -\u003e TokensResult {\n\t\tensure!(\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t\u003cController\u003cT\u003e\u003e::accrue_interest_rate(underlying_asset_id).map_err(|_| Error::\u003cT\u003e::AccrueInterestFailed)?;\n\n\t\tlet wrapped_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_wrapped_id_by_underlying_asset_id(\u0026underlying_asset_id)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NotValidUnderlyingAssetId)?;\n\n\t\tlet wrapped_amount = match (underlying_amount, wrapped_amount, all_assets) {\n\t\t\t(0, 0, true) =\u003e {\n\t\t\t\tlet total_wrapped_amount = T::MultiCurrency::free_balance(wrapped_id, \u0026who);\n\t\t\t\tensure!(!total_wrapped_amount.is_zero(), Error::\u003cT\u003e::NumberOfWrappedTokensIsZero);\n\t\t\t\tunderlying_amount = \u003cLiquidityPools\u003cT\u003e\u003e::convert_from_wrapped(wrapped_id, total_wrapped_amount)\n\t\t\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\ttotal_wrapped_amount\n\t\t\t}\n\t\t\t(_, 0, false) =\u003e {\n\t\t\t\tensure!(underlying_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::convert_to_wrapped(underlying_asset_id, underlying_amount)\n\t\t\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?\n\t\t\t}\n\t\t\t_ =\u003e {\n\t\t\t\tensure!(wrapped_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\t\t\t\tunderlying_amount = \u003cLiquidityPools\u003cT\u003e\u003e::convert_from_wrapped(wrapped_id, wrapped_amount)\n\t\t\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\twrapped_amount\n\t\t\t}\n\t\t};\n\n\t\tensure!(\n\t\t\tunderlying_amount \u003c= \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_available_liquidity(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotEnoughLiquidityAvailable\n\t\t);\n\n\t\tensure!(\n\t\t\twrapped_amount \u003c= T::MultiCurrency::free_balance(wrapped_id, \u0026who),\n\t\t\tError::\u003cT\u003e::NotEnoughWrappedTokens\n\t\t);\n\n\t\t// Fail if redeem not allowed\n\t\tensure!(\n\t\t\t\u003cController\u003cT\u003e\u003e::is_operation_allowed(underlying_asset_id, Operation::Redeem),\n\t\t\tError::\u003cT\u003e::OperationPaused\n\t\t);\n\t\t\u003cController\u003cT\u003e\u003e::redeem_allowed(underlying_asset_id, \u0026who, wrapped_amount)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::RedeemControllerRejection)?;\n\n\t\tT::MultiCurrency::withdraw(wrapped_id, \u0026who, wrapped_amount)?;\n\n\t\tT::MultiCurrency::transfer(\n\t\t\tunderlying_asset_id,\n\t\t\t\u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(),\n\t\t\t\u0026who,\n\t\t\tunderlying_amount,\n\t\t)?;\n\n\t\tOk((underlying_amount, wrapped_id, wrapped_amount))\n\t}\n\n\t/// Users borrow assets from the protocol to their own address\n\t///\n\t/// - `who`: the address of the user who borrows.\n\t/// - `underlying_asset_id`: the currency ID of the underlying asset to borrow.\n\t/// - `underlying_amount`: the amount of the underlying asset to borrow.\n\tfn do_borrow(who: \u0026T::AccountId, underlying_asset_id: CurrencyId, borrow_amount: Balance) -\u003e DispatchResult {\n\t\tensure!(\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\tlet pool_available_liquidity = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_available_liquidity(underlying_asset_id);\n\n\t\t// Raise an error if protocol has insufficient underlying cash.\n\t\tensure!(\n\t\t\tborrow_amount \u003c= pool_available_liquidity,\n\t\t\tError::\u003cT\u003e::NotEnoughLiquidityAvailable\n\t\t);\n\n\t\tensure!(borrow_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\n\t\t\u003cController\u003cT\u003e\u003e::accrue_interest_rate(underlying_asset_id).map_err(|_| Error::\u003cT\u003e::AccrueInterestFailed)?;\n\n\t\t// Fail if borrow not allowed.\n\t\tensure!(\n\t\t\t\u003cController\u003cT\u003e\u003e::is_operation_allowed(underlying_asset_id, Operation::Borrow),\n\t\t\tError::\u003cT\u003e::OperationPaused\n\t\t);\n\t\t\u003cController\u003cT\u003e\u003e::borrow_allowed(underlying_asset_id, \u0026who, borrow_amount)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::BorrowControllerRejection)?;\n\n\t\t// Fetch the amount the borrower owes, with accumulated interest.\n\t\tlet account_borrows =\n\t\t\t\u003cController\u003cT\u003e\u003e::borrow_balance_stored(\u0026who, underlying_asset_id).map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::update_state_on_borrow(\u0026who, underlying_asset_id, borrow_amount, account_borrows)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t// Transfer the borrow_amount from the protocol account to the borrower's account.\n\t\tT::MultiCurrency::transfer(\n\t\t\tunderlying_asset_id,\n\t\t\t\u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(),\n\t\t\t\u0026who,\n\t\t\tborrow_amount,\n\t\t)?;\n\n\t\tOk(())\n\t}\n\n\t/// Sender repays their own borrow\n\t///\n\t/// - `who`: the account paying off the borrow.\n\t/// - `borrower`: the account with the debt being payed off.\n\t/// - `underlying_asset_id`: the currency ID of the underlying asset to repay.\n\t/// - `repay_amount`: the amount of the underlying asset to repay.\n\tfn do_repay(\n\t\twho: \u0026T::AccountId,\n\t\tborrower: \u0026T::AccountId,\n\t\tunderlying_asset_id: CurrencyId,\n\t\tmut repay_amount: Balance,\n\t\tall_assets: bool,\n\t) -\u003e BalanceResult {\n\t\tensure!(\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\tif !all_assets {\n\t\t\tensure!(repay_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\t\t}\n\n\t\t\u003cController\u003cT\u003e\u003e::accrue_interest_rate(underlying_asset_id).map_err(|_| Error::\u003cT\u003e::AccrueInterestFailed)?;\n\n\t\t// Fail if repay_borrow not allowed\n\t\tensure!(\n\t\t\t\u003cController\u003cT\u003e\u003e::is_operation_allowed(underlying_asset_id, Operation::Repay),\n\t\t\tError::\u003cT\u003e::OperationPaused\n\t\t);\n\n\t\t// Fetch the amount the borrower owes, with accumulated interest\n\t\tlet account_borrows = \u003cController\u003cT\u003e\u003e::borrow_balance_stored(\u0026borrower, underlying_asset_id)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\n\t\trepay_amount = match repay_amount.cmp(\u0026Balance::zero()) {\n\t\t\tOrdering::Equal =\u003e account_borrows,\n\t\t\t_ =\u003e repay_amount,\n\t\t};\n\n\t\tensure!(\n\t\t\trepay_amount \u003c= T::MultiCurrency::free_balance(underlying_asset_id, \u0026who),\n\t\t\tError::\u003cT\u003e::NotEnoughUnderlyingsAssets\n\t\t);\n\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::update_state_on_repay(\u0026borrower, underlying_asset_id, repay_amount, account_borrows)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::RepayAmountToBig)?;\n\n\t\t// Transfer the repay_amount from the borrower's account to the protocol account.\n\t\tT::MultiCurrency::transfer(\n\t\t\tunderlying_asset_id,\n\t\t\t\u0026who,\n\t\t\t\u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(),\n\t\t\trepay_amount,\n\t\t)?;\n\n\t\tOk(repay_amount)\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-protocol","src","mock.rs"],"content":"//! Mocks for the minterest-protocol module.\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse liquidity_pools::{Pool, PoolUserData};\nuse minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\nuse orml_currencies::Currency;\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{IdentityLookup, Zero},\n\tFixedPointNumber, ModuleId, Perbill,\n};\n\nuse super::*;\nuse controller::{ControllerData, PauseKeeper};\n\nmod minterest_protocol {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e,\n\t\torml_currencies\u003cT\u003e,\n\t\tliquidity_pools,\n\t\tminterest_protocol\u003cT\u003e,\n\t\tcontroller,\n\t\toracle,\n\t\taccounts\u003cT\u003e,\n\t\tminterest_model,\n\t}\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Test where system = frame_system {}\n}\n\n#[derive(Clone, PartialEq, Eq)]\npub struct Test;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u32;\nimpl frame_system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype AccountData = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n}\n\nimpl orml_tokens::Trait for Test {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\ntype NativeCurrency = Currency\u003cTest, GetNativeCurrencyId\u003e;\n\nimpl orml_currencies::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype NativeCurrency = NativeCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl liquidity_pools::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\nimpl controller::Trait for Test {\n\ttype Event = TestEvent;\n}\n\nimpl oracle::Trait for Test {\n\ttype Event = TestEvent;\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = MAX_MEMBERS;\n}\n\nimpl accounts::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MaxMembers = MaxMembers;\n}\n\nparameter_types! {\n\tpub const BlocksPerYear: u128 = 5256000;\n}\n\nimpl minterest_model::Trait for Test {\n\ttype Event = TestEvent;\n\ttype BlocksPerYear = BlocksPerYear;\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype Borrowing = MockBorrowing;\n}\n\npub struct MockBorrowing;\nimpl Borrowing\u003cAccountId\u003e for MockBorrowing {\n\tfn update_state_on_borrow(\n\t\t_who: \u0026AccountId,\n\t\t_underlying_asset_id: CurrencyId,\n\t\t_amount_borrowed: Balance,\n\t\t_account_borrows: Balance,\n\t) -\u003e DispatchResult {\n\t\tOk(())\n\t}\n\n\tfn update_state_on_repay(\n\t\t_who: \u0026AccountId,\n\t\t_underlying_asset_id: CurrencyId,\n\t\t_amount_borrowed: Balance,\n\t\t_account_borrows: Balance,\n\t) -\u003e DispatchResult {\n\t\tOk(())\n\t}\n}\n\ntype Amount = i128;\n\npub const ALICE: AccountId = 1;\npub fn alice() -\u003e Origin {\n\tOrigin::signed(ALICE)\n}\npub const BOB: AccountId = 2;\npub fn bob() -\u003e Origin {\n\tOrigin::signed(BOB)\n}\npub const DOLLARS: Balance = 1_000_000_000_000_000_000;\npub const ONE_MILL_DOLLARS: Balance = 1_000_000 * DOLLARS;\npub const ONE_HUNDRED_DOLLARS: Balance = 100 * DOLLARS;\npub const TEN_THOUSAND_DOLLARS: Balance = 10_000 * DOLLARS;\npub const MAX_MEMBERS: u32 = 16;\npub type TestProtocol = Module\u003cTest\u003e;\npub type TestPools = liquidity_pools::Module\u003cTest\u003e;\npub type Currencies = orml_currencies::Module\u003cTest\u003e;\npub type System = frame_system::Module\u003cTest\u003e;\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![\n\t\t\t\t// seed: initial DOTs. Initial MINT to pay for gas.\n\t\t\t\t(ALICE, CurrencyId::MINT, ONE_MILL_DOLLARS),\n\t\t\t\t(ALICE, CurrencyId::DOT, ONE_HUNDRED_DOLLARS),\n\t\t\t\t(ALICE, CurrencyId::ETH, ONE_HUNDRED_DOLLARS),\n\t\t\t\t(ALICE, CurrencyId::KSM, ONE_HUNDRED_DOLLARS),\n\t\t\t\t(BOB, CurrencyId::MINT, ONE_MILL_DOLLARS),\n\t\t\t\t(BOB, CurrencyId::DOT, ONE_HUNDRED_DOLLARS),\n\t\t\t\t// seed: initial insurance, equal 10_000$\n\t\t\t\t(TestPools::pools_account_id(), CurrencyId::ETH, TEN_THOUSAND_DOLLARS),\n\t\t\t\t(TestPools::pools_account_id(), CurrencyId::DOT, TEN_THOUSAND_DOLLARS),\n\t\t\t\t// seed: initial insurance = 10_000$, initial pool balance = 1_000_000$\n\t\t\t\t(TestPools::pools_account_id(), CurrencyId::KSM, ONE_MILL_DOLLARS),\n\t\t\t],\n\t\t}\n\t}\n}\nimpl ExtBuilder {\n\tpub fn user_balance(mut self, user: AccountId, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts.push((user, currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cTest\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tliquidity_pools::GenesisConfig::\u003cTest\u003e {\n\t\t\tpools: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\t\ttotal_insurance: TEN_THOUSAND_DOLLARS,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\t\ttotal_insurance: TEN_THOUSAND_DOLLARS,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\t\ttotal_insurance: TEN_THOUSAND_DOLLARS,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpool_user_data: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tALICE,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tALICE,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tALICE,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tALICE,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tBOB,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tBOB,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tcontroller::GenesisConfig::\u003cTest\u003e {\n\t\t\tcontroller_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpause_keepers: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: true,\n\t\t\t\t\t\tredeem_paused: true,\n\t\t\t\t\t\tborrow_paused: true,\n\t\t\t\t\t\trepay_paused: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\taccounts::GenesisConfig::\u003cTest\u003e {\n\t\t\tallowed_accounts: vec![(ALICE, ())],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tlet mut ext: sp_io::TestExternalities = t.into();\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-protocol","src","tests.rs"],"content":"//! Tests for the minterest-protocol pallet.\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_noop, assert_ok};\n\nfn dollars\u003cT: Into\u003cu128\u003e\u003e(d: T) -\u003e Balance {\n\tDOLLARS.saturating_mul(d.into())\n}\n\n#[test]\nfn deposit_underlying_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::KSM, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposit 60 DOT; exchange_rate = 1.0\n\t\t\t// wrapped_amount = 60.0 DOT / 1.0 = 60.0\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(60_u128)\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Deposited(\n\t\t\t\tALICE,\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(60_u128),\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\tdollars(60_u128),\n\t\t\t));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\t// MDOT pool does not exist.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::deposit_underlying(alice(), CurrencyId::MDOT, 10),\n\t\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\t// Alice has 100 ETH on her account, so she cannot make a deposit 150 ETH.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::deposit_underlying(alice(), CurrencyId::ETH, dollars(150_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\n\t\t\t// Transaction with zero balance is not allowed.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::deposit_underlying(alice(), CurrencyId::DOT, Balance::zero()),\n\t\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t\t);\n\n\t\t\t// All operations in the KSM pool are paused.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::deposit_underlying(alice(), CurrencyId::KSM, dollars(10_u128)),\n\t\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposit 60 DOT; exchange_rate = 1.0\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\n\t\t// Alice redeem all 60 MDOT; exchange_rate = 1.0\n\t\tassert_ok!(TestProtocol::redeem(alice(), CurrencyId::DOT));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Redeemed(\n\t\t\tALICE,\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128),\n\t\t\tCurrencyId::MDOT,\n\t\t\tdollars(60_u128),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn redeem_should_not_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::MKSM, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Bob has 0 MDOT on her account, so she cannot make a redeem.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem(bob(), CurrencyId::DOT),\n\t\t\t\tError::\u003cTest\u003e::NumberOfWrappedTokensIsZero\n\t\t\t);\n\n\t\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem(alice(), CurrencyId::MDOT),\n\t\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\t// All operations in the KSM pool are paused.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem(alice(), CurrencyId::KSM),\n\t\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_fails_if_low_balance_in_pool() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::BTC, TEN_THOUSAND_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 10_000$ to BTC pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tTEN_THOUSAND_DOLLARS\n\t\t\t));\n\n\t\t\t// Alice borrowed 100$ from BTC pool:\n\t\t\t// pool_total_liquidity = 10_000 - 100 = 9_900$\n\t\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS));\n\n\t\t\t// Alice has 10_000 MBTC. exchange_rate = 1.0\n\t\t\t// Alice is trying to change all her 10_000 MBTC tokens to BTC. She can't do it because:\n\t\t\t// pool_total_liquidity = 9_900 \u003c 10_000 * 1.0 = 10_000\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem(alice(), CurrencyId::BTC),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_underlying_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::MKSM, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 60 DOT to the pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(60_u128)\n\t\t\t));\n\n\t\t\t// Alice can't redeem 100 DOT, because 100 DOT equal 100 * 1.0 = 100 MDOT\n\t\t\t// And she has 60 MDOT on her balance.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::DOT, dollars(100_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughWrappedTokens\n\t\t\t);\n\n\t\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::MDOT, dollars(20_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\t// Transaction with zero balance is not allowed.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::DOT, Balance::zero()),\n\t\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t\t);\n\n\t\t\t// All operations in the KSM pool are paused.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::KSM, dollars(10_u128)),\n\t\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t\t);\n\n\t\t\tassert_ok!(TestProtocol::redeem_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(30_u128)\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Redeemed(\n\t\t\t\tALICE,\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(30_u128),\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\tdollars(30_u128),\n\t\t\t));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t});\n}\n\n#[test]\nfn redeem_underlying_fails_if_low_balance_in_pool() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::BTC, TEN_THOUSAND_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 10_000$ to BTC pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tTEN_THOUSAND_DOLLARS\n\t\t\t));\n\n\t\t\t// Alice borrowed 100$ from BTC pool:\n\t\t\t// pool_total_liquidity = 10_000 - 100 = 9_900$\n\t\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS));\n\n\t\t\t// Alice has 10_000 MBTC. exchange_rate = 1.0\n\t\t\t// Alice is trying to change all her 10_000 MBTC tokens to BTC. She can't do it because:\n\t\t\t// pool_total_liquidity = 9_900 BTC \u003c 10_000 BTC\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::BTC, TEN_THOUSAND_DOLLARS),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_wrapped_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::MKSM, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 60 DOT to the pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(60_u128)\n\t\t\t));\n\n\t\t\t// Alice has 60 MDOT. She can't redeem 100 MDOT.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::MDOT, dollars(100_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughWrappedTokens\n\t\t\t);\n\n\t\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::DOT, dollars(20_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotValidWrappedTokenId\n\t\t\t);\n\n\t\t\t// Transaction with zero balance is not allowed.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::MDOT, Balance::zero()),\n\t\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t\t);\n\n\t\t\t// All operations in the KSM pool are paused.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::MKSM, dollars(10_u128)),\n\t\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t\t);\n\n\t\t\tassert_ok!(TestProtocol::redeem_wrapped(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\tdollars(35_u128)\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Redeemed(\n\t\t\t\tALICE,\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(35_u128),\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\tdollars(35_u128),\n\t\t\t));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t});\n}\n\n#[test]\nfn redeem_wrapped_fails_if_low_balance_in_pool() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::BTC, TEN_THOUSAND_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 10_000$ to BTC pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tTEN_THOUSAND_DOLLARS\n\t\t\t));\n\n\t\t\t// Alice borrowed 100$ from BTC pool:\n\t\t\t// pool_total_liquidity = 10_000 - 100 = 9_900$\n\t\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS));\n\n\t\t\t// Alice has 10_000 MBTC. exchange_rate = 1.0\n\t\t\t// Alice is trying to change all her 10_000 MBTC tokens to BTC. She can't do it because:\n\t\t\t// pool_total_liquidity = 9_900 BTC \u003c 10_000 MBTC * 1.0 = 10_000 BTC\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::MBTC, TEN_THOUSAND_DOLLARS),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn borrow_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\t\t// total_pool_liquidity = 10_000 (insurance) + 60 = 10_060\n\t\tassert_eq!(\n\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\tdollars(10_060_u128)\n\t\t);\n\n\t\t// Alice cannot borrow 100 DOT because she deposited 60 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::borrow(alice(), CurrencyId::DOT, dollars(100_u128)),\n\t\t\tError::\u003cTest\u003e::BorrowControllerRejection\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestProtocol::borrow(alice(), CurrencyId::MDOT, dollars(60_u128)),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// Transaction with zero balance is not allowed.\n\t\tassert_noop!(\n\t\t\tTestProtocol::borrow(alice(), CurrencyId::DOT, Balance::zero()),\n\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t);\n\n\t\t// All operations in the KSM pool are paused.\n\t\tassert_noop!(\n\t\t\tTestProtocol::borrow(alice(), CurrencyId::KSM, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t);\n\n\t\t// Alice borrowed 30 DOT\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\t\tlet expected_event =\n\t\t\tTestEvent::minterest_protocol(RawEvent::Borrowed(ALICE, CurrencyId::DOT, dollars(30_u128)));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn borrow_fails_if_low_balance_in_pool() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::BTC, TEN_THOUSAND_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 100$ to BTC pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tONE_HUNDRED_DOLLARS\n\t\t\t));\n\n\t\t\t// set total_pool_liquidity = 50 DOT\n\t\t\tassert_ok!(Currencies::withdraw(\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\u0026TestPools::pools_account_id(),\n\t\t\t\tdollars(50_u128)\n\t\t\t));\n\n\t\t\t// Alice cannot borrow 100 BTC because there is 50 BTC in the pool.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\n\t\t\t// set total_pool_liquidity = 0 DOT\n\t\t\tassert_ok!(Currencies::withdraw(\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\u0026TestPools::pools_account_id(),\n\t\t\t\tdollars(50_u128)\n\t\t\t));\n\n\t\t\t// Alice cannot borrow 100 BTC because there is 0 BTC in the pool.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn repay_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\t\t// Alice borrowed 30 DOT from the pool.\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\t\t// Alice balance = 70 DOT\n\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), dollars(70_u128));\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::MDOT, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// Alice cannot repay 100 DOT, because she only have 70 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::DOT, dollars(100_u128)),\n\t\t\tError::\u003cTest\u003e::NotEnoughUnderlyingsAssets\n\t\t);\n\n\t\t// Alice cannot repay 70 DOT, because she only borrowed 60 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::DOT, dollars(70_u128)),\n\t\t\tError::\u003cTest\u003e::RepayAmountToBig\n\t\t);\n\n\t\t// Transaction with zero balance is not allowed.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::DOT, Balance::zero()),\n\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t);\n\n\t\t// All operations in the KSM pool are paused.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::KSM, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t);\n\n\t\t// Alice repaid 20 DOT. Her borrow_balance = 10 DOT.\n\t\tassert_ok!(TestProtocol::repay(alice(), CurrencyId::DOT, dollars(20_u128)));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Repaid(ALICE, CurrencyId::DOT, dollars(20_u128)));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn repay_all_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\t\t// Alice borrowed 30 DOT from the pool.\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_all(alice(), CurrencyId::MDOT),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// All operations in the KSM pool are paused.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_all(alice(), CurrencyId::KSM),\n\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t);\n\n\t\t// Alice repaid all 30 DOT.\n\t\tassert_ok!(TestProtocol::repay_all(alice(), CurrencyId::DOT));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Repaid(ALICE, CurrencyId::DOT, dollars(30_u128)));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn repay_all_fails_if_not_enough_underlying_assets() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\t\t// Alice borrowed 30 DOT from the pool.\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\n\t\t// Alice deposited 70 DOT to the pool. Now she have 0 DOT in her account.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(70_u128)\n\t\t));\n\n\t\t// Insufficient DOT in the ALICE account for repay 30 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_all(alice(), CurrencyId::DOT),\n\t\t\tError::\u003cTest\u003e::NotEnoughUnderlyingsAssets\n\t\t);\n\t});\n}\n\n#[test]\nfn repay_on_behalf_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\n\t\t// Alice borrowed 30 DOT from the pool.\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::MDOT, ALICE, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// Bob can't pay off the 120 DOT debt for Alice, because he has 100 DOT in his account.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::DOT, ALICE, dollars(120_u128)),\n\t\t\tError::\u003cTest\u003e::NotEnoughUnderlyingsAssets\n\t\t);\n\n\t\t// Bob cannot repay 100 DOT, because Alice only borrowed 60 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::DOT, ALICE, dollars(100_u128)),\n\t\t\tError::\u003cTest\u003e::RepayAmountToBig\n\t\t);\n\n\t\t// Transaction with zero balance is not allowed.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::DOT, ALICE, Balance::zero()),\n\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t);\n\n\t\t// All operations in the KSM pool are paused.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::KSM, ALICE, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t);\n\n\t\t// Bob repaid 20 DOT for Alice.\n\t\tassert_ok!(TestProtocol::repay_on_behalf(\n\t\t\tbob(),\n\t\t\tCurrencyId::DOT,\n\t\t\tALICE,\n\t\t\tdollars(20_u128)\n\t\t));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Repaid(BOB, CurrencyId::DOT, dollars(20_u128)));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn enable_as_collateral_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice cannot enable as collateral ETH pool, because she has not deposited funds into the pool.\n\t\tassert_noop!(\n\t\t\tTestProtocol::enable_as_collateral(alice(), CurrencyId::ETH),\n\t\t\tError::\u003cTest\u003e::CanotBeEnabledAsCollateral\n\t\t);\n\n\t\t// Alice deposit 60 ETH\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::ETH,\n\t\t\tdollars(60_u128)\n\t\t));\n\n\t\t// Alice enable as collateral her ETH pool.\n\t\tassert_ok!(TestProtocol::enable_as_collateral(alice(), CurrencyId::ETH));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::PoolEnabledAsCollateral(ALICE, CurrencyId::ETH));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert!(TestPools::check_user_available_collateral(\u0026ALICE, CurrencyId::ETH));\n\n\t\t// ETH pool is already collateral.\n\t\tassert_noop!(\n\t\t\tTestProtocol::enable_as_collateral(alice(), CurrencyId::ETH),\n\t\t\tError::\u003cTest\u003e::AlreadyCollateral\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tTestProtocol::enable_as_collateral(alice(), CurrencyId::MDOT),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn disable_collateral_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_noop!(\n\t\t\tTestProtocol::disable_collateral(alice(), CurrencyId::ETH),\n\t\t\tError::\u003cTest\u003e::AlreadyDisabledCollateral\n\t\t);\n\n\t\t// Alice deposit 60 ETH\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::ETH,\n\t\t\tdollars(60_u128)\n\t\t));\n\n\t\t// Alice enable as collateral her ETH pool.\n\t\tassert_ok!(TestProtocol::enable_as_collateral(alice(), CurrencyId::ETH));\n\n\t\t// Alice disable collateral her ETH pool.\n\t\tassert_ok!(TestProtocol::disable_collateral(alice(), CurrencyId::ETH));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::PoolDisabledCollateral(ALICE, CurrencyId::ETH));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert!(!TestPools::check_user_available_collateral(\u0026ALICE, CurrencyId::ETH));\n\n\t\tassert_noop!(\n\t\t\tTestProtocol::disable_collateral(alice(), CurrencyId::ETH),\n\t\t\tError::\u003cTest\u003e::AlreadyDisabledCollateral\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tTestProtocol::disable_collateral(alice(), CurrencyId::MDOT),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","oracle","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage};\nuse minterest_primitives::{CurrencyId, Price};\nuse sp_runtime::DispatchError;\nuse sp_std::result;\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Exchange {\n\t}\n}\n\ndecl_event!(\n\tpub enum Event {}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\t}\n}\n\ntype PriceResult = result::Result\u003cPrice, DispatchError\u003e;\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tpub fn get_underlying_price(_underlying_asset_id: CurrencyId) -\u003e PriceResult {\n\t\tlet price_nine_dollars = 2_00u128 * 10_000_000_000_000_000;\n\t\tOk(Price::from_inner(price_nine_dollars)) // Price = 2.00 USD\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","traits","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse minterest_primitives::{Balance, CurrencyId};\nuse sp_runtime::DispatchResult;\n\n/// An abstraction of basic borrowing functions\npub trait Borrowing\u003cAccountId\u003e {\n\t/// Updates the state of the core as a consequence of a borrow action.\n\tfn update_state_on_borrow(\n\t\twho: \u0026AccountId,\n\t\tunderlying_asset_id: CurrencyId,\n\t\tamount_borrowed: Balance,\n\t\taccount_borrows: Balance,\n\t) -\u003e DispatchResult;\n\n\t/// updates the state of the core as a consequence of a repay action.\n\tfn update_state_on_repay(\n\t\twho: \u0026AccountId,\n\t\tunderlying_asset_id: CurrencyId,\n\t\trepay_amount: Balance,\n\t\taccount_borrows: Balance,\n\t) -\u003e DispatchResult;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","primitives","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse sp_runtime::{\n\tgeneric,\n\ttraits::{IdentifyAccount, Verify},\n\tFixedU128, MultiSignature, RuntimeDebug,\n};\n\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\n\n/// An index to a block.\npub type BlockNumber = u32;\n\n/// Alias to 512-bit hash when used in the context of a transaction signature on the chain.\npub type Signature = MultiSignature;\n\n/// Some way of identifying an account on the chain. We intentionally make it equivalent\n/// to the public key of our transaction signing scheme.\npub type AccountId = \u003c\u003cSignature as Verify\u003e::Signer as IdentifyAccount\u003e::AccountId;\n\n/// The type for looking up accounts. We don't expect more than 4 billion of them, but you\n/// never know...\npub type AccountIndex = u32;\n\n/// Balance of an account.\npub type Balance = u128;\n\n/// Index of a transaction in the chain.\npub type Index = u32;\n\n/// A hash of some data used by the chain.\npub type Hash = sp_core::H256;\n\n/// Digest item type.\npub type DigestItem = generic::DigestItem\u003cHash\u003e;\n\n/// Signed version of Balance\npub type Amount = i128;\n\n/// Exchange Rate\npub type Rate = FixedU128;\n\n/// Token Price\npub type Price = FixedU128;\n\n#[derive(Encode, Decode, Eq, PartialEq, Copy, Clone, RuntimeDebug, PartialOrd, Ord)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub enum CurrencyId {\n\tMINT = 0,\n\tDOT,\n\tKSM,\n\tBTC,\n\tETH,\n\tMDOT,\n\tMKSM,\n\tMBTC,\n\tMETH,\n}\n\n#[derive(Encode, Decode, Eq, PartialEq, Copy, Clone, RuntimeDebug, PartialOrd, Ord)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub struct CurrencyPair {\n\tpub underlying_id: CurrencyId,\n\tpub wrapped_id: CurrencyId,\n}\n\nimpl CurrencyPair {\n\tpub fn new(underlying_id: CurrencyId, wrapped_id: CurrencyId) -\u003e Self {\n\t\tSelf {\n\t\t\tunderlying_id,\n\t\t\twrapped_id,\n\t\t}\n\t}\n}\n\n#[derive(Encode, Decode, Eq, PartialEq, Copy, Clone, RuntimeDebug, PartialOrd, Ord)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub enum Operation {\n\tDeposit,\n\tRedeem,\n\tBorrow,\n\tRepay,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","rpc","src","lib.rs"],"content":"use std::sync::Arc;\n\nuse node_minterest_runtime::{opaque::Block, AccountId, Balance, Index};\npub use sc_rpc_api::DenyUnsafe;\nuse sp_api::ProvideRuntimeApi;\nuse sp_block_builder::BlockBuilder;\nuse sp_blockchain::{Error as BlockChainError, HeaderBackend, HeaderMetadata};\nuse sp_transaction_pool::TransactionPool;\n\n/// Full client dependencies.\npub struct FullDeps\u003cC, P\u003e {\n\t/// The client instance to use.\n\tpub client: Arc\u003cC\u003e,\n\t/// Transaction pool instance.\n\tpub pool: Arc\u003cP\u003e,\n\t/// Whether to deny unsafe calls\n\tpub deny_unsafe: DenyUnsafe,\n}\n\n/// Instantiate all full RPC extensions.\npub fn create_full\u003cC, P\u003e(deps: FullDeps\u003cC, P\u003e) -\u003e jsonrpc_core::IoHandler\u003csc_rpc::Metadata\u003e\nwhere\n\tC: ProvideRuntimeApi\u003cBlock\u003e,\n\tC: HeaderBackend\u003cBlock\u003e + HeaderMetadata\u003cBlock, Error = BlockChainError\u003e + 'static,\n\tC: Send + Sync + 'static,\n\tC::Api: substrate_frame_rpc_system::AccountNonceApi\u003cBlock, AccountId, Index\u003e,\n\tC::Api: pallet_transaction_payment_rpc::TransactionPaymentRuntimeApi\u003cBlock, Balance\u003e,\n\tC::Api: controller_rpc::ControllerRuntimeApi\u003cBlock\u003e,\n\tC::Api: BlockBuilder\u003cBlock\u003e,\n\tP: TransactionPool + 'static,\n{\n\tuse controller_rpc::{Controller, ControllerApi};\n\tuse pallet_transaction_payment_rpc::{TransactionPayment, TransactionPaymentApi};\n\tuse substrate_frame_rpc_system::{FullSystem, SystemApi};\n\n\tlet mut io = jsonrpc_core::IoHandler::default();\n\tlet FullDeps {\n\t\tclient,\n\t\tpool,\n\t\tdeny_unsafe,\n\t} = deps;\n\n\tio.extend_with(SystemApi::to_delegate(FullSystem::new(\n\t\tclient.clone(),\n\t\tpool,\n\t\tdeny_unsafe,\n\t)));\n\n\tio.extend_with(TransactionPaymentApi::to_delegate(TransactionPayment::new(\n\t\tclient.clone(),\n\t)));\n\n\tio.extend_with(ControllerApi::to_delegate(Controller::new(client)));\n\t// Extend this RPC with a custom API by using the following syntax.\n\t// `YourRpcStruct` should have a reference to a client, which is needed\n\t// to call into the runtime.\n\t// `io.extend_with(YourRpcTrait::to_delegate(YourRpcStruct::new(ReferenceToClient, ...)));`\n\n\tio\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","runtime","build.rs"],"content":"use wasm_builder_runner::WasmBuilder;\n\nfn main() {\n\tWasmBuilder::new()\n\t\t.with_current_project()\n\t\t.with_wasm_builder_from_crates(\"2.0.0\")\n\t\t.export_heap_base()\n\t\t.import_memory()\n\t\t.build()\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","runtime","src","constants.rs"],"content":"//! A set of constant values used in runtime.\n\nuse minterest_primitives::Rate;\n\n/// Money matters.\npub mod currency {\n\tuse minterest_primitives::Balance;\n\n\tpub const DOLLARS: Balance = 1_000_000_000_000_000_000;\n\tpub const CENTS: Balance = DOLLARS / 100;\n\tpub const MILLICENTS: Balance = CENTS / 1000;\n}\n\n/// Time.\npub mod time {\n\tuse minterest_primitives::BlockNumber;\n\tpub const MILLISECS_PER_BLOCK: u64 = 6000;\n\n\tpub const SLOT_DURATION: u64 = MILLISECS_PER_BLOCK;\n\n\t// Time is measured by number of blocks.\n\tpub const MINUTES: BlockNumber = 60_000 / (MILLISECS_PER_BLOCK as BlockNumber);\n\tpub const HOURS: BlockNumber = MINUTES * 60;\n\tpub const DAYS: BlockNumber = HOURS * 24;\n\n\tpub const SECONDS_PER_YEAR: u128 = 365 * DAYS as u128;\n\tpub const BLOCKS_PER_YEAR: u128 = SECONDS_PER_YEAR / MILLISECS_PER_BLOCK as u128;\n\t// BLOCKS_PER_YEAR has to be 5256000\n}\n\n/// A maximum number of admins. When membership reaches this number, no new members may join.\npub const MAX_MEMBERS: u32 = 16;\n\n/// Initial exchange rate: 100%\npub const INITIAL_EXCHANGE_RATE: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","runtime","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n// `construct_runtime!` does a lot of recursion and requires us to increase the limit to 256.\n#![recursion_limit = \"256\"]\n// The `large_enum_variant` warning originates from `construct_runtime` macro.\n#![allow(clippy::large_enum_variant)]\n\n// Make the WASM binary available.\n#[cfg(feature = \"std\")]\ninclude!(concat!(env!(\"OUT_DIR\"), \"/wasm_binary.rs\"));\n\nmod constants;\n#[cfg(test)]\nmod tests;\n\npub use controller_rpc_runtime_api::PoolState;\nuse orml_currencies::BasicCurrencyAdapter;\nuse pallet_grandpa::fg_primitives;\nuse pallet_grandpa::{AuthorityId as GrandpaId, AuthorityList as GrandpaAuthorityList};\nuse sp_api::impl_runtime_apis;\nuse sp_consensus_aura::sr25519::AuthorityId as AuraId;\nuse sp_core::{crypto::KeyTypeId, OpaqueMetadata};\nuse sp_runtime::traits::{BlakeTwo256, Block as BlockT, IdentityLookup, NumberFor, Saturating};\nuse sp_runtime::{\n\tcreate_runtime_str, generic, impl_opaque_keys,\n\ttransaction_validity::{TransactionSource, TransactionValidity},\n\tApplyExtrinsicResult, ModuleId,\n};\nuse sp_std::prelude::*;\n#[cfg(feature = \"std\")]\nuse sp_version::NativeVersion;\nuse sp_version::RuntimeVersion;\n\npub use minterest_primitives::{\n\tAccountId, AccountIndex, Amount, Balance, BlockNumber, CurrencyId, CurrencyPair, DigestItem, Hash, Index, Rate,\n\tSignature,\n};\n\n// A few exports that help ease life for downstream crates.\npub use frame_support::{\n\tconstruct_runtime, parameter_types,\n\ttraits::{KeyOwnerProofSystem, Randomness},\n\tweights::{\n\t\tconstants::{BlockExecutionWeight, ExtrinsicBaseWeight, RocksDbWeight, WEIGHT_PER_SECOND},\n\t\tIdentityFee, Weight,\n\t},\n\tStorageValue,\n};\npub use pallet_balances::Call as BalancesCall;\npub use pallet_timestamp::Call as TimestampCall;\n#[cfg(any(feature = \"std\", test))]\npub use sp_runtime::BuildStorage;\npub use sp_runtime::{Perbill, Permill};\n\npub use constants::{currency::*, time::*, *};\n\n/// Opaque types. These are used by the CLI to instantiate machinery that don't need to know\n/// the specifics of the runtime. They can then be made to be agnostic over specific formats\n/// of data like extrinsics, allowing for them to continue syncing the network through upgrades\n/// to even the core data structures.\npub mod opaque {\n\tuse super::*;\n\n\tpub use sp_runtime::OpaqueExtrinsic as UncheckedExtrinsic;\n\n\t/// Opaque block header type.\n\tpub type Header = generic::Header\u003cBlockNumber, BlakeTwo256\u003e;\n\t/// Opaque block type.\n\tpub type Block = generic::Block\u003cHeader, UncheckedExtrinsic\u003e;\n\t/// Opaque block identifier type.\n\tpub type BlockId = generic::BlockId\u003cBlock\u003e;\n\n\timpl_opaque_keys! {\n\t\tpub struct SessionKeys {\n\t\t\tpub aura: Aura,\n\t\t\tpub grandpa: Grandpa,\n\t\t}\n\t}\n}\n\npub const VERSION: RuntimeVersion = RuntimeVersion {\n\tspec_name: create_runtime_str!(\"node-minterest\"),\n\timpl_name: create_runtime_str!(\"node-minterest\"),\n\tauthoring_version: 1,\n\tspec_version: 1,\n\timpl_version: 1,\n\tapis: RUNTIME_API_VERSIONS,\n\ttransaction_version: 1,\n};\n\n/// The version information used to identify this runtime when compiled natively.\n#[cfg(feature = \"std\")]\npub fn native_version() -\u003e NativeVersion {\n\tNativeVersion {\n\t\truntime_version: VERSION,\n\t\tcan_author_with: Default::default(),\n\t}\n}\n\n// Module accounts of runtime\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n}\n\nparameter_types! {\n\tpub const BlockHashCount: BlockNumber = 2400;\n\t/// We allow for 2 seconds of compute with a 6 second average block time.\n\tpub const MaximumBlockWeight: Weight = 2 * WEIGHT_PER_SECOND;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n\t/// Assume 10% of weight for average on_initialize calls.\n\tpub MaximumExtrinsicWeight: Weight = AvailableBlockRatio::get()\n\t\t.saturating_sub(Perbill::from_percent(10)) * MaximumBlockWeight::get();\n\tpub const MaximumBlockLength: u32 = 5 * 1024 * 1024;\n\tpub const Version: RuntimeVersion = VERSION;\n}\n\n// Configure FRAME pallets to include in runtime.\n\nimpl frame_system::Trait for Runtime {\n\t/// The basic call filter to use in dispatchable.\n\ttype BaseCallFilter = ();\n\t/// The identifier used to distinguish between accounts.\n\ttype AccountId = AccountId;\n\t/// The aggregated dispatch type that is available for extrinsics.\n\ttype Call = Call;\n\t/// The lookup mechanism to get account ID from whatever is passed in dispatchers.\n\ttype Lookup = IdentityLookup\u003cAccountId\u003e;\n\t/// The index type for storing how many extrinsics an account has signed.\n\ttype Index = Index;\n\t/// The index type for blocks.\n\ttype BlockNumber = BlockNumber;\n\t/// The type for hashing blocks and tries.\n\ttype Hash = Hash;\n\t/// The hashing algorithm used.\n\ttype Hashing = BlakeTwo256;\n\t/// The header type.\n\ttype Header = generic::Header\u003cBlockNumber, BlakeTwo256\u003e;\n\t/// The ubiquitous event type.\n\ttype Event = Event;\n\t/// The ubiquitous origin type.\n\ttype Origin = Origin;\n\t/// Maximum number of block number to block hash mappings to keep (oldest pruned first).\n\ttype BlockHashCount = BlockHashCount;\n\t/// Maximum weight of each block.\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\t/// The weight of database operations that the runtime can invoke.\n\ttype DbWeight = RocksDbWeight;\n\t/// The weight of the overhead invoked on the block import process, independent of the\n\t/// extrinsics included in that block.\n\ttype BlockExecutionWeight = BlockExecutionWeight;\n\t/// The base weight of any extrinsic processed by the runtime, independent of the\n\t/// logic of that extrinsic. (Signature verification, nonce increment, fee, etc...)\n\ttype ExtrinsicBaseWeight = ExtrinsicBaseWeight;\n\t/// The maximum weight that a single extrinsic of `Normal` dispatch class can have,\n\t/// idependent of the logic of that extrinsics. (Roughly max block weight - average on\n\t/// initialize cost).\n\ttype MaximumExtrinsicWeight = MaximumExtrinsicWeight;\n\t/// Maximum size of all encoded transactions (in bytes) that are allowed in one block.\n\ttype MaximumBlockLength = MaximumBlockLength;\n\t/// Portion of the block weight that is available to all normal transactions.\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\t/// Version of the runtime.\n\ttype Version = Version;\n\t/// Converts a module to the index of the module in `construct_runtime!`.\n\t///\n\t/// This type is being generated by `construct_runtime!`.\n\ttype PalletInfo = PalletInfo;\n\t/// What to do if a new account is created.\n\ttype OnNewAccount = ();\n\t/// What to do if an account is fully reaped from the system.\n\ttype OnKilledAccount = ();\n\t/// The data to be stored in an account.\n\ttype AccountData = pallet_balances::AccountData\u003cBalance\u003e;\n\t/// Weight information for the extrinsics of this pallet.\n\ttype SystemWeightInfo = ();\n}\n\nimpl pallet_aura::Trait for Runtime {\n\ttype AuthorityId = AuraId;\n}\n\nimpl pallet_grandpa::Trait for Runtime {\n\ttype Event = Event;\n\ttype Call = Call;\n\n\ttype KeyOwnerProofSystem = ();\n\n\ttype KeyOwnerProof = \u003cSelf::KeyOwnerProofSystem as KeyOwnerProofSystem\u003c(KeyTypeId, GrandpaId)\u003e\u003e::Proof;\n\n\ttype KeyOwnerIdentification =\n\t\t\u003cSelf::KeyOwnerProofSystem as KeyOwnerProofSystem\u003c(KeyTypeId, GrandpaId)\u003e\u003e::IdentificationTuple;\n\n\ttype HandleEquivocation = ();\n\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const MinimumPeriod: u64 = SLOT_DURATION / 2;\n}\n\nimpl pallet_timestamp::Trait for Runtime {\n\t/// A timestamp: milliseconds since the unix epoch.\n\ttype Moment = u64;\n\ttype OnTimestampSet = Aura;\n\ttype MinimumPeriod = MinimumPeriod;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const ExistentialDeposit: u128 = 500;\n\tpub const MaxLocks: u32 = 50;\n}\n\nimpl pallet_balances::Trait for Runtime {\n\ttype MaxLocks = MaxLocks;\n\t/// The type for recording an account's balance.\n\ttype Balance = Balance;\n\t/// The ubiquitous event type.\n\ttype Event = Event;\n\ttype DustRemoval = ();\n\ttype ExistentialDeposit = ExistentialDeposit;\n\ttype AccountStore = System;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const TransactionByteFee: Balance = 1;\n}\n\nimpl pallet_transaction_payment::Trait for Runtime {\n\ttype Currency = Balances;\n\ttype OnTransactionPayment = ();\n\ttype TransactionByteFee = TransactionByteFee;\n\ttype WeightToFee = IdentityFee\u003cBalance\u003e;\n\ttype FeeMultiplierUpdate = ();\n}\n\nimpl pallet_sudo::Trait for Runtime {\n\ttype Event = Event;\n\ttype Call = Call;\n}\n\nimpl m_tokens::Trait for Runtime {\n\ttype Event = Event;\n\ttype MultiCurrency = Currencies;\n}\n\nimpl minterest_protocol::Trait for Runtime {\n\ttype Event = Event;\n\ttype Borrowing = liquidity_pools::Module\u003cRuntime\u003e;\n}\n\nimpl orml_tokens::Trait for Runtime {\n\ttype Event = Event;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetMinterestCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\npub type MinterestToken = BasicCurrencyAdapter\u003cRuntime, Balances, Amount, BlockNumber\u003e;\n\nimpl orml_currencies::Trait for Runtime {\n\ttype Event = Event;\n\ttype MultiCurrency = Tokens;\n\ttype NativeCurrency = MinterestToken;\n\ttype GetNativeCurrencyId = GetMinterestCurrencyId;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const InitialExchangeRate: Rate = INITIAL_EXCHANGE_RATE;\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl liquidity_pools::Trait for Runtime {\n\ttype Event = Event;\n\ttype MultiCurrency = Currencies;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\nimpl controller::Trait for Runtime {\n\ttype Event = Event;\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = MAX_MEMBERS;\n}\n\nimpl accounts::Trait for Runtime {\n\ttype Event = Event;\n\ttype MaxMembers = MaxMembers;\n}\n\nimpl oracle::Trait for Runtime {\n\ttype Event = Event;\n}\n\nparameter_types! {\n\tpub const BlocksPerYear: u128 = BLOCKS_PER_YEAR;\n}\n\nimpl minterest_model::Trait for Runtime {\n\ttype Event = Event;\n\ttype BlocksPerYear = BlocksPerYear;\n}\n\n// Create the runtime by composing the FRAME pallets that were previously configured.\nconstruct_runtime!(\n\tpub enum Runtime where\n\t\tBlock = Block,\n\t\tNodeBlock = opaque::Block,\n\t\tUncheckedExtrinsic = UncheckedExtrinsic\n\t{\n\t\tSystem: frame_system::{Module, Call, Config, Storage, Event\u003cT\u003e},\n\t\tRandomnessCollectiveFlip: pallet_randomness_collective_flip::{Module, Call, Storage},\n\t\tTimestamp: pallet_timestamp::{Module, Call, Storage, Inherent},\n\t\tAura: pallet_aura::{Module, Config\u003cT\u003e, Inherent},\n\t\tGrandpa: pallet_grandpa::{Module, Call, Storage, Config, Event},\n\t\tBalances: pallet_balances::{Module, Call, Storage, Config\u003cT\u003e, Event\u003cT\u003e},\n\t\tTransactionPayment: pallet_transaction_payment::{Module, Storage},\n\t\tSudo: pallet_sudo::{Module, Call, Config\u003cT\u003e, Storage, Event\u003cT\u003e},\n\t\t//ORML palletts\n\t\tTokens: orml_tokens::{Module, Storage, Call, Event\u003cT\u003e, Config\u003cT\u003e},\n\t\tCurrencies: orml_currencies::{Module, Call, Event\u003cT\u003e},\n\t\t// Minterest pallets\n\t\tMTokens: m_tokens::{Module, Storage, Call, Event\u003cT\u003e},\n\t\tMinterestProtocol: minterest_protocol::{Module, Storage, Call, Event\u003cT\u003e},\n\t\tLiquidityPools: liquidity_pools::{Module, Storage, Call, Event, Config\u003cT\u003e},\n\t\tController: controller::{Module, Storage, Call, Event, Config\u003cT\u003e},\n\t\tAccounts: accounts::{Module, Storage, Call, Event\u003cT\u003e, Config\u003cT\u003e},\n\t\tOracle: oracle::{Module, Storage, Call, Event},\n\t\tMinterestModel: minterest_model::{Module, Storage, Call, Event, Config},\n\t}\n);\n\n/// The address format for describing accounts.\npub type Address = AccountId;\n/// Block header type as expected by this runtime.\npub type Header = generic::Header\u003cBlockNumber, BlakeTwo256\u003e;\n/// Block type as expected by this runtime.\npub type Block = generic::Block\u003cHeader, UncheckedExtrinsic\u003e;\n/// A Block signed with a Justification\npub type SignedBlock = generic::SignedBlock\u003cBlock\u003e;\n/// BlockId type as expected by this runtime.\npub type BlockId = generic::BlockId\u003cBlock\u003e;\n/// The SignedExtension to the basic transaction logic.\npub type SignedExtra = (\n\tframe_system::CheckSpecVersion\u003cRuntime\u003e,\n\tframe_system::CheckTxVersion\u003cRuntime\u003e,\n\tframe_system::CheckGenesis\u003cRuntime\u003e,\n\tframe_system::CheckEra\u003cRuntime\u003e,\n\tframe_system::CheckNonce\u003cRuntime\u003e,\n\tframe_system::CheckWeight\u003cRuntime\u003e,\n\tpallet_transaction_payment::ChargeTransactionPayment\u003cRuntime\u003e,\n);\n/// Unchecked extrinsic type as expected by this runtime.\npub type UncheckedExtrinsic = generic::UncheckedExtrinsic\u003cAddress, Call, Signature, SignedExtra\u003e;\n/// Extrinsic type that has already been checked.\npub type CheckedExtrinsic = generic::CheckedExtrinsic\u003cAccountId, Call, SignedExtra\u003e;\n/// Executive: handles dispatch to the various modules.\npub type Executive =\n\tframe_executive::Executive\u003cRuntime, Block, frame_system::ChainContext\u003cRuntime\u003e, Runtime, AllModules\u003e;\n\nimpl_runtime_apis! {\n\timpl sp_api::Core\u003cBlock\u003e for Runtime {\n\t\tfn version() -\u003e RuntimeVersion {\n\t\t\tVERSION\n\t\t}\n\n\t\tfn execute_block(block: Block) {\n\t\t\tExecutive::execute_block(block)\n\t\t}\n\n\t\tfn initialize_block(header: \u0026\u003cBlock as BlockT\u003e::Header) {\n\t\t\tExecutive::initialize_block(header)\n\t\t}\n\t}\n\n\timpl sp_api::Metadata\u003cBlock\u003e for Runtime {\n\t\tfn metadata() -\u003e OpaqueMetadata {\n\t\t\tRuntime::metadata().into()\n\t\t}\n\t}\n\n\timpl sp_block_builder::BlockBuilder\u003cBlock\u003e for Runtime {\n\t\tfn apply_extrinsic(extrinsic: \u003cBlock as BlockT\u003e::Extrinsic) -\u003e ApplyExtrinsicResult {\n\t\t\tExecutive::apply_extrinsic(extrinsic)\n\t\t}\n\n\t\tfn finalize_block() -\u003e \u003cBlock as BlockT\u003e::Header {\n\t\t\tExecutive::finalize_block()\n\t\t}\n\n\t\tfn inherent_extrinsics(data: sp_inherents::InherentData) -\u003e Vec\u003c\u003cBlock as BlockT\u003e::Extrinsic\u003e {\n\t\t\tdata.create_extrinsics()\n\t\t}\n\n\t\tfn check_inherents(\n\t\t\tblock: Block,\n\t\t\tdata: sp_inherents::InherentData,\n\t\t) -\u003e sp_inherents::CheckInherentsResult {\n\t\t\tdata.check_extrinsics(\u0026block)\n\t\t}\n\n\t\tfn random_seed() -\u003e \u003cBlock as BlockT\u003e::Hash {\n\t\t\tRandomnessCollectiveFlip::random_seed()\n\t\t}\n\t}\n\n\timpl sp_transaction_pool::runtime_api::TaggedTransactionQueue\u003cBlock\u003e for Runtime {\n\t\tfn validate_transaction(\n\t\t\tsource: TransactionSource,\n\t\t\ttx: \u003cBlock as BlockT\u003e::Extrinsic,\n\t\t) -\u003e TransactionValidity {\n\t\t\tExecutive::validate_transaction(source, tx)\n\t\t}\n\t}\n\n\timpl sp_offchain::OffchainWorkerApi\u003cBlock\u003e for Runtime {\n\t\tfn offchain_worker(header: \u0026\u003cBlock as BlockT\u003e::Header) {\n\t\t\tExecutive::offchain_worker(header)\n\t\t}\n\t}\n\n\timpl sp_consensus_aura::AuraApi\u003cBlock, AuraId\u003e for Runtime {\n\t\tfn slot_duration() -\u003e u64 {\n\t\t\tAura::slot_duration()\n\t\t}\n\n\t\tfn authorities() -\u003e Vec\u003cAuraId\u003e {\n\t\t\tAura::authorities()\n\t\t}\n\t}\n\n\timpl sp_session::SessionKeys\u003cBlock\u003e for Runtime {\n\t\tfn generate_session_keys(seed: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Vec\u003cu8\u003e {\n\t\t\topaque::SessionKeys::generate(seed)\n\t\t}\n\n\t\tfn decode_session_keys(\n\t\t\tencoded: Vec\u003cu8\u003e,\n\t\t) -\u003e Option\u003cVec\u003c(Vec\u003cu8\u003e, KeyTypeId)\u003e\u003e {\n\t\t\topaque::SessionKeys::decode_into_raw_public_keys(\u0026encoded)\n\t\t}\n\t}\n\n\timpl fg_primitives::GrandpaApi\u003cBlock\u003e for Runtime {\n\t\tfn grandpa_authorities() -\u003e GrandpaAuthorityList {\n\t\t\tGrandpa::grandpa_authorities()\n\t\t}\n\n\t\tfn submit_report_equivocation_unsigned_extrinsic(\n\t\t\t_equivocation_proof: fg_primitives::EquivocationProof\u003c\n\t\t\t\t\u003cBlock as BlockT\u003e::Hash,\n\t\t\t\tNumberFor\u003cBlock\u003e,\n\t\t\t\u003e,\n\t\t\t_key_owner_proof: fg_primitives::OpaqueKeyOwnershipProof,\n\t\t) -\u003e Option\u003c()\u003e {\n\t\t\tNone\n\t\t}\n\n\t\tfn generate_key_ownership_proof(\n\t\t\t_set_id: fg_primitives::SetId,\n\t\t\t_authority_id: GrandpaId,\n\t\t) -\u003e Option\u003cfg_primitives::OpaqueKeyOwnershipProof\u003e {\n\t\t\t// NOTE: this is the only implementation possible since we've\n\t\t\t// defined our key owner proof type as a bottom type (i.e. a type\n\t\t\t// with no values).\n\t\t\tNone\n\t\t}\n\t}\n\n\timpl frame_system_rpc_runtime_api::AccountNonceApi\u003cBlock, AccountId, Index\u003e for Runtime {\n\t\tfn account_nonce(account: AccountId) -\u003e Index {\n\t\t\tSystem::account_nonce(account)\n\t\t}\n\t}\n\n\timpl pallet_transaction_payment_rpc_runtime_api::TransactionPaymentApi\u003cBlock, Balance\u003e for Runtime {\n\t\tfn query_info(\n\t\t\tuxt: \u003cBlock as BlockT\u003e::Extrinsic,\n\t\t\tlen: u32,\n\t\t) -\u003e pallet_transaction_payment_rpc_runtime_api::RuntimeDispatchInfo\u003cBalance\u003e {\n\t\t\tTransactionPayment::query_info(uxt, len)\n\t\t}\n\t}\n\n\timpl controller_rpc_runtime_api::ControllerApi\u003cBlock\u003e for Runtime {\n\t\tfn liquidity_pool_state(pool_id: CurrencyId) -\u003e Option\u003cPoolState\u003e {\n\t\t\tlet exchange_rate = Controller::get_liquidity_pool_exchange_rate(pool_id)?;\n\t\t\tlet (borrow_rate, supply_rate) = Controller::get_liquidity_pool_borrow_and_supply_rates(pool_id)?;\n\n\t\t\tSome(PoolState { exchange_rate, borrow_rate, supply_rate })\n\t\t}\n\t}\n\n\t#[cfg(feature = \"runtime-benchmarks\")]\n\timpl frame_benchmarking::Benchmark\u003cBlock\u003e for Runtime {\n\t\tfn dispatch_benchmark(\n\t\t\tconfig: frame_benchmarking::BenchmarkConfig\n\t\t) -\u003e Result\u003cVec\u003cframe_benchmarking::BenchmarkBatch\u003e, sp_runtime::RuntimeString\u003e {\n\t\t\tuse frame_benchmarking::{Benchmarking, BenchmarkBatch, add_benchmark, TrackedStorageKey};\n\n\t\t\tuse frame_system_benchmarking::Module as SystemBench;\n\t\t\timpl frame_system_benchmarking::Trait for Runtime {}\n\n\t\t\tlet whitelist: Vec\u003cTrackedStorageKey\u003e = vec![\n\t\t\t\t// Block Number\n\t\t\t\thex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef702a5c1b19ab7a04f536c519aca4983ac\").to_vec().into(),\n\t\t\t\t// Total Issuance\n\t\t\t\thex_literal::hex!(\"c2261276cc9d1f8598ea4b6a74b15c2f57c875e4cff74148e4628f264b974c80\").to_vec().into(),\n\t\t\t\t// Execution Phase\n\t\t\t\thex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef7ff553b5a9862a516939d82b3d3d8661a\").to_vec().into(),\n\t\t\t\t// Event Count\n\t\t\t\thex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef70a98fdbe9ce6c55837576c60c7af3850\").to_vec().into(),\n\t\t\t\t// System Events\n\t\t\t\thex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef780d41e5e16056765bc8461851072c9d7\").to_vec().into(),\n\t\t\t];\n\n\t\t\tlet mut batches = Vec::\u003cBenchmarkBatch\u003e::new();\n\t\t\tlet params = (\u0026config, \u0026whitelist);\n\n\t\t\tadd_benchmark!(params, batches, frame_system, SystemBench::\u003cRuntime\u003e);\n\t\t\tadd_benchmark!(params, batches, pallet_balances, Balances);\n\t\t\tadd_benchmark!(params, batches, pallet_timestamp, Timestamp);\n\n\t\t\tif batches.is_empty() { return Err(\"Benchmark not found for this pallet.\".into()) }\n\t\t\tOk(batches)\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","runtime","src","tests.rs"],"content":"use crate::{\n\tAccountId, Balance, Block,\n\tCurrencyId::{self, DOT, ETH},\n\tRate, Runtime, DOLLARS,\n};\nuse controller::{ControllerData, PauseKeeper};\nuse controller_rpc_runtime_api::runtime_decl_for_ControllerApi::ControllerApi;\nuse controller_rpc_runtime_api::PoolState;\nuse frame_support::{assert_noop, assert_ok, parameter_types};\nuse liquidity_pools::Pool;\nuse minterest_model::MinterestModelData;\nuse minterest_primitives::{Operation, Price};\nuse orml_traits::MultiCurrency;\nuse sp_runtime::traits::Zero;\nuse sp_runtime::FixedPointNumber;\n\ntype MinterestProtocol = minterest_protocol::Module\u003cRuntime\u003e;\ntype LiquidityPools = liquidity_pools::Module\u003cRuntime\u003e;\ntype Controller = controller::Module\u003cRuntime\u003e;\ntype Currencies = orml_currencies::Module\u003cRuntime\u003e;\ntype System = frame_system::Module\u003cRuntime\u003e;\n\nparameter_types! {\n\tpub ALICE: AccountId = AccountId::from([1u8; 32]);\n\tpub BOB: AccountId = AccountId::from([2u8; 32]);\n\tpub CHARLIE: AccountId = AccountId::from([3u8; 32]);\n}\n\nstruct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![\n\t\t\t\t// seed: initial assets. Initial MINT to pay for gas.\n\t\t\t\t(ALICE::get(), CurrencyId::MINT, 100_000 * DOLLARS),\n\t\t\t\t(ALICE::get(), CurrencyId::DOT, 100_000 * DOLLARS),\n\t\t\t\t(ALICE::get(), CurrencyId::ETH, 100_000 * DOLLARS),\n\t\t\t\t(BOB::get(), CurrencyId::MINT, 100_000 * DOLLARS),\n\t\t\t\t(BOB::get(), CurrencyId::DOT, 100_000 * DOLLARS),\n\t\t\t\t(BOB::get(), CurrencyId::ETH, 100_000 * DOLLARS),\n\t\t\t\t(CHARLIE::get(), CurrencyId::MINT, 100_000 * DOLLARS),\n\t\t\t\t(CHARLIE::get(), CurrencyId::DOT, 100_000 * DOLLARS),\n\t\t\t\t(CHARLIE::get(), CurrencyId::ETH, 100_000 * DOLLARS),\n\t\t\t],\n\t\t}\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tliquidity_pools::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tpools: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpool_user_data: vec![],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tcontroller::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tcontroller_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpause_keepers: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tminterest_model::GenesisConfig {\n\t\t\tminterest_model_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\taccounts::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tallowed_accounts: vec![(ALICE::get(), ())],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tlet mut ext: sp_io::TestExternalities = t.into();\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n\nfn pool_balance(pool_id: CurrencyId) -\u003e Balance {\n\tCurrencies::free_balance(pool_id, \u0026LiquidityPools::pools_account_id())\n}\n\nfn pool_total_insurance(pool_id: CurrencyId) -\u003e Balance {\n\tLiquidityPools::pools(pool_id).total_insurance\n}\n\nfn liquidity_pool_state_rpc(currency_id: CurrencyId) -\u003e Option\u003cPoolState\u003e {\n\t\u003cRuntime as ControllerApi\u003cBlock\u003e\u003e::liquidity_pool_state(currency_id)\n}\n\nfn dollars(amount: u128) -\u003e u128 {\n\tamount.saturating_mul(Price::accuracy())\n}\n\nfn alice() -\u003e \u003cRuntime as frame_system::Trait\u003e::Origin {\n\t\u003cRuntime as frame_system::Trait\u003e::Origin::signed((ALICE::get()).clone())\n}\n\nfn bob() -\u003e \u003cRuntime as frame_system::Trait\u003e::Origin {\n\t\u003cRuntime as frame_system::Trait\u003e::Origin::signed((BOB::get()).clone())\n}\n\nfn charlie() -\u003e \u003cRuntime as frame_system::Trait\u003e::Origin {\n\t\u003cRuntime as frame_system::Trait\u003e::Origin::signed((CHARLIE::get()).clone())\n}\n\n#[test]\nfn test_rates_using_rpc() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(Controller::deposit_insurance(alice(), DOT, dollars(100_000)));\n\t\tassert_ok!(Controller::deposit_insurance(alice(), ETH, dollars(100_000)));\n\t\tassert_eq!(pool_total_insurance(DOT), dollars(100_000));\n\t\tassert_eq!(pool_total_insurance(ETH), dollars(100_000));\n\n\t\tSystem::set_block_number(10);\n\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), DOT, dollars(50_000)));\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), ETH, dollars(70_000)));\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(bob(), DOT));\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(bob(), ETH));\n\t\t// exchange_rate = (150 - 100 + 0) / 50 = 1\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::one(),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\n\t\tSystem::set_block_number(20);\n\n\t\tassert_ok!(MinterestProtocol::borrow(bob(), DOT, dollars(100_000)));\n\t\tassert_ok!(MinterestProtocol::repay(bob(), DOT, dollars(30_000)));\n\t\tassert_eq!(pool_balance(DOT), dollars(80_000));\n\t\t// exchange_rate = (80 - 100 + 70) / 50 = 1\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::one(),\n\t\t\t\tborrow_rate: Rate::from_inner(239_040_000_000),\n\t\t\t\tsupply_rate: Rate::from_inner(301_190_400_000)\n\t\t\t})\n\t\t);\n\n\t\tSystem::set_block_number(30);\n\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(charlie(), DOT, dollars(20_000)));\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(charlie(), ETH, dollars(30_000)));\n\t\t// supply rate and borrow rate decreased\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_003_011_904_000_000),\n\t\t\t\tborrow_rate: Rate::from_inner(172_800_039_584),\n\t\t\t\tsupply_rate: Rate::from_inner(155_520_072_800)\n\t\t\t})\n\t\t);\n\n\t\tSystem::set_block_number(40);\n\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(charlie(), DOT));\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(charlie(), ETH));\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), DOT, dollars(20_000)));\n\t\t// supply rate and borrow rate increased\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_004_567_109_412_126),\n\t\t\t\tborrow_rate: Rate::from_inner(220_114_178_542),\n\t\t\t\tsupply_rate: Rate::from_inner(254_703_421_247)\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn demo_scenario_n2_without_insurance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(alice(), DOT, 100_000 * DOLLARS));\n\t\tSystem::set_block_number(200);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(alice(), ETH, 100_000 * DOLLARS));\n\t\tSystem::set_block_number(600);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), DOT, 80_000 * DOLLARS));\n\t\tSystem::set_block_number(1000);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), ETH, 50_000 * DOLLARS));\n\t\tSystem::set_block_number(2000);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(charlie(), DOT, 100_000 * DOLLARS));\n\t\tSystem::set_block_number(3000);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(charlie(), ETH, 50_000 * DOLLARS));\n\t\tSystem::set_block_number(4000);\n\n\t\tassert_noop!(\n\t\t\tMinterestProtocol::borrow(charlie(), DOT, 20_000 * DOLLARS),\n\t\t\tminterest_protocol::Error::\u003cRuntime\u003e::BorrowControllerRejection\n\t\t);\n\t\tSystem::set_block_number(4100);\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(charlie(), DOT));\n\t\tSystem::set_block_number(4200);\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(charlie(), ETH));\n\t\tSystem::set_block_number(4300);\n\t\tassert_ok!(Controller::pause_specific_operation(alice(), DOT, Operation::Borrow));\n\t\tSystem::set_block_number(4400);\n\t\tassert_noop!(\n\t\t\tMinterestProtocol::borrow(charlie(), DOT, 20_000 * DOLLARS),\n\t\t\tminterest_protocol::Error::\u003cRuntime\u003e::OperationPaused\n\t\t);\n\t\tSystem::set_block_number(5000);\n\t\tassert_ok!(Controller::unpause_specific_operation(alice(), DOT, Operation::Borrow));\n\n\t\tSystem::set_block_number(6000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), DOT, 20_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::one(),\n\t\t\t\tborrow_rate: Rate::from_inner(642857142),\n\t\t\t\tsupply_rate: Rate::from_inner(41326530)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(7000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), ETH, 10_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::one(),\n\t\t\t\tborrow_rate: Rate::from_inner(450000000),\n\t\t\t\tsupply_rate: Rate::from_inner(20250000)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(8000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), ETH, 20_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000000020250000000),\n\t\t\t\tborrow_rate: Rate::from_inner(1350000175),\n\t\t\t\tsupply_rate: Rate::from_inner(182250047)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(9000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), ETH, 70_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000000202500050963),\n\t\t\t\tborrow_rate: Rate::from_inner(4500001113),\n\t\t\t\tsupply_rate: Rate::from_inner(2025001001)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(10000);\n\t\tassert_ok!(MinterestProtocol::repay(charlie(), ETH, 50_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000002227501463063),\n\t\t\t\tborrow_rate: Rate::from_inner(2250017263),\n\t\t\t\tsupply_rate: Rate::from_inner(506257768)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(11000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), DOT, 50_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000000206632652786),\n\t\t\t\tborrow_rate: Rate::from_inner(2250001601),\n\t\t\t\tsupply_rate: Rate::from_inner(506250720)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(12000);\n\t\tassert_ok!(MinterestProtocol::repay(charlie(), DOT, 70_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000000712883477935),\n\t\t\t\tborrow_rate: Rate::from_inner(7128),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(13000);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), ETH, 10_000 * DOLLARS));\n\t\tSystem::set_block_number(13500);\n\t\tassert_ok!(MinterestProtocol::redeem(charlie(), ETH));\n\t\tSystem::set_block_number(14000);\n\t\tassert_ok!(MinterestProtocol::repay_all(charlie(), ETH));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_004_371_397_298_691),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(15000);\n\t\tassert_ok!(MinterestProtocol::redeem_underlying(charlie(), DOT, 50_000 * DOLLARS));\n\t\tSystem::set_block_number(16000);\n\t\tassert_ok!(MinterestProtocol::repay_all(charlie(), DOT));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_000_712_883_477_957),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(17000);\n\t\tassert_ok!(MinterestProtocol::redeem(charlie(), DOT));\n\t\tSystem::set_block_number(18000);\n\t\tassert_ok!(MinterestProtocol::redeem_underlying(bob(), DOT, 40_000 * DOLLARS));\n\t\tSystem::set_block_number(19000);\n\t\tassert_ok!(MinterestProtocol::redeem(bob(), DOT));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_000_712_883_477_958),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t\tassert_ok!(MinterestProtocol::redeem(bob(), ETH));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_004_371_397_298_690),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","service","src","chain_spec.rs"],"content":"use controller::{ControllerData, PauseKeeper};\nuse hex_literal::hex;\nuse liquidity_pools::Pool;\nuse minterest_model::MinterestModelData;\nuse node_minterest_runtime::{\n\tAccountId, AccountsConfig, AuraConfig, Balance, BalancesConfig, ControllerConfig, CurrencyId, GenesisConfig,\n\tGrandpaConfig, LiquidityPoolsConfig, MinterestModelConfig, Signature, SudoConfig, SystemConfig, TokensConfig,\n\tDOLLARS, WASM_BINARY,\n};\nuse sc_service::ChainType;\nuse sc_telemetry::TelemetryEndpoints;\nuse serde_json::map::Map;\nuse sp_consensus_aura::sr25519::AuthorityId as AuraId;\nuse sp_core::{sr25519, Pair, Public};\nuse sp_finality_grandpa::AuthorityId as GrandpaId;\nuse sp_runtime::{\n\ttraits::{IdentifyAccount, Verify, Zero},\n\tFixedPointNumber, FixedU128,\n};\n\n// The URL for the telemetry server.\n// const STAGING_TELEMETRY_URL: \u0026str = \"wss://telemetry.polkadot.io/submit/\";\n\nconst INITIAL_BALANCE: u128 = 100_000 * DOLLARS;\n\n// The URL for the telemetry server.\nconst STAGING_TELEMETRY_URL: \u0026str = \"wss://telemetry.polkadot.io/submit/\";\n\n/// Specialized `ChainSpec`. This is a specialization of the general Substrate ChainSpec type.\npub type ChainSpec = sc_service::GenericChainSpec\u003cGenesisConfig\u003e;\n\n/// Generate a crypto pair from seed.\npub fn get_from_seed\u003cTPublic: Public\u003e(seed: \u0026str) -\u003e \u003cTPublic::Pair as Pair\u003e::Public {\n\tTPublic::Pair::from_string(\u0026format!(\"//{}\", seed), None)\n\t\t.expect(\"static values are valid; qed\")\n\t\t.public()\n}\n\ntype AccountPublic = \u003cSignature as Verify\u003e::Signer;\n\n/// Generate an account ID from seed.\npub fn get_account_id_from_seed\u003cTPublic: Public\u003e(seed: \u0026str) -\u003e AccountId\nwhere\n\tAccountPublic: From\u003c\u003cTPublic::Pair as Pair\u003e::Public\u003e,\n{\n\tAccountPublic::from(get_from_seed::\u003cTPublic\u003e(seed)).into_account()\n}\n\n/// Generate an Aura authority key.\npub fn authority_keys_from_seed(seed: \u0026str) -\u003e (AuraId, GrandpaId) {\n\t(get_from_seed::\u003cAuraId\u003e(seed), get_from_seed::\u003cGrandpaId\u003e(seed))\n}\n\npub fn development_config() -\u003e Result\u003cChainSpec, String\u003e {\n\tlet mut properties = Map::new();\n\tproperties.insert(\"tokenSymbol\".into(), \"MNT\".into());\n\tproperties.insert(\"tokenDecimals\".into(), 18.into());\n\n\tlet wasm_binary = WASM_BINARY.ok_or_else(|| \"Development wasm binary not available\".to_string())?;\n\n\tOk(ChainSpec::from_genesis(\n\t\t// Name\n\t\t\"Development\",\n\t\t// ID\n\t\t\"dev\",\n\t\tChainType::Development,\n\t\tmove || {\n\t\t\ttestnet_genesis(\n\t\t\t\twasm_binary,\n\t\t\t\t// Initial PoA authorities\n\t\t\t\tvec![authority_keys_from_seed(\"Alice\")],\n\t\t\t\t// Sudo account\n\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t// Pre-funded accounts\n\t\t\t\tvec![\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob//stash\"),\n\t\t\t\t],\n\t\t\t\ttrue,\n\t\t\t)\n\t\t},\n\t\t// Bootnodes\n\t\tvec![],\n\t\t// Telemetry\n\t\tNone,\n\t\t// Protocol ID\n\t\tNone,\n\t\t// Properties\n\t\tSome(properties),\n\t\t// Extensions\n\t\tNone,\n\t))\n}\n\npub fn local_testnet_config() -\u003e Result\u003cChainSpec, String\u003e {\n\tlet mut properties = Map::new();\n\tproperties.insert(\"tokenSymbol\".into(), \"MNT\".into());\n\tproperties.insert(\"tokenDecimals\".into(), 18.into());\n\n\tlet wasm_binary = WASM_BINARY.ok_or_else(|| \"Development wasm binary not available\".to_string())?;\n\n\tOk(ChainSpec::from_genesis(\n\t\t// Name\n\t\t\"Local Testnet\",\n\t\t// ID\n\t\t\"local_testnet\",\n\t\tChainType::Local,\n\t\tmove || {\n\t\t\ttestnet_genesis(\n\t\t\t\twasm_binary,\n\t\t\t\t// Initial PoA authorities\n\t\t\t\tvec![authority_keys_from_seed(\"Alice\"), authority_keys_from_seed(\"Bob\")],\n\t\t\t\t// Sudo account\n\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t// Pre-funded accounts\n\t\t\t\tvec![\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Charlie\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Dave\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Eve\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Ferdie\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Charlie//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Dave//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Eve//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Ferdie//stash\"),\n\t\t\t\t],\n\t\t\t\ttrue,\n\t\t\t)\n\t\t},\n\t\t// Bootnodes\n\t\tvec![],\n\t\t// Telemetry\n\t\tNone,\n\t\t// Protocol ID\n\t\tNone,\n\t\t// Properties\n\t\tSome(properties),\n\t\t// Extensions\n\t\tNone,\n\t))\n}\n\npub fn minterest_turbo_testnet_config() -\u003e Result\u003cChainSpec, String\u003e {\n\tlet mut properties = Map::new();\n\tproperties.insert(\"tokenSymbol\".into(), \"MNT\".into());\n\tproperties.insert(\"tokenDecimals\".into(), 18.into());\n\n\tlet wasm_binary = WASM_BINARY.ok_or_else(|| \"Development wasm binary not available\".to_string())?;\n\n\tOk(ChainSpec::from_genesis(\n\t\t\"Minterest Turbo\",\n\t\t\"turbo-latest\",\n\t\tChainType::Live,\n\t\tmove || {\n\t\t\ttestnet_genesis(\n\t\t\t\twasm_binary,\n\t\t\t\t// Initial PoA authorities\n\t\t\t\tvec![authority_keys_from_seed(\"Alice\")],\n\t\t\t\t// Sudo account\n\t\t\t\t// 5ER9G3d2V4EEq8VjEbjkGbMdgprvtCntTYu9itCRJNHTkWYX\n\t\t\t\thex![\"680ee3a95d0b19619d9483fdee34f5d0016fbadd7145d016464f6bfbb993b46b\"].into(),\n\t\t\t\t// Pre-funded accounts\n\t\t\t\tvec![\n\t\t\t\t\thex![\"680ee3a95d0b19619d9483fdee34f5d0016fbadd7145d016464f6bfbb993b46b\"].into(),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob//stash\"),\n\t\t\t\t],\n\t\t\t\ttrue,\n\t\t\t)\n\t\t},\n\t\t// Bootnodes\n\t\tvec![],\n\t\t// Telemetry\n\t\tSome(\n\t\t\tTelemetryEndpoints::new(vec![(STAGING_TELEMETRY_URL.to_string(), 0)])\n\t\t\t\t.expect(\"Staging telemetry url is valid; qed\"),\n\t\t),\n\t\t// Protocol ID\n\t\tSome(\"turbo-latest\"),\n\t\t// Properties\n\t\tSome(properties),\n\t\t// Extensions\n\t\tDefault::default(),\n\t))\n}\n\n/// Configure initial storage state for FRAME modules.\nfn testnet_genesis(\n\twasm_binary: \u0026[u8],\n\tinitial_authorities: Vec\u003c(AuraId, GrandpaId)\u003e,\n\troot_key: AccountId,\n\tendowed_accounts: Vec\u003cAccountId\u003e,\n\t_enable_println: bool,\n) -\u003e GenesisConfig {\n\tGenesisConfig {\n\t\tframe_system: Some(SystemConfig {\n\t\t\t// Add Wasm runtime to storage.\n\t\t\tcode: wasm_binary.to_vec(),\n\t\t\tchanges_trie_config: Default::default(),\n\t\t}),\n\t\tpallet_balances: Some(BalancesConfig {\n\t\t\t// Configure endowed accounts with initial balance of 1 \u003c\u003c 60.\n\t\t\tbalances: endowed_accounts.iter().cloned().map(|k| (k, 1 \u003c\u003c 60)).collect(),\n\t\t}),\n\t\tpallet_aura: Some(AuraConfig {\n\t\t\tauthorities: initial_authorities.iter().map(|x| (x.0.clone())).collect(),\n\t\t}),\n\t\tpallet_grandpa: Some(GrandpaConfig {\n\t\t\tauthorities: initial_authorities.iter().map(|x| (x.1.clone(), 1)).collect(),\n\t\t}),\n\t\tpallet_sudo: Some(SudoConfig {\n\t\t\t// Assign network admin rights.\n\t\t\tkey: root_key,\n\t\t}),\n\t\torml_tokens: Some(TokensConfig {\n\t\t\tendowed_accounts: endowed_accounts\n\t\t\t\t.iter()\n\t\t\t\t.flat_map(|x| {\n\t\t\t\t\tvec![\n\t\t\t\t\t\t(x.clone(), CurrencyId::DOT, INITIAL_BALANCE),\n\t\t\t\t\t\t(x.clone(), CurrencyId::ETH, INITIAL_BALANCE),\n\t\t\t\t\t]\n\t\t\t\t})\n\t\t\t\t.collect(),\n\t\t}),\n\t\tliquidity_pools: Some(LiquidityPoolsConfig {\n\t\t\tpools: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: FixedU128::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: FixedU128::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: FixedU128::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: FixedU128::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpool_user_data: vec![],\n\t\t}),\n\t\tcontroller: Some(ControllerConfig {\n\t\t\tcontroller_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: FixedU128::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: FixedU128::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: FixedU128::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: FixedU128::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: FixedU128::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: FixedU128::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: FixedU128::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: FixedU128::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: FixedU128::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: FixedU128::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: FixedU128::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: FixedU128::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpause_keepers: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}),\n\t\taccounts: Some(AccountsConfig {\n\t\t\tallowed_accounts: vec![(get_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"), ())],\n\t\t}),\n\t\tminterest_model: Some(MinterestModelConfig {\n\t\t\tminterest_model_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: FixedU128::saturating_from_rational(8, 10), // 0.8 = 80 %\n\t\t\t\t\t\tbase_rate_per_block: FixedU128::zero(),\n\t\t\t\t\t\tmultiplier_per_block: FixedU128::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: FixedU128::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: FixedU128::saturating_from_rational(8, 10), // 0.8 = 80 %\n\t\t\t\t\t\tbase_rate_per_block: FixedU128::zero(),\n\t\t\t\t\t\tmultiplier_per_block: FixedU128::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: FixedU128::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: FixedU128::saturating_from_rational(8, 10), // 0.8 = 80 %\n\t\t\t\t\t\tbase_rate_per_block: FixedU128::zero(),\n\t\t\t\t\t\tmultiplier_per_block: FixedU128::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: FixedU128::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: FixedU128::saturating_from_rational(8, 10), // 0.8 = 80 %\n\t\t\t\t\t\tbase_rate_per_block: FixedU128::zero(),\n\t\t\t\t\t\tmultiplier_per_block: FixedU128::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: FixedU128::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}),\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","service","src","lib.rs"],"content":"//! Service and ServiceFactory implementation. Specialized wrapper over substrate service.\n// Disable the following lints\n#![allow(clippy::type_complexity)]\n\nuse node_minterest_runtime::{self, opaque::Block, RuntimeApi};\nuse sc_client_api::{ExecutorProvider, RemoteBackend};\nuse sc_executor::native_executor_instance;\npub use sc_executor::NativeExecutor;\nuse sc_finality_grandpa::{FinalityProofProvider as GrandpaFinalityProofProvider, SharedVoterState};\nuse sc_service::{error::Error as ServiceError, Configuration, TaskManager};\nuse sp_consensus_aura::sr25519::AuthorityPair as AuraPair;\nuse sp_inherents::InherentDataProviders;\nuse std::sync::Arc;\nuse std::time::Duration;\n\npub mod chain_spec;\n\n// Our native executor instance.\nnative_executor_instance!(\n\tpub Executor,\n\tnode_minterest_runtime::api::dispatch,\n\tnode_minterest_runtime::native_version,\n\tframe_benchmarking::benchmarking::HostFunctions,\n);\n\ntype FullClient = sc_service::TFullClient\u003cBlock, RuntimeApi, Executor\u003e;\ntype FullBackend = sc_service::TFullBackend\u003cBlock\u003e;\ntype FullSelectChain = sc_consensus::LongestChain\u003cFullBackend, Block\u003e;\n\npub fn new_partial(\n\tconfig: \u0026Configuration,\n) -\u003e Result\u003c\n\tsc_service::PartialComponents\u003c\n\t\tFullClient,\n\t\tFullBackend,\n\t\tFullSelectChain,\n\t\tsp_consensus::DefaultImportQueue\u003cBlock, FullClient\u003e,\n\t\tsc_transaction_pool::FullPool\u003cBlock, FullClient\u003e,\n\t\t(\n\t\t\tsc_consensus_aura::AuraBlockImport\u003c\n\t\t\t\tBlock,\n\t\t\t\tFullClient,\n\t\t\t\tsc_finality_grandpa::GrandpaBlockImport\u003cFullBackend, Block, FullClient, FullSelectChain\u003e,\n\t\t\t\tAuraPair,\n\t\t\t\u003e,\n\t\t\tsc_finality_grandpa::LinkHalf\u003cBlock, FullClient, FullSelectChain\u003e,\n\t\t),\n\t\u003e,\n\tServiceError,\n\u003e {\n\tlet inherent_data_providers = sp_inherents::InherentDataProviders::new();\n\n\tlet (client, backend, keystore, task_manager) = sc_service::new_full_parts::\u003cBlock, RuntimeApi, Executor\u003e(\u0026config)?;\n\tlet client = Arc::new(client);\n\n\tlet select_chain = sc_consensus::LongestChain::new(backend.clone());\n\n\tlet transaction_pool = sc_transaction_pool::BasicPool::new_full(\n\t\tconfig.transaction_pool.clone(),\n\t\tconfig.prometheus_registry(),\n\t\ttask_manager.spawn_handle(),\n\t\tclient.clone(),\n\t);\n\n\tlet (grandpa_block_import, grandpa_link) =\n\t\tsc_finality_grandpa::block_import(client.clone(), \u0026(client.clone() as Arc\u003c_\u003e), select_chain.clone())?;\n\n\tlet aura_block_import =\n\t\tsc_consensus_aura::AuraBlockImport::\u003c_, _, _, AuraPair\u003e::new(grandpa_block_import.clone(), client.clone());\n\n\tlet import_queue = sc_consensus_aura::import_queue::\u003c_, _, _, AuraPair, _, _\u003e(\n\t\tsc_consensus_aura::slot_duration(\u0026*client)?,\n\t\taura_block_import.clone(),\n\t\tSome(Box::new(grandpa_block_import)),\n\t\tNone,\n\t\tclient.clone(),\n\t\tinherent_data_providers.clone(),\n\t\t\u0026task_manager.spawn_handle(),\n\t\tconfig.prometheus_registry(),\n\t\tsp_consensus::CanAuthorWithNativeVersion::new(client.executor().clone()),\n\t)?;\n\n\tOk(sc_service::PartialComponents {\n\t\tclient,\n\t\tbackend,\n\t\ttask_manager,\n\t\timport_queue,\n\t\tkeystore,\n\t\tselect_chain,\n\t\ttransaction_pool,\n\t\tinherent_data_providers,\n\t\tother: (aura_block_import, grandpa_link),\n\t})\n}\n\n/// Builds a new service for a full client.\npub fn new_full(config: Configuration) -\u003e Result\u003cTaskManager, ServiceError\u003e {\n\tlet sc_service::PartialComponents {\n\t\tclient,\n\t\tbackend,\n\t\tmut task_manager,\n\t\timport_queue,\n\t\tkeystore,\n\t\tselect_chain,\n\t\ttransaction_pool,\n\t\tinherent_data_providers,\n\t\tother: (block_import, grandpa_link),\n\t} = new_partial(\u0026config)?;\n\n\tlet finality_proof_provider = GrandpaFinalityProofProvider::new_for_service(backend.clone(), client.clone());\n\n\tlet (network, network_status_sinks, system_rpc_tx, network_starter) =\n\t\tsc_service::build_network(sc_service::BuildNetworkParams {\n\t\t\tconfig: \u0026config,\n\t\t\tclient: client.clone(),\n\t\t\ttransaction_pool: transaction_pool.clone(),\n\t\t\tspawn_handle: task_manager.spawn_handle(),\n\t\t\timport_queue,\n\t\t\ton_demand: None,\n\t\t\tblock_announce_validator_builder: None,\n\t\t\tfinality_proof_request_builder: None,\n\t\t\tfinality_proof_provider: Some(finality_proof_provider),\n\t\t})?;\n\n\tif config.offchain_worker.enabled {\n\t\tsc_service::build_offchain_workers(\n\t\t\t\u0026config,\n\t\t\tbackend.clone(),\n\t\t\ttask_manager.spawn_handle(),\n\t\t\tclient.clone(),\n\t\t\tnetwork.clone(),\n\t\t);\n\t}\n\n\tlet role = config.role.clone();\n\tlet force_authoring = config.force_authoring;\n\tlet name = config.network.node_name.clone();\n\tlet enable_grandpa = !config.disable_grandpa;\n\tlet prometheus_registry = config.prometheus_registry().cloned();\n\tlet telemetry_connection_sinks = sc_service::TelemetryConnectionSinks::default();\n\n\tlet rpc_extensions_builder = {\n\t\tlet client = client.clone();\n\t\tlet pool = transaction_pool.clone();\n\n\t\tBox::new(move |deny_unsafe, _| {\n\t\t\tlet deps = minterest_rpc::FullDeps {\n\t\t\t\tclient: client.clone(),\n\t\t\t\tpool: pool.clone(),\n\t\t\t\tdeny_unsafe,\n\t\t\t};\n\n\t\t\tminterest_rpc::create_full(deps)\n\t\t})\n\t};\n\n\tsc_service::spawn_tasks(sc_service::SpawnTasksParams {\n\t\tnetwork: network.clone(),\n\t\tclient: client.clone(),\n\t\tkeystore: keystore.clone(),\n\t\ttask_manager: \u0026mut task_manager,\n\t\ttransaction_pool: transaction_pool.clone(),\n\t\ttelemetry_connection_sinks: telemetry_connection_sinks.clone(),\n\t\trpc_extensions_builder,\n\t\ton_demand: None,\n\t\tremote_blockchain: None,\n\t\tbackend,\n\t\tnetwork_status_sinks,\n\t\tsystem_rpc_tx,\n\t\tconfig,\n\t})?;\n\n\tif role.is_authority() {\n\t\tlet proposer =\n\t\t\tsc_basic_authorship::ProposerFactory::new(client.clone(), transaction_pool, prometheus_registry.as_ref());\n\n\t\tlet can_author_with = sp_consensus::CanAuthorWithNativeVersion::new(client.executor().clone());\n\n\t\tlet aura = sc_consensus_aura::start_aura::\u003c_, _, _, _, _, AuraPair, _, _, _\u003e(\n\t\t\tsc_consensus_aura::slot_duration(\u0026*client)?,\n\t\t\tclient.clone(),\n\t\t\tselect_chain,\n\t\t\tblock_import,\n\t\t\tproposer,\n\t\t\tnetwork.clone(),\n\t\t\tinherent_data_providers.clone(),\n\t\t\tforce_authoring,\n\t\t\tkeystore.clone(),\n\t\t\tcan_author_with,\n\t\t)?;\n\n\t\t// the AURA authoring task is considered essential, i.e. if it\n\t\t// fails we take down the service with it.\n\t\ttask_manager.spawn_essential_handle().spawn_blocking(\"aura\", aura);\n\t}\n\n\t// if the node isn't actively participating in consensus then it doesn't\n\t// need a keystore, regardless of which protocol we use below.\n\tlet keystore = if role.is_authority() {\n\t\tSome(keystore as sp_core::traits::BareCryptoStorePtr)\n\t} else {\n\t\tNone\n\t};\n\n\tlet grandpa_config = sc_finality_grandpa::Config {\n\t\t// FIXME #1578 make this available through chainspec\n\t\tgossip_duration: Duration::from_millis(333),\n\t\tjustification_period: 512,\n\t\tname: Some(name),\n\t\tobserver_enabled: false,\n\t\tkeystore,\n\t\tis_authority: role.is_network_authority(),\n\t};\n\n\tif enable_grandpa {\n\t\t// start the full GRANDPA voter\n\t\t// NOTE: non-authorities could run the GRANDPA observer protocol, but at\n\t\t// this point the full voter should provide better guarantees of block\n\t\t// and vote data availability than the observer. The observer has not\n\t\t// been tested extensively yet and having most nodes in a network run it\n\t\t// could lead to finality stalls.\n\t\tlet grandpa_config = sc_finality_grandpa::GrandpaParams {\n\t\t\tconfig: grandpa_config,\n\t\t\tlink: grandpa_link,\n\t\t\tnetwork,\n\t\t\tinherent_data_providers,\n\t\t\ttelemetry_on_connect: Some(telemetry_connection_sinks.on_connect_stream()),\n\t\t\tvoting_rule: sc_finality_grandpa::VotingRulesBuilder::default().build(),\n\t\t\tprometheus_registry,\n\t\t\tshared_voter_state: SharedVoterState::empty(),\n\t\t};\n\n\t\t// the GRANDPA voter task is considered infallible, i.e.\n\t\t// if it fails we take down the service with it.\n\t\ttask_manager\n\t\t\t.spawn_essential_handle()\n\t\t\t.spawn_blocking(\"grandpa-voter\", sc_finality_grandpa::run_grandpa_voter(grandpa_config)?);\n\t} else {\n\t\tsc_finality_grandpa::setup_disabled_grandpa(client, \u0026inherent_data_providers, network)?;\n\t}\n\n\tnetwork_starter.start_network();\n\tOk(task_manager)\n}\n\n/// Builds a new service for a light client.\npub fn new_light(config: Configuration) -\u003e Result\u003cTaskManager, ServiceError\u003e {\n\tlet (client, backend, keystore, mut task_manager, on_demand) =\n\t\tsc_service::new_light_parts::\u003cBlock, RuntimeApi, Executor\u003e(\u0026config)?;\n\n\tlet transaction_pool = Arc::new(sc_transaction_pool::BasicPool::new_light(\n\t\tconfig.transaction_pool.clone(),\n\t\tconfig.prometheus_registry(),\n\t\ttask_manager.spawn_handle(),\n\t\tclient.clone(),\n\t\ton_demand.clone(),\n\t));\n\n\tlet grandpa_block_import = sc_finality_grandpa::light_block_import(\n\t\tclient.clone(),\n\t\tbackend.clone(),\n\t\t\u0026(client.clone() as Arc\u003c_\u003e),\n\t\tArc::new(on_demand.checker().clone()) as Arc\u003c_\u003e,\n\t)?;\n\tlet finality_proof_import = grandpa_block_import.clone();\n\tlet finality_proof_request_builder = finality_proof_import.create_finality_proof_request_builder();\n\n\tlet import_queue = sc_consensus_aura::import_queue::\u003c_, _, _, AuraPair, _, _\u003e(\n\t\tsc_consensus_aura::slot_duration(\u0026*client)?,\n\t\tgrandpa_block_import,\n\t\tNone,\n\t\tSome(Box::new(finality_proof_import)),\n\t\tclient.clone(),\n\t\tInherentDataProviders::new(),\n\t\t\u0026task_manager.spawn_handle(),\n\t\tconfig.prometheus_registry(),\n\t\tsp_consensus::NeverCanAuthor,\n\t)?;\n\n\tlet finality_proof_provider = GrandpaFinalityProofProvider::new_for_service(backend.clone(), client.clone());\n\n\tlet (network, network_status_sinks, system_rpc_tx, network_starter) =\n\t\tsc_service::build_network(sc_service::BuildNetworkParams {\n\t\t\tconfig: \u0026config,\n\t\t\tclient: client.clone(),\n\t\t\ttransaction_pool: transaction_pool.clone(),\n\t\t\tspawn_handle: task_manager.spawn_handle(),\n\t\t\timport_queue,\n\t\t\ton_demand: Some(on_demand.clone()),\n\t\t\tblock_announce_validator_builder: None,\n\t\t\tfinality_proof_request_builder: Some(finality_proof_request_builder),\n\t\t\tfinality_proof_provider: Some(finality_proof_provider),\n\t\t})?;\n\n\tif config.offchain_worker.enabled {\n\t\tsc_service::build_offchain_workers(\n\t\t\t\u0026config,\n\t\t\tbackend.clone(),\n\t\t\ttask_manager.spawn_handle(),\n\t\t\tclient.clone(),\n\t\t\tnetwork.clone(),\n\t\t);\n\t}\n\n\tsc_service::spawn_tasks(sc_service::SpawnTasksParams {\n\t\tremote_blockchain: Some(backend.remote_blockchain()),\n\t\ttransaction_pool,\n\t\ttask_manager: \u0026mut task_manager,\n\t\ton_demand: Some(on_demand),\n\t\trpc_extensions_builder: Box::new(|_, _| ()),\n\t\ttelemetry_connection_sinks: sc_service::TelemetryConnectionSinks::default(),\n\t\tconfig,\n\t\tclient,\n\t\tkeystore,\n\t\tbackend,\n\t\tnetwork,\n\t\tnetwork_status_sinks,\n\t\tsystem_rpc_tx,\n\t})?;\n\n\tnetwork_starter.start_network();\n\n\tOk(task_manager)\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","src","main.rs"],"content":"fn main() -\u003e minterest_cli::Result\u003c()\u003e {\n\tminterest_cli::run()\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","home","lut1k","Projects","minterest-chain-node","cli","build.rs"],"content":"use substrate_build_script_utils::{generate_cargo_keys, rerun_if_git_head_changed};\n\nfn main() {\n\tgenerate_cargo_keys();\n\n\trerun_if_git_head_changed();\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","cli","src","cli.rs"],"content":"use sc_cli::RunCmd;\nuse structopt::StructOpt;\n\n#[derive(Debug, StructOpt)]\npub struct Cli {\n\t#[structopt(subcommand)]\n\tpub subcommand: Option\u003cSubcommand\u003e,\n\n\t#[structopt(flatten)]\n\tpub run: RunCmd,\n}\n\n#[derive(Debug, StructOpt)]\npub enum Subcommand {\n\t/// Build a chain specification.\n\tBuildSpec(sc_cli::BuildSpecCmd),\n\n\t/// Validate blocks.\n\tCheckBlock(sc_cli::CheckBlockCmd),\n\n\t/// Export blocks.\n\tExportBlocks(sc_cli::ExportBlocksCmd),\n\n\t/// Export the state of a given block into a chain spec.\n\tExportState(sc_cli::ExportStateCmd),\n\n\t/// Import blocks.\n\tImportBlocks(sc_cli::ImportBlocksCmd),\n\n\t/// Remove the whole chain.\n\tPurgeChain(sc_cli::PurgeChainCmd),\n\n\t/// Revert the chain to a previous state.\n\tRevert(sc_cli::RevertCmd),\n\n\t/// The custom benchmark subcommmand benchmarking runtime pallets.\n\t#[structopt(name = \"benchmark\", about = \"Benchmark runtime pallets.\")]\n\tBenchmark(frame_benchmarking_cli::BenchmarkCmd),\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","cli","src","command.rs"],"content":"// This file is part of Substrate.\n\n// Copyright (C) 2017-2020 Parity Technologies (UK) Ltd.\n// SPDX-License-Identifier: Apache-2.0\n\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// \thttp://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nuse crate::cli::{Cli, Subcommand};\nuse node_minterest_runtime::Block;\nuse sc_cli::{ChainSpec, Role, RuntimeVersion, SubstrateCli};\nuse sc_service::PartialComponents;\nuse service::{self, chain_spec};\n\nimpl SubstrateCli for Cli {\n\tfn impl_name() -\u003e String {\n\t\t\"Substrate Node\".into()\n\t}\n\n\tfn impl_version() -\u003e String {\n\t\tenv!(\"SUBSTRATE_CLI_IMPL_VERSION\").into()\n\t}\n\n\tfn description() -\u003e String {\n\t\tenv!(\"CARGO_PKG_DESCRIPTION\").into()\n\t}\n\n\tfn author() -\u003e String {\n\t\tenv!(\"CARGO_PKG_AUTHORS\").into()\n\t}\n\n\tfn support_url() -\u003e String {\n\t\t\"support.anonymous.an\".into()\n\t}\n\n\tfn copyright_start_year() -\u003e i32 {\n\t\t2017\n\t}\n\n\tfn load_spec(\u0026self, id: \u0026str) -\u003e Result\u003cBox\u003cdyn sc_service::ChainSpec\u003e, String\u003e {\n\t\tOk(match id {\n\t\t\t\"dev\" =\u003e Box::new(chain_spec::development_config()?),\n\t\t\t\"local\" =\u003e Box::new(chain_spec::local_testnet_config()?),\n\t\t\t\"\" | \"turbo-latest\" =\u003e Box::new(chain_spec::minterest_turbo_testnet_config()?),\n\t\t\tpath =\u003e Box::new(chain_spec::ChainSpec::from_json_file(std::path::PathBuf::from(path))?),\n\t\t})\n\t}\n\n\tfn native_runtime_version(_: \u0026Box\u003cdyn ChainSpec\u003e) -\u003e \u0026'static RuntimeVersion {\n\t\t\u0026node_minterest_runtime::VERSION\n\t}\n}\n\n/// Parse and run command line arguments\npub fn run() -\u003e sc_cli::Result\u003c()\u003e {\n\tlet cli = Cli::from_args();\n\n\tmatch \u0026cli.subcommand {\n\t\tSome(Subcommand::BuildSpec(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.sync_run(|config| cmd.run(config.chain_spec, config.network))\n\t\t}\n\t\tSome(Subcommand::CheckBlock(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient,\n\t\t\t\t\ttask_manager,\n\t\t\t\t\timport_queue,\n\t\t\t\t\t..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, import_queue), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::ExportBlocks(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient, task_manager, ..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, config.database), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::ExportState(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient, task_manager, ..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, config.chain_spec), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::ImportBlocks(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient,\n\t\t\t\t\ttask_manager,\n\t\t\t\t\timport_queue,\n\t\t\t\t\t..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, import_queue), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::PurgeChain(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.sync_run(|config| cmd.run(config.database))\n\t\t}\n\t\tSome(Subcommand::Revert(cmd)) =\u003e {\n\t\t\tlet runner = cli.create_runner(cmd)?;\n\t\t\trunner.async_run(|config| {\n\t\t\t\tlet PartialComponents {\n\t\t\t\t\tclient,\n\t\t\t\t\ttask_manager,\n\t\t\t\t\tbackend,\n\t\t\t\t\t..\n\t\t\t\t} = service::new_partial(\u0026config)?;\n\t\t\t\tOk((cmd.run(client, backend), task_manager))\n\t\t\t})\n\t\t}\n\t\tSome(Subcommand::Benchmark(cmd)) =\u003e {\n\t\t\tif cfg!(feature = \"runtime-benchmarks\") {\n\t\t\t\tlet runner = cli.create_runner(cmd)?;\n\n\t\t\t\trunner.sync_run(|config| cmd.run::\u003cBlock, service::Executor\u003e(config))\n\t\t\t} else {\n\t\t\t\tErr(\"Benchmarking wasn't enabled when building the node. \\\n\t\t\t\tYou can enable it with `--features runtime-benchmarks`.\"\n\t\t\t\t\t.into())\n\t\t\t}\n\t\t}\n\t\tNone =\u003e {\n\t\t\tlet runner = cli.create_runner(\u0026cli.run)?;\n\t\t\trunner.run_node_until_exit(|config| match config.role {\n\t\t\t\tRole::Light =\u003e service::new_light(config),\n\t\t\t\t_ =\u003e service::new_full(config),\n\t\t\t})\n\t\t}\n\t}\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[5549803],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[5549840],"length":1,"stats":{"Line":0},"fn_name":"impl_version"},{"line":30,"address":[5549851],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[5549888],"length":1,"stats":{"Line":0},"fn_name":"description"},{"line":34,"address":[5549896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[4273667,4273552],"length":1,"stats":{"Line":0},"fn_name":"run"},{"line":65,"address":[4273568],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[4276221,4277409,4276815,4277994,4278082,4275627,4275033,4273805,4274439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[4273690,4273815,4273770],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[4274361,4274185,4273908,4273827,4274410],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[6504259,6504240],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":72,"address":[4274452],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[4275001,4274464,4274806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[6505744,6505835],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":76,"address":[6506002],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[6506026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[6506059],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[6505850,6505893,6506131,6506737,6506297,6505762],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[6506604,6506391],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[4275046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[4275400,4275058,4275595],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[4275276],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[6507477],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[6508666,6507314,6507218,6507537,6507703],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[6508542,6507817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[4275640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[4275994,4275652,4276189],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[4275870],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[6510540],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[6510386,6510766,6510600,6510290,6511604],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[6511524,6510880],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[4276234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[4276783,4276588,4276246],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[4276464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[6513458],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[6513482],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[6513515],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[6513349,6513753,6514193,6513587,6513218,6513306],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[6514060,6513847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[4276828],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[4276840,4277377,4277182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[4277058],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[4277422],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[4277776,4277962,4277434],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[4277652],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[6516306],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[6516330],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[6516363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[6516066,6516154,6516965,6516553,6516197,6516387],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[6516647,6516896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[4278007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[4278019],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[4278322,4278483,4278087,4273724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[4278243],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[6517527,6517450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[6517472],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":71},{"path":["/","home","lut1k","Projects","minterest-chain-node","cli","src","lib.rs"],"content":"#[cfg(feature = \"cli\")]\nmod cli;\n#[cfg(feature = \"cli\")]\nmod command;\n\n#[cfg(feature = \"cli\")]\npub use cli::*;\n\n#[cfg(feature = \"cli\")]\npub use command::*;\n\n#[cfg(feature = \"cli\")]\npub use sc_cli::{Error, Result};\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","auction","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn bid_collateral_auction() -\u003e Weight {\n\t\t(493_957_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(12 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(12 as Weight))\n\t}\n\tfn bid_surplus_auction() -\u003e Weight {\n\t\t(257_830_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(6 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(5 as Weight))\n\t}\n\tfn bid_debit_auction() -\u003e Weight {\n\t\t(287_271_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(7 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(8 as Weight))\n\t}\n\tfn on_finalize(c: u32) -\u003e Weight {\n\t\t(50_992_000 as Weight)\n\t\t\t.saturating_add((171_653_000 as Weight).saturating_mul(c as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads((4 as Weight).saturating_mul(c as Weight)))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes((3 as Weight).saturating_mul(c as Weight)))\n\t}\n}\n","traces":[{"line":9,"address":[4565904],"length":1,"stats":{"Line":0},"fn_name":"bid_collateral_auction"},{"line":10,"address":[4565950,4566022],"length":1,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[4565908],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[4565970],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[4566048],"length":1,"stats":{"Line":0},"fn_name":"bid_surplus_auction"},{"line":15,"address":[4566094,4566166],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":19},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","auction","src","lib.rs"],"content":"//! # Auction\n//!\n//! ## Overview\n//!\n//! This module provides a basic abstraction to implement on-chain auctioning\n//! feature.\n//!\n//! The auction logic can be customized by implement and supplying\n//! `AuctionHandler` trait.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// Disable the following two lints since they originate from an external macro (namely decl_storage)\n#![allow(clippy::string_lit_as_bytes)]\n\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, ensure, weights::Weight, IterableStorageDoubleMap, Parameter,\n};\nuse frame_system::ensure_signed;\nuse orml_traits::{Auction, AuctionHandler, AuctionInfo, Change};\nuse sp_runtime::{\n\ttraits::{AtLeast32BitUnsigned, Bounded, MaybeSerializeDeserialize, Member, One, Zero},\n\tDispatchError, DispatchResult,\n};\nuse sp_std::result;\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn bid_collateral_auction() -\u003e Weight;\n\tfn bid_surplus_auction() -\u003e Weight;\n\tfn bid_debit_auction() -\u003e Weight;\n\tfn on_finalize(c: u32) -\u003e Weight;\n}\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// The balance type for bidding\n\ttype Balance: Parameter + Member + AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize;\n\n\t/// The auction ID type\n\ttype AuctionId: Parameter + Member + AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize + Bounded;\n\n\t/// The `AuctionHandler` that allow custom bidding logic and handles auction\n\t/// result\n\ttype Handler: AuctionHandler\u003cSelf::AccountId, Self::Balance, Self::BlockNumber, Self::AuctionId\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\t\u003cT as Trait\u003e::Balance,\n\t\t\u003cT as Trait\u003e::AuctionId,\n\t{\n\t\t/// A bid is placed. [auction_id, bidder, bidding_amount]\n\t\tBid(AuctionId, AccountId, Balance),\n\t}\n);\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Auction {\n\t\t/// Stores on-going and future auctions. Closed auction are removed.\n\t\tpub Auctions get(fn auctions): map hasher(twox_64_concat) T::AuctionId =\u003e Option\u003cAuctionInfo\u003cT::AccountId, T::Balance, T::BlockNumber\u003e\u003e;\n\n\t\t/// Track the next auction ID.\n\t\tpub AuctionsIndex get(fn auctions_index): T::AuctionId;\n\n\t\t/// Index auctions by end time.\n\t\tpub AuctionEndTime get(fn auction_end_time): double_map hasher(twox_64_concat) T::BlockNumber, hasher(twox_64_concat) T::AuctionId =\u003e Option\u003c()\u003e;\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Bid an auction.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t///     - T::Handler is module_auction_manager of Acala\n\t\t///     - Indirectly needs orml_currencies and module_cdp_treasury of Acala\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads:\n\t\t///     - collateral auction:\n\t\t///             - best cases: 7\n\t\t///             - worst cases: 14\n\t\t///     - surplus auction:\n\t\t///             - best cases: 5\n\t\t///             - worst cases: 6\n\t\t///     - debit auction:\n\t\t///             - best cases: 8\n\t\t///             - worst cases: 7\n\t\t/// - Db writes:\n\t\t///     - collateral auction:\n\t\t///             - best cases: 7\n\t\t///             - worst cases: 14\n\t\t///     - surplus auction:\n\t\t///             - best cases: 3\n\t\t///             - worst cases: 5\n\t\t///     - debit auction:\n\t\t///             - best cases: 8\n\t\t///             - worst cases: 8\n\t\t/// -------------------\n\t\t/// Base Weight:\n\t\t///     - collateral auction:\n\t\t///             - best cases: 134 µs\n\t\t///             - worst cases: 300.4 µs\n\t\t///     - surplus auction:\n\t\t///             - best cases: 97.9 µs\n\t\t///             - worst cases: 157.6 µs\n\t\t///     - debit auction:\n\t\t///             - best cases: 140.7 µs\n\t\t///             - worst cases: 142.8 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::bid_collateral_auction()]\n\t\tpub fn bid(origin, id: T::AuctionId, #[compact] value: T::Balance) {\n\t\t\tlet from = ensure_signed(origin)?;\n\n\t\t\t\u003cAuctions\u003cT\u003e\u003e::try_mutate_exists(id, |auction| -\u003e DispatchResult {\n\t\t\t\tlet mut auction = auction.as_mut().ok_or(Error::\u003cT\u003e::AuctionNotExist)?;\n\n\t\t\t\tlet block_number = \u003cframe_system::Module\u003cT\u003e\u003e::block_number();\n\n\t\t\t\t// make sure auction is started\n\t\t\t\tensure!(block_number \u003e= auction.start, Error::\u003cT\u003e::AuctionNotStarted);\n\n\t\t\t\tif let Some(ref current_bid) = auction.bid {\n\t\t\t\t\tensure!(value \u003e current_bid.1, Error::\u003cT\u003e::InvalidBidPrice);\n\t\t\t\t} else {\n\t\t\t\t\tensure!(!value.is_zero(), Error::\u003cT\u003e::InvalidBidPrice);\n\t\t\t\t}\n\t\t\t\tlet bid_result = T::Handler::on_new_bid(\n\t\t\t\t\tblock_number,\n\t\t\t\t\tid,\n\t\t\t\t\t(from.clone(), value),\n\t\t\t\t\tauction.bid.clone(),\n\t\t\t\t);\n\n\t\t\t\tensure!(bid_result.accept_bid, Error::\u003cT\u003e::BidNotAccepted);\n\t\t\t\tmatch bid_result.auction_end_change {\n\t\t\t\t\tChange::NewValue(new_end) =\u003e {\n\t\t\t\t\t\tif let Some(old_end_block) = auction.end {\n\t\t\t\t\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::remove(\u0026old_end_block, id);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif let Some(new_end_block) = new_end {\n\t\t\t\t\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::insert(\u0026new_end_block, id, ());\n\t\t\t\t\t\t}\n\t\t\t\t\t\tauction.end = new_end;\n\t\t\t\t\t},\n\t\t\t\t\tChange::NoChange =\u003e {},\n\t\t\t\t}\n\t\t\t\tauction.bid = Some((from.clone(), value));\n\n\t\t\t\tOk(())\n\t\t\t})?;\n\n\t\t\tSelf::deposit_event(RawEvent::Bid(id, from, value));\n\t\t}\n\n\t\t/// dummy `on_initialize` to return the weight used in `on_finalize`.\n\t\tfn on_initialize(now: T::BlockNumber) -\u003e Weight {\n\t\t\tT::WeightInfo::on_finalize(\u003cAuctionEndTime\u003cT\u003e\u003e::iter_prefix(\u0026now).count() as u32)\n\t\t}\n\n\t\tfn on_finalize(now: T::BlockNumber) {\n\t\t\tSelf::_on_finalize(now);\n\t\t}\n\t}\n}\n\ndecl_error! {\n\t/// Error for auction module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\tAuctionNotExist,\n\t\tAuctionNotStarted,\n\t\tBidNotAccepted,\n\t\tInvalidBidPrice,\n\t\tNoAvailableAuctionId,\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tfn _on_finalize(now: T::BlockNumber) {\n\t\tfor (auction_id, _) in \u003cAuctionEndTime\u003cT\u003e\u003e::drain_prefix(\u0026now) {\n\t\t\tif let Some(auction) = \u003cAuctions\u003cT\u003e\u003e::take(\u0026auction_id) {\n\t\t\t\tT::Handler::on_auction_ended(auction_id, auction.bid);\n\t\t\t}\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e Auction\u003cT::AccountId, T::BlockNumber\u003e for Module\u003cT\u003e {\n\ttype AuctionId = T::AuctionId;\n\ttype Balance = T::Balance;\n\n\tfn auction_info(id: Self::AuctionId) -\u003e Option\u003cAuctionInfo\u003cT::AccountId, Self::Balance, T::BlockNumber\u003e\u003e {\n\t\tSelf::auctions(id)\n\t}\n\n\tfn update_auction(\n\t\tid: Self::AuctionId,\n\t\tinfo: AuctionInfo\u003cT::AccountId, Self::Balance, T::BlockNumber\u003e,\n\t) -\u003e DispatchResult {\n\t\tlet auction = \u003cAuctions\u003cT\u003e\u003e::get(id).ok_or(Error::\u003cT\u003e::AuctionNotExist)?;\n\t\tif let Some(old_end) = auction.end {\n\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::remove(\u0026old_end, id);\n\t\t}\n\t\tif let Some(new_end) = info.end {\n\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::insert(\u0026new_end, id, ());\n\t\t}\n\t\t\u003cAuctions\u003cT\u003e\u003e::insert(id, info);\n\t\tOk(())\n\t}\n\n\tfn new_auction(\n\t\tstart: T::BlockNumber,\n\t\tend: Option\u003cT::BlockNumber\u003e,\n\t) -\u003e result::Result\u003cSelf::AuctionId, DispatchError\u003e {\n\t\tlet auction = AuctionInfo { bid: None, start, end };\n\t\tlet auction_id = \u003cAuctionsIndex\u003cT\u003e\u003e::try_mutate(|n| -\u003e result::Result\u003cSelf::AuctionId, DispatchError\u003e {\n\t\t\tlet id = *n;\n\t\t\tensure!(id != Self::AuctionId::max_value(), Error::\u003cT\u003e::NoAvailableAuctionId);\n\t\t\t*n += One::one();\n\t\t\tOk(id)\n\t\t})?;\n\t\t\u003cAuctions\u003cT\u003e\u003e::insert(auction_id, auction);\n\t\tif let Some(end_block) = end {\n\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::insert(\u0026end_block, auction_id, ());\n\t\t}\n\n\t\tOk(auction_id)\n\t}\n\n\tfn remove_auction(id: Self::AuctionId) {\n\t\tif let Some(auction) = \u003cAuctions\u003cT\u003e\u003e::take(\u0026id) {\n\t\t\tif let Some(end_block) = auction.end {\n\t\t\t\t\u003cAuctionEndTime\u003cT\u003e\u003e::remove(end_block, id);\n\t\t\t}\n\t\t}\n\t}\n}\n","traces":[{"line":54,"address":[5118278,5118117,5118304,5118471],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[5118473,5118972,5118346,5118795,5118283,5119260,5119457,5118408,5118451,5117901,5118075,5118513,5119361,5119083,5118233,5118122,5117972],"length":1,"stats":{"Line":7},"fn_name":null},{"line":65,"address":[5120272,5120057,5119616,5119664,5119767,5120240,5120048,5119760,5119600,5120244,5119585,5119872,5119852,5120192,5120016,5120205,5119840,5119630,5119568,5119982,5119952,5120020,5119968,5119744,5120176,5119601,5120096],"length":1,"stats":{"Line":85},"fn_name":"auctions\u003corml_auction::mock::Runtime,u64\u003e"},{"line":127,"address":[5124025,5124312,5124259,5124068,5123922],"length":1,"stats":{"Line":3},"fn_name":null},{"line":129,"address":[5124952,5124522,5124402,5124180,5124896],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003corml_auction::mock::Runtime\u003e"},{"line":130,"address":[5124914,5125202,5125153,5124967],"length":1,"stats":{"Line":3},"fn_name":null},{"line":132,"address":[5125138],"length":1,"stats":{"Line":2},"fn_name":null},{"line":135,"address":[5125224,5125273],"length":1,"stats":{"Line":3},"fn_name":null},{"line":137,"address":[5125371,5125512,5125265,5125421],"length":1,"stats":{"Line":2},"fn_name":null},{"line":138,"address":[5125426,5125390],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[5125349,5125514,5125504],"length":1,"stats":{"Line":3},"fn_name":null},{"line":142,"address":[5125726],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[5125585],"length":1,"stats":{"Line":1},"fn_name":null},{"line":144,"address":[5125598],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[5125605],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[5125700],"length":1,"stats":{"Line":2},"fn_name":null},{"line":149,"address":[5125844,5125805],"length":1,"stats":{"Line":3},"fn_name":null},{"line":150,"address":[5125918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[5125818,5125925],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[5126013,5125962],"length":1,"stats":{"Line":2},"fn_name":null},{"line":153,"address":[5125993],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[5126069,5126015],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[5126049],"length":1,"stats":{"Line":1},"fn_name":null},{"line":158,"address":[5126071],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[5126105,5126244],"length":1,"stats":{"Line":2},"fn_name":null},{"line":164,"address":[5126301],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[5124432],"length":1,"stats":{"Line":1},"fn_name":null},{"line":176,"address":[5121863],"length":1,"stats":{"Line":1},"fn_name":null},{"line":193,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":195,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":196,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":206,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":207,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":210,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":215,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":216,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":219,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":221,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":229,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":230,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":231,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":233,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":234,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":236,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":237,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":238,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":241,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":244,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":245,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":246,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":247,"address":[],"length":0,"stats":{"Line":1},"fn_name":null}],"covered":55,"coverable":57},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","auction","src","mock.rs"],"content":"//! Mocks for the auction module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse orml_traits::OnNewBidResult;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod auction {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\tauction\u003cT\u003e,\n\t}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\npub type Balance = u64;\npub type BlockNumber = u64;\npub type AuctionId = u64;\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = ();\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\npub struct Handler;\n\nimpl AuctionHandler\u003cAccountId, Balance, BlockNumber, AuctionId\u003e for Handler {\n\tfn on_new_bid(\n\t\tnow: BlockNumber,\n\t\t_id: AuctionId,\n\t\tnew_bid: (AccountId, Balance),\n\t\t_last_bid: Option\u003c(AccountId, Balance)\u003e,\n\t) -\u003e OnNewBidResult\u003cBlockNumber\u003e {\n\t\tif new_bid.0 == ALICE {\n\t\t\tOnNewBidResult {\n\t\t\t\taccept_bid: true,\n\t\t\t\tauction_end_change: Change::NewValue(Some(now + BID_EXTEND_BLOCK)),\n\t\t\t}\n\t\t} else {\n\t\t\tOnNewBidResult {\n\t\t\t\taccept_bid: false,\n\t\t\t\tauction_end_change: Change::NoChange,\n\t\t\t}\n\t\t}\n\t}\n\n\tfn on_auction_ended(_id: AuctionId, _winner: Option\u003c(AccountId, Balance)\u003e) {}\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype AuctionId = AuctionId;\n\ttype Handler = Handler;\n\ttype WeightInfo = ();\n}\npub type AuctionModule = Module\u003cRuntime\u003e;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const BID_EXTEND_BLOCK: BlockNumber = 10;\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[{"line":11,"address":[4213557,4213488],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[4214686,4214439,4214207,4214780,4213854,4213728,4213888,4214034],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[4213868,4214182,4213923,4214139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[4214564,4214607,4214291,4214221],"length":1,"stats":{"Line":2},"fn_name":null},{"line":33,"address":[5149553],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":79,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":92,"address":[5144336,5144343,5144341],"length":1,"stats":{"Line":2},"fn_name":"on_auction_ended"},{"line":111,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":112,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":122,"address":[],"length":0,"stats":{"Line":8},"fn_name":null}],"covered":10,"coverable":14},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","auction","src","tests.rs"],"content":"//! Unit tests for the tokens module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok, traits::OnFinalize};\nuse mock::*;\n\n#[test]\nfn new_auction_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t});\n}\n\n#[test]\nfn update_auction_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_noop!(\n\t\t\tAuctionModule::update_auction(\n\t\t\t\t1,\n\t\t\t\tAuctionInfo {\n\t\t\t\t\tbid: Some((ALICE, 100)),\n\t\t\t\t\tstart: 10,\n\t\t\t\t\tend: Some(100)\n\t\t\t\t}\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::AuctionNotExist,\n\t\t);\n\t\tassert_ok!(AuctionModule::update_auction(\n\t\t\t0,\n\t\t\tAuctionInfo {\n\t\t\t\tbid: Some((ALICE, 100)),\n\t\t\t\tstart: 10,\n\t\t\t\tend: Some(100)\n\t\t\t}\n\t\t));\n\t});\n}\n\n#[test]\nfn auction_info_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_eq!(\n\t\t\tAuctionModule::auction_info(0),\n\t\t\tSome(AuctionInfo {\n\t\t\t\tbid: None,\n\t\t\t\tstart: 10,\n\t\t\t\tend: Some(100)\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn bid_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\t\tassert_ok!(AuctionModule::new_auction(0, Some(5)), 0);\n\t\tassert_eq!(\n\t\t\tAuctionModule::auction_info(0),\n\t\t\tSome(AuctionInfo {\n\t\t\t\tbid: None,\n\t\t\t\tstart: 0,\n\t\t\t\tend: Some(5)\n\t\t\t})\n\t\t);\n\t\tassert_ok!(AuctionModule::bid(Origin::signed(ALICE), 0, 20));\n\t\tlet bid_event = TestEvent::auction(RawEvent::Bid(0, ALICE, 20));\n\t\tassert!(System::events().iter().any(|record| record.event == bid_event));\n\t\tassert_eq!(\n\t\t\tAuctionModule::auction_info(0),\n\t\t\tSome(AuctionInfo {\n\t\t\t\tbid: Some((ALICE, 20)),\n\t\t\t\tstart: 0,\n\t\t\t\tend: Some(11)\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn bid_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_ok!(AuctionModule::new_auction(0, Some(100)), 1);\n\t\tassert_noop!(\n\t\t\tAuctionModule::bid(Origin::signed(ALICE), 0, 20),\n\t\t\tError::\u003cRuntime\u003e::AuctionNotStarted\n\t\t);\n\t\tassert_noop!(\n\t\t\tAuctionModule::bid(Origin::signed(BOB), 1, 20),\n\t\t\tError::\u003cRuntime\u003e::BidNotAccepted,\n\t\t);\n\t\tassert_noop!(\n\t\t\tAuctionModule::bid(Origin::signed(ALICE), 1, 0),\n\t\t\tError::\u003cRuntime\u003e::InvalidBidPrice,\n\t\t);\n\t});\n}\n\n#[test]\nfn remove_auction_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_eq!(AuctionModule::auctions_index(), 1);\n\t\tassert_eq!(AuctionModule::auctions(0).is_some(), true);\n\t\tassert_eq!(AuctionModule::auction_end_time(100, 0), Some(()));\n\t\tAuctionModule::remove_auction(0);\n\t\tassert_eq!(AuctionModule::auctions(0), None);\n\t\tassert_eq!(AuctionModule::auction_end_time(100, 0), None);\n\t});\n}\n\n#[test]\nfn cleanup_auction_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(100)), 0);\n\t\tassert_eq!(AuctionModule::auctions_index(), 1);\n\t\tassert_ok!(AuctionModule::new_auction(10, Some(50)), 1);\n\t\tassert_eq!(AuctionModule::auctions_index(), 2);\n\t\tassert_eq!(AuctionModule::auctions(0).is_some(), true);\n\t\tassert_eq!(AuctionModule::auctions(1).is_some(), true);\n\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(0).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(50).count(), 1);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(100).count(), 1);\n\n\t\tAuctionModule::on_finalize(50);\n\t\tassert_eq!(AuctionModule::auctions(0).is_some(), true);\n\t\tassert_eq!(AuctionModule::auctions(1).is_some(), false);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(0).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(50).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(100).count(), 1);\n\n\t\tAuctionModule::on_finalize(100);\n\t\tassert_eq!(AuctionModule::auctions(0).is_some(), false);\n\t\tassert_eq!(AuctionModule::auctions(1).is_some(), false);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(0).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(50).count(), 0);\n\t\tassert_eq!(\u003cAuctionEndTime\u003cRuntime\u003e\u003e::iter_prefix(100).count(), 0);\n\t});\n}\n\n#[test]\nfn cannot_add_new_auction_when_no_available_id() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t\u003cAuctionsIndex\u003cRuntime\u003e\u003e::put(AuctionId::max_value());\n\t\tassert_noop!(\n\t\t\tAuctionModule::new_auction(0, None),\n\t\t\tError::\u003cRuntime\u003e::NoAvailableAuctionId\n\t\t);\n\t});\n}\n","traces":[{"line":10,"address":[4964528,4964533],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":11,"address":[4249453,4249431],"length":1,"stats":{"Line":3},"fn_name":null},{"line":12,"address":[4964706,4964567],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[4249520,4249534],"length":1,"stats":{"Line":3},"fn_name":"update_auction_should_work"},{"line":18,"address":[4965075,4965008],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":19,"address":[4965227,4965097,4965015],"length":1,"stats":{"Line":2},"fn_name":null},{"line":20,"address":[4965763,4965721,4965200],"length":1,"stats":{"Line":3},"fn_name":null},{"line":21,"address":[4965706],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4965609],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[4965528],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4965585],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4965713],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4966922],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4966828],"length":1,"stats":{"Line":1},"fn_name":null},{"line":34,"address":[4966747],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4966804],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[4249616,4249630],"length":1,"stats":{"Line":3},"fn_name":"auction_info_should_work"},{"line":44,"address":[4249623,4249645],"length":1,"stats":{"Line":3},"fn_name":null},{"line":45,"address":[4967255,4967444],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[4967719,4967823],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4967418],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[4249712,4249726],"length":1,"stats":{"Line":3},"fn_name":"bid_should_work"},{"line":59,"address":[4249719,4249741],"length":1,"stats":{"Line":3},"fn_name":null},{"line":60,"address":[4968183],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[4968214,4968407],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[4968715,4968853],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4968381],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[4968835,4969158],"length":1,"stats":{"Line":2},"fn_name":null},{"line":71,"address":[4969424],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4968142,4968128,4969548,4969752],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":73,"address":[4969789,4969893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4969737],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4249822,4249808],"length":1,"stats":{"Line":3},"fn_name":"bid_should_fail"},{"line":86,"address":[4249837,4249815],"length":1,"stats":{"Line":3},"fn_name":null},{"line":87,"address":[4970313,4970486,4970231],"length":1,"stats":{"Line":2},"fn_name":null},{"line":88,"address":[4970924,4970794,4970420],"length":1,"stats":{"Line":2},"fn_name":null},{"line":89,"address":[4971308,4970897],"length":1,"stats":{"Line":2},"fn_name":null},{"line":90,"address":[4971242],"length":1,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[4971300],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[4972490,4972387],"length":1,"stats":{"Line":2},"fn_name":null},{"line":94,"address":[4972423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[4972482],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4973671,4973569],"length":1,"stats":{"Line":2},"fn_name":null},{"line":98,"address":[4973605],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4973663],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[4249918,4249904],"length":1,"stats":{"Line":3},"fn_name":"remove_auction_should_work"},{"line":106,"address":[4249933,4249911],"length":1,"stats":{"Line":3},"fn_name":null},{"line":107,"address":[4974871,4975065],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[4975373,4975502,4975039],"length":1,"stats":{"Line":2},"fn_name":null},{"line":109,"address":[4975958,4975795,4975469],"length":1,"stats":{"Line":2},"fn_name":null},{"line":110,"address":[4975919,4976383,4976251],"length":1,"stats":{"Line":2},"fn_name":null},{"line":111,"address":[4976365],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[4976832,4976688],"length":1,"stats":{"Line":1},"fn_name":null},{"line":113,"address":[4977100,4976803,4977211],"length":1,"stats":{"Line":2},"fn_name":null},{"line":118,"address":[4250014,4250000],"length":1,"stats":{"Line":3},"fn_name":"cleanup_auction_should_work"},{"line":119,"address":[4250029,4250007],"length":1,"stats":{"Line":3},"fn_name":null},{"line":120,"address":[4977727,4977533],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[4978205,4978035,4977701],"length":1,"stats":{"Line":2},"fn_name":null},{"line":122,"address":[4978505,4978127,4978634],"length":1,"stats":{"Line":2},"fn_name":null},{"line":123,"address":[4978608,4979071,4978942],"length":1,"stats":{"Line":2},"fn_name":null},{"line":124,"address":[4979038,4979522,4979364],"length":1,"stats":{"Line":2},"fn_name":null},{"line":125,"address":[4979484,4979815,4979972],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[4980423,4979939,4980265],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[4980716,4980874,4980385],"length":1,"stats":{"Line":2},"fn_name":null},{"line":129,"address":[4980836,4981317,4981167],"length":1,"stats":{"Line":2},"fn_name":null},{"line":131,"address":[4981287],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[4981785,4981614],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[4981747,4982235,4982078],"length":1,"stats":{"Line":2},"fn_name":null},{"line":134,"address":[4982202,4982686,4982528],"length":1,"stats":{"Line":2},"fn_name":null},{"line":135,"address":[4982979,4982648,4983137],"length":1,"stats":{"Line":2},"fn_name":null},{"line":136,"address":[4983580,4983430,4983099],"length":1,"stats":{"Line":2},"fn_name":null},{"line":138,"address":[4983550],"length":1,"stats":{"Line":1},"fn_name":null},{"line":139,"address":[4983877,4984048],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[4984341,4984010,4984498],"length":1,"stats":{"Line":2},"fn_name":null},{"line":141,"address":[4984949,4984465,4984791],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[4984911,4985230,4985379],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[4985773,4985639,4985344],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[4250096,4250110],"length":1,"stats":{"Line":3},"fn_name":"cannot_add_new_auction_when_no_available_id"},{"line":149,"address":[4250125,4250103],"length":1,"stats":{"Line":3},"fn_name":null},{"line":150,"address":[4986071,4986088],"length":1,"stats":{"Line":2},"fn_name":null},{"line":151,"address":[4986100,4986211,4986169],"length":1,"stats":{"Line":3},"fn_name":null},{"line":152,"address":[4986114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[4986161],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":83,"coverable":83},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","authority","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn dispatch_as() -\u003e Weight {\n\t\t(43_132_000 as Weight)\n\t}\n\tfn schedule_dispatch_without_delay() -\u003e Weight {\n\t\t(123_715_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n\tfn schedule_dispatch_with_delay() -\u003e Weight {\n\t\t(116_719_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n\tfn fast_track_scheduled_dispatch() -\u003e Weight {\n\t\t(59_055_000 as Weight)\n\t}\n\tfn delay_scheduled_dispatch() -\u003e Weight {\n\t\t(44_796_000 as Weight)\n\t}\n\tfn cancel_scheduled_dispatch() -\u003e Weight {\n\t\t(140_123_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":10,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[4217310,4217382],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[4217268],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[4217330],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[4217412],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":1,"coverable":18},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","authority","src","lib.rs"],"content":"//! # Authority\n//! A module to provide features for governance including dispatch method on\n//! behalf of other accounts and schedule dispatchables.\n//!\n//! - [`Trait`](./trait.Trait.html)\n//! - [`Call`](./enum.Call.html)\n//! - [`Module`](./struct.Module.html)\n//!\n//! ## Overview\n//!\n//! Two functionalities are provided by this module:\n//! - schedule a dispatchable\n//! - dispatch method with on behalf of other origins\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// Disable the following three lints since they originate from an external macro\n#![allow(clippy::string_lit_as_bytes)]\n#![allow(clippy::boxed_local)]\n#![allow(clippy::borrowed_box)]\n\nuse codec::{Decode, Encode};\nuse frame_support::weights::Weight;\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage,\n\tdispatch::PostDispatchInfo,\n\ttraits::{\n\t\tschedule::{DispatchTime, Named as ScheduleNamed, Priority},\n\t\tEnsureOrigin, Get, IsType, OriginTrait,\n\t},\n\tweights::GetDispatchInfo,\n\tParameter,\n};\nuse sp_runtime::{\n\ttraits::{CheckedSub, Dispatchable, Saturating},\n\tDispatchError, DispatchResult, RuntimeDebug,\n};\nuse sp_std::prelude::*;\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn dispatch_as() -\u003e Weight;\n\tfn schedule_dispatch_without_delay() -\u003e Weight;\n\tfn schedule_dispatch_with_delay() -\u003e Weight;\n\tfn fast_track_scheduled_dispatch() -\u003e Weight;\n\tfn delay_scheduled_dispatch() -\u003e Weight;\n\tfn cancel_scheduled_dispatch() -\u003e Weight;\n}\n\n/// A delayed origin. Can only be dispatched via `dispatch_as` with a delay.\n#[derive(PartialEq, Eq, Clone, RuntimeDebug, Encode, Decode)]\npub struct DelayedOrigin\u003cBlockNumber, PalletsOrigin\u003e {\n\t/// Number of blocks that this call have been delayed.\n\tpub delay: BlockNumber,\n\t/// The initial origin.\n\tpub origin: Box\u003cPalletsOrigin\u003e,\n}\n\n/// Ensure the origin have a minimum amount of delay.\npub struct EnsureDelayed\u003cDelay, Inner, BlockNumber, PalletsOrigin\u003e(\n\tsp_std::marker::PhantomData\u003c(Delay, Inner, BlockNumber, PalletsOrigin)\u003e,\n);\nimpl\u003c\n\t\tPalletsOrigin: Into\u003cO\u003e,\n\t\tO: Into\u003cResult\u003cDelayedOrigin\u003cBlockNumber, PalletsOrigin\u003e, O\u003e\u003e + From\u003cDelayedOrigin\u003cBlockNumber, PalletsOrigin\u003e\u003e,\n\t\tDelay: Get\u003cBlockNumber\u003e,\n\t\tInner: EnsureOrigin\u003cO\u003e,\n\t\tBlockNumber: PartialOrd,\n\t\u003e EnsureOrigin\u003cO\u003e for EnsureDelayed\u003cDelay, Inner, BlockNumber, PalletsOrigin\u003e\n{\n\ttype Success = Inner::Success;\n\n\tfn try_origin(o: O) -\u003e Result\u003cSelf::Success, O\u003e {\n\t\to.into().and_then(|delayed_origin| {\n\t\t\tif delayed_origin.delay \u003e= Delay::get() {\n\t\t\t\tlet pallets_origin = *delayed_origin.origin;\n\t\t\t\tInner::try_origin(pallets_origin.into())\n\t\t\t} else {\n\t\t\t\tErr(delayed_origin.into())\n\t\t\t}\n\t\t})\n\t}\n\n\t#[cfg(feature = \"runtime-benchmarks\")]\n\tfn successful_origin() -\u003e O {\n\t\tunimplemented!()\n\t}\n}\n\n/// Origin for the authority module.\npub type Origin\u003cT\u003e = DelayedOrigin\u003c\u003cT as frame_system::Trait\u003e::BlockNumber, \u003cT as Trait\u003e::PalletsOrigin\u003e;\n\n/// Config for orml-authority\npub trait AuthorityConfig\u003cOrigin, PalletsOrigin, BlockNumber\u003e {\n\t/// Check if the `origin` is allowed to schedule a dispatchable call with a\n\t/// given `priority`.\n\tfn check_schedule_dispatch(origin: Origin, priority: Priority) -\u003e DispatchResult;\n\t/// Check if the `origin` is allow to fast track a scheduled task that\n\t/// initially created by `initial_origin`. `new_delay` is number of blocks\n\t/// this dispatchable will be dispatched from now after fast track.\n\tfn check_fast_track_schedule(\n\t\torigin: Origin,\n\t\tinitial_origin: \u0026PalletsOrigin,\n\t\tnew_delay: BlockNumber,\n\t) -\u003e DispatchResult;\n\t/// Check if the `origin` is allow to delay a scheduled task that initially\n\t/// created by `inital_origin`.\n\tfn check_delay_schedule(origin: Origin, initial_origin: \u0026PalletsOrigin) -\u003e DispatchResult;\n\t/// Check if the `origin` is allow to cancel a scheduled task that initially\n\t/// created by `inital_origin`.\n\tfn check_cancel_schedule(origin: Origin, initial_origin: \u0026PalletsOrigin) -\u003e DispatchResult;\n}\n\n/// Represent an origin that can be dispatched by other origins with permission\n/// check.\npub trait AsOriginId\u003cOrigin, PalletsOrigin\u003e {\n\t/// Convert into `PalletsOrigin`\n\tfn into_origin(self) -\u003e PalletsOrigin;\n\t/// Check if the `origin` is allow to dispatch call on behalf of this\n\t/// origin.\n\tfn check_dispatch_from(\u0026self, origin: Origin) -\u003e DispatchResult;\n}\n\ntype CallOf\u003cT\u003e = \u003cT as Trait\u003e::Call;\n\n/// The schedule task index type.\npub type ScheduleTaskIndex = u32;\n\n/// orml-authority configuration trait.\npub trait Trait: frame_system::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// The outer origin type.\n\ttype Origin: From\u003cDelayedOrigin\u003cSelf::BlockNumber, \u003cSelf as Trait\u003e::PalletsOrigin\u003e\u003e\n\t\t+ IsType\u003c\u003cSelf as frame_system::Trait\u003e::Origin\u003e\n\t\t+ OriginTrait\u003cPalletsOrigin = Self::PalletsOrigin\u003e;\n\n\t/// The caller origin, overarching type of all pallets origins.\n\ttype PalletsOrigin: Parameter + Into\u003c\u003cSelf as frame_system::Trait\u003e::Origin\u003e;\n\n\t/// The aggregated call type.\n\ttype Call: Parameter\n\t\t+ Dispatchable\u003cOrigin = \u003cSelf as frame_system::Trait\u003e::Origin, PostInfo = PostDispatchInfo\u003e\n\t\t+ GetDispatchInfo;\n\n\t/// The Scheduler.\n\ttype Scheduler: ScheduleNamed\u003cSelf::BlockNumber, \u003cSelf as Trait\u003e::Call, Self::PalletsOrigin\u003e;\n\n\t/// The type represent origin that can be dispatched by other origins.\n\ttype AsOriginId: Parameter + AsOriginId\u003c\u003cSelf as frame_system::Trait\u003e::Origin, Self::PalletsOrigin\u003e;\n\n\t/// Additional permission config.\n\ttype AuthorityConfig: AuthorityConfig\u003c\u003cSelf as frame_system::Trait\u003e::Origin, Self::PalletsOrigin, Self::BlockNumber\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Calculation overflow.\n\t\tOverflow,\n\t\t/// Failed to schedule a task.\n\t\tFailedToSchedule,\n\t\t/// Failed to cancel a task.\n\t\tFailedToCancel,\n\t}\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Authority {\n\t\t/// Track the next task ID.\n\t\tpub NextTaskIndex get(fn next_task_index): ScheduleTaskIndex;\n\t}\n}\n\ndecl_event! {\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as Trait\u003e::PalletsOrigin,\n\t\t\u003cT as frame_system::Trait\u003e::BlockNumber,\n\t{\n\t\t/// A call is dispatched. [result]\n\t\tDispatched(DispatchResult),\n\t\t/// A call is scheduled. [origin, index]\n\t\tScheduled(PalletsOrigin, ScheduleTaskIndex),\n\t\t/// A scheduled call is fast tracked. [origin, index, when]\n\t\tFastTracked(PalletsOrigin, ScheduleTaskIndex, BlockNumber),\n\t\t/// A scheduled call is delayed. [origin, index, when]\n\t\tDelayed(PalletsOrigin, ScheduleTaskIndex, BlockNumber),\n\t\t/// A scheduled call is cancelled. [origin, index]\n\t\tCancelled(PalletsOrigin, ScheduleTaskIndex),\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: \u003cT as frame_system::Trait\u003e::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Dispatch a dispatchable on behalf of other origin\n\t\t#[weight = (T::WeightInfo::dispatch_as().saturating_add(call.get_dispatch_info().weight), call.get_dispatch_info().class)]\n\t\tpub fn dispatch_as(\n\t\t\torigin,\n\t\t\tas_origin: T::AsOriginId,\n\t\t\tcall: Box\u003cCallOf\u003cT\u003e\u003e,\n\t\t) {\n\t\t\tas_origin.check_dispatch_from(origin)?;\n\n\t\t\tlet e = call.dispatch(as_origin.into_origin().into());\n\n\t\t\tSelf::deposit_event(RawEvent::Dispatched(e.map(|_| ()).map_err(|e| e.error)));\n\t\t}\n\n\t\t/// Schedule a dispatchable to be dispatched at later block.\n\t\t/// This is the only way to dispatch a call with `DelayedOrigin`.\n\t\t#[weight = T::WeightInfo::schedule_dispatch_without_delay()]\n\t\tpub fn schedule_dispatch(\n\t\t\torigin,\n\t\t\twhen: DispatchTime\u003cT::BlockNumber\u003e,\n\t\t\tpriority: Priority,\n\t\t\twith_delayed_origin: bool,\n\t\t\tcall: Box\u003cCallOf\u003cT\u003e\u003e,\n\t\t) {\n\t\t\tT::AuthorityConfig::check_schedule_dispatch(origin.clone(), priority)?;\n\n\t\t\tlet id = NextTaskIndex::mutate(|id| -\u003e sp_std::result::Result\u003cScheduleTaskIndex, DispatchError\u003e {\n\t\t\t\tlet current_id = *id;\n\t\t\t\t*id = id.checked_add(1).ok_or(Error::\u003cT\u003e::Overflow)?;\n\t\t\t\tOk(current_id)\n\t\t\t})?;\n\n\t\t\tlet now = frame_system::Module::\u003cT\u003e::block_number();\n\n\t\t\tlet delay = match when {\n\t\t\t\tDispatchTime::At(x) =\u003e x.checked_sub(\u0026now).ok_or(Error::\u003cT\u003e::Overflow)?,\n\t\t\t\tDispatchTime::After(x) =\u003e x\n\t\t\t};\n\n\t\t\tlet schedule_origin = if with_delayed_origin {\n\t\t\t\tlet origin: \u003cT as Trait\u003e::Origin = From::from(origin);\n\t\t\t\tlet origin: \u003cT as Trait\u003e::Origin = From::from(DelayedOrigin::\u003cT::BlockNumber, T::PalletsOrigin\u003e {\n\t\t\t\t\tdelay,\n\t\t\t\t\torigin: Box::new(origin.caller().clone())\n\t\t\t\t});\n\t\t\t\torigin\n\t\t\t} else {\n\t\t\t\t\u003cT as Trait\u003e::Origin::from(origin)\n\t\t\t};\n\n\t\t\tlet pallets_origin = schedule_origin.caller().clone();\n\n\t\t\tT::Scheduler::schedule_named(\n\t\t\t\tEncode::encode(\u0026(\u0026pallets_origin, id)),\n\t\t\t\twhen,\n\t\t\t\tNone,\n\t\t\t\tpriority,\n\t\t\t\tpallets_origin.clone(),\n\t\t\t\t*call,\n\t\t\t).map_err(|_| Error::\u003cT\u003e::FailedToSchedule)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Scheduled(pallets_origin, id));\n\t\t}\n\n\t\t/// Fast track a scheduled dispatchable.\n\t\t/// WARN: This is not fully implemented.\n\t\t#[weight = T::WeightInfo::fast_track_scheduled_dispatch()]\n\t\tpub fn fast_track_scheduled_dispatch(\n\t\t\torigin,\n\t\t\tinitial_origin: T::PalletsOrigin,\n\t\t\ttask_id: ScheduleTaskIndex,\n\t\t\twhen: DispatchTime\u003cT::BlockNumber\u003e,\n\t\t) {\n\t\t\tlet now = frame_system::Module::\u003cT\u003e::block_number();\n\n\t\t\tlet new_delay = match when {\n\t\t\t\tDispatchTime::At(x) =\u003e x.checked_sub(\u0026now).ok_or(Error::\u003cT\u003e::Overflow)?,\n\t\t\t\tDispatchTime::After(x) =\u003e x\n\t\t\t};\n\n\t\t\tT::AuthorityConfig::check_fast_track_schedule(origin, \u0026initial_origin, new_delay)?;\n\n\t\t\tlet now = frame_system::Module::\u003cT\u003e::block_number();\n\n\t\t\tlet when = match when {\n\t\t\t\tDispatchTime::At(x) =\u003e x,\n\t\t\t\tDispatchTime::After(x) =\u003e now.saturating_add(x)\n\t\t\t};\n\n\t\t\t// TODO: depends https://github.com/paritytech/substrate/issues/6774\n\n\t\t\tSelf::deposit_event(RawEvent::FastTracked(initial_origin, task_id, when));\n\t\t}\n\n\t\t/// Delay a scheduled dispatchable.\n\t\t/// WARN: This is not fully implemented.\n\t\t#[weight = T::WeightInfo::delay_scheduled_dispatch()]\n\t\tpub fn delay_scheduled_dispatch(\n\t\t\torigin,\n\t\t\tinitial_origin: T::PalletsOrigin,\n\t\t\ttask_id: ScheduleTaskIndex,\n\t\t\t_additional_delay: T::BlockNumber,\n\t\t) {\n\t\t\tT::AuthorityConfig::check_delay_schedule(origin, \u0026initial_origin)?;\n\n\t\t\t// TODO: depends https://github.com/paritytech/substrate/issues/6774\n\n\t\t\tSelf::deposit_event(RawEvent::Delayed(initial_origin, task_id, 0.into()));\n\t\t}\n\n\t\t/// Cancel a scheduled dispatchable.\n\t\t#[weight = T::WeightInfo::cancel_scheduled_dispatch()]\n\t\tpub fn cancel_scheduled_dispatch(\n\t\t\torigin,\n\t\t\tinitial_origin: T::PalletsOrigin,\n\t\t\ttask_id: ScheduleTaskIndex,\n\t\t) {\n\t\t\tT::AuthorityConfig::check_cancel_schedule(origin, \u0026initial_origin)?;\n\n\t\t\tT::Scheduler::cancel_named((\u0026initial_origin, task_id).encode()).map_err(|_| Error::\u003cT\u003e::FailedToCancel)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Cancelled(initial_origin, task_id));\n\t\t}\n\t}\n}\n","traces":[{"line":75,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[4324304,4324276,4324272],"length":1,"stats":{"Line":23},"fn_name":"{{closure}}"},{"line":180,"address":[4326492,4327466,4326745,4326524,4327186,4328163,4326006,4328706,4328502,4327046,4327755,4327240,4329015,4327886,4328470,4327940],"length":1,"stats":{"Line":7},"fn_name":null},{"line":186,"address":[4326123,4332550,4331381,4325890,4326073,4325832,4326178,4329989],"length":1,"stats":{"Line":6},"fn_name":null},{"line":188,"address":[4332637,4328762,4330059,4331451,4326614,4326510,4326665,4330224,4326722,4331616,4326220,4326443,4326278,4326758],"length":1,"stats":{"Line":18},"fn_name":null},{"line":190,"address":[4331622,4330230,4327345,4330447,4327479,4327000,4327446,4332802,4327398,4331839,4327199,4327163,4326835,4328767,4327064,4326777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[4331909,4327498,4328095,4327556,4333018,4328143,4327866,4327712,4330734,4327773,4327899,4328042,4328777,4330517,4332126,4328176],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[4332196,4328488,4328640,4332483,4328592,4332358,4330966,4328424,4328719,4328686,4328787,4328268,4330804,4333236,4328195],"length":1,"stats":{"Line":6},"fn_name":null},{"line":198,"address":[4364646,4360458,4362801,4363229,4362535,4362075,4363181,4361753,4364806,4363845,4361396,4364087,4360948,4363723,4360794,4361810,4363354,4360602,4361547,4363510,4361249,4364484,4361005,4362487,4362955,4363769,4362234,4364271],"length":1,"stats":{"Line":5},"fn_name":null},{"line":205,"address":[4333615],"length":1,"stats":{"Line":2},"fn_name":null},{"line":211,"address":[4345908,4346022,4346185,4346303,4346045],"length":1,"stats":{"Line":4},"fn_name":null},{"line":213,"address":[4346775,4346397,4346068],"length":1,"stats":{"Line":2},"fn_name":null},{"line":215,"address":[4346944,4346964,4346960,4346451,4346945],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}\u003corml_authority::mock::Runtime\u003e"},{"line":220,"address":[4334322],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[4349268,4349040,4349007,4349098,4349146],"length":1,"stats":{"Line":7},"fn_name":null},{"line":230,"address":[4349431,4349136,4351584,4349366,4349391],"length":1,"stats":{"Line":12},"fn_name":"{{closure}}\u003corml_authority::mock::Runtime\u003e"},{"line":231,"address":[4351599],"length":1,"stats":{"Line":3},"fn_name":null},{"line":232,"address":[4351811,4351605,4351765],"length":1,"stats":{"Line":3},"fn_name":null},{"line":233,"address":[4351754],"length":1,"stats":{"Line":3},"fn_name":null},{"line":236,"address":[4349419,4349555],"length":1,"stats":{"Line":6},"fn_name":null},{"line":238,"address":[4349602,4349854],"length":1,"stats":{"Line":3},"fn_name":null},{"line":239,"address":[4349563,4349856,4349609],"length":1,"stats":{"Line":5},"fn_name":null},{"line":240,"address":[4349578],"length":1,"stats":{"Line":1},"fn_name":null},{"line":243,"address":[4350361,4349929],"length":1,"stats":{"Line":6},"fn_name":null},{"line":244,"address":[4350012],"length":1,"stats":{"Line":3},"fn_name":null},{"line":245,"address":[4350246],"length":1,"stats":{"Line":3},"fn_name":null},{"line":246,"address":[4350086],"length":1,"stats":{"Line":3},"fn_name":null},{"line":247,"address":[4350107],"length":1,"stats":{"Line":3},"fn_name":null},{"line":249,"address":[4350298],"length":1,"stats":{"Line":3},"fn_name":null},{"line":251,"address":[4349935],"length":1,"stats":{"Line":2},"fn_name":null},{"line":254,"address":[4350373,4350423],"length":1,"stats":{"Line":6},"fn_name":null},{"line":256,"address":[4350824,4350628,4350792,4350738],"length":1,"stats":{"Line":6},"fn_name":null},{"line":257,"address":[4350439],"length":1,"stats":{"Line":3},"fn_name":null},{"line":258,"address":[4350492],"length":1,"stats":{"Line":2},"fn_name":null},{"line":259,"address":[4350508],"length":1,"stats":{"Line":3},"fn_name":null},{"line":261,"address":[4350546],"length":1,"stats":{"Line":3},"fn_name":null},{"line":262,"address":[4350553],"length":1,"stats":{"Line":3},"fn_name":null},{"line":263,"address":[4350714,4351341,4350826,4351828,4350822,4350768,4350929,4351824],"length":1,"stats":{"Line":13},"fn_name":"{{closure}}\u003corml_authority::mock::Runtime\u003e"},{"line":265,"address":[4350934],"length":1,"stats":{"Line":1},"fn_name":null},{"line":270,"address":[4334798],"length":1,"stats":{"Line":0},"fn_name":null},{"line":277,"address":[4353758,4353794],"length":1,"stats":{"Line":2},"fn_name":null},{"line":279,"address":[4354111,4353859],"length":1,"stats":{"Line":1},"fn_name":null},{"line":280,"address":[4354184,4353802,4353866,4354116],"length":1,"stats":{"Line":2},"fn_name":null},{"line":281,"address":[4353835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[4354405,4354257],"length":1,"stats":{"Line":1},"fn_name":null},{"line":286,"address":[4354393,4354527],"length":1,"stats":{"Line":2},"fn_name":null},{"line":288,"address":[4354585,4354611],"length":1,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[4354587,4354535],"length":1,"stats":{"Line":2},"fn_name":null},{"line":290,"address":[4354550,4354617],"length":1,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[4354625],"length":1,"stats":{"Line":1},"fn_name":null},{"line":300,"address":[4335223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":307,"address":[4356936,4356819,4357042,4356959,4357163],"length":1,"stats":{"Line":3},"fn_name":null},{"line":311,"address":[4356982,4357231],"length":1,"stats":{"Line":2},"fn_name":null},{"line":315,"address":[4335587],"length":1,"stats":{"Line":0},"fn_name":null},{"line":321,"address":[4359488,4359711,4359590,4359371,4359511],"length":1,"stats":{"Line":3},"fn_name":null},{"line":323,"address":[4359542,4359789,4360292,4359987,4360288],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}\u003corml_authority::mock::Runtime\u003e"},{"line":325,"address":[4359876],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":48,"coverable":63},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","authority","src","mock.rs"],"content":"//! Mocks for the authority module.\n\n#![cfg(test)]\n\nuse frame_support::{\n\tparameter_types,\n\ttraits::{OnFinalize, OnInitialize},\n};\nuse frame_system::{ensure_root, ensure_signed, EnsureRoot};\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{BadOrigin, Block as BlockT, IdentityLookup},\n\tPerbill,\n};\n\nuse super::*;\npub use crate as authority;\n\npub type AccountId = u128;\npub type BlockNumber = u64;\n\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = Call;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = Event;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub MaximumSchedulerWeight: u32 = Perbill::from_percent(80) * MaximumBlockWeight::get();\n}\nimpl pallet_scheduler::Trait for Runtime {\n\ttype Event = Event;\n\ttype Origin = Origin;\n\ttype PalletsOrigin = OriginCaller;\n\ttype Call = Call;\n\ttype MaximumWeight = MaximumSchedulerWeight;\n\ttype ScheduleOrigin = EnsureRoot\u003cu128\u003e;\n\ttype MaxScheduledPerBlock = ();\n\ttype WeightInfo = ();\n}\n\n#[derive(Clone, Encode, Decode, Eq, PartialEq, Ord, PartialOrd, Debug)]\npub enum MockAsOriginId {\n\tRoot,\n\tAccount1,\n\tAccount2,\n}\n\npub struct AuthorityConfigImpl;\n\nimpl AuthorityConfig\u003cOrigin, OriginCaller, BlockNumber\u003e for AuthorityConfigImpl {\n\tfn check_schedule_dispatch(origin: Origin, _priority: Priority) -\u003e DispatchResult {\n\t\tlet origin: Result\u003cframe_system::RawOrigin\u003cu128\u003e, _\u003e = origin.into();\n\t\tmatch origin {\n\t\t\tOk(frame_system::RawOrigin::Root)\n\t\t\t| Ok(frame_system::RawOrigin::Signed(1))\n\t\t\t| Ok(frame_system::RawOrigin::Signed(2)) =\u003e Ok(()),\n\t\t\t_ =\u003e Err(BadOrigin.into()),\n\t\t}\n\t}\n\tfn check_fast_track_schedule(\n\t\torigin: Origin,\n\t\t_initial_origin: \u0026OriginCaller,\n\t\t_new_delay: BlockNumber,\n\t) -\u003e DispatchResult {\n\t\tensure_root(origin)?;\n\t\tOk(())\n\t}\n\tfn check_delay_schedule(origin: Origin, initial_origin: \u0026OriginCaller) -\u003e DispatchResult {\n\t\tensure_root(origin.clone()).or_else(|_| {\n\t\t\tif origin.caller() == initial_origin {\n\t\t\t\tOk(())\n\t\t\t} else {\n\t\t\t\tErr(BadOrigin.into())\n\t\t\t}\n\t\t})\n\t}\n\tfn check_cancel_schedule(origin: Origin, initial_origin: \u0026OriginCaller) -\u003e DispatchResult {\n\t\tensure_root(origin.clone()).or_else(|_| {\n\t\t\tif origin.caller() == initial_origin {\n\t\t\t\tOk(())\n\t\t\t} else {\n\t\t\t\tErr(BadOrigin.into())\n\t\t\t}\n\t\t})\n\t}\n}\n\nimpl AsOriginId\u003cOrigin, OriginCaller\u003e for MockAsOriginId {\n\tfn into_origin(self) -\u003e OriginCaller {\n\t\tmatch self {\n\t\t\tMockAsOriginId::Root =\u003e Origin::root().caller().clone(),\n\t\t\tMockAsOriginId::Account1 =\u003e Origin::signed(1).caller().clone(),\n\t\t\tMockAsOriginId::Account2 =\u003e Origin::signed(2).caller().clone(),\n\t\t}\n\t}\n\tfn check_dispatch_from(\u0026self, origin: Origin) -\u003e DispatchResult {\n\t\tensure_root(origin.clone()).or_else(|_| {\n\t\t\tif let OriginCaller::authority(ref sign) = origin.caller() {\n\t\t\t\tif sign.origin == Box::new(Origin::root().caller().clone()) {\n\t\t\t\t\treturn Ok(());\n\t\t\t\t} else {\n\t\t\t\t\treturn Err(BadOrigin.into());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet ok = match self {\n\t\t\t\tMockAsOriginId::Root =\u003e false,\n\t\t\t\tMockAsOriginId::Account1 =\u003e ensure_signed(origin)? == 1,\n\t\t\t\tMockAsOriginId::Account2 =\u003e ensure_signed(origin)? == 2,\n\t\t\t};\n\t\t\treturn if ok { Ok(()) } else { Err(BadOrigin.into()) };\n\t\t})\n\t}\n}\n\nimpl Trait for Runtime {\n\ttype Event = Event;\n\ttype Origin = Origin;\n\ttype PalletsOrigin = OriginCaller;\n\ttype Scheduler = Scheduler;\n\ttype Call = Call;\n\ttype AsOriginId = MockAsOriginId;\n\ttype AuthorityConfig = AuthorityConfigImpl;\n\ttype WeightInfo = ();\n}\n\npub type Block = sp_runtime::generic::Block\u003cHeader, UncheckedExtrinsic\u003e;\npub type UncheckedExtrinsic = sp_runtime::generic::UncheckedExtrinsic\u003cu32, u64, u64, ()\u003e;\n\nframe_support::construct_runtime!(\n\tpub enum Runtime where\n\t\tBlock = Block,\n\t\tNodeBlock = Block,\n\t\tUncheckedExtrinsic = UncheckedExtrinsic\n\t{\n\t\tSystem: frame_system::{Module, Call, Event\u003cT\u003e},\n\t\tAuthority: authority::{Module, Call, Origin\u003cT\u003e, Event\u003cT\u003e},\n\t\tScheduler: pallet_scheduler::{Module, Call, Storage, Event\u003cT\u003e},\n\t}\n);\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n\npub fn run_to_block(n: u64) {\n\twhile System::block_number() \u003c n {\n\t\tScheduler::on_finalize(System::block_number());\n\t\tSystem::set_block_number(System::block_number() + 1);\n\t\tScheduler::on_initialize(System::block_number());\n\t}\n}\n","traces":[{"line":27,"address":[4263009],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[4377044],"length":1,"stats":{"Line":3},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":83,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":85,"address":[4261045],"length":1,"stats":{"Line":3},"fn_name":null},{"line":86,"address":[4261081],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[4261128],"length":1,"stats":{"Line":3},"fn_name":null},{"line":88,"address":[4261133,4261116],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":101,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":110,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":122,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":129,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":130,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":131,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":133,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":138,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":139,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[4263920,4270487,4264021,4270336,4263904,4263824,4263845,4264341,4263952,4264708],"length":1,"stats":{"Line":53},"fn_name":"fmt"},{"line":167,"address":[4377960,4379902,4379733,4378018,4378319,4379684,4378267,4379945],"length":1,"stats":{"Line":6},"fn_name":null},{"line":168,"address":[4380172,4379128,4379981,4378686,4378358,4378416,4380030,4378638,4380217],"length":1,"stats":{"Line":12},"fn_name":null},{"line":169,"address":[4379133,4379065,4378798,4378725,4379017],"length":1,"stats":{"Line":4},"fn_name":null},{"line":176,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":177,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":183,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":187,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":191,"address":[4262800],"length":1,"stats":{"Line":3},"fn_name":"run_to_block"},{"line":192,"address":[4262814,4262926],"length":1,"stats":{"Line":6},"fn_name":null},{"line":193,"address":[4262844],"length":1,"stats":{"Line":3},"fn_name":null},{"line":194,"address":[4262864,4262928,4262958],"length":1,"stats":{"Line":3},"fn_name":null},{"line":195,"address":[4262908],"length":1,"stats":{"Line":3},"fn_name":null}],"covered":39,"coverable":50},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","authority","src","tests.rs"],"content":"//! Unit tests for the authority module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok};\nuse frame_system::RawOrigin;\nuse mock::{\n\tauthority, run_to_block, Authority, BlockNumber, Call, ExtBuilder, MockAsOriginId, Origin, OriginCaller, Runtime,\n\tSystem,\n};\nuse sp_runtime::{traits::BadOrigin, Perbill};\n\n#[test]\nfn dispatch_as_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet ensure_root_call = Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\tlet ensure_signed_call = Call::System(frame_system::Call::remark(vec![]));\n\t\tassert_ok!(Authority::dispatch_as(\n\t\t\tOrigin::root(),\n\t\t\tMockAsOriginId::Root,\n\t\t\tBox::new(ensure_root_call.clone())\n\t\t));\n\t\tassert_ok!(Authority::dispatch_as(\n\t\t\tOrigin::root(),\n\t\t\tMockAsOriginId::Account1,\n\t\t\tBox::new(ensure_signed_call.clone())\n\t\t));\n\t\tassert_noop!(\n\t\t\tAuthority::dispatch_as(\n\t\t\t\tOrigin::signed(1),\n\t\t\t\tMockAsOriginId::Root,\n\t\t\t\tBox::new(ensure_signed_call.clone())\n\t\t\t),\n\t\t\tBadOrigin,\n\t\t);\n\t\tassert_ok!(Authority::dispatch_as(\n\t\t\tOrigin::signed(1),\n\t\t\tMockAsOriginId::Account1,\n\t\t\tBox::new(ensure_signed_call.clone())\n\t\t));\n\t\tassert_noop!(\n\t\t\tAuthority::dispatch_as(\n\t\t\t\tOrigin::signed(1),\n\t\t\t\tMockAsOriginId::Account2,\n\t\t\t\tBox::new(ensure_signed_call.clone())\n\t\t\t),\n\t\t\tBadOrigin,\n\t\t);\n\t});\n}\n\n#[test]\nfn schedule_dispatch_at_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet ensure_root_call = Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\tlet call = Call::Authority(authority::Call::dispatch_as(\n\t\t\tMockAsOriginId::Root,\n\t\t\tBox::new(ensure_root_call.clone()),\n\t\t));\n\t\trun_to_block(1);\n\t\tassert_eq!(\n\t\t\tAuthority::schedule_dispatch(Origin::root(), DispatchTime::At(1), 0, true, Box::new(call.clone())),\n\t\t\tErr(Error::\u003cRuntime\u003e::FailedToSchedule.into())\n\t\t);\n\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::At(2),\n\t\t\t0,\n\t\t\ttrue,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(\n\t\t\tOriginCaller::authority(DelayedOrigin {\n\t\t\t\tdelay: 1,\n\t\t\t\torigin: Box::new(OriginCaller::system(RawOrigin::Root)),\n\t\t\t}),\n\t\t\t1,\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\trun_to_block(2);\n\t\tlet event = mock::Event::pallet_scheduler(pallet_scheduler::RawEvent::Dispatched(\n\t\t\t(2, 0),\n\t\t\tSome([1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0].to_vec()),\n\t\t\tOk(()),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\t// with_delayed_origin = false\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::At(3),\n\t\t\t0,\n\t\t\tfalse,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(OriginCaller::system(RawOrigin::Root), 2));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\trun_to_block(3);\n\t\tlet event = mock::Event::pallet_scheduler(pallet_scheduler::RawEvent::Dispatched(\n\t\t\t(3, 0),\n\t\t\tSome([0, 0, 2, 0, 0, 0].to_vec()),\n\t\t\tOk(()),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\t});\n}\n\n#[test]\nfn schedule_dispatch_after_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet ensure_root_call = Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\tlet call = Call::Authority(authority::Call::dispatch_as(\n\t\t\tMockAsOriginId::Root,\n\t\t\tBox::new(ensure_root_call.clone()),\n\t\t));\n\t\trun_to_block(1);\n\t\tassert_eq!(\n\t\t\tAuthority::schedule_dispatch(Origin::root(), DispatchTime::After(0), 0, true, Box::new(call.clone())),\n\t\t\tErr(Error::\u003cRuntime\u003e::FailedToSchedule.into())\n\t\t);\n\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::After(1),\n\t\t\t0,\n\t\t\ttrue,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(\n\t\t\tOriginCaller::authority(DelayedOrigin {\n\t\t\t\tdelay: 1,\n\t\t\t\torigin: Box::new(OriginCaller::system(RawOrigin::Root)),\n\t\t\t}),\n\t\t\t1,\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\trun_to_block(2);\n\t\tlet event = mock::Event::pallet_scheduler(pallet_scheduler::RawEvent::Dispatched(\n\t\t\t(2, 0),\n\t\t\tSome([1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0].to_vec()),\n\t\t\tOk(()),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\t// with_delayed_origin = false\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::After(1),\n\t\t\t0,\n\t\t\tfalse,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(OriginCaller::system(RawOrigin::Root), 2));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\trun_to_block(3);\n\t\tlet event = mock::Event::pallet_scheduler(pallet_scheduler::RawEvent::Dispatched(\n\t\t\t(3, 0),\n\t\t\tSome([0, 0, 2, 0, 0, 0].to_vec()),\n\t\t\tOk(()),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\t});\n}\n\n#[test]\nfn fast_track_scheduled_dispatch_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\t\t//let ensure_root_call =\n\t\t// Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\t// let ensure_signed_call = Call::System(frame_system::Call::remark(vec![]));\n\t\tassert_ok!(Authority::fast_track_scheduled_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tframe_system::RawOrigin::Root.into(),\n\t\t\t0,\n\t\t\tDispatchTime::At(4),\n\t\t));\n\t});\n}\n\n#[test]\nfn delay_scheduled_dispatch_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t//let ensure_root_call =\n\t\t// Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\t// let ensure_signed_call = Call::System(frame_system::Call::remark(vec![]));\n\t\tassert_ok!(Authority::delay_scheduled_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tframe_system::RawOrigin::Root.into(),\n\t\t\t0,\n\t\t\t5,\n\t\t));\n\t});\n}\n\n#[test]\nfn cancel_scheduled_dispatch_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet ensure_root_call = Call::System(frame_system::Call::fill_block(Perbill::one()));\n\t\tlet call = Call::Authority(authority::Call::dispatch_as(\n\t\t\tMockAsOriginId::Root,\n\t\t\tBox::new(ensure_root_call.clone()),\n\t\t));\n\t\trun_to_block(1);\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::At(2),\n\t\t\t0,\n\t\t\ttrue,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(\n\t\t\tOriginCaller::authority(DelayedOrigin {\n\t\t\t\tdelay: 1,\n\t\t\t\torigin: Box::new(OriginCaller::system(RawOrigin::Root)),\n\t\t\t}),\n\t\t\t0,\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\tlet schedule_origin = {\n\t\t\tlet origin: \u003cRuntime as Trait\u003e::Origin = From::from(Origin::root());\n\t\t\tlet origin: \u003cRuntime as Trait\u003e::Origin =\n\t\t\t\tFrom::from(DelayedOrigin::\u003cBlockNumber, \u003cRuntime as Trait\u003e::PalletsOrigin\u003e {\n\t\t\t\t\tdelay: 1,\n\t\t\t\t\torigin: Box::new(origin.caller().clone()),\n\t\t\t\t});\n\t\t\torigin\n\t\t};\n\n\t\tlet pallets_origin = schedule_origin.caller().clone();\n\t\tassert_ok!(Authority::cancel_scheduled_dispatch(Origin::root(), pallets_origin, 0));\n\t\tlet event = mock::Event::authority(RawEvent::Cancelled(\n\t\t\tOriginCaller::authority(DelayedOrigin {\n\t\t\t\tdelay: 1,\n\t\t\t\torigin: Box::new(OriginCaller::system(RawOrigin::Root)),\n\t\t\t}),\n\t\t\t0,\n\t\t));\n\t\tprintln!(\"{:?}\", System::events());\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\tassert_ok!(Authority::schedule_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tDispatchTime::At(2),\n\t\t\t0,\n\t\t\tfalse,\n\t\t\tBox::new(call.clone())\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Scheduled(OriginCaller::system(RawOrigin::Root), 1));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\n\t\tassert_ok!(Authority::cancel_scheduled_dispatch(\n\t\t\tOrigin::root(),\n\t\t\tframe_system::RawOrigin::Root.into(),\n\t\t\t1\n\t\t));\n\t\tlet event = mock::Event::authority(RawEvent::Cancelled(OriginCaller::system(RawOrigin::Root), 1));\n\t\tassert!(System::events().iter().any(|record| record.event == event));\n\t});\n}\n","traces":[{"line":15,"address":[4229813,4229808],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":16,"address":[4229902,4229840],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":17,"address":[4229924,4229847],"length":1,"stats":{"Line":2},"fn_name":null},{"line":18,"address":[4229986],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[4230249,4230308],"length":1,"stats":{"Line":2},"fn_name":null},{"line":20,"address":[4230100],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4230125],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4230157],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[4230658,4230717],"length":1,"stats":{"Line":2},"fn_name":null},{"line":25,"address":[4230542],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4230549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4230581],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4230943,4231177],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[4231114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4230979],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4230986],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4231018],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[4232373,4232432],"length":1,"stats":{"Line":2},"fn_name":null},{"line":38,"address":[4232257],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[4232264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[4232296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[4232892,4232658],"length":1,"stats":{"Line":2},"fn_name":null},{"line":43,"address":[4232829],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[4232694],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4232701],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[4232733],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4234373,4234368],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":55,"address":[4234592,4234638],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":56,"address":[4234660,4234599],"length":1,"stats":{"Line":2},"fn_name":null},{"line":57,"address":[4234843],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[4234722],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[4234746],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[4234956],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[4235401,4235270],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4234996,4238876,4234971,4235121],"length":1,"stats":{"Line":3},"fn_name":null},{"line":64,"address":[4235199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[4235878,4235960],"length":1,"stats":{"Line":2},"fn_name":null},{"line":68,"address":[4235383],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4235753],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4235801],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4236426],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4236354],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[4236186],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[4234414,4236620,4236548,4234400,4236792],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":83,"address":[4236785],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[4236919],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4236825],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[4236848],"length":1,"stats":{"Line":1},"fn_name":null},{"line":87,"address":[4236911],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[4237371,4237124,4234462,4237196,4234448],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":92,"address":[4237609,4237526],"length":1,"stats":{"Line":2},"fn_name":null},{"line":93,"address":[4237364],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4237404],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4237452],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4237817],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[4238219,4238011,4234510,4234496,4238071],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":102,"address":[4238212],"length":1,"stats":{"Line":1},"fn_name":null},{"line":103,"address":[4238346],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[4238252],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[4238275],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[4238338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[4238762,4238551,4234544,4238611,4234558],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":113,"address":[4239269,4239264],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":114,"address":[4239534,4239488],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":115,"address":[4239495,4239556],"length":1,"stats":{"Line":2},"fn_name":null},{"line":116,"address":[4239739],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[4239618],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[4239642],"length":1,"stats":{"Line":1},"fn_name":null},{"line":120,"address":[4239852],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[4240297,4240166],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[4243772,4239892,4240017,4239867],"length":1,"stats":{"Line":3},"fn_name":null},{"line":123,"address":[4240095],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[4240774,4240856],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[4240279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[4240649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[4240697],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[4241322],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[4241250],"length":1,"stats":{"Line":1},"fn_name":null},{"line":136,"address":[4241082],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[4241516,4239296,4241444,4239310,4241688],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":142,"address":[4241681],"length":1,"stats":{"Line":1},"fn_name":null},{"line":143,"address":[4241815],"length":1,"stats":{"Line":1},"fn_name":null},{"line":144,"address":[4241721],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[4241744],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[4241807],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[4239344,4239358,4242092,4242267,4242020],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":151,"address":[4242505,4242422],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[4242260],"length":1,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[4242300],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[4242348],"length":1,"stats":{"Line":1},"fn_name":null},{"line":158,"address":[4242713],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[4243115,4242967,4239406,4242907,4239392],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":161,"address":[4243108],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[4243242],"length":1,"stats":{"Line":1},"fn_name":null},{"line":163,"address":[4243148],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[4243171],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[4243234],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[4243658,4243507,4239440,4239454,4243447],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":172,"address":[4244160,4244165],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":173,"address":[4244192,4244219],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":174,"address":[4244199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[4244324,4244384],"length":1,"stats":{"Line":2},"fn_name":null},{"line":179,"address":[4244234],"length":1,"stats":{"Line":1},"fn_name":null},{"line":180,"address":[4244252],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[4244300],"length":1,"stats":{"Line":1},"fn_name":null},{"line":188,"address":[4244672,4244677],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":189,"address":[4244704,4244739],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":193,"address":[4244802,4244852,4244711],"length":1,"stats":{"Line":3},"fn_name":null},{"line":194,"address":[4244719],"length":1,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[4244754],"length":1,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[4245136,4245141],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":204,"address":[4245360,4245414],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":205,"address":[4245436,4245367],"length":1,"stats":{"Line":2},"fn_name":null},{"line":206,"address":[4245619],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[4245498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[4245522],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4245732],"length":1,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[4245979,4245897],"length":1,"stats":{"Line":2},"fn_name":null},{"line":212,"address":[4245747],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[4245772],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4245820],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[4246445],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[4246373],"length":1,"stats":{"Line":1},"fn_name":null},{"line":221,"address":[4246205],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[4245168,4245182,4246814,4246639,4246567],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":228,"address":[4246863,4246807],"length":1,"stats":{"Line":2},"fn_name":null},{"line":230,"address":[4247030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[4246878],"length":1,"stats":{"Line":1},"fn_name":null},{"line":234,"address":[4247089],"length":1,"stats":{"Line":1},"fn_name":null},{"line":237,"address":[4247160,4247216],"length":1,"stats":{"Line":2},"fn_name":null},{"line":238,"address":[4247232],"length":1,"stats":{"Line":1},"fn_name":null},{"line":239,"address":[4247782],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[4247710],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[4247542],"length":1,"stats":{"Line":1},"fn_name":null},{"line":246,"address":[4248002,4247904],"length":1,"stats":{"Line":2},"fn_name":null},{"line":247,"address":[4248356,4245230,4245216,4248124],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":249,"address":[4248514,4248606],"length":1,"stats":{"Line":2},"fn_name":null},{"line":250,"address":[4248349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[4248389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[4248437],"length":1,"stats":{"Line":1},"fn_name":null},{"line":256,"address":[4248826],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[4245278,4245264,4249020,4249231,4249080],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":259,"address":[4249323,4249379],"length":1,"stats":{"Line":2},"fn_name":null},{"line":260,"address":[4249224],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[4249264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[4249587],"length":1,"stats":{"Line":1},"fn_name":null},{"line":265,"address":[4245326,4249992,4249841,4245312,4249781],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"}],"covered":147,"coverable":147},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","benchmarking","src","lib.rs"],"content":"//! Macro for benchmarking a Substrate runtime. A fork of `frame-benchmarking`\n//! pallet.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nmod tests;\n\npub use frame_benchmarking::{\n\tbenchmarking, BenchmarkBatch, BenchmarkConfig, BenchmarkParameter, BenchmarkResults, Benchmarking,\n\tBenchmarkingSetup, TrackedStorageKey,\n};\n#[cfg(feature = \"std\")]\npub use frame_benchmarking::{Analysis, BenchmarkSelector};\npub use frame_support;\npub use paste;\n#[doc(hidden)]\npub use sp_io::storage::root as storage_root;\npub use sp_runtime::traits::Zero;\n\n/// Construct pallet benchmarks for weighing dispatchables.\n///\n/// Works around the idea of complexity parameters, named by a single letter\n/// (which is usually upper cased in complexity notation but is lower-cased for\n/// use in this macro).\n///\n/// Complexity parameters (\"parameters\") have a range which is a `u32` pair.\n/// Every time a benchmark is prepared and run, this parameter takes a concrete\n/// value within the range. There is an associated instancing block, which is a\n/// single expression that is evaluated during preparation. It may use `?`\n/// (`i.e. `return Err(...)`) to bail with a string error. Here's a\n/// few examples:\n///\n/// ```ignore\n/// // These two are equivalent:\n/// let x in 0 .. 10;\n/// let x in 0 .. 10 =\u003e ();\n/// // This one calls a setup function and might return an error (which would be terminal).\n/// let y in 0 .. 10 =\u003e setup(y)?;\n/// // This one uses a code block to do lots of stuff:\n/// let z in 0 .. 10 =\u003e {\n///   let a = z * z / 5;\n///   let b = do_something(a)?;\n///   combine_into(z, b);\n/// }\n/// ```\n///\n/// Note that due to parsing restrictions, if the `from` expression is not a\n/// single token (i.e. a literal or constant), then it must be parenthesised.\n///\n/// The macro allows for a number of \"arms\", each representing an individual\n/// benchmark. Using the simple syntax, the associated dispatchable function\n/// maps 1:1 with the benchmark and the name of the benchmark is the same as\n/// that of the associated function. However, extended syntax allows\n/// for arbitrary expresions to be evaluated in a benchmark (including for\n/// example, `on_initialize`).\n///\n/// The macro allows for common parameters whose ranges and instancing\n/// expressions may be drawn upon (or not) by each arm. Syntax is available to\n/// allow for only the range to be drawn upon if desired, allowing an\n/// alternative instancing expression to be given.\n///\n/// Note that the ranges are *inclusive* on both sides. This is in contrast to\n/// ranges in Rust which are left-inclusive right-exclusive.\n///\n/// Each arm may also have a block of code which is run prior to any instancing\n/// and a block of code which is run afterwards. All code blocks may draw upon\n/// the specific value of each parameter at any time. Local variables are shared\n/// between the two pre- and post- code blocks, but do not leak from the\n/// interior of any instancing expressions.\n///\n/// Any common parameters that are unused in an arm do not have their instancing\n/// expressions evaluated.\n///\n/// Example:\n/// ```ignore\n/// use path_to_node_runtime::MyRuntime;\n/// use path_to_account_id::AccountId;\n/// use frame_benchmarking::account;\n/// use orml_benchmarking::runtime_benchmarks;\n///\n/// runtime_benchmarks! {\n///   // The constructed runtime struct, and the pallet to benchmark.\n///   { MyRuntime, my_pallet }\n///\n///\n///   // first dispatchable: foo; this is a user dispatchable and operates on a `u8` vector of\n///   // size `l`, which we allow to be initialized as usual.\n///   foo {\n///     let caller = account::\u003cAccountId\u003e(b\"caller\", 0, benchmarks_seed);\n///     let l = ...;\n///   }: _(Origin::Signed(caller), vec![0u8; l])\n///\n///   // second dispatchable: bar; this is a root dispatchable and accepts a `u8` vector of size\n///   // `l`. We don't want it pre-initialized like before so we override using the `=\u003e ()` notation.\n///   // In this case, we explicitly name the call using `bar` instead of `_`.\n///   bar {\n///     let l = _ .. _ =\u003e ();\n///   }: bar(Origin::Root, vec![0u8; l])\n///\n///   // third dispatchable: baz; this is a user dispatchable. It isn't dependent on length like the\n///   // other two but has its own complexity `c` that needs setting up. It uses `caller` (in the\n///   // pre-instancing block) within the code block. This is only allowed in the param instancers\n///   // of arms. Instancers of common params cannot optimistically draw upon hypothetical variables\n///   // that the arm's pre-instancing code block might have declared.\n///   baz1 {\n///     let caller = account::\u003cAccountId\u003e(b\"caller\", 0, benchmarks_seed);\n///     let c = 0 .. 10 =\u003e setup_c(\u0026caller, c);\n///   }: baz(Origin::Signed(caller))\n///\n///   // this is a second benchmark of the baz dispatchable with a different setup.\n///   baz2 {\n///     let caller = account::\u003cAccountId\u003e(b\"caller\", 0, benchmarks_seed);\n///     let c = 0 .. 10 =\u003e setup_c_in_some_other_way(\u0026caller, c);\n///   }: baz(Origin::Signed(caller))\n///\n///   // this is benchmarking some code that is not a dispatchable.\n///   populate_a_set {\n///     let x in 0 .. 10_000;\n///     let mut m = Vec::\u003cu32\u003e::new();\n///     for i in 0..x {\n///       m.insert(i);\n///     }\n///   }: { m.into_iter().collect::\u003cBTreeSet\u003e() }\n/// }\n/// ```\n///\n/// Test functions are automatically generated for each benchmark and are\n/// accessible to you when you run `cargo test`. All tests are named\n/// `test_benchmark_\u003cbenchmark_name\u003e`, expect you to pass them the Runtime\n/// Trait, and run them in a test externalities environment. The test function\n/// runs your benchmark just like a regular benchmark, but only testing at the\n/// lowest and highest values for each component. The function will return\n/// `Ok(())` if the benchmarks return no errors.\n///\n/// You can optionally add a `verify` code block at the end of a benchmark to\n/// test any final state of your benchmark in a unit test. For example:\n///\n/// ```ignore\n/// sort_vector {\n///     let x in 1 .. 10000;\n///     let mut m = Vec::\u003cu32\u003e::new();\n///     for i in (0..x).rev() {\n///         m.push(i);\n///     }\n/// }: {\n///     m.sort();\n/// } verify {\n///     ensure!(m[0] == 0, \"You forgot to sort!\")\n/// }\n/// ```\n///\n/// These `verify` blocks will not affect your benchmark results!\n///\n/// You can construct benchmark tests like so:\n///\n/// ```ignore\n/// #[test]\n/// fn test_benchmarks() {\n///   new_test_ext().execute_with(|| {\n///     assert_ok!(test_benchmark_dummy());\n///     assert_err!(test_benchmark_other_name(), \"Bad origin\");\n///     assert_ok!(test_benchmark_sort_vector());\n///     assert_err!(test_benchmark_broken_benchmark(), \"You forgot to sort!\");\n///   });\n/// }\n/// ```\n#[macro_export]\nmacro_rules! runtime_benchmarks {\n\t(\n\t\t{ $runtime:ident, $pallet:ident }\n\t\t_ {\n\t\t\t$(\n\t\t\t\tlet $common:ident in $common_from:tt .. $common_to:expr =\u003e $common_instancer:expr;\n\t\t\t)*\n\t\t}\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter!(\n\t\t\t{ }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( { $common , $common_from , $common_to , $common_instancer } )* }\n\t\t\t( )\n\t\t\t( )\n\t\t\t$( $rest )*\n\t\t);\n\t}\n}\n\n/// Same as [`benchmarks`] but for instantiable module.\n#[macro_export]\nmacro_rules! runtime_benchmarks_instance {\n\t(\n\t\t{ $runtime:ident, $pallet:ident, $instance:ident }\n\t\t_ {\n\t\t\t$(\n\t\t\t\tlet $common:ident in $common_from:tt .. $common_to:expr =\u003e $common_instancer:expr;\n\t\t\t)*\n\t\t}\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter!(\n\t\t\t{ $instance }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( { $common , $common_from , $common_to , $common_instancer } )* }\n\t\t\t( )\n\t\t\t( )\n\t\t\t$( $rest )*\n\t\t);\n\t}\n}\n\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! benchmarks_iter {\n\t// detect and extract extra tag:\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t#[extra]\n\t\t$name:ident\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* $name )\n\t\t\t$name\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// mutation arm:\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* ) // This contains $( $( { $instance } )? $name:ident )*\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: _ ( $origin:expr $( , $arg:expr )* )\n\t\tverify $postcode:block\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: $name ( $origin $( , $arg )* )\n\t\t\tverify $postcode\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// mutation arm:\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: $dispatch:ident ( $origin:expr $( , $arg:expr )* )\n\t\tverify $postcode:block\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: {\n\t\t\t\t\u003c\n\t\t\t\t\t$pallet::Call\u003c$runtime $(, $instance)? \u003e as $crate::frame_support::traits::UnfilteredDispatchable\n\t\t\t\t\u003e\n\t\t\t\t::dispatch_bypass_filter(\n\t\t\t\t\t$pallet::Call::\u003c$runtime $(, $instance)? \u003e::$dispatch($($arg),*), $origin.into()\n\t\t\t\t)?;\n\t\t\t}\n\t\t\tverify $postcode\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// iteration arm:\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: $eval:block\n\t\tverify $postcode:block\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? }\n\t\t\t$name\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t{ }\n\t\t\t{ $eval }\n\t\t\t{ $( $code )* }\n\t\t\t$postcode\n\t\t}\n\n\t\t#[cfg(test)]\n\t\t$crate::impl_benchmark_test!(\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $instance)? }\n\t\t\t$name\n\t\t);\n\n\t\t$crate::benchmarks_iter!(\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* { $( $instance )? } $name )\n\t\t\t( $( $names_extra )* )\n\t\t\t$( $rest )*\n\t\t);\n\t};\n\t// iteration-exit arm\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t) =\u003e {\n\t\t$crate::selected_benchmark!(\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $instance)? }\n\t\t\t$( $names )*\n\t\t);\n\t\t$crate::impl_benchmark!(\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $instance)? }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra ),* )\n\t\t);\n\t};\n\t// add verify block to _() format\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: _ ( $origin:expr $( , $arg:expr )* )\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: _ ( $origin $( , $arg )* )\n\t\t\tverify { }\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// add verify block to name() format\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: $dispatch:ident ( $origin:expr $( , $arg:expr )* )\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter! {\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: $dispatch ( $origin $( , $arg )* )\n\t\t\tverify { }\n\t\t\t$( $rest )*\n\t\t}\n\t};\n\t// add verify block to {} format\n\t(\n\t\t{ $( $instance:ident )? }\n\t\t$runtime:ident\n\t\t$pallet:ident\n\t\t{ $( $common:tt )* }\n\t\t( $( $names:tt )* )\n\t\t( $( $names_extra:tt )* )\n\t\t$name:ident { $( $code:tt )* }: $eval:block\n\t\t$( $rest:tt )*\n\t) =\u003e {\n\t\t$crate::benchmarks_iter!(\n\t\t\t{ $( $instance)? }\n\t\t\t$runtime\n\t\t\t$pallet\n\t\t\t{ $( $common )* }\n\t\t\t( $( $names )* )\n\t\t\t( $( $names_extra )* )\n\t\t\t$name { $( $code )* }: $eval\n\t\t\tverify { }\n\t\t\t$( $rest )*\n\t\t);\n\t};\n}\n\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! benchmark_backend {\n\t// parsing arms\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( PRE { $( $pre_parsed:tt )* } )*\n\t} { $eval:block } {\n\t\t\tlet $pre_id:tt : $pre_ty:ty = $pre_ex:expr;\n\t\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? } $name $runtime $pallet { $( $common )* } {\n\t\t\t\t$( PRE { $( $pre_parsed )* } )*\n\t\t\t\tPRE { $pre_id , $pre_ty , $pre_ex }\n\t\t\t} { $eval } { $( $rest )* } $postcode\n\t\t}\n\t};\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in ( $param_from:expr ) .. $param_to:expr =\u003e $param_instancer:expr;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? } $name $runtime $pallet { $( $common )* } {\n\t\t\t\t$( $parsed )*\n\t\t\t\tPARAM { $param , $param_from , $param_to , $param_instancer }\n\t\t\t} { $eval } { $( $rest )* } $postcode\n\t\t}\n\t};\n\t// mutation arm to look after defaulting to a common param\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( { $common:ident , $common_from:tt , $common_to:expr , $common_instancer:expr } )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in ...;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? } $name $runtime $pallet {\n\t\t\t\t$( { $common , $common_from , $common_to , $common_instancer } )*\n\t\t\t} {\n\t\t\t\t$( $parsed )*\n\t\t\t} { $eval } {\n\t\t\t\tlet $param\n\t\t\t\t\tin ({ $( let $common = $common_from; )* $param })\n\t\t\t\t\t.. ({ $( let $common = $common_to; )* $param })\n\t\t\t\t\t=\u003e ({ $( let $common = || -\u003e Result\u003c(), \u0026'static str\u003e { $common_instancer ; Ok(()) }; )* $param()? });\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// mutation arm to look after defaulting only the range to common param\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( { $common:ident , $common_from:tt , $common_to:expr , $common_instancer:expr } )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in _ .. _ =\u003e $param_instancer:expr ;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? } $name $runtime $pallet {\n\t\t\t\t$( { $common , $common_from , $common_to , $common_instancer } )*\n\t\t\t} {\n\t\t\t\t$( $parsed )*\n\t\t\t} { $eval } {\n\t\t\t\tlet $param\n\t\t\t\t\tin ({ $( let $common = $common_from; )* $param })\n\t\t\t\t\t.. ({ $( let $common = $common_to; )* $param })\n\t\t\t\t\t=\u003e $param_instancer ;\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// mutation arm to look after a single tt for param_from.\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in $param_from:tt .. $param_to:expr =\u003e $param_instancer:expr ;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? }\n\t\t\t$name $runtime $pallet { $( $common )* } { $( $parsed )* } { $eval } {\n\t\t\t\tlet $param in ( $param_from ) .. $param_to =\u003e $param_instancer;\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// mutation arm to look after the default tail of `=\u003e ()`\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $param:ident in $param_from:tt .. $param_to:expr;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? }\n\t\t\t$name $runtime $pallet { $( $common )* } { $( $parsed )* } { $eval } {\n\t\t\t\tlet $param in $param_from .. $param_to =\u003e ();\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// mutation arm to look after `let _ =`\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( $common:tt )*\n\t} {\n\t\t$( $parsed:tt )*\n\t} { $eval:block } {\n\t\tlet $pre_id:tt = $pre_ex:expr;\n\t\t$( $rest:tt )*\n\t} $postcode:block) =\u003e {\n\t\t$crate::benchmark_backend! {\n\t\t\t{ $( $instance)? }\n\t\t\t$name $runtime $pallet { $( $common )* } { $( $parsed )* } { $eval } {\n\t\t\t\tlet $pre_id : _ = $pre_ex;\n\t\t\t\t$( $rest )*\n\t\t\t} $postcode\n\t\t}\n\t};\n\t// actioning arm\n\t( { $( $instance:ident )? } $name:ident $runtime:ident $pallet:ident {\n\t\t$( { $common:ident , $common_from:tt , $common_to:expr , $common_instancer:expr } )*\n\t} {\n\t\t$( PRE { $pre_id:tt , $pre_ty:ty , $pre_ex:expr } )*\n\t\t$( PARAM { $param:ident , $param_from:expr , $param_to:expr , $param_instancer:expr } )*\n\t} { $eval:block } { $( $post:tt )* } $postcode:block) =\u003e {\n\t\t#[allow(non_camel_case_types)]\n\t\tstruct $name;\n\t\t#[allow(unused_variables)]\n\t\timpl $crate::BenchmarkingSetup\u003c$runtime $(, $instance)?\u003e for $name {\n\t\t\tfn components(\u0026self) -\u003e Vec\u003c($crate::BenchmarkParameter, u32, u32)\u003e {\n\t\t\t\tvec! [\n\t\t\t\t\t$(\n\t\t\t\t\t\t($crate::BenchmarkParameter::$param, $param_from, $param_to)\n\t\t\t\t\t),*\n\t\t\t\t]\n\t\t\t}\n\n\t\t\tfn instance(\n\t\t\t\t\u0026self,\n\t\t\t\tcomponents: \u0026[($crate::BenchmarkParameter, u32)],\n\t\t\t\tverify: bool\n\t\t\t)\n\t\t\t\t-\u003e Result\u003cBox\u003cdyn FnOnce() -\u003e Result\u003c(), \u0026'static str\u003e\u003e, \u0026'static str\u003e\n\t\t\t{\n\t\t\t\t$(\n\t\t\t\t\tlet $common = $common_from;\n\t\t\t\t)*\n\t\t\t\t$(\n\t\t\t\t\t// Prepare instance\n\t\t\t\t\tlet $param = components.iter()\n\t\t\t\t\t\t.find(|\u0026c| c.0 == $crate::BenchmarkParameter::$param)\n\t\t\t\t\t\t.ok_or(\"Could not find component in benchmark preparation.\")?\n\t\t\t\t\t\t.1;\n\t\t\t\t)*\n\t\t\t\t$(\n\t\t\t\t\tlet $pre_id : $pre_ty = $pre_ex;\n\t\t\t\t)*\n\t\t\t\t$( $param_instancer ; )*\n\t\t\t\t$( $post )*\n\n\t\t\t\tOk(Box::new(move || -\u003e Result\u003c(), \u0026'static str\u003e {\n\t\t\t\t\t$eval;\n\t\t\t\t\tif verify {\n\t\t\t\t\t\t$postcode;\n\t\t\t\t\t}\n\t\t\t\t\tOk(())\n\t\t\t\t}))\n\t\t\t}\n\t\t}\n\t};\n}\n\n// Creates a `SelectedBenchmark` enum implementing `BenchmarkingSetup`.\n//\n// Every variant must implement [`BenchmarkingSetup`].\n//\n// ```nocompile\n// \n// struct Transfer;\n// impl BenchmarkingSetup for Transfer { ... }\n//\n// struct SetBalance;\n// impl BenchmarkingSetup for SetBalance { ... }\n//\n// selected_benchmark!({} Transfer {} SetBalance);\n// ```\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! selected_benchmark {\n\t(\n\t\t$runtime:ident $pallet:ident\n\t\t{ $( $instance:ident )? }\n\t\t$( { $( $bench_inst:ident )? } $bench:ident )*\n\t) =\u003e {\n\t\t// The list of available benchmarks for this pallet.\n\t\t#[allow(non_camel_case_types)]\n\t\tenum SelectedBenchmark {\n\t\t\t$( $bench, )*\n\t\t}\n\n\t\t// Allow us to select a benchmark from the list of available benchmarks.\n\t\timpl $crate::BenchmarkingSetup\u003c$runtime $(, $instance)?\u003e for SelectedBenchmark {\n\t\t\tfn components(\u0026self) -\u003e Vec\u003c($crate::BenchmarkParameter, u32, u32)\u003e {\n\t\t\t\tmatch self {\n\t\t\t\t\t$(\n\t\t\t\t\t\tSelf::$bench =\u003e \u003c\n\t\t\t\t\t\t\t$bench as $crate::BenchmarkingSetup\u003c$runtime $(, $bench_inst)? \u003e\n\t\t\t\t\t\t\u003e::components(\u0026$bench),\n\t\t\t\t\t)*\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfn instance(\n\t\t\t\t\u0026self,\n\t\t\t\tcomponents: \u0026[($crate::BenchmarkParameter, u32)],\n\t\t\t\tverify: bool\n\t\t\t)\n\t\t\t\t-\u003e Result\u003cBox\u003cdyn FnOnce() -\u003e Result\u003c(), \u0026'static str\u003e\u003e, \u0026'static str\u003e\n\t\t\t{\n\t\t\t\tmatch self {\n\t\t\t\t\t$(\n\t\t\t\t\t\tSelf::$bench =\u003e \u003c\n\t\t\t\t\t\t\t$bench as $crate::BenchmarkingSetup\u003c$runtime $(, $bench_inst)? \u003e\n\t\t\t\t\t\t\u003e::instance(\u0026$bench, components, verify),\n\t\t\t\t\t)*\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}\n\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! impl_benchmark {\n\t(\n\t\t$runtime:ident $pallet:ident\n\t\t{ $( $instance:ident )? }\n\t\t( $( { $( $name_inst:ident )? } $name:ident )* )\n\t\t( $( $name_extra:ident ),* )\n\t) =\u003e {\n\t\t#[cfg(feature=\"runtime-benchmarks\")]\n\t\tpub struct Benchmark;\n\n\t\t#[cfg(feature=\"runtime-benchmarks\")]\n\t\timpl $crate::Benchmarking\u003c$crate::BenchmarkResults\u003e for Benchmark {\n\t\t\tfn benchmarks(extra: bool) -\u003e Vec\u003c\u0026'static [u8]\u003e {\n\t\t\t\tlet mut all = vec![ $( stringify!($name).as_ref() ),* ];\n\t\t\t\tif !extra {\n\t\t\t\t\tlet extra = [ $( stringify!($name_extra).as_ref() ),* ];\n\t\t\t\t\tall.retain(|x| !extra.contains(x));\n\t\t\t\t}\n\t\t\t\tall\n\t\t\t}\n\n\t\t\tfn run_benchmark(\n\t\t\t\textrinsic: \u0026[u8],\n\t\t\t\tlowest_range_values: \u0026[u32],\n\t\t\t\thighest_range_values: \u0026[u32],\n\t\t\t\tsteps: \u0026[u32],\n\t\t\t\trepeat: u32,\n\t\t\t\twhitelist: \u0026[$crate::TrackedStorageKey],\n\t\t\t\tverify: bool,\n\t\t\t) -\u003e Result\u003cVec\u003c$crate::BenchmarkResults\u003e, \u0026'static str\u003e {\n\t\t\t\t// Map the input to the selected benchmark.\n\t\t\t\tlet extrinsic = sp_std::str::from_utf8(extrinsic)\n\t\t\t\t\t.map_err(|_| \"`extrinsic` is not a valid utf8 string!\")?;\n\t\t\t\tlet selected_benchmark = match extrinsic {\n\t\t\t\t\t$( stringify!($name) =\u003e SelectedBenchmark::$name, )*\n\t\t\t\t\t_ =\u003e return Err(\"Could not find extrinsic.\"),\n\t\t\t\t};\n\n\t\t\t\tlet mut results: Vec\u003c$crate::BenchmarkResults\u003e = Vec::new();\n\t\t\t\tif repeat == 0 {\n\t\t\t\t\treturn Ok(results);\n\t\t\t\t}\n\n\t\t\t\t// Add whitelist to DB\n\t\t\t\t$crate::benchmarking::set_whitelist(whitelist.to_vec());\n\n\t\t\t\t// Warm up the DB\n\t\t\t\t$crate::benchmarking::commit_db();\n\t\t\t\t$crate::benchmarking::wipe_db();\n\n\t\t\t\tlet components = \u003c\n\t\t\t\t\tSelectedBenchmark as $crate::BenchmarkingSetup\u003c$runtime $(, $instance)?\u003e\n\t\t\t\t\u003e::components(\u0026selected_benchmark);\n\n\t\t\t\t// Default number of steps for a component.\n\t\t\t\tlet mut prev_steps = 10;\n\n\t\t\t\tlet repeat_benchmark = |\n\t\t\t\t\trepeat: u32,\n\t\t\t\t\tc: \u0026[($crate::BenchmarkParameter, u32)],\n\t\t\t\t\tresults: \u0026mut Vec\u003c$crate::BenchmarkResults\u003e,\n\t\t\t\t\tverify: bool,\n\t\t\t\t| -\u003e Result\u003c(), \u0026'static str\u003e {\n\t\t\t\t\t// Run the benchmark `repeat` times.\n\t\t\t\t\tfor _ in 0..repeat {\n\t\t\t\t\t\t// Set up the externalities environment for the setup we want to\n\t\t\t\t\t\t// benchmark.\n\t\t\t\t\t\tlet closure_to_benchmark = \u003c\n\t\t\t\t\t\t\tSelectedBenchmark as $crate::BenchmarkingSetup\u003c$runtime $(, $instance)?\u003e\n\t\t\t\t\t\t\u003e::instance(\u0026selected_benchmark, c, verify)?;\n\n\t\t\t\t\t\t// Set the block number to at least 1 so events are deposited.\n\t\t\t\t\t\tif $crate::Zero::is_zero(\u0026frame_system::Module::\u003c$runtime\u003e::block_number()) {\n\t\t\t\t\t\t\tframe_system::Module::\u003c$runtime\u003e::set_block_number(1u8.into());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Commit the externalities to the database, flushing the DB cache.\n\t\t\t\t\t\t// This will enable worst case scenario for reading from the database.\n\t\t\t\t\t\t$crate::benchmarking::commit_db();\n\n\t\t\t\t\t\t// Reset the read/write counter so we don't count operations in the setup process.\n\t\t\t\t\t\t$crate::benchmarking::reset_read_write_count();\n\n\t\t\t\t\t\tif verify {\n\t\t\t\t\t\t\tclosure_to_benchmark()?;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Time the extrinsic logic.\n\t\t\t\t\t\t\tframe_support::debug::trace!(\n\t\t\t\t\t\t\t\ttarget: \"benchmark\",\n\t\t\t\t\t\t\t\t\"Start Benchmark: {:?}\", c\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tlet start_extrinsic = $crate::benchmarking::current_time();\n\t\t\t\t\t\t\tclosure_to_benchmark()?;\n\t\t\t\t\t\t\tlet finish_extrinsic = $crate::benchmarking::current_time();\n\t\t\t\t\t\t\tlet elapsed_extrinsic = finish_extrinsic - start_extrinsic;\n\t\t\t\t\t\t\t// Commit the changes to get proper write count\n\t\t\t\t\t\t\t$crate::benchmarking::commit_db();\n\t\t\t\t\t\t\tframe_support::debug::trace!(\n\t\t\t\t\t\t\t\ttarget: \"benchmark\",\n\t\t\t\t\t\t\t\t\"End Benchmark: {} ns\", elapsed_extrinsic\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tlet read_write_count = $crate::benchmarking::read_write_count();\n\t\t\t\t\t\t\tframe_support::debug::trace!(\n\t\t\t\t\t\t\t\ttarget: \"benchmark\",\n\t\t\t\t\t\t\t\t\"Read/Write Count {:?}\", read_write_count\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t// Time the storage root recalculation.\n\t\t\t\t\t\t\tlet start_storage_root = $crate::benchmarking::current_time();\n\t\t\t\t\t\t\t$crate::storage_root();\n\t\t\t\t\t\t\tlet finish_storage_root = $crate::benchmarking::current_time();\n\t\t\t\t\t\t\tlet elapsed_storage_root = finish_storage_root - start_storage_root;\n\n\t\t\t\t\t\t\tresults.push($crate::BenchmarkResults {\n\t\t\t\t\t\t\t\tcomponents: c.to_vec(),\n\t\t\t\t\t\t\t\textrinsic_time: elapsed_extrinsic,\n\t\t\t\t\t\t\t\tstorage_root_time: elapsed_storage_root,\n\t\t\t\t\t\t\t\treads: read_write_count.0,\n\t\t\t\t\t\t\t\trepeat_reads: read_write_count.1,\n\t\t\t\t\t\t\t\twrites: read_write_count.2,\n\t\t\t\t\t\t\t\trepeat_writes: read_write_count.3,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Wipe the DB back to the genesis state.\n\t\t\t\t\t\t$crate::benchmarking::wipe_db();\n\t\t\t\t\t}\n\n\t\t\t\t\tOk(())\n\t\t\t\t};\n\n\t\t\t\tif components.is_empty() {\n\t\t\t\t\tif verify {\n\t\t\t\t\t\t// If `--verify` is used, run the benchmark once to verify it would complete.\n\t\t\t\t\t\trepeat_benchmark(repeat, Default::default(), \u0026mut Vec::new(), true)?;\n\t\t\t\t\t}\n\t\t\t\t\trepeat_benchmark(repeat, Default::default(), \u0026mut results, false)?;\n\t\t\t\t} else {\n\t\t\t\t\t// Select the component we will be benchmarking. Each component will be benchmarked.\n\t\t\t\t\tfor (idx, (name, low, high)) in components.iter().enumerate() {\n\t\t\t\t\t\t// Get the number of steps for this component.\n\t\t\t\t\t\tlet steps = steps.get(idx).cloned().unwrap_or(prev_steps);\n\t\t\t\t\t\tprev_steps = steps;\n\n\t\t\t\t\t\t// Skip this loop if steps is zero\n\t\t\t\t\t\tif steps == 0 { continue }\n\n\t\t\t\t\t\tlet lowest = lowest_range_values.get(idx).cloned().unwrap_or(*low);\n\t\t\t\t\t\tlet highest = highest_range_values.get(idx).cloned().unwrap_or(*high);\n\n\t\t\t\t\t\tlet diff = highest - lowest;\n\n\t\t\t\t\t\t// Create up to `STEPS` steps for that component between high and low.\n\t\t\t\t\t\tlet step_size = (diff / steps).max(1);\n\t\t\t\t\t\tlet num_of_steps = diff / step_size + 1;\n\n\t\t\t\t\t\tfor s in 0..num_of_steps {\n\t\t\t\t\t\t\t// This is the value we will be testing for component `name`\n\t\t\t\t\t\t\tlet component_value = lowest + step_size * s;\n\n\t\t\t\t\t\t\t// Select the max value for all the other components.\n\t\t\t\t\t\t\tlet c: Vec\u003c($crate::BenchmarkParameter, u32)\u003e = components.iter()\n\t\t\t\t\t\t\t\t.enumerate()\n\t\t\t\t\t\t\t\t.map(|(idx, (n, _, h))|\n\t\t\t\t\t\t\t\t\tif n == name {\n\t\t\t\t\t\t\t\t\t\t(*n, component_value)\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t(*n, *highest_range_values.get(idx).unwrap_or(h))\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.collect();\n\n\t\t\t\t\t\t\tif verify {\n\t\t\t\t\t\t\t\t// If `--verify` is used, run the benchmark once to verify it would complete.\n\t\t\t\t\t\t\t\trepeat_benchmark(1, \u0026c, \u0026mut Vec::new(), true)?;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\trepeat_benchmark(repeat, \u0026c, \u0026mut results, false)?;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Ok(results);\n\t\t\t}\n\t\t}\n\t};\n}\n\n// This creates a unit test for one benchmark of the main benchmark macro.\n// It runs the benchmark using the `high` and `low` value for each component\n// and ensure that everything completes successfully.\n#[macro_export]\n#[doc(hidden)]\nmacro_rules! impl_benchmark_test {\n\t(\n\t\t$runtime:ident $pallet:ident\n\t\t{ $( $instance:ident )? }\n\t\t$name:ident\n\t) =\u003e {\n\t\t$crate::paste::item! {\n\t\t\tfn [\u003ctest_benchmark_ $name\u003e] () -\u003e Result\u003c(), \u0026'static str\u003e\n\t\t\t{\n\t\t\t\tlet selected_benchmark = SelectedBenchmark::$name;\n\t\t\t\tlet components = \u003c\n\t\t\t\t\tSelectedBenchmark as $crate::BenchmarkingSetup\u003c$runtime, _\u003e\n\t\t\t\t\u003e::components(\u0026selected_benchmark);\n\n\t\t\t\tlet execute_benchmark = |\n\t\t\t\t\tc: Vec\u003c($crate::BenchmarkParameter, u32)\u003e\n\t\t\t\t| -\u003e Result\u003c(), \u0026'static str\u003e {\n\t\t\t\t\t// Set up the benchmark, return execution + verification function.\n\t\t\t\t\tlet closure_to_verify = \u003c\n\t\t\t\t\t\tSelectedBenchmark as $crate::BenchmarkingSetup\u003c$runtime, _\u003e\n\t\t\t\t\t\u003e::instance(\u0026selected_benchmark, \u0026c, true)?;\n\n\t\t\t\t\t// Set the block number to at least 1 so events are deposited.\n\t\t\t\t\tif $crate::Zero::is_zero(\u0026frame_system::Module::\u003c$runtime\u003e::block_number()) {\n\t\t\t\t\t\tframe_system::Module::\u003c$runtime\u003e::set_block_number(1u8.into());\n\t\t\t\t\t}\n\n\t\t\t\t\t// Run execution + verification\n\t\t\t\t\tclosure_to_verify()?;\n\n\t\t\t\t\t// Reset the state\n\t\t\t\t\t$crate::benchmarking::wipe_db();\n\n\t\t\t\t\tOk(())\n\t\t\t\t};\n\n\t\t\t\tif components.is_empty() {\n\t\t\t\t\texecute_benchmark(Default::default())?;\n\t\t\t\t} else {\n\t\t\t\t\tfor (_, (name, low, high)) in components.iter().enumerate() {\n\t\t\t\t\t\t// Test only the low and high value, assuming values in the middle won't break\n\t\t\t\t\t\tfor component_value in vec![low, high] {\n\t\t\t\t\t\t\t// Select the max value for all the other components.\n\t\t\t\t\t\t\tlet c: Vec\u003c($crate::BenchmarkParameter, u32)\u003e = components.iter()\n\t\t\t\t\t\t\t\t.enumerate()\n\t\t\t\t\t\t\t\t.map(|(_, (n, _, h))|\n\t\t\t\t\t\t\t\t\tif n == name {\n\t\t\t\t\t\t\t\t\t\t(*n, *component_value)\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t(*n, *h)\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.collect();\n\n\t\t\t\t\t\t\texecute_benchmark(c)?;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tOk(())\n\t\t\t}\n\t\t}\n\t};\n}\n\n/// This macro adds pallet benchmarks to a `Vec\u003cBenchmarkBatch\u003e` object.\n///\n/// First create an object that holds in the input parameters for the benchmark:\n///\n/// ```ignore\n/// let params = (\u0026config, \u0026whitelist);\n/// ```\n///\n/// The `whitelist` is a parameter you pass to control the DB read/write\n/// tracking. We use a vector of [TrackedStorageKey], which is a simple struct\n/// used to set if a key has been read or written to.\n///\n/// For values that should be skipped entirely, we can just pass `key.into()`.\n/// For example:\n///\n/// ```\n/// use frame_benchmarking::TrackedStorageKey;\n/// use hex_literal;\n/// let whitelist: Vec\u003cTrackedStorageKey\u003e = vec![\n///     // Block Number\n///     hex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef702a5c1b19ab7a04f536c519aca4983ac\").to_vec().into(),\n///     // Total Issuance\n///     hex_literal::hex!(\"c2261276cc9d1f8598ea4b6a74b15c2f57c875e4cff74148e4628f264b974c80\").to_vec().into(),\n///     // Execution Phase\n///     hex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef7ff553b5a9862a516939d82b3d3d8661a\").to_vec().into(),\n///     // Event Count\n///     hex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef70a98fdbe9ce6c55837576c60c7af3850\").to_vec().into(),\n/// ];\n/// ```\n///\n/// Then define a mutable local variable to hold your `BenchmarkBatch` object:\n/// ```ignore\n/// let mut batches = Vec::\u003cBenchmarkBatch\u003e::new();\n/// ````\n///\n/// Then add the pallets you want to benchmark to this object, using their crate\n/// name and generated module struct:\n/// ```ignore\n/// add_benchmark!(params, batches, pallet_balances, Balances);\n/// add_benchmark!(params, batches, pallet_session, SessionBench::\u003cRuntime\u003e);\n/// add_benchmark!(params, batches, frame_system, SystemBench::\u003cRuntime\u003e);\n/// ...\n/// ```\n///\n/// At the end of `dispatch_benchmark`, you should return this batches object.\n#[macro_export]\nmacro_rules! add_benchmark {\n\t( $params:ident, $batches:ident, $name:ident, $( $location:tt )* ) =\u003e (\n\t\tlet name_string = stringify!($name).as_bytes();\n\t\tlet (config, whitelist) = $params;\n\t\tlet $crate::BenchmarkConfig {\n\t\t\tpallet,\n\t\t\tbenchmark,\n\t\t\tlowest_range_values,\n\t\t\thighest_range_values,\n\t\t\tsteps,\n\t\t\trepeat,\n\t\t\tverify,\n\t\t\textra,\n\t\t} = config;\n\t\tif \u0026pallet[..] == \u0026name_string[..] || \u0026pallet[..] == \u0026b\"*\"[..] {\n\t\t\tif \u0026pallet[..] == \u0026b\"*\"[..] || \u0026benchmark[..] == \u0026b\"*\"[..] {\n\t\t\t\tfor benchmark in $( $location )*::Benchmark::benchmarks(*extra).into_iter() {\n\t\t\t\t\t$batches.push($crate::BenchmarkBatch {\n\t\t\t\t\t\tresults: $( $location )*::Benchmark::run_benchmark(\n\t\t\t\t\t\t\tbenchmark,\n\t\t\t\t\t\t\t\u0026lowest_range_values[..],\n\t\t\t\t\t\t\t\u0026highest_range_values[..],\n\t\t\t\t\t\t\t\u0026steps[..],\n\t\t\t\t\t\t\t*repeat,\n\t\t\t\t\t\t\twhitelist,\n\t\t\t\t\t\t\t*verify,\n\t\t\t\t\t\t)?,\n\t\t\t\t\t\tpallet: name_string.to_vec(),\n\t\t\t\t\t\tbenchmark: benchmark.to_vec(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$batches.push($crate::BenchmarkBatch {\n\t\t\t\t\tresults: $( $location )*::Benchmark::run_benchmark(\n\t\t\t\t\t\t\u0026benchmark[..],\n\t\t\t\t\t\t\u0026lowest_range_values[..],\n\t\t\t\t\t\t\u0026highest_range_values[..],\n\t\t\t\t\t\t\u0026steps[..],\n\t\t\t\t\t\t*repeat,\n\t\t\t\t\t\twhitelist,\n\t\t\t\t\t\t*verify\n\t\t\t\t\t)?,\n\t\t\t\t\tpallet: name_string.to_vec(),\n\t\t\t\t\tbenchmark: benchmark.clone(),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t)\n}\n","traces":[{"line":483,"address":[4974976,4977033,4980000,4980009,4977024,4974985],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}"},{"line":573,"address":[4317312,4312176,4309632,4314656,4319856],"length":1,"stats":{"Line":5},"fn_name":"components"},{"line":574,"address":[4312261,4319868,4314724,4317397,4309717,4309644,4319924,4314668,4317324,4312188],"length":1,"stats":{"Line":10},"fn_name":null},{"line":576,"address":[4314698,4317376,4317355,4309675,4312240,4312219,4309696,4319898],"length":1,"stats":{"Line":8},"fn_name":null},{"line":581,"address":[4312320,4314894,4317456,4314768,4320094,4319968,4309776],"length":1,"stats":{"Line":5},"fn_name":"instance"},{"line":589,"address":[4320017,4314817],"length":1,"stats":{"Line":2},"fn_name":null},{"line":593,"address":[4314992,4317661,4309836,4314836,4317716,4317516,4312574,4320036,4320243,4320192,4312380,4312519,4309981,4315043,4310036,4314909,4320109],"length":1,"stats":{"Line":12},"fn_name":null},{"line":594,"address":[4974912,4976974,4978544,4978558,4979950,4981536,4979936,4981550,4974926,4976960],"length":1,"stats":{"Line":10},"fn_name":"{{closure}}"},{"line":595,"address":[4315123,4310038,4317718,4314978,4312660,4317802,4317644,4312505,4315045,4312576,4320178,4320245,4309964,4320323,4310122],"length":1,"stats":{"Line":5},"fn_name":null},{"line":604,"address":[4975008,4978608,4981617,4980032,4978655,4981600,4977056],"length":1,"stats":{"Line":19},"fn_name":"{{closure}}"},{"line":606,"address":[4981604,4977278,4975260,4980441,4981629,4978746,4977449,4980269,4975447,4981699,4978684,4975594],"length":1,"stats":{"Line":9},"fn_name":null},{"line":609,"address":[4980445,4975869,4977453,4978824,4981777],"length":1,"stats":{"Line":5},"fn_name":null},{"line":646,"address":[4322512],"length":1,"stats":{"Line":2},"fn_name":"components"},{"line":647,"address":[4322653,4322675,4322609,4322587,4322631],"length":1,"stats":{"Line":4},"fn_name":null},{"line":649,"address":[4322667,4322524,4322645,4322601,4322623],"length":1,"stats":{"Line":6},"fn_name":null},{"line":656,"address":[4322704],"length":1,"stats":{"Line":1},"fn_name":"instance"},{"line":663,"address":[4323099,4322886,4322955,4323027,4323168],"length":1,"stats":{"Line":5},"fn_name":null},{"line":665,"address":[4322899,4322971,4323112,4323043,4322753],"length":1,"stats":{"Line":5},"fn_name":null},{"line":876,"address":[4318160,4312960,4320854,4315616,4310518,4318198,4315654,4310480,4320816,4312998],"length":1,"stats":{"Line":5},"fn_name":"test_benchmark_set_value"},{"line":878,"address":[4318167,4312967,4315623,4320823,4310487],"length":1,"stats":{"Line":5},"fn_name":null},{"line":879,"address":[4320831,4310495,4318175,4315631,4312975],"length":1,"stats":{"Line":5},"fn_name":null},{"line":883,"address":[4318221,4313021,4310541,4315677,4320877],"length":1,"stats":{"Line":10},"fn_name":null},{"line":887,"address":[4976143,4976007,4980719,4978879,4980479,4975903,4976072,4977727,4981982,4980583,4977630,4980648,4980622,4978983,4977591,4979119,4981839,4976046,4981943,4979048,4979022,4982008,4977656,4977487,4982079],"length":1,"stats":{"Line":20},"fn_name":null},{"line":889,"address":[4980629,4981847,4980721,4980814,4979121,4977822,4977495,4978887,4976053,4977729,4981989,4982174,4976145,4975911,4977637,4979214,4982081,4980487,4979029,4976238],"length":1,"stats":{"Line":10},"fn_name":null},{"line":892,"address":[4976401,4982064,4982337,4979377,4979305,4977913,4976128,4980704,4977712,4979104,4980905,4982265,4980977,4976329,4977985],"length":1,"stats":{"Line":15},"fn_name":null},{"line":893,"address":[4982304,4976368,4979344,4977952,4980944],"length":1,"stats":{"Line":5},"fn_name":null},{"line":897,"address":[4981111,4980979,4976535,4979511,4976655,4982591,4982471,4979379,4977987,4982339,4979631,4981231,4978239,4978119,4976403],"length":1,"stats":{"Line":7},"fn_name":null},{"line":900,"address":[4981100,4979500,4982460,4978108,4976524],"length":1,"stats":{"Line":4},"fn_name":null},{"line":902,"address":[4982596,4978244,4981236,4979636,4976660],"length":1,"stats":{"Line":4},"fn_name":null},{"line":905,"address":[4318501,4321157,4313037,4321570,4320893,4313301,4315693,4310557,4313714,4310821,4318914,4315957,4311234,4316370,4318237],"length":1,"stats":{"Line":8},"fn_name":null},{"line":906,"address":[4321337,4315769,4321269,4310826,4320969,4316137,4315962,4313306,4313481,4316069,4310933,4313413,4310633,4318613,4318681,4318506,4321162,4318313,4311001,4313113],"length":1,"stats":{"Line":2},"fn_name":null},{"line":908,"address":[4316375,4317230,4318699,4321355,4316155,4311239,4311019,4318919,4313719,4319774,4310607,4315743,4312094,4313499,4321575,4320943,4313087,4318287,4314574,4322430],"length":1,"stats":{"Line":13},"fn_name":null},{"line":910,"address":[4314435,4311955,4319202,4319253,4321858,4319635,4314002,4317091,4316658,4311347,4311522,4319027,4311573,4321909,4313827,4322291,4316483,4314053,4316709,4321683],"length":1,"stats":{"Line":14},"fn_name":null},{"line":912,"address":[4314095,4321951,4314196,4319396,4319295,4316852,4316751,4311615,4311716,4322052],"length":1,"stats":{"Line":10},"fn_name":null},{"line":914,"address":[4322028,4311692,4316828,4314172,4319372],"length":1,"stats":{"Line":15},"fn_name":null},{"line":915,"address":[4976845,4978491,4979821,4981421,4981483,4978429,4982843,4976907,4979883,4982781],"length":1,"stats":{"Line":5},"fn_name":null},{"line":916,"address":[4981485,4976909,4982845,4978493,4979885],"length":1,"stats":{"Line":5},"fn_name":null},{"line":918,"address":[4981461,4982821,4978469,4976885,4979861],"length":1,"stats":{"Line":0},"fn_name":null},{"line":923,"address":[4314440,4317096,4319458,4322114,4319640,4319769,4314258,4316914,4312089,4317225,4322296,4322425,4314569,4311778,4311960],"length":1,"stats":{"Line":7},"fn_name":null},{"line":927,"address":[4322435,4314579,4319779,4312099,4317235],"length":1,"stats":{"Line":3},"fn_name":null}],"covered":39,"coverable":40},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","benchmarking","src","tests.rs"],"content":"//! Tests for the module.\n\n#![cfg(test)]\n\nuse super::*;\nuse codec::Decode;\nuse frame_benchmarking::account;\nuse frame_support::{\n\tassert_err, assert_ok, decl_module, decl_storage, dispatch::DispatchResult, ensure, impl_outer_origin,\n};\nuse frame_system::{ensure_none, ensure_signed, RawOrigin};\nuse sp_runtime::{\n\ttesting::{Header, H256},\n\ttraits::{BlakeTwo256, IdentityLookup},\n};\nuse sp_std::prelude::*;\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Test {\n\t\tValue get(fn value): Option\u003cu32\u003e;\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\t#[weight = 0]\n\t\tfn set_value(origin, n: u32) -\u003e DispatchResult {\n\t\t\tlet _sender = ensure_signed(origin)?;\n\t\t\tValue::put(n);\n\t\t\tOk(())\n\t\t}\n\n\t\t#[weight = 0]\n\t\tfn dummy(origin, _n: u32) -\u003e DispatchResult {\n\t\t\tlet _sender = ensure_none(origin)?;\n\t\t\tOk(())\n\t\t}\n\t}\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\npub trait Trait {\n\ttype Event;\n\ttype BlockNumber;\n\ttype AccountId: 'static + Default + Decode;\n\ttype Origin: From\u003cframe_system::RawOrigin\u003cSelf::AccountId\u003e\u003e + Into\u003cResult\u003cRawOrigin\u003cSelf::AccountId\u003e, Self::Origin\u003e\u003e;\n}\n\ntype AccountId = u128;\n\n#[derive(Clone, Eq, PartialEq)]\npub struct Test;\n\nimpl frame_system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Call = ();\n\ttype Hashing = BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = ();\n\ttype BlockHashCount = ();\n\ttype MaximumBlockWeight = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = ();\n\ttype AvailableBlockRatio = ();\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nimpl Trait for Test {\n\ttype Event = ();\n\ttype BlockNumber = u32;\n\ttype Origin = Origin;\n\ttype AccountId = u128;\n}\n\n// This function basically just builds a genesis storage key/value store\n// according to our desired mockup.\nfn new_test_ext() -\u003e sp_io::TestExternalities {\n\tframe_system::GenesisConfig::default()\n\t\t.build_storage::\u003cTest\u003e()\n\t\t.unwrap()\n\t\t.into()\n}\n\nruntime_benchmarks! {\n\t{ Test, self }\n\n\t_ {\n\t\t// Define a common range for `b`.\n\t\tlet b in 1 .. 1000 =\u003e ();\n\t}\n\n\tset_value {\n\t\tlet b in ...;\n\t\tlet caller = account::\u003cAccountId\u003e(\"caller\", 0, 0);\n\t}: _ (RawOrigin::Signed(caller), b.into())\n\tverify {\n\t\tassert_eq!(Value::get(), Some(b));\n\t}\n\n\tother_name {\n\t\tlet b in ...;\n\t}: dummy (RawOrigin::None, b.into())\n\n\tsort_vector {\n\t\tlet x in 1 .. 10000;\n\t\tlet mut m = Vec::\u003cu32\u003e::new();\n\t\tfor i in (0..x).rev() {\n\t\t\tm.push(i);\n\t\t}\n\t}: {\n\t\tm.sort();\n\t} verify {\n\t\tensure!(m[0] == 0, \"You forgot to sort!\")\n\t}\n\n\tbad_origin {\n\t\tlet b in ...;\n\t\tlet caller = account::\u003cAccountId\u003e(\"caller\", 0, 0);\n\t}: dummy (RawOrigin::Signed(caller), b.into())\n\n\tbad_verify {\n\t\tlet x in 1 .. 10000;\n\t\tlet mut m = Vec::\u003cu32\u003e::new();\n\t\tfor i in (0..x).rev() {\n\t\t\tm.push(i);\n\t\t}\n\t}: { }\n\tverify {\n\t\tensure!(m[0] == 0, \"You forgot to sort!\")\n\t}\n}\n\n#[test]\nfn benchmarks_macro_works() {\n\t// Check benchmark creation for `set_value`.\n\tlet selected_benchmark = SelectedBenchmark::set_value;\n\n\tlet components = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::components(\u0026selected_benchmark);\n\tassert_eq!(components, vec![(BenchmarkParameter::b, 1, 1000)]);\n\n\tlet closure = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\n\t\t\u0026selected_benchmark,\n\t\t\u0026[(BenchmarkParameter::b, 1)],\n\t\ttrue,\n\t)\n\t.expect(\"failed to create closure\");\n\n\tnew_test_ext().execute_with(|| {\n\t\tassert_eq!(closure(), Ok(()));\n\t});\n}\n\n#[test]\nfn benchmarks_macro_rename_works() {\n\t// Check benchmark creation for `other_dummy`.\n\tlet selected_benchmark = SelectedBenchmark::other_name;\n\tlet components = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::components(\u0026selected_benchmark);\n\tassert_eq!(components, vec![(BenchmarkParameter::b, 1, 1000)]);\n\n\tlet closure = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\n\t\t\u0026selected_benchmark,\n\t\t\u0026[(BenchmarkParameter::b, 1)],\n\t\ttrue,\n\t)\n\t.expect(\"failed to create closure\");\n\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(closure());\n\t});\n}\n\n#[test]\nfn benchmarks_macro_works_for_non_dispatchable() {\n\tlet selected_benchmark = SelectedBenchmark::sort_vector;\n\n\tlet components = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::components(\u0026selected_benchmark);\n\tassert_eq!(components, vec![(BenchmarkParameter::x, 1, 10000)]);\n\n\tlet closure = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\n\t\t\u0026selected_benchmark,\n\t\t\u0026[(BenchmarkParameter::x, 1)],\n\t\ttrue,\n\t)\n\t.expect(\"failed to create closure\");\n\n\tassert_eq!(closure(), Ok(()));\n}\n\n#[test]\nfn benchmarks_macro_verify_works() {\n\t// Check postcondition for benchmark `set_value` is valid.\n\tlet selected_benchmark = SelectedBenchmark::set_value;\n\n\tlet closure = \u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\n\t\t\u0026selected_benchmark,\n\t\t\u0026[(BenchmarkParameter::b, 1)],\n\t\ttrue,\n\t)\n\t.expect(\"failed to create closure\");\n\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(closure());\n\t});\n\n\t// Check postcondition for benchmark `bad_verify` is invalid.\n\tlet selected = SelectedBenchmark::bad_verify;\n\n\tlet closure =\n\t\t\u003cSelectedBenchmark as BenchmarkingSetup\u003cTest\u003e\u003e::instance(\u0026selected, \u0026[(BenchmarkParameter::x, 10000)], true)\n\t\t\t.expect(\"failed to create closure\");\n\n\tnew_test_ext().execute_with(|| {\n\t\tassert_err!(closure(), \"You forgot to sort!\");\n\t});\n}\n\n#[test]\nfn benchmarks_generate_unit_tests() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(test_benchmark_set_value());\n\t\tassert_ok!(test_benchmark_other_name());\n\t\tassert_ok!(test_benchmark_sort_vector());\n\t\tassert_err!(test_benchmark_bad_origin(), \"Bad origin\");\n\t\tassert_err!(test_benchmark_bad_verify(), \"You forgot to sort!\");\n\t});\n}\n","traces":[{"line":18,"address":[4969728,4969732,4969760],"length":1,"stats":{"Line":8},"fn_name":"{{closure}}"},{"line":28,"address":[4972083,4972292,4972239,4971980,4972125],"length":1,"stats":{"Line":6},"fn_name":null},{"line":29,"address":[4972232],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[4972352],"length":1,"stats":{"Line":2},"fn_name":null},{"line":35,"address":[4974489,4974392,4974539,4974311,4974431],"length":1,"stats":{"Line":4},"fn_name":null},{"line":36,"address":[4974467],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[4974853,4974784],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[4306503,4306464],"length":1,"stats":{"Line":1},"fn_name":"new_test_ext"},{"line":95,"address":[4306588,4306531,4306474],"length":1,"stats":{"Line":6},"fn_name":null},{"line":101,"address":[4312835,4317821,4310141,4317687,4312679,4317924,4310244,4312545,4310007],"length":1,"stats":{"Line":15},"fn_name":null},{"line":106,"address":[4320025,4312224,4309680,4317360,4309825,4312369,4317505,4314825],"length":1,"stats":{"Line":8},"fn_name":null},{"line":111,"address":[4310187],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[4975062,4975015],"length":1,"stats":{"Line":4},"fn_name":null},{"line":114,"address":[4975611,4975452],"length":1,"stats":{"Line":2},"fn_name":null},{"line":119,"address":[4977119,4977087],"length":1,"stats":{"Line":2},"fn_name":null},{"line":123,"address":[4315015],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[4315130,4315443,4315494],"length":1,"stats":{"Line":2},"fn_name":null},{"line":125,"address":[4315473],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[4978612],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4978695,4978797,4978748],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[4317867],"length":1,"stats":{"Line":1},"fn_name":null},{"line":136,"address":[4980039,4980086],"length":1,"stats":{"Line":2},"fn_name":null},{"line":140,"address":[4320215],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[4320693,4320642,4320330],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[4320672],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[4981634,4981750,4981701],"length":1,"stats":{"Line":3},"fn_name":null},{"line":151,"address":[4323200,4323237],"length":1,"stats":{"Line":3},"fn_name":"benchmarks_macro_works"},{"line":153,"address":[4323207],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[4323220],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[4323366,4323262],"length":1,"stats":{"Line":2},"fn_name":null},{"line":165,"address":[4323922],"length":1,"stats":{"Line":2},"fn_name":null},{"line":166,"address":[4982951,4983062],"length":1,"stats":{"Line":1},"fn_name":null},{"line":171,"address":[4324176,4324213],"length":1,"stats":{"Line":3},"fn_name":"benchmarks_macro_rename_works"},{"line":173,"address":[4324183],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[4324196],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[4324238,4324342],"length":1,"stats":{"Line":2},"fn_name":null},{"line":184,"address":[4324898],"length":1,"stats":{"Line":2},"fn_name":null},{"line":185,"address":[4983383],"length":1,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[4325152,4325190],"length":1,"stats":{"Line":3},"fn_name":"benchmarks_macro_works_for_non_dispatchable"},{"line":191,"address":[4325159],"length":1,"stats":{"Line":1},"fn_name":null},{"line":193,"address":[4325167],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[4325215,4325325],"length":1,"stats":{"Line":2},"fn_name":null},{"line":203,"address":[4326100,4325931],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[4326448,4326514],"length":1,"stats":{"Line":3},"fn_name":"benchmarks_macro_verify_works"},{"line":209,"address":[4326462],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[4326581],"length":1,"stats":{"Line":2},"fn_name":null},{"line":219,"address":[4983703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[4326677],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[4326685],"length":1,"stats":{"Line":1},"fn_name":null},{"line":229,"address":[4326810],"length":1,"stats":{"Line":2},"fn_name":null},{"line":230,"address":[4984118,4983959],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[4327104,4327121],"length":1,"stats":{"Line":3},"fn_name":"benchmarks_generate_unit_tests"},{"line":236,"address":[4327111,4327139],"length":1,"stats":{"Line":3},"fn_name":null},{"line":237,"address":[4984423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[4984692],"length":1,"stats":{"Line":1},"fn_name":null},{"line":239,"address":[4984961],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[4985461,4985230],"length":1,"stats":{"Line":1},"fn_name":null},{"line":241,"address":[4985745,4985427,4985903],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":57,"coverable":58},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","currencies","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn transfer_non_native_currency() -\u003e Weight {\n\t\t(172_011_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(5 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n\tfn transfer_native_currency() -\u003e Weight {\n\t\t(43_023_000 as Weight)\n\t}\n\tfn update_balance_non_native_currency() -\u003e Weight {\n\t\t(137_440_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(5 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n\tfn update_balance_native_currency_creating() -\u003e Weight {\n\t\t(64_432_000 as Weight)\n\t}\n\tfn update_balance_native_currency_killing() -\u003e Weight {\n\t\t(62_595_000 as Weight)\n\t}\n}\n","traces":[{"line":9,"address":[4828848],"length":1,"stats":{"Line":0},"fn_name":"transfer_non_native_currency"},{"line":10,"address":[23331326,23331398],"length":1,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[23331346],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[90082416],"length":1,"stats":{"Line":0},"fn_name":"transfer_native_currency"},{"line":15,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[4829008],"length":1,"stats":{"Line":0},"fn_name":"update_balance_non_native_currency"},{"line":18,"address":[90082478,90082550],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[23331444],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[90082498],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":14},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","currencies","src","lib.rs"],"content":"//! # Currencies Module\n//!\n//! ## Overview\n//!\n//! The currencies module provides a mixed currencies system, by configuring a\n//! native currency which implements `BasicCurrencyExtended`, and a\n//! multi-currency which implements `MultiCurrency`.\n//!\n//! It also provides an adapter, to adapt `frame_support::traits::Currency`\n//! implementations into `BasicCurrencyExtended`.\n//!\n//! The currencies module provides functionality of both `MultiCurrencyExtended`\n//! and `BasicCurrencyExtended`, via unified interfaces, and all calls would be\n//! delegated to the underlying multi-currency and base currency system.\n//! A native currency ID could be set by `Trait::GetNativeCurrencyId`, to\n//! identify the native currency.\n//!\n//! ### Implementations\n//!\n//! The currencies module provides implementations for following traits.\n//!\n//! - `MultiCurrency` - Abstraction over a fungible multi-currency system.\n//! - `MultiCurrencyExtended` - Extended `MultiCurrency` with additional helper\n//!   types and methods, like updating balance\n//! by a given signed integer amount.\n//!\n//! ## Interface\n//!\n//! ### Dispatchable Functions\n//!\n//! - `transfer` - Transfer some balance to another account, in a given\n//!   currency.\n//! - `transfer_native_currency` - Transfer some balance to another account, in\n//!   native currency set in\n//! `Trait::NativeCurrency`.\n//! - `update_balance` - Update balance by signed integer amount, in a given\n//!   currency, root origin required.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::Codec;\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage,\n\ttraits::{\n\t\tCurrency as PalletCurrency, ExistenceRequirement, Get, LockableCurrency as PalletLockableCurrency,\n\t\tReservableCurrency as PalletReservableCurrency, WithdrawReasons,\n\t},\n\tweights::Weight,\n};\nuse frame_system::{ensure_root, ensure_signed};\nuse sp_runtime::{\n\ttraits::{CheckedSub, MaybeSerializeDeserialize, StaticLookup, Zero},\n\tDispatchError, DispatchResult,\n};\nuse sp_std::{\n\tconvert::{TryFrom, TryInto},\n\tfmt::Debug,\n\tmarker, result,\n};\n\nuse orml_traits::{\n\tarithmetic::{Signed, SimpleArithmetic},\n\tBalanceStatus, BasicCurrency, BasicCurrencyExtended, BasicLockableCurrency, BasicReservableCurrency,\n\tLockIdentifier, MultiCurrency, MultiCurrencyExtended, MultiLockableCurrency, MultiReservableCurrency,\n};\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn transfer_non_native_currency() -\u003e Weight;\n\tfn transfer_native_currency() -\u003e Weight;\n\tfn update_balance_non_native_currency() -\u003e Weight;\n\tfn update_balance_native_currency_creating() -\u003e Weight;\n\tfn update_balance_native_currency_killing() -\u003e Weight;\n}\n\ntype BalanceOf\u003cT\u003e = \u003c\u003cT as Trait\u003e::MultiCurrency as MultiCurrency\u003c\u003cT as frame_system::Trait\u003e::AccountId\u003e\u003e::Balance;\ntype CurrencyIdOf\u003cT\u003e =\n\t\u003c\u003cT as Trait\u003e::MultiCurrency as MultiCurrency\u003c\u003cT as frame_system::Trait\u003e::AccountId\u003e\u003e::CurrencyId;\n\ntype AmountOf\u003cT\u003e =\n\t\u003c\u003cT as Trait\u003e::MultiCurrency as MultiCurrencyExtended\u003c\u003cT as frame_system::Trait\u003e::AccountId\u003e\u003e::Amount;\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\ttype MultiCurrency: MultiCurrencyExtended\u003cSelf::AccountId\u003e\n\t\t+ MultiLockableCurrency\u003cSelf::AccountId\u003e\n\t\t+ MultiReservableCurrency\u003cSelf::AccountId\u003e;\n\ttype NativeCurrency: BasicCurrencyExtended\u003cSelf::AccountId, Balance = BalanceOf\u003cSelf\u003e, Amount = AmountOf\u003cSelf\u003e\u003e\n\t\t+ BasicLockableCurrency\u003cSelf::AccountId, Balance = BalanceOf\u003cSelf\u003e\u003e\n\t\t+ BasicReservableCurrency\u003cSelf::AccountId, Balance = BalanceOf\u003cSelf\u003e\u003e;\n\ttype GetNativeCurrencyId: Get\u003cCurrencyIdOf\u003cSelf\u003e\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Currencies {}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\tAmount = AmountOf\u003cT\u003e,\n\t\tBalance = BalanceOf\u003cT\u003e,\n\t\tCurrencyId = CurrencyIdOf\u003cT\u003e\n\t{\n\t\t/// Currency transfer success. [currency_id, from, to, amount]\n\t\tTransferred(CurrencyId, AccountId, AccountId, Balance),\n\t\t/// Update balance success. [currency_id, who, amount]\n\t\tBalanceUpdated(CurrencyId, AccountId, Amount),\n\t\t/// Deposit success. [currency_id, who, amount]\n\t\tDeposited(CurrencyId, AccountId, Balance),\n\t\t/// Withdraw success. [currency_id, who, amount]\n\t\tWithdrawn(CurrencyId, AccountId, Balance),\n\t}\n);\n\ndecl_error! {\n\t/// Error for currencies module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Unable to convert the Amount type into Balance.\n\t\tAmountIntoBalanceFailed,\n\t\t/// Balance is too low.\n\t\tBalanceTooLow,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tconst NativeCurrencyId: CurrencyIdOf\u003cT\u003e = T::GetNativeCurrencyId::get();\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Transfer some balance to another account under `currency_id`.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::MultiCurrency is orml_tokens\n\t\t///\t\t- T::NativeCurrency is pallet_balances\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 5\n\t\t/// - Db writes: 2\n\t\t/// -------------------\n\t\t/// Base Weight:\n\t\t///\t\t- non-native currency: 90.23 µs\n\t\t///\t\t- native currency in worst case: 70 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::transfer_non_native_currency()]\n\t\tpub fn transfer(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: CurrencyIdOf\u003cT\u003e,\n\t\t\t#[compact] amount: BalanceOf\u003cT\u003e,\n\t\t) {\n\t\t\tlet from = ensure_signed(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\t\u003cSelf as MultiCurrency\u003cT::AccountId\u003e\u003e::transfer(currency_id, \u0026from, \u0026to, amount)?;\n\t\t}\n\n\t\t/// Transfer some native currency to another account.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::MultiCurrency is orml_tokens\n\t\t///\t\t- T::NativeCurrency is pallet_balances\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 2 * `Accounts`\n\t\t/// - Db writes: 2 * `Accounts`\n\t\t/// -------------------\n\t\t/// Base Weight: 70 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::transfer_native_currency()]\n\t\tpub fn transfer_native_currency(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\t#[compact] amount: BalanceOf\u003cT\u003e,\n\t\t) {\n\t\t\tlet from = ensure_signed(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\tT::NativeCurrency::transfer(\u0026from, \u0026to, amount)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Transferred(T::GetNativeCurrencyId::get(), from, to, amount));\n\t\t}\n\n\t\t/// update amount of account `who` under `currency_id`.\n\t\t///\n\t\t/// The dispatch origin of this call must be _Root_.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::MultiCurrency is orml_tokens\n\t\t///\t\t- T::NativeCurrency is pallet_balances\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads:\n\t\t/// \t- non-native currency: 5\n\t\t/// - Db writes:\n\t\t/// \t- non-native currency: 2\n\t\t/// -------------------\n\t\t/// Base Weight:\n\t\t/// \t- non-native currency: 66.24 µs\n\t\t///\t\t- native currency and killing account: 26.33 µs\n\t\t///\t\t- native currency and create account: 27.39 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::update_balance_non_native_currency()]\n\t\tpub fn update_balance(\n\t\t\torigin,\n\t\t\twho: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: CurrencyIdOf\u003cT\u003e,\n\t\t\tamount: AmountOf\u003cT\u003e,\n\t\t) {\n\t\t\tensure_root(origin)?;\n\t\t\tlet dest = T::Lookup::lookup(who)?;\n\t\t\t\u003cSelf as MultiCurrencyExtended\u003cT::AccountId\u003e\u003e::update_balance(currency_id, \u0026dest, amount)?;\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {}\n\nimpl\u003cT: Trait\u003e MultiCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype CurrencyId = CurrencyIdOf\u003cT\u003e;\n\ttype Balance = BalanceOf\u003cT\u003e;\n\n\tfn total_issuance(currency_id: Self::CurrencyId) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::total_issuance()\n\t\t} else {\n\t\t\tT::MultiCurrency::total_issuance(currency_id)\n\t\t}\n\t}\n\n\tfn total_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::total_balance(who)\n\t\t} else {\n\t\t\tT::MultiCurrency::total_balance(currency_id, who)\n\t\t}\n\t}\n\n\tfn free_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::free_balance(who)\n\t\t} else {\n\t\t\tT::MultiCurrency::free_balance(currency_id, who)\n\t\t}\n\t}\n\n\tfn ensure_can_withdraw(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::ensure_can_withdraw(who, amount)\n\t\t} else {\n\t\t\tT::MultiCurrency::ensure_can_withdraw(currency_id, who, amount)\n\t\t}\n\t}\n\n\tfn transfer(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tfrom: \u0026T::AccountId,\n\t\tto: \u0026T::AccountId,\n\t\tamount: Self::Balance,\n\t) -\u003e DispatchResult {\n\t\tif amount.is_zero() || from == to {\n\t\t\treturn Ok(());\n\t\t}\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::transfer(from, to, amount)?;\n\t\t} else {\n\t\t\tT::MultiCurrency::transfer(currency_id, from, to, amount)?;\n\t\t}\n\t\tSelf::deposit_event(RawEvent::Transferred(currency_id, from.clone(), to.clone(), amount));\n\t\tOk(())\n\t}\n\n\tfn deposit(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::deposit(who, amount)?;\n\t\t} else {\n\t\t\tT::MultiCurrency::deposit(currency_id, who, amount)?;\n\t\t}\n\t\tSelf::deposit_event(RawEvent::Deposited(currency_id, who.clone(), amount));\n\t\tOk(())\n\t}\n\n\tfn withdraw(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::withdraw(who, amount)?;\n\t\t} else {\n\t\t\tT::MultiCurrency::withdraw(currency_id, who, amount)?;\n\t\t}\n\t\tSelf::deposit_event(RawEvent::Withdrawn(currency_id, who.clone(), amount));\n\t\tOk(())\n\t}\n\n\tfn can_slash(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e bool {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::can_slash(who, amount)\n\t\t} else {\n\t\t\tT::MultiCurrency::can_slash(currency_id, who, amount)\n\t\t}\n\t}\n\n\tfn slash(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::slash(who, amount)\n\t\t} else {\n\t\t\tT::MultiCurrency::slash(currency_id, who, amount)\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiCurrencyExtended\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype Amount = AmountOf\u003cT\u003e;\n\n\tfn update_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId, by_amount: Self::Amount) -\u003e DispatchResult {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::update_balance(who, by_amount)?;\n\t\t} else {\n\t\t\tT::MultiCurrency::update_balance(currency_id, who, by_amount)?;\n\t\t}\n\t\tSelf::deposit_event(RawEvent::BalanceUpdated(currency_id, who.clone(), by_amount));\n\t\tOk(())\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiLockableCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype Moment = T::BlockNumber;\n\n\tfn set_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::set_lock(lock_id, who, amount);\n\t\t} else {\n\t\t\tT::MultiCurrency::set_lock(lock_id, currency_id, who, amount);\n\t\t}\n\t}\n\n\tfn extend_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::extend_lock(lock_id, who, amount);\n\t\t} else {\n\t\t\tT::MultiCurrency::extend_lock(lock_id, currency_id, who, amount);\n\t\t}\n\t}\n\n\tfn remove_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId) {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::remove_lock(lock_id, who);\n\t\t} else {\n\t\t\tT::MultiCurrency::remove_lock(lock_id, currency_id, who);\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiReservableCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\tfn can_reserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::can_reserve(who, value)\n\t\t} else {\n\t\t\tT::MultiCurrency::can_reserve(currency_id, who, value)\n\t\t}\n\t}\n\n\tfn slash_reserved(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::slash_reserved(who, value)\n\t\t} else {\n\t\t\tT::MultiCurrency::slash_reserved(currency_id, who, value)\n\t\t}\n\t}\n\n\tfn reserved_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::reserved_balance(who)\n\t\t} else {\n\t\t\tT::MultiCurrency::reserved_balance(currency_id, who)\n\t\t}\n\t}\n\n\tfn reserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::reserve(who, value)\n\t\t} else {\n\t\t\tT::MultiCurrency::reserve(currency_id, who, value)\n\t\t}\n\t}\n\n\tfn unreserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::unreserve(who, value)\n\t\t} else {\n\t\t\tT::MultiCurrency::unreserve(currency_id, who, value)\n\t\t}\n\t}\n\n\tfn repatriate_reserved(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tslashed: \u0026T::AccountId,\n\t\tbeneficiary: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\tif currency_id == T::GetNativeCurrencyId::get() {\n\t\t\tT::NativeCurrency::repatriate_reserved(slashed, beneficiary, value, status)\n\t\t} else {\n\t\t\tT::MultiCurrency::repatriate_reserved(currency_id, slashed, beneficiary, value, status)\n\t\t}\n\t}\n}\n\npub struct Currency\u003cT, GetCurrencyId\u003e(marker::PhantomData\u003cT\u003e, marker::PhantomData\u003cGetCurrencyId\u003e);\n\nimpl\u003cT, GetCurrencyId\u003e BasicCurrency\u003cT::AccountId\u003e for Currency\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cCurrencyIdOf\u003cT\u003e\u003e,\n{\n\ttype Balance = BalanceOf\u003cT\u003e;\n\n\tfn total_issuance() -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e\u003e::total_issuance(GetCurrencyId::get())\n\t}\n\n\tfn total_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e\u003e::total_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn free_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e\u003e::free_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn ensure_can_withdraw(who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e\u003e::ensure_can_withdraw(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn transfer(from: \u0026T::AccountId, to: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e as MultiCurrency\u003cT::AccountId\u003e\u003e::transfer(GetCurrencyId::get(), from, to, amount)\n\t}\n\n\tfn deposit(who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e\u003e::deposit(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn withdraw(who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e\u003e::withdraw(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn can_slash(who: \u0026T::AccountId, amount: Self::Balance) -\u003e bool {\n\t\t\u003cModule\u003cT\u003e\u003e::can_slash(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn slash(who: \u0026T::AccountId, amount: Self::Balance) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e\u003e::slash(GetCurrencyId::get(), who, amount)\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e BasicCurrencyExtended\u003cT::AccountId\u003e for Currency\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cCurrencyIdOf\u003cT\u003e\u003e,\n{\n\ttype Amount = AmountOf\u003cT\u003e;\n\n\tfn update_balance(who: \u0026T::AccountId, by_amount: Self::Amount) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e as MultiCurrencyExtended\u003cT::AccountId\u003e\u003e::update_balance(GetCurrencyId::get(), who, by_amount)\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e BasicLockableCurrency\u003cT::AccountId\u003e for Currency\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cCurrencyIdOf\u003cT\u003e\u003e,\n{\n\ttype Moment = T::BlockNumber;\n\n\tfn set_lock(lock_id: LockIdentifier, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\t\u003cModule\u003cT\u003e as MultiLockableCurrency\u003cT::AccountId\u003e\u003e::set_lock(lock_id, GetCurrencyId::get(), who, amount);\n\t}\n\n\tfn extend_lock(lock_id: LockIdentifier, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\t\u003cModule\u003cT\u003e as MultiLockableCurrency\u003cT::AccountId\u003e\u003e::extend_lock(lock_id, GetCurrencyId::get(), who, amount);\n\t}\n\n\tfn remove_lock(lock_id: LockIdentifier, who: \u0026T::AccountId) {\n\t\t\u003cModule\u003cT\u003e as MultiLockableCurrency\u003cT::AccountId\u003e\u003e::remove_lock(lock_id, GetCurrencyId::get(), who);\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e BasicReservableCurrency\u003cT::AccountId\u003e for Currency\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cCurrencyIdOf\u003cT\u003e\u003e,\n{\n\tfn can_reserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::can_reserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn slash_reserved(who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::slash_reserved(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn reserved_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::reserved_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn reserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::reserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn unreserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::unreserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn repatriate_reserved(\n\t\tslashed: \u0026T::AccountId,\n\t\tbeneficiary: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\t\u003cModule\u003cT\u003e as MultiReservableCurrency\u003cT::AccountId\u003e\u003e::repatriate_reserved(\n\t\t\tGetCurrencyId::get(),\n\t\t\tslashed,\n\t\t\tbeneficiary,\n\t\t\tvalue,\n\t\t\tstatus,\n\t\t)\n\t}\n}\n\npub type NativeCurrencyOf\u003cT\u003e = Currency\u003cT, \u003cT as Trait\u003e::GetNativeCurrencyId\u003e;\n\n/// Adapt other currency traits implementation to `BasicCurrency`.\npub struct BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e(marker::PhantomData\u003c(T, Currency, Amount, Moment)\u003e);\n\ntype PalletBalanceOf\u003cA, Currency\u003e = \u003cCurrency as PalletCurrency\u003cA\u003e\u003e::Balance;\n\n// Adapt `frame_support::traits::Currency`\nimpl\u003cT, AccountId, Currency, Amount, Moment\u003e BasicCurrency\u003cAccountId\u003e\n\tfor BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e\nwhere\n\tCurrency: PalletCurrency\u003cAccountId\u003e,\n\tT: Trait,\n{\n\ttype Balance = PalletBalanceOf\u003cAccountId, Currency\u003e;\n\n\tfn total_issuance() -\u003e Self::Balance {\n\t\tCurrency::total_issuance()\n\t}\n\n\tfn total_balance(who: \u0026AccountId) -\u003e Self::Balance {\n\t\tCurrency::total_balance(who)\n\t}\n\n\tfn free_balance(who: \u0026AccountId) -\u003e Self::Balance {\n\t\tCurrency::free_balance(who)\n\t}\n\n\tfn ensure_can_withdraw(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tlet new_balance = Self::free_balance(who)\n\t\t\t.checked_sub(\u0026amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::BalanceTooLow)?;\n\n\t\tCurrency::ensure_can_withdraw(who, amount, WithdrawReasons::all(), new_balance)\n\t}\n\n\tfn transfer(from: \u0026AccountId, to: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tCurrency::transfer(from, to, amount, ExistenceRequirement::AllowDeath)\n\t}\n\n\tfn deposit(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tlet _ = Currency::deposit_creating(who, amount);\n\t\tOk(())\n\t}\n\n\tfn withdraw(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tCurrency::withdraw(who, amount, WithdrawReasons::all(), ExistenceRequirement::AllowDeath).map(|_| ())\n\t}\n\n\tfn can_slash(who: \u0026AccountId, amount: Self::Balance) -\u003e bool {\n\t\tCurrency::can_slash(who, amount)\n\t}\n\n\tfn slash(who: \u0026AccountId, amount: Self::Balance) -\u003e Self::Balance {\n\t\tlet (_, gap) = Currency::slash(who, amount);\n\t\tgap\n\t}\n}\n\n// Adapt `frame_support::traits::Currency`\nimpl\u003cT, AccountId, Currency, Amount, Moment\u003e BasicCurrencyExtended\u003cAccountId\u003e\n\tfor BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e\nwhere\n\tAmount: Signed\n\t\t+ TryInto\u003cPalletBalanceOf\u003cAccountId, Currency\u003e\u003e\n\t\t+ TryFrom\u003cPalletBalanceOf\u003cAccountId, Currency\u003e\u003e\n\t\t+ SimpleArithmetic\n\t\t+ Codec\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ Default,\n\tCurrency: PalletCurrency\u003cAccountId\u003e,\n\tT: Trait,\n{\n\ttype Amount = Amount;\n\n\tfn update_balance(who: \u0026AccountId, by_amount: Self::Amount) -\u003e DispatchResult {\n\t\tlet by_balance = by_amount\n\t\t\t.abs()\n\t\t\t.try_into()\n\t\t\t.map_err(|_| Error::\u003cT\u003e::AmountIntoBalanceFailed)?;\n\t\tif by_amount.is_positive() {\n\t\t\tSelf::deposit(who, by_balance)\n\t\t} else {\n\t\t\tSelf::withdraw(who, by_balance)\n\t\t}\n\t}\n}\n\n// Adapt `frame_support::traits::LockableCurrency`\nimpl\u003cT, AccountId, Currency, Amount, Moment\u003e BasicLockableCurrency\u003cAccountId\u003e\n\tfor BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e\nwhere\n\tCurrency: PalletLockableCurrency\u003cAccountId\u003e,\n\tT: Trait,\n{\n\ttype Moment = Moment;\n\n\tfn set_lock(lock_id: LockIdentifier, who: \u0026AccountId, amount: Self::Balance) {\n\t\tCurrency::set_lock(lock_id, who, amount, WithdrawReasons::all());\n\t}\n\n\tfn extend_lock(lock_id: LockIdentifier, who: \u0026AccountId, amount: Self::Balance) {\n\t\tCurrency::extend_lock(lock_id, who, amount, WithdrawReasons::all());\n\t}\n\n\tfn remove_lock(lock_id: LockIdentifier, who: \u0026AccountId) {\n\t\tCurrency::remove_lock(lock_id, who);\n\t}\n}\n\n// Adapt `frame_support::traits::ReservableCurrency`\nimpl\u003cT, AccountId, Currency, Amount, Moment\u003e BasicReservableCurrency\u003cAccountId\u003e\n\tfor BasicCurrencyAdapter\u003cT, Currency, Amount, Moment\u003e\nwhere\n\tCurrency: PalletReservableCurrency\u003cAccountId\u003e,\n\tT: Trait,\n{\n\tfn can_reserve(who: \u0026AccountId, value: Self::Balance) -\u003e bool {\n\t\tCurrency::can_reserve(who, value)\n\t}\n\n\tfn slash_reserved(who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tlet (_, gap) = Currency::slash_reserved(who, value);\n\t\tgap\n\t}\n\n\tfn reserved_balance(who: \u0026AccountId) -\u003e Self::Balance {\n\t\tCurrency::reserved_balance(who)\n\t}\n\n\tfn reserve(who: \u0026AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\tCurrency::reserve(who, value)\n\t}\n\n\tfn unreserve(who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tCurrency::unreserve(who, value)\n\t}\n\n\tfn repatriate_reserved(\n\t\tslashed: \u0026AccountId,\n\t\tbeneficiary: \u0026AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\tCurrency::repatriate_reserved(slashed, beneficiary, value, status)\n\t}\n}\n","traces":[{"line":100,"address":[4226800],"length":1,"stats":{"Line":0},"fn_name":"encode_to\u003calloc::vec::Vec\u003cu8\u003e\u003e"},{"line":104,"address":[4603911],"length":1,"stats":{"Line":7},"fn_name":null},{"line":112,"address":[4598448,4601869,4600060,4601540,4599732,4598632],"length":1,"stats":{"Line":8},"fn_name":null},{"line":114,"address":[4600250,4600467,4602277,4602059,4598714],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[4600550,4598897,4602360,4600767,4602578],"length":1,"stats":{"Line":7},"fn_name":null},{"line":118,"address":[4602876,4599085,4602661,4601064,4598342,4600850],"length":1,"stats":{"Line":7},"fn_name":null},{"line":132,"address":[5165517,5165860,5165129,5167474,5166086,5166961,5167518,5167358,5165680,5164985,5165364,5167642,5167070,5166236,5166470,5167268,5166383,5166762,5166624,5167598,5167007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[5153510],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[5172238],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[4240129,4239928,4239782,4240075,4239885],"length":1,"stats":{"Line":6},"fn_name":null},{"line":164,"address":[4240029,4240212,4240386,4240434],"length":1,"stats":{"Line":4},"fn_name":null},{"line":165,"address":[4240492,4240460,4240606,4240379],"length":1,"stats":{"Line":4},"fn_name":null},{"line":182,"address":[5172636],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[4243006,4242963,4242860,4243217,4243164],"length":1,"stats":{"Line":3},"fn_name":null},{"line":189,"address":[4243495,4243563,4243320,4243115],"length":1,"stats":{"Line":2},"fn_name":null},{"line":190,"address":[4243647,4243488,4243603,4243775],"length":1,"stats":{"Line":2},"fn_name":null},{"line":192,"address":[4243633,4243780],"length":1,"stats":{"Line":2},"fn_name":null},{"line":214,"address":[5173095],"length":1,"stats":{"Line":0},"fn_name":null},{"line":221,"address":[4246292,4246172,4246420,4246366,4246253],"length":1,"stats":{"Line":4},"fn_name":null},{"line":222,"address":[4246498,4246665,4246320],"length":1,"stats":{"Line":2},"fn_name":null},{"line":223,"address":[4246735,4246767,4246658,4246881],"length":1,"stats":{"Line":2},"fn_name":null},{"line":234,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":235,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":236,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":242,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":243,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":251,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":252,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":258,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":259,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":272,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":273,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":275,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":276,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":280,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":281,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":284,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":285,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":286,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":289,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":293,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":294,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":297,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":298,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":299,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":302,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":304,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":306,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":307,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":310,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":311,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":319,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":320,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":322,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":330,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":331,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":332,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":334,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":336,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":337,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":344,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":345,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":346,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":352,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":353,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":354,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":356,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":360,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":361,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":362,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":364,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":370,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":371,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":372,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":374,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":378,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":379,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":380,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":382,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":386,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":387,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":388,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":390,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":394,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":395,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":396,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":398,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":402,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":403,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":404,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":406,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":410,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":417,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":418,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":420,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":434,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":435,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":438,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":439,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":442,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":443,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":446,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":447,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":450,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":451,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":454,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":455,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":458,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":459,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":462,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":463,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":466,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":467,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":478,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":479,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":490,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":491,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":494,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":495,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":498,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":499,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":508,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":509,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":512,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":513,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":516,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":517,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":520,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":521,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":524,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":525,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":528,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":535,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":536,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":537,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":538,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":539,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":560,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":561,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":564,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":565,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":568,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":569,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":572,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":573,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":574,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":575,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":577,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":580,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":581,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":584,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":585,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":586,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":589,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":590,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":593,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":594,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":597,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":598,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":599,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":621,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":622,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":625,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":626,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":627,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":629,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":643,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":644,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":647,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":648,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":651,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":652,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":663,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":664,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":667,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":668,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":669,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":672,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":673,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":676,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":677,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":680,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":681,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":684,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":690,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":108,"coverable":201},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","currencies","src","mock.rs"],"content":"//! Mocks for the currencies module.\n\n#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse pallet_balances;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse tokens;\n\nuse super::*;\n\nmod currencies {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\tcurrencies\u003cT\u003e,\n\t\ttokens\u003cT\u003e,\n\t\tpallet_balances\u003cT\u003e,\n\t}\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = pallet_balances::AccountData\u003cu64\u003e;\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\ntype CurrencyId = u32;\ntype Balance = u64;\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n}\n\nimpl pallet_balances::Trait for Runtime {\n\ttype Balance = Balance;\n\ttype DustRemoval = ();\n\ttype Event = TestEvent;\n\ttype ExistentialDeposit = ExistentialDeposit;\n\ttype AccountStore = frame_system::Module\u003cRuntime\u003e;\n\ttype MaxLocks = ();\n\ttype WeightInfo = ();\n}\n\npub type PalletBalances = pallet_balances::Module\u003cRuntime\u003e;\n\nimpl tokens::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = i64;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\npub type Tokens = tokens::Module\u003cRuntime\u003e;\n\npub const NATIVE_CURRENCY_ID: CurrencyId = 1;\npub const X_TOKEN_ID: CurrencyId = 2;\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = NATIVE_CURRENCY_ID;\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = Tokens;\n\ttype NativeCurrency = AdaptedBasicCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\npub type Currencies = Module\u003cRuntime\u003e;\npub type NativeCurrency = NativeCurrencyOf\u003cRuntime\u003e;\npub type AdaptedBasicCurrency = BasicCurrencyAdapter\u003cRuntime, PalletBalances, i64, u64\u003e;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const EVA: AccountId = 5;\npub const ID_1: LockIdentifier = *b\"1       \";\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t}\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn balances(mut self, endowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e) -\u003e Self {\n\t\tself.endowed_accounts = endowed_accounts;\n\t\tself\n\t}\n\n\tpub fn one_hundred_for_alice_n_bob(self) -\u003e Self {\n\t\tself.balances(vec![\n\t\t\t(ALICE, NATIVE_CURRENCY_ID, 100),\n\t\t\t(BOB, NATIVE_CURRENCY_ID, 100),\n\t\t\t(ALICE, X_TOKEN_ID, 100),\n\t\t\t(BOB, X_TOKEN_ID, 100),\n\t\t])\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tpallet_balances::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tbalances: self\n\t\t\t\t.endowed_accounts\n\t\t\t\t.clone()\n\t\t\t\t.into_iter()\n\t\t\t\t.filter(|(_, currency_id, _)| *currency_id == NATIVE_CURRENCY_ID)\n\t\t\t\t.map(|(account_id, _, initial_balance)| (account_id, initial_balance))\n\t\t\t\t.collect::\u003cVec\u003c_\u003e\u003e(),\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\ttokens::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self\n\t\t\t\t.endowed_accounts\n\t\t\t\t.into_iter()\n\t\t\t\t.filter(|(_, currency_id, _)| *currency_id != NATIVE_CURRENCY_ID)\n\t\t\t\t.collect::\u003cVec\u003c_\u003e\u003e(),\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[{"line":18,"address":[4371835,4371437,4371231,4372749,4371070,4371635,4371872,4370889,4372018,4372200,4372803,4372398,4372638,4372857,4371033,4371474],"length":1,"stats":{"Line":6},"fn_name":null},{"line":20,"address":[4371105,4371409,4371354,4371047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[4371509,4371810,4371758,4371451],"length":1,"stats":{"Line":2},"fn_name":null},{"line":22,"address":[4371849,4371907,4372129,4372175],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[4372287,4372506,4372552,4372214],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[4373029,4372960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[5138625],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[5130656],"length":1,"stats":{"Line":6},"fn_name":"default"},{"line":130,"address":[5130663],"length":1,"stats":{"Line":6},"fn_name":null},{"line":136,"address":[5130785,5130736],"length":1,"stats":{"Line":8},"fn_name":"balances"},{"line":137,"address":[5130797,5130838,5130743],"length":1,"stats":{"Line":16},"fn_name":null},{"line":138,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":141,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":142,"address":[5131292,5130938,5131162],"length":1,"stats":{"Line":23},"fn_name":null},{"line":143,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":144,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":145,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":146,"address":[5131115],"length":1,"stats":{"Line":8},"fn_name":null},{"line":150,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":151,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":156,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":164,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":174,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[],"length":0,"stats":{"Line":8},"fn_name":null}],"covered":18,"coverable":25},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","currencies","src","tests.rs"],"content":"//! Unit tests for the currencies module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok};\nuse mock::{\n\tAccountId, AdaptedBasicCurrency, Currencies, ExtBuilder, NativeCurrency, Origin, PalletBalances, System, TestEvent,\n\tTokens, ALICE, BOB, EVA, ID_1, NATIVE_CURRENCY_ID, X_TOKEN_ID,\n};\nuse sp_runtime::traits::BadOrigin;\n\n#[test]\nfn multi_lockable_currency_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tCurrencies::set_lock(ID_1, X_TOKEN_ID, \u0026ALICE, 50);\n\t\t\tassert_eq!(Tokens::locks(\u0026ALICE, X_TOKEN_ID).len(), 1);\n\t\t\tCurrencies::set_lock(ID_1, NATIVE_CURRENCY_ID, \u0026ALICE, 50);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 1);\n\t\t});\n}\n\n#[test]\nfn multi_reservable_currency_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Currencies::total_issuance(NATIVE_CURRENCY_ID), 200);\n\t\t\tassert_eq!(Currencies::total_issuance(X_TOKEN_ID), 200);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 100);\n\n\t\t\tassert_ok!(Currencies::reserve(X_TOKEN_ID, \u0026ALICE, 30));\n\t\t\tassert_ok!(Currencies::reserve(NATIVE_CURRENCY_ID, \u0026ALICE, 40));\n\t\t\tassert_eq!(Currencies::reserved_balance(X_TOKEN_ID, \u0026ALICE), 30);\n\t\t\tassert_eq!(Currencies::reserved_balance(NATIVE_CURRENCY_ID, \u0026ALICE), 40);\n\t\t});\n}\n\n#[test]\nfn native_currency_lockable_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tNativeCurrency::set_lock(ID_1, \u0026ALICE, 10);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 1);\n\t\t\tNativeCurrency::remove_lock(ID_1, \u0026ALICE);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 0);\n\t\t});\n}\n\n#[test]\nfn native_currency_reservable_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(NativeCurrency::reserve(\u0026ALICE, 50));\n\t\t\tassert_eq!(NativeCurrency::reserved_balance(\u0026ALICE), 50);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_lockable() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tAdaptedBasicCurrency::set_lock(ID_1, \u0026ALICE, 10);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 1);\n\t\t\tAdaptedBasicCurrency::remove_lock(ID_1, \u0026ALICE);\n\t\t\tassert_eq!(PalletBalances::locks(\u0026ALICE).len(), 0);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_reservable() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::reserve(\u0026ALICE, 50));\n\t\t\tassert_eq!(AdaptedBasicCurrency::reserved_balance(\u0026ALICE), 50);\n\t\t});\n}\n\n#[test]\nfn multi_currency_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Currencies::transfer(Some(ALICE).into(), BOB, X_TOKEN_ID, 50));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026BOB), 150);\n\t\t});\n}\n\n#[test]\nfn multi_currency_extended_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrencyExtended\u003cAccountId\u003e\u003e::update_balance(\n\t\t\t\tX_TOKEN_ID, \u0026ALICE, 50\n\t\t\t));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 150);\n\t\t});\n}\n\n#[test]\nfn native_currency_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Currencies::transfer_native_currency(Some(ALICE).into(), BOB, 50));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 50);\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026BOB), 150);\n\n\t\t\tassert_ok!(NativeCurrency::transfer(\u0026ALICE, \u0026BOB, 10));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 40);\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026BOB), 160);\n\n\t\t\tassert_eq!(Currencies::slash(NATIVE_CURRENCY_ID, \u0026ALICE, 10), 0);\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 30);\n\t\t\tassert_eq!(NativeCurrency::total_issuance(), 190);\n\t\t});\n}\n\n#[test]\nfn native_currency_extended_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(NativeCurrency::update_balance(\u0026ALICE, 10));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 110);\n\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrencyExtended\u003cAccountId\u003e\u003e::update_balance(\n\t\t\t\tNATIVE_CURRENCY_ID,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t10\n\t\t\t));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 120);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_transfer() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::transfer(\u0026ALICE, \u0026BOB, 50));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 50);\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026BOB), 150);\n\n\t\t\t// creation fee\n\t\t\tassert_ok!(AdaptedBasicCurrency::transfer(\u0026ALICE, \u0026EVA, 10));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 40);\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026EVA), 10);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_deposit() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::deposit(\u0026EVA, 50));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026EVA), 50);\n\t\t\tassert_eq!(PalletBalances::total_issuance(), 250);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_withdraw() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::withdraw(\u0026ALICE, 100));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 0);\n\t\t\tassert_eq!(PalletBalances::total_issuance(), 100);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_slash() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(AdaptedBasicCurrency::slash(\u0026ALICE, 101), 1);\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 0);\n\t\t\tassert_eq!(PalletBalances::total_issuance(), 100);\n\t\t});\n}\n\n#[test]\nfn basic_currency_adapting_pallet_balances_update_balance() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(AdaptedBasicCurrency::update_balance(\u0026ALICE, -10));\n\t\t\tassert_eq!(PalletBalances::total_balance(\u0026ALICE), 90);\n\t\t\tassert_eq!(PalletBalances::total_issuance(), 190);\n\t\t});\n}\n\n#[test]\nfn update_balance_call_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Currencies::update_balance(\n\t\t\t\tOrigin::root(),\n\t\t\t\tALICE,\n\t\t\t\tNATIVE_CURRENCY_ID,\n\t\t\t\t-10\n\t\t\t));\n\t\t\tassert_eq!(NativeCurrency::free_balance(\u0026ALICE), 90);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_ok!(Currencies::update_balance(Origin::root(), ALICE, X_TOKEN_ID, 10));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 110);\n\t\t});\n}\n\n#[test]\nfn update_balance_call_fails_if_not_root_origin() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_noop!(\n\t\t\tCurrencies::update_balance(Some(ALICE).into(), ALICE, X_TOKEN_ID, 100),\n\t\t\tBadOrigin\n\t\t);\n\t});\n}\n\n#[test]\nfn call_event_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Currencies::transfer(Some(ALICE).into(), BOB, X_TOKEN_ID, 50));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026BOB), 150);\n\n\t\t\tlet transferred_event = TestEvent::currencies(RawEvent::Transferred(X_TOKEN_ID, ALICE, BOB, 50));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrency\u003cAccountId\u003e\u003e::transfer(\n\t\t\t\tX_TOKEN_ID, \u0026ALICE, \u0026BOB, 10\n\t\t\t));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 40);\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026BOB), 160);\n\n\t\t\tlet transferred_event = TestEvent::currencies(RawEvent::Transferred(X_TOKEN_ID, ALICE, BOB, 10));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrency\u003cAccountId\u003e\u003e::deposit(\n\t\t\t\tX_TOKEN_ID, \u0026ALICE, 100\n\t\t\t));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 140);\n\n\t\t\tlet transferred_event = TestEvent::currencies(RawEvent::Deposited(X_TOKEN_ID, ALICE, 100));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\n\t\t\tassert_ok!(\u003cCurrencies as MultiCurrency\u003cAccountId\u003e\u003e::withdraw(\n\t\t\t\tX_TOKEN_ID, \u0026ALICE, 20\n\t\t\t));\n\t\t\tassert_eq!(Currencies::free_balance(X_TOKEN_ID, \u0026ALICE), 120);\n\n\t\t\tlet transferred_event = TestEvent::currencies(RawEvent::Withdrawn(X_TOKEN_ID, ALICE, 20));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\t\t});\n}\n","traces":[{"line":14,"address":[4575712,4575717],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":15,"address":[5483719,5483749],"length":1,"stats":{"Line":2},"fn_name":null},{"line":18,"address":[4575744,4575801],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":19,"address":[4575758],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4575823],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4576366],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4576414],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4576965,4576960],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":28,"address":[5483877,5483847],"length":1,"stats":{"Line":2},"fn_name":null},{"line":31,"address":[4576992],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":32,"address":[4577154,4576999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4577116,4577454,4577594],"length":1,"stats":{"Line":2},"fn_name":null},{"line":34,"address":[4577553,4577894,4578029],"length":1,"stats":{"Line":2},"fn_name":null},{"line":35,"address":[4578329,4578474,4577993],"length":1,"stats":{"Line":2},"fn_name":null},{"line":37,"address":[4578771,4578428],"length":1,"stats":{"Line":2},"fn_name":null},{"line":38,"address":[4579026],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[4579311,4579470],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[4579432,4579843,4579737],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4580117,4580112],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":46,"address":[5483975,5484005],"length":1,"stats":{"Line":2},"fn_name":null},{"line":49,"address":[4580196,4580144],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":50,"address":[4580158],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[4580218],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4580756],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[4580794],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[4581344,4581349],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":59,"address":[5484133,5484103],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[4581376],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":63,"address":[4581390],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4581760,4581631],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4582037,4582032],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":70,"address":[5484231,5484261],"length":1,"stats":{"Line":2},"fn_name":null},{"line":73,"address":[4582116,4582064],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":74,"address":[4582078],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4582138],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4582676],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[4582714],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[4583269,4583264],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":83,"address":[5484359,5484389],"length":1,"stats":{"Line":2},"fn_name":null},{"line":86,"address":[4583296],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":87,"address":[4583310],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4583551,4583680],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[4583957,4583952],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":94,"address":[5484487,5484517],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[4583984],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":98,"address":[4583991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4584524,4584365],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[4584791,4584897,4584486],"length":1,"stats":{"Line":2},"fn_name":null},{"line":105,"address":[4585173,4585168],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":106,"address":[5484645,5484615],"length":1,"stats":{"Line":2},"fn_name":null},{"line":109,"address":[4585200],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":110,"address":[4585214],"length":1,"stats":{"Line":1},"fn_name":null},{"line":113,"address":[4585460,4585594],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[4585861,4585856],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":119,"address":[5484773,5484743],"length":1,"stats":{"Line":2},"fn_name":null},{"line":122,"address":[4585888],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":123,"address":[4585895],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[4586421,4586263],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[4586385,4586721,4586871],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[4587168,4586827],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[4587423,4587581],"length":1,"stats":{"Line":1},"fn_name":null},{"line":129,"address":[4587545,4587881,4588026],"length":1,"stats":{"Line":2},"fn_name":null},{"line":131,"address":[4587980,4588326,4588461],"length":1,"stats":{"Line":2},"fn_name":null},{"line":132,"address":[4588425,4588755,4588871],"length":1,"stats":{"Line":2},"fn_name":null},{"line":133,"address":[4588841,4589244,4589138],"length":1,"stats":{"Line":2},"fn_name":null},{"line":138,"address":[4589509,4589504],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":139,"address":[5484871,5484901],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[4589536],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":143,"address":[4589550],"length":1,"stats":{"Line":1},"fn_name":null},{"line":144,"address":[4589830,4589998],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[4589952,4590277],"length":1,"stats":{"Line":2},"fn_name":null},{"line":151,"address":[4590508,4590637],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[4590917,4590912],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":157,"address":[5484999,5485029],"length":1,"stats":{"Line":2},"fn_name":null},{"line":160,"address":[4590944],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":161,"address":[4590965],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[4591248,4591406],"length":1,"stats":{"Line":1},"fn_name":null},{"line":163,"address":[4591856,4591370,4591706],"length":1,"stats":{"Line":2},"fn_name":null},{"line":166,"address":[4592153,4591812],"length":1,"stats":{"Line":2},"fn_name":null},{"line":167,"address":[4592408,4592557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":168,"address":[4592930,4592824,4592524],"length":1,"stats":{"Line":2},"fn_name":null},{"line":173,"address":[4593200,4593205],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":174,"address":[5485127,5485157],"length":1,"stats":{"Line":2},"fn_name":null},{"line":177,"address":[4593232],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":178,"address":[4593246],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[4593520,4593659],"length":1,"stats":{"Line":1},"fn_name":null},{"line":180,"address":[4594032,4593629,4593926],"length":1,"stats":{"Line":2},"fn_name":null},{"line":185,"address":[4594304,4594309],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":186,"address":[5485255,5485285],"length":1,"stats":{"Line":2},"fn_name":null},{"line":189,"address":[4594336],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":190,"address":[4594350],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[4594624,4594763],"length":1,"stats":{"Line":1},"fn_name":null},{"line":192,"address":[4595030,4594733,4595136],"length":1,"stats":{"Line":2},"fn_name":null},{"line":197,"address":[4595413,4595408],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":198,"address":[5485383,5485413],"length":1,"stats":{"Line":2},"fn_name":null},{"line":201,"address":[4595440],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":202,"address":[4595617,4595454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[4595581,4595905,4596021],"length":1,"stats":{"Line":2},"fn_name":null},{"line":204,"address":[4596394,4596288,4595991],"length":1,"stats":{"Line":2},"fn_name":null},{"line":209,"address":[4596656,4596661],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":210,"address":[5485541,5485511],"length":1,"stats":{"Line":2},"fn_name":null},{"line":213,"address":[4596688],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":214,"address":[4596702],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[4597117,4596978],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4597490,4597087,4597384],"length":1,"stats":{"Line":2},"fn_name":null},{"line":221,"address":[4597765,4597760],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":222,"address":[5485669,5485639],"length":1,"stats":{"Line":2},"fn_name":null},{"line":225,"address":[4597792],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":226,"address":[4597850],"length":1,"stats":{"Line":1},"fn_name":null},{"line":227,"address":[4597799],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[4598277,4598114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":233,"address":[4598577,4598236,4598702],"length":1,"stats":{"Line":2},"fn_name":null},{"line":234,"address":[4599014,4598669],"length":1,"stats":{"Line":2},"fn_name":null},{"line":235,"address":[4599388,4599254],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[4599648,4599653],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":241,"address":[4599703,4599680],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":242,"address":[4599864,4599687],"length":1,"stats":{"Line":2},"fn_name":null},{"line":243,"address":[4599718],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[4600917,4600912],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":251,"address":[5485925,5485895],"length":1,"stats":{"Line":2},"fn_name":null},{"line":254,"address":[4601136,4601155],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":255,"address":[4601143],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[4601170],"length":1,"stats":{"Line":1},"fn_name":null},{"line":258,"address":[4601544,4601712],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[4601671,4602273,4602012],"length":1,"stats":{"Line":2},"fn_name":null},{"line":261,"address":[4602108],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[4602240,4602574,4602817,4600958,4600944],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":264,"address":[4602851,4602788],"length":1,"stats":{"Line":2},"fn_name":null},{"line":267,"address":[4603274,4603106],"length":1,"stats":{"Line":1},"fn_name":null},{"line":268,"address":[4603233,4603835,4603574],"length":1,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[4603670],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[4604136,4603802,4601006,4600992,4604371],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":273,"address":[4604405,4604343],"length":1,"stats":{"Line":2},"fn_name":null},{"line":276,"address":[4604921,4604660],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[4604780],"length":1,"stats":{"Line":1},"fn_name":null},{"line":279,"address":[4601054,4605222,4605457,4601040,4604888],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":281,"address":[4605429,4605491],"length":1,"stats":{"Line":2},"fn_name":null},{"line":284,"address":[4605980,4605728],"length":1,"stats":{"Line":1},"fn_name":null},{"line":286,"address":[4605842],"length":1,"stats":{"Line":1},"fn_name":null},{"line":287,"address":[4606420,4601102,4601088,4605950,4606248],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"}],"covered":140,"coverable":140},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","gradually-update","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn gradually_update() -\u003e Weight {\n\t\t(57_922_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(1 as Weight))\n\t}\n\tfn cancel_gradually_update() -\u003e Weight {\n\t\t(66_687_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(1 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(1 as Weight))\n\t}\n\tfn on_finalize(u: u32) -\u003e Weight {\n\t\t(37_067_000 as Weight)\n\t\t\t.saturating_add((20_890_000 as Weight).saturating_mul(u as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":10,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":13},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","gradually-update","src","lib.rs"],"content":"//! # Gradually Update\n//! A module for scheduling gradually updates to storage values.\n//!\n//! - [`Trait`](./trait.Trait.html)\n//! - [`Call`](./enum.Call.html)\n//! - [`Module`](./struct.Module.html)\n//!\n//! ## Overview\n//!\n//! This module exposes capabilities for scheduling updates to storage values\n//! gradually. This is useful to change parameter values gradually to ensure a\n//! smooth transition. It is also possible to cancel an update before it reaches\n//! to target value.\n//!\n//! NOTE: Only unsigned integer value up to 128 bits are supported. But a\n//! \"newtype\" pattern struct that wraps an unsigned integer works too such as\n//! `Permill` and `FixedU128`.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// Disable the following two lints since they originate from an external macro (namely decl_storage)\n#![allow(clippy::string_lit_as_bytes)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, ensure, storage,\n\ttraits::{EnsureOrigin, Get},\n\tweights::Weight,\n};\nuse frame_system::ensure_root;\n\nuse sp_runtime::{traits::SaturatedConversion, DispatchResult, RuntimeDebug};\nuse sp_std::prelude::Vec;\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn gradually_update() -\u003e Weight;\n\tfn cancel_gradually_update() -\u003e Weight;\n\tfn on_finalize(u: u32) -\u003e Weight;\n}\n\ntype StorageKey = Vec\u003cu8\u003e;\ntype StorageValue = Vec\u003cu8\u003e;\n\n/// Gradually update a value stored at `key` to `target_value`,\n/// change `per_block` * `T::UpdateFrequency` per `T::UpdateFrequency` blocks.\n#[derive(Encode, Decode, Clone, Eq, PartialEq, RuntimeDebug)]\npub struct GraduallyUpdate {\n\t/// The storage key of the value to update\n\tpub key: StorageKey,\n\t/// The target value\n\tpub target_value: StorageValue,\n\t/// The amount of the value to update per one block\n\tpub per_block: StorageValue,\n}\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\t/// The frequency of updating values between blocks\n\ttype UpdateFrequency: Get\u003cSelf::BlockNumber\u003e;\n\t/// The origin that can schedule an update\n\ttype DispatchOrigin: EnsureOrigin\u003cSelf::Origin\u003e;\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as GraduallyUpdate {\n\t\t/// All the on-going updates\n\t\tpub GraduallyUpdates get(fn gradually_updates): Vec\u003cGraduallyUpdate\u003e;\n\t\t/// The last updated block number\n\t\tpub LastUpdatedAt get(fn last_updated_at): T::BlockNumber;\n\t}\n}\n\ndecl_event!(\n\t/// Event for gradually-update module.\n\tpub enum Event\u003cT\u003e where\n\t\u003cT as frame_system::Trait\u003e::BlockNumber,\n\t{\n\t\t/// Gradually update added. [key, per_block, target_value]\n\t\tGraduallyUpdateAdded(StorageKey, StorageValue, StorageValue),\n\t\t/// Gradually update cancelled. [key]\n\t\tGraduallyUpdateCancelled(StorageKey),\n\t\t/// Gradually update applied. [block_number, key, target_value]\n\t\tUpdated(BlockNumber, StorageKey, StorageValue),\n\t}\n);\n\ndecl_error! {\n\t/// Error for gradually-update module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The `per_block` or `target_value` is invalid.\n\t\tInvalidPerBlockOrTargetValue,\n\t\t/// The `target_value` is invalid.\n\t\tInvalidTargetValue,\n\t\t/// Another update is already been scheduled for this key.\n\t\tGraduallyUpdateHasExisted,\n\t\t/// No update exists to cancel.\n\t\tGraduallyUpdateNotFound,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\tconst UpdateFrequency: T::BlockNumber = T::UpdateFrequency::get();\n\n\t\t/// Add gradually_update to adjust numeric parameter.\n\t\t#[weight = T::WeightInfo::gradually_update()]\n\t\tpub fn gradually_update(origin, update: GraduallyUpdate) {\n\t\t\tT::DispatchOrigin::try_origin(origin).map(|_| ()).or_else(ensure_root)?;\n\n\t\t\t// Support max value is u128, ensure per_block and target_value \u003c= 16 bytes.\n\t\t\tensure!(update.per_block.len() == update.target_value.len() \u0026\u0026 update.per_block.len() \u003c= 16, Error::\u003cT\u003e::InvalidPerBlockOrTargetValue);\n\n\t\t\tif storage::unhashed::exists(\u0026update.key) {\n\t\t\t\tlet current_value = storage::unhashed::get::\u003cStorageValue\u003e(\u0026update.key).unwrap();\n\t\t\t\tensure!(current_value.len() == update.target_value.len(), Error::\u003cT\u003e::InvalidTargetValue);\n\t\t\t}\n\n\t\t\tGraduallyUpdates::try_mutate(|gradually_updates| -\u003e DispatchResult {\n\t\t\t\tensure!(!gradually_updates.contains(\u0026update), Error::\u003cT\u003e::GraduallyUpdateHasExisted);\n\n\t\t\t\tgradually_updates.push(update.clone());\n\n\t\t\t\tOk(())\n\t\t\t})?;\n\n\t\t\tSelf::deposit_event(RawEvent::GraduallyUpdateAdded(update.key, update.per_block, update.target_value));\n\t\t}\n\n\t\t/// Cancel gradually_update to adjust numeric parameter.\n\t\t#[weight = T::WeightInfo::cancel_gradually_update()]\n\t\tpub fn cancel_gradually_update(origin, key: StorageKey) {\n\t\t\tT::DispatchOrigin::try_origin(origin).map(|_| ()).or_else(ensure_root)?;\n\n\t\t\tGraduallyUpdates::try_mutate(|gradually_updates| -\u003e DispatchResult {\n\t\t\t\tlet old_len = gradually_updates.len();\n\t\t\t\tgradually_updates.retain(|item| item.key != key);\n\n\t\t\t\tensure!(gradually_updates.len() != old_len, Error::\u003cT\u003e::GraduallyUpdateNotFound);\n\n\t\t\t\tOk(())\n\t\t\t})?;\n\n\t\t\tSelf::deposit_event(RawEvent::GraduallyUpdateCancelled(key));\n\t\t}\n\n\t\t/// `on_initialize` to return the weight used in `on_finalize`.\n\t\tfn on_initialize() -\u003e Weight {\n\t\t\tlet now = \u003cframe_system::Module\u003cT\u003e\u003e::block_number();\n\t\t\tif Self::_need_update(now) {\n\t\t\t\tT::WeightInfo::on_finalize(GraduallyUpdates::get().len() as u32)\n\t\t\t} else {\n\t\t\t\t0\n\t\t\t}\n\t\t}\n\n\t\t/// Update gradually_update to adjust numeric parameter.\n\t\tfn on_finalize(now: T::BlockNumber) {\n\t\t\tSelf::_on_finalize(now);\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tfn _need_update(now: T::BlockNumber) -\u003e bool {\n\t\tnow \u003e= Self::last_updated_at() + T::UpdateFrequency::get()\n\t}\n\n\tfn _on_finalize(now: T::BlockNumber) {\n\t\tif !Self::_need_update(now) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet mut gradually_updates = GraduallyUpdates::get();\n\t\tlet initial_count = gradually_updates.len();\n\n\t\tgradually_updates.retain(|update| {\n\t\t\tlet mut keep = true;\n\t\t\tlet current_value = storage::unhashed::get::\u003cStorageValue\u003e(\u0026update.key).unwrap_or_default();\n\t\t\tlet current_value_u128 = u128::from_le_bytes(Self::convert_vec_to_u8(\u0026current_value));\n\n\t\t\tlet frequency_u128: u128 = T::UpdateFrequency::get().saturated_into();\n\n\t\t\tlet step = u128::from_le_bytes(Self::convert_vec_to_u8(\u0026update.per_block));\n\t\t\tlet step_u128 = step.checked_mul(frequency_u128).unwrap();\n\n\t\t\tlet target_u128 = u128::from_le_bytes(Self::convert_vec_to_u8(\u0026update.target_value));\n\n\t\t\tlet new_value_u128 = if current_value_u128 \u003e target_u128 {\n\t\t\t\t(current_value_u128.checked_sub(step_u128).unwrap()).max(target_u128)\n\t\t\t} else {\n\t\t\t\t(current_value_u128.checked_add(step_u128).unwrap()).min(target_u128)\n\t\t\t};\n\n\t\t\t// current_value equal target_value, remove gradually_update\n\t\t\tif new_value_u128 == target_u128 {\n\t\t\t\tkeep = false;\n\t\t\t}\n\n\t\t\tlet mut value = new_value_u128.encode();\n\t\t\tvalue.truncate(update.target_value.len());\n\n\t\t\tstorage::unhashed::put(\u0026update.key, \u0026value);\n\n\t\t\tSelf::deposit_event(RawEvent::Updated(now, update.key.clone(), value));\n\n\t\t\tkeep\n\t\t});\n\n\t\t// gradually_update has finished. Remove it from GraduallyUpdates.\n\t\tif gradually_updates.len() \u003c initial_count {\n\t\t\tGraduallyUpdates::put(gradually_updates);\n\t\t}\n\n\t\tLastUpdatedAt::\u003cT\u003e::put(now);\n\t}\n\n\t#[allow(clippy::ptr_arg)]\n\tfn convert_vec_to_u8(input: \u0026StorageValue) -\u003e [u8; 16] {\n\t\tlet mut array: [u8; 16] = [0; 16];\n\t\tfor (i, v) in input.iter().enumerate() {\n\t\t\tarray[i] = *v;\n\t\t}\n\t\tarray\n\t}\n}\n","traces":[{"line":69,"address":[4924096,4924049,4924244,4924206,4924048,4924192,4924064,4924272,4924240,4924076,4924176],"length":1,"stats":{"Line":69},"fn_name":"last_updated_at\u003corml_gradually_update::mock::Runtime\u003e"},{"line":78,"address":[4925870,4925985,4925653,4927477,4927117,4925831,4926267,4927809,4926494,4927237,4926928],"length":1,"stats":{"Line":8},"fn_name":null},{"line":84,"address":[4926149,4929434,4927541,4925889,4930288,4926300,4925845,4925811,4926247,4929647,4926199,4925672,4925443,4925384,4925608,4928703,4928490],"length":1,"stats":{"Line":14},"fn_name":null},{"line":86,"address":[4929731,4926378,4926660,4927556,4930547,4926612,4926319,4928787,4926562],"length":1,"stats":{"Line":4},"fn_name":null},{"line":88,"address":[4927072,4926886,4930008,4927457,4926699,4927561,4929799,4926933,4928855,4927498,4930199,4929064,4927361,4926773,4930636,4927409,4927136],"length":1,"stats":{"Line":7},"fn_name":null},{"line":117,"address":[4936852,4935419,4936848,4935366,4936857,4935138,4935266,4935235],"length":1,"stats":{"Line":13},"fn_name":"{{closure}}\u003corml_gradually_update::mock::Runtime\u003e"},{"line":120,"address":[4935340,4935505,4935661],"length":1,"stats":{"Line":7},"fn_name":null},{"line":122,"address":[4936067,4935740,4935632],"length":1,"stats":{"Line":6},"fn_name":null},{"line":123,"address":[4935780],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[4936062,4935948,4935864,4935981],"length":1,"stats":{"Line":4},"fn_name":null},{"line":127,"address":[4936864,4936383,4936077],"length":1,"stats":{"Line":13},"fn_name":"{{closure}}\u003corml_gradually_update::mock::Runtime\u003e"},{"line":128,"address":[4936895,4937022,4936987],"length":1,"stats":{"Line":9},"fn_name":null},{"line":130,"address":[4937060,4936972],"length":1,"stats":{"Line":14},"fn_name":null},{"line":132,"address":[4937075],"length":1,"stats":{"Line":7},"fn_name":null},{"line":135,"address":[4936157],"length":1,"stats":{"Line":7},"fn_name":null},{"line":141,"address":[4939147,4939716,4938861,4938989,4939721,4939094,4938958,4939712],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}\u003corml_gradually_update::mock::Runtime\u003e"},{"line":143,"address":[4939237,4939063,4939365,4939776],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003corml_gradually_update::mock::Runtime\u003e"},{"line":144,"address":[4939798],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[4939728,4939836,4939742],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003corml_gradually_update::mock::Runtime\u003e"},{"line":147,"address":[4939937,4939905,4939861],"length":1,"stats":{"Line":3},"fn_name":null},{"line":149,"address":[4939900],"length":1,"stats":{"Line":1},"fn_name":null},{"line":152,"address":[4939267],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[4932999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":174,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":177,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":179,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":183,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":185,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":186,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":187,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":188,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":190,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":192,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":193,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":195,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":197,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":198,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":200,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":204,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":205,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":211,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":213,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":215,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":219,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":220,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":227,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":228,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":229,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":230,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":232,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":54,"coverable":56},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","gradually-update","src","mock.rs"],"content":"//! Mocks for the gradually-update module.\n\n#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse frame_system as system;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod gradually_update {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\tgradually_update\u003cT\u003e,\n\t}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\npub type BlockNumber = u64;\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = ();\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = system::Module\u003cRuntime\u003e;\n\nparameter_types! {\n\tpub const UpdateFrequency: BlockNumber = 10;\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype UpdateFrequency = UpdateFrequency;\n\ttype DispatchOrigin = system::EnsureRoot\u003cAccountId\u003e;\n\ttype WeightInfo = ();\n}\npub type GraduallyUpdateModule = Module\u003cRuntime\u003e;\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[{"line":12,"address":[4456720,4456789],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[4457284,4458028,4457934,4457466,4456969,4457664,4457101,4457138],"length":1,"stats":{"Line":16},"fn_name":null},{"line":22,"address":[4457395,4457173,4457115,4457441],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[4457553,4457480,4457772,4457818],"length":1,"stats":{"Line":4},"fn_name":null},{"line":34,"address":[5056001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":95,"address":[],"length":0,"stats":{"Line":8},"fn_name":null}],"covered":6,"coverable":10},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","gradually-update","src","tests.rs"],"content":"//! Unit tests for the gradually-update module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok, traits::OnFinalize};\nuse mock::{ExtBuilder, GraduallyUpdateModule, Origin, Runtime, System, TestEvent};\nuse sp_runtime::{FixedPointNumber, FixedU128, Permill};\n\nfn storage_set(key: \u0026Vec\u003cu8\u003e, value: \u0026Vec\u003cu8\u003e) {\n\tstorage::unhashed::put(key, value);\n}\n\nfn storage_get(key: \u0026Vec\u003cu8\u003e) -\u003e Vec\u003cu8\u003e {\n\tstorage::unhashed::get::\u003cStorageValue\u003e(key).unwrap_or_default()\n}\n\n#[test]\nfn gradually_update_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: vec![9],\n\t\t\tper_block: vec![1],\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\n\t\tlet gradually_update_event = TestEvent::gradually_update(RawEvent::GraduallyUpdateAdded(\n\t\t\tupdate.key,\n\t\t\tupdate.per_block,\n\t\t\tupdate.target_value,\n\t\t));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_event));\n\t});\n}\n\n#[test]\nfn gradually_update_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 9u32.encode(),\n\t\t\tper_block: 1u64.encode(),\n\t\t};\n\t\tassert_noop!(\n\t\t\tGraduallyUpdateModule::gradually_update(Origin::root(), update.clone()),\n\t\t\tError::\u003cRuntime\u003e::InvalidPerBlockOrTargetValue\n\t\t);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 90u32.encode(),\n\t\t\tper_block: 1u32.encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\n\t\tGraduallyUpdateModule::on_finalize(20);\n\n\t\tlet new_update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 9u64.encode(),\n\t\t\tper_block: 1u64.encode(),\n\t\t};\n\t\tassert_noop!(\n\t\t\tGraduallyUpdateModule::gradually_update(Origin::root(), new_update.clone()),\n\t\t\tError::\u003cRuntime\u003e::InvalidTargetValue\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tGraduallyUpdateModule::gradually_update(Origin::root(), update.clone()),\n\t\t\tError::\u003cRuntime\u003e::GraduallyUpdateHasExisted\n\t\t);\n\t});\n}\n\n#[test]\nfn cancel_gradually_update_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: vec![9],\n\t\t\tper_block: vec![1],\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tlet gradually_update_event = TestEvent::gradually_update(RawEvent::GraduallyUpdateAdded(\n\t\t\tupdate.key.clone(),\n\t\t\tupdate.per_block,\n\t\t\tupdate.target_value,\n\t\t));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_event));\n\n\t\tassert_ok!(GraduallyUpdateModule::cancel_gradually_update(\n\t\t\tOrigin::root(),\n\t\t\tupdate.key.clone()\n\t\t));\n\t\tlet cancel_gradually_update_event = TestEvent::gradually_update(RawEvent::GraduallyUpdateCancelled(update.key));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == cancel_gradually_update_event));\n\t});\n}\n\n#[test]\nfn cancel_gradually_update_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 9u32.encode(),\n\t\t\tper_block: 1u32.encode(),\n\t\t};\n\t\tassert_noop!(\n\t\t\tGraduallyUpdateModule::cancel_gradually_update(Origin::root(), update.key.clone()),\n\t\t\tError::\u003cRuntime\u003e::GraduallyUpdateNotFound\n\t\t);\n\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\n\t\tassert_ok!(GraduallyUpdateModule::cancel_gradually_update(\n\t\t\tOrigin::root(),\n\t\t\tupdate.key.clone()\n\t\t));\n\t});\n}\n\n#[test]\nfn add_on_finalize_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: vec![30],\n\t\t\tper_block: vec![1],\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(10, update.key.clone(), vec![10]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t\tassert_eq!(System::events().len(), 2);\n\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tassert_eq!(System::events().len(), 2);\n\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(20, update.key.clone(), vec![20]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t\tassert_eq!(System::events().len(), 3);\n\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(40, update.key.clone(), vec![30]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t});\n}\n\n#[test]\nfn sub_on_finalize_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: vec![5],\n\t\t\tper_block: vec![1],\n\t\t};\n\n\t\tstorage_set(\u0026update.key, \u0026vec![30]);\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30]);\n\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(10, update.key.clone(), vec![20]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t\tassert_eq!(System::events().len(), 2);\n\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20]);\n\t\tassert_eq!(System::events().len(), 2);\n\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(20, update.key.clone(), vec![10]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t\tassert_eq!(System::events().len(), 3);\n\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![5]);\n\t\tlet gradually_update_blocknumber_event =\n\t\t\tTestEvent::gradually_update(RawEvent::Updated(40, update.key.clone(), vec![5]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == gradually_update_blocknumber_event));\n\t});\n}\n\n#[test]\nfn u32_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 30u32.encode(),\n\t\t\tper_block: 1u32.encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10, 0, 0, 0]);\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10, 0, 0, 0]);\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20, 0, 0, 0]);\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30, 0, 0, 0]);\n\t});\n}\n\n#[test]\nfn u128_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: 30u128.encode(),\n\t\t\tper_block: 1u128.encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![20, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t});\n}\n\n#[test]\nfn permill_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: Permill::from_percent(30).encode(),\n\t\t\tper_block: Permill::from_percent(1).encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![160, 134, 1, 0]);\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![160, 134, 1, 0]);\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![64, 13, 3, 0]);\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![224, 147, 4, 0]);\n\t});\n}\n\n#[test]\nfn fixedu128_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![1],\n\t\t\ttarget_value: FixedU128::saturating_from_rational(30, 1).encode(),\n\t\t\tper_block: FixedU128::saturating_from_rational(1, 1).encode(),\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_eq!(storage_get(\u0026update.key), Vec::\u003cu8\u003e::new());\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![0, 0, 232, 137, 4, 35, 199, 138, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![0, 0, 232, 137, 4, 35, 199, 138, 0, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![0, 0, 208, 19, 9, 70, 142, 21, 1, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(\n\t\t\tstorage_get(\u0026update.key),\n\t\t\tvec![0, 0, 184, 157, 13, 105, 85, 160, 1, 0, 0, 0, 0, 0, 0, 0]\n\t\t);\n\t});\n}\n\n#[test]\nfn finish_multiple_on_finalize_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet update = GraduallyUpdate {\n\t\t\tkey: vec![10],\n\t\t\ttarget_value: vec![30],\n\t\t\tper_block: vec![1],\n\t\t};\n\t\tlet update2 = GraduallyUpdate {\n\t\t\tkey: vec![20],\n\t\t\ttarget_value: vec![60],\n\t\t\tper_block: vec![2],\n\t\t};\n\t\tlet update3 = GraduallyUpdate {\n\t\t\tkey: vec![30],\n\t\t\ttarget_value: vec![100],\n\t\t\tper_block: vec![3],\n\t\t};\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update.clone()));\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update2.clone()));\n\t\tassert_ok!(GraduallyUpdateModule::gradually_update(Origin::root(), update3.clone()));\n\n\t\tGraduallyUpdateModule::on_finalize(10);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![20]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![30]);\n\n\t\tGraduallyUpdateModule::on_finalize(15);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![10]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![20]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![30]);\n\n\t\tGraduallyUpdateModule::on_finalize(20);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![20]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![40]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![60]);\n\n\t\tGraduallyUpdateModule::on_finalize(40);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![60]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![90]);\n\n\t\tGraduallyUpdateModule::on_finalize(50);\n\t\tassert_eq!(storage_get(\u0026update.key), vec![30]);\n\t\tassert_eq!(storage_get(\u0026update2.key), vec![60]);\n\t\tassert_eq!(storage_get(\u0026update3.key), vec![100]);\n\t});\n}\n","traces":[{"line":10,"address":[4319088],"length":1,"stats":{"Line":1},"fn_name":"storage_set"},{"line":11,"address":[4319107],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[4319152],"length":1,"stats":{"Line":2},"fn_name":"storage_get"},{"line":15,"address":[4319169],"length":1,"stats":{"Line":2},"fn_name":null},{"line":19,"address":[4948837,4948832],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":20,"address":[4948912,4948963],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":21,"address":[4948919],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4949156],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[4948978],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[4949027],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4949094],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[4949275,4950294,4949329],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[4949699],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4949588],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4949622],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4949662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[4949967,4950041,4950118,4949907],"length":1,"stats":{"Line":3},"fn_name":null},{"line":37,"address":[4948878,4950033,4948864],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":42,"address":[4319344,4319358],"length":1,"stats":{"Line":3},"fn_name":"gradually_update_should_fail"},{"line":43,"address":[4950581,4950496],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":44,"address":[4950664,4950503],"length":1,"stats":{"Line":2},"fn_name":null},{"line":45,"address":[4950535],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[4950596],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4950638],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[4950933,4950760],"length":1,"stats":{"Line":2},"fn_name":null},{"line":50,"address":[4950806,4950878,4950831,4955320],"length":1,"stats":{"Line":3},"fn_name":null},{"line":51,"address":[4950925],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4952140],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[4952017],"length":1,"stats":{"Line":1},"fn_name":null},{"line":56,"address":[4952069],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4952114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[4952270,4955361,4952244,4952319],"length":1,"stats":{"Line":3},"fn_name":null},{"line":61,"address":[4952601],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4952736],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4952613],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[4952665],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[4952710],"length":1,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[4952832,4953005],"length":1,"stats":{"Line":2},"fn_name":null},{"line":69,"address":[4955402,4952950,4952903,4952878],"length":1,"stats":{"Line":3},"fn_name":null},{"line":70,"address":[4952997],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[4954084,4954223],"length":1,"stats":{"Line":2},"fn_name":null},{"line":74,"address":[4955443,4954111,4954168],"length":1,"stats":{"Line":2},"fn_name":null},{"line":75,"address":[4954215],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[4319454,4319440],"length":1,"stats":{"Line":3},"fn_name":"cancel_gradually_update_should_work"},{"line":82,"address":[4319447,4319469],"length":1,"stats":{"Line":3},"fn_name":null},{"line":83,"address":[4956007],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4956267],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[4956074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":87,"address":[4956123],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4956199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4956452,4956395,4958171],"length":1,"stats":{"Line":2},"fn_name":null},{"line":91,"address":[4956830],"length":1,"stats":{"Line":1},"fn_name":null},{"line":92,"address":[4956723],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[4956750],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4956790],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[4957172,4957098,4957249,4957038],"length":1,"stats":{"Line":3},"fn_name":null},{"line":98,"address":[4955918,4955904,4957164],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":100,"address":[4957317,4957368],"length":1,"stats":{"Line":2},"fn_name":null},{"line":101,"address":[4957242],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4957282],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[4957576],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[4957760,4957971,4957820,4957894],"length":1,"stats":{"Line":3},"fn_name":null},{"line":107,"address":[4957886,4955952,4955966],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":112,"address":[4319536,4319550],"length":1,"stats":{"Line":3},"fn_name":"cancel_gradually_update_should_fail"},{"line":113,"address":[4319565,4319543],"length":1,"stats":{"Line":3},"fn_name":null},{"line":114,"address":[4958487,4958640],"length":1,"stats":{"Line":2},"fn_name":null},{"line":115,"address":[4958511],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[4958572],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[4958614],"length":1,"stats":{"Line":1},"fn_name":null},{"line":119,"address":[4958736,4958913],"length":1,"stats":{"Line":2},"fn_name":null},{"line":120,"address":[4960598,4958807,4958858,4958782],"length":1,"stats":{"Line":3},"fn_name":null},{"line":121,"address":[4958905],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[4959952,4960639],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[4960350,4960299],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[4960257],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[4960264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[4319646,4319632],"length":1,"stats":{"Line":3},"fn_name":"add_on_finalize_should_work"},{"line":135,"address":[4319639,4319661],"length":1,"stats":{"Line":3},"fn_name":null},{"line":136,"address":[4961079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":138,"address":[4961307],"length":1,"stats":{"Line":1},"fn_name":null},{"line":139,"address":[4961114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[4961163],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[4961239],"length":1,"stats":{"Line":1},"fn_name":null},{"line":143,"address":[4961411,4968296,4961467],"length":1,"stats":{"Line":2},"fn_name":null},{"line":144,"address":[4961760],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[4962355],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[4962378],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[4963007],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[4963545,4963456,4963298,4963370],"length":1,"stats":{"Line":3},"fn_name":null},{"line":152,"address":[4960928,4960942,4963448],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":153,"address":[4963586,4963538],"length":1,"stats":{"Line":2},"fn_name":null},{"line":155,"address":[4964128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[4964151],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[4964788],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[4965345],"length":1,"stats":{"Line":1},"fn_name":null},{"line":160,"address":[4965368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[4965997],"length":1,"stats":{"Line":1},"fn_name":null},{"line":163,"address":[4966288,4966535,4966446,4966360],"length":1,"stats":{"Line":3},"fn_name":null},{"line":165,"address":[4966438,4960976,4960990],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":166,"address":[4966576,4966528],"length":1,"stats":{"Line":2},"fn_name":null},{"line":168,"address":[4967118],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[4967141],"length":1,"stats":{"Line":1},"fn_name":null},{"line":171,"address":[4967716],"length":1,"stats":{"Line":1},"fn_name":null},{"line":172,"address":[4968135,4968212,4968061,4968001],"length":1,"stats":{"Line":3},"fn_name":null},{"line":174,"address":[4968127,4961024,4961038],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":179,"address":[4319742,4319728],"length":1,"stats":{"Line":3},"fn_name":"sub_on_finalize_should_work"},{"line":180,"address":[4319735,4319757],"length":1,"stats":{"Line":3},"fn_name":null},{"line":181,"address":[4969047],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[4969275],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[4969082],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[4969131],"length":1,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[4969207],"length":1,"stats":{"Line":1},"fn_name":null},{"line":189,"address":[4969392,4969478],"length":1,"stats":{"Line":2},"fn_name":null},{"line":190,"address":[4976440,4969528],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[4969859],"length":1,"stats":{"Line":1},"fn_name":null},{"line":193,"address":[4970493],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[4970516],"length":1,"stats":{"Line":1},"fn_name":null},{"line":196,"address":[4971145],"length":1,"stats":{"Line":1},"fn_name":null},{"line":197,"address":[4971508,4971436,4971683,4971594],"length":1,"stats":{"Line":3},"fn_name":null},{"line":199,"address":[4968896,4968910,4971586],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":200,"address":[4971724,4971676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":202,"address":[4972266],"length":1,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[4972289],"length":1,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[4972926],"length":1,"stats":{"Line":1},"fn_name":null},{"line":206,"address":[4973483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[4973506],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[4974135],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4974498,4974426,4974584,4974673],"length":1,"stats":{"Line":3},"fn_name":null},{"line":212,"address":[4968958,4974576,4968944],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":213,"address":[4974714,4974666],"length":1,"stats":{"Line":2},"fn_name":null},{"line":215,"address":[4975256],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4975279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[4975860],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[4976279,4976145,4976356,4976205],"length":1,"stats":{"Line":3},"fn_name":null},{"line":221,"address":[4976271,4968992,4969006],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":226,"address":[4319824,4319838],"length":1,"stats":{"Line":3},"fn_name":"u32_should_work"},{"line":227,"address":[4319853,4319831],"length":1,"stats":{"Line":3},"fn_name":null},{"line":228,"address":[4977200,4977063],"length":1,"stats":{"Line":2},"fn_name":null},{"line":229,"address":[4977071],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[4977132],"length":1,"stats":{"Line":1},"fn_name":null},{"line":231,"address":[4977174],"length":1,"stats":{"Line":1},"fn_name":null},{"line":233,"address":[4980883,4977379,4977304,4977330],"length":1,"stats":{"Line":3},"fn_name":null},{"line":234,"address":[4977672],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[4978267],"length":1,"stats":{"Line":1},"fn_name":null},{"line":236,"address":[4978290],"length":1,"stats":{"Line":1},"fn_name":null},{"line":237,"address":[4978938],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[4978961],"length":1,"stats":{"Line":1},"fn_name":null},{"line":239,"address":[4979609],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[4979632],"length":1,"stats":{"Line":1},"fn_name":null},{"line":241,"address":[4980268],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[4980291],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[4319934,4319920],"length":1,"stats":{"Line":3},"fn_name":"u128_should_work"},{"line":248,"address":[4319949,4319927],"length":1,"stats":{"Line":3},"fn_name":null},{"line":249,"address":[4981392,4981255],"length":1,"stats":{"Line":2},"fn_name":null},{"line":250,"address":[4981263],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[4981324],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[4981366],"length":1,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[4981496,4985267,4981522,4981571],"length":1,"stats":{"Line":3},"fn_name":null},{"line":255,"address":[4981864],"length":1,"stats":{"Line":1},"fn_name":null},{"line":256,"address":[4982459],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[4982608],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[4982482],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[4982499],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[4983178],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[4983327],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[4983201],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[4983218],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[4983897],"length":1,"stats":{"Line":1},"fn_name":null},{"line":267,"address":[4984046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":268,"address":[4983920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":269,"address":[4983937],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[4984604],"length":1,"stats":{"Line":1},"fn_name":null},{"line":272,"address":[4984747],"length":1,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[4984627],"length":1,"stats":{"Line":1},"fn_name":null},{"line":274,"address":[4984644],"length":1,"stats":{"Line":1},"fn_name":null},{"line":280,"address":[4320030,4320016],"length":1,"stats":{"Line":3},"fn_name":"permill_should_work"},{"line":281,"address":[4320045,4320023],"length":1,"stats":{"Line":3},"fn_name":null},{"line":282,"address":[4985639,4985871],"length":1,"stats":{"Line":2},"fn_name":null},{"line":283,"address":[4985647],"length":1,"stats":{"Line":1},"fn_name":null},{"line":284,"address":[4985754,4985708],"length":1,"stats":{"Line":2},"fn_name":null},{"line":285,"address":[4985788],"length":1,"stats":{"Line":1},"fn_name":null},{"line":287,"address":[4985975,4989529,4986031],"length":1,"stats":{"Line":2},"fn_name":null},{"line":288,"address":[4986324],"length":1,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[4986919],"length":1,"stats":{"Line":1},"fn_name":null},{"line":290,"address":[4986942],"length":1,"stats":{"Line":1},"fn_name":null},{"line":291,"address":[4987590],"length":1,"stats":{"Line":1},"fn_name":null},{"line":292,"address":[4987613],"length":1,"stats":{"Line":1},"fn_name":null},{"line":293,"address":[4988261],"length":1,"stats":{"Line":1},"fn_name":null},{"line":294,"address":[4988284],"length":1,"stats":{"Line":1},"fn_name":null},{"line":295,"address":[4988914],"length":1,"stats":{"Line":1},"fn_name":null},{"line":296,"address":[4988937],"length":1,"stats":{"Line":1},"fn_name":null},{"line":301,"address":[4320126,4320112],"length":1,"stats":{"Line":3},"fn_name":"fixedu128_should_work"},{"line":302,"address":[4320119,4320141],"length":1,"stats":{"Line":3},"fn_name":null},{"line":303,"address":[4990182,4989895],"length":1,"stats":{"Line":2},"fn_name":null},{"line":304,"address":[4989903],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[4990021,4989974],"length":1,"stats":{"Line":2},"fn_name":null},{"line":306,"address":[4990077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":308,"address":[4990286,4990342,4994038],"length":1,"stats":{"Line":2},"fn_name":null},{"line":309,"address":[4990635],"length":1,"stats":{"Line":1},"fn_name":null},{"line":310,"address":[4991230],"length":1,"stats":{"Line":1},"fn_name":null},{"line":311,"address":[4991379],"length":1,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[4991253],"length":1,"stats":{"Line":1},"fn_name":null},{"line":313,"address":[4991270],"length":1,"stats":{"Line":1},"fn_name":null},{"line":315,"address":[4991949],"length":1,"stats":{"Line":1},"fn_name":null},{"line":316,"address":[4992098],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[4991972],"length":1,"stats":{"Line":1},"fn_name":null},{"line":318,"address":[4991989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":320,"address":[4992668],"length":1,"stats":{"Line":1},"fn_name":null},{"line":321,"address":[4992817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[4992691],"length":1,"stats":{"Line":1},"fn_name":null},{"line":323,"address":[4992708],"length":1,"stats":{"Line":1},"fn_name":null},{"line":325,"address":[4993375],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[4993518],"length":1,"stats":{"Line":0},"fn_name":null},{"line":327,"address":[4993398],"length":1,"stats":{"Line":1},"fn_name":null},{"line":328,"address":[4993415],"length":1,"stats":{"Line":1},"fn_name":null},{"line":334,"address":[4320222,4320208],"length":1,"stats":{"Line":3},"fn_name":"finish_multiple_on_finalize_should_work"},{"line":335,"address":[4320237,4320215],"length":1,"stats":{"Line":3},"fn_name":null},{"line":336,"address":[4994413],"length":1,"stats":{"Line":1},"fn_name":null},{"line":338,"address":[4994657],"length":1,"stats":{"Line":1},"fn_name":null},{"line":339,"address":[4994464],"length":1,"stats":{"Line":1},"fn_name":null},{"line":340,"address":[4994513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":341,"address":[4994589],"length":1,"stats":{"Line":1},"fn_name":null},{"line":343,"address":[4994974],"length":1,"stats":{"Line":1},"fn_name":null},{"line":344,"address":[4994758],"length":1,"stats":{"Line":1},"fn_name":null},{"line":345,"address":[4994833],"length":1,"stats":{"Line":1},"fn_name":null},{"line":346,"address":[4994906],"length":1,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[4995291],"length":1,"stats":{"Line":1},"fn_name":null},{"line":349,"address":[4995075],"length":1,"stats":{"Line":1},"fn_name":null},{"line":350,"address":[4995150],"length":1,"stats":{"Line":1},"fn_name":null},{"line":351,"address":[4995223],"length":1,"stats":{"Line":1},"fn_name":null},{"line":353,"address":[5006070,4995451,4995395],"length":1,"stats":{"Line":2},"fn_name":null},{"line":354,"address":[5006111,4995736],"length":1,"stats":{"Line":1},"fn_name":null},{"line":355,"address":[4996059,5006152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":357,"address":[4996379],"length":1,"stats":{"Line":1},"fn_name":null},{"line":358,"address":[4996402],"length":1,"stats":{"Line":1},"fn_name":null},{"line":359,"address":[4997047],"length":1,"stats":{"Line":1},"fn_name":null},{"line":360,"address":[4997692],"length":1,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[4998326],"length":1,"stats":{"Line":1},"fn_name":null},{"line":363,"address":[4998349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":364,"address":[4998994],"length":1,"stats":{"Line":1},"fn_name":null},{"line":365,"address":[4999639],"length":1,"stats":{"Line":1},"fn_name":null},{"line":367,"address":[5000273],"length":1,"stats":{"Line":1},"fn_name":null},{"line":368,"address":[5000296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":369,"address":[5000941],"length":1,"stats":{"Line":1},"fn_name":null},{"line":370,"address":[5001586],"length":1,"stats":{"Line":1},"fn_name":null},{"line":372,"address":[5002220],"length":1,"stats":{"Line":1},"fn_name":null},{"line":373,"address":[5002243],"length":1,"stats":{"Line":1},"fn_name":null},{"line":374,"address":[5002888],"length":1,"stats":{"Line":1},"fn_name":null},{"line":375,"address":[5003533],"length":1,"stats":{"Line":1},"fn_name":null},{"line":377,"address":[5004167],"length":1,"stats":{"Line":1},"fn_name":null},{"line":378,"address":[5004190],"length":1,"stats":{"Line":1},"fn_name":null},{"line":379,"address":[5004835],"length":1,"stats":{"Line":1},"fn_name":null},{"line":380,"address":[5005462],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":245,"coverable":253},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","nft","src","lib.rs"],"content":"//! # Non Fungible Token\n//! The module provides implementations for non-fungible-token.\n//!\n//! - [`Trait`](./trait.Trait.html)\n//! - [`Call`](./enum.Call.html)\n//! - [`Module`](./struct.Module.html)\n//!\n//! ## Overview\n//!\n//! This module provides basic functions to create and manager\n//! NFT(non fungible token) such as `create_class`, `transfer`, `mint`, `burn`.\n\n//! ### Module Functions\n//!\n//! - `create_class` - Create NFT(non fungible token) class\n//! - `transfer` - Transfer NFT(non fungible token) to another account.\n//! - `mint` - Mint NFT(non fungible token)\n//! - `burn` - Burn NFT(non fungible token)\n//! - `destroy_class` - Destroy NFT(non fungible token) class\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{decl_error, decl_module, decl_storage, ensure, Parameter};\nuse sp_runtime::{\n\ttraits::{AtLeast32BitUnsigned, CheckedAdd, CheckedSub, Member, One, Zero},\n\tDispatchError, DispatchResult, RuntimeDebug,\n};\nuse sp_std::vec::Vec;\n\nmod mock;\nmod tests;\n\n/// Class info\n#[derive(Encode, Decode, Clone, Eq, PartialEq, RuntimeDebug)]\npub struct ClassInfo\u003cTokenId, AccountId, Data\u003e {\n\t/// Class metadata\n\tpub metadata: Vec\u003cu8\u003e,\n\t/// Total issuance for the class\n\tpub total_issuance: TokenId,\n\t/// Class owner\n\tpub owner: AccountId,\n\t/// Class Properties\n\tpub data: Data,\n}\n\n/// Token info\n#[derive(Encode, Decode, Clone, Eq, PartialEq, RuntimeDebug)]\npub struct TokenInfo\u003cAccountId, Data\u003e {\n\t/// Token metadata\n\tpub metadata: Vec\u003cu8\u003e,\n\t/// Token owner\n\tpub owner: AccountId,\n\t/// Token Properties\n\tpub data: Data,\n}\n\npub trait Trait: frame_system::Trait {\n\t/// The class ID type\n\ttype ClassId: Parameter + Member + AtLeast32BitUnsigned + Default + Copy;\n\t/// The token ID type\n\ttype TokenId: Parameter + Member + AtLeast32BitUnsigned + Default + Copy;\n\t/// The class properties type\n\ttype ClassData: Parameter + Member;\n\t/// The token properties type\n\ttype TokenData: Parameter + Member;\n}\n\ndecl_error! {\n\t/// Error for non-fungible-token module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// No available class ID\n\t\tNoAvailableClassId,\n\t\t/// No available token ID\n\t\tNoAvailableTokenId,\n\t\t/// Token(ClassId, TokenId) not found\n\t\tTokenNotFound,\n\t\t/// Class not found\n\t\tClassNotFound,\n\t\t/// The operator is not the owner of the token and has no permission\n\t\tNoPermission,\n\t\t/// Arithmetic calculation overflow\n\t\tNumOverflow,\n\t\t/// Can not destroy class\n\t\t/// Total issuance is not 0\n\t\tCannotDestroyClass,\n\t}\n}\n\npub type ClassInfoOf\u003cT\u003e =\n\tClassInfo\u003c\u003cT as Trait\u003e::TokenId, \u003cT as frame_system::Trait\u003e::AccountId, \u003cT as Trait\u003e::ClassData\u003e;\npub type TokenInfoOf\u003cT\u003e = TokenInfo\u003c\u003cT as frame_system::Trait\u003e::AccountId, \u003cT as Trait\u003e::TokenData\u003e;\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as NonFungibleToken {\n\t\t/// Next available class ID.\n\t\tpub NextClassId get(fn next_class_id): T::ClassId;\n\t\t/// Next available token ID.\n\t\tpub NextTokenId get(fn next_token_id): T::TokenId;\n\t\t/// Store class info.\n\t\t///\n\t\t/// Returns `None` if class info not set or removed.\n\t\tpub Classes get(fn classes): map hasher(twox_64_concat) T::ClassId =\u003e Option\u003cClassInfoOf\u003cT\u003e\u003e;\n\t\t/// Store token info.\n\t\t///\n\t\t/// Returns `None` if token info not set or removed.\n\t\tpub Tokens get(fn tokens): double_map hasher(twox_64_concat) T::ClassId, hasher(twox_64_concat) T::TokenId =\u003e Option\u003cTokenInfoOf\u003cT\u003e\u003e;\n\t\t/// Token existence check by owner and class ID.\n\t\tpub TokensByOwner get(fn tokens_by_owner): double_map hasher(twox_64_concat) T::AccountId, hasher(twox_64_concat) (T::ClassId, T::TokenId) =\u003e Option\u003c()\u003e;\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Create NFT(non fungible token) class\n\tpub fn create_class(\n\t\towner: \u0026T::AccountId,\n\t\tmetadata: Vec\u003cu8\u003e,\n\t\tdata: T::ClassData,\n\t) -\u003e Result\u003cT::ClassId, DispatchError\u003e {\n\t\tlet class_id = NextClassId::\u003cT\u003e::try_mutate(|id| -\u003e Result\u003cT::ClassId, DispatchError\u003e {\n\t\t\tlet current_id = *id;\n\t\t\t*id = id.checked_add(\u0026One::one()).ok_or(Error::\u003cT\u003e::NoAvailableClassId)?;\n\t\t\tOk(current_id)\n\t\t})?;\n\n\t\tlet info = ClassInfo {\n\t\t\tmetadata,\n\t\t\ttotal_issuance: Default::default(),\n\t\t\towner: owner.clone(),\n\t\t\tdata,\n\t\t};\n\t\tClasses::\u003cT\u003e::insert(class_id, info);\n\n\t\tOk(class_id)\n\t}\n\n\t/// Transfer NFT(non fungible token) from `from` account to `to` account\n\tpub fn transfer(from: \u0026T::AccountId, to: \u0026T::AccountId, token: (T::ClassId, T::TokenId)) -\u003e DispatchResult {\n\t\tif from == to {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\tTokensByOwner::\u003cT\u003e::try_mutate_exists(from, token, |token_by_owner| -\u003e DispatchResult {\n\t\t\tensure!(token_by_owner.take().is_some(), Error::\u003cT\u003e::NoPermission);\n\t\t\tTokensByOwner::\u003cT\u003e::insert(to, token, ());\n\n\t\t\tTokens::\u003cT\u003e::try_mutate_exists(token.0, token.1, |token_info| -\u003e DispatchResult {\n\t\t\t\tlet mut info = token_info.as_mut().ok_or(Error::\u003cT\u003e::TokenNotFound)?;\n\t\t\t\tinfo.owner = to.clone();\n\t\t\t\tOk(())\n\t\t\t})\n\t\t})\n\t}\n\n\t/// Mint NFT(non fungible token) to `owner`\n\tpub fn mint(\n\t\towner: \u0026T::AccountId,\n\t\tclass_id: T::ClassId,\n\t\tmetadata: Vec\u003cu8\u003e,\n\t\tdata: T::TokenData,\n\t) -\u003e Result\u003cT::TokenId, DispatchError\u003e {\n\t\tNextTokenId::\u003cT\u003e::try_mutate(|id| -\u003e Result\u003cT::TokenId, DispatchError\u003e {\n\t\t\tlet token_id = *id;\n\t\t\t*id = id.checked_add(\u0026One::one()).ok_or(Error::\u003cT\u003e::NoAvailableTokenId)?;\n\n\t\t\tClasses::\u003cT\u003e::try_mutate(class_id, |class_info| -\u003e DispatchResult {\n\t\t\t\tlet info = class_info.as_mut().ok_or(Error::\u003cT\u003e::ClassNotFound)?;\n\t\t\t\tinfo.total_issuance = info\n\t\t\t\t\t.total_issuance\n\t\t\t\t\t.checked_add(\u0026One::one())\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\tOk(())\n\t\t\t})?;\n\n\t\t\tlet token_info = TokenInfo {\n\t\t\t\tmetadata,\n\t\t\t\towner: owner.clone(),\n\t\t\t\tdata,\n\t\t\t};\n\t\t\tTokens::\u003cT\u003e::insert(class_id, token_id, token_info);\n\t\t\tTokensByOwner::\u003cT\u003e::insert(owner, (class_id, token_id), ());\n\n\t\t\tOk(token_id)\n\t\t})\n\t}\n\n\t/// Burn NFT(non fungible token) from `owner`\n\tpub fn burn(owner: \u0026T::AccountId, token: (T::ClassId, T::TokenId)) -\u003e DispatchResult {\n\t\tTokens::\u003cT\u003e::try_mutate_exists(token.0, token.1, |token_info| -\u003e DispatchResult {\n\t\t\tensure!(token_info.take().is_some(), Error::\u003cT\u003e::TokenNotFound);\n\n\t\t\tTokensByOwner::\u003cT\u003e::try_mutate_exists(owner, token, |info| -\u003e DispatchResult {\n\t\t\t\tensure!(info.take().is_some(), Error::\u003cT\u003e::NoPermission);\n\n\t\t\t\tClasses::\u003cT\u003e::try_mutate(token.0, |class_info| -\u003e DispatchResult {\n\t\t\t\t\tlet info = class_info.as_mut().ok_or(Error::\u003cT\u003e::ClassNotFound)?;\n\t\t\t\t\tinfo.total_issuance = info\n\t\t\t\t\t\t.total_issuance\n\t\t\t\t\t\t.checked_sub(\u0026One::one())\n\t\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\t\tOk(())\n\t\t\t\t})\n\t\t\t})\n\t\t})\n\t}\n\n\t/// Destroy NFT(non fungible token) class\n\tpub fn destroy_class(owner: \u0026T::AccountId, class_id: T::ClassId) -\u003e DispatchResult {\n\t\tClasses::\u003cT\u003e::try_mutate_exists(class_id, |class_info| -\u003e DispatchResult {\n\t\t\tlet info = class_info.take().ok_or(Error::\u003cT\u003e::ClassNotFound)?;\n\t\t\tensure!(info.owner == *owner, Error::\u003cT\u003e::NoPermission);\n\t\t\tensure!(info.total_issuance == Zero::zero(), Error::\u003cT\u003e::CannotDestroyClass);\n\t\t\tOk(())\n\t\t})\n\t}\n}\n","traces":[{"line":120,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":216,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":218,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":55},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","nft","src","mock.rs"],"content":"//! Mocks for the gradually-update module.\n\n#![cfg(test)]\n\nuse frame_support::{impl_outer_origin, parameter_types};\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\npub type BlockNumber = u64;\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = ();\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = ();\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\nimpl Trait for Runtime {\n\ttype ClassId = u64;\n\ttype TokenId = u64;\n\ttype ClassData = ();\n\ttype TokenData = ();\n}\npub type NonFungibleTokenModule = Module\u003cRuntime\u003e;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const CLASS_ID: \u003cRuntime as Trait\u003e::ClassId = 0;\npub const CLASS_ID_NOT_EXIST: \u003cRuntime as Trait\u003e::ClassId = 1;\npub const TOKEN_ID: \u003cRuntime as Trait\u003e::TokenId = 0;\npub const TOKEN_ID_NOT_EXIST: \u003cRuntime as Trait\u003e::TokenId = 1;\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[{"line":75,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":7},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","nft","src","tests.rs"],"content":"//! Unit tests for the non-fungible-token module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok};\nuse mock::{\n\tExtBuilder, NonFungibleTokenModule, Runtime, ALICE, BOB, CLASS_ID, CLASS_ID_NOT_EXIST, TOKEN_ID, TOKEN_ID_NOT_EXIST,\n};\n\n#[test]\nfn create_class_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t});\n}\n\n#[test]\nfn create_class_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tNextClassId::\u003cRuntime\u003e::mutate(|id| *id = \u003cRuntime as Trait\u003e::ClassId::max_value());\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()),\n\t\t\tError::\u003cRuntime\u003e::NoAvailableClassId\n\t\t);\n\t});\n}\n\n#[test]\nfn mint_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t});\n}\n\n#[test]\nfn mint_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tClasses::\u003cRuntime\u003e::mutate(CLASS_ID, |class_info| {\n\t\t\tclass_info.as_mut().unwrap().total_issuance = \u003cRuntime as Trait\u003e::TokenId::max_value();\n\t\t});\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\tNextTokenId::\u003cRuntime\u003e::mutate(|id| *id = \u003cRuntime as Trait\u003e::TokenId::max_value());\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()),\n\t\t\tError::\u003cRuntime\u003e::NoAvailableTokenId\n\t\t);\n\t});\n}\n\n#[test]\nfn transfer_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::transfer(\u0026BOB, \u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t\tassert_ok!(NonFungibleTokenModule::transfer(\u0026BOB, \u0026ALICE, (CLASS_ID, TOKEN_ID)));\n\t\tassert_ok!(NonFungibleTokenModule::transfer(\u0026ALICE, \u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t});\n}\n\n#[test]\nfn transfer_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::transfer(\u0026BOB, \u0026ALICE, (CLASS_ID, TOKEN_ID_NOT_EXIST)),\n\t\t\tError::\u003cRuntime\u003e::NoPermission\n\t\t);\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::transfer(\u0026ALICE, \u0026BOB, (CLASS_ID, TOKEN_ID)),\n\t\t\tError::\u003cRuntime\u003e::NoPermission\n\t\t);\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::mint(\u0026BOB, CLASS_ID_NOT_EXIST, vec![1], ()),\n\t\t\tError::\u003cRuntime\u003e::ClassNotFound\n\t\t);\n\t});\n}\n\n#[test]\nfn burn_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t});\n}\n\n#[test]\nfn burn_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID_NOT_EXIST)),\n\t\t\tError::\u003cRuntime\u003e::TokenNotFound\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::burn(\u0026ALICE, (CLASS_ID, TOKEN_ID)),\n\t\t\tError::\u003cRuntime\u003e::NoPermission\n\t\t);\n\t});\n\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\n\t\tClasses::\u003cRuntime\u003e::mutate(CLASS_ID, |class_info| {\n\t\t\tclass_info.as_mut().unwrap().total_issuance = 0;\n\t\t});\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID)),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn destroy_class_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t\tassert_ok!(NonFungibleTokenModule::destroy_class(\u0026ALICE, CLASS_ID));\n\t});\n}\n\n#[test]\nfn destroy_class_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(NonFungibleTokenModule::create_class(\u0026ALICE, vec![1], ()));\n\t\tassert_ok!(NonFungibleTokenModule::mint(\u0026BOB, CLASS_ID, vec![1], ()));\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::destroy_class(\u0026ALICE, CLASS_ID_NOT_EXIST),\n\t\t\tError::\u003cRuntime\u003e::ClassNotFound\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::destroy_class(\u0026BOB, CLASS_ID),\n\t\t\tError::\u003cRuntime\u003e::NoPermission\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tNonFungibleTokenModule::destroy_class(\u0026ALICE, CLASS_ID),\n\t\t\tError::\u003cRuntime\u003e::CannotDestroyClass\n\t\t);\n\n\t\tassert_ok!(NonFungibleTokenModule::burn(\u0026BOB, (CLASS_ID, TOKEN_ID)));\n\t\tassert_ok!(NonFungibleTokenModule::destroy_class(\u0026ALICE, CLASS_ID));\n\t\tassert_eq!(Classes::\u003cRuntime\u003e::contains_key(CLASS_ID), false);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","rpc","runtime-api","src","lib.rs"],"content":"//! Runtime API definition for oracle module.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// The `too_many_arguments` warning originates from `decl_runtime_apis` macro.\n#![allow(clippy::too_many_arguments)]\n// The `unnecessary_mut_passed` warning originates from `decl_runtime_apis` macro.\n#![allow(clippy::unnecessary_mut_passed)]\n\nuse codec::Codec;\nuse sp_std::prelude::Vec;\n\nsp_api::decl_runtime_apis! {\n\tpub trait OracleApi\u003cProviderId, Key, Value\u003e where\n\t\tProviderId: Codec,\n\t\tKey: Codec,\n\t\tValue: Codec,\n\t{\n\t\tfn get_value(provider_id: ProviderId, key: Key) -\u003e Option\u003cValue\u003e;\n\t\tfn get_all_values(provider_id: ProviderId) -\u003e Vec\u003c(Key, Option\u003cValue\u003e)\u003e;\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","rpc","src","lib.rs"],"content":"use std::sync::Arc;\n\nuse codec::Codec;\nuse jsonrpc_core::{Error as RpcError, ErrorCode, Result};\nuse jsonrpc_derive::rpc;\nuse sp_api::ProvideRuntimeApi;\nuse sp_blockchain::HeaderBackend;\nuse sp_runtime::{generic::BlockId, traits::Block as BlockT};\n\npub use self::gen_client::Client as OracleClient;\npub use orml_oracle_rpc_runtime_api::OracleApi as OracleRuntimeApi;\n\n#[rpc]\npub trait OracleApi\u003cBlockHash, ProviderId, Key, Value\u003e {\n\t#[rpc(name = \"oracle_getValue\")]\n\tfn get_value(\u0026self, provider_id: ProviderId, key: Key, at: Option\u003cBlockHash\u003e) -\u003e Result\u003cOption\u003cValue\u003e\u003e;\n\t#[rpc(name = \"oracle_getAllValues\")]\n\tfn get_all_values(\u0026self, provider_id: ProviderId, at: Option\u003cBlockHash\u003e) -\u003e Result\u003cVec\u003c(Key, Option\u003cValue\u003e)\u003e\u003e;\n}\n\n/// A struct that implements the [`OracleApi`].\npub struct Oracle\u003cC, B\u003e {\n\tclient: Arc\u003cC\u003e,\n\t_marker: std::marker::PhantomData\u003cB\u003e,\n}\n\nimpl\u003cC, B\u003e Oracle\u003cC, B\u003e {\n\t/// Create new `Oracle` with the given reference to the client.\n\tpub fn new(client: Arc\u003cC\u003e) -\u003e Self {\n\t\tOracle {\n\t\t\tclient,\n\t\t\t_marker: Default::default(),\n\t\t}\n\t}\n}\n\npub enum Error {\n\tRuntimeError,\n}\n\nimpl From\u003cError\u003e for i64 {\n\tfn from(e: Error) -\u003e i64 {\n\t\tmatch e {\n\t\t\tError::RuntimeError =\u003e 1,\n\t\t}\n\t}\n}\n\nimpl\u003cC, Block, ProviderId, Key, Value\u003e OracleApi\u003c\u003cBlock as BlockT\u003e::Hash, ProviderId, Key, Value\u003e for Oracle\u003cC, Block\u003e\nwhere\n\tBlock: BlockT,\n\tC: Send + Sync + 'static + ProvideRuntimeApi\u003cBlock\u003e + HeaderBackend\u003cBlock\u003e,\n\tC::Api: OracleRuntimeApi\u003cBlock, ProviderId, Key, Value\u003e,\n\tProviderId: Codec,\n\tKey: Codec,\n\tValue: Codec,\n{\n\tfn get_value(\n\t\t\u0026self,\n\t\tprovider_id: ProviderId,\n\t\tkey: Key,\n\t\tat: Option\u003c\u003cBlock as BlockT\u003e::Hash\u003e,\n\t) -\u003e Result\u003cOption\u003cValue\u003e\u003e {\n\t\tlet api = self.client.runtime_api();\n\t\tlet at = BlockId::hash(at.unwrap_or(\n\t\t\t// If the block hash is not supplied assume the best block.\n\t\t\tself.client.info().best_hash,\n\t\t));\n\t\tapi.get_value(\u0026at, provider_id, key).map_err(|e| RpcError {\n\t\t\tcode: ErrorCode::ServerError(Error::RuntimeError.into()),\n\t\t\tmessage: \"Unable to get value.\".into(),\n\t\t\tdata: Some(format!(\"{:?}\", e).into()),\n\t\t})\n\t}\n\n\tfn get_all_values(\n\t\t\u0026self,\n\t\tprovider_id: ProviderId,\n\t\tat: Option\u003c\u003cBlock as BlockT\u003e::Hash\u003e,\n\t) -\u003e Result\u003cVec\u003c(Key, Option\u003cValue\u003e)\u003e\u003e {\n\t\tlet api = self.client.runtime_api();\n\t\tlet at = BlockId::hash(at.unwrap_or(\n\t\t\t// If the block hash is not supplied assume the best block.\n\t\t\tself.client.info().best_hash,\n\t\t));\n\t\tapi.get_all_values(\u0026at, provider_id).map_err(|e| RpcError {\n\t\t\tcode: ErrorCode::ServerError(Error::RuntimeError.into()),\n\t\t\tmessage: \"Unable to get all values.\".into(),\n\t\t\tdata: Some(format!(\"{:?}\", e).into()),\n\t\t})\n\t}\n}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":21},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","default_combine_data.rs"],"content":"use crate::{DefaultInstance, Instance, MomentOf, TimestampedValueOf, Trait};\nuse frame_support::traits::{Get, Time};\nuse orml_traits::CombineData;\nuse sp_std::{marker, prelude::*};\n\n/// Sort by value and returns median timestamped value.\n/// Returns prev_value if not enough valid values.\npub struct DefaultCombineData\u003cT, MinimumCount, ExpiresIn, I = DefaultInstance\u003e(\n\tmarker::PhantomData\u003c(T, I, MinimumCount, ExpiresIn)\u003e,\n);\n\nimpl\u003cT, I, MinimumCount, ExpiresIn\u003e CombineData\u003c\u003cT as Trait\u003cI\u003e\u003e::OracleKey, TimestampedValueOf\u003cT, I\u003e\u003e\n\tfor DefaultCombineData\u003cT, MinimumCount, ExpiresIn, I\u003e\nwhere\n\tT: Trait\u003cI\u003e,\n\tI: Instance,\n\tMinimumCount: Get\u003cu32\u003e,\n\tExpiresIn: Get\u003cMomentOf\u003cT, I\u003e\u003e,\n{\n\tfn combine_data(\n\t\t_key: \u0026\u003cT as Trait\u003cI\u003e\u003e::OracleKey,\n\t\tmut values: Vec\u003cTimestampedValueOf\u003cT, I\u003e\u003e,\n\t\tprev_value: Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e,\n\t) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tlet expires_in = ExpiresIn::get();\n\t\tlet now = T::Time::now();\n\n\t\tvalues.retain(|x| x.timestamp + expires_in \u003e now);\n\n\t\tlet count = values.len() as u32;\n\t\tlet minimum_count = MinimumCount::get();\n\t\tif count \u003c minimum_count {\n\t\t\treturn prev_value;\n\t\t}\n\n\t\tvalues.sort_by(|a, b| a.value.cmp(\u0026b.value));\n\n\t\tlet median_index = count / 2;\n\t\tSome(values[median_index as usize].clone())\n\t}\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":25,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":26,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":28,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":30,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":31,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":32,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":33,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":38,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":39,"address":[],"length":0,"stats":{"Line":2},"fn_name":null}],"covered":11,"coverable":11},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn feed_values(c: u32) -\u003e Weight {\n\t\t(74_792_000 as Weight)\n\t\t\t.saturating_add((11_208_000 as Weight).saturating_mul(c as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(1 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes((2 as Weight).saturating_mul(c as Weight)))\n\t}\n\tfn on_finalize() -\u003e Weight {\n\t\t(15_881_000 as Weight).saturating_add(DbWeight::get().writes(1 as Weight))\n\t}\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":10,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":8},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","lib.rs"],"content":"//! # Oracle\n//! A module to allow oracle operators to feed external data.\n//!\n//! - [`Trait`](./trait.Trait.html)\n//! - [`Call`](./enum.Call.html)\n//! - [`Module`](./struct.Module.html)\n//!\n//! ## Overview\n//!\n//! This module exposes capabilities for oracle operators to feed external\n//! offchain data. The raw values can be combined to provide an aggregated\n//! value.\n//!\n//! The data are submitted with unsigned transaction so it does not incure a\n//! transaction fee. However the data still needs to be signed by a session key\n//! to prevent spam and ensure the integrity.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// Disable the following two lints since they originate from an external macro (namely decl_storage)\n#![allow(clippy::string_lit_as_bytes)]\n\nmod default_combine_data;\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn feed_values(c: u32) -\u003e Weight;\n\tfn on_finalize() -\u003e Weight;\n}\n\nuse codec::{Decode, Encode};\npub use default_combine_data::DefaultCombineData;\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage,\n\tdispatch::DispatchResultWithPostInfo,\n\tensure,\n\ttraits::{ChangeMembers, Get, InitializeMembers, Time},\n\tweights::{DispatchClass, Pays, Weight},\n\tIterableStorageMap, Parameter,\n};\nuse frame_system::{ensure_root, ensure_signed};\npub use orml_traits::{CombineData, DataFeeder, DataProvider, DataProviderExtended, OnNewData};\nuse orml_utilities::OrderedSet;\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::{traits::Member, DispatchResult, RuntimeDebug};\nuse sp_std::{prelude::*, vec};\n\ntype MomentOf\u003cT, I = DefaultInstance\u003e = \u003c\u003cT as Trait\u003cI\u003e\u003e::Time as Time\u003e::Moment;\npub type TimestampedValueOf\u003cT, I = DefaultInstance\u003e = TimestampedValue\u003c\u003cT as Trait\u003cI\u003e\u003e::OracleValue, MomentOf\u003cT, I\u003e\u003e;\n\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Clone, Copy, Ord, PartialOrd)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub struct TimestampedValue\u003cValue, Moment\u003e {\n\tpub value: Value,\n\tpub timestamp: Moment,\n}\n\npub trait Trait\u003cI: Instance = DefaultInstance\u003e: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf, I\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// Hook on new data received\n\ttype OnNewData: OnNewData\u003cSelf::AccountId, Self::OracleKey, Self::OracleValue\u003e;\n\n\t/// Provide the implementation to combine raw values to produce aggregated\n\t/// value\n\ttype CombineData: CombineData\u003cSelf::OracleKey, TimestampedValueOf\u003cSelf, I\u003e\u003e;\n\n\t/// Time provider\n\ttype Time: Time;\n\n\t/// The data key type\n\ttype OracleKey: Parameter + Member;\n\n\t/// The data value type\n\ttype OracleValue: Parameter + Member + Ord;\n\n\t/// The root operator account id, recorad all sudo feeds on this account.\n\ttype RootOperatorAccountId: Get\u003cSelf::AccountId\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003cI\u003e, I: Instance\u003e {\n\t\t/// Sender does not have permission\n\t\tNoPermission,\n\t\t/// Feeder has already feeded at this block\n\t\tAlreadyFeeded,\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT, I=DefaultInstance\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\t\u003cT as Trait\u003cI\u003e\u003e::OracleKey,\n\t\t\u003cT as Trait\u003cI\u003e\u003e::OracleValue,\n\t{\n\t\t/// New feed data is submitted. [sender, values]\n\t\tNewFeedData(AccountId, Vec\u003c(OracleKey, OracleValue)\u003e),\n\t}\n);\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003cI\u003e, I: Instance=DefaultInstance\u003e as Oracle {\n\n\t\t/// Raw values for each oracle operators\n\t\tpub RawValues get(fn raw_values): double_map hasher(twox_64_concat) T::AccountId, hasher(twox_64_concat) T::OracleKey =\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e;\n\n\t\t/// True if Self::values(key) is up to date, otherwise the value is stale\n\t\tpub IsUpdated get(fn is_updated): map hasher(twox_64_concat) \u003cT as Trait\u003cI\u003e\u003e::OracleKey =\u003e bool;\n\n\t\t/// Combined value, may not be up to date\n\t\tpub Values get(fn values): map hasher(twox_64_concat) \u003cT as Trait\u003cI\u003e\u003e::OracleKey =\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e;\n\n\t\t/// If an oracle operator has feed a value in this block\n\t\tHasDispatched: OrderedSet\u003cT::AccountId\u003e;\n\n\t\t// TODO: this shouldn't be required https://github.com/paritytech/substrate/issues/6041\n\t\t/// The current members of the collective. This is stored sorted (just by value).\n\t\tpub Members get(fn members) config(): OrderedSet\u003cT::AccountId\u003e;\n\n\t\tpub Nonces get(fn nonces): map hasher(twox_64_concat) T::AccountId =\u003e u32;\n\t}\n\n\tadd_extra_genesis {\n\t\tconfig(phantom): sp_std::marker::PhantomData\u003cI\u003e;\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003cI\u003e, I: Instance=DefaultInstance\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT, I\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Feed the external value.\n\t\t///\n\t\t/// Require unsigned. However a valid signature signed by session key is required along with payload.\n\t\t#[weight = (T::WeightInfo::feed_values(values.len() as u32), DispatchClass::Operational)]\n\t\tpub fn feed_values(\n\t\t\torigin,\n\t\t\tvalues: Vec\u003c(T::OracleKey, T::OracleValue)\u003e,\n\t\t) -\u003e DispatchResultWithPostInfo {\n\t\t\tlet feeder = ensure_signed(origin.clone()).or_else(|_| ensure_root(origin).map(|_| T::RootOperatorAccountId::get()))?;\n\t\t\tSelf::do_feed_values(feeder, values)?;\n\t\t\tOk(Pays::No.into())\n\t\t}\n\n\t\t/// `on_initialize` to return the weight used in `on_finalize`.\n\t\tfn on_initialize() -\u003e Weight {\n\t\t\tT::WeightInfo::on_finalize()\n\t\t}\n\n\t\tfn on_finalize(_n: T::BlockNumber) {\n\t\t\t// cleanup for next block\n\t\t\t\u003cHasDispatched\u003cT, I\u003e\u003e::kill();\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e Module\u003cT, I\u003e {\n\tpub fn read_raw_values(key: \u0026T::OracleKey) -\u003e Vec\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tSelf::members()\n\t\t\t.0\n\t\t\t.iter()\n\t\t\t.chain(vec![T::RootOperatorAccountId::get()].iter())\n\t\t\t.filter_map(|x| Self::raw_values(x, key))\n\t\t\t.collect()\n\t}\n\n\t/// Returns fresh combined value if has update, or latest combined value.\n\t///\n\t/// Note this will update values storage if has update.\n\tpub fn get(key: \u0026T::OracleKey) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tif Self::is_updated(key) {\n\t\t\t\u003cValues\u003cT, I\u003e\u003e::get(key)\n\t\t} else {\n\t\t\tlet timestamped = Self::combined(key)?;\n\t\t\t\u003cValues\u003cT, I\u003e\u003e::insert(key, timestamped.clone());\n\t\t\tIsUpdated::\u003cT, I\u003e::insert(key, true);\n\t\t\tSome(timestamped)\n\t\t}\n\t}\n\n\t/// Returns fresh combined value if has update, or latest combined value.\n\t///\n\t/// This is a no-op function which would not change storage.\n\tpub fn get_no_op(key: \u0026T::OracleKey) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tif Self::is_updated(key) {\n\t\t\tSelf::values(key)\n\t\t} else {\n\t\t\tSelf::combined(key)\n\t\t}\n\t}\n\n\t#[allow(clippy::complexity)]\n\tpub fn get_all_values() -\u003e Vec\u003c(T::OracleKey, Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e)\u003e {\n\t\t\u003cValues\u003cT, I\u003e\u003e::iter()\n\t\t\t.map(|(key, _)| key)\n\t\t\t.map(|key| {\n\t\t\t\tlet v = Self::get_no_op(\u0026key);\n\t\t\t\t(key, v)\n\t\t\t})\n\t\t\t.collect()\n\t}\n\n\tfn combined(key: \u0026T::OracleKey) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tlet values = Self::read_raw_values(key);\n\t\tT::CombineData::combine_data(key, values, Self::values(key))\n\t}\n\n\tfn do_feed_values(who: T::AccountId, values: Vec\u003c(T::OracleKey, T::OracleValue)\u003e) -\u003e DispatchResult {\n\t\t// ensure feeder is authorized\n\t\tensure!(\n\t\t\tSelf::members().contains(\u0026who) || who == T::RootOperatorAccountId::get(),\n\t\t\tError::\u003cT, I\u003e::NoPermission\n\t\t);\n\n\t\t// ensure account hasn't dispatched an updated yet\n\t\tensure!(\n\t\t\tHasDispatched::\u003cT, I\u003e::mutate(|set| set.insert(who.clone())),\n\t\t\tError::\u003cT, I\u003e::AlreadyFeeded\n\t\t);\n\n\t\tlet now = T::Time::now();\n\t\tfor (key, value) in \u0026values {\n\t\t\tlet timestamped = TimestampedValue {\n\t\t\t\tvalue: value.clone(),\n\t\t\t\ttimestamp: now,\n\t\t\t};\n\t\t\tRawValues::\u003cT, I\u003e::insert(\u0026who, \u0026key, timestamped);\n\t\t\tIsUpdated::\u003cT, I\u003e::remove(\u0026key);\n\n\t\t\tT::OnNewData::on_new_data(\u0026who, \u0026key, \u0026value);\n\t\t}\n\t\tSelf::deposit_event(RawEvent::NewFeedData(who, values));\n\t\tOk(())\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e InitializeMembers\u003cT::AccountId\u003e for Module\u003cT, I\u003e {\n\tfn initialize_members(members: \u0026[T::AccountId]) {\n\t\tif !members.is_empty() {\n\t\t\tassert!(Members::\u003cT, I\u003e::get().0.is_empty(), \"Members are already initialized!\");\n\t\t\tMembers::\u003cT, I\u003e::put(OrderedSet::from_sorted_set(members.into()));\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e ChangeMembers\u003cT::AccountId\u003e for Module\u003cT, I\u003e {\n\tfn change_members_sorted(_incoming: \u0026[T::AccountId], outgoing: \u0026[T::AccountId], new: \u0026[T::AccountId]) {\n\t\t// remove session keys and its values\n\t\tfor removed in outgoing {\n\t\t\tRawValues::\u003cT, I\u003e::remove_prefix(removed);\n\t\t}\n\n\t\tMembers::\u003cT, I\u003e::put(OrderedSet::from_sorted_set(new.into()));\n\n\t\t// not bothering to track which key needs recompute, just update all\n\t\tIsUpdated::\u003cT, I\u003e::remove_all();\n\t}\n\n\tfn set_prime(_prime: Option\u003cT::AccountId\u003e) {\n\t\t// nothing\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e DataProvider\u003cT::OracleKey, T::OracleValue\u003e for Module\u003cT, I\u003e {\n\tfn get(key: \u0026T::OracleKey) -\u003e Option\u003cT::OracleValue\u003e {\n\t\tSelf::get(key).map(|timestamped_value| timestamped_value.value)\n\t}\n}\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e DataProviderExtended\u003cT::OracleKey, TimestampedValueOf\u003cT, I\u003e\u003e for Module\u003cT, I\u003e {\n\tfn get_no_op(key: \u0026T::OracleKey) -\u003e Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e {\n\t\tSelf::get_no_op(key)\n\t}\n\t#[allow(clippy::complexity)]\n\tfn get_all_values() -\u003e Vec\u003c(T::OracleKey, Option\u003cTimestampedValueOf\u003cT, I\u003e\u003e)\u003e {\n\t\tSelf::get_all_values()\n\t}\n}\n\nimpl\u003cT: Trait\u003cI\u003e, I: Instance\u003e DataFeeder\u003cT::OracleKey, T::OracleValue, T::AccountId\u003e for Module\u003cT, I\u003e {\n\tfn feed_value(who: T::AccountId, key: T::OracleKey, value: T::OracleValue) -\u003e DispatchResult {\n\t\tSelf::do_feed_values(who, vec![(key, value)])?;\n\t\tOk(())\n\t}\n}\n","traces":[{"line":95,"address":[5127896,5128210,5127822],"length":1,"stats":{"Line":2},"fn_name":null},{"line":102,"address":[5127827,5127970,5128605,5127777,5127586,5129101,5127653,5129235,5128115,5128012,5129417,5128739,5128055],"length":1,"stats":{"Line":6},"fn_name":null},{"line":106,"address":[4595488,4594912,4595248,4595573,4594709,4594421,4595536,4595264,4594656,4594832,4595717,4596149,4596437,4596005,4596064,4594944,4595808,4594112,4596256,4595120,4594240,4594400,4596208,4594133,4594368,4595056,4595285,4594080,4595552,4594384,4595376,4595776,4594336,4596240,4594512,4595200,4594224,4595632,4595824,4594768,4594976,4595429,4596384,4595392,4594480,4595088,4594277,4593968,4595232,4595104,4595696,4594565,4595920,4595952,4595141,4595968,4594688,4594816,4596416,4594528,4593989,4595664,4596400,4594997,4594624,4595861,4594192,4595408,4594960,4594256,4594048,4596112,4595344,4594096,4595984,4594544,4594853,4596096,4596272,4595520,4595680,4595840,4596128,4596352,4594672,4594800,4596293],"length":1,"stats":{"Line":186},"fn_name":"fmt"},{"line":133,"address":[5138462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[5131851],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[5138292,5137598,5138288,5138340,5137198,5137647,5137232,5138336,5137270],"length":1,"stats":{"Line":16},"fn_name":"{{closure}}\u003corml_oracle::mock::Test,orml_oracle::DefaultInstance\u003e"},{"line":148,"address":[5137751,5137812,5137932,5137511],"length":1,"stats":{"Line":7},"fn_name":null},{"line":149,"address":[5137781,5137937],"length":1,"stats":{"Line":14},"fn_name":null},{"line":159,"address":[5135071],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":166,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":167,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":177,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":178,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":179,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":182,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":183,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":184,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":191,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":192,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":201,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":202,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":203,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":205,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":211,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":212,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":215,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":218,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":219,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":224,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":225,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":229,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":231,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":234,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":235,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":237,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":239,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":240,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":245,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":254,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":256,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":257,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":260,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":263,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":272,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":277,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":278,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":282,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":50,"coverable":68},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","mock.rs"],"content":"#![cfg(test)]\n\nuse super::*;\n\nuse frame_support::{impl_outer_dispatch, impl_outer_event, impl_outer_origin, parameter_types, weights::Weight};\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{BlakeTwo256, IdentityLookup},\n\tPerbill,\n};\n\nuse std::cell::RefCell;\n\nmod oracle {\n\tpub use super::super::*;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\toracle\u003cT\u003e,\n\t}\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\nimpl_outer_dispatch! {\n\tpub enum Call for Test where origin: Origin {\n\t\toracle::ModuleOracle,\n\t}\n}\n\npub type AccountId = u128;\ntype Key = u32;\ntype Value = u32;\n\n// For testing the module, we construct most of a mock runtime. This means\n// first constructing a configuration type (`Test`) which `impl`s each of the\n// configuration traits of modules we want to use.\n#[derive(Clone, Eq, PartialEq, Debug)]\npub struct Test;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: Weight = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n}\nimpl frame_system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Call = Call;\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cTest\u003e;\n\nthread_local! {\n\tstatic TIME: RefCell\u003cu32\u003e = RefCell::new(0);\n}\n\npub struct Timestamp;\nimpl Time for Timestamp {\n\ttype Moment = u32;\n\n\tfn now() -\u003e Self::Moment {\n\t\tTIME.with(|v| *v.borrow())\n\t}\n}\n\nimpl Timestamp {\n\tpub fn set_timestamp(val: u32) {\n\t\tTIME.with(|v| *v.borrow_mut() = val);\n\t}\n}\n\nparameter_types! {\n\tpub const MinimumCount: u32 = 3;\n\tpub const ExpiresIn: u32 = 600;\n\tpub const RootOperatorAccountId: AccountId = 4;\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype OnNewData = ();\n\ttype CombineData = DefaultCombineData\u003cSelf, MinimumCount, ExpiresIn\u003e;\n\ttype Time = Timestamp;\n\ttype OracleKey = Key;\n\ttype OracleValue = Value;\n\ttype RootOperatorAccountId = RootOperatorAccountId;\n\ttype WeightInfo = ();\n}\n\npub type ModuleOracle = Module\u003cTest\u003e;\n// This function basically just builds a genesis storage key/value store\n// according to our desired mockup.\npub fn new_test_ext() -\u003e sp_io::TestExternalities {\n\tlet mut storage = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\tlet _ = GenesisConfig::\u003cTest\u003e {\n\t\tmembers: vec![1, 2, 3].into(),\n\t\tphantom: Default::default(),\n\t}\n\t.assimilate_storage(\u0026mut storage);\n\n\tlet mut t: sp_io::TestExternalities = storage.into();\n\n\tt.execute_with(|| {\n\t\tTimestamp::set_timestamp(12345);\n\t});\n\n\tt\n}\n","traces":[{"line":19,"address":[4814904,4815804,4815430,4814729,4815232,4814867,4815710,4815050],"length":1,"stats":{"Line":6},"fn_name":null},{"line":21,"address":[4814881,4815161,4815207,4814939],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[4815246,4815538,4815586,4815319],"length":1,"stats":{"Line":2},"fn_name":null},{"line":26,"address":[4815920,4815989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[4663633],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[4663670],"length":1,"stats":{"Line":8},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":89,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":94,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":95,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":119,"address":[4656671,4656624],"length":1,"stats":{"Line":6},"fn_name":"new_test_ext"},{"line":120,"address":[4656699,4656634],"length":1,"stats":{"Line":13},"fn_name":null},{"line":123,"address":[4656783],"length":1,"stats":{"Line":8},"fn_name":null},{"line":124,"address":[4656881],"length":1,"stats":{"Line":8},"fn_name":null},{"line":126,"address":[4656966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[4657014],"length":1,"stats":{"Line":8},"fn_name":null},{"line":130,"address":[4657112],"length":1,"stats":{"Line":16},"fn_name":null},{"line":131,"address":[4814593],"length":1,"stats":{"Line":8},"fn_name":null}],"covered":14,"coverable":18},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","oracle","src","tests.rs"],"content":"#![cfg(test)]\n\nuse crate::{\n\tmock::{new_test_ext, AccountId, ModuleOracle, Origin, RootOperatorAccountId, System, Test, TestEvent, Timestamp},\n\tError, RawEvent, TimestampedValue,\n};\nuse frame_support::{\n\tassert_noop, assert_ok,\n\ttraits::{ChangeMembers, OnFinalize},\n\tweights::Pays,\n};\n\n#[test]\nfn should_feed_values_from_member() {\n\tnew_test_ext().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\t\tlet account_id: AccountId = 1;\n\n\t\tassert_noop!(\n\t\t\tModuleOracle::feed_values(Origin::signed(5), vec![(50, 1000), (51, 900), (52, 800)]),\n\t\t\tError::\u003cTest, _\u003e::NoPermission,\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::feed_values(Origin::signed(account_id), vec![(50, 1000), (51, 900), (52, 800)])\n\t\t\t\t.unwrap()\n\t\t\t\t.pays_fee,\n\t\t\tPays::No\n\t\t);\n\n\t\tlet new_feed_data_event = TestEvent::oracle(RawEvent::NewFeedData(1, vec![(50, 1000), (51, 900), (52, 800)]));\n\t\tassert!(System::events()\n\t\t\t.iter()\n\t\t\t.any(|record| record.event == new_feed_data_event));\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026account_id, \u002650),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 1000,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026account_id, \u002651),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 900,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026account_id, \u002652),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 800,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn should_feed_values_from_root() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet root_feeder: AccountId = RootOperatorAccountId::get();\n\n\t\tassert_ok!(ModuleOracle::feed_values(\n\t\t\tOrigin::root(),\n\t\t\tvec![(50, 1000), (51, 900), (52, 800)]\n\t\t));\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026root_feeder, \u002650),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 1000,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026root_feeder, \u002651),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 900,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::raw_values(\u0026root_feeder, \u002652),\n\t\t\tSome(TimestampedValue {\n\t\t\t\tvalue: 800,\n\t\t\t\ttimestamp: 12345,\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn should_update_is_updated() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet key: u32 = 50;\n\t\tassert_eq!(ModuleOracle::is_updated(key), false);\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(key, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(key, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(key, 1000)]));\n\t\tassert_eq!(ModuleOracle::is_updated(key), false);\n\t\tassert_eq!(\n\t\t\tModuleOracle::get(\u0026key).unwrap(),\n\t\t\tTimestampedValue {\n\t\t\t\tvalue: 1000,\n\t\t\t\ttimestamp: 12345\n\t\t\t}\n\t\t);\n\t\tassert_eq!(ModuleOracle::is_updated(key), true);\n\t\tModuleOracle::on_finalize(1);\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(key, 1000)]));\n\t\tassert_eq!(ModuleOracle::is_updated(key), false);\n\t});\n}\n\n#[test]\nfn should_read_raw_values() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet key: u32 = 50;\n\n\t\tlet raw_values = ModuleOracle::read_raw_values(\u0026key);\n\t\tassert_eq!(raw_values, vec![]);\n\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(key, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(key, 1200)]));\n\n\t\tlet raw_values = ModuleOracle::read_raw_values(\u0026key);\n\t\tassert_eq!(\n\t\t\traw_values,\n\t\t\tvec![\n\t\t\t\tTimestampedValue {\n\t\t\t\t\tvalue: 1000,\n\t\t\t\t\ttimestamp: 12345,\n\t\t\t\t},\n\t\t\t\tTimestampedValue {\n\t\t\t\t\tvalue: 1200,\n\t\t\t\t\ttimestamp: 12345,\n\t\t\t\t},\n\t\t\t]\n\t\t);\n\t});\n}\n\n#[test]\nfn should_combined_data() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet key: u32 = 50;\n\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(key, 1300)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(key, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(key, 1200)]));\n\n\t\tlet expected = Some(TimestampedValue {\n\t\t\tvalue: 1200,\n\t\t\ttimestamp: 12345,\n\t\t});\n\n\t\tassert_eq!(ModuleOracle::get(\u0026key), expected);\n\n\t\tTimestamp::set_timestamp(23456);\n\n\t\tassert_eq!(ModuleOracle::get(\u0026key), expected);\n\t});\n}\n\n#[test]\nfn should_return_none_for_non_exist_key() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_eq!(ModuleOracle::get(\u002650), None);\n\t});\n}\n\n#[test]\nfn multiple_calls_should_fail() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(50, 1300)]));\n\t\tassert_noop!(\n\t\t\tModuleOracle::feed_values(Origin::signed(1), vec![(50, 1300)]),\n\t\t\tError::\u003cTest, _\u003e::AlreadyFeeded,\n\t\t);\n\n\t\tModuleOracle::on_finalize(1);\n\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(50, 1300)]));\n\t});\n}\n\n#[test]\nfn get_all_values_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet eur: u32 = 1;\n\t\tlet jpy: u32 = 2;\n\n\t\tassert_eq!(ModuleOracle::get_all_values(), vec![]);\n\n\t\t// feed eur \u0026 jpy\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(eur, 1300)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(eur, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(jpy, 9000)]));\n\n\t\t// not enough eur \u0026 jpy prices\n\t\tassert_eq!(ModuleOracle::get(\u0026eur), None);\n\t\tassert_eq!(ModuleOracle::get(\u0026jpy), None);\n\t\tassert_eq!(ModuleOracle::get_all_values(), vec![]);\n\n\t\t// finalize block\n\t\tModuleOracle::on_finalize(1);\n\n\t\t// feed eur \u0026 jpy\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(eur, 1200)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(jpy, 8000)]));\n\n\t\t// enough eur prices\n\t\tlet eur_price = Some(TimestampedValue {\n\t\t\tvalue: 1200,\n\t\t\ttimestamp: 12345,\n\t\t});\n\t\tassert_eq!(ModuleOracle::get(\u0026eur), eur_price);\n\n\t\t// not enough jpy prices\n\t\tassert_eq!(ModuleOracle::get(\u0026jpy), None);\n\n\t\tassert_eq!(ModuleOracle::get_all_values(), vec![(eur, eur_price)]);\n\n\t\t// feed jpy\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(jpy, 7000)]));\n\n\t\t// enough jpy prices\n\t\tlet jpy_price = Some(TimestampedValue {\n\t\t\tvalue: 8000,\n\t\t\ttimestamp: 12345,\n\t\t});\n\t\tassert_eq!(ModuleOracle::get(\u0026jpy), jpy_price);\n\n\t\tassert_eq!(ModuleOracle::get_all_values(), vec![(eur, eur_price), (jpy, jpy_price)]);\n\t});\n}\n\n#[test]\nfn change_member_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\t\u003cModuleOracle as ChangeMembers\u003cAccountId\u003e\u003e::change_members_sorted(\u0026[4], \u0026[1], \u0026[2, 3, 4]);\n\t\tassert_noop!(\n\t\t\tModuleOracle::feed_values(Origin::signed(1), vec![(50, 1000)]),\n\t\t\tError::\u003cTest, _\u003e::NoPermission,\n\t\t);\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(50, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(4), vec![(50, 1000)]));\n\t});\n}\n\n#[test]\nfn should_clear_is_updated_on_change_member() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(50, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(50, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(3), vec![(50, 1000)]));\n\n\t\tassert_eq!(\n\t\t\tModuleOracle::get(\u002650).unwrap(),\n\t\t\tTimestampedValue {\n\t\t\t\tvalue: 1000,\n\t\t\t\ttimestamp: 12345\n\t\t\t}\n\t\t);\n\t\tassert_eq!(ModuleOracle::is_updated(50), true);\n\n\t\tModuleOracle::change_members_sorted(\u0026[4], \u0026[1], \u0026[2, 3, 4]);\n\n\t\tassert_eq!(ModuleOracle::is_updated(50), false);\n\t});\n}\n\n#[test]\nfn should_clear_data_for_removed_members() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(1), vec![(50, 1000)]));\n\t\tassert_ok!(ModuleOracle::feed_values(Origin::signed(2), vec![(50, 1000)]));\n\n\t\tModuleOracle::change_members_sorted(\u0026[4], \u0026[1], \u0026[2, 3, 4]);\n\n\t\tassert_eq!(ModuleOracle::raw_values(\u00261, 50), None);\n\t});\n}\n","traces":[{"line":14,"address":[4301936,4301941],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":15,"address":[4302051,4302016],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":16,"address":[4302023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[4302066],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[4302090,4302389],"length":1,"stats":{"Line":2},"fn_name":null},{"line":20,"address":[4306518,4302121,4302318],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4302381],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[4303794,4304084],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[4306544,4303496],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4303920,4304436],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[4304560,4304632,4304718,4304830],"length":1,"stats":{"Line":3},"fn_name":null},{"line":34,"address":[4301968,4304710,4301982],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":36,"address":[4305095,4304934],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[4304792,4304871],"length":1,"stats":{"Line":2},"fn_name":null},{"line":44,"address":[4305679,4305518],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4305046,4305455],"length":1,"stats":{"Line":2},"fn_name":null},{"line":52,"address":[4306078,4306198],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[4305630,4306015],"length":1,"stats":{"Line":2},"fn_name":null},{"line":63,"address":[4306704,4306709],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":64,"address":[4306774,4306736],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":65,"address":[4306743],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[4307039,4306992],"length":1,"stats":{"Line":2},"fn_name":null},{"line":68,"address":[4306789],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4306820],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4307523,4307342],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[4307270],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[4307831,4308006],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[4307445],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4308284,4308388],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[4307928],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4308709,4308704],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":100,"address":[4308736,4308809],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":101,"address":[4308743],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4308786,4308832,4308972],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[4312606,4308922,4309275],"length":1,"stats":{"Line":2},"fn_name":null},{"line":104,"address":[4309644,4312632],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[4310053,4312658],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[4310659,4310462],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[4311130,4310993],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[4310952,4310589],"length":1,"stats":{"Line":2},"fn_name":null},{"line":114,"address":[4311096,4311559,4311439],"length":1,"stats":{"Line":2},"fn_name":null},{"line":115,"address":[4311529],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[4312684,4311828],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[4312346,4312213],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[4312800,4312805],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":123,"address":[4312889,4312832],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":124,"address":[4312839],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[4312866],"length":1,"stats":{"Line":1},"fn_name":null},{"line":127,"address":[4313044,4312912],"length":1,"stats":{"Line":2},"fn_name":null},{"line":129,"address":[4313462,4314843],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4313851,4314869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[4314221],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[4314375],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[4314238,4314287],"length":1,"stats":{"Line":2},"fn_name":null},{"line":136,"address":[4314243],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[4314265],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[4315029,4315024],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":151,"address":[4315056,4315130],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":152,"address":[4315063],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[4315155,4315098,4317295],"length":1,"stats":{"Line":2},"fn_name":null},{"line":155,"address":[4317321,4315521],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[4315930,4317347],"length":1,"stats":{"Line":1},"fn_name":null},{"line":158,"address":[4316339],"length":1,"stats":{"Line":1},"fn_name":null},{"line":163,"address":[4316408,4316586],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[4316563],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[4316865,4317027],"length":1,"stats":{"Line":1},"fn_name":null},{"line":172,"address":[4317445,4317440],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":173,"address":[4317472],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":174,"address":[4317479,4317626],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[4317893,4317888],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":180,"address":[4317920,4317983],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":181,"address":[4318008,4317927,4320023],"length":1,"stats":{"Line":2},"fn_name":null},{"line":182,"address":[4318586,4318371],"length":1,"stats":{"Line":2},"fn_name":null},{"line":183,"address":[4320049,4318402,4318515],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[4318578],"length":1,"stats":{"Line":1},"fn_name":null},{"line":187,"address":[4319626],"length":1,"stats":{"Line":1},"fn_name":null},{"line":189,"address":[4320075,4319650],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[4320213,4320208],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":195,"address":[4320240,4320332],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":196,"address":[4320247],"length":1,"stats":{"Line":1},"fn_name":null},{"line":197,"address":[4320306],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[4320317,4320355],"length":1,"stats":{"Line":2},"fn_name":null},{"line":202,"address":[4320901,4327825],"length":1,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[4321310,4327851],"length":1,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[4327877,4321719],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[4322367,4322136],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[4322304,4322675,4322804],"length":1,"stats":{"Line":2},"fn_name":null},{"line":209,"address":[4322778,4323113],"length":1,"stats":{"Line":2},"fn_name":null},{"line":212,"address":[4323659],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[4323669,4327903],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4324078,4327929],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[4324487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[4324788,4324556],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[4325096,4325225,4324725],"length":1,"stats":{"Line":2},"fn_name":null},{"line":228,"address":[4325536,4325199],"length":1,"stats":{"Line":2},"fn_name":null},{"line":231,"address":[4327955,4326189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":234,"address":[4326598],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[4326854,4326667],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[4327147,4326828],"length":1,"stats":{"Line":2},"fn_name":null},{"line":245,"address":[4328272,4328277],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":246,"address":[4328304,4328402],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":247,"address":[4328332],"length":1,"stats":{"Line":1},"fn_name":null},{"line":248,"address":[4328417,4328632],"length":1,"stats":{"Line":2},"fn_name":null},{"line":249,"address":[4328448,4328561,4330443],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[4328624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[4329702,4330469],"length":1,"stats":{"Line":1},"fn_name":null},{"line":253,"address":[4330070,4330495],"length":1,"stats":{"Line":1},"fn_name":null},{"line":258,"address":[4330629,4330624],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":259,"address":[4330656,4330719],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":260,"address":[4330663,4330744,4333278],"length":1,"stats":{"Line":2},"fn_name":null},{"line":261,"address":[4333304,4331107],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[4333330,4331513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[4332152,4332017],"length":1,"stats":{"Line":1},"fn_name":null},{"line":265,"address":[4331919],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[4332461,4332627,4332120],"length":1,"stats":{"Line":2},"fn_name":null},{"line":273,"address":[4332569],"length":1,"stats":{"Line":1},"fn_name":null},{"line":275,"address":[4333018,4332887],"length":1,"stats":{"Line":1},"fn_name":null},{"line":280,"address":[4333424,4333429],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":281,"address":[4333511,4333456],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":282,"address":[4333463,4333536,4334775],"length":1,"stats":{"Line":2},"fn_name":null},{"line":283,"address":[4333893,4334801],"length":1,"stats":{"Line":1},"fn_name":null},{"line":285,"address":[4334296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":287,"address":[4334507,4334334],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":123,"coverable":123},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","rewards","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn on_initialize(c: u32) -\u003e Weight {\n\t\t(33_360_000 as Weight)\n\t\t\t.saturating_add((23_139_000 as Weight).saturating_mul(c as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads((1 as Weight).saturating_mul(c as Weight)))\n\t}\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":10,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":5},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","rewards","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode, FullCodec, HasCompact};\nuse frame_support::{decl_module, decl_storage, weights::Weight, Parameter};\nuse orml_traits::RewardHandler;\nuse sp_runtime::{\n\ttraits::{AtLeast32BitUnsigned, MaybeSerializeDeserialize, Member, Saturating, Zero},\n\tFixedPointNumber, FixedPointOperand, FixedU128, RuntimeDebug,\n};\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tfmt::Debug,\n};\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn on_initialize(c: u32) -\u003e Weight;\n}\n\n/// The Reward Pool Info.\n#[derive(Clone, Encode, Decode, PartialEq, Eq, RuntimeDebug, Default)]\npub struct PoolInfo\u003cShare: HasCompact, Balance: HasCompact\u003e {\n\t/// Total shares amount\n\t#[codec(compact)]\n\tpub total_shares: Share,\n\t/// Total rewards amount\n\t#[codec(compact)]\n\tpub total_rewards: Balance,\n\t/// Total withdrawn rewards amount\n\t#[codec(compact)]\n\tpub total_withdrawn_rewards: Balance,\n}\n\npub trait Trait: frame_system::Trait {\n\t/// The share type of pool.\n\ttype Share: Parameter\n\t\t+ Member\n\t\t+ AtLeast32BitUnsigned\n\t\t+ Default\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ FixedPointOperand;\n\n\t/// The reward balance type.\n\ttype Balance: Parameter\n\t\t+ Member\n\t\t+ AtLeast32BitUnsigned\n\t\t+ Default\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ FixedPointOperand;\n\n\t/// The reward pool ID type.\n\ttype PoolId: Parameter + Member + Copy + FullCodec;\n\n\t/// The `RewardHandler`\n\ttype Handler: RewardHandler\u003c\n\t\tSelf::AccountId,\n\t\tSelf::BlockNumber,\n\t\tShare = Self::Share,\n\t\tBalance = Self::Balance,\n\t\tPoolId = Self::PoolId,\n\t\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Rewards {\n\t\t/// Stores reward pool info.\n\t\tpub Pools get(fn pools): map hasher(twox_64_concat) T::PoolId =\u003e PoolInfo\u003cT::Share, T::Balance\u003e;\n\n\t\t/// Record share amount and withdrawn reward amount for specific `AccountId` under `PoolId`.\n\t\tpub ShareAndWithdrawnReward get(fn share_and_withdrawn_reward): double_map hasher(twox_64_concat) T::PoolId, hasher(twox_64_concat) T::AccountId =\u003e (T::Share, T::Balance);\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\n\t\tfn on_initialize(now: T::BlockNumber) -\u003e Weight {\n\t\t\tlet mut count = 0;\n\t\t\tT::Handler::accumulate_reward(now, | pool, reward_to_accumulate | {\n\t\t\t\tif !reward_to_accumulate.is_zero() {\n\t\t\t\t\tcount += 1;\n\t\t\t\t\tPools::\u003cT\u003e::mutate(pool, | pool_info | pool_info.total_rewards = pool_info.total_rewards.saturating_add(reward_to_accumulate));\n\t\t\t\t}\n\t\t\t});\n\t\t\tT::WeightInfo::on_initialize(count)\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tpub fn add_share(who: \u0026T::AccountId, pool: T::PoolId, add_amount: T::Share) {\n\t\tif add_amount.is_zero() {\n\t\t\treturn;\n\t\t}\n\n\t\tPools::\u003cT\u003e::mutate(pool, |pool_info| {\n\t\t\tlet proportion = FixedU128::checked_from_rational(add_amount, pool_info.total_shares).unwrap_or_default();\n\t\t\tlet reward_inflation = proportion.saturating_mul_int(pool_info.total_rewards);\n\n\t\t\tpool_info.total_shares = pool_info.total_shares.saturating_add(add_amount);\n\t\t\tpool_info.total_rewards = pool_info.total_rewards.saturating_add(reward_inflation);\n\t\t\tpool_info.total_withdrawn_rewards = pool_info.total_withdrawn_rewards.saturating_add(reward_inflation);\n\n\t\t\tShareAndWithdrawnReward::\u003cT\u003e::mutate(pool, who, |(share, withdrawn_rewards)| {\n\t\t\t\t*share = share.saturating_add(add_amount);\n\t\t\t\t*withdrawn_rewards = withdrawn_rewards.saturating_add(reward_inflation);\n\t\t\t});\n\t\t});\n\t}\n\n\tpub fn remove_share(who: \u0026T::AccountId, pool: T::PoolId, remove_amount: T::Share) {\n\t\tif remove_amount.is_zero() {\n\t\t\treturn;\n\t\t}\n\n\t\t// claim rewards firstly\n\t\tSelf::claim_rewards(who, pool);\n\n\t\tShareAndWithdrawnReward::\u003cT\u003e::mutate(pool, who, |(share, withdrawn_rewards)| {\n\t\t\tlet remove_amount = remove_amount.min(*share);\n\n\t\t\tif remove_amount.is_zero() {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPools::\u003cT\u003e::mutate(pool, |pool_info| {\n\t\t\t\tlet proportion = FixedU128::checked_from_rational(remove_amount, *share).unwrap_or_default();\n\t\t\t\tlet withdrawn_rewards_to_remove = proportion.saturating_mul_int(*withdrawn_rewards);\n\n\t\t\t\tpool_info.total_shares = pool_info.total_shares.saturating_sub(remove_amount);\n\t\t\t\tpool_info.total_rewards = pool_info.total_rewards.saturating_sub(withdrawn_rewards_to_remove);\n\t\t\t\tpool_info.total_withdrawn_rewards = pool_info\n\t\t\t\t\t.total_withdrawn_rewards\n\t\t\t\t\t.saturating_sub(withdrawn_rewards_to_remove);\n\n\t\t\t\t*withdrawn_rewards = withdrawn_rewards.saturating_sub(withdrawn_rewards_to_remove);\n\t\t\t});\n\n\t\t\t*share = share.saturating_sub(remove_amount);\n\t\t});\n\t}\n\n\tpub fn set_share(who: \u0026T::AccountId, pool: T::PoolId, new_share: T::Share) {\n\t\tlet (share, _) = Self::share_and_withdrawn_reward(pool, who);\n\n\t\tif new_share \u003e share {\n\t\t\tSelf::add_share(who, pool, new_share.saturating_sub(share));\n\t\t} else {\n\t\t\tSelf::remove_share(who, pool, share.saturating_sub(new_share));\n\t\t}\n\t}\n\n\tpub fn claim_rewards(who: \u0026T::AccountId, pool: T::PoolId) {\n\t\tShareAndWithdrawnReward::\u003cT\u003e::mutate(pool, who, |(share, withdrawn_rewards)| {\n\t\t\tif share.is_zero() {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPools::\u003cT\u003e::mutate(pool, |pool_info| {\n\t\t\t\tlet proportion = FixedU128::checked_from_rational(*share, pool_info.total_shares).unwrap_or_default();\n\t\t\t\tlet reward_to_withdraw = proportion\n\t\t\t\t\t.saturating_mul_int(pool_info.total_rewards)\n\t\t\t\t\t.saturating_sub(*withdrawn_rewards)\n\t\t\t\t\t.min(\n\t\t\t\t\t\tpool_info\n\t\t\t\t\t\t\t.total_rewards\n\t\t\t\t\t\t\t.saturating_sub(pool_info.total_withdrawn_rewards),\n\t\t\t\t\t);\n\n\t\t\t\tif reward_to_withdraw.is_zero() {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tpool_info.total_withdrawn_rewards =\n\t\t\t\t\tpool_info.total_withdrawn_rewards.saturating_add(reward_to_withdraw);\n\t\t\t\t*withdrawn_rewards = withdrawn_rewards.saturating_add(reward_to_withdraw);\n\n\t\t\t\t// pay reward to `who`\n\t\t\t\tT::Handler::payout(who, pool, reward_to_withdraw);\n\t\t\t});\n\t\t});\n\t}\n}\n","traces":[{"line":101,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":54},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","rewards","src","mock.rs"],"content":"//! Mocks for the rewards module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{impl_outer_origin, parameter_types};\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\nuse sp_std::cell::RefCell;\nuse std::collections::HashMap;\n\npub type AccountId = u128;\npub type Balance = u64;\npub type Share = u64;\npub type PoolId = u32;\npub type BlockNumber = u64;\npub type CurrencyId = u32;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const CAROL: AccountId = 3;\npub const DOT_POOL: PoolId = 1;\npub const BTC_POOL: PoolId = 2;\npub const XBTC_POOL: PoolId = 3;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\n\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Call = ();\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = ();\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nthread_local! {\n\tpub static RECEIVED_PAYOUT: RefCell\u003cHashMap\u003c(PoolId, AccountId), Balance\u003e\u003e = RefCell::new(HashMap::new());\n}\n\npub struct Handler;\nimpl RewardHandler\u003cAccountId, BlockNumber\u003e for Handler {\n\ttype Share = Share;\n\ttype Balance = Balance;\n\ttype PoolId = PoolId;\n\ttype CurrencyId = CurrencyId;\n\n\tfn accumulate_reward(\n\t\tnow: BlockNumber,\n\t\tmut callback: impl FnMut(Self::PoolId, Self::Balance),\n\t) -\u003e Vec\u003c(Self::CurrencyId, Self::Balance)\u003e {\n\t\tif now % 2 == 0 {\n\t\t\tlet mut total_accumulated_rewards = 0;\n\t\t\tlet valid_pool_ids = vec![DOT_POOL, BTC_POOL];\n\n\t\t\tfor (pool, _) in Pools::\u003cRuntime\u003e::iter() {\n\t\t\t\tif valid_pool_ids.contains(\u0026pool) {\n\t\t\t\t\tlet rewards: Balance = 100;\n\t\t\t\t\tcallback(pool, rewards);\n\t\t\t\t\ttotal_accumulated_rewards += rewards;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvec![(1, total_accumulated_rewards)]\n\t\t} else {\n\t\t\tvec![]\n\t\t}\n\t}\n\n\tfn payout(who: \u0026AccountId, pool: Self::PoolId, amount: Self::Balance) {\n\t\tRECEIVED_PAYOUT.with(|v| {\n\t\t\tlet mut old_map = v.borrow().clone();\n\t\t\tif let Some(before) = old_map.get_mut(\u0026(pool, *who)) {\n\t\t\t\t*before += amount;\n\t\t\t} else {\n\t\t\t\told_map.insert((pool, *who), amount);\n\t\t\t};\n\n\t\t\t*v.borrow_mut() = old_map;\n\t\t});\n\t}\n}\n\nimpl Trait for Runtime {\n\ttype Share = Share;\n\ttype Balance = Balance;\n\ttype PoolId = PoolId;\n\ttype Handler = Handler;\n\ttype WeightInfo = ();\n}\npub type RewardsModule = Module\u003cRuntime\u003e;\n\npub struct ExtBuilder;\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tExtBuilder\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[{"line":80,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":23},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","rewards","src","tests.rs"],"content":"//! Unit tests for the rewards module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::traits::OnInitialize;\nuse mock::*;\n\n#[test]\nfn add_share_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (0, 0));\n\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 0);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (0, 0));\n\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 100);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 5000;\n\t\t\tpool_info.total_withdrawn_rewards += 2000;\n\t\t});\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 5000,\n\t\t\t\ttotal_withdrawn_rewards: 2000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (0, 0));\n\n\t\tRewardsModule::add_share(\u0026BOB, DOT_POOL, 50);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 150,\n\t\t\t\ttotal_rewards: 7500,\n\t\t\t\ttotal_withdrawn_rewards: 4500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (50, 2500));\n\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 150);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 300,\n\t\t\t\ttotal_rewards: 15000,\n\t\t\t\ttotal_withdrawn_rewards: 12000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (250, 7500));\n\t});\n}\n\n#[test]\nfn claim_rewards_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 100);\n\t\tRewardsModule::add_share(\u0026BOB, DOT_POOL, 100);\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 5000;\n\t\t});\n\t\tRewardsModule::add_share(\u0026CAROL, DOT_POOL, 200);\n\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 400,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 5000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (100, 0));\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, CAROL), (200, 5000));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, BOB)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, CAROL)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\tRewardsModule::claim_rewards(\u0026ALICE, DOT_POOL);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 400,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 7500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 2500));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t2500\n\t\t);\n\n\t\tRewardsModule::claim_rewards(\u0026CAROL, DOT_POOL);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 400,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 7500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, CAROL), (200, 5000));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, CAROL)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\tRewardsModule::claim_rewards(\u0026BOB, DOT_POOL);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 400,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 10000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (100, 2500));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, BOB)).unwrap_or(\u00260)),\n\t\t\t2500\n\t\t);\n\t});\n}\n\n#[test]\nfn remove_share_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tRewardsModule::add_share(\u0026ALICE, DOT_POOL, 100);\n\t\tRewardsModule::add_share(\u0026BOB, DOT_POOL, 100);\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 10000;\n\t\t});\n\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 200,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (100, 0));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, BOB)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\t// remove amount is zero, do not claim interest\n\t\tRewardsModule::remove_share(\u0026ALICE, DOT_POOL, 0);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 200,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\tRewardsModule::remove_share(\u0026BOB, DOT_POOL, 50);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 150,\n\t\t\t\ttotal_rewards: 7500,\n\t\t\t\ttotal_withdrawn_rewards: 2500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, BOB), (50, 2500));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, BOB)).unwrap_or(\u00260)),\n\t\t\t5000\n\t\t);\n\n\t\tRewardsModule::remove_share(\u0026ALICE, DOT_POOL, 101);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 50,\n\t\t\t\ttotal_rewards: 2501,\n\t\t\t\ttotal_withdrawn_rewards: 2500,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (0, 0));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t4999\n\t\t);\n\t});\n}\n\n#[test]\nfn set_share_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (0, 0));\n\n\t\tRewardsModule::set_share(\u0026ALICE, DOT_POOL, 100);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 0,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 0));\n\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 10000;\n\t\t});\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\n\t\tRewardsModule::set_share(\u0026ALICE, DOT_POOL, 500);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 500,\n\t\t\t\ttotal_rewards: 50000,\n\t\t\t\ttotal_withdrawn_rewards: 40000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (500, 40000));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t0\n\t\t);\n\n\t\tRewardsModule::set_share(\u0026ALICE, DOT_POOL, 100);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 100,\n\t\t\t\ttotal_rewards: 10000,\n\t\t\t\ttotal_withdrawn_rewards: 10000,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(RewardsModule::share_and_withdrawn_reward(DOT_POOL, ALICE), (100, 10000));\n\t\tassert_eq!(\n\t\t\tRECEIVED_PAYOUT.with(|v| *v.borrow().get(\u0026(DOT_POOL, ALICE)).unwrap_or(\u00260)),\n\t\t\t10000\n\t\t);\n\t});\n}\n\n#[test]\nfn on_initialize_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tPools::\u003cRuntime\u003e::mutate(DOT_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 100;\n\t\t});\n\t\tPools::\u003cRuntime\u003e::mutate(BTC_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 200;\n\t\t});\n\t\tPools::\u003cRuntime\u003e::mutate(XBTC_POOL, |pool_info| {\n\t\t\tpool_info.total_rewards += 300;\n\t\t});\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 100,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(BTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 200,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(XBTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 300,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\n\t\tRewardsModule::on_initialize(1);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 100,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(BTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 200,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(XBTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 300,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\n\t\tRewardsModule::on_initialize(2);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(DOT_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 200,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(BTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 300,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t\tassert_eq!(\n\t\t\tRewardsModule::pools(XBTC_POOL),\n\t\t\tPoolInfo {\n\t\t\t\ttotal_shares: 0,\n\t\t\t\ttotal_rewards: 300,\n\t\t\t\ttotal_withdrawn_rewards: 0,\n\t\t\t}\n\t\t);\n\t});\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn transfer() -\u003e Weight {\n\t\t(158_835_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(4 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n\tfn transfer_all() -\u003e Weight {\n\t\t(162_545_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(4 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(2 as Weight))\n\t}\n}\n","traces":[{"line":9,"address":[32472928],"length":1,"stats":{"Line":0},"fn_name":"transfer"},{"line":10,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[89565362],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[22765566,22765638],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":8},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","imbalances.rs"],"content":"// wrapping these imbalances in a private module is necessary to ensure absolute\n// privacy of the inner member.\nuse crate::{TotalIssuance, Trait};\nuse frame_support::storage::StorageMap;\nuse frame_support::traits::{Get, Imbalance, TryDrop};\nuse sp_runtime::traits::{Saturating, Zero};\nuse sp_std::{marker, mem, result};\n\n/// Opaque, move-only struct with private fields that serves as a token\n/// denoting that funds have been created without any equal and opposite\n/// accounting.\n#[must_use]\npub struct PositiveImbalance\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e(\n\tT::Balance,\n\tmarker::PhantomData\u003cGetCurrencyId\u003e,\n);\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e PositiveImbalance\u003cT, GetCurrencyId\u003e {\n\t/// Create a new positive imbalance from a balance.\n\tpub fn new(amount: T::Balance) -\u003e Self {\n\t\tPositiveImbalance(amount, marker::PhantomData::\u003cGetCurrencyId\u003e)\n\t}\n}\n\n/// Opaque, move-only struct with private fields that serves as a token\n/// denoting that funds have been destroyed without any equal and opposite\n/// accounting.\n#[must_use]\npub struct NegativeImbalance\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e(\n\tT::Balance,\n\tmarker::PhantomData\u003cGetCurrencyId\u003e,\n);\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e NegativeImbalance\u003cT, GetCurrencyId\u003e {\n\t/// Create a new negative imbalance from a balance.\n\tpub fn new(amount: T::Balance) -\u003e Self {\n\t\tNegativeImbalance(amount, marker::PhantomData::\u003cGetCurrencyId\u003e)\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e TryDrop for PositiveImbalance\u003cT, GetCurrencyId\u003e {\n\tfn try_drop(self) -\u003e result::Result\u003c(), Self\u003e {\n\t\tself.drop_zero()\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e Imbalance\u003cT::Balance\u003e for PositiveImbalance\u003cT, GetCurrencyId\u003e {\n\ttype Opposite = NegativeImbalance\u003cT, GetCurrencyId\u003e;\n\n\tfn zero() -\u003e Self {\n\t\tSelf::new(Zero::zero())\n\t}\n\tfn drop_zero(self) -\u003e result::Result\u003c(), Self\u003e {\n\t\tif self.0.is_zero() {\n\t\t\tOk(())\n\t\t} else {\n\t\t\tErr(self)\n\t\t}\n\t}\n\tfn split(self, amount: T::Balance) -\u003e (Self, Self) {\n\t\tlet first = self.0.min(amount);\n\t\tlet second = self.0 - first;\n\n\t\tmem::forget(self);\n\t\t(Self::new(first), Self::new(second))\n\t}\n\tfn merge(mut self, other: Self) -\u003e Self {\n\t\tself.0 = self.0.saturating_add(other.0);\n\t\tmem::forget(other);\n\n\t\tself\n\t}\n\tfn subsume(\u0026mut self, other: Self) {\n\t\tself.0 = self.0.saturating_add(other.0);\n\t\tmem::forget(other);\n\t}\n\tfn offset(self, other: Self::Opposite) -\u003e result::Result\u003cSelf, Self::Opposite\u003e {\n\t\tlet (a, b) = (self.0, other.0);\n\t\tmem::forget((self, other));\n\n\t\tif a \u003e= b {\n\t\t\tOk(Self::new(a - b))\n\t\t} else {\n\t\t\tErr(NegativeImbalance::new(b - a))\n\t\t}\n\t}\n\tfn peek(\u0026self) -\u003e T::Balance {\n\t\tself.0\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e TryDrop for NegativeImbalance\u003cT, GetCurrencyId\u003e {\n\tfn try_drop(self) -\u003e result::Result\u003c(), Self\u003e {\n\t\tself.drop_zero()\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e Imbalance\u003cT::Balance\u003e for NegativeImbalance\u003cT, GetCurrencyId\u003e {\n\ttype Opposite = PositiveImbalance\u003cT, GetCurrencyId\u003e;\n\n\tfn zero() -\u003e Self {\n\t\tSelf::new(Zero::zero())\n\t}\n\tfn drop_zero(self) -\u003e result::Result\u003c(), Self\u003e {\n\t\tif self.0.is_zero() {\n\t\t\tOk(())\n\t\t} else {\n\t\t\tErr(self)\n\t\t}\n\t}\n\tfn split(self, amount: T::Balance) -\u003e (Self, Self) {\n\t\tlet first = self.0.min(amount);\n\t\tlet second = self.0 - first;\n\n\t\tmem::forget(self);\n\t\t(Self::new(first), Self::new(second))\n\t}\n\tfn merge(mut self, other: Self) -\u003e Self {\n\t\tself.0 = self.0.saturating_add(other.0);\n\t\tmem::forget(other);\n\n\t\tself\n\t}\n\tfn subsume(\u0026mut self, other: Self) {\n\t\tself.0 = self.0.saturating_add(other.0);\n\t\tmem::forget(other);\n\t}\n\tfn offset(self, other: Self::Opposite) -\u003e result::Result\u003cSelf, Self::Opposite\u003e {\n\t\tlet (a, b) = (self.0, other.0);\n\t\tmem::forget((self, other));\n\n\t\tif a \u003e= b {\n\t\t\tOk(Self::new(a - b))\n\t\t} else {\n\t\t\tErr(PositiveImbalance::new(b - a))\n\t\t}\n\t}\n\tfn peek(\u0026self) -\u003e T::Balance {\n\t\tself.0\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e Drop for PositiveImbalance\u003cT, GetCurrencyId\u003e {\n\t/// Basic drop handler will just square up the total issuance.\n\tfn drop(\u0026mut self) {\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(GetCurrencyId::get(), |v| *v = v.saturating_add(self.0));\n\t}\n}\n\nimpl\u003cT: Trait, GetCurrencyId: Get\u003cT::CurrencyId\u003e\u003e Drop for NegativeImbalance\u003cT, GetCurrencyId\u003e {\n\t/// Basic drop handler will just square up the total issuance.\n\tfn drop(\u0026mut self) {\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(GetCurrencyId::get(), |v| *v = v.saturating_sub(self.0));\n\t}\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":21,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":36,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":146,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":152,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[],"length":0,"stats":{"Line":3},"fn_name":null}],"covered":10,"coverable":64},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","lib.rs"],"content":"//! # Tokens Module\n//!\n//! ## Overview\n//!\n//! The tokens module provides fungible multi-currency functionality that\n//! implements `MultiCurrency` trait.\n//!\n//! The tokens module provides functions for:\n//!\n//! - Querying and setting the balance of a given account.\n//! - Getting and managing total issuance.\n//! - Balance transfer between accounts.\n//! - Depositing and withdrawing balance.\n//! - Slashing an account balance.\n//!\n//! ### Implementations\n//!\n//! The tokens module provides implementations for following traits.\n//!\n//! - `MultiCurrency` - Abstraction over a fungible multi-currency system.\n//! - `MultiCurrencyExtended` - Extended `MultiCurrency` with additional helper\n//!   types and methods, like updating balance\n//! by a given signed integer amount.\n//!\n//! ## Interface\n//!\n//! ### Dispatchable Functions\n//!\n//! - `transfer` - Transfer some balance to another account.\n//! - `transfer_all` - Transfer all balance to another account.\n//!\n//! ### Genesis Config\n//!\n//! The tokens module depends on the `GenesisConfig`. Endowed accounts could be\n//! configured in genesis configs.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, ensure,\n\ttraits::Get,\n\ttraits::{\n\t\tBalanceStatus as Status, Currency as PalletCurrency, ExistenceRequirement, Imbalance,\n\t\tLockableCurrency as PalletLockableCurrency, ReservableCurrency as PalletReservableCurrency, SignedImbalance,\n\t\tWithdrawReasons,\n\t},\n\tweights::Weight,\n\tParameter, StorageMap,\n};\nuse frame_system::ensure_signed;\nuse sp_runtime::{\n\ttraits::{\n\t\tAtLeast32BitUnsigned, Bounded, CheckedAdd, CheckedSub, MaybeSerializeDeserialize, Member, Saturating,\n\t\tStaticLookup, Zero,\n\t},\n\tDispatchError, DispatchResult, RuntimeDebug,\n};\nuse sp_std::{\n\tconvert::{TryFrom, TryInto},\n\tmarker,\n\tprelude::*,\n\tresult,\n};\n\n#[cfg(feature = \"std\")]\nuse sp_std::collections::btree_map::BTreeMap;\n\npub use crate::imbalances::{NegativeImbalance, PositiveImbalance};\nuse orml_traits::{\n\tarithmetic::{self, Signed},\n\tBalanceStatus, LockIdentifier, MultiCurrency, MultiCurrencyExtended, MultiLockableCurrency,\n\tMultiReservableCurrency, OnReceived,\n};\n\nmod default_weight;\nmod imbalances;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn transfer() -\u003e Weight;\n\tfn transfer_all() -\u003e Weight;\n}\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// The balance type\n\ttype Balance: Parameter + Member + AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize;\n\n\t/// The amount type, should be signed version of `Balance`\n\ttype Amount: Signed\n\t\t+ TryInto\u003cSelf::Balance\u003e\n\t\t+ TryFrom\u003cSelf::Balance\u003e\n\t\t+ Parameter\n\t\t+ Member\n\t\t+ arithmetic::SimpleArithmetic\n\t\t+ Default\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize;\n\n\t/// The currency ID type\n\ttype CurrencyId: Parameter + Member + Copy + MaybeSerializeDeserialize + Ord;\n\n\t/// Hook when some fund is deposited into an account\n\ttype OnReceived: OnReceived\u003cSelf::AccountId, Self::CurrencyId, Self::Balance\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\n/// A single lock on a balance. There can be many of these on an account and\n/// they \"overlap\", so the same balance is frozen by multiple locks.\n#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug)]\npub struct BalanceLock\u003cBalance\u003e {\n\t/// An identifier for this lock. Only one lock may be in existence for each\n\t/// identifier.\n\tpub id: LockIdentifier,\n\t/// The amount which the free balance may not drop below when this lock is\n\t/// in effect.\n\tpub amount: Balance,\n}\n\n/// balance information for an account.\n#[derive(Encode, Decode, Clone, PartialEq, Eq, Default, RuntimeDebug)]\npub struct AccountData\u003cBalance\u003e {\n\t/// Non-reserved part of the balance. There may still be restrictions on\n\t/// this, but it is the total pool what may in principle be transferred,\n\t/// reserved.\n\t///\n\t/// This is the only balance that matters in terms of most operations on\n\t/// tokens.\n\tpub free: Balance,\n\t/// Balance which is reserved and may not be used at all.\n\t///\n\t/// This can still get slashed, but gets slashed last of all.\n\t///\n\t/// This balance is a 'reserve' balance that other subsystems use in order\n\t/// to set aside tokens that are still 'owned' by the account holder, but\n\t/// which are suspendable.\n\tpub reserved: Balance,\n\t/// The amount that `free` may not drop below when withdrawing.\n\tpub frozen: Balance,\n}\n\nimpl\u003cBalance: Saturating + Copy + Ord\u003e AccountData\u003cBalance\u003e {\n\t/// The amount that this account's free balance may not be reduced beyond.\n\tfn frozen(\u0026self) -\u003e Balance {\n\t\tself.frozen\n\t}\n\t/// The total balance in this account including any that is reserved and\n\t/// ignoring any frozen.\n\tfn total(\u0026self) -\u003e Balance {\n\t\tself.free.saturating_add(self.reserved)\n\t}\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Tokens {\n\t\t/// The total issuance of a token type.\n\t\tpub TotalIssuance get(fn total_issuance) build(|config: \u0026GenesisConfig\u003cT\u003e| {\n\t\t\tconfig\n\t\t\t\t.endowed_accounts\n\t\t\t\t.iter()\n\t\t\t\t.map(|(_, currency_id, initial_balance)| (currency_id, initial_balance))\n\t\t\t\t.fold(BTreeMap::\u003cT::CurrencyId, T::Balance\u003e::new(), |mut acc, (currency_id, initial_balance)| {\n\t\t\t\t\tif let Some(issuance) = acc.get_mut(currency_id) {\n\t\t\t\t\t\t*issuance = issuance.checked_add(initial_balance).expect(\"total issuance cannot overflow when building genesis\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\tacc.insert(*currency_id, *initial_balance);\n\t\t\t\t\t}\n\t\t\t\t\tacc\n\t\t\t\t})\n\t\t\t\t.into_iter()\n\t\t\t\t.collect::\u003cVec\u003c_\u003e\u003e()\n\t\t}): map hasher(twox_64_concat) T::CurrencyId =\u003e T::Balance;\n\n\t\t/// Any liquidity locks of a token type under an account.\n\t\t/// NOTE: Should only be accessed when setting, changing and freeing a lock.\n\t\tpub Locks get(fn locks): double_map hasher(blake2_128_concat) T::AccountId, hasher(twox_64_concat) T::CurrencyId =\u003e Vec\u003cBalanceLock\u003cT::Balance\u003e\u003e;\n\n\t\t/// The balance of a token type under an account.\n\t\t///\n\t\t/// NOTE: If the total is ever zero, decrease account ref account.\n\t\t///\n\t\t/// NOTE: This is only used in the case that this module is used to store balances.\n\t\tpub Accounts get(fn accounts): double_map hasher(blake2_128_concat) T::AccountId, hasher(twox_64_concat) T::CurrencyId =\u003e AccountData\u003cT::Balance\u003e;\n\t}\n\tadd_extra_genesis {\n\t\tconfig(endowed_accounts): Vec\u003c(T::AccountId, T::CurrencyId, T::Balance)\u003e;\n\n\t\tbuild(|config: \u0026GenesisConfig\u003cT\u003e| {\n\t\t\tconfig.endowed_accounts.iter().for_each(|(account_id, currency_id, initial_balance)| {\n\t\t\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(account_id, currency_id, |account_data| account_data.free = *initial_balance)\n\t\t\t})\n\t\t})\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\t\u003cT as Trait\u003e::CurrencyId,\n\t\t\u003cT as Trait\u003e::Balance\n\t{\n\t\t/// Token transfer success. [currency_id, from, to, amount]\n\t\tTransferred(CurrencyId, AccountId, AccountId, Balance),\n\t}\n);\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Transfer some balance to another account.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 4\n\t\t/// - Db writes: 2\n\t\t/// -------------------\n\t\t/// Base Weight: 84.08 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::transfer()]\n\t\tpub fn transfer(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: T::CurrencyId,\n\t\t\t#[compact] amount: T::Balance,\n\t\t) {\n\t\t\tlet from = ensure_signed(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\t\u003cSelf as MultiCurrency\u003c_\u003e\u003e::transfer(currency_id, \u0026from, \u0026to, amount)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Transferred(currency_id, from, to, amount));\n\t\t}\n\n\t\t/// Transfer all remaining balance to the given account.\n\t\t///\n\t\t/// The dispatch origin for this call must be `Signed` by the transactor.\n\t\t///\n\t\t/// # \u003cweight\u003e\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 4\n\t\t/// - Db writes: 2\n\t\t/// -------------------\n\t\t/// Base Weight: 87.71 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::transfer_all()]\n\t\tpub fn transfer_all(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: T::CurrencyId,\n\t\t) {\n\t\t\tlet from = ensure_signed(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\tlet balance = \u003cSelf as MultiCurrency\u003cT::AccountId\u003e\u003e::free_balance(currency_id, \u0026from);\n\t\t\t\u003cSelf as MultiCurrency\u003cT::AccountId\u003e\u003e::transfer(currency_id, \u0026from, \u0026to, balance)?;\n\n\t\t\tSelf::deposit_event(RawEvent::Transferred(currency_id, from, to, balance));\n\t\t}\n\t}\n}\n\ndecl_error! {\n\t/// Error for token module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The balance is too low\n\t\tBalanceTooLow,\n\t\t/// This operation will cause balance to overflow\n\t\tBalanceOverflow,\n\t\t/// This operation will cause total issuance to overflow\n\t\tTotalIssuanceOverflow,\n\t\t/// Cannot convert Amount into Balance type\n\t\tAmountIntoBalanceFailed,\n\t\t/// Failed because liquidity restrictions due to locking\n\t\tLiquidityRestrictions,\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Set free balance of `who` to a new value.\n\t///\n\t/// Note this will not maintain total issuance.\n\tfn set_free_balance(currency_id: T::CurrencyId, who: \u0026T::AccountId, balance: T::Balance) {\n\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(who, currency_id, |account_data| account_data.free = balance);\n\t}\n\n\t/// Set reserved balance of `who` to a new value, meanwhile enforce\n\t/// existential rule.\n\t///\n\t/// Note this will not maintain total issuance, and the caller is expected\n\t/// to do it.\n\tfn set_reserved_balance(currency_id: T::CurrencyId, who: \u0026T::AccountId, balance: T::Balance) {\n\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(who, currency_id, |account_data| account_data.reserved = balance);\n\t}\n\n\t/// Update the account entry for `who` under `currency_id`, given the locks.\n\tfn update_locks(currency_id: T::CurrencyId, who: \u0026T::AccountId, locks: \u0026[BalanceLock\u003cT::Balance\u003e]) {\n\t\t// update account data\n\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(who, currency_id, |account_data| {\n\t\t\taccount_data.frozen = Zero::zero();\n\t\t\tfor lock in locks.iter() {\n\t\t\t\taccount_data.frozen = account_data.frozen.max(lock.amount);\n\t\t\t}\n\t\t});\n\n\t\t// update locks\n\t\tlet existed = \u003cLocks\u003cT\u003e\u003e::contains_key(who, currency_id);\n\t\tif locks.is_empty() {\n\t\t\t\u003cLocks\u003cT\u003e\u003e::remove(who, currency_id);\n\t\t\tif existed {\n\t\t\t\t// decrease account ref count when destruct lock\n\t\t\t\tframe_system::Module::\u003cT\u003e::dec_ref(who);\n\t\t\t}\n\t\t} else {\n\t\t\t\u003cLocks\u003cT\u003e\u003e::insert(who, currency_id, locks);\n\t\t\tif !existed {\n\t\t\t\t// increase account ref count when initialize lock\n\t\t\t\tframe_system::Module::\u003cT\u003e::inc_ref(who);\n\t\t\t}\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype CurrencyId = T::CurrencyId;\n\ttype Balance = T::Balance;\n\n\tfn total_issuance(currency_id: Self::CurrencyId) -\u003e Self::Balance {\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::get(currency_id)\n\t}\n\n\tfn total_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tSelf::accounts(who, currency_id).total()\n\t}\n\n\tfn free_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tSelf::accounts(who, currency_id).free\n\t}\n\n\t// Ensure that an account can withdraw from their free balance given any\n\t// existing withdrawal restrictions like locks and vesting balance.\n\t// Is a no-op if amount to be withdrawn is zero.\n\tfn ensure_can_withdraw(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\tlet new_balance = Self::free_balance(currency_id, who)\n\t\t\t.checked_sub(\u0026amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::BalanceTooLow)?;\n\t\tensure!(\n\t\t\tnew_balance \u003e= Self::accounts(who, currency_id).frozen(),\n\t\t\tError::\u003cT\u003e::LiquidityRestrictions\n\t\t);\n\t\tOk(())\n\t}\n\n\t/// Transfer some free balance from `from` to `to`.\n\t/// Is a no-op if value to be transferred is zero or the `from` is the same\n\t/// as `to`.\n\tfn transfer(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tfrom: \u0026T::AccountId,\n\t\tto: \u0026T::AccountId,\n\t\tamount: Self::Balance,\n\t) -\u003e DispatchResult {\n\t\tif amount.is_zero() || from == to {\n\t\t\treturn Ok(());\n\t\t}\n\t\tSelf::ensure_can_withdraw(currency_id, from, amount)?;\n\n\t\tlet from_balance = Self::free_balance(currency_id, from);\n\t\tlet to_balance = Self::free_balance(currency_id, to)\n\t\t\t.checked_add(\u0026amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::BalanceOverflow)?;\n\t\t// Cannot underflow because ensure_can_withdraw check\n\t\tSelf::set_free_balance(currency_id, from, from_balance - amount);\n\t\tSelf::set_free_balance(currency_id, to, to_balance);\n\t\tT::OnReceived::on_received(to, currency_id, amount);\n\n\t\tOk(())\n\t}\n\n\t/// Deposit some `amount` into the free balance of account `who`.\n\t///\n\t/// Is a no-op if the `amount` to be deposited is zero.\n\tfn deposit(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\tlet new_total = Self::total_issuance(currency_id)\n\t\t\t.checked_add(\u0026amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::TotalIssuanceOverflow)?;\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::insert(currency_id, new_total);\n\t\tSelf::set_free_balance(currency_id, who, Self::free_balance(currency_id, who) + amount);\n\t\tT::OnReceived::on_received(who, currency_id, amount);\n\n\t\tOk(())\n\t}\n\n\tfn withdraw(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e DispatchResult {\n\t\tif amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\t\tSelf::ensure_can_withdraw(currency_id, who, amount)?;\n\n\t\t// Cannot underflow because ensure_can_withdraw check\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(currency_id, |v| *v -= amount);\n\t\tSelf::set_free_balance(currency_id, who, Self::free_balance(currency_id, who) - amount);\n\n\t\tOk(())\n\t}\n\n\t// Check if `value` amount of free balance can be slashed from `who`.\n\tfn can_slash(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tif value.is_zero() {\n\t\t\treturn true;\n\t\t}\n\t\tSelf::free_balance(currency_id, who) \u003e= value\n\t}\n\n\t/// Is a no-op if `value` to be slashed is zero.\n\t///\n\t/// NOTE: `slash()` prefers free balance, but assumes that reserve balance\n\t/// can be drawn from in extreme circumstances. `can_slash()` should be used\n\t/// prior to `slash()` to avoid having to draw from reserved funds, however\n\t/// we err on the side of punishment if things are inconsistent\n\t/// or `can_slash` wasn't used appropriately.\n\tfn slash(currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) -\u003e Self::Balance {\n\t\tif amount.is_zero() {\n\t\t\treturn amount;\n\t\t}\n\n\t\tlet account = Self::accounts(who, currency_id);\n\t\tlet free_slashed_amount = account.free.min(amount);\n\t\t// Cannot underflow becuase free_slashed_amount can never be greater than amount\n\t\tlet mut remaining_slash = amount - free_slashed_amount;\n\n\t\t// slash free balance\n\t\tif !free_slashed_amount.is_zero() {\n\t\t\t// Cannot underflow becuase free_slashed_amount can never be greater than\n\t\t\t// account.free\n\t\t\tSelf::set_free_balance(currency_id, who, account.free - free_slashed_amount);\n\t\t}\n\n\t\t// slash reserved balance\n\t\tif !remaining_slash.is_zero() {\n\t\t\tlet reserved_slashed_amount = account.reserved.min(remaining_slash);\n\t\t\t// Cannot underflow due to above line\n\t\t\tremaining_slash -= reserved_slashed_amount;\n\t\t\tSelf::set_reserved_balance(currency_id, who, account.reserved - reserved_slashed_amount);\n\t\t}\n\n\t\t// Cannot underflow because the slashed value cannot be greater than total\n\t\t// issuance\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(currency_id, |v| *v -= amount - remaining_slash);\n\t\tremaining_slash\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiCurrencyExtended\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype Amount = T::Amount;\n\n\tfn update_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId, by_amount: Self::Amount) -\u003e DispatchResult {\n\t\tif by_amount.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\t// Ensure this doesn't overflow. There isn't any traits that exposes\n\t\t// `saturating_abs` so we need to do it manually.\n\t\tlet by_amount_abs = if by_amount == Self::Amount::min_value() {\n\t\t\tSelf::Amount::max_value()\n\t\t} else {\n\t\t\tby_amount.abs()\n\t\t};\n\n\t\tlet by_balance =\n\t\t\tTryInto::\u003cSelf::Balance\u003e::try_into(by_amount_abs).map_err(|_| Error::\u003cT\u003e::AmountIntoBalanceFailed)?;\n\t\tif by_amount.is_positive() {\n\t\t\tSelf::deposit(currency_id, who, by_balance)\n\t\t} else {\n\t\t\tSelf::withdraw(currency_id, who, by_balance).map(|_| ())\n\t\t}\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiLockableCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\ttype Moment = T::BlockNumber;\n\n\t// Set a lock on the balance of `who` under `currency_id`.\n\t// Is a no-op if lock amount is zero.\n\tfn set_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\tif amount.is_zero() {\n\t\t\treturn;\n\t\t}\n\t\tlet mut new_lock = Some(BalanceLock { id: lock_id, amount });\n\t\tlet mut locks = Self::locks(who, currency_id)\n\t\t\t.into_iter()\n\t\t\t.filter_map(|lock| {\n\t\t\t\tif lock.id == lock_id {\n\t\t\t\t\tnew_lock.take()\n\t\t\t\t} else {\n\t\t\t\t\tSome(lock)\n\t\t\t\t}\n\t\t\t})\n\t\t\t.collect::\u003cVec\u003c_\u003e\u003e();\n\t\tif let Some(lock) = new_lock {\n\t\t\tlocks.push(lock)\n\t\t}\n\t\tSelf::update_locks(currency_id, who, \u0026locks[..]);\n\t}\n\n\t// Extend a lock on the balance of `who` under `currency_id`.\n\t// Is a no-op if lock amount is zero\n\tfn extend_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId, amount: Self::Balance) {\n\t\tif amount.is_zero() {\n\t\t\treturn;\n\t\t}\n\t\tlet mut new_lock = Some(BalanceLock { id: lock_id, amount });\n\t\tlet mut locks = Self::locks(who, currency_id)\n\t\t\t.into_iter()\n\t\t\t.filter_map(|lock| {\n\t\t\t\tif lock.id == lock_id {\n\t\t\t\t\tnew_lock.take().map(|nl| BalanceLock {\n\t\t\t\t\t\tid: lock.id,\n\t\t\t\t\t\tamount: lock.amount.max(nl.amount),\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\tSome(lock)\n\t\t\t\t}\n\t\t\t})\n\t\t\t.collect::\u003cVec\u003c_\u003e\u003e();\n\t\tif let Some(lock) = new_lock {\n\t\t\tlocks.push(lock)\n\t\t}\n\t\tSelf::update_locks(currency_id, who, \u0026locks[..]);\n\t}\n\n\tfn remove_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026T::AccountId) {\n\t\tlet mut locks = Self::locks(who, currency_id);\n\t\tlocks.retain(|lock| lock.id != lock_id);\n\t\tSelf::update_locks(currency_id, who, \u0026locks[..]);\n\t}\n}\n\nimpl\u003cT: Trait\u003e MultiReservableCurrency\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\t/// Check if `who` can reserve `value` from their free balance.\n\t///\n\t/// Always `true` if value to be reserved is zero.\n\tfn can_reserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tif value.is_zero() {\n\t\t\treturn true;\n\t\t}\n\t\tSelf::ensure_can_withdraw(currency_id, who, value).is_ok()\n\t}\n\n\t/// Slash from reserved balance, returning any amount that was unable to be\n\t/// slashed.\n\t///\n\t/// Is a no-op if the value to be slashed is zero.\n\tfn slash_reserved(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tif value.is_zero() {\n\t\t\treturn value;\n\t\t}\n\n\t\tlet reserved_balance = Self::reserved_balance(currency_id, who);\n\t\tlet actual = reserved_balance.min(value);\n\t\tSelf::set_reserved_balance(currency_id, who, reserved_balance - actual);\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(currency_id, |v| *v -= actual);\n\t\tvalue - actual\n\t}\n\n\tfn reserved_balance(currency_id: Self::CurrencyId, who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tSelf::accounts(who, currency_id).reserved\n\t}\n\n\t/// Move `value` from the free balance from `who` to their reserved balance.\n\t///\n\t/// Is a no-op if value to be reserved is zero.\n\tfn reserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\tif value.is_zero() {\n\t\t\treturn Ok(());\n\t\t}\n\t\tSelf::ensure_can_withdraw(currency_id, who, value)?;\n\n\t\tlet account = Self::accounts(who, currency_id);\n\t\tSelf::set_free_balance(currency_id, who, account.free - value);\n\t\t// Cannot overflow becuase total issuance is using the same balance type and\n\t\t// this doesn't increase total issuance\n\t\tSelf::set_reserved_balance(currency_id, who, account.reserved + value);\n\t\tOk(())\n\t}\n\n\t/// Unreserve some funds, returning any amount that was unable to be\n\t/// unreserved.\n\t///\n\t/// Is a no-op if the value to be unreserved is zero.\n\tfn unreserve(currency_id: Self::CurrencyId, who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tif value.is_zero() {\n\t\t\treturn value;\n\t\t}\n\n\t\tlet account = Self::accounts(who, currency_id);\n\t\tlet actual = account.reserved.min(value);\n\t\tSelf::set_reserved_balance(currency_id, who, account.reserved - actual);\n\t\tSelf::set_free_balance(currency_id, who, account.free + actual);\n\t\tT::OnReceived::on_received(who, currency_id, actual);\n\t\tvalue - actual\n\t}\n\n\t/// Move the reserved balance of one account into the balance of another,\n\t/// according to `status`.\n\t///\n\t/// Is a no-op if:\n\t/// - the value to be moved is zero; or\n\t/// - the `slashed` id equal to `beneficiary` and the `status` is\n\t///   `Reserved`.\n\tfn repatriate_reserved(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tslashed: \u0026T::AccountId,\n\t\tbeneficiary: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\tif value.is_zero() {\n\t\t\treturn Ok(value);\n\t\t}\n\n\t\tif slashed == beneficiary {\n\t\t\treturn match status {\n\t\t\t\tBalanceStatus::Free =\u003e Ok(Self::unreserve(currency_id, slashed, value)),\n\t\t\t\tBalanceStatus::Reserved =\u003e Ok(value.saturating_sub(Self::reserved_balance(currency_id, slashed))),\n\t\t\t};\n\t\t}\n\n\t\tlet from_account = Self::accounts(slashed, currency_id);\n\t\tlet to_account = Self::accounts(beneficiary, currency_id);\n\t\tlet actual = from_account.reserved.min(value);\n\t\tmatch status {\n\t\t\tBalanceStatus::Free =\u003e {\n\t\t\t\tSelf::set_free_balance(currency_id, beneficiary, to_account.free + actual);\n\t\t\t\tT::OnReceived::on_received(beneficiary, currency_id, actual);\n\t\t\t}\n\t\t\tBalanceStatus::Reserved =\u003e {\n\t\t\t\tSelf::set_reserved_balance(currency_id, beneficiary, to_account.reserved + actual);\n\t\t\t}\n\t\t}\n\t\tSelf::set_reserved_balance(currency_id, slashed, from_account.reserved - actual);\n\t\tOk(value - actual)\n\t}\n}\n\npub struct CurrencyAdapter\u003cT, GetCurrencyId\u003e(marker::PhantomData\u003c(T, GetCurrencyId)\u003e);\n\nimpl\u003cT, GetCurrencyId\u003e PalletCurrency\u003cT::AccountId\u003e for CurrencyAdapter\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cT::CurrencyId\u003e,\n{\n\ttype Balance = T::Balance;\n\ttype PositiveImbalance = PositiveImbalance\u003cT, GetCurrencyId\u003e;\n\ttype NegativeImbalance = NegativeImbalance\u003cT, GetCurrencyId\u003e;\n\n\tfn total_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::total_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn can_slash(who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tModule::\u003cT\u003e::can_slash(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn total_issuance() -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::total_issuance(GetCurrencyId::get())\n\t}\n\n\tfn minimum_balance() -\u003e Self::Balance {\n\t\tZero::zero()\n\t}\n\n\tfn burn(mut amount: Self::Balance) -\u003e Self::PositiveImbalance {\n\t\tif amount.is_zero() {\n\t\t\treturn PositiveImbalance::zero();\n\t\t}\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(GetCurrencyId::get(), |issued| {\n\t\t\t*issued = issued.checked_sub(\u0026amount).unwrap_or_else(|| {\n\t\t\t\tamount = *issued;\n\t\t\t\tZero::zero()\n\t\t\t});\n\t\t});\n\t\tPositiveImbalance::new(amount)\n\t}\n\n\tfn issue(mut amount: Self::Balance) -\u003e Self::NegativeImbalance {\n\t\tif amount.is_zero() {\n\t\t\treturn NegativeImbalance::zero();\n\t\t}\n\t\t\u003cTotalIssuance\u003cT\u003e\u003e::mutate(GetCurrencyId::get(), |issued| {\n\t\t\t*issued = issued.checked_add(\u0026amount).unwrap_or_else(|| {\n\t\t\t\tamount = Self::Balance::max_value() - *issued;\n\t\t\t\tSelf::Balance::max_value()\n\t\t\t})\n\t\t});\n\t\tNegativeImbalance::new(amount)\n\t}\n\n\tfn free_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::free_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn ensure_can_withdraw(\n\t\twho: \u0026T::AccountId,\n\t\tamount: Self::Balance,\n\t\t_reasons: WithdrawReasons,\n\t\t_new_balance: Self::Balance,\n\t) -\u003e DispatchResult {\n\t\tModule::\u003cT\u003e::ensure_can_withdraw(GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn transfer(\n\t\tsource: \u0026T::AccountId,\n\t\tdest: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\t_existence_requirement: ExistenceRequirement,\n\t) -\u003e DispatchResult {\n\t\t\u003cModule\u003cT\u003e as MultiCurrency\u003cT::AccountId\u003e\u003e::transfer(GetCurrencyId::get(), \u0026source, \u0026dest, value)\n\t}\n\n\tfn slash(who: \u0026T::AccountId, value: Self::Balance) -\u003e (Self::NegativeImbalance, Self::Balance) {\n\t\tif value.is_zero() {\n\t\t\treturn (Self::NegativeImbalance::zero(), value);\n\t\t}\n\n\t\tlet currency_id = GetCurrencyId::get();\n\t\tlet account = Module::\u003cT\u003e::accounts(who, currency_id);\n\t\tlet free_slashed_amount = account.free.min(value);\n\t\tlet mut remaining_slash = value - free_slashed_amount;\n\n\t\t// slash free balance\n\t\tif !free_slashed_amount.is_zero() {\n\t\t\tModule::\u003cT\u003e::set_free_balance(currency_id, who, account.free - free_slashed_amount);\n\t\t}\n\n\t\t// slash reserved balance\n\t\tif !remaining_slash.is_zero() {\n\t\t\tlet reserved_slashed_amount = account.reserved.min(remaining_slash);\n\t\t\tremaining_slash -= reserved_slashed_amount;\n\t\t\tModule::\u003cT\u003e::set_reserved_balance(currency_id, who, account.reserved - reserved_slashed_amount);\n\t\t\t(\n\t\t\t\tSelf::NegativeImbalance::new(free_slashed_amount + reserved_slashed_amount),\n\t\t\t\tremaining_slash,\n\t\t\t)\n\t\t} else {\n\t\t\t(Self::NegativeImbalance::new(value), remaining_slash)\n\t\t}\n\t}\n\n\tfn deposit_into_existing(\n\t\twho: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t) -\u003e result::Result\u003cSelf::PositiveImbalance, DispatchError\u003e {\n\t\tif value.is_zero() {\n\t\t\treturn Ok(Self::PositiveImbalance::zero());\n\t\t}\n\t\tlet currency_id = GetCurrencyId::get();\n\t\tlet new_total = Module::\u003cT\u003e::free_balance(currency_id, who)\n\t\t\t.checked_add(\u0026value)\n\t\t\t.ok_or(Error::\u003cT\u003e::TotalIssuanceOverflow)?;\n\t\tModule::\u003cT\u003e::set_free_balance(currency_id, who, new_total);\n\n\t\tOk(Self::PositiveImbalance::new(value))\n\t}\n\n\tfn deposit_creating(who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::PositiveImbalance {\n\t\tSelf::deposit_into_existing(who, value).unwrap_or_else(|_| Self::PositiveImbalance::zero())\n\t}\n\n\tfn withdraw(\n\t\twho: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\t_reasons: WithdrawReasons,\n\t\t_liveness: ExistenceRequirement,\n\t) -\u003e result::Result\u003cSelf::NegativeImbalance, DispatchError\u003e {\n\t\tif value.is_zero() {\n\t\t\treturn Ok(Self::NegativeImbalance::zero());\n\t\t}\n\t\tlet currency_id = GetCurrencyId::get();\n\t\tModule::\u003cT\u003e::ensure_can_withdraw(currency_id, who, value)?;\n\t\tModule::\u003cT\u003e::set_free_balance(currency_id, who, Module::\u003cT\u003e::free_balance(currency_id, who) - value);\n\n\t\tOk(Self::NegativeImbalance::new(value))\n\t}\n\n\tfn make_free_balance_be(\n\t\twho: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t) -\u003e SignedImbalance\u003cSelf::Balance, Self::PositiveImbalance\u003e {\n\t\t\u003cAccounts\u003cT\u003e\u003e::mutate(\n\t\t\twho,\n\t\t\tGetCurrencyId::get(),\n\t\t\t|account| -\u003e Result\u003cSignedImbalance\u003cSelf::Balance, Self::PositiveImbalance\u003e, ()\u003e {\n\t\t\t\tlet imbalance = if account.free \u003c= value {\n\t\t\t\t\tSignedImbalance::Positive(PositiveImbalance::new(value - account.free))\n\t\t\t\t} else {\n\t\t\t\t\tSignedImbalance::Negative(NegativeImbalance::new(account.free - value))\n\t\t\t\t};\n\t\t\t\taccount.free = value;\n\t\t\t\tOk(imbalance)\n\t\t\t},\n\t\t)\n\t\t.unwrap_or_else(|_| SignedImbalance::Positive(Self::PositiveImbalance::zero()))\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e PalletReservableCurrency\u003cT::AccountId\u003e for CurrencyAdapter\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cT::CurrencyId\u003e,\n{\n\tfn can_reserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e bool {\n\t\tModule::\u003cT\u003e::can_reserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn slash_reserved(who: \u0026T::AccountId, value: Self::Balance) -\u003e (Self::NegativeImbalance, Self::Balance) {\n\t\tlet actual = Module::\u003cT\u003e::slash_reserved(GetCurrencyId::get(), who, value);\n\t\t(Self::NegativeImbalance::zero(), actual)\n\t}\n\n\tfn reserved_balance(who: \u0026T::AccountId) -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::reserved_balance(GetCurrencyId::get(), who)\n\t}\n\n\tfn reserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e DispatchResult {\n\t\tModule::\u003cT\u003e::reserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn unreserve(who: \u0026T::AccountId, value: Self::Balance) -\u003e Self::Balance {\n\t\tModule::\u003cT\u003e::unreserve(GetCurrencyId::get(), who, value)\n\t}\n\n\tfn repatriate_reserved(\n\t\tslashed: \u0026T::AccountId,\n\t\tbeneficiary: \u0026T::AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: Status,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e {\n\t\tModule::\u003cT\u003e::repatriate_reserved(GetCurrencyId::get(), slashed, beneficiary, value, status)\n\t}\n}\n\nimpl\u003cT, GetCurrencyId\u003e PalletLockableCurrency\u003cT::AccountId\u003e for CurrencyAdapter\u003cT, GetCurrencyId\u003e\nwhere\n\tT: Trait,\n\tGetCurrencyId: Get\u003cT::CurrencyId\u003e,\n{\n\ttype Moment = T::BlockNumber;\n\ttype MaxLocks = ();\n\n\tfn set_lock(id: LockIdentifier, who: \u0026T::AccountId, amount: Self::Balance, _reasons: WithdrawReasons) {\n\t\tModule::\u003cT\u003e::set_lock(id, GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn extend_lock(id: LockIdentifier, who: \u0026T::AccountId, amount: Self::Balance, _reasons: WithdrawReasons) {\n\t\tModule::\u003cT\u003e::extend_lock(id, GetCurrencyId::get(), who, amount)\n\t}\n\n\tfn remove_lock(id: LockIdentifier, who: \u0026T::AccountId) {\n\t\tModule::\u003cT\u003e::remove_lock(id, GetCurrencyId::get(), who)\n\t}\n}\n","traces":[{"line":149,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":150,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":154,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":155,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":159,"address":[4769663,4770062,4778112,4778300,4778327,4768496,4769691,4778288,4769536,4778192,4768512,4778215,4778016,4778320,4769600,4769768,4769553,4778096,4778208,4769818,4770048],"length":1,"stats":{"Line":994},"fn_name":"accounts\u003cm_tokens::mock::Runtime,\u0026u32,minterest_primitives::CurrencyId\u003e"},{"line":162,"address":[4769856,4769683,4769615],"length":1,"stats":{"Line":149},"fn_name":"{{closure}}\u003cm_tokens::mock::Runtime\u003e"},{"line":163,"address":[4769887,4769972],"length":1,"stats":{"Line":114},"fn_name":null},{"line":166,"address":[4770256,4770270],"length":1,"stats":{"Line":82},"fn_name":"{{closure}}\u003cm_tokens::mock::Runtime\u003e"},{"line":167,"address":[4770320,4770351,4770413,4769959],"length":1,"stats":{"Line":139},"fn_name":"{{closure}}\u003cm_tokens::mock::Runtime\u003e"},{"line":168,"address":[4770653,4770527,4770375,4770437],"length":1,"stats":{"Line":136},"fn_name":null},{"line":169,"address":[4770540],"length":1,"stats":{"Line":27},"fn_name":null},{"line":171,"address":[4770482],"length":1,"stats":{"Line":41},"fn_name":null},{"line":173,"address":[4770660],"length":1,"stats":{"Line":41},"fn_name":null},{"line":177,"address":[4770034,4770042],"length":1,"stats":{"Line":35},"fn_name":null},{"line":193,"address":[4769785,4770096],"length":1,"stats":{"Line":84},"fn_name":"{{closure}}\u003cm_tokens::mock::Runtime\u003e"},{"line":194,"address":[4770176,4770190,4770110],"length":1,"stats":{"Line":116},"fn_name":"{{closure}}\u003cm_tokens::mock::Runtime\u003e"},{"line":195,"address":[4770225,4770720,4770733],"length":1,"stats":{"Line":120},"fn_name":"{{closure}}\u003cm_tokens::mock::Runtime\u003e"},{"line":201,"address":[4378064,4378279,4377895,4378037,4378089,4377735],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[4767244,4767677,4766692,4767419,4766843,4766809,4766987],"length":1,"stats":{"Line":10},"fn_name":null},{"line":212,"address":[4500010,4499493,4500161,4499742,4498798,4499805,4499084,4498425,4499937,4499694,4499252,4500120,4498569,4498939,4499339],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[4519007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[4822608,4822900,4822847,4822739,4822701],"length":1,"stats":{"Line":3},"fn_name":null},{"line":237,"address":[4823204,4822811,4823136,4822998],"length":1,"stats":{"Line":3},"fn_name":null},{"line":238,"address":[4823498,4823370,4823244,4823129],"length":1,"stats":{"Line":3},"fn_name":null},{"line":240,"address":[4823274],"length":1,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[4519372],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[4826042,4825989,4825881,4825843,4825750],"length":1,"stats":{"Line":3},"fn_name":null},{"line":261,"address":[4826328,4826260,4825953,4826140],"length":1,"stats":{"Line":2},"fn_name":null},{"line":262,"address":[4826356,4826249],"length":1,"stats":{"Line":2},"fn_name":null},{"line":263,"address":[4826671,4826543,4826395],"length":1,"stats":{"Line":1},"fn_name":null},{"line":265,"address":[4826451],"length":1,"stats":{"Line":1},"fn_name":null},{"line":290,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":291,"address":[],"length":0,"stats":{"Line":51},"fn_name":null},{"line":299,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":300,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":304,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":306,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":307,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":308,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":309,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":314,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":315,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":316,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":319,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":323,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":325,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":335,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":336,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":339,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":340,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":343,"address":[],"length":0,"stats":{"Line":22},"fn_name":null},{"line":344,"address":[],"length":0,"stats":{"Line":22},"fn_name":null},{"line":350,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":351,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":352,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":355,"address":[],"length":0,"stats":{"Line":72},"fn_name":null},{"line":356,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[],"length":0,"stats":{"Line":34},"fn_name":null},{"line":358,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":359,"address":[],"length":0,"stats":{"Line":33},"fn_name":null},{"line":360,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":368,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":374,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":375,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":377,"address":[],"length":0,"stats":{"Line":34},"fn_name":null},{"line":379,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":380,"address":[],"length":0,"stats":{"Line":47},"fn_name":null},{"line":381,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":382,"address":[],"length":0,"stats":{"Line":38},"fn_name":null},{"line":384,"address":[],"length":0,"stats":{"Line":35},"fn_name":null},{"line":385,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":386,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":388,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":394,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":395,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":396,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":399,"address":[],"length":0,"stats":{"Line":55},"fn_name":null},{"line":400,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":401,"address":[],"length":0,"stats":{"Line":33},"fn_name":null},{"line":402,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":403,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":404,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":406,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":409,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":410,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":411,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":413,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":416,"address":[],"length":0,"stats":{"Line":21},"fn_name":null},{"line":417,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":419,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":423,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":424,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":425,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":427,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":437,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":438,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":439,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":442,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":443,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":445,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":448,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":451,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":455,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":456,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":458,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":459,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":464,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":465,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":472,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":473,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":474,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":479,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":480,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":482,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":485,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":486,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":487,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":488,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":490,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":500,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":501,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":502,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":504,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":505,"address":[],"length":0,"stats":{"Line":25},"fn_name":null},{"line":507,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":508,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":509,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":511,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":515,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":516,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":518,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":523,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":524,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":525,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":527,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":528,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":530,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":531,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":532,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":533,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":534,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":537,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":541,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":542,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":544,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":547,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":548,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":549,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":550,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":558,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":559,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":560,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":562,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":569,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":570,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":571,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":574,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":575,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":576,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":577,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":578,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":581,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":582,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":588,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":589,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":590,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":592,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":594,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":595,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":598,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":599,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":606,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":607,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":608,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":611,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":612,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":613,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":614,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":615,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":616,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":626,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":633,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":634,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":637,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":638,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":639,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":640,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":644,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":645,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":646,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":647,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":648,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":649,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":650,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":652,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":653,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":656,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":657,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":672,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":673,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":676,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":677,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":680,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":681,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":684,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":685,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":688,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":689,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":690,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":692,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":693,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":694,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":695,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":698,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":701,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":702,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":703,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":705,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":706,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":707,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":708,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":711,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":714,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":715,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":718,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":724,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":727,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":733,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":736,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":737,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":738,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":741,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":742,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":743,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":744,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":747,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":748,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":752,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":753,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":754,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":755,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":757,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":758,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":761,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":765,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":769,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":770,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":772,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":773,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":774,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":775,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":776,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":778,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":781,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":782,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":785,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":791,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":792,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":794,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":795,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":796,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":798,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":801,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":806,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":807,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":808,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":809,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":810,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":812,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":814,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":815,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":818,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":827,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":828,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":831,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":832,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":833,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":836,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":837,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":840,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":841,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":844,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":845,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":848,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":854,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":866,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":867,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":870,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":871,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":874,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":875,"address":[],"length":0,"stats":{"Line":1},"fn_name":null}],"covered":266,"coverable":294},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","mock.rs"],"content":"//! Mocks for the tokens module.\n\n#![cfg(test)]\n\nuse frame_support::{\n\timpl_outer_event, impl_outer_origin, parameter_types,\n\ttraits::{ChangeMembers, Contains, ContainsLengthBound},\n};\nuse frame_system as system;\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{Convert, IdentityLookup},\n\tModuleId, Perbill, Percent, Permill,\n};\nuse sp_std::cell::RefCell;\nuse std::collections::HashMap;\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod tokens {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\ttokens\u003cT\u003e,\n\t\tpallet_treasury\u003cT\u003e,\n\t\tpallet_elections_phragmen\u003cT\u003e,\n\t}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\ntype AccountId = u64;\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = system::Module\u003cRuntime\u003e;\n\ntype CurrencyId = u32;\npub type Balance = u64;\n\nthread_local! {\n\tpub static ACCUMULATED_RECEIVED: RefCell\u003cHashMap\u003c(AccountId, CurrencyId), Balance\u003e\u003e = RefCell::new(HashMap::new());\n}\n\npub struct MockOnReceived;\nimpl OnReceived\u003cAccountId, CurrencyId, Balance\u003e for MockOnReceived {\n\tfn on_received(who: \u0026AccountId, currency_id: CurrencyId, amount: Balance) {\n\t\tACCUMULATED_RECEIVED.with(|v| {\n\t\t\tlet mut old_map = v.borrow().clone();\n\t\t\tif let Some(before) = old_map.get_mut(\u0026(*who, currency_id)) {\n\t\t\t\t*before += amount;\n\t\t\t} else {\n\t\t\t\told_map.insert((*who, currency_id), amount);\n\t\t\t};\n\n\t\t\t*v.borrow_mut() = old_map;\n\t\t});\n\t}\n}\n\nthread_local! {\n\tstatic TEN_TO_FOURTEEN: RefCell\u003cVec\u003cu64\u003e\u003e = RefCell::new(vec![10,11,12,13,14]);\n}\npub struct TenToFourteen;\nimpl Contains\u003cu64\u003e for TenToFourteen {\n\tfn sorted_members() -\u003e Vec\u003cu64\u003e {\n\t\tTEN_TO_FOURTEEN.with(|v| v.borrow().clone())\n\t}\n\t#[cfg(feature = \"runtime-benchmarks\")]\n\tfn add(new: \u0026u64) {\n\t\tTEN_TO_FOURTEEN.with(|v| {\n\t\t\tlet mut members = v.borrow_mut();\n\t\t\tmembers.push(*new);\n\t\t\tmembers.sort();\n\t\t})\n\t}\n}\nimpl ContainsLengthBound for TenToFourteen {\n\tfn max_len() -\u003e usize {\n\t\tTEN_TO_FOURTEEN.with(|v| v.borrow().len())\n\t}\n\tfn min_len() -\u003e usize {\n\t\t0\n\t}\n}\n\nparameter_types! {\n\tpub const ProposalBond: Permill = Permill::from_percent(5);\n\tpub const ProposalBondMinimum: u64 = 1;\n\tpub const TipCountdown: u64 = 1;\n\tpub const TipFindersFee: Percent = Percent::from_percent(20);\n\tpub const TipReportDepositBase: u64 = 1;\n\tpub const DataDepositPerByte: u64 = 1;\n\tpub const SpendPeriod: u64 = 2;\n\tpub const Burn: Permill = Permill::from_percent(50);\n\tpub const TreasuryModuleId: ModuleId = ModuleId(*b\"py/trsry\");\n\tpub const GetTokenId: CurrencyId = TEST_TOKEN_ID;\n}\n\nimpl pallet_treasury::Trait for Runtime {\n\ttype ModuleId = TreasuryModuleId;\n\ttype Currency = CurrencyAdapter\u003cRuntime, GetTokenId\u003e;\n\ttype ApproveOrigin = frame_system::EnsureRoot\u003cu64\u003e;\n\ttype RejectOrigin = frame_system::EnsureRoot\u003cu64\u003e;\n\ttype Tippers = TenToFourteen;\n\ttype TipCountdown = TipCountdown;\n\ttype TipFindersFee = TipFindersFee;\n\ttype TipReportDepositBase = TipReportDepositBase;\n\ttype DataDepositPerByte = DataDepositPerByte;\n\ttype Event = TestEvent;\n\ttype OnSlash = ();\n\ttype ProposalBond = ProposalBond;\n\ttype ProposalBondMinimum = ProposalBondMinimum;\n\ttype SpendPeriod = SpendPeriod;\n\ttype Burn = Burn;\n\ttype BurnDestination = (); // Just gets burned.\n\ttype BountyDepositBase = ();\n\ttype BountyDepositPayoutDelay = ();\n\ttype BountyUpdatePeriod = ();\n\ttype BountyCuratorDeposit = ();\n\ttype BountyValueMinimum = ();\n\ttype MaximumReasonLength = ();\n\ttype WeightInfo = ();\n}\n\npub struct CurrencyToVoteHandler;\nimpl Convert\u003cu64, u64\u003e for CurrencyToVoteHandler {\n\tfn convert(x: u64) -\u003e u64 {\n\t\tx\n\t}\n}\nimpl Convert\u003cu128, u64\u003e for CurrencyToVoteHandler {\n\tfn convert(x: u128) -\u003e u64 {\n\t\tx as u64\n\t}\n}\n\nparameter_types! {\n\tpub const CandidacyBond: u64 = 3;\n}\n\nthread_local! {\n\tstatic VOTING_BOND: RefCell\u003cu64\u003e = RefCell::new(2);\n\tstatic DESIRED_MEMBERS: RefCell\u003cu32\u003e = RefCell::new(2);\n\tstatic DESIRED_RUNNERS_UP: RefCell\u003cu32\u003e = RefCell::new(2);\n\tstatic TERM_DURATION: RefCell\u003cu64\u003e = RefCell::new(5);\n}\n\npub struct VotingBond;\nimpl Get\u003cu64\u003e for VotingBond {\n\tfn get() -\u003e u64 {\n\t\tVOTING_BOND.with(|v| *v.borrow())\n\t}\n}\n\npub struct DesiredMembers;\nimpl Get\u003cu32\u003e for DesiredMembers {\n\tfn get() -\u003e u32 {\n\t\tDESIRED_MEMBERS.with(|v| *v.borrow())\n\t}\n}\n\npub struct DesiredRunnersUp;\nimpl Get\u003cu32\u003e for DesiredRunnersUp {\n\tfn get() -\u003e u32 {\n\t\tDESIRED_RUNNERS_UP.with(|v| *v.borrow())\n\t}\n}\n\npub struct TermDuration;\nimpl Get\u003cu64\u003e for TermDuration {\n\tfn get() -\u003e u64 {\n\t\tTERM_DURATION.with(|v| *v.borrow())\n\t}\n}\n\nthread_local! {\n\tpub static MEMBERS: RefCell\u003cVec\u003cu64\u003e\u003e = RefCell::new(vec![]);\n\tpub static PRIME: RefCell\u003cOption\u003cu64\u003e\u003e = RefCell::new(None);\n}\n\npub struct TestChangeMembers;\nimpl ChangeMembers\u003cu64\u003e for TestChangeMembers {\n\tfn change_members_sorted(incoming: \u0026[u64], outgoing: \u0026[u64], new: \u0026[u64]) {\n\t\t// new, incoming, outgoing must be sorted.\n\t\tlet mut new_sorted = new.to_vec();\n\t\tnew_sorted.sort();\n\t\tassert_eq!(new, \u0026new_sorted[..]);\n\n\t\tlet mut incoming_sorted = incoming.to_vec();\n\t\tincoming_sorted.sort();\n\t\tassert_eq!(incoming, \u0026incoming_sorted[..]);\n\n\t\tlet mut outgoing_sorted = outgoing.to_vec();\n\t\toutgoing_sorted.sort();\n\t\tassert_eq!(outgoing, \u0026outgoing_sorted[..]);\n\n\t\t// incoming and outgoing must be disjoint\n\t\tfor x in incoming.iter() {\n\t\t\tassert!(outgoing.binary_search(x).is_err());\n\t\t}\n\n\t\tlet mut old_plus_incoming = MEMBERS.with(|m| m.borrow().to_vec());\n\t\told_plus_incoming.extend_from_slice(incoming);\n\t\told_plus_incoming.sort();\n\n\t\tlet mut new_plus_outgoing = new.to_vec();\n\t\tnew_plus_outgoing.extend_from_slice(outgoing);\n\t\tnew_plus_outgoing.sort();\n\n\t\tassert_eq!(\n\t\t\told_plus_incoming, new_plus_outgoing,\n\t\t\t\"change members call is incorrect!\"\n\t\t);\n\n\t\tMEMBERS.with(|m| *m.borrow_mut() = new.to_vec());\n\t\tPRIME.with(|p| *p.borrow_mut() = None);\n\t}\n\n\tfn set_prime(who: Option\u003cu64\u003e) {\n\t\tPRIME.with(|p| *p.borrow_mut() = who);\n\t}\n}\n\nparameter_types! {\n\tpub const ElectionsPhragmenModuleId: LockIdentifier = *b\"phrelect\";\n}\n\nimpl pallet_elections_phragmen::Trait for Runtime {\n\ttype ModuleId = ElectionsPhragmenModuleId;\n\ttype Event = TestEvent;\n\ttype Currency = CurrencyAdapter\u003cRuntime, GetTokenId\u003e;\n\ttype CurrencyToVote = CurrencyToVoteHandler;\n\ttype ChangeMembers = TestChangeMembers;\n\ttype InitializeMembers = ();\n\ttype CandidacyBond = CandidacyBond;\n\ttype VotingBond = VotingBond;\n\ttype TermDuration = TermDuration;\n\ttype DesiredMembers = DesiredMembers;\n\ttype DesiredRunnersUp = DesiredRunnersUp;\n\ttype LoserCandidate = ();\n\ttype KickedMember = ();\n\ttype BadReport = ();\n\ttype WeightInfo = ();\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = i64;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = MockOnReceived;\n\ttype WeightInfo = ();\n}\n\npub type Tokens = Module\u003cRuntime\u003e;\npub type TreasuryCurrencyAdapter = \u003cRuntime as pallet_treasury::Trait\u003e::Currency;\n\npub const TEST_TOKEN_ID: CurrencyId = 1;\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const TREASURY_ACCOUNT: AccountId = 3;\npub const ID_1: LockIdentifier = *b\"1       \";\npub const ID_2: LockIdentifier = *b\"2       \";\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n\ttreasury_genesis: bool,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t\ttreasury_genesis: false,\n\t\t}\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn balances(mut self, endowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e) -\u003e Self {\n\t\tself.endowed_accounts = endowed_accounts;\n\t\tself\n\t}\n\n\tpub fn one_hundred_for_alice_n_bob(self) -\u003e Self {\n\t\tself.balances(vec![(ALICE, TEST_TOKEN_ID, 100), (BOB, TEST_TOKEN_ID, 100)])\n\t}\n\n\tpub fn one_hundred_for_treasury_account(mut self) -\u003e Self {\n\t\tself.treasury_genesis = true;\n\t\tself.balances(vec![(TREASURY_ACCOUNT, TEST_TOKEN_ID, 100)])\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tGenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tif self.treasury_genesis {\n\t\t\tpallet_treasury::GenesisConfig::default()\n\t\t\t\t.assimilate_storage::\u003cRuntime, _\u003e(\u0026mut t)\n\t\t\t\t.unwrap();\n\n\t\t\tpallet_elections_phragmen::GenesisConfig::\u003cRuntime\u003e {\n\t\t\t\tmembers: vec![(TREASURY_ACCOUNT, 10)],\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\t\t}\n\n\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[{"line":21,"address":[5115216,5115285],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[5116032,5115995,5115646,5115609,5116215,5116457,5117475,5116603,5115807,5117529,5116785,5117020,5117310,5117421,5116420,5115465],"length":1,"stats":{"Line":7},"fn_name":null},{"line":31,"address":[5115623,5115924,5115970,5115681],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[5116009,5116395,5116349,5116067],"length":1,"stats":{"Line":3},"fn_name":null},{"line":33,"address":[5116714,5116760,5116434,5116492],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[5117199,5117151,5116872,5116799],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[4344497],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[4344535],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":89,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":90,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":96,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":102,"address":[4344647],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[4344817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[4344881],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[4344961],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[4344996],"length":1,"stats":{"Line":5},"fn_name":null},{"line":168,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[4345076],"length":1,"stats":{"Line":2},"fn_name":null},{"line":184,"address":[4345172],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[4345268],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[4345364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":192,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":198,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":218,"address":[4345463],"length":1,"stats":{"Line":0},"fn_name":null},{"line":219,"address":[4345575],"length":1,"stats":{"Line":0},"fn_name":null},{"line":224,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":231,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":239,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":240,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":243,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":245,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":251,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[4345665],"length":1,"stats":{"Line":6},"fn_name":null},{"line":312,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":314,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":321,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":322,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":323,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":326,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":327,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":331,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":332,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":335,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":336,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":341,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":343,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":347,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":348,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":352,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":354,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":358,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":359,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":360,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":33,"coverable":96},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","tokens","src","tests.rs"],"content":"//! Unit tests for the tokens module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok, traits::WithdrawReason};\nuse mock::{\n\tBalance, ExtBuilder, Runtime, System, TestEvent, Tokens, TreasuryCurrencyAdapter, ACCUMULATED_RECEIVED, ALICE, BOB,\n\tID_1, ID_2, TEST_TOKEN_ID, TREASURY_ACCOUNT,\n};\n\n#[test]\nfn set_lock_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 10);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen(), 10);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 50);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 50);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t\tTokens::set_lock(ID_2, TEST_TOKEN_ID, \u0026ALICE, 60);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 60);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 2);\n\t\t});\n}\n\n#[test]\nfn extend_lock_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 10);\n\t\t\tTokens::extend_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 20);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t\tassert_eq!(Tokens::accounts(\u0026ALICE, TEST_TOKEN_ID).frozen, 20);\n\t\t\tTokens::extend_lock(ID_2, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tTokens::extend_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 20);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 2);\n\t\t});\n}\n\n#[test]\nfn remove_lock_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tTokens::set_lock(ID_2, TEST_TOKEN_ID, \u0026ALICE, 20);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 2);\n\t\t\tTokens::remove_lock(ID_2, TEST_TOKEN_ID, \u0026ALICE);\n\t\t\tassert_eq!(Tokens::locks(ALICE, TEST_TOKEN_ID).len(), 1);\n\t\t});\n}\n\n#[test]\nfn frozen_can_limit_liquidity() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 90);\n\t\t\tassert_noop!(\n\t\t\t\t\u003cTokens as MultiCurrency\u003c_\u003e\u003e::transfer(TEST_TOKEN_ID, \u0026ALICE, \u0026BOB, 11),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions,\n\t\t\t);\n\t\t\tTokens::set_lock(ID_1, TEST_TOKEN_ID, \u0026ALICE, 10);\n\t\t\tassert_ok!(\u003cTokens as MultiCurrency\u003c_\u003e\u003e::transfer(TEST_TOKEN_ID, \u0026ALICE, \u0026BOB, 11),);\n\t\t});\n}\n\n#[test]\nfn can_reserve_is_correct() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::can_reserve(TEST_TOKEN_ID, \u0026ALICE, 0), true);\n\t\t\tassert_eq!(Tokens::can_reserve(TEST_TOKEN_ID, \u0026ALICE, 101), false);\n\t\t\tassert_eq!(Tokens::can_reserve(TEST_TOKEN_ID, \u0026ALICE, 100), true);\n\t\t});\n}\n\n#[test]\nfn reserve_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_noop!(\n\t\t\t\tTokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 101),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow,\n\t\t\t);\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::total_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t});\n}\n\n#[test]\nfn unreserve_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::unreserve(TEST_TOKEN_ID, \u0026ALICE, 0), 0);\n\t\t\tassert_eq!(Tokens::unreserve(TEST_TOKEN_ID, \u0026ALICE, 50), 50);\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 30));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 70);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 30);\n\t\t\tassert_eq!(Tokens::unreserve(TEST_TOKEN_ID, \u0026ALICE, 15), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 85);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 15);\n\t\t\tassert_eq!(Tokens::unreserve(TEST_TOKEN_ID, \u0026ALICE, 30), 15);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t});\n}\n\n#[test]\nfn slash_reserved_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\t\t\tassert_eq!(Tokens::slash_reserved(TEST_TOKEN_ID, \u0026ALICE, 0), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\t\t\tassert_eq!(Tokens::slash_reserved(TEST_TOKEN_ID, \u0026ALICE, 100), 50);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 150);\n\t\t});\n}\n\n#[test]\nfn repatriate_reserved_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026ALICE, \u0026ALICE, 0, BalanceStatus::Free),\n\t\t\t\tOk(0)\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026ALICE, \u0026ALICE, 50, BalanceStatus::Free),\n\t\t\t\tOk(50)\n\t\t\t);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 0);\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026BOB, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026BOB, \u0026BOB, 60, BalanceStatus::Reserved),\n\t\t\t\tOk(10)\n\t\t\t);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026BOB, \u0026ALICE, 30, BalanceStatus::Reserved),\n\t\t\t\tOk(0)\n\t\t\t);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 30);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 20);\n\n\t\t\tassert_eq!(\n\t\t\t\tTokens::repatriate_reserved(TEST_TOKEN_ID, \u0026BOB, \u0026ALICE, 30, BalanceStatus::Free),\n\t\t\t\tOk(10)\n\t\t\t);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 120);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 30);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026BOB), 0);\n\t\t});\n}\n\n#[test]\nfn slash_draw_reserved_correct() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::reserve(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\n\t\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 80), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 20);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 120);\n\n\t\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 50), 30);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 100);\n\t\t});\n}\n\n#[test]\nfn genesis_issuance_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 100);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\t\t});\n}\n\n#[test]\nfn transfer_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Tokens::transfer(Some(ALICE).into(), BOB, TEST_TOKEN_ID, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 150);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\t\t\tassert_eq!(\n\t\t\t\tACCUMULATED_RECEIVED.with(|v| *v.borrow().get(\u0026(BOB, TEST_TOKEN_ID)).unwrap()),\n\t\t\t\t50\n\t\t\t);\n\n\t\t\tlet transferred_event = TestEvent::tokens(RawEvent::Transferred(TEST_TOKEN_ID, ALICE, BOB, 50));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\n\t\t\tassert_noop!(\n\t\t\t\tTokens::transfer(Some(ALICE).into(), BOB, TEST_TOKEN_ID, 60),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow,\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn transfer_all_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Tokens::transfer_all(Some(ALICE).into(), BOB, TEST_TOKEN_ID));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 200);\n\n\t\t\tlet transferred_event = TestEvent::tokens(RawEvent::Transferred(TEST_TOKEN_ID, ALICE, BOB, 100));\n\t\t\tassert!(System::events().iter().any(|record| record.event == transferred_event));\n\t\t});\n}\n\n#[test]\nfn deposit_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::deposit(TEST_TOKEN_ID, \u0026ALICE, 100));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 200);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 300);\n\n\t\t\tassert_noop!(\n\t\t\t\tTokens::deposit(TEST_TOKEN_ID, \u0026ALICE, Balance::max_value()),\n\t\t\t\tError::\u003cRuntime\u003e::TotalIssuanceOverflow,\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn withdraw_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::withdraw(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 150);\n\n\t\t\tassert_noop!(\n\t\t\t\tTokens::withdraw(TEST_TOKEN_ID, \u0026ALICE, 60),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn slash_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// slashed_amount \u003c amount\n\t\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 50), 0);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 150);\n\n\t\t\t// slashed_amount == amount\n\t\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 51), 1);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 0);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 100);\n\t\t});\n}\n\n#[test]\nfn update_balance_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(Tokens::update_balance(TEST_TOKEN_ID, \u0026ALICE, 50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 150);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 250);\n\n\t\t\tassert_ok!(Tokens::update_balance(TEST_TOKEN_ID, \u0026BOB, -50));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026BOB), 50);\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 200);\n\n\t\t\tassert_noop!(\n\t\t\t\tTokens::update_balance(TEST_TOKEN_ID, \u0026BOB, -60),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn ensure_can_withdraw_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_alice_n_bob()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_noop!(\n\t\t\t\tTokens::ensure_can_withdraw(TEST_TOKEN_ID, \u0026ALICE, 101),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceTooLow\n\t\t\t);\n\n\t\t\tassert_ok!(Tokens::ensure_can_withdraw(TEST_TOKEN_ID, \u0026ALICE, 1));\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026ALICE), 100);\n\t\t});\n}\n\n#[test]\nfn no_op_if_amount_is_zero() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(Tokens::ensure_can_withdraw(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t\tassert_ok!(Tokens::transfer(Some(ALICE).into(), BOB, TEST_TOKEN_ID, 0));\n\t\tassert_ok!(Tokens::transfer(Some(ALICE).into(), ALICE, TEST_TOKEN_ID, 0));\n\t\tassert_ok!(Tokens::deposit(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t\tassert_ok!(Tokens::withdraw(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 0), 0);\n\t\tassert_eq!(Tokens::slash(TEST_TOKEN_ID, \u0026ALICE, 1), 1);\n\t\tassert_ok!(Tokens::update_balance(TEST_TOKEN_ID, \u0026ALICE, 0));\n\t});\n}\n\n#[test]\nfn currency_adapter_ensure_currency_adapter_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Tokens::total_issuance(TEST_TOKEN_ID), 100);\n\t\t\tassert_eq!(Tokens::total_balance(TEST_TOKEN_ID, \u0026TREASURY_ACCOUNT), 100);\n\t\t\t// CandidacyBond = 3 VotingBond = 2\n\t\t\tassert_eq!(Tokens::reserved_balance(TEST_TOKEN_ID, \u0026TREASURY_ACCOUNT), 5);\n\t\t\tassert_eq!(Tokens::free_balance(TEST_TOKEN_ID, \u0026TREASURY_ACCOUNT), 95);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t100\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::can_slash(\u0026TREASURY_ACCOUNT, 10),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::minimum_balance(),\n\t\t\t\t0\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::can_reserve(\u0026TREASURY_ACCOUNT, 5),\n\t\t\t\ttrue\n\t\t\t);\n\n\t\t\t// burn\n\t\t\tlet imbalance = \u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::burn(10);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t90\n\t\t\t);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\n\t\t\t// issue\n\t\t\tlet imbalance = \u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::issue(20);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t120\n\t\t\t);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\n\t\t\t// transfer\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t95\n\t\t\t);\n\t\t\tassert_ok!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::ensure_can_withdraw(\n\t\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\t10,\n\t\t\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t\t\t0\n\t\t\t\t)\n\t\t\t);\n\t\t\tassert_ok!(\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t11,\n\t\t\t\tExistenceRequirement::KeepAlive\n\t\t\t));\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t84\n\t\t\t);\n\n\t\t\t// deposit\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\t\t\tlet imbalance = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 11);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t95\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t100\n\t\t\t);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t95\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t111\n\t\t\t);\n\n\t\t\t// withdraw\n\t\t\tlet imbalance = \u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::withdraw(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t10,\n\t\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t\tExistenceRequirement::KeepAlive,\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t85\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t111\n\t\t\t);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\t\t85\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\t\u003cRuntime as pallet_elections_phragmen::Trait\u003e::Currency::total_issuance(),\n\t\t\t\t101\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_burn_must_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tlet init_total_issuance = TreasuryCurrencyAdapter::total_issuance();\n\t\t\tlet imbalance = TreasuryCurrencyAdapter::burn(10);\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), init_total_issuance - 10);\n\t\t\tdrop(imbalance);\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), init_total_issuance);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_reserving_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_balance(\u0026TREASURY_ACCOUNT), 111);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 111);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 69));\n\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_balance(\u0026TREASURY_ACCOUNT), 111);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 42);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 69);\n\t});\n}\n\n#[test]\nfn currency_adapter_balance_transfer_when_reserved_should_not_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 69));\n\t\tassert_noop!(\n\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 69, ExistenceRequirement::AllowDeath),\n\t\t\tError::\u003cRuntime\u003e::BalanceTooLow,\n\t\t);\n\t});\n}\n\n#[test]\nfn currency_adapter_deducting_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 69));\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 42);\n\t});\n}\n\n#[test]\nfn currency_adapter_refunding_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 42);\n\t\tTokens::set_reserved_balance(TEST_TOKEN_ID, \u0026TREASURY_ACCOUNT, 69);\n\t\tTreasuryCurrencyAdapter::unreserve(\u0026TREASURY_ACCOUNT, 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 111);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\t});\n}\n\n#[test]\nfn currency_adapter_slashing_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 69));\n\t\tassert!(TreasuryCurrencyAdapter::slash(\u0026TREASURY_ACCOUNT, 69).1.is_zero());\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 42);\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 42);\n\t});\n}\n\n#[test]\nfn currency_adapter_slashing_incomplete_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 42);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 21));\n\t\tassert_eq!(TreasuryCurrencyAdapter::slash(\u0026TREASURY_ACCOUNT, 69).1, 27);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 0);\n\t});\n}\n\n#[test]\nfn currency_adapter_basic_locking_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// CandidacyBond = 3 VotingBond = 2\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 95);\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 91, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 5, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_partial_locking_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 5, WithdrawReasons::all());\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t1,\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_removal_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, u64::max_value(), WithdrawReasons::all());\n\t\t\tTreasuryCurrencyAdapter::remove_lock(ID_1, \u0026TREASURY_ACCOUNT);\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t1,\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_replacement_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, u64::max_value(), WithdrawReasons::all());\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 5, WithdrawReasons::all());\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t1,\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn currency_adapter_double_locking_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 5, WithdrawReasons::none());\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_2, \u0026TREASURY_ACCOUNT, 5, WithdrawReasons::all());\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\t1,\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn currency_adapter_combination_locking_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// withdrawReasons not work\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, u64::max_value(), WithdrawReasons::none());\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_2, \u0026TREASURY_ACCOUNT, 0, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 1, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_value_extension_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 100, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 2, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 8, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 3, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_block_number_extension_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 200, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tSystem::set_block_number(2);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReasons::all());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 3, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_lock_reasons_extension_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tTreasuryCurrencyAdapter::set_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReason::Transfer.into());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReasons::none());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t\tTreasuryCurrencyAdapter::extend_lock(ID_1, \u0026TREASURY_ACCOUNT, 90, WithdrawReason::Reserve.into());\n\t\t\tassert_noop!(\n\t\t\t\tTreasuryCurrencyAdapter::transfer(\u0026TREASURY_ACCOUNT, \u0026ALICE, 6, ExistenceRequirement::AllowDeath),\n\t\t\t\tError::\u003cRuntime\u003e::LiquidityRestrictions\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_reward_should_work() {\n\tExtBuilder::default()\n\t\t.one_hundred_for_treasury_account()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 100);\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_balance(\u0026TREASURY_ACCOUNT), 100);\n\t\t\tassert_ok!(TreasuryCurrencyAdapter::deposit_into_existing(\u0026TREASURY_ACCOUNT, 10).map(drop));\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_balance(\u0026TREASURY_ACCOUNT), 110);\n\t\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 110);\n\t\t});\n}\n\n#[test]\nfn currency_adapter_slashing_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 111));\n\t\tassert_eq!(TreasuryCurrencyAdapter::slash_reserved(\u0026TREASURY_ACCOUNT, 42).1, 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 69);\n\t});\n}\n\n#[test]\nfn currency_adapter_slashing_incomplete_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 42));\n\t\tassert_eq!(TreasuryCurrencyAdapter::slash_reserved(\u0026TREASURY_ACCOUNT, 69).1, 27);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::total_issuance(), 69);\n\t});\n}\n\n#[test]\nfn currency_adapter_repatriating_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 110);\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026ALICE, 1);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 110));\n\t\tassert_ok!(\n\t\t\tTreasuryCurrencyAdapter::repatriate_reserved(\u0026TREASURY_ACCOUNT, \u0026ALICE, 41, Status::Free),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026ALICE), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026ALICE), 42);\n\t});\n}\n\n#[test]\nfn currency_adapter_transferring_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 110);\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026ALICE, 1);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 110));\n\t\tassert_ok!(\n\t\t\tTreasuryCurrencyAdapter::repatriate_reserved(\u0026TREASURY_ACCOUNT, \u0026ALICE, 41, Status::Reserved),\n\t\t\t0\n\t\t);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026ALICE), 41);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026ALICE), 1);\n\t});\n}\n\n#[test]\nfn currency_adapter_transferring_reserved_balance_to_nonexistent_should_fail() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 111);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 111));\n\t\tassert_ok!(TreasuryCurrencyAdapter::repatriate_reserved(\n\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\u0026ALICE,\n\t\t\t42,\n\t\t\tStatus::Free\n\t\t));\n\t});\n}\n\n#[test]\nfn currency_adapter_transferring_incomplete_reserved_balance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026TREASURY_ACCOUNT, 110);\n\t\tlet _ = TreasuryCurrencyAdapter::deposit_creating(\u0026ALICE, 1);\n\t\tassert_ok!(TreasuryCurrencyAdapter::reserve(\u0026TREASURY_ACCOUNT, 41));\n\t\tassert_ok!(\n\t\t\tTreasuryCurrencyAdapter::repatriate_reserved(\u0026TREASURY_ACCOUNT, \u0026ALICE, 69, Status::Free),\n\t\t\t28\n\t\t);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026TREASURY_ACCOUNT), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT), 69);\n\t\tassert_eq!(TreasuryCurrencyAdapter::reserved_balance(\u0026ALICE), 0);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026ALICE), 42);\n\t});\n}\n\n#[test]\nfn currency_adapter_transferring_too_high_value_should_not_panic() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tTreasuryCurrencyAdapter::make_free_balance_be(\u0026TREASURY_ACCOUNT, u64::max_value());\n\t\tTreasuryCurrencyAdapter::make_free_balance_be(\u0026ALICE, 1);\n\n\t\tassert_noop!(\n\t\t\tTreasuryCurrencyAdapter::transfer(\n\t\t\t\t\u0026TREASURY_ACCOUNT,\n\t\t\t\t\u0026ALICE,\n\t\t\t\tu64::max_value(),\n\t\t\t\tExistenceRequirement::AllowDeath\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::BalanceOverflow,\n\t\t);\n\n\t\tassert_eq!(\n\t\t\tTreasuryCurrencyAdapter::free_balance(\u0026TREASURY_ACCOUNT),\n\t\t\tu64::max_value()\n\t\t);\n\t\tassert_eq!(TreasuryCurrencyAdapter::free_balance(\u0026ALICE), 1);\n\t});\n}\n","traces":[{"line":13,"address":[4894720,4894742],"length":1,"stats":{"Line":3},"fn_name":"set_lock_should_work"},{"line":14,"address":[4894727,4894757],"length":1,"stats":{"Line":2},"fn_name":null},{"line":17,"address":[4966969,4966912],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":18,"address":[4966926],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[4966991,4967166],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4967459,4967622,4967125],"length":1,"stats":{"Line":2},"fn_name":null},{"line":21,"address":[4967923,4967579],"length":1,"stats":{"Line":2},"fn_name":null},{"line":22,"address":[4968467],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4968685,4968515],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[4968986,4968642],"length":1,"stats":{"Line":2},"fn_name":null},{"line":25,"address":[4969530],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4969748,4969578],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4969705,4970025],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[4894848,4894870],"length":1,"stats":{"Line":3},"fn_name":"extend_lock_should_work"},{"line":33,"address":[4894885,4894855],"length":1,"stats":{"Line":2},"fn_name":null},{"line":36,"address":[4970608,4970665],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":37,"address":[4970622],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[4970680],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[4971450,4971255],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[4971389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[4971743],"length":1,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[4972318,4972513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[4972452],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[4972789],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4972830],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4894976,4894998],"length":1,"stats":{"Line":3},"fn_name":"remove_lock_should_work"},{"line":51,"address":[4895013,4894983],"length":1,"stats":{"Line":2},"fn_name":null},{"line":54,"address":[4973497,4973440],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":55,"address":[4973454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":56,"address":[4973519],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4973560],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[4974111],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[4974147],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4895104,4895126],"length":1,"stats":{"Line":3},"fn_name":"frozen_can_limit_liquidity"},{"line":65,"address":[4895141,4895111],"length":1,"stats":{"Line":2},"fn_name":null},{"line":68,"address":[4974736,4974793],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":69,"address":[4974750],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[4974909,4974870,4974808],"length":1,"stats":{"Line":3},"fn_name":null},{"line":71,"address":[4974822],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4974862],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4975893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4975940],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[4895232,4895254],"length":1,"stats":{"Line":3},"fn_name":"can_reserve_is_correct"},{"line":81,"address":[4895269,4895239],"length":1,"stats":{"Line":2},"fn_name":null},{"line":84,"address":[4976288],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":85,"address":[4976480,4976306],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[4976433,4976769,4976904],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[4977276,4977172,4976860],"length":1,"stats":{"Line":2},"fn_name":null},{"line":92,"address":[4895360,4895382],"length":1,"stats":{"Line":3},"fn_name":"reserve_should_work"},{"line":93,"address":[4895397,4895367],"length":1,"stats":{"Line":2},"fn_name":null},{"line":96,"address":[4977568,4977591],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":97,"address":[4977685,4977575,4977646],"length":1,"stats":{"Line":3},"fn_name":null},{"line":98,"address":[4977606],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4977638],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[4978741],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4979182,4979002],"length":1,"stats":{"Line":1},"fn_name":null},{"line":103,"address":[4979144,4979696,4979558],"length":1,"stats":{"Line":2},"fn_name":null},{"line":104,"address":[4980215,4979658,4980072],"length":1,"stats":{"Line":2},"fn_name":null},{"line":105,"address":[4980172,4980580],"length":1,"stats":{"Line":2},"fn_name":null},{"line":106,"address":[4980806,4980986],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[4980948,4981500,4981362],"length":1,"stats":{"Line":2},"fn_name":null},{"line":108,"address":[4981462,4981852,4981970],"length":1,"stats":{"Line":2},"fn_name":null},{"line":113,"address":[4895488,4895510],"length":1,"stats":{"Line":3},"fn_name":"unreserve_should_work"},{"line":114,"address":[4895495,4895525],"length":1,"stats":{"Line":2},"fn_name":null},{"line":117,"address":[4982368],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":118,"address":[4982382,4982550],"length":1,"stats":{"Line":1},"fn_name":null},{"line":119,"address":[4982509,4982994,4982850],"length":1,"stats":{"Line":2},"fn_name":null},{"line":120,"address":[4983294,4982953,4983439],"length":1,"stats":{"Line":2},"fn_name":null},{"line":121,"address":[4983393,4983884,4983739],"length":1,"stats":{"Line":2},"fn_name":null},{"line":122,"address":[4984181,4983838],"length":1,"stats":{"Line":2},"fn_name":null},{"line":123,"address":[4984436,4984604],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[4984563,4984904,4985049],"length":1,"stats":{"Line":2},"fn_name":null},{"line":125,"address":[4985489,4985003,4985349],"length":1,"stats":{"Line":2},"fn_name":null},{"line":126,"address":[4985929,4985448,4985789],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[4986229,4986374,4985888],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[4986814,4986328,4986674],"length":1,"stats":{"Line":2},"fn_name":null},{"line":129,"address":[4987239,4986773,4987108],"length":1,"stats":{"Line":2},"fn_name":null},{"line":130,"address":[4987506,4987201,4987612],"length":1,"stats":{"Line":2},"fn_name":null},{"line":135,"address":[4895616,4895638],"length":1,"stats":{"Line":3},"fn_name":"slash_reserved_should_work"},{"line":136,"address":[4895623,4895653],"length":1,"stats":{"Line":2},"fn_name":null},{"line":139,"address":[4987904],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":140,"address":[4987918],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[4988371,4988203],"length":1,"stats":{"Line":1},"fn_name":null},{"line":142,"address":[4988671,4988330,4988801],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[4989245,4988763,4989101],"length":1,"stats":{"Line":2},"fn_name":null},{"line":144,"address":[4989204,4989685,4989545],"length":1,"stats":{"Line":2},"fn_name":null},{"line":145,"address":[4990125,4989644,4989985],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[4990555,4990425,4990084],"length":1,"stats":{"Line":2},"fn_name":null},{"line":147,"address":[4990855,4990517,4991000],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[4991300,4991440,4990954],"length":1,"stats":{"Line":2},"fn_name":null},{"line":149,"address":[4991399,4991740,4991880],"length":1,"stats":{"Line":2},"fn_name":null},{"line":150,"address":[4992295,4992174,4991839],"length":1,"stats":{"Line":2},"fn_name":null},{"line":151,"address":[4992562,4992260,4992668],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[4895744,4895766],"length":1,"stats":{"Line":3},"fn_name":"repatriate_reserved_should_work"},{"line":157,"address":[4895781,4895751],"length":1,"stats":{"Line":2},"fn_name":null},{"line":160,"address":[4992960],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":161,"address":[4993148,4992980],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[4993107,4993448,4993633],"length":1,"stats":{"Line":2},"fn_name":null},{"line":163,"address":[4994123,4993933],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[4993552],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[4994431,4994575],"length":1,"stats":{"Line":1},"fn_name":null},{"line":168,"address":[4994043],"length":1,"stats":{"Line":1},"fn_name":null},{"line":171,"address":[4995023,4994541,4994883],"length":1,"stats":{"Line":2},"fn_name":null},{"line":172,"address":[4995323,4994982,4995463],"length":1,"stats":{"Line":2},"fn_name":null},{"line":174,"address":[4995763,4995422,4995903],"length":1,"stats":{"Line":2},"fn_name":null},{"line":175,"address":[4996348,4995862,4996203],"length":1,"stats":{"Line":2},"fn_name":null},{"line":176,"address":[4996302,4996645],"length":1,"stats":{"Line":2},"fn_name":null},{"line":177,"address":[4996900,4997068],"length":1,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[4997554,4997368,4997027],"length":1,"stats":{"Line":2},"fn_name":null},{"line":179,"address":[4997854,4997998],"length":1,"stats":{"Line":1},"fn_name":null},{"line":180,"address":[4997467],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[4997964,4998446,4998306],"length":1,"stats":{"Line":2},"fn_name":null},{"line":184,"address":[4998746,4998936,4998405],"length":1,"stats":{"Line":2},"fn_name":null},{"line":186,"address":[4999236,4999380],"length":1,"stats":{"Line":1},"fn_name":null},{"line":187,"address":[4998852],"length":1,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[4999688,4999828,4999346],"length":1,"stats":{"Line":2},"fn_name":null},{"line":191,"address":[5000268,4999787,5000128],"length":1,"stats":{"Line":2},"fn_name":null},{"line":192,"address":[5000708,5000568,5000227],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[5000667,5001198,5001008],"length":1,"stats":{"Line":2},"fn_name":null},{"line":195,"address":[5001642,5001498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":196,"address":[5001114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[5001950,5002090,5001608],"length":1,"stats":{"Line":2},"fn_name":null},{"line":200,"address":[5002390,5002530,5002049],"length":1,"stats":{"Line":2},"fn_name":null},{"line":201,"address":[5002489,5002961,5002830],"length":1,"stats":{"Line":2},"fn_name":null},{"line":202,"address":[5003228,5003334,5002923],"length":1,"stats":{"Line":2},"fn_name":null},{"line":207,"address":[4895872,4895894],"length":1,"stats":{"Line":3},"fn_name":"slash_draw_reserved_correct"},{"line":208,"address":[4895909,4895879],"length":1,"stats":{"Line":2},"fn_name":null},{"line":211,"address":[5003632],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":212,"address":[5003646],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[5003931,5004099],"length":1,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[5004058,5004399,5004529],"length":1,"stats":{"Line":2},"fn_name":null},{"line":215,"address":[5004829,5004491,5004974],"length":1,"stats":{"Line":2},"fn_name":null},{"line":217,"address":[5004928,5005414,5005274],"length":1,"stats":{"Line":2},"fn_name":null},{"line":218,"address":[5005373,5005854,5005714],"length":1,"stats":{"Line":2},"fn_name":null},{"line":219,"address":[5006154,5005813,5006284],"length":1,"stats":{"Line":2},"fn_name":null},{"line":220,"address":[5006729,5006246,5006584],"length":1,"stats":{"Line":2},"fn_name":null},{"line":222,"address":[5007169,5006683,5007029],"length":1,"stats":{"Line":2},"fn_name":null},{"line":223,"address":[5007609,5007128,5007469],"length":1,"stats":{"Line":2},"fn_name":null},{"line":224,"address":[5008024,5007568,5007903],"length":1,"stats":{"Line":2},"fn_name":null},{"line":225,"address":[5008397,5008291,5007989],"length":1,"stats":{"Line":2},"fn_name":null},{"line":230,"address":[4896000,4896022],"length":1,"stats":{"Line":3},"fn_name":"genesis_issuance_should_work"},{"line":231,"address":[4896007,4896037],"length":1,"stats":{"Line":2},"fn_name":null},{"line":234,"address":[5008704],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":235,"address":[5008718,5008886],"length":1,"stats":{"Line":1},"fn_name":null},{"line":236,"address":[5008845,5009295,5009174],"length":1,"stats":{"Line":2},"fn_name":null},{"line":237,"address":[5009260,5009562,5009668],"length":1,"stats":{"Line":2},"fn_name":null},{"line":242,"address":[4896128,4896150],"length":1,"stats":{"Line":3},"fn_name":"transfer_should_work"},{"line":243,"address":[4896135,4896165],"length":1,"stats":{"Line":2},"fn_name":null},{"line":246,"address":[5010211,5010192],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":247,"address":[5010199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":249,"address":[5010226],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[5010743,5010575],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[5011043,5010702,5011173],"length":1,"stats":{"Line":2},"fn_name":null},{"line":252,"address":[5011135,5011608,5011473],"length":1,"stats":{"Line":2},"fn_name":null},{"line":253,"address":[5012124,5011908],"length":1,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[5009977,5009968,5011572],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":258,"address":[5012000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[5010144,5012661,5010158,5012099,5012425,5012482],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}"},{"line":261,"address":[5012815,5012642],"length":1,"stats":{"Line":2},"fn_name":null},{"line":262,"address":[5012694],"length":1,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[5012807],"length":1,"stats":{"Line":1},"fn_name":null},{"line":269,"address":[4896278,4896256],"length":1,"stats":{"Line":3},"fn_name":"transfer_all_should_work"},{"line":270,"address":[4896293,4896263],"length":1,"stats":{"Line":2},"fn_name":null},{"line":273,"address":[5014035,5014016],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":274,"address":[5014023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[5014050],"length":1,"stats":{"Line":1},"fn_name":null},{"line":277,"address":[5014393,5014561],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[5014843,5015050,5014520],"length":1,"stats":{"Line":2},"fn_name":null},{"line":280,"address":[5014929],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[5015028,5015318,5015514,5015363,5013982,5013968],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}"},{"line":286,"address":[4896406,4896384],"length":1,"stats":{"Line":3},"fn_name":"deposit_should_work"},{"line":287,"address":[4896421,4896391],"length":1,"stats":{"Line":2},"fn_name":null},{"line":290,"address":[5015632,5015674],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":291,"address":[5015646,5015693],"length":1,"stats":{"Line":2},"fn_name":null},{"line":292,"address":[5016106,5015948],"length":1,"stats":{"Line":1},"fn_name":null},{"line":293,"address":[5016532,5016068,5016406],"length":1,"stats":{"Line":2},"fn_name":null},{"line":295,"address":[5016498,5016888],"length":1,"stats":{"Line":2},"fn_name":null},{"line":296,"address":[5016827],"length":1,"stats":{"Line":1},"fn_name":null},{"line":297,"address":[5016880],"length":1,"stats":{"Line":1},"fn_name":null},{"line":303,"address":[4896512,4896534],"length":1,"stats":{"Line":3},"fn_name":"withdraw_should_work"},{"line":304,"address":[4896549,4896519],"length":1,"stats":{"Line":2},"fn_name":null},{"line":307,"address":[5017984,5018026],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":308,"address":[5017998,5018045],"length":1,"stats":{"Line":2},"fn_name":null},{"line":309,"address":[5018300,5018458],"length":1,"stats":{"Line":1},"fn_name":null},{"line":310,"address":[5018420,5018758,5018884],"length":1,"stats":{"Line":2},"fn_name":null},{"line":312,"address":[5019217,5019259,5018850],"length":1,"stats":{"Line":3},"fn_name":null},{"line":313,"address":[5019177],"length":1,"stats":{"Line":1},"fn_name":null},{"line":314,"address":[5019209],"length":1,"stats":{"Line":1},"fn_name":null},{"line":320,"address":[4896640,4896662],"length":1,"stats":{"Line":3},"fn_name":"slash_should_work"},{"line":321,"address":[4896677,4896647],"length":1,"stats":{"Line":2},"fn_name":null},{"line":324,"address":[5020336],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":326,"address":[5020523,5020350],"length":1,"stats":{"Line":1},"fn_name":null},{"line":327,"address":[5020953,5020482,5020823],"length":1,"stats":{"Line":2},"fn_name":null},{"line":328,"address":[5020915,5021398,5021253],"length":1,"stats":{"Line":2},"fn_name":null},{"line":331,"address":[5021838,5021698,5021352],"length":1,"stats":{"Line":2},"fn_name":null},{"line":332,"address":[5021797,5022247,5022126],"length":1,"stats":{"Line":2},"fn_name":null},{"line":333,"address":[5022620,5022514,5022212],"length":1,"stats":{"Line":2},"fn_name":null},{"line":338,"address":[4896768,4896790],"length":1,"stats":{"Line":3},"fn_name":"update_balance_should_work"},{"line":339,"address":[4896805,4896775],"length":1,"stats":{"Line":2},"fn_name":null},{"line":342,"address":[5022954,5022912],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":343,"address":[5022926,5022973],"length":1,"stats":{"Line":2},"fn_name":null},{"line":344,"address":[5023228,5023386],"length":1,"stats":{"Line":1},"fn_name":null},{"line":345,"address":[5023348,5023833,5023686],"length":1,"stats":{"Line":2},"fn_name":null},{"line":347,"address":[5024130,5023785],"length":1,"stats":{"Line":2},"fn_name":null},{"line":348,"address":[5024385,5024543],"length":1,"stats":{"Line":1},"fn_name":null},{"line":349,"address":[5024505,5024843,5024969],"length":1,"stats":{"Line":2},"fn_name":null},{"line":351,"address":[5025346,5024935,5025304],"length":1,"stats":{"Line":3},"fn_name":null},{"line":352,"address":[5025262],"length":1,"stats":{"Line":1},"fn_name":null},{"line":353,"address":[5025296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":359,"address":[4896896,4896918],"length":1,"stats":{"Line":3},"fn_name":"ensure_can_withdraw_should_work"},{"line":360,"address":[4896933,4896903],"length":1,"stats":{"Line":2},"fn_name":null},{"line":363,"address":[5026439,5026416],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":364,"address":[5026423,5026494,5026533],"length":1,"stats":{"Line":3},"fn_name":null},{"line":365,"address":[5026454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":366,"address":[5026486],"length":1,"stats":{"Line":1},"fn_name":null},{"line":369,"address":[5027589],"length":1,"stats":{"Line":1},"fn_name":null},{"line":370,"address":[5027833,5027987],"length":1,"stats":{"Line":1},"fn_name":null},{"line":375,"address":[4897046,4897024],"length":1,"stats":{"Line":3},"fn_name":"no_op_if_amount_is_zero"},{"line":376,"address":[4897031,4897061],"length":1,"stats":{"Line":3},"fn_name":null},{"line":377,"address":[5028400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":378,"address":[5028673],"length":1,"stats":{"Line":1},"fn_name":null},{"line":379,"address":[5029014],"length":1,"stats":{"Line":1},"fn_name":null},{"line":380,"address":[5029364],"length":1,"stats":{"Line":1},"fn_name":null},{"line":381,"address":[5029646],"length":1,"stats":{"Line":1},"fn_name":null},{"line":382,"address":[5029930,5030103],"length":1,"stats":{"Line":1},"fn_name":null},{"line":383,"address":[5030057,5030518,5030385],"length":1,"stats":{"Line":2},"fn_name":null},{"line":384,"address":[5030782,5030480],"length":1,"stats":{"Line":2},"fn_name":null},{"line":389,"address":[4897158,4897136],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_ensure_currency_adapter_should_work"},{"line":390,"address":[4897173,4897143],"length":1,"stats":{"Line":2},"fn_name":null},{"line":393,"address":[5031121,5031056],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":394,"address":[5031143,5031069,5031283],"length":1,"stats":{"Line":2},"fn_name":null},{"line":395,"address":[5031242,5031723,5031583],"length":1,"stats":{"Line":2},"fn_name":null},{"line":397,"address":[5032023,5031682,5032163],"length":1,"stats":{"Line":2},"fn_name":null},{"line":398,"address":[5032463,5032598,5032122],"length":1,"stats":{"Line":2},"fn_name":null},{"line":399,"address":[5032898,5033039],"length":1,"stats":{"Line":1},"fn_name":null},{"line":400,"address":[5032562],"length":1,"stats":{"Line":1},"fn_name":null},{"line":403,"address":[5033340,5033463],"length":1,"stats":{"Line":1},"fn_name":null},{"line":404,"address":[5032997],"length":1,"stats":{"Line":1},"fn_name":null},{"line":407,"address":[5033763,5033888],"length":1,"stats":{"Line":1},"fn_name":null},{"line":408,"address":[5033430],"length":1,"stats":{"Line":1},"fn_name":null},{"line":411,"address":[5034329,5034188],"length":1,"stats":{"Line":1},"fn_name":null},{"line":412,"address":[5033855],"length":1,"stats":{"Line":1},"fn_name":null},{"line":415,"address":[5034630,5034766],"length":1,"stats":{"Line":1},"fn_name":null},{"line":416,"address":[5034287],"length":1,"stats":{"Line":1},"fn_name":null},{"line":421,"address":[5034720],"length":1,"stats":{"Line":1},"fn_name":null},{"line":422,"address":[5035097,5035223],"length":1,"stats":{"Line":1},"fn_name":null},{"line":423,"address":[5035059],"length":1,"stats":{"Line":1},"fn_name":null},{"line":426,"address":[5035189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":427,"address":[5035745,5035622],"length":1,"stats":{"Line":1},"fn_name":null},{"line":428,"address":[5035584],"length":1,"stats":{"Line":1},"fn_name":null},{"line":433,"address":[5036114,5035719],"length":1,"stats":{"Line":2},"fn_name":null},{"line":434,"address":[5036122,5036168,5036294],"length":1,"stats":{"Line":2},"fn_name":null},{"line":435,"address":[5036130],"length":1,"stats":{"Line":1},"fn_name":null},{"line":438,"address":[5036260],"length":1,"stats":{"Line":1},"fn_name":null},{"line":439,"address":[5036818,5036693],"length":1,"stats":{"Line":1},"fn_name":null},{"line":440,"address":[5036655],"length":1,"stats":{"Line":1},"fn_name":null},{"line":445,"address":[5037202,5037335],"length":1,"stats":{"Line":1},"fn_name":null},{"line":446,"address":[5037194,5036785],"length":1,"stats":{"Line":2},"fn_name":null},{"line":449,"address":[5037742],"length":1,"stats":{"Line":1},"fn_name":null},{"line":450,"address":[5037703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":453,"address":[5037294],"length":1,"stats":{"Line":1},"fn_name":null},{"line":457,"address":[5037976],"length":1,"stats":{"Line":1},"fn_name":null},{"line":461,"address":[5037968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":463,"address":[5038412,5038294],"length":1,"stats":{"Line":1},"fn_name":null},{"line":464,"address":[5038249],"length":1,"stats":{"Line":1},"fn_name":null},{"line":469,"address":[5038796,5038926],"length":1,"stats":{"Line":1},"fn_name":null},{"line":470,"address":[5038788,5038386],"length":1,"stats":{"Line":2},"fn_name":null},{"line":473,"address":[5039295,5038888],"length":1,"stats":{"Line":2},"fn_name":null},{"line":474,"address":[5039356,5039474],"length":1,"stats":{"Line":1},"fn_name":null},{"line":475,"address":[5039311],"length":1,"stats":{"Line":1},"fn_name":null},{"line":478,"address":[5039984,5039858],"length":1,"stats":{"Line":1},"fn_name":null},{"line":479,"address":[5039448,5039850],"length":1,"stats":{"Line":2},"fn_name":null},{"line":482,"address":[5039950],"length":1,"stats":{"Line":1},"fn_name":null},{"line":483,"address":[5040508,5040390],"length":1,"stats":{"Line":1},"fn_name":null},{"line":484,"address":[5040345],"length":1,"stats":{"Line":1},"fn_name":null},{"line":487,"address":[5040892,5041025],"length":1,"stats":{"Line":1},"fn_name":null},{"line":488,"address":[5040884,5040482],"length":1,"stats":{"Line":2},"fn_name":null},{"line":493,"address":[5041394],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[5040984],"length":1,"stats":{"Line":1},"fn_name":null},{"line":497,"address":[5041386],"length":1,"stats":{"Line":1},"fn_name":null},{"line":499,"address":[5041493,5041611],"length":1,"stats":{"Line":1},"fn_name":null},{"line":500,"address":[5041448],"length":1,"stats":{"Line":1},"fn_name":null},{"line":503,"address":[5041995,5042153],"length":1,"stats":{"Line":1},"fn_name":null},{"line":504,"address":[5041585,5041987],"length":1,"stats":{"Line":2},"fn_name":null},{"line":507,"address":[5042087],"length":1,"stats":{"Line":1},"fn_name":null},{"line":508,"address":[5042559,5042677],"length":1,"stats":{"Line":1},"fn_name":null},{"line":509,"address":[5042514],"length":1,"stats":{"Line":1},"fn_name":null},{"line":512,"address":[5043037,5043168],"length":1,"stats":{"Line":1},"fn_name":null},{"line":513,"address":[5043029,5042651],"length":1,"stats":{"Line":2},"fn_name":null},{"line":520,"address":[4897286,4897264],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_burn_must_work"},{"line":521,"address":[4897301,4897271],"length":1,"stats":{"Line":2},"fn_name":null},{"line":524,"address":[5043744,5043774],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":525,"address":[5043751],"length":1,"stats":{"Line":1},"fn_name":null},{"line":526,"address":[5043789],"length":1,"stats":{"Line":1},"fn_name":null},{"line":527,"address":[5044031,5044873,5043815],"length":1,"stats":{"Line":1},"fn_name":null},{"line":528,"address":[5043997],"length":1,"stats":{"Line":1},"fn_name":null},{"line":529,"address":[5044508,5044368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":534,"address":[4897414,4897392],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_reserving_balance_should_work"},{"line":535,"address":[4897399,4897429],"length":1,"stats":{"Line":3},"fn_name":null},{"line":536,"address":[5044958],"length":1,"stats":{"Line":1},"fn_name":null},{"line":538,"address":[5044999,5045157],"length":1,"stats":{"Line":1},"fn_name":null},{"line":539,"address":[5045592,5045457,5045121],"length":1,"stats":{"Line":2},"fn_name":null},{"line":540,"address":[5046032,5045892,5045556],"length":1,"stats":{"Line":2},"fn_name":null},{"line":542,"address":[5046329,5045991],"length":1,"stats":{"Line":2},"fn_name":null},{"line":544,"address":[5046742,5046584],"length":1,"stats":{"Line":1},"fn_name":null},{"line":545,"address":[5047168,5047042,5046706],"length":1,"stats":{"Line":2},"fn_name":null},{"line":546,"address":[5047435,5047541,5047135],"length":1,"stats":{"Line":2},"fn_name":null},{"line":551,"address":[4897526,4897504],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_balance_transfer_when_reserved_should_not_work"},{"line":552,"address":[4897541,4897511],"length":1,"stats":{"Line":3},"fn_name":null},{"line":553,"address":[5047892,5047854],"length":1,"stats":{"Line":2},"fn_name":null},{"line":554,"address":[5047912],"length":1,"stats":{"Line":1},"fn_name":null},{"line":555,"address":[5048185,5048300,5048258],"length":1,"stats":{"Line":3},"fn_name":null},{"line":556,"address":[5048199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":557,"address":[5048250],"length":1,"stats":{"Line":1},"fn_name":null},{"line":563,"address":[4897638,4897616],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_deducting_balance_should_work"},{"line":564,"address":[4897623,4897653],"length":1,"stats":{"Line":3},"fn_name":null},{"line":565,"address":[5049390],"length":1,"stats":{"Line":1},"fn_name":null},{"line":566,"address":[5049425],"length":1,"stats":{"Line":1},"fn_name":null},{"line":567,"address":[5049672,5049801],"length":1,"stats":{"Line":1},"fn_name":null},{"line":572,"address":[4897728,4897750],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_refunding_balance_should_work"},{"line":573,"address":[4897735,4897765],"length":1,"stats":{"Line":3},"fn_name":null},{"line":574,"address":[5050110],"length":1,"stats":{"Line":1},"fn_name":null},{"line":575,"address":[5050145],"length":1,"stats":{"Line":1},"fn_name":null},{"line":576,"address":[5050170],"length":1,"stats":{"Line":1},"fn_name":null},{"line":577,"address":[5050339,5050190],"length":1,"stats":{"Line":1},"fn_name":null},{"line":578,"address":[5050712,5050606,5050306],"length":1,"stats":{"Line":2},"fn_name":null},{"line":583,"address":[4897862,4897840],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_slashing_balance_should_work"},{"line":584,"address":[4897877,4897847],"length":1,"stats":{"Line":3},"fn_name":null},{"line":585,"address":[5051060,5051022],"length":1,"stats":{"Line":2},"fn_name":null},{"line":586,"address":[5051080],"length":1,"stats":{"Line":1},"fn_name":null},{"line":587,"address":[5051495,5051353],"length":1,"stats":{"Line":1},"fn_name":null},{"line":588,"address":[5051532,5051667,5051477],"length":1,"stats":{"Line":2},"fn_name":null},{"line":589,"address":[5051961,5052077,5051631],"length":1,"stats":{"Line":2},"fn_name":null},{"line":590,"address":[5052047,5052344,5052450],"length":1,"stats":{"Line":2},"fn_name":null},{"line":595,"address":[4897974,4897952],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_slashing_incomplete_balance_should_work"},{"line":596,"address":[4897989,4897959],"length":1,"stats":{"Line":3},"fn_name":null},{"line":597,"address":[5052820,5052782],"length":1,"stats":{"Line":2},"fn_name":null},{"line":598,"address":[5052840],"length":1,"stats":{"Line":1},"fn_name":null},{"line":599,"address":[5053113],"length":1,"stats":{"Line":1},"fn_name":null},{"line":600,"address":[5053664,5053822],"length":1,"stats":{"Line":1},"fn_name":null},{"line":601,"address":[5053786,5054238,5054122],"length":1,"stats":{"Line":2},"fn_name":null},{"line":602,"address":[5054611,5054208,5054505],"length":1,"stats":{"Line":2},"fn_name":null},{"line":607,"address":[4898086,4898064],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_basic_locking_should_work"},{"line":608,"address":[4898101,4898071],"length":1,"stats":{"Line":2},"fn_name":null},{"line":611,"address":[5054928,5054960],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":613,"address":[5054942,5054982,5055106],"length":1,"stats":{"Line":2},"fn_name":null},{"line":614,"address":[5055074,5055406],"length":1,"stats":{"Line":2},"fn_name":null},{"line":615,"address":[5055569,5055454,5055527],"length":1,"stats":{"Line":3},"fn_name":null},{"line":616,"address":[5055468],"length":1,"stats":{"Line":1},"fn_name":null},{"line":617,"address":[5055519],"length":1,"stats":{"Line":1},"fn_name":null},{"line":623,"address":[4898214,4898192],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_partial_locking_should_work"},{"line":624,"address":[4898199,4898229],"length":1,"stats":{"Line":2},"fn_name":null},{"line":627,"address":[5056624],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":628,"address":[5056631],"length":1,"stats":{"Line":1},"fn_name":null},{"line":629,"address":[5056711],"length":1,"stats":{"Line":1},"fn_name":null},{"line":633,"address":[5056706],"length":1,"stats":{"Line":1},"fn_name":null},{"line":639,"address":[4898320,4898342],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_lock_removal_should_work"},{"line":640,"address":[4898327,4898357],"length":1,"stats":{"Line":2},"fn_name":null},{"line":643,"address":[5057008],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":644,"address":[5057015],"length":1,"stats":{"Line":1},"fn_name":null},{"line":645,"address":[5057085],"length":1,"stats":{"Line":1},"fn_name":null},{"line":646,"address":[5057135],"length":1,"stats":{"Line":1},"fn_name":null},{"line":650,"address":[5057130],"length":1,"stats":{"Line":1},"fn_name":null},{"line":656,"address":[4898470,4898448],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_lock_replacement_should_work"},{"line":657,"address":[4898485,4898455],"length":1,"stats":{"Line":2},"fn_name":null},{"line":660,"address":[5057440],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":661,"address":[5057447],"length":1,"stats":{"Line":1},"fn_name":null},{"line":662,"address":[5057510],"length":1,"stats":{"Line":1},"fn_name":null},{"line":663,"address":[5057590],"length":1,"stats":{"Line":1},"fn_name":null},{"line":667,"address":[5057585],"length":1,"stats":{"Line":1},"fn_name":null},{"line":673,"address":[4898598,4898576],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_double_locking_should_work"},{"line":674,"address":[4898583,4898613],"length":1,"stats":{"Line":2},"fn_name":null},{"line":677,"address":[5057888],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":678,"address":[5057895],"length":1,"stats":{"Line":1},"fn_name":null},{"line":679,"address":[5057956],"length":1,"stats":{"Line":1},"fn_name":null},{"line":680,"address":[5058036],"length":1,"stats":{"Line":1},"fn_name":null},{"line":684,"address":[5058031],"length":1,"stats":{"Line":1},"fn_name":null},{"line":690,"address":[4898726,4898704],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_combination_locking_should_work"},{"line":691,"address":[4898711,4898741],"length":1,"stats":{"Line":2},"fn_name":null},{"line":694,"address":[5058345,5058336],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":696,"address":[5058343,5058360],"length":1,"stats":{"Line":2},"fn_name":null},{"line":697,"address":[5058429],"length":1,"stats":{"Line":1},"fn_name":null},{"line":698,"address":[5058610,5058495,5058568],"length":1,"stats":{"Line":3},"fn_name":null},{"line":699,"address":[5058509],"length":1,"stats":{"Line":1},"fn_name":null},{"line":700,"address":[5058560],"length":1,"stats":{"Line":1},"fn_name":null},{"line":706,"address":[4898854,4898832],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_lock_value_extension_should_work"},{"line":707,"address":[4898839,4898869],"length":1,"stats":{"Line":2},"fn_name":null},{"line":710,"address":[5059685,5059664],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":711,"address":[5059707,5059671],"length":1,"stats":{"Line":2},"fn_name":null},{"line":712,"address":[5059828,5059870,5059755],"length":1,"stats":{"Line":3},"fn_name":null},{"line":713,"address":[5059769],"length":1,"stats":{"Line":1},"fn_name":null},{"line":714,"address":[5059820],"length":1,"stats":{"Line":1},"fn_name":null},{"line":716,"address":[5060926],"length":1,"stats":{"Line":1},"fn_name":null},{"line":717,"address":[5061112,5060992,5061070],"length":1,"stats":{"Line":3},"fn_name":null},{"line":718,"address":[5061011],"length":1,"stats":{"Line":1},"fn_name":null},{"line":719,"address":[5061062],"length":1,"stats":{"Line":1},"fn_name":null},{"line":721,"address":[5062168],"length":1,"stats":{"Line":1},"fn_name":null},{"line":722,"address":[5062354,5062234,5062312],"length":1,"stats":{"Line":3},"fn_name":null},{"line":723,"address":[5062253],"length":1,"stats":{"Line":1},"fn_name":null},{"line":724,"address":[5062304],"length":1,"stats":{"Line":1},"fn_name":null},{"line":730,"address":[4898960,4898982],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_lock_block_number_extension_should_work"},{"line":731,"address":[4898997,4898967],"length":1,"stats":{"Line":2},"fn_name":null},{"line":734,"address":[5063536,5063557],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":735,"address":[5063579,5063543],"length":1,"stats":{"Line":2},"fn_name":null},{"line":736,"address":[5063627,5063700,5063742],"length":1,"stats":{"Line":3},"fn_name":null},{"line":737,"address":[5063641],"length":1,"stats":{"Line":1},"fn_name":null},{"line":738,"address":[5063692],"length":1,"stats":{"Line":1},"fn_name":null},{"line":740,"address":[5064798],"length":1,"stats":{"Line":1},"fn_name":null},{"line":741,"address":[5064864,5064942,5064984],"length":1,"stats":{"Line":3},"fn_name":null},{"line":742,"address":[5064883],"length":1,"stats":{"Line":1},"fn_name":null},{"line":743,"address":[5064934],"length":1,"stats":{"Line":1},"fn_name":null},{"line":745,"address":[5066045],"length":1,"stats":{"Line":1},"fn_name":null},{"line":746,"address":[5066052],"length":1,"stats":{"Line":1},"fn_name":null},{"line":747,"address":[5066118,5066196,5066238],"length":1,"stats":{"Line":3},"fn_name":null},{"line":748,"address":[5066137],"length":1,"stats":{"Line":1},"fn_name":null},{"line":749,"address":[5066188],"length":1,"stats":{"Line":1},"fn_name":null},{"line":755,"address":[4899088,4899110],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_lock_reasons_extension_should_work"},{"line":756,"address":[4899095,4899125],"length":1,"stats":{"Line":2},"fn_name":null},{"line":759,"address":[5067408,5067445],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":760,"address":[5067467,5067415],"length":1,"stats":{"Line":2},"fn_name":null},{"line":761,"address":[5067588,5067515,5067630],"length":1,"stats":{"Line":3},"fn_name":null},{"line":762,"address":[5067529],"length":1,"stats":{"Line":1},"fn_name":null},{"line":763,"address":[5067580],"length":1,"stats":{"Line":1},"fn_name":null},{"line":765,"address":[5068686],"length":1,"stats":{"Line":1},"fn_name":null},{"line":766,"address":[5068752,5068830,5068872],"length":1,"stats":{"Line":3},"fn_name":null},{"line":767,"address":[5068771],"length":1,"stats":{"Line":1},"fn_name":null},{"line":768,"address":[5068822],"length":1,"stats":{"Line":1},"fn_name":null},{"line":770,"address":[5069928],"length":1,"stats":{"Line":1},"fn_name":null},{"line":771,"address":[5070010,5070130,5070088],"length":1,"stats":{"Line":3},"fn_name":null},{"line":772,"address":[5070029],"length":1,"stats":{"Line":1},"fn_name":null},{"line":773,"address":[5070080],"length":1,"stats":{"Line":1},"fn_name":null},{"line":779,"address":[4899238,4899216],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_reward_should_work"},{"line":780,"address":[4899223,4899253],"length":1,"stats":{"Line":2},"fn_name":null},{"line":783,"address":[5071312],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":784,"address":[5071474,5071319],"length":1,"stats":{"Line":1},"fn_name":null},{"line":785,"address":[5071914,5071774,5071438],"length":1,"stats":{"Line":2},"fn_name":null},{"line":786,"address":[5071873,5072207],"length":1,"stats":{"Line":2},"fn_name":null},{"line":787,"address":[5072481,5072620],"length":1,"stats":{"Line":1},"fn_name":null},{"line":788,"address":[5072590,5072993,5072887],"length":1,"stats":{"Line":2},"fn_name":null},{"line":793,"address":[4899344,4899366],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_slashing_reserved_balance_should_work"},{"line":794,"address":[4899351,4899381],"length":1,"stats":{"Line":3},"fn_name":null},{"line":795,"address":[5073310,5073348],"length":1,"stats":{"Line":2},"fn_name":null},{"line":796,"address":[5073368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":797,"address":[5073641],"length":1,"stats":{"Line":1},"fn_name":null},{"line":798,"address":[5074192,5074350],"length":1,"stats":{"Line":1},"fn_name":null},{"line":799,"address":[5074314,5074650,5074766],"length":1,"stats":{"Line":2},"fn_name":null},{"line":800,"address":[5075139,5074736,5075033],"length":1,"stats":{"Line":2},"fn_name":null},{"line":805,"address":[4899456,4899478],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_slashing_incomplete_reserved_balance_should_work"},{"line":806,"address":[4899463,4899493],"length":1,"stats":{"Line":3},"fn_name":null},{"line":807,"address":[5075470,5075508],"length":1,"stats":{"Line":2},"fn_name":null},{"line":808,"address":[5075528],"length":1,"stats":{"Line":1},"fn_name":null},{"line":809,"address":[5075801],"length":1,"stats":{"Line":1},"fn_name":null},{"line":810,"address":[5076510,5076352],"length":1,"stats":{"Line":1},"fn_name":null},{"line":811,"address":[5076810,5076926,5076474],"length":1,"stats":{"Line":2},"fn_name":null},{"line":812,"address":[5077299,5076896,5077193],"length":1,"stats":{"Line":2},"fn_name":null},{"line":817,"address":[4899590,4899568],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_repatriating_reserved_balance_should_work"},{"line":818,"address":[4899575,4899605],"length":1,"stats":{"Line":3},"fn_name":null},{"line":819,"address":[5077630],"length":1,"stats":{"Line":1},"fn_name":null},{"line":820,"address":[5077671],"length":1,"stats":{"Line":1},"fn_name":null},{"line":821,"address":[5077712],"length":1,"stats":{"Line":1},"fn_name":null},{"line":822,"address":[5078206,5078067],"length":1,"stats":{"Line":1},"fn_name":null},{"line":823,"address":[5077999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":826,"address":[5078514,5078649,5078177],"length":1,"stats":{"Line":2},"fn_name":null},{"line":827,"address":[5079084,5078949,5078613],"length":1,"stats":{"Line":2},"fn_name":null},{"line":828,"address":[5079048,5079378,5079504],"length":1,"stats":{"Line":2},"fn_name":null},{"line":829,"address":[5079771,5079877,5079471],"length":1,"stats":{"Line":2},"fn_name":null},{"line":834,"address":[4899702,4899680],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_transferring_reserved_balance_should_work"},{"line":835,"address":[4899687,4899717],"length":1,"stats":{"Line":3},"fn_name":null},{"line":836,"address":[5080190],"length":1,"stats":{"Line":1},"fn_name":null},{"line":837,"address":[5080231],"length":1,"stats":{"Line":1},"fn_name":null},{"line":838,"address":[5080272],"length":1,"stats":{"Line":1},"fn_name":null},{"line":839,"address":[5080627,5080766],"length":1,"stats":{"Line":1},"fn_name":null},{"line":840,"address":[5080559],"length":1,"stats":{"Line":1},"fn_name":null},{"line":843,"address":[5080737,5081209,5081074],"length":1,"stats":{"Line":2},"fn_name":null},{"line":844,"address":[5081509,5081644,5081173],"length":1,"stats":{"Line":2},"fn_name":null},{"line":845,"address":[5081608,5081938,5082064],"length":1,"stats":{"Line":2},"fn_name":null},{"line":846,"address":[5082437,5082331,5082031],"length":1,"stats":{"Line":2},"fn_name":null},{"line":851,"address":[4899814,4899792],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_transferring_reserved_balance_to_nonexistent_should_fail"},{"line":852,"address":[4899829,4899799],"length":1,"stats":{"Line":3},"fn_name":null},{"line":853,"address":[5082750],"length":1,"stats":{"Line":1},"fn_name":null},{"line":854,"address":[5082785],"length":1,"stats":{"Line":1},"fn_name":null},{"line":855,"address":[5083041],"length":1,"stats":{"Line":1},"fn_name":null},{"line":859,"address":[5083033],"length":1,"stats":{"Line":1},"fn_name":null},{"line":865,"address":[4899926,4899904],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_transferring_incomplete_reserved_balance_should_work"},{"line":866,"address":[4899941,4899911],"length":1,"stats":{"Line":3},"fn_name":null},{"line":867,"address":[5083358],"length":1,"stats":{"Line":1},"fn_name":null},{"line":868,"address":[5083399],"length":1,"stats":{"Line":1},"fn_name":null},{"line":869,"address":[5083440],"length":1,"stats":{"Line":1},"fn_name":null},{"line":870,"address":[5083795,5083934],"length":1,"stats":{"Line":1},"fn_name":null},{"line":871,"address":[5083727],"length":1,"stats":{"Line":1},"fn_name":null},{"line":874,"address":[5083905,5084242,5084377],"length":1,"stats":{"Line":2},"fn_name":null},{"line":875,"address":[5084812,5084677,5084341],"length":1,"stats":{"Line":2},"fn_name":null},{"line":876,"address":[5084776,5085232,5085106],"length":1,"stats":{"Line":2},"fn_name":null},{"line":877,"address":[5085499,5085199,5085605],"length":1,"stats":{"Line":2},"fn_name":null},{"line":882,"address":[4900016,4900038],"length":1,"stats":{"Line":3},"fn_name":"currency_adapter_transferring_too_high_value_should_not_panic"},{"line":883,"address":[4900053,4900023],"length":1,"stats":{"Line":3},"fn_name":null},{"line":884,"address":[5085928,5085911],"length":1,"stats":{"Line":2},"fn_name":null},{"line":885,"address":[5085976],"length":1,"stats":{"Line":1},"fn_name":null},{"line":887,"address":[5086022,5086118],"length":1,"stats":{"Line":2},"fn_name":null},{"line":888,"address":[5086046],"length":1,"stats":{"Line":1},"fn_name":null},{"line":892,"address":[5086038],"length":1,"stats":{"Line":1},"fn_name":null},{"line":894,"address":[5086110],"length":1,"stats":{"Line":1},"fn_name":null},{"line":897,"address":[5087367,5087242],"length":1,"stats":{"Line":1},"fn_name":null},{"line":898,"address":[5087197],"length":1,"stats":{"Line":1},"fn_name":null},{"line":901,"address":[5087713,5087334,5087831],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":505,"coverable":505},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","arithmetic.rs"],"content":"pub use num_traits::{\n\tBounded, CheckedAdd, CheckedDiv, CheckedMul, CheckedShl, CheckedShr, CheckedSub, One, Signed, Zero,\n};\nuse sp_std::{\n\tself,\n\tconvert::{TryFrom, TryInto},\n\tops::{Add, AddAssign, Div, DivAssign, Mul, MulAssign, Rem, RemAssign, Shl, Shr, Sub, SubAssign},\n};\n\n/// A meta trait for arithmetic.\n///\n/// Arithmetic types do all the usual stuff you'd expect numbers to do. They are\n/// guaranteed to be able to represent at least `u32` values without loss, hence\n/// the trait implies `From\u003cu32\u003e` and smaller ints. All other conversions are\n/// fallible.\npub trait SimpleArithmetic:\n\tZero\n\t+ One\n\t+ From\u003cu8\u003e\n\t+ From\u003cu16\u003e\n\t+ From\u003cu32\u003e\n\t+ TryInto\u003cu8\u003e\n\t+ TryInto\u003cu16\u003e\n\t+ TryInto\u003cu32\u003e\n\t+ TryFrom\u003cu64\u003e\n\t+ TryInto\u003cu64\u003e\n\t+ TryFrom\u003cu128\u003e\n\t+ TryInto\u003cu128\u003e\n\t+ Add\u003cSelf, Output = Self\u003e\n\t+ AddAssign\u003cSelf\u003e\n\t+ Sub\u003cSelf, Output = Self\u003e\n\t+ SubAssign\u003cSelf\u003e\n\t+ Mul\u003cSelf, Output = Self\u003e\n\t+ MulAssign\u003cSelf\u003e\n\t+ Div\u003cSelf, Output = Self\u003e\n\t+ DivAssign\u003cSelf\u003e\n\t+ Rem\u003cSelf, Output = Self\u003e\n\t+ RemAssign\u003cSelf\u003e\n\t+ Shl\u003cu32, Output = Self\u003e\n\t+ Shr\u003cu32, Output = Self\u003e\n\t+ CheckedShl\n\t+ CheckedShr\n\t+ CheckedAdd\n\t+ CheckedSub\n\t+ CheckedMul\n\t+ CheckedDiv\n\t+ PartialOrd\u003cSelf\u003e\n\t+ Ord\n\t+ Bounded\n\t+ Sized\n{\n}\n\nimpl\u003c\n\t\tT: Zero\n\t\t\t+ One\n\t\t\t+ From\u003cu8\u003e\n\t\t\t+ From\u003cu16\u003e\n\t\t\t+ From\u003cu32\u003e\n\t\t\t+ TryInto\u003cu8\u003e\n\t\t\t+ TryInto\u003cu16\u003e\n\t\t\t+ TryInto\u003cu32\u003e\n\t\t\t+ TryFrom\u003cu64\u003e\n\t\t\t+ TryInto\u003cu64\u003e\n\t\t\t+ TryFrom\u003cu128\u003e\n\t\t\t+ TryInto\u003cu128\u003e\n\t\t\t+ Add\u003cSelf, Output = Self\u003e\n\t\t\t+ AddAssign\u003cSelf\u003e\n\t\t\t+ Sub\u003cSelf, Output = Self\u003e\n\t\t\t+ SubAssign\u003cSelf\u003e\n\t\t\t+ Mul\u003cSelf, Output = Self\u003e\n\t\t\t+ MulAssign\u003cSelf\u003e\n\t\t\t+ Div\u003cSelf, Output = Self\u003e\n\t\t\t+ DivAssign\u003cSelf\u003e\n\t\t\t+ Rem\u003cSelf, Output = Self\u003e\n\t\t\t+ RemAssign\u003cSelf\u003e\n\t\t\t+ Shl\u003cu32, Output = Self\u003e\n\t\t\t+ Shr\u003cu32, Output = Self\u003e\n\t\t\t+ CheckedShl\n\t\t\t+ CheckedShr\n\t\t\t+ CheckedAdd\n\t\t\t+ CheckedSub\n\t\t\t+ CheckedMul\n\t\t\t+ CheckedDiv\n\t\t\t+ PartialOrd\u003cSelf\u003e\n\t\t\t+ Ord\n\t\t\t+ Bounded\n\t\t\t+ Sized,\n\t\u003e SimpleArithmetic for T\n{\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","auction.rs"],"content":"use crate::Change;\nuse codec::FullCodec;\nuse codec::{Decode, Encode};\nuse sp_runtime::{\n\ttraits::{AtLeast32Bit, Bounded, MaybeSerializeDeserialize},\n\tDispatchError, DispatchResult, RuntimeDebug,\n};\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tfmt::Debug,\n\tresult,\n};\n\n/// Auction info.\n#[cfg_attr(feature = \"std\", derive(PartialEq, Eq))]\n#[derive(Encode, Decode, RuntimeDebug)]\npub struct AuctionInfo\u003cAccountId, Balance, BlockNumber\u003e {\n\t/// Current bidder and bid price.\n\tpub bid: Option\u003c(AccountId, Balance)\u003e,\n\t/// Define which block this auction will be started.\n\tpub start: BlockNumber,\n\t/// Define which block this auction will be ended.\n\tpub end: Option\u003cBlockNumber\u003e,\n}\n\n/// Abstraction over a simple auction system.\npub trait Auction\u003cAccountId, BlockNumber\u003e {\n\t/// The id of an AuctionInfo\n\ttype AuctionId: FullCodec + Default + Copy + Eq + PartialEq + MaybeSerializeDeserialize + Bounded + Debug;\n\t/// The price to bid.\n\ttype Balance: AtLeast32Bit + FullCodec + Copy + MaybeSerializeDeserialize + Debug + Default;\n\n\t/// The auction info of `id`\n\tfn auction_info(id: Self::AuctionId) -\u003e Option\u003cAuctionInfo\u003cAccountId, Self::Balance, BlockNumber\u003e\u003e;\n\t/// Update the auction info of `id` with `info`\n\tfn update_auction(id: Self::AuctionId, info: AuctionInfo\u003cAccountId, Self::Balance, BlockNumber\u003e) -\u003e DispatchResult;\n\t/// Create new auction with specific startblock and endblock, return the id\n\t/// of the auction\n\tfn new_auction(start: BlockNumber, end: Option\u003cBlockNumber\u003e) -\u003e result::Result\u003cSelf::AuctionId, DispatchError\u003e;\n\t/// Remove auction by `id`\n\tfn remove_auction(id: Self::AuctionId);\n}\n\n/// The result of bid handling.\npub struct OnNewBidResult\u003cBlockNumber\u003e {\n\t/// Indicates if the bid was accepted\n\tpub accept_bid: bool,\n\t/// The auction end change.\n\tpub auction_end_change: Change\u003cOption\u003cBlockNumber\u003e\u003e,\n}\n\n/// Hooks for auction to handle bids.\npub trait AuctionHandler\u003cAccountId, Balance, BlockNumber, AuctionId\u003e {\n\t/// Called when new bid is received.\n\t/// The return value determines if the bid should be accepted and update\n\t/// auction end time. Implementation should reserve money from current\n\t/// winner and refund previous winner.\n\tfn on_new_bid(\n\t\tnow: BlockNumber,\n\t\tid: AuctionId,\n\t\tnew_bid: (AccountId, Balance),\n\t\tlast_bid: Option\u003c(AccountId, Balance)\u003e,\n\t) -\u003e OnNewBidResult\u003cBlockNumber\u003e;\n\t/// End an auction with `winner`\n\tfn on_auction_ended(id: AuctionId, winner: Option\u003c(AccountId, Balance)\u003e);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","currency.rs"],"content":"use crate::arithmetic;\nuse codec::{Codec, FullCodec};\npub use frame_support::traits::{BalanceStatus, LockIdentifier};\nuse sp_runtime::{\n\ttraits::{AtLeast32BitUnsigned, MaybeSerializeDeserialize},\n\tDispatchError, DispatchResult,\n};\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tconvert::{TryFrom, TryInto},\n\tfmt::Debug,\n\tresult,\n};\n\n/// Abstraction over a fungible multi-currency system.\npub trait MultiCurrency\u003cAccountId\u003e {\n\t/// The currency identifier.\n\ttype CurrencyId: FullCodec + Eq + PartialEq + Copy + MaybeSerializeDeserialize + Debug;\n\n\t/// The balance of an account.\n\ttype Balance: AtLeast32BitUnsigned + FullCodec + Copy + MaybeSerializeDeserialize + Debug + Default;\n\n\t// Public immutables\n\n\t/// The total amount of issuance of `currency_id`.\n\tfn total_issuance(currency_id: Self::CurrencyId) -\u003e Self::Balance;\n\n\t// The combined balance of `who` under `currency_id`.\n\tfn total_balance(currency_id: Self::CurrencyId, who: \u0026AccountId) -\u003e Self::Balance;\n\n\t// The free balance of `who` under `currency_id`.\n\tfn free_balance(currency_id: Self::CurrencyId, who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// A dry-run of `withdraw`. Returns `Ok` iff the account is able to make a\n\t/// withdrawal of the given amount.\n\tfn ensure_can_withdraw(currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t// Public mutables\n\n\t/// Transfer some amount from one account to another.\n\tfn transfer(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tfrom: \u0026AccountId,\n\t\tto: \u0026AccountId,\n\t\tamount: Self::Balance,\n\t) -\u003e DispatchResult;\n\n\t/// Add `amount` to the balance of `who` under `currency_id` and increase\n\t/// total issuance.\n\tfn deposit(currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Remove `amount` from the balance of `who` under `currency_id` and reduce\n\t/// total issuance.\n\tfn withdraw(currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Same result as `slash(currency_id, who, value)` (but without the\n\t/// side-effects) assuming there are no balance changes in the meantime and\n\t/// only the reserved balance is not taken into account.\n\tfn can_slash(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e bool;\n\n\t/// Deduct the balance of `who` by up to `amount`.\n\t///\n\t/// As much funds up to `amount` will be deducted as possible.  If this is\n\t/// less than `amount`,then a non-zero value will be returned.\n\tfn slash(currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance) -\u003e Self::Balance;\n}\n\n/// Extended `MultiCurrency` with additional helper types and methods.\npub trait MultiCurrencyExtended\u003cAccountId\u003e: MultiCurrency\u003cAccountId\u003e {\n\t/// The type for balance related operations, typically signed int.\n\ttype Amount: arithmetic::Signed\n\t\t+ TryInto\u003cSelf::Balance\u003e\n\t\t+ TryFrom\u003cSelf::Balance\u003e\n\t\t+ arithmetic::SimpleArithmetic\n\t\t+ Codec\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ Default;\n\n\t/// Add or remove abs(`by_amount`) from the balance of `who` under\n\t/// `currency_id`. If positive `by_amount`, do add, else do remove.\n\tfn update_balance(currency_id: Self::CurrencyId, who: \u0026AccountId, by_amount: Self::Amount) -\u003e DispatchResult;\n}\n\n/// A fungible multi-currency system whose accounts can have liquidity\n/// restrictions.\npub trait MultiLockableCurrency\u003cAccountId\u003e: MultiCurrency\u003cAccountId\u003e {\n\t/// The quantity used to denote time; usually just a `BlockNumber`.\n\ttype Moment;\n\n\t/// Create a new balance lock on account `who`.\n\t///\n\t/// If the new lock is valid (i.e. not already expired), it will push the\n\t/// struct to the `Locks` vec in storage. Note that you can lock more funds\n\t/// than a user has.\n\t///\n\t/// If the lock `lock_id` already exists, this will update it.\n\tfn set_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance);\n\n\t/// Changes a balance lock (selected by `lock_id`) so that it becomes less\n\t/// liquid in all parameters or creates a new one if it does not exist.\n\t///\n\t/// Calling `extend_lock` on an existing lock `lock_id` differs from\n\t/// `set_lock` in that it applies the most severe constraints of the two,\n\t/// while `set_lock` replaces the lock with the new parameters. As in,\n\t/// `extend_lock` will set:\n\t/// - maximum `amount`\n\tfn extend_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026AccountId, amount: Self::Balance);\n\n\t/// Remove an existing lock.\n\tfn remove_lock(lock_id: LockIdentifier, currency_id: Self::CurrencyId, who: \u0026AccountId);\n}\n\n/// A fungible multi-currency system where funds can be reserved from the user.\npub trait MultiReservableCurrency\u003cAccountId\u003e: MultiCurrency\u003cAccountId\u003e {\n\t/// Same result as `reserve(who, value)` (but without the side-effects)\n\t/// assuming there are no balance changes in the meantime.\n\tfn can_reserve(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e bool;\n\n\t/// Deducts up to `value` from reserved balance of `who`. This function\n\t/// cannot fail.\n\t///\n\t/// As much funds up to `value` will be deducted as possible. If the reserve\n\t/// balance of `who` is less than `value`, then a non-zero second item will\n\t/// be returned.\n\tfn slash_reserved(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance;\n\n\t/// The amount of the balance of a given account that is externally\n\t/// reserved; this can still get slashed, but gets slashed last of all.\n\t///\n\t/// This balance is a 'reserve' balance that other subsystems use in order\n\t/// to set aside tokens that are still 'owned' by the account holder, but\n\t/// which are suspendable.\n\tfn reserved_balance(currency_id: Self::CurrencyId, who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// Moves `value` from balance to reserved balance.\n\t///\n\t/// If the free balance is lower than `value`, then no funds will be moved\n\t/// and an `Err` will be returned to notify of this. This is different\n\t/// behavior than `unreserve`.\n\tfn reserve(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e DispatchResult;\n\n\t/// Moves up to `value` from reserved balance to free balance. This function\n\t/// cannot fail.\n\t///\n\t/// As much funds up to `value` will be moved as possible. If the reserve\n\t/// balance of `who` is less than `value`, then the remaining amount will be\n\t/// returned.\n\t///\n\t/// # NOTES\n\t///\n\t/// - This is different from `reserve`.\n\tfn unreserve(currency_id: Self::CurrencyId, who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance;\n\n\t/// Moves up to `value` from reserved balance of account `slashed` to\n\t/// balance of account `beneficiary`. `beneficiary` must exist for this to\n\t/// succeed. If it does not, `Err` will be returned. Funds will be placed in\n\t/// either the `free` balance or the `reserved` balance, depending on the\n\t/// `status`.\n\t///\n\t/// As much funds up to `value` will be deducted as possible. If this is\n\t/// less than `value`, then `Ok(non_zero)` will be returned.\n\tfn repatriate_reserved(\n\t\tcurrency_id: Self::CurrencyId,\n\t\tslashed: \u0026AccountId,\n\t\tbeneficiary: \u0026AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e;\n}\n\n/// Abstraction over a fungible (single) currency system.\npub trait BasicCurrency\u003cAccountId\u003e {\n\t/// The balance of an account.\n\ttype Balance: AtLeast32BitUnsigned + FullCodec + Copy + MaybeSerializeDeserialize + Debug + Default;\n\n\t// Public immutables\n\n\t/// The total amount of issuance.\n\tfn total_issuance() -\u003e Self::Balance;\n\n\t/// The combined balance of `who`.\n\tfn total_balance(who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// The free balance of `who`.\n\tfn free_balance(who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// A dry-run of `withdraw`. Returns `Ok` iff the account is able to make a\n\t/// withdrawal of the given amount.\n\tfn ensure_can_withdraw(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t// Public mutables\n\n\t/// Transfer some amount from one account to another.\n\tfn transfer(from: \u0026AccountId, to: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Add `amount` to the balance of `who` and increase total issuance.\n\tfn deposit(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Remove `amount` from the balance of `who` and reduce total issuance.\n\tfn withdraw(who: \u0026AccountId, amount: Self::Balance) -\u003e DispatchResult;\n\n\t/// Same result as `slash(who, value)` (but without the side-effects)\n\t/// assuming there are no balance changes in the meantime and only the\n\t/// reserved balance is not taken into account.\n\tfn can_slash(who: \u0026AccountId, value: Self::Balance) -\u003e bool;\n\n\t/// Deduct the balance of `who` by up to `amount`.\n\t///\n\t/// As much funds up to `amount` will be deducted as possible. If this is\n\t/// less than `amount`,then a non-zero value will be returned.\n\tfn slash(who: \u0026AccountId, amount: Self::Balance) -\u003e Self::Balance;\n}\n\n/// Extended `BasicCurrency` with additional helper types and methods.\npub trait BasicCurrencyExtended\u003cAccountId\u003e: BasicCurrency\u003cAccountId\u003e {\n\t/// The signed type for balance related operations, typically signed int.\n\ttype Amount: arithmetic::Signed\n\t\t+ TryInto\u003cSelf::Balance\u003e\n\t\t+ TryFrom\u003cSelf::Balance\u003e\n\t\t+ arithmetic::SimpleArithmetic\n\t\t+ Codec\n\t\t+ Copy\n\t\t+ MaybeSerializeDeserialize\n\t\t+ Debug\n\t\t+ Default;\n\n\t/// Add or remove abs(`by_amount`) from the balance of `who`. If positive\n\t/// `by_amount`, do add, else do remove.\n\tfn update_balance(who: \u0026AccountId, by_amount: Self::Amount) -\u003e DispatchResult;\n}\n\n/// A fungible single currency system whose accounts can have liquidity\n/// restrictions.\npub trait BasicLockableCurrency\u003cAccountId\u003e: BasicCurrency\u003cAccountId\u003e {\n\t/// The quantity used to denote time; usually just a `BlockNumber`.\n\ttype Moment;\n\n\t/// Create a new balance lock on account `who`.\n\t///\n\t/// If the new lock is valid (i.e. not already expired), it will push the\n\t/// struct to the `Locks` vec in storage. Note that you can lock more funds\n\t/// than a user has.\n\t///\n\t/// If the lock `lock_id` already exists, this will update it.\n\tfn set_lock(lock_id: LockIdentifier, who: \u0026AccountId, amount: Self::Balance);\n\n\t/// Changes a balance lock (selected by `lock_id`) so that it becomes less\n\t/// liquid in all parameters or creates a new one if it does not exist.\n\t///\n\t/// Calling `extend_lock` on an existing lock `lock_id` differs from\n\t/// `set_lock` in that it applies the most severe constraints of the two,\n\t/// while `set_lock` replaces the lock with the new parameters. As in,\n\t/// `extend_lock` will set:\n\t/// - maximum `amount`\n\tfn extend_lock(lock_id: LockIdentifier, who: \u0026AccountId, amount: Self::Balance);\n\n\t/// Remove an existing lock.\n\tfn remove_lock(lock_id: LockIdentifier, who: \u0026AccountId);\n}\n\n/// A fungible single currency system where funds can be reserved from the user.\npub trait BasicReservableCurrency\u003cAccountId\u003e: BasicCurrency\u003cAccountId\u003e {\n\t/// Same result as `reserve(who, value)` (but without the side-effects)\n\t/// assuming there are no balance changes in the meantime.\n\tfn can_reserve(who: \u0026AccountId, value: Self::Balance) -\u003e bool;\n\n\t/// Deducts up to `value` from reserved balance of `who`. This function\n\t/// cannot fail.\n\t///\n\t/// As much funds up to `value` will be deducted as possible. If the reserve\n\t/// balance of `who` is less than `value`, then a non-zero second item will\n\t/// be returned.\n\tfn slash_reserved(who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance;\n\n\t/// The amount of the balance of a given account that is externally\n\t/// reserved; this can still get slashed, but gets slashed last of all.\n\t///\n\t/// This balance is a 'reserve' balance that other subsystems use in order\n\t/// to set aside tokens that are still 'owned' by the account holder, but\n\t/// which are suspendable.\n\tfn reserved_balance(who: \u0026AccountId) -\u003e Self::Balance;\n\n\t/// Moves `value` from balance to reserved balance.\n\t///\n\t/// If the free balance is lower than `value`, then no funds will be moved\n\t/// and an `Err` will be returned to notify of this. This is different\n\t/// behavior than `unreserve`.\n\tfn reserve(who: \u0026AccountId, value: Self::Balance) -\u003e DispatchResult;\n\n\t/// Moves up to `value` from reserved balance to free balance. This function\n\t/// cannot fail.\n\t///\n\t/// As much funds up to `value` will be moved as possible. If the reserve\n\t/// balance of `who` is less than `value`, then the remaining amount will be\n\t/// returned.\n\t///\n\t/// # NOTES\n\t///\n\t/// - This is different from `reserve`.\n\tfn unreserve(who: \u0026AccountId, value: Self::Balance) -\u003e Self::Balance;\n\n\t/// Moves up to `value` from reserved balance of account `slashed` to\n\t/// balance of account `beneficiary`. `beneficiary` must exist for this to\n\t/// succeed. If it does not, `Err` will be returned. Funds will be placed in\n\t/// either the `free` balance or the `reserved` balance, depending on the\n\t/// `status`.\n\t///\n\t/// As much funds up to `value` will be deducted as possible. If this is\n\t/// less than `value`, then `Ok(non_zero)` will be returned.\n\tfn repatriate_reserved(\n\t\tslashed: \u0026AccountId,\n\t\tbeneficiary: \u0026AccountId,\n\t\tvalue: Self::Balance,\n\t\tstatus: BalanceStatus,\n\t) -\u003e result::Result\u003cSelf::Balance, DispatchError\u003e;\n}\n\n/// Handler when an account received some assets\n#[impl_trait_for_tuples::impl_for_tuples(30)]\npub trait OnReceived\u003cAccountId, CurrencyId, Balance\u003e {\n\t/// An account have received some assets\n\tfn on_received(account: \u0026AccountId, currency: CurrencyId, amount: Balance);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","data_provider.rs"],"content":"use sp_runtime::DispatchResult;\nuse sp_std::vec::Vec;\n\n/// Data provider with ability to provide data with no-op, and provide all data.\npub trait DataFeeder\u003cKey, Value, AccountId\u003e: DataProvider\u003cKey, Value\u003e {\n\t/// Provide a new value for a given key from an operator\n\tfn feed_value(who: AccountId, key: Key, value: Value) -\u003e DispatchResult;\n}\n\n/// A simple trait to provide data\npub trait DataProvider\u003cKey, Value\u003e {\n\t/// Get data by key\n\tfn get(key: \u0026Key) -\u003e Option\u003cValue\u003e;\n}\n\n/// Extended data provider to provide timestamped data by key with no-op, and\n/// all data.\npub trait DataProviderExtended\u003cKey, TimestampedValue\u003e {\n\t/// Get timestamped value by key\n\tfn get_no_op(key: \u0026Key) -\u003e Option\u003cTimestampedValue\u003e;\n\t/// Provide a list of tuples of key and timestamped value\n\tfn get_all_values() -\u003e Vec\u003c(Key, Option\u003cTimestampedValue\u003e)\u003e;\n}\n\n#[allow(dead_code)] // rust cannot detect usage in macro_rules\npub fn median\u003cT: Ord + Clone\u003e(mut items: Vec\u003cT\u003e) -\u003e Option\u003cT\u003e {\n\tif items.is_empty() {\n\t\treturn None;\n\t}\n\n\tlet mid_index = items.len() / 2;\n\n\titems.sort();\n\n\t// Won't panic as guarded items not empty case.\n\tSome(items[mid_index as usize].clone())\n}\n\n#[macro_export]\nmacro_rules! create_median_value_data_provider {\n\t($name:ident, $key:ty, $value:ty, $timestamped_value:ty, [$( $provider:ty ),*]) =\u003e {\n\t\tpub struct $name;\n\t\timpl $crate::DataProvider\u003c$key, $value\u003e for $name {\n\t\t\tfn get(key: \u0026$key) -\u003e Option\u003c$value\u003e {\n\t\t\t\tlet mut values = vec![];\n\t\t\t\t$(\n\t\t\t\t\tif let Some(v) = \u003c$provider as $crate::DataProvider\u003c$key, $value\u003e\u003e::get(\u0026key) {\n\t\t\t\t\t\tvalues.push(v);\n\t\t\t\t\t}\n\t\t\t\t)*\n\t\t\t\t$crate::data_provider::median(values)\n\t\t\t}\n\t\t}\n\t\timpl $crate::DataProviderExtended\u003c$key, $timestamped_value\u003e for $name {\n\t\t\tfn get_no_op(key: \u0026$key) -\u003e Option\u003c$timestamped_value\u003e {\n\t\t\t\tlet mut values = vec![];\n\t\t\t\t$(\n\t\t\t\t\tif let Some(v) = \u003c$provider as $crate::DataProviderExtended\u003c$key, $timestamped_value\u003e\u003e::get_no_op(\u0026key) {\n\t\t\t\t\t\tvalues.push(v);\n\t\t\t\t\t}\n\t\t\t\t)*\n\t\t\t\t$crate::data_provider::median(values)\n\t\t\t}\n\t\t\tfn get_all_values() -\u003e Vec\u003c($key, Option\u003c$timestamped_value\u003e)\u003e {\n\t\t\t\tlet mut keys = sp_std::collections::btree_set::BTreeSet::new();\n\t\t\t\t$(\n\t\t\t\t\t\u003c$provider as $crate::DataProviderExtended\u003c$key, $timestamped_value\u003e\u003e::get_all_values()\n\t\t\t\t\t\t.into_iter()\n\t\t\t\t\t\t.for_each(|(k, _)| { keys.insert(k); });\n\t\t\t\t)*\n\t\t\t\tkeys.into_iter().map(|k| (k, Self::get_no_op(\u0026k))).collect()\n\t\t\t}\n\t\t}\n\t}\n}\n\n#[cfg(test)]\nmod tests {\n\tuse super::*;\n\tuse sp_std::cell::RefCell;\n\n\tthread_local! {\n\t\tstatic MOCK_PRICE_1: RefCell\u003cOption\u003cu8\u003e\u003e = RefCell::new(None);\n\t\tstatic MOCK_PRICE_2: RefCell\u003cOption\u003cu8\u003e\u003e = RefCell::new(None);\n\t\tstatic MOCK_PRICE_3: RefCell\u003cOption\u003cu8\u003e\u003e = RefCell::new(None);\n\t\tstatic MOCK_PRICE_4: RefCell\u003cOption\u003cu8\u003e\u003e = RefCell::new(None);\n\t}\n\n\tmacro_rules! mock_data_provider {\n\t\t($provider:ident, $price:ident) =\u003e {\n\t\t\tpub struct $provider;\n\t\t\timpl $provider {\n\t\t\t\tfn set_price(price: Option\u003cu8\u003e) {\n\t\t\t\t\t$price.with(|v| *v.borrow_mut() = price)\n\t\t\t\t}\n\t\t\t}\n\t\t\timpl DataProvider\u003cu8, u8\u003e for $provider {\n\t\t\t\tfn get(_: \u0026u8) -\u003e Option\u003cu8\u003e {\n\t\t\t\t\t$price.with(|v| *v.borrow())\n\t\t\t\t}\n\t\t\t}\n\t\t\timpl DataProviderExtended\u003cu8, u8\u003e for $provider {\n\t\t\t\tfn get_no_op(_: \u0026u8) -\u003e Option\u003cu8\u003e {\n\t\t\t\t\t$price.with(|v| *v.borrow())\n\t\t\t\t}\n\t\t\t\tfn get_all_values() -\u003e Vec\u003c(u8, Option\u003cu8\u003e)\u003e {\n\t\t\t\t\tvec![(0, Self::get_no_op(\u00260))]\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n\n\tmock_data_provider!(Provider1, MOCK_PRICE_1);\n\tmock_data_provider!(Provider2, MOCK_PRICE_2);\n\tmock_data_provider!(Provider3, MOCK_PRICE_3);\n\tmock_data_provider!(Provider4, MOCK_PRICE_4);\n\n\tcreate_median_value_data_provider!(Providers, u8, u8, u8, [Provider1, Provider2, Provider3, Provider4]);\n\n\t#[test]\n\tfn median_value_data_provider_works() {\n\t\tassert_eq!(\u003cProviders as DataProvider\u003c_, _\u003e\u003e::get(\u00260), None);\n\n\t\tlet data = vec![\n\t\t\t(vec![None, None, None, Some(1)], Some(1)),\n\t\t\t(vec![None, None, Some(2), Some(1)], Some(2)),\n\t\t\t(vec![Some(5), Some(2), None, Some(7)], Some(5)),\n\t\t\t(vec![Some(5), Some(13), Some(2), Some(7)], Some(7)),\n\t\t];\n\n\t\tfor (values, target) in data {\n\t\t\tProvider1::set_price(values[0]);\n\t\t\tProvider2::set_price(values[1]);\n\t\t\tProvider3::set_price(values[2]);\n\t\t\tProvider4::set_price(values[3]);\n\n\t\t\tassert_eq!(\u003cProviders as DataProvider\u003c_, _\u003e\u003e::get(\u00260), target);\n\t\t}\n\t}\n}\n","traces":[{"line":26,"address":[4254048,4254072],"length":1,"stats":{"Line":1},"fn_name":"median\u003cu8\u003e"},{"line":27,"address":[4254088,4254052],"length":1,"stats":{"Line":2},"fn_name":null},{"line":28,"address":[4254128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4254162,4254107],"length":1,"stats":{"Line":2},"fn_name":null},{"line":33,"address":[4254170],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4254218],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[4221088,4221123],"length":1,"stats":{"Line":1},"fn_name":"get"},{"line":45,"address":[4221100],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4221493,4221376,4221403,4221223,4221466,4221313,4221135,4221196,4221286],"length":1,"stats":{"Line":9},"fn_name":null},{"line":48,"address":[4221205,4221295,4221475,4221385,4221281,4221461,4221371,4221191],"length":1,"stats":{"Line":8},"fn_name":null},{"line":51,"address":[4221495],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[4221616,4221651],"length":1,"stats":{"Line":0},"fn_name":"get_no_op"},{"line":56,"address":[4221628],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[4221751,4221931,4222021,4221841,4221904,4221814,4221724,4221663,4221994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[4221733,4221899,4221913,4221809,4221989,4221823,4221719,4222003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[4222023],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[4222195,4222144],"length":1,"stats":{"Line":0},"fn_name":"get_all_values"},{"line":65,"address":[4222154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[4222385,4222249,4222215,4222314,4222459],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[4222377,4222306,4222451,4222244],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[4222482],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[4219236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[4219364],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4219492],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[4219620],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[4220752,4220080,4220416,4219744],"length":1,"stats":{"Line":4},"fn_name":"set_price"},{"line":94,"address":[4262000,4261552,4262910,4262462,4261566,4262896,4262014,4262448],"length":1,"stats":{"Line":12},"fn_name":"{{closure}}"},{"line":98,"address":[4220144,4220816,4219808,4220480],"length":1,"stats":{"Line":4},"fn_name":"get"},{"line":99,"address":[4220496,4220832,4219824,4220160],"length":1,"stats":{"Line":12},"fn_name":null},{"line":103,"address":[4220192,4220528,4219856,4220864],"length":1,"stats":{"Line":0},"fn_name":"get_no_op"},{"line":104,"address":[4220208,4220880,4219872,4220544],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[4220638,4220240,4220974,4220912,4219966,4220576,4220302,4219904],"length":1,"stats":{"Line":0},"fn_name":"get_all_values"},{"line":107,"address":[4220314,4220986,4220934,4221062,4220726,4219978,4220054,4219926,4220390,4220650,4220598,4220262],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[4222672,4222715],"length":1,"stats":{"Line":3},"fn_name":"median_value_data_provider_works"},{"line":122,"address":[4223057,4222679,4222737],"length":1,"stats":{"Line":2},"fn_name":null},{"line":124,"address":[4223348,4222855,4223874,4224262,4223607,4224149],"length":1,"stats":{"Line":2},"fn_name":null},{"line":125,"address":[4222892,4223366],"length":1,"stats":{"Line":2},"fn_name":null},{"line":126,"address":[4223625,4223452],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[4223711,4223892],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[4223978,4224167],"length":1,"stats":{"Line":2},"fn_name":null},{"line":131,"address":[4224695,4224490,4225589],"length":1,"stats":{"Line":2},"fn_name":null},{"line":132,"address":[4224869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[4224941],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[4224998],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[4225049],"length":1,"stats":{"Line":1},"fn_name":null},{"line":137,"address":[4225280,4225100],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":32,"coverable":46},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","get_by_key.rs"],"content":"/// A trait for querying a value by a key.\npub trait GetByKey\u003cKey, Value\u003e {\n\t/// Return the value.\n\tfn get(k: \u0026Key) -\u003e Value;\n}\n\n/// Create new implementations of the `GetByKey` trait.\n///\n/// The implementation is typically used like a map or set.\n///\n/// Example:\n/// ```ignore\n/// use primitives::CurrencyId;\n/// parameter_type_with_key! {\n///     pub Rates: |currency_id: CurrencyId| -\u003e u32 {\n///         match currency_id {\n///             CurrencyId::DOT =\u003e 1,\n///             CurrencyId::KSM =\u003e 2,\n///             _ =\u003e 3,\n///         }\n///     }\n/// }\n/// ```\n#[macro_export]\nmacro_rules! parameter_type_with_key {\n\t(\n\t\tpub $name:ident: |$k:ident: $key:ty| -\u003e $value:ty $body:block;\n\t) =\u003e {\n\t\tpub struct $name;\n\t\timpl $crate::get_by_key::GetByKey\u003c$key, $value\u003e for $name {\n\t\t\tfn get($k: \u0026$key) -\u003e $value {\n\t\t\t\t$body\n\t\t\t}\n\t\t}\n\t};\n}\n\n#[cfg(test)]\nmod tests {\n\tuse super::*;\n\n\tparameter_type_with_key! {\n\t\tpub Test: |k: u32| -\u003e u32 {\n\t\t\tmatch k {\n\t\t\t\t1 =\u003e 1,\n\t\t\t\t_ =\u003e 2,\n\t\t\t}\n\t\t};\n\t}\n\n\t#[test]\n\tfn get_by_key_should_work() {\n\t\tassert_eq!(Test::get(\u00261), 1);\n\t\tassert_eq!(Test::get(\u00262), 2);\n\t\tassert_eq!(Test::get(\u00263), 2);\n\t}\n}\n","traces":[{"line":31,"address":[4280832],"length":1,"stats":{"Line":1},"fn_name":"get"},{"line":44,"address":[4280854],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4280841,4280856],"length":1,"stats":{"Line":2},"fn_name":null},{"line":46,"address":[4280846],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4280880],"length":1,"stats":{"Line":3},"fn_name":"get_by_key_should_work"},{"line":53,"address":[4280894,4281044],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4281338,4281457,4281009],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[4281824,4281425,4281724],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":8,"coverable":8},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse sp_runtime::RuntimeDebug;\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tprelude::Vec,\n};\n\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\n\npub use auction::{Auction, AuctionHandler, AuctionInfo, OnNewBidResult};\npub use currency::{\n\tBalanceStatus, BasicCurrency, BasicCurrencyExtended, BasicLockableCurrency, BasicReservableCurrency,\n\tLockIdentifier, MultiCurrency, MultiCurrencyExtended, MultiLockableCurrency, MultiReservableCurrency, OnReceived,\n};\npub use data_provider::{DataFeeder, DataProvider, DataProviderExtended};\npub use get_by_key::GetByKey;\npub use price::{DefaultPriceProvider, PriceProvider};\npub use rewards::RewardHandler;\n\npub mod arithmetic;\npub mod auction;\npub mod currency;\npub mod data_provider;\npub mod get_by_key;\npub mod price;\npub mod rewards;\n\n/// New data handler\n#[impl_trait_for_tuples::impl_for_tuples(30)]\npub trait OnNewData\u003cAccountId, Key, Value\u003e {\n\t/// New data is available\n\tfn on_new_data(who: \u0026AccountId, key: \u0026Key, value: \u0026Value);\n}\n\n/// Combine data provided by operators\npub trait CombineData\u003cKey, TimestampedValue\u003e {\n\t/// Combine data provided by operators\n\tfn combine_data(\n\t\tkey: \u0026Key,\n\t\tvalues: Vec\u003cTimestampedValue\u003e,\n\t\tprev_value: Option\u003cTimestampedValue\u003e,\n\t) -\u003e Option\u003cTimestampedValue\u003e;\n}\n\n/// Indicate if should change a value\n#[derive(Encode, Decode, Clone, Eq, PartialEq, RuntimeDebug)]\npub enum Change\u003cValue\u003e {\n\t/// No change.\n\tNoChange,\n\t/// Changed to new value.\n\tNewValue(Value),\n}\n\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Ord, PartialOrd, Clone, Copy)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub struct TimestampedValue\u003cValue: Ord + PartialOrd, Moment\u003e {\n\tpub value: Value,\n\tpub timestamp: Moment,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","price.rs"],"content":"use crate::DataProvider;\nuse frame_support::Parameter;\nuse sp_runtime::traits::{CheckedDiv, MaybeSerializeDeserialize, Member};\nuse sp_std::marker::PhantomData;\n\n/// A trait to provide relative price for two currencies\npub trait PriceProvider\u003cCurrencyId, Price\u003e {\n\tfn get_price(base: CurrencyId, quote: CurrencyId) -\u003e Option\u003cPrice\u003e;\n}\n\n/// A `PriceProvider` implementation based on price data from a `DataProvider`\npub struct DefaultPriceProvider\u003cCurrencyId, Source\u003e(PhantomData\u003c(CurrencyId, Source)\u003e);\n\nimpl\u003cCurrencyId, Source, Price\u003e PriceProvider\u003cCurrencyId, Price\u003e for DefaultPriceProvider\u003cCurrencyId, Source\u003e\nwhere\n\tCurrencyId: Parameter + Member + Copy + MaybeSerializeDeserialize,\n\tSource: DataProvider\u003cCurrencyId, Price\u003e,\n\tPrice: CheckedDiv,\n{\n\tfn get_price(base_currency_id: CurrencyId, quote_currency_id: CurrencyId) -\u003e Option\u003cPrice\u003e {\n\t\tlet base_price = Source::get(\u0026base_currency_id)?;\n\t\tlet quote_price = Source::get(\u0026quote_currency_id)?;\n\n\t\tbase_price.checked_div(\u0026quote_price)\n\t}\n}\n\n#[cfg(test)]\nmod test {\n\tuse super::*;\n\tuse sp_runtime::{FixedPointNumber, FixedU128};\n\n\ttype Price = FixedU128;\n\n\tpub struct MockDataProvider;\n\timpl DataProvider\u003cu32, Price\u003e for MockDataProvider {\n\t\tfn get(currency: \u0026u32) -\u003e Option\u003cPrice\u003e {\n\t\t\tmatch currency {\n\t\t\t\t0 =\u003e Some(Price::from_inner(0)),\n\t\t\t\t1 =\u003e Some(Price::from_inner(1)),\n\t\t\t\t2 =\u003e Some(Price::from_inner(2)),\n\t\t\t\t_ =\u003e None,\n\t\t\t}\n\t\t}\n\t}\n\n\ttype TestPriceProvider = DefaultPriceProvider\u003cu32, MockDataProvider\u003e;\n\n\t#[test]\n\tfn get_price_should_work() {\n\t\tassert_eq!(\n\t\t\tTestPriceProvider::get_price(1, 2),\n\t\t\tSome(Price::saturating_from_rational(1, 2))\n\t\t);\n\t\tassert_eq!(\n\t\t\tTestPriceProvider::get_price(2, 1),\n\t\t\tSome(Price::saturating_from_rational(2, 1))\n\t\t);\n\t}\n\n\t#[test]\n\tfn price_is_none_should_not_panic() {\n\t\tassert_eq!(TestPriceProvider::get_price(3, 3), None);\n\t\tassert_eq!(TestPriceProvider::get_price(3, 1), None);\n\t\tassert_eq!(TestPriceProvider::get_price(1, 3), None);\n\t}\n\n\t#[test]\n\tfn price_is_zero_should_not_panic() {\n\t\tassert_eq!(TestPriceProvider::get_price(0, 0), None);\n\t\tassert_eq!(TestPriceProvider::get_price(1, 0), None);\n\t\tassert_eq!(TestPriceProvider::get_price(0, 1), Some(Price::from_inner(0)));\n\t}\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":21,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":24,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":37,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":38,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":39,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":40,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4288080,4288085],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":51,"address":[4215673,4215833],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4215569],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[4215598],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[4216167,4216276],"length":1,"stats":{"Line":1},"fn_name":null},{"line":56,"address":[4215791],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4216104],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[4216544],"length":1,"stats":{"Line":3},"fn_name":"price_is_none_should_not_panic"},{"line":63,"address":[4216556,4216751],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4216709,4217059,4217199],"length":1,"stats":{"Line":2},"fn_name":null},{"line":65,"address":[4217578,4217474,4217160],"length":1,"stats":{"Line":2},"fn_name":null},{"line":69,"address":[4217856],"length":1,"stats":{"Line":3},"fn_name":"price_is_zero_should_not_panic"},{"line":70,"address":[4218057,4217865],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[4218015,4218517,4218365],"length":1,"stats":{"Line":2},"fn_name":null},{"line":72,"address":[4218475,4218788,4218964],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":25,"coverable":25},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","traits","src","rewards.rs"],"content":"use codec::FullCodec;\nuse sp_runtime::traits::{AtLeast32BitUnsigned, MaybeSerializeDeserialize};\nuse sp_std::{fmt::Debug, vec::Vec};\n\n/// Hooks to manage reward pool\npub trait RewardHandler\u003cAccountId, BlockNumber\u003e {\n\t/// The share type of pool\n\ttype Share: AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize + Debug;\n\n\t/// The reward balance type\n\ttype Balance: AtLeast32BitUnsigned + Default + Copy + MaybeSerializeDeserialize + Debug;\n\n\t/// The reward pool ID type\n\ttype PoolId: Copy + FullCodec;\n\n\t/// The currency type\n\ttype CurrencyId: FullCodec + Eq + PartialEq + Copy + MaybeSerializeDeserialize + Debug;\n\n\t/// Accumulate rewards\n\tfn accumulate_reward(\n\t\tnow: BlockNumber,\n\t\tcallback: impl FnMut(Self::PoolId, Self::Balance),\n\t) -\u003e Vec\u003c(Self::CurrencyId, Self::Balance)\u003e;\n\n\t/// Payout the reward to `who`\n\tfn payout(who: \u0026AccountId, pool: Self::PoolId, amount: Self::Balance);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","utilities","src","iterator.rs"],"content":"use codec::{Decode, EncodeLike, FullCodec, FullEncode};\nuse frame_support::{\n\tstorage::{\n\t\tgenerator::{StorageDoubleMap as StorageDoubleMapT, StorageMap as StorageMapT},\n\t\tunhashed, StorageDoubleMap, StorageMap,\n\t},\n\tReversibleStorageHasher,\n};\nuse sp_std::prelude::*;\n\n/// Utility to iterate through items in a storage map.\n/// Forks from substrate, expose previous_key field\npub struct StorageMapIterator\u003cK, V, Hasher\u003e {\n\tprefix: Vec\u003cu8\u003e,\n\tpub previous_key: Vec\u003cu8\u003e,\n\tdrain: bool,\n\t_phantom: sp_std::marker::PhantomData\u003c(K, V, Hasher)\u003e,\n}\n\n/// Forks from substrate\nimpl\u003cK: Decode + Sized, V: Decode + Sized, Hasher: ReversibleStorageHasher\u003e Iterator\n\tfor StorageMapIterator\u003cK, V, Hasher\u003e\n{\n\ttype Item = (K, V);\n\n\tfn next(\u0026mut self) -\u003e Option\u003c(K, V)\u003e {\n\t\tloop {\n\t\t\tlet maybe_next = sp_io::storage::next_key(\u0026self.previous_key).filter(|n| n.starts_with(\u0026self.prefix));\n\t\t\tbreak match maybe_next {\n\t\t\t\tSome(next) =\u003e {\n\t\t\t\t\tself.previous_key = next;\n\t\t\t\t\tmatch unhashed::get::\u003cV\u003e(\u0026self.previous_key) {\n\t\t\t\t\t\tSome(value) =\u003e {\n\t\t\t\t\t\t\tif self.drain {\n\t\t\t\t\t\t\t\tunhashed::kill(\u0026self.previous_key)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tlet mut key_material = Hasher::reverse(\u0026self.previous_key[self.prefix.len()..]);\n\t\t\t\t\t\t\tmatch K::decode(\u0026mut key_material) {\n\t\t\t\t\t\t\t\tOk(key) =\u003e Some((key, value)),\n\t\t\t\t\t\t\t\tErr(_) =\u003e continue,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tNone =\u003e continue,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tNone =\u003e None,\n\t\t\t};\n\t\t}\n\t}\n}\n\n/// Shim for StorageMapIterator, add more features\npub struct StorageMapIteratorShim\u003cK, V, H\u003e {\n\tpub storage_map_iterator: StorageMapIterator\u003cK, V, H\u003e,\n\tpub remain_iterator_count: Option\u003cu32\u003e,\n\tpub finished: bool,\n}\n\nimpl\u003cK: Decode + Sized, V: Decode + Sized, H: ReversibleStorageHasher\u003e Iterator for StorageMapIteratorShim\u003cK, V, H\u003e {\n\ttype Item = \u003cStorageMapIterator\u003cK, V, H\u003e as Iterator\u003e::Item;\n\n\tfn next(\u0026mut self) -\u003e Option\u003cSelf::Item\u003e {\n\t\t// check accumulated iteration count\n\t\tif let Some(remain_iterator_count) = self.remain_iterator_count {\n\t\t\tif remain_iterator_count == 0 {\n\t\t\t\treturn None;\n\t\t\t} else {\n\t\t\t\tself.remain_iterator_count = Some(remain_iterator_count - 1);\n\t\t\t}\n\t\t}\n\n\t\tself.storage_map_iterator.next().or_else(|| {\n\t\t\t// mark this map iterator has already finished\n\t\t\tself.finished = true;\n\t\t\tNone\n\t\t})\n\t}\n}\n\n/// A strongly-typed map in storage whose keys and values can be iterated over.\npub trait IterableStorageMapExtended\u003cK: FullEncode, V: FullCodec\u003e: StorageMap\u003cK, V\u003e {\n\t/// The type that iterates over all `(key, value)`.\n\ttype Iterator: Iterator\u003cItem = (K, V)\u003e;\n\n\t/// Enumerate all elements in the map in no particular order. If you alter\n\t/// the map while doing this, you'll get undefined results.\n\tfn iter(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator;\n\n\t/// Remove all elements from the map and iterate through them in no\n\t/// particular order. If you add elements to the map while doing this,\n\t/// you'll get undefined results.\n\tfn drain(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator;\n}\n\nimpl\u003cK: FullCodec, V: FullCodec, G: StorageMapT\u003cK, V\u003e\u003e IterableStorageMapExtended\u003cK, V\u003e for G\nwhere\n\tG::Hasher: ReversibleStorageHasher,\n{\n\ttype Iterator = StorageMapIteratorShim\u003cK, V, G::Hasher\u003e;\n\n\t/// Enumerate all elements in the map.\n\tfn iter(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator {\n\t\tlet prefix = G::prefix_hash();\n\t\tlet previous_key = start_key\n\t\t\t.filter(|k| k.starts_with(\u0026prefix))\n\t\t\t.unwrap_or_else(|| prefix.clone());\n\t\tlet storage_map_iterator = StorageMapIterator {\n\t\t\tprefix,\n\t\t\tprevious_key,\n\t\t\tdrain: false,\n\t\t\t_phantom: Default::default(),\n\t\t};\n\n\t\tStorageMapIteratorShim {\n\t\t\tstorage_map_iterator,\n\t\t\tremain_iterator_count: max_iterations,\n\t\t\tfinished: false,\n\t\t}\n\t}\n\n\t/// Enumerate all elements in the map.\n\tfn drain(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator {\n\t\tlet prefix = G::prefix_hash();\n\n\t\tlet previous_key = start_key\n\t\t\t.filter(|k| k.starts_with(\u0026prefix))\n\t\t\t.unwrap_or_else(|| prefix.clone());\n\t\tlet storage_map_iterator = StorageMapIterator {\n\t\t\tprefix,\n\t\t\tprevious_key,\n\t\t\tdrain: true,\n\t\t\t_phantom: Default::default(),\n\t\t};\n\n\t\tStorageMapIteratorShim {\n\t\t\tstorage_map_iterator,\n\t\t\tremain_iterator_count: max_iterations,\n\t\t\tfinished: false,\n\t\t}\n\t}\n}\n\n/// Iterate over a prefix and decode raw_key and raw_value into `T`.\n/// Forks from substrate, expose previous_key field\npub struct MapIterator\u003cT\u003e {\n\tprefix: Vec\u003cu8\u003e,\n\tpub previous_key: Vec\u003cu8\u003e,\n\t/// If true then value are removed while iterating\n\tdrain: bool,\n\t/// Function that take `(raw_key_without_prefix, raw_value)` and decode `T`.\n\t/// `raw_key_without_prefix` is the raw storage key without the prefix\n\t/// iterated on.\n\tclosure: fn(\u0026[u8], \u0026[u8]) -\u003e Result\u003cT, codec::Error\u003e,\n}\n\n/// Forks from substrate\nimpl\u003cT\u003e Iterator for MapIterator\u003cT\u003e {\n\ttype Item = T;\n\n\tfn next(\u0026mut self) -\u003e Option\u003cSelf::Item\u003e {\n\t\tloop {\n\t\t\tlet maybe_next = sp_io::storage::next_key(\u0026self.previous_key).filter(|n| n.starts_with(\u0026self.prefix));\n\t\t\tbreak match maybe_next {\n\t\t\t\tSome(next) =\u003e {\n\t\t\t\t\tself.previous_key = next;\n\t\t\t\t\tlet raw_value = match unhashed::get_raw(\u0026self.previous_key) {\n\t\t\t\t\t\tSome(raw_value) =\u003e raw_value,\n\t\t\t\t\t\tNone =\u003e {\n\t\t\t\t\t\t\tframe_support::print(\"ERROR: next_key returned a key with no value in MapIterator\");\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tif self.drain {\n\t\t\t\t\t\tunhashed::kill(\u0026self.previous_key)\n\t\t\t\t\t}\n\t\t\t\t\tlet raw_key_without_prefix = \u0026self.previous_key[self.prefix.len()..];\n\t\t\t\t\tlet item = match (self.closure)(raw_key_without_prefix, \u0026raw_value[..]) {\n\t\t\t\t\t\tOk(item) =\u003e item,\n\t\t\t\t\t\tErr(_e) =\u003e {\n\t\t\t\t\t\t\tframe_support::print(\"ERROR: (key, value) failed to decode in MapIterator\");\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\tSome(item)\n\t\t\t\t}\n\t\t\t\tNone =\u003e None,\n\t\t\t};\n\t\t}\n\t}\n}\n\n/// Shim for MapIterator, add more features\npub struct MapIteratorShim\u003cT\u003e {\n\tpub map_iterator: MapIterator\u003cT\u003e,\n\tpub remain_iterator_count: Option\u003cu32\u003e,\n\tpub finished: bool,\n}\n\nimpl\u003cT\u003e Iterator for MapIteratorShim\u003cT\u003e {\n\ttype Item = \u003cMapIterator\u003cT\u003e as Iterator\u003e::Item;\n\n\tfn next(\u0026mut self) -\u003e Option\u003cSelf::Item\u003e {\n\t\t// check accumulated iteration count\n\t\tif let Some(remain_iterator_count) = self.remain_iterator_count {\n\t\t\tif remain_iterator_count == 0 {\n\t\t\t\treturn None;\n\t\t\t} else {\n\t\t\t\tself.remain_iterator_count = Some(remain_iterator_count - 1);\n\t\t\t}\n\t\t}\n\n\t\tself.map_iterator.next().or_else(|| {\n\t\t\t// mark this map iterator has already finished\n\t\t\tself.finished = true;\n\t\t\tNone\n\t\t})\n\t}\n}\n\n/// A strongly-typed map in storage whose keys and values can be iterated over.\npub trait IterableStorageDoubleMapExtended\u003cK1: FullCodec, K2: FullCodec, V: FullCodec\u003e:\n\tStorageDoubleMap\u003cK1, K2, V\u003e\n{\n\t/// The type that iterates over all `(key2, value)`.\n\ttype PrefixIterator: Iterator\u003cItem = (K2, V)\u003e;\n\n\t/// The type that iterates over all `(key1, key2, value)`.\n\ttype Iterator: Iterator\u003cItem = (K1, K2, V)\u003e;\n\n\t/// Enumerate all elements in the map with first key `k1` in no particular\n\t/// order. If you add or remove values whose first key is `k1` to the map\n\t/// while doing this, you'll get undefined results.\n\tfn iter_prefix(\n\t\tk1: impl EncodeLike\u003cK1\u003e,\n\t\tmax_iterations: Option\u003cu32\u003e,\n\t\tstart_key: Option\u003cVec\u003cu8\u003e\u003e,\n\t) -\u003e Self::PrefixIterator;\n\n\t/// Remove all elements from the map with first key `k1` and iterate through\n\t/// them in no particular order. If you add elements with first key `k1` to\n\t/// the map while doing this, you'll get undefined results.\n\tfn drain_prefix(\n\t\tk1: impl EncodeLike\u003cK1\u003e,\n\t\tmax_iterations: Option\u003cu32\u003e,\n\t\tstart_key: Option\u003cVec\u003cu8\u003e\u003e,\n\t) -\u003e Self::PrefixIterator;\n\n\t/// Enumerate all elements in the map in no particular order. If you add or\n\t/// remove values to the map while doing this, you'll get undefined results.\n\tfn iter(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator;\n\n\t/// Remove all elements from the map and iterate through them in no\n\t/// particular order. If you add elements to the map while doing this,\n\t/// you'll get undefined results.\n\tfn drain(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator;\n}\n\nimpl\u003cK1: FullCodec, K2: FullCodec, V: FullCodec, G: StorageDoubleMapT\u003cK1, K2, V\u003e\u003e\n\tIterableStorageDoubleMapExtended\u003cK1, K2, V\u003e for G\nwhere\n\tG::Hasher1: ReversibleStorageHasher,\n\tG::Hasher2: ReversibleStorageHasher,\n{\n\ttype PrefixIterator = MapIteratorShim\u003c(K2, V)\u003e;\n\ttype Iterator = MapIteratorShim\u003c(K1, K2, V)\u003e;\n\n\tfn iter_prefix(\n\t\tk1: impl EncodeLike\u003cK1\u003e,\n\t\tmax_iterations: Option\u003cu32\u003e,\n\t\tstart_key: Option\u003cVec\u003cu8\u003e\u003e,\n\t) -\u003e Self::PrefixIterator {\n\t\tlet prefix = G::storage_double_map_final_key1(k1);\n\t\tlet previous_key = start_key\n\t\t\t.filter(|k| k.starts_with(\u0026prefix))\n\t\t\t.unwrap_or_else(|| prefix.clone());\n\n\t\tlet map_iterator = MapIterator {\n\t\t\tprefix,\n\t\t\tprevious_key,\n\t\t\tdrain: false,\n\t\t\tclosure: |raw_key_without_prefix, mut raw_value| {\n\t\t\t\tlet mut key_material = G::Hasher2::reverse(raw_key_without_prefix);\n\t\t\t\tOk((K2::decode(\u0026mut key_material)?, V::decode(\u0026mut raw_value)?))\n\t\t\t},\n\t\t};\n\n\t\tMapIteratorShim {\n\t\t\tmap_iterator,\n\t\t\tremain_iterator_count: max_iterations,\n\t\t\tfinished: false,\n\t\t}\n\t}\n\n\tfn drain_prefix(\n\t\tk1: impl EncodeLike\u003cK1\u003e,\n\t\tmax_iterations: Option\u003cu32\u003e,\n\t\tstart_key: Option\u003cVec\u003cu8\u003e\u003e,\n\t) -\u003e Self::PrefixIterator {\n\t\tlet mut shim = Self::iter_prefix(k1, max_iterations, start_key);\n\t\tshim.map_iterator.drain = true;\n\t\tshim\n\t}\n\n\tfn iter(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator {\n\t\tlet prefix = G::prefix_hash();\n\t\tlet previous_key = start_key\n\t\t\t.filter(|k| k.starts_with(\u0026prefix))\n\t\t\t.unwrap_or_else(|| prefix.clone());\n\n\t\tlet map_iterator = MapIterator {\n\t\t\tprefix,\n\t\t\tprevious_key,\n\t\t\tdrain: false,\n\t\t\tclosure: |raw_key_without_prefix, mut raw_value| {\n\t\t\t\tlet mut k1_k2_material = G::Hasher1::reverse(raw_key_without_prefix);\n\t\t\t\tlet k1 = K1::decode(\u0026mut k1_k2_material)?;\n\t\t\t\tlet mut k2_material = G::Hasher2::reverse(k1_k2_material);\n\t\t\t\tlet k2 = K2::decode(\u0026mut k2_material)?;\n\t\t\t\tOk((k1, k2, V::decode(\u0026mut raw_value)?))\n\t\t\t},\n\t\t};\n\n\t\tMapIteratorShim {\n\t\t\tmap_iterator,\n\t\t\tremain_iterator_count: max_iterations,\n\t\t\tfinished: false,\n\t\t}\n\t}\n\n\tfn drain(max_iterations: Option\u003cu32\u003e, start_key: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Self::Iterator {\n\t\tlet mut shim = Self::iter(max_iterations, start_key);\n\t\tshim.map_iterator.drain = true;\n\t\tshim\n\t}\n}\n","traces":[{"line":26,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":216,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":268,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":275,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":282,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":307,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":308,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":309,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":331,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":332,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":333,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":85},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","utilities","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::storage::{with_transaction, TransactionOutcome};\nuse sp_runtime::DispatchError;\nuse sp_std::result::Result;\n\npub mod iterator;\npub mod offchain_worker;\npub mod ordered_set;\n\npub use iterator::{IterableStorageDoubleMapExtended, IterableStorageMapExtended};\npub use offchain_worker::OffchainErr;\npub use ordered_set::OrderedSet;\n\n/// Execute the supplied function in a new storage transaction.\n///\n/// All changes to storage performed by the supplied function are discarded if\n/// the returned outcome is `Result::Err`.\n///\n/// Transactions can be nested to any depth. Commits happen to the parent\n/// transaction.\npub fn with_transaction_result\u003cR\u003e(f: impl FnOnce() -\u003e Result\u003cR, DispatchError\u003e) -\u003e Result\u003cR, DispatchError\u003e {\n\twith_transaction(|| {\n\t\tlet res = f();\n\t\tif res.is_ok() {\n\t\t\tTransactionOutcome::Commit(res)\n\t\t} else {\n\t\t\tTransactionOutcome::Rollback(res)\n\t\t}\n\t})\n}\n\n#[cfg(test)]\nmod tests {\n\tuse super::*;\n\tuse frame_support::{assert_noop, assert_ok, decl_module, decl_storage};\n\tuse sp_io::TestExternalities;\n\tuse sp_runtime::{DispatchError, DispatchResult};\n\n\tpub trait Trait: frame_system::Trait {}\n\n\tdecl_module! {\n\t\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {}\n\t}\n\n\tdecl_storage! {\n\t\ttrait Store for Module\u003cT: Trait\u003e as StorageTransactions {\n\t\t\tpub Value: u32;\n\t\t\tpub Map: map hasher(twox_64_concat) String =\u003e u32;\n\t\t}\n\t}\n\n\t#[test]\n\tfn storage_transaction_basic_commit() {\n\t\tTestExternalities::default().execute_with(|| {\n\t\t\tassert_eq!(Value::get(), 0);\n\t\t\tassert!(!Map::contains_key(\"val0\"));\n\n\t\t\tassert_ok!(with_transaction_result(|| -\u003e DispatchResult {\n\t\t\t\tValue::set(99);\n\t\t\t\tMap::insert(\"val0\", 99);\n\t\t\t\tassert_eq!(Value::get(), 99);\n\t\t\t\tassert_eq!(Map::get(\"val0\"), 99);\n\t\t\t\tOk(())\n\t\t\t}));\n\n\t\t\tassert_eq!(Value::get(), 99);\n\t\t\tassert_eq!(Map::get(\"val0\"), 99);\n\t\t});\n\t}\n\n\t#[test]\n\tfn storage_transaction_basic_rollback() {\n\t\tTestExternalities::default().execute_with(|| {\n\t\t\tassert_eq!(Value::get(), 0);\n\t\t\tassert_eq!(Map::get(\"val0\"), 0);\n\n\t\t\tassert_noop!(\n\t\t\t\twith_transaction_result(|| -\u003e DispatchResult {\n\t\t\t\t\tValue::set(99);\n\t\t\t\t\tMap::insert(\"val0\", 99);\n\t\t\t\t\tassert_eq!(Value::get(), 99);\n\t\t\t\t\tassert_eq!(Map::get(\"val0\"), 99);\n\t\t\t\t\tErr(\"test\".into())\n\t\t\t\t}),\n\t\t\t\tDispatchError::Other(\"test\")\n\t\t\t);\n\n\t\t\tassert_eq!(Value::get(), 0);\n\t\t\tassert_eq!(Map::get(\"val0\"), 0);\n\t\t});\n\t}\n}\n","traces":[{"line":22,"address":[5231088],"length":1,"stats":{"Line":50},"fn_name":"with_transaction_result\u003c(),closure-0\u003e"},{"line":23,"address":[5231231,5231168,5231095],"length":1,"stats":{"Line":105},"fn_name":"{{closure}}\u003c(),closure-0\u003e"},{"line":24,"address":[4489706,4489962],"length":1,"stats":{"Line":54},"fn_name":null},{"line":25,"address":[5231251,5231361],"length":1,"stats":{"Line":71},"fn_name":null},{"line":26,"address":[4490098,4489842],"length":1,"stats":{"Line":48},"fn_name":null},{"line":28,"address":[4489771,4490027],"length":1,"stats":{"Line":21},"fn_name":null},{"line":46,"address":[5049508,5049536,5049540,5049504,5049568],"length":1,"stats":{"Line":21},"fn_name":"{{closure}}"},{"line":54,"address":[5049605,5049600],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":55,"address":[4488631,4488659],"length":1,"stats":{"Line":3},"fn_name":null},{"line":56,"address":[5050643,5050487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[5050603,5050966,5050943],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[5050951,5051000,5049632],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":60,"address":[5049642],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[5049671],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[5049689,5049836],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[5050103,5050220,5049799],"length":1,"stats":{"Line":2},"fn_name":null},{"line":64,"address":[5050192],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[5051389,5051242],"length":1,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[5051656,5051760,5051352],"length":1,"stats":{"Line":2},"fn_name":null},{"line":73,"address":[4488720,4488737],"length":1,"stats":{"Line":3},"fn_name":"storage_transaction_basic_rollback"},{"line":74,"address":[4488755,4488727],"length":1,"stats":{"Line":3},"fn_name":null},{"line":75,"address":[5053172,5053035,5052999],"length":1,"stats":{"Line":2},"fn_name":null},{"line":76,"address":[5053472,5053132,5053596],"length":1,"stats":{"Line":2},"fn_name":null},{"line":78,"address":[5053562,5053955,5053981],"length":1,"stats":{"Line":3},"fn_name":null},{"line":79,"address":[5052064,5053897],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":80,"address":[5052074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[5052106],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[5052271,5052124],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[5052667,5052234,5052538],"length":1,"stats":{"Line":2},"fn_name":null},{"line":84,"address":[5052629,5052927],"length":1,"stats":{"Line":2},"fn_name":null},{"line":86,"address":[5053904],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[5055199,5055037],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[5055544,5055162,5055659],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":33,"coverable":33},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","utilities","src","offchain_worker","mod.rs"],"content":"/// Error which may occur while executing the off-chain code.\n#[derive(PartialEq)]\npub enum OffchainErr {\n\tOffchainStore,\n\tSubmitTransaction,\n\tNotValidator,\n\tOffchainLock,\n}\n\nimpl sp_std::fmt::Debug for OffchainErr {\n\tfn fmt(\u0026self, fmt: \u0026mut sp_std::fmt::Formatter) -\u003e sp_std::fmt::Result {\n\t\tmatch *self {\n\t\t\tOffchainErr::OffchainStore =\u003e write!(fmt, \"Failed to manipulate offchain store\"),\n\t\t\tOffchainErr::SubmitTransaction =\u003e write!(fmt, \"Failed to submit transaction\"),\n\t\t\tOffchainErr::NotValidator =\u003e write!(fmt, \"Is not validator\"),\n\t\t\tOffchainErr::OffchainLock =\u003e write!(fmt, \"Failed to manipulate offchain lock\"),\n\t\t}\n\t}\n}\n","traces":[{"line":11,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","utilities","src","ordered_set.rs"],"content":"use codec::{Decode, Encode};\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::RuntimeDebug;\nuse sp_std::prelude::*;\n\n/// An ordered set backed by `Vec`\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(RuntimeDebug, PartialEq, Eq, Encode, Decode, Default)]\npub struct OrderedSet\u003cT\u003e(pub Vec\u003cT\u003e);\n\nimpl\u003cT: Ord\u003e OrderedSet\u003cT\u003e {\n\t/// Create a new empty set\n\tpub fn new() -\u003e Self {\n\t\tSelf(Vec::new())\n\t}\n\n\t/// Create a set from a `Vec`.\n\t/// `v` will be sorted and dedup first.\n\tpub fn from(mut v: Vec\u003cT\u003e) -\u003e Self {\n\t\tv.sort();\n\t\tv.dedup();\n\t\tSelf::from_sorted_set(v)\n\t}\n\n\t/// Create a set from a `Vec`.\n\t/// Assume `v` is sorted and contain unique elements.\n\tpub fn from_sorted_set(v: Vec\u003cT\u003e) -\u003e Self {\n\t\tSelf(v)\n\t}\n\n\t/// Insert an element.\n\t/// Return true if insertion happened.\n\tpub fn insert(\u0026mut self, value: T) -\u003e bool {\n\t\tmatch self.0.binary_search(\u0026value) {\n\t\t\tOk(_) =\u003e false,\n\t\t\tErr(loc) =\u003e {\n\t\t\t\tself.0.insert(loc, value);\n\t\t\t\ttrue\n\t\t\t}\n\t\t}\n\t}\n\n\t/// Remove an element.\n\t/// Return true if removal happened.\n\tpub fn remove(\u0026mut self, value: \u0026T) -\u003e bool {\n\t\tmatch self.0.binary_search(\u0026value) {\n\t\t\tOk(loc) =\u003e {\n\t\t\t\tself.0.remove(loc);\n\t\t\t\ttrue\n\t\t\t}\n\t\t\tErr(_) =\u003e false,\n\t\t}\n\t}\n\n\t/// Return if the set contains `value`\n\tpub fn contains(\u0026self, value: \u0026T) -\u003e bool {\n\t\tself.0.binary_search(\u0026value).is_ok()\n\t}\n\n\t/// Clear the set\n\tpub fn clear(\u0026mut self) {\n\t\tself.0.clear();\n\t}\n}\n\nimpl\u003cT: Ord\u003e From\u003cVec\u003cT\u003e\u003e for OrderedSet\u003cT\u003e {\n\tfn from(v: Vec\u003cT\u003e) -\u003e Self {\n\t\tSelf::from(v)\n\t}\n}\n\n#[cfg(test)]\nmod tests {\n\tuse super::*;\n\n\t#[test]\n\tfn from() {\n\t\tlet v = vec![4, 2, 3, 4, 3, 1];\n\t\tlet set: OrderedSet\u003ci32\u003e = v.into();\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 2, 3, 4]));\n\t}\n\n\t#[test]\n\tfn insert() {\n\t\tlet mut set: OrderedSet\u003ci32\u003e = OrderedSet::new();\n\t\tassert_eq!(set, OrderedSet::from(vec![]));\n\n\t\tassert_eq!(set.insert(1), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![1]));\n\n\t\tassert_eq!(set.insert(5), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 5]));\n\n\t\tassert_eq!(set.insert(3), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 3, 5]));\n\n\t\tassert_eq!(set.insert(3), false);\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 3, 5]));\n\t}\n\n\t#[test]\n\tfn remove() {\n\t\tlet mut set: OrderedSet\u003ci32\u003e = OrderedSet::from(vec![1, 2, 3, 4]);\n\n\t\tassert_eq!(set.remove(\u00265), false);\n\t\tassert_eq!(set, OrderedSet::from(vec![1, 2, 3, 4]));\n\n\t\tassert_eq!(set.remove(\u00261), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![2, 3, 4]));\n\n\t\tassert_eq!(set.remove(\u00263), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![2, 4]));\n\n\t\tassert_eq!(set.remove(\u00263), false);\n\t\tassert_eq!(set, OrderedSet::from(vec![2, 4]));\n\n\t\tassert_eq!(set.remove(\u00264), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![2]));\n\n\t\tassert_eq!(set.remove(\u00262), true);\n\t\tassert_eq!(set, OrderedSet::from(vec![]));\n\n\t\tassert_eq!(set.remove(\u00262), false);\n\t\tassert_eq!(set, OrderedSet::from(vec![]));\n\t}\n\n\t#[test]\n\tfn contains() {\n\t\tlet set: OrderedSet\u003ci32\u003e = OrderedSet::from(vec![1, 2, 3, 4]);\n\n\t\tassert_eq!(set.contains(\u00265), false);\n\n\t\tassert_eq!(set.contains(\u00261), true);\n\n\t\tassert_eq!(set.contains(\u00263), true);\n\t}\n\n\t#[test]\n\tfn clear() {\n\t\tlet mut set: OrderedSet\u003ci32\u003e = OrderedSet::from(vec![1, 2, 3, 4]);\n\t\tset.clear();\n\t\tassert_eq!(set, OrderedSet::new());\n\t}\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":15,"address":[4919911],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4919984,4920057],"length":1,"stats":{"Line":11},"fn_name":"from\u003ci32\u003e"},{"line":21,"address":[4919991],"length":1,"stats":{"Line":11},"fn_name":null},{"line":22,"address":[4920074],"length":1,"stats":{"Line":9},"fn_name":null},{"line":23,"address":[4920081],"length":1,"stats":{"Line":9},"fn_name":null},{"line":28,"address":[4920176],"length":1,"stats":{"Line":9},"fn_name":"from_sorted_set\u003ci32\u003e"},{"line":29,"address":[4920183],"length":1,"stats":{"Line":9},"fn_name":null},{"line":34,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":35,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":36,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":37,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":38,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":39,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":46,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":48,"address":[4920569,4920548],"length":1,"stats":{"Line":2},"fn_name":null},{"line":49,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4920597],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":58,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":62,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":69,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":78,"address":[5019408,5019494],"length":1,"stats":{"Line":3},"fn_name":"from"},{"line":79,"address":[5019415],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[5019509],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[5019670,5019576],"length":1,"stats":{"Line":2},"fn_name":null},{"line":85,"address":[5020176,5020198],"length":1,"stats":{"Line":3},"fn_name":"insert"},{"line":86,"address":[5020183],"length":1,"stats":{"Line":1},"fn_name":null},{"line":87,"address":[5020213,5020278],"length":1,"stats":{"Line":2},"fn_name":null},{"line":89,"address":[5020965,5020792],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[5021342,5020914],"length":1,"stats":{"Line":2},"fn_name":null},{"line":92,"address":[5021871,5022050],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[5021998,5022427],"length":1,"stats":{"Line":2},"fn_name":null},{"line":95,"address":[5022956,5023142],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5023083,5023519],"length":1,"stats":{"Line":2},"fn_name":null},{"line":98,"address":[5024048,5024236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[5024177,5024589],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[5025184,5025259],"length":1,"stats":{"Line":3},"fn_name":"remove"},{"line":104,"address":[5025274,5025191],"length":1,"stats":{"Line":2},"fn_name":null},{"line":106,"address":[5025539,5025295],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[5025459,5025916],"length":1,"stats":{"Line":2},"fn_name":null},{"line":109,"address":[5026633,5026432],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[5027010,5026574],"length":1,"stats":{"Line":2},"fn_name":null},{"line":112,"address":[5027526,5027720],"length":1,"stats":{"Line":1},"fn_name":null},{"line":113,"address":[5028097,5027668],"length":1,"stats":{"Line":2},"fn_name":null},{"line":115,"address":[5028613,5028809],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[5028757,5029186],"length":1,"stats":{"Line":2},"fn_name":null},{"line":118,"address":[5029890,5029702],"length":1,"stats":{"Line":1},"fn_name":null},{"line":119,"address":[5029839,5030267],"length":1,"stats":{"Line":2},"fn_name":null},{"line":121,"address":[5030783,5030945],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[5030915,5031322],"length":1,"stats":{"Line":2},"fn_name":null},{"line":124,"address":[5031838,5032002],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[5032355,5031972],"length":1,"stats":{"Line":2},"fn_name":null},{"line":129,"address":[5033067,5032992],"length":1,"stats":{"Line":3},"fn_name":"contains"},{"line":130,"address":[5033082,5032999],"length":1,"stats":{"Line":2},"fn_name":null},{"line":132,"address":[5033297,5033103],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[5033801,5033665,5033257],"length":1,"stats":{"Line":2},"fn_name":null},{"line":136,"address":[5034252,5034139,5033761],"length":1,"stats":{"Line":2},"fn_name":null},{"line":140,"address":[5034592,5034664],"length":1,"stats":{"Line":3},"fn_name":"clear"},{"line":141,"address":[5034679,5034599],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[5034699],"length":1,"stats":{"Line":1},"fn_name":null},{"line":143,"address":[5034738,5034714],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":66,"coverable":66},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","vesting","src","default_weight.rs"],"content":"//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 2.0.0\n\n#![allow(unused_parens)]\n#![allow(unused_imports)]\n\nuse frame_support::weights::{constants::RocksDbWeight as DbWeight, Weight};\n\nimpl crate::WeightInfo for () {\n\tfn vested_transfer() -\u003e Weight {\n\t\t(310_862_000 as Weight)\n\t\t\t.saturating_add(DbWeight::get().reads(4 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(4 as Weight))\n\t}\n\tfn claim(i: u32) -\u003e Weight {\n\t\t(158_614_000 as Weight)\n\t\t\t.saturating_add((958_000 as Weight).saturating_mul(i as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(3 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n\tfn update_vesting_schedules(i: u32) -\u003e Weight {\n\t\t(119_811_000 as Weight)\n\t\t\t.saturating_add((2_320_000 as Weight).saturating_mul(i as Weight))\n\t\t\t.saturating_add(DbWeight::get().reads(2 as Weight))\n\t\t\t.saturating_add(DbWeight::get().writes(3 as Weight))\n\t}\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":10,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":14},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","vesting","src","lib.rs"],"content":"//! # Vesting Module\n//!\n//! ## Overview\n//!\n//! Vesting module provides a means of scheduled balance lock on an account. It\n//! uses the *graded vesting* way, which unlocks a specific amount of balance\n//! every period of time, until all balance unlocked.\n//!\n//! ### Vesting Schedule\n//!\n//! The schedule of a vesting is described by data structure `VestingSchedule`:\n//! from the block number of `start`, for every `period` amount of blocks,\n//! `per_period` amount of balance would unlocked, until number of periods\n//! `period_count` reached. Note in vesting schedules, *time* is measured by\n//! block number. All `VestingSchedule`s under an account could be queried in\n//! chain state.\n//!\n//! ## Interface\n//!\n//! ### Dispatchable Functions\n//!\n//! - `vested_transfer` - Add a new vesting schedule for an account.\n//! - `claim` - Claim unlocked balances.\n//! - `update_vesting_schedules` - Update all vesting schedules under an\n//!   account, `root` origin required.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode, HasCompact};\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, ensure,\n\ttraits::{Currency, EnsureOrigin, ExistenceRequirement, Get, LockIdentifier, LockableCurrency, WithdrawReasons},\n\ttransactional,\n\tweights::Weight,\n};\nuse frame_system::{ensure_root, ensure_signed};\nuse sp_runtime::{\n\ttraits::{AtLeast32Bit, CheckedAdd, Saturating, StaticLookup, Zero},\n\tDispatchResult, RuntimeDebug,\n};\nuse sp_std::{\n\tcmp::{Eq, PartialEq},\n\tvec::Vec,\n};\n\nmod default_weight;\nmod mock;\nmod tests;\n\npub trait WeightInfo {\n\tfn vested_transfer() -\u003e Weight;\n\tfn claim(i: u32) -\u003e Weight;\n\tfn update_vesting_schedules(i: u32) -\u003e Weight;\n}\n\n/// The maximum number of vesting schedules an account can have.\npub const MAX_VESTINGS: usize = 20;\n\n/// The vesting schedule.\n///\n/// Benefits would be granted gradually, `per_period` amount every `period` of\n/// blocks after `start`.\n#[derive(Clone, Encode, Decode, PartialEq, Eq, RuntimeDebug)]\npub struct VestingSchedule\u003cBlockNumber, Balance: HasCompact\u003e {\n\t/// Vesting starting block\n\tpub start: BlockNumber,\n\t/// Number of blocks between vest\n\tpub period: BlockNumber,\n\t/// Number of vest\n\tpub period_count: u32,\n\t/// Amount of tokens to release per vest\n\t#[codec(compact)]\n\tpub per_period: Balance,\n}\n\nimpl\u003cBlockNumber: AtLeast32Bit + Copy, Balance: AtLeast32Bit + Copy\u003e VestingSchedule\u003cBlockNumber, Balance\u003e {\n\t/// Returns the end of all periods, `None` if calculation overflows.\n\tpub fn end(\u0026self) -\u003e Option\u003cBlockNumber\u003e {\n\t\t// period * period_count + start\n\t\tself.period\n\t\t\t.checked_mul(\u0026self.period_count.into())?\n\t\t\t.checked_add(\u0026self.start)\n\t}\n\n\t/// Returns all locked amount, `None` if calculation overflows.\n\tpub fn total_amount(\u0026self) -\u003e Option\u003cBalance\u003e {\n\t\tself.per_period.checked_mul(\u0026self.period_count.into())\n\t}\n\n\t/// Returns locked amount for a given `time`.\n\t///\n\t/// Note this func assumes schedule is a valid one(non-zero period and\n\t/// non-overflow total amount), and it should be guaranteed by callers.\n\tpub fn locked_amount(\u0026self, time: BlockNumber) -\u003e Balance {\n\t\t// full = (time - start) / period\n\t\t// unrealized = period_count - full\n\t\t// per_period * unrealized\n\t\tlet full = time\n\t\t\t.saturating_sub(self.start)\n\t\t\t.checked_div(\u0026self.period)\n\t\t\t.expect(\"ensured non-zero period; qed\");\n\t\tlet unrealized = self.period_count.saturating_sub(full.unique_saturated_into());\n\t\tself.per_period\n\t\t\t.checked_mul(\u0026unrealized.into())\n\t\t\t.expect(\"ensured non-overflow total amount; qed\")\n\t}\n}\n\npub type BalanceOf\u003cT\u003e = \u003c\u003cT as Trait\u003e::Currency as Currency\u003c\u003cT as frame_system::Trait\u003e::AccountId\u003e\u003e::Balance;\npub type VestingScheduleOf\u003cT\u003e = VestingSchedule\u003c\u003cT as frame_system::Trait\u003e::BlockNumber, BalanceOf\u003cT\u003e\u003e;\npub type ScheduledItem\u003cT\u003e = (\n\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\u003cT as frame_system::Trait\u003e::BlockNumber,\n\t\u003cT as frame_system::Trait\u003e::BlockNumber,\n\tu32,\n\tBalanceOf\u003cT\u003e,\n);\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\ttype Currency: LockableCurrency\u003cSelf::AccountId, Moment = Self::BlockNumber\u003e;\n\n\t/// The minimum amount transferred to call `vested_transfer`.\n\ttype MinVestedTransfer: Get\u003cBalanceOf\u003cSelf\u003e\u003e;\n\n\t/// Required origin for vested transfer.\n\ttype VestedTransferOrigin: EnsureOrigin\u003cSelf::Origin, Success = Self::AccountId\u003e;\n\n\t/// Weight information for extrinsics in this module.\n\ttype WeightInfo: WeightInfo;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Vesting {\n\t\t/// Vesting schedules of an account.\n\t\tpub VestingSchedules get(fn vesting_schedules) build(|config: \u0026GenesisConfig\u003cT\u003e| {\n\t\t\tconfig.vesting.iter()\n\t\t\t\t.map(|\u0026(ref who, start, period, period_count, per_period)| {\n\t\t\t\t\tlet total = per_period * Into::\u003cBalanceOf\u003cT\u003e\u003e::into(period_count);\n\t\t\t\t\tassert!(T::Currency::free_balance(who) \u003e= total, \"Account do not have enough balance\");\n\t\t\t\t\tT::Currency::set_lock(VESTING_LOCK_ID, who, total, WithdrawReasons::all());\n\t\t\t\t\t(who.clone(), vec![VestingSchedule {start, period, period_count, per_period}])\n\t\t\t\t})\n\t\t\t\t.collect::\u003cVec\u003c_\u003e\u003e()\n\t\t}): map hasher(blake2_128_concat) T::AccountId =\u003e Vec\u003cVestingScheduleOf\u003cT\u003e\u003e;\n\t}\n\n\tadd_extra_genesis {\n\t\tconfig(vesting): Vec\u003cScheduledItem\u003cT\u003e\u003e;\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as frame_system::Trait\u003e::AccountId,\n\t\tBalance = BalanceOf\u003cT\u003e,\n\t\tVestingSchedule = VestingScheduleOf\u003cT\u003e\n\t{\n\t\t/// Added new vesting schedule. [from, to, vesting_schedule]\n\t\tVestingScheduleAdded(AccountId, AccountId, VestingSchedule),\n\t\t/// Claimed vesting. [who, locked_amount]\n\t\tClaimed(AccountId, Balance),\n\t\t/// Updated vesting schedules. [who]\n\t\tVestingSchedulesUpdated(AccountId),\n\t}\n);\n\ndecl_error! {\n\t/// Error for vesting module.\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Vesting period is zero\n\t\tZeroVestingPeriod,\n\t\t/// Number of vests is zero\n\t\tZeroVestingPeriodCount,\n\t\t/// Arithmetic calculation overflow\n\t\tNumOverflow,\n\t\t/// Insufficient amount of balance to lock\n\t\tInsufficientBalanceToLock,\n\t\t/// This account have too many vesting schedules\n\t\tTooManyVestingSchedules,\n\t\t/// The vested transfer amount is too low\n\t\tAmountLow,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\t/// The minimum amount to be transferred to create a new vesting schedule.\n\t\tconst MinVestedTransfer: BalanceOf\u003cT\u003e = T::MinVestedTransfer::get();\n\n\t\tfn deposit_event() = default;\n\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::Currency is orml_currencies\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 3\n\t\t/// - Db writes: 3\n\t\t/// -------------------\n\t\t/// Base Weight: 65.23 µs\n\t\t/// # \u003c/weight\u003e\n\t\t// can not get VestingSchedule count from `who`, so use `MAX_VESTINGS / 2`\n\t\t#[weight = T::WeightInfo::claim((MAX_VESTINGS / 2) as u32)]\n\t\tpub fn claim(origin) {\n\t\t\tlet who = ensure_signed(origin)?;\n\t\t\tlet locked_amount = Self::do_claim(\u0026who);\n\n\t\t\tSelf::deposit_event(RawEvent::Claimed(who, locked_amount));\n\t\t}\n\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::Currency is orml_currencies\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 4\n\t\t/// - Db writes: 4\n\t\t/// -------------------\n\t\t/// Base Weight: 150.4 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::vested_transfer()]\n\t\tpub fn vested_transfer(\n\t\t\torigin,\n\t\t\tdest: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tschedule: VestingScheduleOf\u003cT\u003e,\n\t\t) {\n\t\t\tlet from = T::VestedTransferOrigin::ensure_origin(origin)?;\n\t\t\tlet to = T::Lookup::lookup(dest)?;\n\t\t\tSelf::do_vested_transfer(\u0026from, \u0026to, schedule.clone())?;\n\n\t\t\tSelf::deposit_event(RawEvent::VestingScheduleAdded(from, to, schedule));\n\t\t}\n\n\t\t/// # \u003cweight\u003e\n\t\t/// - Preconditions:\n\t\t/// \t- T::Currency is orml_currencies\n\t\t/// - Complexity: `O(1)`\n\t\t/// - Db reads: 2\n\t\t/// - Db writes: 3\n\t\t/// -------------------\n\t\t/// Base Weight: 61.87 µs\n\t\t/// # \u003c/weight\u003e\n\t\t#[weight = T::WeightInfo::update_vesting_schedules(vesting_schedules.len() as u32)]\n\t\tpub fn update_vesting_schedules(\n\t\t\torigin,\n\t\t\twho: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tvesting_schedules: Vec\u003cVestingScheduleOf\u003cT\u003e\u003e\n\t\t) {\n\t\t\tensure_root(origin)?;\n\n\t\t\tlet account = T::Lookup::lookup(who)?;\n\t\t\tSelf::do_update_vesting_schedules(\u0026account, vesting_schedules)?;\n\n\t\t\tSelf::deposit_event(RawEvent::VestingSchedulesUpdated(account));\n\t\t}\n\t}\n}\n\nconst VESTING_LOCK_ID: LockIdentifier = *b\"ormlvest\";\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tfn do_claim(who: \u0026T::AccountId) -\u003e BalanceOf\u003cT\u003e {\n\t\tlet locked = Self::locked_balance(who);\n\t\tif locked.is_zero() {\n\t\t\tT::Currency::remove_lock(VESTING_LOCK_ID, who);\n\t\t} else {\n\t\t\tT::Currency::set_lock(VESTING_LOCK_ID, who, locked, WithdrawReasons::all());\n\t\t}\n\t\tlocked\n\t}\n\n\t/// Returns locked balance based on current block number.\n\tfn locked_balance(who: \u0026T::AccountId) -\u003e BalanceOf\u003cT\u003e {\n\t\tlet now = \u003cframe_system::Module\u003cT\u003e\u003e::block_number();\n\t\t\u003cVestingSchedules\u003cT\u003e\u003e::mutate_exists(who, |maybe_schedules| {\n\t\t\tlet total = if let Some(schedules) = maybe_schedules.as_mut() {\n\t\t\t\tlet mut total: BalanceOf\u003cT\u003e = Zero::zero();\n\t\t\t\tschedules.retain(|s| {\n\t\t\t\t\tlet amount = s.locked_amount(now);\n\t\t\t\t\ttotal = total.saturating_add(amount);\n\t\t\t\t\t!amount.is_zero()\n\t\t\t\t});\n\t\t\t\ttotal\n\t\t\t} else {\n\t\t\t\tZero::zero()\n\t\t\t};\n\t\t\tif total.is_zero() {\n\t\t\t\t*maybe_schedules = None;\n\t\t\t}\n\t\t\ttotal\n\t\t})\n\t}\n\n\tfn _do_vested_transfer(from: \u0026T::AccountId, to: \u0026T::AccountId, schedule: VestingScheduleOf\u003cT\u003e) -\u003e DispatchResult {\n\t\tlet schedule_amount = Self::ensure_valid_vesting_schedule(\u0026schedule)?;\n\n\t\tensure!(\n\t\t\t\u003cVestingSchedules\u003cT\u003e\u003e::decode_len(to).unwrap_or(0) \u003c MAX_VESTINGS,\n\t\t\tError::\u003cT\u003e::TooManyVestingSchedules\n\t\t);\n\n\t\tlet total_amount = Self::locked_balance(to)\n\t\t\t.checked_add(\u0026schedule_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tT::Currency::transfer(from, to, schedule_amount, ExistenceRequirement::AllowDeath)?;\n\t\tT::Currency::set_lock(VESTING_LOCK_ID, to, total_amount, WithdrawReasons::all());\n\t\t\u003cVestingSchedules\u003cT\u003e\u003e::append(to, schedule);\n\n\t\tOk(())\n\t}\n\n\t#[transactional]\n\tfn do_vested_transfer(from: \u0026T::AccountId, to: \u0026T::AccountId, schedule: VestingScheduleOf\u003cT\u003e) -\u003e DispatchResult {\n\t\t// workaround bug of #[transactional] does not handle return in body correctly.\n\t\t// TODO: Update once https://github.com/paritytech/substrate/pull/7188 is available.\n\t\tSelf::_do_vested_transfer(from, to, schedule)\n\t}\n\n\tfn do_update_vesting_schedules(who: \u0026T::AccountId, schedules: Vec\u003cVestingScheduleOf\u003cT\u003e\u003e) -\u003e DispatchResult {\n\t\tlet total_amount = schedules.iter().try_fold::\u003c_, _, Result\u003cBalanceOf\u003cT\u003e, Error\u003cT\u003e\u003e\u003e(\n\t\t\tZero::zero(),\n\t\t\t|acc_amount, schedule| {\n\t\t\t\tlet amount = Self::ensure_valid_vesting_schedule(schedule)?;\n\t\t\t\tOk(acc_amount + amount)\n\t\t\t},\n\t\t)?;\n\t\tensure!(\n\t\t\tT::Currency::free_balance(who) \u003e= total_amount,\n\t\t\tError::\u003cT\u003e::InsufficientBalanceToLock,\n\t\t);\n\n\t\tT::Currency::set_lock(VESTING_LOCK_ID, who, total_amount, WithdrawReasons::all());\n\t\t\u003cVestingSchedules\u003cT\u003e\u003e::insert(who, schedules);\n\n\t\tOk(())\n\t}\n\n\t/// Returns `Ok(amount)` if valid schedule, or error.\n\tfn ensure_valid_vesting_schedule(schedule: \u0026VestingScheduleOf\u003cT\u003e) -\u003e Result\u003cBalanceOf\u003cT\u003e, Error\u003cT\u003e\u003e {\n\t\tensure!(!schedule.period.is_zero(), Error::\u003cT\u003e::ZeroVestingPeriod);\n\t\tensure!(!schedule.period_count.is_zero(), Error::\u003cT\u003e::ZeroVestingPeriodCount);\n\t\tensure!(schedule.end().is_some(), Error::\u003cT\u003e::NumOverflow);\n\n\t\tlet total = schedule.total_amount().ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tensure!(total \u003e= T::MinVestedTransfer::get(), Error::\u003cT\u003e::AmountLow);\n\n\t\tOk(total)\n\t}\n}\n","traces":[{"line":78,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":80,"address":[],"length":0,"stats":{"Line":20},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":87,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":94,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":98,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":99,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":100,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":102,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":103,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":104,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":133,"address":[4455916,4455904,4454769,4454752,4455744,4455613,4455840,4454720,4455707,4455824,4455591,4455536,4455685,4455502,4454737,4455488,4455936,4455847],"length":1,"stats":{"Line":84},"fn_name":"vesting_schedules\u003corml_vesting::mock::Runtime,\u0026u128\u003e"},{"line":136,"address":[4455608,4455551,4455360],"length":1,"stats":{"Line":24},"fn_name":"{{closure}}\u003corml_vesting::mock::Runtime\u003e"},{"line":137,"address":[4455382],"length":1,"stats":{"Line":8},"fn_name":null},{"line":138,"address":[4454816,4454952,4454842],"length":1,"stats":{"Line":16},"fn_name":"{{closure}}\u003corml_vesting::mock::Runtime\u003e"},{"line":139,"address":[4454906,4454977],"length":1,"stats":{"Line":16},"fn_name":null},{"line":140,"address":[4455052,4454992],"length":1,"stats":{"Line":8},"fn_name":null},{"line":141,"address":[4455031,4455082],"length":1,"stats":{"Line":16},"fn_name":null},{"line":142,"address":[4455132],"length":1,"stats":{"Line":8},"fn_name":null},{"line":145,"address":[4455483,4455478],"length":1,"stats":{"Line":8},"fn_name":null},{"line":153,"address":[4458689,4457184,4457350,4457680,4457427,4458266,4457935,4457961],"length":1,"stats":{"Line":3},"fn_name":null},{"line":160,"address":[4457355,4457189,4459304,4457305,4460265,4460072,4456994,4457139,4457682,4456936,4457564,4457612,4457660,4460723,4458460,4459497],"length":1,"stats":{"Line":7},"fn_name":null},{"line":162,"address":[4458010,4460960,4459727,4458105,4460348,4457940,4460495,4458057,4459580,4457701,4457893,4457759,4458475],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[4458485,4460511,4458349,4460679,4459743,4458217,4458302,4458397,4458144],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[4463682,4463828,4463785,4463956,4464009],"length":1,"stats":{"Line":3},"fn_name":null},{"line":208,"address":[4464087,4463945],"length":1,"stats":{"Line":2},"fn_name":null},{"line":210,"address":[4464095],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[4466658,4466354,4466457,4466711,4466500],"length":1,"stats":{"Line":18},"fn_name":null},{"line":229,"address":[4466971,4466814,4466609,4467039],"length":1,"stats":{"Line":13},"fn_name":null},{"line":230,"address":[4467324,4467095,4467452,4466964],"length":1,"stats":{"Line":13},"fn_name":null},{"line":232,"address":[4467151],"length":1,"stats":{"Line":5},"fn_name":null},{"line":250,"address":[4469850,4469980,4469927,4469811,4469730],"length":1,"stats":{"Line":3},"fn_name":null},{"line":252,"address":[4469878,4470336,4470284,4470072],"length":1,"stats":{"Line":2},"fn_name":null},{"line":253,"address":[4470604,4470476,4470214,4470376],"length":1,"stats":{"Line":2},"fn_name":null},{"line":255,"address":[4470406],"length":1,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":265,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":266,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":268,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":275,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":277,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":278,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":279,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":280,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":281,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":282,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":284,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":286,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":288,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":289,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":291,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":296,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":298,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":299,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":300,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":303,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":304,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":307,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":308,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":309,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":311,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":315,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":321,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":322,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":323,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":324,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":325,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":329,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":331,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":335,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":337,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":341,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":342,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":343,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":344,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":346,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":348,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":350,"address":[],"length":0,"stats":{"Line":5},"fn_name":null}],"covered":81,"coverable":90},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","vesting","src","mock.rs"],"content":"//! Mocks for the vesting module.\n\n#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse frame_system::RawOrigin;\nuse pallet_balances;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod vesting {\n\tpub use crate::Event;\n}\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\tvesting\u003cT\u003e,\n\t\tpallet_balances\u003cT\u003e,\n\t}\n}\n\n// Workaround for https://github.com/rust-lang/rust/issues/26925 . Remove when sorted.\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u128;\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = pallet_balances::AccountData\u003cu64\u003e;\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\ntype Balance = u64;\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n\tpub const MinVestedTransfer: u64 = 5;\n}\n\nimpl pallet_balances::Trait for Runtime {\n\ttype Balance = Balance;\n\ttype DustRemoval = ();\n\ttype Event = TestEvent;\n\ttype ExistentialDeposit = ExistentialDeposit;\n\ttype AccountStore = frame_system::Module\u003cRuntime\u003e;\n\ttype MaxLocks = ();\n\ttype WeightInfo = ();\n}\npub type PalletBalances = pallet_balances::Module\u003cRuntime\u003e;\n\npub struct EnsureAliceOrBob;\nimpl EnsureOrigin\u003cOrigin\u003e for EnsureAliceOrBob {\n\ttype Success = AccountId;\n\n\tfn try_origin(o: Origin) -\u003e Result\u003cSelf::Success, Origin\u003e {\n\t\tInto::\u003cResult\u003cRawOrigin\u003cAccountId\u003e, Origin\u003e\u003e::into(o).and_then(|o| match o {\n\t\t\tRawOrigin::Signed(ALICE) =\u003e Ok(ALICE),\n\t\t\tRawOrigin::Signed(BOB) =\u003e Ok(BOB),\n\t\t\tr =\u003e Err(Origin::from(r)),\n\t\t})\n\t}\n\n\t#[cfg(feature = \"runtime-benchmarks\")]\n\tfn successful_origin() -\u003e Origin {\n\t\tOrigin::from(RawOrigin::Signed(Default::default()))\n\t}\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Currency = PalletBalances;\n\ttype MinVestedTransfer = MinVestedTransfer;\n\ttype VestedTransferOrigin = EnsureAliceOrBob;\n\ttype WeightInfo = ();\n}\npub type Vesting = Module\u003cRuntime\u003e;\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub const CHARLIE: AccountId = 3;\n\n#[derive(Default)]\npub struct ExtBuilder;\n\nimpl ExtBuilder {\n\tpub fn build() -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\tpallet_balances::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tbalances: vec![(ALICE, 100), (CHARLIE, 30)],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tGenesisConfig::\u003cRuntime\u003e {\n\t\t\tvesting: vec![(CHARLIE, 2, 3, 4, 5)], // who, start, period, period_count, per_period\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tt.into()\n\t}\n}\n","traces":[{"line":13,"address":[4581957,4581888],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[4583486,4582679,4583242,4582281,4582716,4583596,4583650,4582479,4582318,4582862,4583044,4582137],"length":1,"stats":{"Line":12},"fn_name":null},{"line":22,"address":[4582602,4582295,4582654,4582353],"length":1,"stats":{"Line":2},"fn_name":null},{"line":23,"address":[4582751,4583019,4582693,4582973],"length":1,"stats":{"Line":2},"fn_name":null},{"line":24,"address":[4583350,4583058,4583131,4583396],"length":1,"stats":{"Line":2},"fn_name":null},{"line":35,"address":[4632801],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":91,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":92,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":93,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":122,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":127,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":129,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[4626695],"length":1,"stats":{"Line":8},"fn_name":null},{"line":135,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[],"length":0,"stats":{"Line":8},"fn_name":null}],"covered":14,"coverable":20},{"path":["/","home","lut1k","Projects","minterest-chain-node","orml","vesting","src","tests.rs"],"content":"//! Unit tests for the vesting module.\n\n#![cfg(test)]\n\nuse super::*;\nuse frame_support::{assert_noop, assert_ok, error::BadOrigin, traits::WithdrawReason};\nuse mock::{ExtBuilder, Origin, PalletBalances, Runtime, System, TestEvent, Vesting, ALICE, BOB, CHARLIE};\nuse pallet_balances::{BalanceLock, Reasons};\n\n#[test]\nfn vesting_from_chain_spec_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tassert_ok!(PalletBalances::ensure_can_withdraw(\n\t\t\t\u0026CHARLIE,\n\t\t\t10,\n\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t20\n\t\t));\n\t\tassert!(PalletBalances::ensure_can_withdraw(\u0026CHARLIE, 11, WithdrawReason::Transfer.into(), 19).is_err());\n\n\t\tassert_eq!(\n\t\t\tVesting::vesting_schedules(\u0026CHARLIE),\n\t\t\tvec![VestingSchedule {\n\t\t\t\tstart: 2u64,\n\t\t\t\tperiod: 3u64,\n\t\t\t\tperiod_count: 4u32,\n\t\t\t\tper_period: 5u64,\n\t\t\t}]\n\t\t);\n\n\t\tSystem::set_block_number(13);\n\n\t\tassert_ok!(Vesting::claim(Origin::signed(CHARLIE)));\n\n\t\tassert_ok!(PalletBalances::ensure_can_withdraw(\n\t\t\t\u0026CHARLIE,\n\t\t\t25,\n\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t5\n\t\t));\n\t\tassert!(PalletBalances::ensure_can_withdraw(\u0026CHARLIE, 26, WithdrawReason::Transfer.into(), 4).is_err());\n\n\t\tSystem::set_block_number(14);\n\n\t\tassert_ok!(Vesting::claim(Origin::signed(CHARLIE)));\n\n\t\tassert_ok!(PalletBalances::ensure_can_withdraw(\n\t\t\t\u0026CHARLIE,\n\t\t\t30,\n\t\t\tWithdrawReason::Transfer.into(),\n\t\t\t0\n\t\t));\n\t});\n}\n\n#[test]\nfn vested_transfer_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tSystem::set_block_number(1);\n\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\t\tassert_eq!(Vesting::vesting_schedules(\u0026BOB), vec![schedule.clone()]);\n\n\t\tlet vested_event = TestEvent::vesting(RawEvent::VestingScheduleAdded(ALICE, BOB, schedule));\n\t\tassert!(System::events().iter().any(|record| record.event == vested_event));\n\t});\n}\n\n#[test]\nfn add_new_vesting_schedule_merges_with_current_locked_balance_and_until() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule));\n\n\t\tSystem::set_block_number(12);\n\n\t\tlet another_schedule = VestingSchedule {\n\t\t\tstart: 10u64,\n\t\t\tperiod: 13u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 7u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, another_schedule));\n\n\t\tassert_eq!(\n\t\t\tPalletBalances::locks(\u0026BOB).pop(),\n\t\t\tSome(BalanceLock {\n\t\t\t\tid: VESTING_LOCK_ID,\n\t\t\t\tamount: 17u64,\n\t\t\t\treasons: Reasons::All,\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn cannot_use_fund_if_not_claimed() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 10u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 50u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\t\tassert!(PalletBalances::ensure_can_withdraw(\u0026BOB, 1, WithdrawReason::Transfer.into(), 49).is_err());\n\t});\n}\n\n#[test]\nfn vested_transfer_fails_if_zero_period_or_count() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 0u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()),\n\t\t\tError::\u003cRuntime\u003e::ZeroVestingPeriod\n\t\t);\n\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 0u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()),\n\t\t\tError::\u003cRuntime\u003e::ZeroVestingPeriodCount\n\t\t);\n\t});\n}\n\n#[test]\nfn vested_transfer_fails_if_transfer_err() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(BOB), ALICE, schedule.clone()),\n\t\t\tpallet_balances::Error::\u003cRuntime, _\u003e::InsufficientBalance,\n\t\t);\n\t});\n}\n\n#[test]\nfn vested_transfer_fails_if_overflow() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: u64::max_value(),\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(ALICE), BOB, schedule),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\tlet another_schedule = VestingSchedule {\n\t\t\tstart: u64::max_value(),\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 1u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(ALICE), BOB, another_schedule),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn vested_transfer_fails_if_bad_origin() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 100u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(CHARLIE), BOB, schedule.clone()),\n\t\t\tBadOrigin\n\t\t);\n\t});\n}\n\n#[test]\nfn claim_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\n\t\tSystem::set_block_number(11);\n\t\t// remain locked if not claimed\n\t\tassert!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 10).is_err());\n\t\t// unlocked after claiming\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\t\tassert_ok!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 10));\n\t\t// more are still locked\n\t\tassert!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 1).is_err());\n\n\t\tSystem::set_block_number(21);\n\t\t// claim more\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\t\tassert_ok!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 10));\n\t\t// all used up\n\t\tassert_eq!(PalletBalances::free_balance(BOB), 0);\n\n\t\t// no locks anymore\n\t\tassert_eq!(PalletBalances::locks(\u0026BOB), vec![]);\n\t});\n}\n\n#[test]\nfn update_vesting_schedules_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\n\t\tlet updated_schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 20u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::update_vesting_schedules(\n\t\t\tOrigin::root(),\n\t\t\tBOB,\n\t\t\tvec![updated_schedule]\n\t\t));\n\n\t\tSystem::set_block_number(11);\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\t\tassert!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 1).is_err());\n\n\t\tSystem::set_block_number(21);\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\t\tassert_ok!(PalletBalances::transfer(Origin::signed(BOB), ALICE, 10));\n\t});\n}\n\n#[test]\nfn update_vesting_schedules_fails_if_unexpected_existing_locks() {\n\tExtBuilder::build().execute_with(|| {\n\t\tassert_ok!(PalletBalances::transfer(Origin::signed(ALICE), BOB, 1));\n\t\tPalletBalances::set_lock(*b\"prelocks\", \u0026BOB, 0u64, WithdrawReasons::all());\n\t});\n}\n\n#[test]\nfn vested_transfer_check_for_min() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 1u64,\n\t\t\tperiod: 1u64,\n\t\t\tperiod_count: 1u32,\n\t\t\tper_period: 3u64,\n\t\t};\n\t\tassert_noop!(\n\t\t\tVesting::vested_transfer(Origin::signed(BOB), ALICE, schedule.clone()),\n\t\t\tError::\u003cRuntime\u003e::AmountLow\n\t\t);\n\t});\n}\n\n#[test]\nfn multiple_vesting_schedule_claim_works() {\n\tExtBuilder::build().execute_with(|| {\n\t\tlet schedule = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 2u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule.clone()));\n\n\t\tlet schedule2 = VestingSchedule {\n\t\t\tstart: 0u64,\n\t\t\tperiod: 10u64,\n\t\t\tperiod_count: 3u32,\n\t\t\tper_period: 10u64,\n\t\t};\n\t\tassert_ok!(Vesting::vested_transfer(Origin::signed(ALICE), BOB, schedule2.clone()));\n\n\t\tassert_eq!(Vesting::vesting_schedules(\u0026BOB), vec![schedule, schedule2.clone()]);\n\n\t\tSystem::set_block_number(21);\n\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\n\t\tassert_eq!(Vesting::vesting_schedules(\u0026BOB), vec![schedule2]);\n\n\t\tSystem::set_block_number(31);\n\n\t\tassert_ok!(Vesting::claim(Origin::signed(BOB)));\n\n\t\tassert_eq!(VestingSchedules::\u003cRuntime\u003e::contains_key(\u0026BOB), false);\n\n\t\tassert_eq!(PalletBalances::locks(\u0026BOB), vec![]);\n\t});\n}\n","traces":[{"line":11,"address":[4865600,4865605],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":12,"address":[4865632,4865669],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":13,"address":[4865691],"length":1,"stats":{"Line":1},"fn_name":null},{"line":16,"address":[4865639],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[4865980,4866110],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4866248],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[4866092],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4866150],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4866788],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4866815],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[4867128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[4867093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[4867393,4867498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[4867486],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4867545],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4867836],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4867799],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4222176,4222193],"length":1,"stats":{"Line":3},"fn_name":"vested_transfer_works"},{"line":58,"address":[4222211,4222183],"length":1,"stats":{"Line":3},"fn_name":null},{"line":59,"address":[4868231],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[4868266],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[4869717,4868313],"length":1,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[4869758,4868681],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[4869288],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[4868190,4868176,4869687,4869494],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":76,"address":[4222289,4222272],"length":1,"stats":{"Line":3},"fn_name":"add_new_vesting_schedule_merges_with_current_locked_balance_and_until"},{"line":77,"address":[4222279,4222307],"length":1,"stats":{"Line":3},"fn_name":null},{"line":78,"address":[4869911],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[4869975,4869997],"length":1,"stats":{"Line":2},"fn_name":null},{"line":86,"address":[4870349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4870359],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4870423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[4870810],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4870763],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[4222385,4222368],"length":1,"stats":{"Line":3},"fn_name":"cannot_use_fund_if_not_claimed"},{"line":109,"address":[4222375,4222403],"length":1,"stats":{"Line":3},"fn_name":null},{"line":110,"address":[4871319],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[4871829,4871362,4871419],"length":1,"stats":{"Line":2},"fn_name":null},{"line":117,"address":[4871799,4871698],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[4222464,4222481],"length":1,"stats":{"Line":3},"fn_name":"vested_transfer_fails_if_zero_period_or_count"},{"line":123,"address":[4222471,4222499],"length":1,"stats":{"Line":3},"fn_name":null},{"line":124,"address":[4871927],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4872156,4871990],"length":1,"stats":{"Line":2},"fn_name":null},{"line":131,"address":[4874461,4872092,4872038],"length":1,"stats":{"Line":2},"fn_name":null},{"line":132,"address":[4872148],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[4873235],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[4873282,4873439],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[4873318,4874502,4873375],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[4873431],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[4222577,4222560],"length":1,"stats":{"Line":3},"fn_name":"vested_transfer_fails_if_transfer_err"},{"line":150,"address":[4222567,4222595],"length":1,"stats":{"Line":3},"fn_name":null},{"line":151,"address":[4874711],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[4874766,4874932],"length":1,"stats":{"Line":2},"fn_name":null},{"line":158,"address":[4874868,4875932,4874814],"length":1,"stats":{"Line":2},"fn_name":null},{"line":159,"address":[4874924],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[4222656,4222673],"length":1,"stats":{"Line":3},"fn_name":"vested_transfer_fails_if_overflow"},{"line":166,"address":[4222691,4222663],"length":1,"stats":{"Line":3},"fn_name":null},{"line":167,"address":[4876088],"length":1,"stats":{"Line":1},"fn_name":null},{"line":171,"address":[4876071],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[4876135,4876272],"length":1,"stats":{"Line":2},"fn_name":null},{"line":174,"address":[4876166],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[4876264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[4877353],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[4877542,4877400],"length":1,"stats":{"Line":2},"fn_name":null},{"line":185,"address":[4877436],"length":1,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[4877534],"length":1,"stats":{"Line":1},"fn_name":null},{"line":192,"address":[4222769,4222752],"length":1,"stats":{"Line":3},"fn_name":"vested_transfer_fails_if_bad_origin"},{"line":193,"address":[4222759,4222787],"length":1,"stats":{"Line":3},"fn_name":null},{"line":194,"address":[4878695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":200,"address":[4878750,4878916],"length":1,"stats":{"Line":2},"fn_name":null},{"line":201,"address":[4879900,4878798,4878852],"length":1,"stats":{"Line":2},"fn_name":null},{"line":208,"address":[4222848,4222865],"length":1,"stats":{"Line":3},"fn_name":"claim_works"},{"line":209,"address":[4222855,4222883],"length":1,"stats":{"Line":3},"fn_name":null},{"line":210,"address":[4880039],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4882890,4880094,4880157],"length":1,"stats":{"Line":2},"fn_name":null},{"line":218,"address":[4880472],"length":1,"stats":{"Line":1},"fn_name":null},{"line":220,"address":[4880597,4880499],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[4880590,4880627],"length":1,"stats":{"Line":2},"fn_name":null},{"line":223,"address":[4880917],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[4881323,4881227],"length":1,"stats":{"Line":1},"fn_name":null},{"line":227,"address":[4881311],"length":1,"stats":{"Line":1},"fn_name":null},{"line":229,"address":[4881370],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[4881665],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[4881967,4882122],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[4882086,4882405],"length":1,"stats":{"Line":2},"fn_name":null},{"line":240,"address":[4222961,4222944],"length":1,"stats":{"Line":3},"fn_name":"update_vesting_schedules_works"},{"line":241,"address":[4222979,4222951],"length":1,"stats":{"Line":3},"fn_name":null},{"line":242,"address":[4883031],"length":1,"stats":{"Line":1},"fn_name":null},{"line":248,"address":[4884937,4883157,4883094],"length":1,"stats":{"Line":2},"fn_name":null},{"line":250,"address":[4883472],"length":1,"stats":{"Line":1},"fn_name":null},{"line":256,"address":[4883712,4883652],"length":1,"stats":{"Line":2},"fn_name":null},{"line":257,"address":[4883519],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[4883550],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[4883960],"length":1,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[4883987],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[4884342,4884258],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[4884330],"length":1,"stats":{"Line":1},"fn_name":null},{"line":267,"address":[4884389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":268,"address":[4884660],"length":1,"stats":{"Line":1},"fn_name":null},{"line":273,"address":[4223057,4223040],"length":1,"stats":{"Line":3},"fn_name":"update_vesting_schedules_fails_if_unexpected_existing_locks"},{"line":274,"address":[4223075,4223047],"length":1,"stats":{"Line":3},"fn_name":null},{"line":275,"address":[4885109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[4885360],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[4223153,4223136],"length":1,"stats":{"Line":3},"fn_name":"vested_transfer_check_for_min"},{"line":282,"address":[4223143,4223171],"length":1,"stats":{"Line":3},"fn_name":null},{"line":283,"address":[4885479],"length":1,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[4885534,4885700],"length":1,"stats":{"Line":2},"fn_name":null},{"line":290,"address":[4886700,4885582,4885636],"length":1,"stats":{"Line":2},"fn_name":null},{"line":291,"address":[4885692],"length":1,"stats":{"Line":1},"fn_name":null},{"line":297,"address":[4223249,4223232],"length":1,"stats":{"Line":3},"fn_name":"multiple_vesting_schedule_claim_works"},{"line":298,"address":[4223267,4223239],"length":1,"stats":{"Line":3},"fn_name":null},{"line":299,"address":[4886839],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[4886902,4890608,4886965],"length":1,"stats":{"Line":2},"fn_name":null},{"line":307,"address":[4887280],"length":1,"stats":{"Line":1},"fn_name":null},{"line":313,"address":[4890649,4887327],"length":1,"stats":{"Line":1},"fn_name":null},{"line":315,"address":[4887695,4890690],"length":1,"stats":{"Line":1},"fn_name":null},{"line":317,"address":[4888412],"length":1,"stats":{"Line":1},"fn_name":null},{"line":319,"address":[4888439],"length":1,"stats":{"Line":1},"fn_name":null},{"line":321,"address":[4888724],"length":1,"stats":{"Line":1},"fn_name":null},{"line":323,"address":[4889373],"length":1,"stats":{"Line":1},"fn_name":null},{"line":325,"address":[4889400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":327,"address":[4889843,4889685],"length":1,"stats":{"Line":1},"fn_name":null},{"line":329,"address":[4889807,4890120],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":122,"coverable":123},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","accounts","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::traits::Get;\nuse frame_support::{\n\tdecl_error, decl_event, decl_module, decl_storage, dispatch::DispatchResult, ensure, IterableStorageMap,\n};\nuse frame_system::{self as system, ensure_root, ensure_signed};\nuse sp_std::collections::btree_set::BTreeSet;\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\npub trait Trait: system::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n\n\t/// A maximum number of members. When membership reaches this number, no new members may join.\n\ttype MaxMembers: Get\u003cu32\u003e;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Accounts {\n\t\tAllowedAccounts get(fn allowed_accounts) config(): map hasher(blake2_128_concat) T::AccountId =\u003e ();\n\t\tMemberCount: u32;\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e\n\twhere\n\t\tAccountId = \u003cT as system::Trait\u003e::AccountId,\n\t{\n\t\t/// New account is added to the allow-list: \\[who\\]\n\t\tAccountAdded(AccountId),\n\n\t\t/// Account is removed from the allow-list: \\[who\\]\n\t\tAccountRemoved(AccountId),\n\n\t\t/// The caller is a member: \\[who\\]\n\t\tIsAnAdmin(AccountId),\n\t}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The account cannot be added to the allowed list because it has already been added.\n\t\tAlreadyMember,\n\n\t\t/// The account cannot be removed from the allowed list because it is not a member.\n\t\tNotAnAdmin,\n\n\t\t/// Cannot add another member because the limit is already reached.\n\t\tMembershipLimitReached,\n\n\t\t/// Cannot remove a member because ay least one member must remain.\n\t\tMustBeAtLeastOneMember,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\t\tfn deposit_event() = default;\n\n\t\t/// Adds a new account to the allow-list.\n\t\t///\n\t\t/// The dispatch origin of this call must be _Root_.\n\t\t#[weight = 0]\n\t\tpub fn add_member(origin, new_account: T::AccountId) -\u003e DispatchResult {\n\t\t\tensure_root(origin)?;\n\n\t\t\tlet member_count = MemberCount::get();\n\t\t\tensure!(member_count \u003c T::MaxMembers::get(), Error::\u003cT\u003e::MembershipLimitReached);\n\n\t\t\tensure!(!AllowedAccounts::\u003cT\u003e::contains_key(\u0026new_account), Error::\u003cT\u003e::AlreadyMember);\n\n\t\t\tAllowedAccounts::\u003cT\u003e::insert(\u0026new_account, ());\n\t\t\tMemberCount::put(member_count + 1);\n\t\t\tSelf::deposit_event(RawEvent::AccountAdded(new_account));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Remove an account from the allow-list.\n\t\t///\n\t\t/// The dispatch origin of this call must be _Root_.\n\t\t#[weight = 0]\n\t\tpub fn remove_member(origin, account_to_remove: T::AccountId) -\u003e DispatchResult {\n\t\t\tensure_root(origin)?;\n\n\t\t\tensure!(AllowedAccounts::\u003cT\u003e::contains_key(\u0026account_to_remove), Error::\u003cT\u003e::NotAnAdmin);\n\n\t\t\tlet member_count = MemberCount::get();\n\t\t\tensure!(member_count \u003e 1, Error::\u003cT\u003e::MustBeAtLeastOneMember);\n\n\t\t\tAllowedAccounts::\u003cT\u003e::remove(\u0026account_to_remove);\n\t\t\tMemberCount::mutate(|v| *v -= 1);\n\t\t\tSelf::deposit_event(RawEvent::AccountRemoved(account_to_remove));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Checks whether the caller is a member of the allow-list.\n\t\t/// Emits an event if they are, and errors if not.\n\t\t#[weight = 0]\n\t\tfn is_admin(origin) -\u003e DispatchResult {\n\t\t\tlet caller = ensure_signed(origin)?;\n\t\t\tensure!(AllowedAccounts::\u003cT\u003e::contains_key(\u0026caller), Error::\u003cT\u003e::NotAnAdmin);\n\t\t\tSelf::deposit_event(RawEvent::IsAnAdmin(caller));\n\t\t\tOk(())\n\t\t}\n\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Checks whether the caller is a member of the allow-list.\n\tpub fn is_admin_internal(caller: \u0026T::AccountId) -\u003e bool {\n\t\tlet members = \u003cAllowedAccounts\u003cT\u003e as IterableStorageMap\u003cT::AccountId, ()\u003e\u003e::iter()\n\t\t\t.map(|(acct, _)| acct)\n\t\t\t.collect::\u003cBTreeSet\u003c_\u003e\u003e();\n\n\t\tmembers.contains(\u0026caller)\n\t}\n}\n","traces":[{"line":23,"address":[5026513,5026702,5026688,5023504,5026560,5023424,5026496,5026572],"length":1,"stats":{"Line":265},"fn_name":"module_prefix\u003ccontroller::mock::Runtime\u003e"},{"line":30,"address":[5253127,5253577,5253343,5253822],"length":1,"stats":{"Line":8},"fn_name":null},{"line":36,"address":[4214250,4214069,4213191,4213623,4214119,4212832,4214205,4214755,4214169],"length":1,"stats":{"Line":5},"fn_name":null},{"line":39,"address":[4684757,4684621,4686398,4684802,4684671,4686129,4685697,4685096,4684721],"length":1,"stats":{"Line":4},"fn_name":null},{"line":42,"address":[4212800,4213739,4214652,4214697,4213307,4214501,4214619,4214569,4214765],"length":1,"stats":{"Line":4},"fn_name":null},{"line":62,"address":[6092496,6091725,6092653,6092718,6092451,6092831,6091614,6092055,6092100],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[6080982],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[4688953,4688884,4689084,4688992,4689031],"length":1,"stats":{"Line":8},"fn_name":null},{"line":74,"address":[4689145,4689020],"length":1,"stats":{"Line":5},"fn_name":null},{"line":75,"address":[4689152,4689203],"length":1,"stats":{"Line":4},"fn_name":null},{"line":77,"address":[4689286,4689192,4689309],"length":1,"stats":{"Line":8},"fn_name":null},{"line":79,"address":[4689302],"length":1,"stats":{"Line":5},"fn_name":null},{"line":80,"address":[4689663,4689389],"length":1,"stats":{"Line":5},"fn_name":null},{"line":81,"address":[4689419],"length":1,"stats":{"Line":5},"fn_name":null},{"line":82,"address":[4689481],"length":1,"stats":{"Line":5},"fn_name":null},{"line":88,"address":[6081213],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[4691468,4691676,4691623,4691576,4691537],"length":1,"stats":{"Line":3},"fn_name":null},{"line":92,"address":[4691612,4691737,4691754],"length":1,"stats":{"Line":3},"fn_name":null},{"line":94,"address":[4691837,4691743],"length":1,"stats":{"Line":2},"fn_name":null},{"line":95,"address":[4691844,4691873],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[4691866],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[4692208,4692217,4691952],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003caccounts::mock::Test\u003e"},{"line":99,"address":[4691959],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[4692021],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[6081425],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[4694249,4694128,4694051,4694302,4694163],"length":1,"stats":{"Line":3},"fn_name":null},{"line":108,"address":[4694530,4694380,4694440,4694238],"length":1,"stats":{"Line":4},"fn_name":null},{"line":109,"address":[4694386],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[4694543],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[5252608,5252632],"length":1,"stats":{"Line":8},"fn_name":"is_admin_internal\u003cminterest_model::mock::Test\u003e"},{"line":119,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":120,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":123,"address":[],"length":0,"stats":{"Line":9},"fn_name":null}],"covered":29,"coverable":33},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","accounts","src","mock.rs"],"content":"/// Mocks for the accounts pallet.\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\nuse sp_io::TestExternalities;\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\nmod accounts {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\taccounts\u003cT\u003e,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Test;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\ntype AccountId = u32;\n\nimpl frame_system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype AccountData = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = 16;\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype MaxMembers = MaxMembers;\n}\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub type TestAccounts = Module\u003cTest\u003e;\npub type System = frame_system::Module\u003cTest\u003e;\n\npub struct ExternalityBuilder;\n\nimpl ExternalityBuilder {\n\tpub fn build() -\u003e TestExternalities {\n\t\tlet storage = system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\t\tlet mut ext = TestExternalities::from(storage);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[{"line":9,"address":[4924528,4924597],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[4925246,4925661,4925376,4924768,4925566,4924894,4925074,4924928],"length":1,"stats":{"Line":15},"fn_name":null},{"line":19,"address":[4925221,4925178,4924963,4924908],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[4925260,4925448,4925330,4925491],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[4320081],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":81,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":82,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":83,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":84,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":6,"coverable":10},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","accounts","src","tests.rs"],"content":"//! Tests for the accounts pallet.\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_noop, assert_ok, error::BadOrigin};\n\n#[test]\nfn add_member_should_work() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\t// The dispatch origin of this call must be _Root_.\n\t\tassert_noop!(TestAccounts::add_member(Origin::signed(ALICE), BOB), BadOrigin);\n\n\t\t// Add Alice to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), ALICE));\n\t\tlet expected_event = TestEvent::accounts(RawEvent::AccountAdded(ALICE));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert!(\u003cAllowedAccounts\u003cTest\u003e\u003e::contains_key(ALICE));\n\n\t\t// Add Bob to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), BOB));\n\t\tlet expected_event = TestEvent::accounts(RawEvent::AccountAdded(BOB));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert!(\u003cAllowedAccounts\u003cTest\u003e\u003e::contains_key(BOB));\n\n\t\t// Alice cannot be added to the allowed list because she has already been added.\n\t\tassert_noop!(\n\t\t\tTestAccounts::add_member(Origin::root(), ALICE),\n\t\t\tError::\u003cTest\u003e::AlreadyMember\n\t\t);\n\t});\n}\n\n#[test]\nfn cant_exceed_max_members() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\t// Add 16 members, reaching the max\n\t\tfor i in 0..16 {\n\t\t\tassert_ok!(TestAccounts::add_member(Origin::root(), i));\n\t\t}\n\n\t\t// Try to add the 17th member exceeding the max\n\t\tassert_noop!(\n\t\t\tTestAccounts::add_member(Origin::root(), 16),\n\t\t\tError::\u003cTest\u003e::MembershipLimitReached\n\t\t);\n\t})\n}\n\n#[test]\nfn remove_member_should_work() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\t// Add Alice to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), ALICE));\n\n\t\t// Add Bob to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), BOB));\n\n\t\t// Remove Bob from allow-list.\n\t\tassert_ok!(TestAccounts::remove_member(Origin::root(), BOB));\n\n\t\t// Cannot remove Alice, because ay least one member must remain.\n\t\tassert_noop!(\n\t\t\tTestAccounts::remove_member(Origin::root(), ALICE),\n\t\t\tError::\u003cTest\u003e::MustBeAtLeastOneMember\n\t\t);\n\n\t\t// Test that the expected events were emitted.\n\t\tlet our_events = System::events()\n\t\t\t.into_iter()\n\t\t\t.map(|r| r.event)\n\t\t\t.filter_map(|e| {\n\t\t\t\tif let TestEvent::accounts(inner) = e {\n\t\t\t\t\tSome(inner)\n\t\t\t\t} else {\n\t\t\t\t\tNone\n\t\t\t\t}\n\t\t\t})\n\t\t\t.collect::\u003cVec\u003c_\u003e\u003e();\n\n\t\tlet expected_events = vec![\n\t\t\tRawEvent::AccountAdded(1),\n\t\t\tRawEvent::AccountAdded(2),\n\t\t\tRawEvent::AccountRemoved(2),\n\t\t];\n\n\t\tassert_eq!(our_events, expected_events);\n\n\t\t// Check storage changes.\n\t\tassert!(\u003cAllowedAccounts\u003cTest\u003e\u003e::contains_key(ALICE));\n\t\tassert!(!\u003cAllowedAccounts\u003cTest\u003e\u003e::contains_key(BOB));\n\n\t\t// Bob was previously removed from the allow-list.\n\t\tassert_noop!(\n\t\t\tTestAccounts::remove_member(Origin::root(), BOB),\n\t\t\tError::\u003cTest\u003e::NotAnAdmin\n\t\t);\n\t})\n}\n\n#[test]\nfn is_admin_should_work() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\t// Add Alice to allow-list.\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), ALICE));\n\n\t\tassert_ok!(TestAccounts::is_admin(Origin::signed(ALICE)));\n\t\tlet expected_event = TestEvent::accounts(RawEvent::IsAnAdmin(ALICE));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\tassert_noop!(TestAccounts::is_admin(Origin::signed(BOB)), Error::\u003cTest\u003e::NotAnAdmin);\n\t});\n}\n\n#[test]\nfn is_admin_internal_should_work() {\n\tExternalityBuilder::build().execute_with(|| {\n\t\tassert_ok!(TestAccounts::add_member(Origin::root(), ALICE));\n\n\t\tassert!(TestAccounts::is_admin_internal(\u0026ALICE));\n\t\tassert!(!TestAccounts::is_admin_internal(\u0026BOB));\n\t});\n}\n","traces":[{"line":9,"address":[4498624,4498629],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":10,"address":[4498752,4498775],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":12,"address":[4498795,4498759,4498921],"length":1,"stats":{"Line":3},"fn_name":null},{"line":15,"address":[4499984],"length":1,"stats":{"Line":1},"fn_name":null},{"line":16,"address":[4500313],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[4500382,4498656,4498670,4500618],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":18,"address":[4500604,4500658,4500687],"length":1,"stats":{"Line":2},"fn_name":null},{"line":21,"address":[4500664,4500728],"length":1,"stats":{"Line":2},"fn_name":null},{"line":22,"address":[4501026],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4501095,4498718,4498704,4501331],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":24,"address":[4501317,4501396,4501371],"length":1,"stats":{"Line":2},"fn_name":null},{"line":27,"address":[4501377,4501555],"length":1,"stats":{"Line":2},"fn_name":null},{"line":28,"address":[4501429],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4501547],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[4502725,4502720],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":36,"address":[4502817,4502752],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":38,"address":[4502928,4502839,4502759,4503298],"length":1,"stats":{"Line":3},"fn_name":null},{"line":39,"address":[4502965],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[4503429,4502909],"length":1,"stats":{"Line":2},"fn_name":null},{"line":44,"address":[4503303],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4503421],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[4504480,4504485],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":52,"address":[4504734,4504672],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":54,"address":[4504749,4504679],"length":1,"stats":{"Line":2},"fn_name":null},{"line":57,"address":[4505027],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[4505358],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4505689,4505829],"length":1,"stats":{"Line":2},"fn_name":null},{"line":64,"address":[4505703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[4505821],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4506916],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[4504524,4504512],"length":1,"stats":{"Line":2},"fn_name":"{{closure}}"},{"line":72,"address":[4504592],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":73,"address":[4504601,4504623],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4504643],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4504615],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[4507025,4507096],"length":1,"stats":{"Line":2},"fn_name":null},{"line":82,"address":[4507030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[4507052],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[4507074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":87,"address":[4507204,4507359],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4507718,4507334,4507743],"length":1,"stats":{"Line":2},"fn_name":null},{"line":91,"address":[4507783,4507729,4507810],"length":1,"stats":{"Line":2},"fn_name":null},{"line":94,"address":[4507969,4507791],"length":1,"stats":{"Line":2},"fn_name":null},{"line":95,"address":[4507843],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[4507961],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4509168,4509173],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":103,"address":[4509248,4509310],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":105,"address":[4509255,4509325],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[4509608],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[4509934],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[4509200,4509214,4509995,4510232],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":111,"address":[4510380,4510267,4510216],"length":1,"stats":{"Line":3},"fn_name":null},{"line":116,"address":[4511472,4511477],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":117,"address":[4511504],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":118,"address":[4511511],"length":1,"stats":{"Line":1},"fn_name":null},{"line":120,"address":[4511801,4511844],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[4511894,4511830,4511924,4511878],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":56,"coverable":57},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","rpc","runtime-api","src","lib.rs"],"content":"//! Runtime API definition for controller pallet.\n\n#![cfg_attr(not(feature = \"std\"), no_std)]\n// The `too_many_arguments` warning originates from `decl_runtime_apis` macro.\n#![allow(clippy::too_many_arguments)]\n// The `unnecessary_mut_passed` warning originates from `decl_runtime_apis` macro.\n#![allow(clippy::unnecessary_mut_passed)]\n\nuse codec::{Decode, Encode};\nuse minterest_primitives::{CurrencyId, Rate};\nuse sp_core::RuntimeDebug;\nuse sp_std::prelude::*;\n\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\n\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, Eq, PartialEq, Default, RuntimeDebug)]\npub struct PoolState {\n\tpub exchange_rate: Rate,\n\tpub borrow_rate: Rate,\n\tpub supply_rate: Rate,\n}\n\n// Here we declare the runtime API. It is implemented it the `impl` block in\n// runtime amalgamator file (the `runtime/src/lib.rs`)\nsp_api::decl_runtime_apis! {\n\tpub trait ControllerApi {\n\t\tfn liquidity_pool_state(pool_id: CurrencyId) -\u003e Option\u003cPoolState\u003e;\n\t}\n}\n","traces":[{"line":27,"address":[13307682,13309641,13308808,13307946,13307584,13309175,13309632,13309664,13308837,13309616,13309682],"length":1,"stats":{"Line":0},"fn_name":"liquidity_pool_state_call_api_at\u003ccore::option::Option\u003ccontroller_rpc_runtime_api::PoolState\u003e,closure-0,sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e,sc_service::client::client::Client\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_service::client::call_executor::LocalCallExecutor\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_executor::native_executor::NativeExecutor\u003cminterest_service::Executor\u003e\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e, node_minterest_runtime::RuntimeApi\u003e,node_minterest_runtime::RuntimeApiImpl\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e, sc_service::client::client::Client\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_service::client::call_executor::LocalCallExecutor\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_executor::native_executor::NativeExecutor\u003cminterest_service::Executor\u003e\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e, node_minterest_runtime::RuntimeApi\u003e\u003e\u003e"}],"covered":0,"coverable":1},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","rpc","src","lib.rs"],"content":"//! RPC interface for the controller module.\n\npub use controller_rpc_runtime_api::{ControllerApi as ControllerRuntimeApi, PoolState};\nuse jsonrpc_core::{Error as RpcError, ErrorCode, Result};\nuse jsonrpc_derive::rpc;\nuse minterest_primitives::CurrencyId;\nuse sp_api::ProvideRuntimeApi;\nuse sp_blockchain::HeaderBackend;\nuse sp_runtime::{generic::BlockId, traits::Block as BlockT};\nuse std::sync::Arc;\n\n#[rpc]\npub trait ControllerApi\u003cBlockHash\u003e {\n\t#[rpc(name = \"controller_liquidityPoolState\")]\n\tfn liquidity_pool_state(\u0026self, pool_id: CurrencyId, at: Option\u003cBlockHash\u003e) -\u003e Result\u003cOption\u003cPoolState\u003e\u003e;\n}\n\n/// A struct that implements the [`ControllerApi`].\npub struct Controller\u003cC, B\u003e {\n\tclient: Arc\u003cC\u003e,\n\t_marker: std::marker::PhantomData\u003cB\u003e,\n}\n\nimpl\u003cC, B\u003e Controller\u003cC, B\u003e {\n\t/// Create new `LiquidityPool` with the given reference to the client.\n\tpub fn new(client: Arc\u003cC\u003e) -\u003e Self {\n\t\tSelf {\n\t\t\tclient,\n\t\t\t_marker: Default::default(),\n\t\t}\n\t}\n}\n\npub enum Error {\n\tRuntimeError,\n}\n\nimpl From\u003cError\u003e for i64 {\n\tfn from(e: Error) -\u003e i64 {\n\t\tmatch e {\n\t\t\tError::RuntimeError =\u003e 1,\n\t\t}\n\t}\n}\n\nimpl\u003cC, Block\u003e ControllerApi\u003c\u003cBlock as BlockT\u003e::Hash\u003e for Controller\u003cC, Block\u003e\nwhere\n\tBlock: BlockT,\n\tC: Send + Sync + 'static + ProvideRuntimeApi\u003cBlock\u003e + HeaderBackend\u003cBlock\u003e,\n\tC::Api: ControllerRuntimeApi\u003cBlock\u003e,\n{\n\tfn liquidity_pool_state(\n\t\t\u0026self,\n\t\tpool_id: CurrencyId,\n\t\tat: Option\u003c\u003cBlock as BlockT\u003e::Hash\u003e,\n\t) -\u003e Result\u003cOption\u003cPoolState\u003e\u003e {\n\t\tlet api = self.client.runtime_api();\n\t\tlet at = BlockId::hash(at.unwrap_or_else(||\n            // If the block hash is not supplied assume the best block.\n            self.client.info().best_hash));\n\t\tapi.liquidity_pool_state(\u0026at, pool_id).map_err(|e| RpcError {\n\t\t\tcode: ErrorCode::ServerError(Error::RuntimeError.into()),\n\t\t\tmessage: \"Unable to get pool state.\".into(),\n\t\t\tdata: Some(format!(\"{:?}\", e).into()),\n\t\t})\n\t}\n}\n","traces":[{"line":26,"address":[7724176,7724219],"length":1,"stats":{"Line":0},"fn_name":"new\u003csc_service::client::client::Client\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_service::client::call_executor::LocalCallExecutor\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_executor::native_executor::NativeExecutor\u003cminterest_service::Executor\u003e\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e, node_minterest_runtime::RuntimeApi\u003e,sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e"},{"line":29,"address":[7487118],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[7487376,7487438],"length":1,"stats":{"Line":0},"fn_name":"liquidity_pool_state\u003csc_service::client::client::Client\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_service::client::call_executor::LocalCallExecutor\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_executor::native_executor::NativeExecutor\u003cminterest_service::Executor\u003e\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e, node_minterest_runtime::RuntimeApi\u003e,sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e"},{"line":57,"address":[7487453,7487398],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[7724866],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[7487904,7488311,7487612,7487945],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}\u003csc_service::client::client::Client\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_service::client::call_executor::LocalCallExecutor\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_executor::native_executor::NativeExecutor\u003cminterest_service::Executor\u003e\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e, node_minterest_runtime::RuntimeApi\u003e,sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e"},{"line":62,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":13},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, ensure, traits::Get};\nuse frame_system::{self as system, ensure_signed};\nuse minterest_primitives::{Balance, CurrencyId, Operation, Rate};\nuse orml_traits::MultiCurrency;\nuse orml_utilities::with_transaction_result;\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::traits::CheckedSub;\nuse sp_runtime::{\n\ttraits::{CheckedAdd, CheckedDiv, CheckedMul, Zero},\n\tDispatchError, DispatchResult, FixedPointNumber, RuntimeDebug,\n};\nuse sp_std::{cmp::Ordering, convert::TryInto, prelude::Vec, result};\n\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, Clone, RuntimeDebug, Eq, PartialEq, Default)]\npub struct ControllerData\u003cBlockNumber\u003e {\n\t/// Block number that interest was last accrued at.\n\tpub timestamp: BlockNumber,\n\n\t/// Defines the portion of borrower interest that is converted into insurance.\n\tpub insurance_factor: Rate,\n\n\t/// Maximum borrow rate.\n\tpub max_borrow_rate: Rate,\n\n\t/// Determines how much a user can borrow.\n\tpub collateral_factor: Rate,\n}\n\n/// The Administrator can pause certain actions as a safety mechanism.\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Default)]\npub struct PauseKeeper {\n\t/// Pause mint operation in the pool.\n\tpub deposit_paused: bool,\n\n\t/// Pause redeem operation in the pool.\n\tpub redeem_paused: bool,\n\n\t/// Pause borrow operation in the pool.\n\tpub borrow_paused: bool,\n\n\t/// Pause repay operation in the pool.\n\tpub repay_paused: bool,\n}\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\ntype LiquidityPools\u003cT\u003e = liquidity_pools::Module\u003cT\u003e;\ntype MinterestModel\u003cT\u003e = minterest_model::Module\u003cT\u003e;\ntype Oracle\u003cT\u003e = oracle::Module\u003cT\u003e;\ntype Accounts\u003cT\u003e = accounts::Module\u003cT\u003e;\n\npub trait Trait:\n\tliquidity_pools::Trait + system::Trait + oracle::Trait + accounts::Trait + minterest_model::Trait\n{\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n}\n\ndecl_event! {\n\tpub enum Event {\n\t\t/// InsuranceFactor has been successfully changed\n\t\tInsuranceFactorChanged,\n\n\t\t/// Max Borrow Rate has been successfully changed\n\t\tMaxBorrowRateChanged,\n\n\t\t/// The operation is paused: \\[pool_id, operation\\]\n\t\tOperationIsPaused(CurrencyId, Operation),\n\n\t\t/// The operation is unpaused: \\[pool_id, operation\\]\n\t\tOperationIsUnPaused(CurrencyId, Operation),\n\n\t\t/// Insurance balance replenished: \\[pool_id, amount\\]\n\t\tDepositedInsurance(CurrencyId, Balance),\n\n\t\t/// Insurance balance redeemed: \\[pool_id, amount\\]\n\t\tRedeemedInsurance(CurrencyId, Balance),\n\t}\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as ControllerStorage {\n\t\t/// Controller data information: `(timestamp, insurance_factor, collateral_factor, max_borrow_rate)`.\n\t\tpub ControllerDates get(fn controller_dates) config(): map hasher(blake2_128_concat) CurrencyId =\u003e ControllerData\u003cT::BlockNumber\u003e;\n\n\t\t/// The Pause Guardian can pause certain actions as a safety mechanism\n\t\tpub PauseKeepers get(fn pause_keepers) config(): map hasher(blake2_128_concat) CurrencyId =\u003e PauseKeeper;\n\t}\n}\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Number overflow in calculation.\n\t\tNumOverflow,\n\n\t\t/// Borrow rate is absurdly high.\n\t\tBorrowRateIsTooHight,\n\n\t\t/// Oracle unavailable or price equal 0ю\n\t\tOraclePriceError,\n\n\t\t/// Insufficient available liquidity.\n\t\tInsufficientLiquidity,\n\n\t\t/// Pool not found.\n\t\tPoolNotFound,\n\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\tRequireAdmin,\n\n\t\t/// Not enough balance to deposit or withdraw or repay.\n\t\tNotEnoughBalance,\n\n\t\t/// Balance overflows maximum.\n\t\t///\n\t\t/// Only happened when the balance went wrong and balance overflows the integer type.\n\t\tBalanceOverflowed,\n\n\t\t/// Maximum borrow rate cannot be set to 0.\n\t\tMaxBorrowRateCannotBeZero,\n\n\t\t/// An error occurred in the parameters that were passed to the function.\n\t\tParametersError,\n\t}\n}\n\n// Admin functions\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\t\tfn deposit_event() = default;\n\n\t\t/// Pause specific operation (deposit, redeem, borrow, repay) with the pool.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn pause_specific_operation(origin, pool_id: CurrencyId, operation: Operation) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\t\t\tmatch operation {\n\t\t\t\tOperation::Deposit =\u003e PauseKeepers::mutate(pool_id, |pool| pool.deposit_paused = true),\n\t\t\t\tOperation::Redeem =\u003e PauseKeepers::mutate(pool_id, |pool| pool.redeem_paused = true),\n\t\t\t\tOperation::Borrow =\u003e PauseKeepers::mutate(pool_id, |pool| pool.borrow_paused = true),\n\t\t\t\tOperation::Repay =\u003e PauseKeepers::mutate(pool_id, |pool| pool.repay_paused = true),\n\t\t\t};\n\t\t\tSelf::deposit_event(Event::OperationIsPaused(pool_id, operation));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Unpause specific operation (deposit, redeem, borrow, repay) with the pool.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn unpause_specific_operation(origin, pool_id: CurrencyId, operation: Operation) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\t\t\tmatch operation {\n\t\t\t\tOperation::Deposit =\u003e PauseKeepers::mutate(pool_id, |pool| pool.deposit_paused = false),\n\t\t\t\tOperation::Redeem =\u003e PauseKeepers::mutate(pool_id, |pool| pool.redeem_paused = false),\n\t\t\t\tOperation::Borrow =\u003e PauseKeepers::mutate(pool_id, |pool| pool.borrow_paused = false),\n\t\t\t\tOperation::Repay =\u003e PauseKeepers::mutate(pool_id, |pool| pool.repay_paused = false),\n\t\t\t};\n\t\t\tSelf::deposit_event(Event::OperationIsUnPaused(pool_id, operation));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Replenishes the insurance balance.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn deposit_insurance(origin, pool_id: CurrencyId, #[compact] amount: Balance) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\t\tSelf::do_deposit_insurance(\u0026sender, pool_id, amount)?;\n\t\t\t\tSelf::deposit_event(Event::DepositedInsurance(pool_id, amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Redeem the insurance balance.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn redeem_insurance(origin, pool_id: CurrencyId, #[compact] amount: Balance) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\t\tSelf::do_redeem_insurance(\u0026sender, pool_id, amount)?;\n\t\t\t\tSelf::deposit_event(Event::RedeemedInsurance(pool_id, amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Set insurance factor.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_insurance_factor(origin, pool_id: CurrencyId, new_amount_n: u128, new_amount_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\n\t\t\tlet new_insurance_factor = Rate::checked_from_rational(new_amount_n, new_amount_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\tControllerDates::\u003cT\u003e::mutate(pool_id, |r| r.insurance_factor = new_insurance_factor);\n\t\t\tSelf::deposit_event(Event::InsuranceFactorChanged);\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Set Maximum borrow rate.\n\t\t///\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_max_borrow_rate(origin, pool_id: CurrencyId, new_amount_n: u128, new_amount_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\n\t\t\tlet new_max_borow_rate = Rate::checked_from_rational(new_amount_n, new_amount_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\tensure!(!new_max_borow_rate.is_zero(), Error::\u003cT\u003e::MaxBorrowRateCannotBeZero);\n\n\t\t\tControllerDates::\u003cT\u003e::mutate(pool_id, |r| r.max_borrow_rate = new_max_borow_rate);\n\t\t\tSelf::deposit_event(Event::MaxBorrowRateChanged);\n\t\t\tOk(())\n\t\t}\n\t}\n}\n\ntype RateResult = result::Result\u003cRate, DispatchError\u003e;\ntype BalanceResult = result::Result\u003cBalance, DispatchError\u003e;\ntype LiquidityResult = result::Result\u003c(Balance, Balance), DispatchError\u003e;\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Applies accrued interest to total borrows and insurances.\n\t/// This calculates interest accrued from the last checkpointed block\n\t/// up to the current block and writes new checkpoint to storage.\n\tpub fn accrue_interest_rate(underlying_asset_id: CurrencyId) -\u003e DispatchResult {\n\t\t//Remember the initial block number.\n\t\tlet current_block_number = \u003cframe_system::Module\u003cT\u003e\u003e::block_number();\n\t\tlet accrual_block_number_previous = Self::controller_dates(underlying_asset_id).timestamp;\n\n\t\t//Short-circuit accumulating 0 interest.\n\t\tif current_block_number == accrual_block_number_previous {\n\t\t\treturn Ok(());\n\t\t}\n\n\t\tlet current_total_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_available_liquidity(underlying_asset_id);\n\t\tlet current_total_borrowed_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_borrowed(underlying_asset_id);\n\t\tlet current_total_insurance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_insurance(underlying_asset_id);\n\t\tlet current_borrow_index = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_borrow_index(underlying_asset_id);\n\n\t\tlet utilization_rate = Self::calculate_utilization_rate(\n\t\t\tcurrent_total_balance,\n\t\t\tcurrent_total_borrowed_balance,\n\t\t\tcurrent_total_insurance,\n\t\t)?;\n\n\t\t// Calculate the current borrow interest rate\n\t\tlet current_borrow_interest_rate =\n\t\t\t\u003cMinterestModel\u003cT\u003e\u003e::calculate_borrow_interest_rate(underlying_asset_id, utilization_rate)?;\n\n\t\tlet max_borrow_rate = Self::get_max_borrow_rate(underlying_asset_id);\n\t\tlet insurance_factor = Self::get_insurance_factor(underlying_asset_id);\n\n\t\tensure!(\n\t\t\tcurrent_borrow_interest_rate \u003c= max_borrow_rate,\n\t\t\tError::\u003cT\u003e::BorrowRateIsTooHight\n\t\t);\n\n\t\t// Calculate the number of blocks elapsed since the last accrual\n\t\tlet block_delta = Self::calculate_block_delta(current_block_number, accrual_block_number_previous)?;\n\n\t\t/*\n\t\tCalculate the interest accumulated into borrows and insurance and the new index:\n\t\t\t*  simpleInterestFactor = borrowRate * blockDelta\n\t\t\t*  interestAccumulated = simpleInterestFactor * totalBorrows\n\t\t\t*  totalBorrowsNew = interestAccumulated + totalBorrows\n\t\t\t*  totalInsuranceNew = interestAccumulated * insuranceFactor + totalInsurance\n\t\t\t*  borrowIndexNew = simpleInterestFactor * borrowIndex + borrowIndex\n\t\t*/\n\n\t\tlet simple_interest_factor = Self::calculate_interest_factor(current_borrow_interest_rate, \u0026block_delta)?;\n\t\tlet interest_accumulated =\n\t\t\tSelf::calculate_interest_accumulated(simple_interest_factor, current_total_borrowed_balance)?;\n\t\tlet new_total_borrow_balance =\n\t\t\tSelf::calculate_new_total_borrow(interest_accumulated, current_total_borrowed_balance)?;\n\t\tlet new_total_insurance =\n\t\t\tSelf::calculate_new_total_insurance(interest_accumulated, insurance_factor, current_total_insurance)?;\n\t\tlet new_borrow_index = Self::calculate_new_borrow_index(simple_interest_factor, current_borrow_index)?;\n\n\t\t// Save new params\n\t\tControllerDates::\u003cT\u003e::mutate(underlying_asset_id, |x| x.timestamp = current_block_number);\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::set_accrual_interest_params(\n\t\t\tunderlying_asset_id,\n\t\t\tnew_total_borrow_balance,\n\t\t\tnew_total_insurance,\n\t\t)?;\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::set_pool_borrow_index(underlying_asset_id, new_borrow_index)?;\n\n\t\tOk(())\n\t}\n\n\t/// Return the borrow balance of account based on stored data.\n\t///\n\t/// - `who`: The address whose balance should be calculated.\n\t/// - `currency_id`: ID of the currency, the balance of borrowing of which we calculate.\n\tpub fn borrow_balance_stored(who: \u0026T::AccountId, underlying_asset_id: CurrencyId) -\u003e BalanceResult {\n\t\tlet user_borrow_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_user_total_borrowed(\u0026who, underlying_asset_id);\n\n\t\t// If borrow_balance = 0 then borrow_index is likely also 0.\n\t\t// Rather than failing the calculation with a division by 0, we immediately return 0 in this case.\n\t\tif user_borrow_balance.is_zero() {\n\t\t\treturn Ok(Balance::zero());\n\t\t};\n\n\t\tlet pool_borrow_index = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_borrow_index(underlying_asset_id);\n\t\tlet user_borrow_index = \u003cLiquidityPools\u003cT\u003e\u003e::get_user_borrow_index(\u0026who, underlying_asset_id);\n\n\t\t// Calculate new borrow balance using the borrow index:\n\t\t// recent_borrow_balance = user_borrow_balance * pool_borrow_index / user_borrow_index\n\t\tlet principal_times_index = Rate::from_inner(user_borrow_balance)\n\t\t\t.checked_mul(\u0026pool_borrow_index)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tlet result = Rate::from_inner(principal_times_index)\n\t\t\t.checked_div(\u0026user_borrow_index)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(result)\n\t}\n\n\t/// Determine what the account liquidity would be if the given amounts were redeemed/borrowed.\n\t///\n\t/// - `account`: The account to determine liquidity.\n\t/// - `underlying_asset_id`: The pool to hypothetically redeem/borrow.\n\t/// - `redeem_amount`: The number of tokens to hypothetically redeem.\n\t/// - `borrow_amount`: The amount of underlying to hypothetically borrow.\n\t/// Returns (hypothetical account liquidity in excess of collateral requirements,\n\t///          hypothetical account shortfall below collateral requirements).\n\tpub fn get_hypothetical_account_liquidity(\n\t\taccount: \u0026T::AccountId,\n\t\tunderlying_to_borrow: CurrencyId,\n\t\tredeem_amount: Balance,\n\t\tborrow_amount: Balance,\n\t) -\u003e LiquidityResult {\n\t\tensure!(!(borrow_amount \u003e 0 \u0026\u0026 redeem_amount \u003e 0), Error::\u003cT\u003e::ParametersError);\n\n\t\tlet m_tokens_ids: Vec\u003cCurrencyId\u003e = \u003cT as liquidity_pools::Trait\u003e::EnabledCurrencyPair::get()\n\t\t\t.iter()\n\t\t\t.map(|currency_pair| currency_pair.wrapped_id)\n\t\t\t.collect();\n\n\t\tlet mut sum_collateral = Balance::zero();\n\t\tlet mut sum_borrow_plus_effects = Balance::zero();\n\n\t\t// For each tokens the account is in\n\t\tfor asset in m_tokens_ids.into_iter() {\n\t\t\tlet underlying_asset = \u003cLiquidityPools\u003cT\u003e\u003e::get_underlying_asset_id_by_wrapped_id(\u0026asset)?;\n\n\t\t\t// Read the balances and exchange rate from the cToken\n\t\t\tlet borrow_balance = Self::borrow_balance_stored(account, underlying_asset)?;\n\t\t\tlet exchange_rate = \u003cLiquidityPools\u003cT\u003e\u003e::get_exchange_rate(underlying_asset)?;\n\t\t\tlet collateral_factor = Self::get_collateral_factor(underlying_asset);\n\n\t\t\t// Get the normalized price of the asset.\n\t\t\tlet oracle_price =\n\t\t\t\t\u003cOracle\u003cT\u003e\u003e::get_underlying_price(underlying_asset).map_err(|_| Error::\u003cT\u003e::OraclePriceError)?;\n\n\t\t\tif oracle_price.is_zero() {\n\t\t\t\treturn Ok((Balance::zero(), Balance::zero()));\n\t\t\t}\n\n\t\t\t// Pre-compute a conversion factor from tokens -\u003e dollars (normalized price value)\n\t\t\t// tokens_to_denom = collateral_factor * exchange_rate * oracle_price\n\t\t\tlet tokens_to_denom = collateral_factor\n\t\t\t\t.checked_mul(\u0026exchange_rate)\n\t\t\t\t.and_then(|v| v.checked_mul(\u0026oracle_price))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\tif \u003cLiquidityPools\u003cT\u003e\u003e::check_user_available_collateral(\u0026account, underlying_asset) {\n\t\t\t\tlet m_token_balance = T::MultiCurrency::free_balance(asset, account);\n\n\t\t\t\t// sum_collateral += tokens_to_denom * m_token_balance\n\t\t\t\tsum_collateral =\n\t\t\t\t\tSelf::mul_price_and_balance_add_to_prev_value(sum_collateral, m_token_balance, tokens_to_denom)?;\n\t\t\t}\n\n\t\t\t// sum_borrow_plus_effects += oracle_price * borrow_balance\n\t\t\tsum_borrow_plus_effects =\n\t\t\t\tSelf::mul_price_and_balance_add_to_prev_value(sum_borrow_plus_effects, borrow_balance, oracle_price)?;\n\n\t\t\t// Calculate effects of interacting with Underlying Asset Modify.\n\t\t\tif underlying_to_borrow == underlying_asset {\n\t\t\t\t// redeem effect\n\t\t\t\tif redeem_amount \u003e 0 {\n\t\t\t\t\t// sum_borrow_plus_effects += tokens_to_denom * redeem_tokens\n\t\t\t\t\tsum_borrow_plus_effects = Self::mul_price_and_balance_add_to_prev_value(\n\t\t\t\t\t\tsum_borrow_plus_effects,\n\t\t\t\t\t\tredeem_amount,\n\t\t\t\t\t\ttokens_to_denom,\n\t\t\t\t\t)?;\n\t\t\t\t};\n\t\t\t\t// borrow effect\n\t\t\t\tif borrow_amount \u003e 0 {\n\t\t\t\t\t// sum_borrow_plus_effects += oracle_price * borrow_amount\n\t\t\t\t\tsum_borrow_plus_effects = Self::mul_price_and_balance_add_to_prev_value(\n\t\t\t\t\t\tsum_borrow_plus_effects,\n\t\t\t\t\t\tborrow_amount,\n\t\t\t\t\t\toracle_price,\n\t\t\t\t\t)?;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tmatch sum_collateral.cmp(\u0026sum_borrow_plus_effects) {\n\t\t\tOrdering::Greater =\u003e Ok((\n\t\t\t\tsum_collateral\n\t\t\t\t\t.checked_sub(sum_borrow_plus_effects)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::InsufficientLiquidity)?,\n\t\t\t\t0,\n\t\t\t)),\n\t\t\t_ =\u003e Ok((\n\t\t\t\t0,\n\t\t\t\tsum_borrow_plus_effects\n\t\t\t\t\t.checked_sub(sum_collateral)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::InsufficientLiquidity)?,\n\t\t\t)),\n\t\t}\n\t}\n\n\t/// Checks if the account should be allowed to redeem tokens in the given pool.\n\t///\n\t/// - `underlying_asset_id` - The CurrencyId to verify the redeem against.\n\t/// - `redeemer` -  The account which would redeem the tokens.\n\t/// - `redeem_amount` - The number of mTokens to exchange for the underlying asset in the\n\t/// pool.\n\t///\n\t/// Return Ok if the redeem is allowed.\n\tpub fn redeem_allowed(\n\t\tunderlying_asset_id: CurrencyId,\n\t\tredeemer: \u0026T::AccountId,\n\t\tredeem_amount: Balance,\n\t) -\u003e DispatchResult {\n\t\tif LiquidityPools::\u003cT\u003e::check_user_available_collateral(\u0026redeemer, underlying_asset_id) {\n\t\t\tlet (_, shortfall) =\n\t\t\t\tSelf::get_hypothetical_account_liquidity(\u0026redeemer, underlying_asset_id, redeem_amount, 0)?;\n\n\t\t\tensure!(!(shortfall \u003e 0), Error::\u003cT\u003e::InsufficientLiquidity);\n\t\t}\n\n\t\tOk(())\n\t}\n\n\t/// Checks if the account should be allowed to borrow the underlying asset of the given pool.\n\t///\n\t/// - `underlying_asset_id` - The CurrencyId to verify the borrow against.\n\t/// - `who` -  The account which would borrow the asset.\n\t/// - `borrow_amount` - The amount of underlying assets the account would borrow.\n\t///\n\t/// Return Ok if the borrow is allowed.\n\tpub fn borrow_allowed(\n\t\tunderlying_asset_id: CurrencyId,\n\t\twho: \u0026T::AccountId,\n\t\tborrow_amount: Balance,\n\t) -\u003e DispatchResult {\n\t\t//FIXME: add borrowCap checking\n\n\t\tlet (_, shortfall) = Self::get_hypothetical_account_liquidity(\u0026who, underlying_asset_id, 0, borrow_amount)?;\n\n\t\tensure!(!(shortfall \u003e 0), Error::\u003cT\u003e::InsufficientLiquidity);\n\n\t\tOk(())\n\t}\n\n\t/// Checks if a specific operation is allowed on a pool.\n\t///\n\t/// Return true - if operation is allowed, false - if operation is unallowed.\n\tpub fn is_operation_allowed(pool_id: CurrencyId, operation: Operation) -\u003e bool {\n\t\tmatch operation {\n\t\t\tOperation::Deposit =\u003e !Self::pause_keepers(pool_id).deposit_paused,\n\t\t\tOperation::Redeem =\u003e !Self::pause_keepers(pool_id).redeem_paused,\n\t\t\tOperation::Borrow =\u003e !Self::pause_keepers(pool_id).borrow_paused,\n\t\t\tOperation::Repay =\u003e !Self::pause_keepers(pool_id).repay_paused,\n\t\t}\n\t}\n}\n\n// RPC methods\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Gets the exchange rate between a mToken and the underlying asset.\n\tpub fn get_liquidity_pool_exchange_rate(pool_id: CurrencyId) -\u003e Option\u003cRate\u003e {\n\t\tlet exchange_rate = \u003cLiquidityPools\u003cT\u003e\u003e::get_exchange_rate(pool_id).ok()?;\n\t\tSome(exchange_rate)\n\t}\n\n\t/// Gets borrow interest rate and supply interest rate.\n\tpub fn get_liquidity_pool_borrow_and_supply_rates(pool_id: CurrencyId) -\u003e Option\u003c(Rate, Rate)\u003e {\n\t\tlet current_total_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_available_liquidity(pool_id);\n\t\tlet current_total_borrowed_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_borrowed(pool_id);\n\t\tlet current_total_insurance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_insurance(pool_id);\n\t\tlet insurance_factor = Self::get_insurance_factor(pool_id);\n\n\t\tlet utilization_rate = Self::calculate_utilization_rate(\n\t\t\tcurrent_total_balance,\n\t\t\tcurrent_total_borrowed_balance,\n\t\t\tcurrent_total_insurance,\n\t\t)\n\t\t.ok()?;\n\n\t\tlet borrow_rate = \u003cMinterestModel\u003cT\u003e\u003e::calculate_borrow_interest_rate(pool_id, utilization_rate).ok()?;\n\n\t\tlet supply_rate = Self::calculate_supply_interest_rate(utilization_rate, borrow_rate, insurance_factor).ok()?;\n\n\t\tSome((borrow_rate, supply_rate))\n\t}\n}\n\n// Private methods\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Calculates the utilization rate of the pool.\n\t/// - `current_total_balance`: The amount of cash in the pool.\n\t/// - `current_total_borrowed_balance`: The amount of borrows in the pool.\n\t/// - `current_total_insurance`: The amount of insurance in the pool (currently unused).\n\t///\n\t/// returns `utilization_rate = total_borrows / (total_cash + total_borrows - total_insurance)`\n\tfn calculate_utilization_rate(\n\t\tcurrent_total_balance: Balance,\n\t\tcurrent_total_borrowed_balance: Balance,\n\t\tcurrent_total_insurance: Balance,\n\t) -\u003e RateResult {\n\t\t// Utilization rate is 0 when there are no borrows\n\t\tif current_total_borrowed_balance.is_zero() {\n\t\t\treturn Ok(Rate::zero());\n\t\t}\n\n\t\t// utilization_rate = current_total_borrowed_balance / (current_total_balance +\n\t\t// + current_total_borrowed_balance - current_total_insurance)\n\t\tlet utilization_rate = Rate::checked_from_rational(\n\t\t\tcurrent_total_borrowed_balance,\n\t\t\tcurrent_total_balance\n\t\t\t\t.checked_add(current_total_borrowed_balance)\n\t\t\t\t.and_then(|v| v.checked_sub(current_total_insurance))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?,\n\t\t)\n\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(utilization_rate)\n\t}\n\n\t/// Calculates the current supply interest rate of the pool.\n\t/// - `utilization_rate`: Current utilization rate.\n\t/// - `borrow_rate`: Current interest rate that users pay for lending assets.\n\t/// - `insurance_factor`: Current insurance factor.\n\t///\n\t/// returns `supply_interest_rate = utilization_rate * (borrow_rate * (1 - insurance_factor))`\n\tfn calculate_supply_interest_rate(utilization_rate: Rate, borrow_rate: Rate, insurance_factor: Rate) -\u003e RateResult {\n\t\tlet supply_interest_rate = Rate::one()\n\t\t\t.checked_sub(\u0026insurance_factor)\n\t\t\t.and_then(|v| v.checked_mul(\u0026borrow_rate))\n\t\t\t.and_then(|v| v.checked_mul(\u0026utilization_rate))\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(supply_interest_rate)\n\t}\n\n\t/// Calculates the number of blocks elapsed since the last accrual.\n\t/// - `current_block_number`: Current block number.\n\t/// - `accrual_block_number_previous`: Number of the last block with accruals.\n\t///\n\t/// returns `current_block_number - accrual_block_number_previous`\n\tfn calculate_block_delta(\n\t\tcurrent_block_number: T::BlockNumber,\n\t\taccrual_block_number_previous: T::BlockNumber,\n\t) -\u003e result::Result\u003cT::BlockNumber, DispatchError\u003e {\n\t\tensure!(\n\t\t\tcurrent_block_number \u003e= accrual_block_number_previous,\n\t\t\tError::\u003cT\u003e::NumOverflow\n\t\t);\n\n\t\tOk(current_block_number - accrual_block_number_previous)\n\t}\n\n\t/// Calculates the simple interest factor.\n\t/// - `current_borrow_interest_rate`: Current interest rate that users pay for lending assets.\n\t/// - `block_delta`: The number of blocks elapsed since the last accrual.\n\t///\n\t/// returns `interest_factor = current_borrow_interest_rate * block_delta`.\n\tfn calculate_interest_factor(\n\t\tcurrent_borrow_interest_rate: Rate,\n\t\tblock_delta: \u0026\u003cT as system::Trait\u003e::BlockNumber,\n\t) -\u003e RateResult {\n\t\tlet block_delta_as_usize = TryInto::try_into(*block_delta)\n\t\t\t.ok()\n\t\t\t.expect(\"blockchain will not exceed 2^32 blocks; qed\");\n\n\t\tlet interest_factor = Rate::saturating_from_rational(block_delta_as_usize as u128, 1)\n\t\t\t.checked_mul(\u0026current_borrow_interest_rate)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(interest_factor)\n\t}\n\n\t/// Calculate the interest accumulated into borrows.\n\t///\n\t/// returns `interest_accumulated = simple_interest_factor * current_total_borrowed_balance`\n\tfn calculate_interest_accumulated(\n\t\tsimple_interest_factor: Rate,\n\t\tcurrent_total_borrowed_balance: Balance,\n\t) -\u003e BalanceResult {\n\t\tlet interest_accumulated = Rate::from_inner(current_total_borrowed_balance)\n\t\t\t.checked_mul(\u0026simple_interest_factor)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(interest_accumulated)\n\t}\n\n\t/// Calculates the new total borrow.\n\t/// - `interest_accumulated`: Accrued interest on the borrower's loan.\n\t/// - `current_total_borrowed_balance`: The amount of borrows in the pool.\n\t///\n\t/// returns `new_total_borrows = interest_accumulated + total_borrows`\n\tfn calculate_new_total_borrow(\n\t\tinterest_accumulated: Balance,\n\t\tcurrent_total_borrowed_balance: Balance,\n\t) -\u003e BalanceResult {\n\t\tlet new_total_borrows = interest_accumulated\n\t\t\t.checked_add(current_total_borrowed_balance)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(new_total_borrows)\n\t}\n\n\t/// Calculates new total insurance.\n\t/// - `interest_accumulated`: Accrued interest on the borrower's loan.\n\t/// - `insurance_factor`: The portion of borrower interest that is converted into insurance\n\t/// - `current_total_insurance`: The amount of insurance in the pool (currently unused).\n\t///\n\t/// returns `total_insurance_new = interest_accumulated * insurance_factor + total_insurance`\n\tfn calculate_new_total_insurance(\n\t\tinterest_accumulated: Balance,\n\t\tinsurance_factor: Rate,\n\t\tcurrent_total_insurance: Balance,\n\t) -\u003e BalanceResult {\n\t\t// insurance_accumulated = interest_accumulated * insurance_factor\n\t\tlet insurance_accumulated = Rate::from_inner(interest_accumulated)\n\t\t\t.checked_mul(\u0026insurance_factor)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t// total_insurance_new = insurance_accumulated + current_total_insurance\n\t\tlet total_insurance_new = insurance_accumulated\n\t\t\t.checked_add(current_total_insurance)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(total_insurance_new)\n\t}\n\n\t/// Calculates new borrow index.\n\t///\n\t/// returns `new_borrow_index = simple_interest_factor * borrow_index + borrow_index`\n\tfn calculate_new_borrow_index(simple_interest_factor: Rate, current_borrow_index: Rate) -\u003e RateResult {\n\t\tlet new_borrow_index = simple_interest_factor\n\t\t\t.checked_mul(\u0026current_borrow_index)\n\t\t\t.and_then(|v| v.checked_add(\u0026current_borrow_index))\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(new_borrow_index)\n\t}\n\n\t/// Performs mathematical calculations.\n\t///\n\t/// returns `value = value + balance_scalar * rate_scalar`\n\tfn mul_price_and_balance_add_to_prev_value(\n\t\tvalue: Balance,\n\t\tbalance_scalar: Balance,\n\t\trate_scalar: Rate,\n\t) -\u003e BalanceResult {\n\t\tlet result = value\n\t\t\t.checked_add(\n\t\t\t\tRate::from_inner(balance_scalar)\n\t\t\t\t\t.checked_mul(\u0026rate_scalar)\n\t\t\t\t\t.map(|x| x.into_inner())\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?,\n\t\t\t)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(result)\n\t}\n}\n\n// Storage getters for Controller Data\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Determines how much a user can borrow.\n\tfn get_collateral_factor(pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::controller_dates(pool_id).collateral_factor\n\t}\n\n\t/// Gets the maximum borrow rate.\n\tfn get_max_borrow_rate(pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::controller_dates(pool_id).max_borrow_rate\n\t}\n\n\t/// Get the insurance factor.\n\tfn get_insurance_factor(pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::controller_dates(pool_id).insurance_factor\n\t}\n}\n\n// Admin functions\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t// FIXME It is possible to remove this function\n\t/// Replenishes the insurance balance.\n\t/// - `who`: Account ID of the administrator who replenishes the insurance.\n\t/// - `pool_id`: Pool ID of the replenishing pool.\n\t/// - `amount`: Amount to replenish insurance in the pool.\n\tfn do_deposit_insurance(who: \u0026T::AccountId, pool_id: CurrencyId, amount: Balance) -\u003e DispatchResult {\n\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\n\t\tensure!(\n\t\t\tamount \u003c= T::MultiCurrency::free_balance(pool_id, \u0026who),\n\t\t\tError::\u003cT\u003e::NotEnoughBalance\n\t\t);\n\n\t\t// transfer amount to this pool\n\t\tT::MultiCurrency::transfer(pool_id, \u0026who, \u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(), amount)?;\n\n\t\t// calculate new insurance balance\n\t\tlet current_insurance_balance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_insurance(pool_id);\n\n\t\tlet new_insurance_balance = current_insurance_balance\n\t\t\t.checked_add(amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::BalanceOverflowed)?;\n\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::set_pool_total_insurance(pool_id, new_insurance_balance)?;\n\n\t\tOk(())\n\t}\n\n\t/// Burns the insurance balance.\n\t/// - `who`: Account ID of the administrator who burns the insurance.\n\t/// - `pool_id`: Pool ID in which the insurance is decreasing.\n\t/// - `amount`: Amount to redeem insurance in the pool.\n\tfn do_redeem_insurance(who: \u0026T::AccountId, pool_id: CurrencyId, amount: Balance) -\u003e DispatchResult {\n\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::pool_exists(\u0026pool_id), Error::\u003cT\u003e::PoolNotFound);\n\n\t\tensure!(\n\t\t\tamount \u003c= T::MultiCurrency::free_balance(pool_id, \u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id()),\n\t\t\tError::\u003cT\u003e::NotEnoughBalance\n\t\t);\n\n\t\t// calculate new insurance balance\n\t\tlet current_total_insurance = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_total_insurance(pool_id);\n\t\tensure!(amount \u003c= current_total_insurance, Error::\u003cT\u003e::NotEnoughBalance);\n\n\t\tlet new_insurance_balance = current_total_insurance\n\t\t\t.checked_sub(amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NotEnoughBalance)?;\n\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::set_pool_total_insurance(pool_id, new_insurance_balance)?;\n\n\t\t// transfer amount from this pool\n\t\tT::MultiCurrency::transfer(pool_id, \u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(), \u0026who, amount)?;\n\n\t\tOk(())\n\t}\n}\n","traces":[{"line":68,"address":[5294939,5294487,5295752,5296182,5295346,5294591],"length":1,"stats":{"Line":8},"fn_name":null},{"line":77,"address":[4411004,4409134,4409868,4411174,4410036],"length":1,"stats":{"Line":5},"fn_name":null},{"line":80,"address":[4411190,4410220,4411360,4409231,4410052],"length":1,"stats":{"Line":5},"fn_name":null},{"line":83,"address":[4409328,4410417,4411376,4410236,4411558],"length":1,"stats":{"Line":5},"fn_name":null},{"line":86,"address":[4410423,4411564,4411743,4409444,4410601,4409045],"length":1,"stats":{"Line":5},"fn_name":null},{"line":90,"address":[5296686,5296734,5296401,5296448,5302727,5302832,5302720,5302812,5278729,5279756,5302704,5279744,5302839,5296384,5302800,5296463,5278720,5296720,5296672,5302624],"length":1,"stats":{"Line":378},"fn_name":"pause_keepers\u003cminterest_protocol::mock::Test,minterest_primitives::CurrencyId\u003e"},{"line":137,"address":[5667049,5666031,5663759,5666705,5666912,5666184,5666959,5664123,5666377,5666519,5665216,5665406,5663704,5664557,5667096,5663368,5663977,5665565,5663558,5664711,5665925,5666422,5667260,5664178,5664396,5666822,5665767,5663224,5665062,5665813,5664901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[5689663],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[5440242,5440354,5440485,5440319,5440432],"length":1,"stats":{"Line":6},"fn_name":null},{"line":148,"address":[5440644,5440543,5440568,5440421],"length":1,"stats":{"Line":6},"fn_name":null},{"line":149,"address":[5440557,5440695,5440653],"length":1,"stats":{"Line":5},"fn_name":null},{"line":150,"address":[5440789,5440806,5440840,5440823],"length":1,"stats":{"Line":4},"fn_name":null},{"line":151,"address":[5440659,5441120,5441129,5440791],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":152,"address":[5440808,5441152,5441161],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":153,"address":[5441184,5441193,5440825],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":154,"address":[5441216,5440774,5441225],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":156,"address":[5440844],"length":1,"stats":{"Line":2},"fn_name":null},{"line":157,"address":[5440903],"length":1,"stats":{"Line":2},"fn_name":null},{"line":163,"address":[5690139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[5443026,5443216,5443103,5443138,5443269],"length":1,"stats":{"Line":6},"fn_name":null},{"line":166,"address":[5443205,5443327,5443352,5443428],"length":1,"stats":{"Line":6},"fn_name":null},{"line":167,"address":[5443479,5443341,5443437],"length":1,"stats":{"Line":5},"fn_name":null},{"line":168,"address":[5443590,5443573,5443607,5443624],"length":1,"stats":{"Line":4},"fn_name":null},{"line":169,"address":[5443904,5443443,5443913,5443575],"length":1,"stats":{"Line":5},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":170,"address":[5443592,5443936,5443945],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":171,"address":[5443977,5443609,5443968],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":172,"address":[5444000,5444009,5443558],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":174,"address":[5443628],"length":1,"stats":{"Line":2},"fn_name":null},{"line":175,"address":[5443687],"length":1,"stats":{"Line":2},"fn_name":null},{"line":181,"address":[5690615],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[5446353,5445900,5445783,5446288,5445979],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":184,"address":[5446298,5446437,5446478,5446376],"length":1,"stats":{"Line":6},"fn_name":null},{"line":185,"address":[5446622,5446558,5446426,5446496],"length":1,"stats":{"Line":8},"fn_name":null},{"line":186,"address":[5446507,5446643,5446743],"length":1,"stats":{"Line":6},"fn_name":null},{"line":187,"address":[5446678],"length":1,"stats":{"Line":3},"fn_name":null},{"line":188,"address":[5446862],"length":1,"stats":{"Line":3},"fn_name":null},{"line":195,"address":[5691091],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[5448859,5449233,5449168,5448663,5448780],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":198,"address":[5449358,5449178,5449256,5449317],"length":1,"stats":{"Line":2},"fn_name":null},{"line":199,"address":[5449502,5449376,5449438,5449306],"length":1,"stats":{"Line":4},"fn_name":null},{"line":200,"address":[5449523,5449623,5449387],"length":1,"stats":{"Line":2},"fn_name":null},{"line":201,"address":[5449558],"length":1,"stats":{"Line":1},"fn_name":null},{"line":202,"address":[5449742],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[5691566],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[5451769,5451882,5451938,5451804,5451692],"length":1,"stats":{"Line":9},"fn_name":null},{"line":212,"address":[5451871,5451996,5452021,5452097],"length":1,"stats":{"Line":8},"fn_name":null},{"line":213,"address":[5452166,5452010,5452106],"length":1,"stats":{"Line":7},"fn_name":null},{"line":215,"address":[5452421,5452144,5452334,5452253],"length":1,"stats":{"Line":9},"fn_name":null},{"line":216,"address":[5452423,5452315,5452245],"length":1,"stats":{"Line":7},"fn_name":null},{"line":218,"address":[5452382,5452749,5452736],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":219,"address":[5452485],"length":1,"stats":{"Line":3},"fn_name":null},{"line":220,"address":[5452516],"length":1,"stats":{"Line":3},"fn_name":null},{"line":226,"address":[5691924],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[5454684,5454874,5454796,5454930,5454761],"length":1,"stats":{"Line":3},"fn_name":null},{"line":229,"address":[5455013,5455089,5454863,5454988],"length":1,"stats":{"Line":4},"fn_name":null},{"line":230,"address":[5455002,5455098,5455158],"length":1,"stats":{"Line":3},"fn_name":null},{"line":232,"address":[5455326,5455245,5455397,5455136],"length":1,"stats":{"Line":3},"fn_name":null},{"line":233,"address":[5455399,5455307,5455237],"length":1,"stats":{"Line":3},"fn_name":null},{"line":235,"address":[5455374,5455514,5455467],"length":1,"stats":{"Line":3},"fn_name":null},{"line":237,"address":[5455475,5455840,5455853],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003ccontroller::mock::Runtime\u003e"},{"line":238,"address":[5455593],"length":1,"stats":{"Line":1},"fn_name":null},{"line":239,"address":[5455624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":254,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":255,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":258,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":259,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":262,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":263,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":264,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":265,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":268,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[],"length":0,"stats":{"Line":26},"fn_name":null},{"line":275,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":277,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":278,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":280,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":281,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":282,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":286,"address":[],"length":0,"stats":{"Line":32},"fn_name":null},{"line":297,"address":[],"length":0,"stats":{"Line":30},"fn_name":null},{"line":298,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":299,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[],"length":0,"stats":{"Line":32},"fn_name":null},{"line":301,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[],"length":0,"stats":{"Line":30},"fn_name":null},{"line":303,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":304,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":307,"address":[],"length":0,"stats":{"Line":46},"fn_name":null},{"line":309,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":310,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":311,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":313,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":315,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":322,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":323,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":327,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":328,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":331,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":332,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":336,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":337,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":338,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":339,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":341,"address":[],"length":0,"stats":{"Line":22},"fn_name":null},{"line":342,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":343,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":344,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":346,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":357,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":363,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":365,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":367,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":370,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":371,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":374,"address":[],"length":0,"stats":{"Line":20},"fn_name":null},{"line":375,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":378,"address":[],"length":0,"stats":{"Line":20},"fn_name":null},{"line":379,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":380,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":383,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":384,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":386,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":387,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":392,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":393,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":394,"address":[],"length":0,"stats":{"Line":27},"fn_name":null},{"line":395,"address":[],"length":0,"stats":{"Line":22},"fn_name":null},{"line":397,"address":[],"length":0,"stats":{"Line":21},"fn_name":null},{"line":398,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":401,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":402,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":406,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":407,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":410,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":412,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":414,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":415,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":416,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":417,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":421,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":423,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":424,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":425,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":426,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":432,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":433,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":434,"address":[],"length":0,"stats":{"Line":21},"fn_name":null},{"line":435,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":436,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":437,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":439,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":440,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":441,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":442,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":443,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":456,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":461,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":462,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":463,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":465,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":468,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":478,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":485,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":487,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":489,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":495,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":496,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":497,"address":[],"length":0,"stats":{"Line":27},"fn_name":null},{"line":498,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":499,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":500,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":508,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":509,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":510,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":514,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":515,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":516,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":517,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":518,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":521,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":522,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":523,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":527,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":529,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":531,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":543,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":549,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":550,"address":[],"length":0,"stats":{"Line":27},"fn_name":null},{"line":556,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":557,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":558,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":559,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":560,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":562,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":564,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":573,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":574,"address":[],"length":0,"stats":{"Line":20},"fn_name":null},{"line":575,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":576,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":577,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":578,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":580,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":588,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":592,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":593,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":594,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":597,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":605,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":609,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":613,"address":[],"length":0,"stats":{"Line":45},"fn_name":null},{"line":614,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":615,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":617,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":623,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":627,"address":[],"length":0,"stats":{"Line":39},"fn_name":null},{"line":628,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":629,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":630,"address":[],"length":0,"stats":{"Line":32},"fn_name":null},{"line":632,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":640,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":644,"address":[],"length":0,"stats":{"Line":45},"fn_name":null},{"line":645,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":646,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":648,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":657,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":663,"address":[],"length":0,"stats":{"Line":39},"fn_name":null},{"line":664,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":665,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":666,"address":[],"length":0,"stats":{"Line":32},"fn_name":null},{"line":669,"address":[],"length":0,"stats":{"Line":45},"fn_name":null},{"line":670,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":671,"address":[],"length":0,"stats":{"Line":27},"fn_name":null},{"line":673,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":679,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":680,"address":[],"length":0,"stats":{"Line":52},"fn_name":null},{"line":681,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":682,"address":[],"length":0,"stats":{"Line":43},"fn_name":null},{"line":683,"address":[],"length":0,"stats":{"Line":32},"fn_name":null},{"line":685,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":691,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":696,"address":[],"length":0,"stats":{"Line":36},"fn_name":null},{"line":698,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":699,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":700,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":701,"address":[],"length":0,"stats":{"Line":26},"fn_name":null},{"line":703,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":705,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":712,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":713,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":717,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":718,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":722,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":723,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":734,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":735,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":737,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":738,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":739,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":743,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":746,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":748,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":749,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":750,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":752,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":754,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":761,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":762,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":764,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":765,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":766,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":770,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":771,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":773,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":774,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":775,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":777,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":780,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":782,"address":[],"length":0,"stats":{"Line":1},"fn_name":null}],"covered":239,"coverable":281},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","src","mock.rs"],"content":"#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse liquidity_pools::{Pool, PoolUserData};\npub use minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\nuse orml_currencies::Currency;\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{IdentityLookup, Zero},\n\tModuleId, Perbill,\n};\n\nuse super::*;\nuse minterest_model::MinterestModelData;\n\nmod controller {\n\tpub use crate::Event;\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e,\n\t\torml_currencies\u003cT\u003e,\n\t\tliquidity_pools,\n\t\tcontroller,\n\t\toracle,\n\t\taccounts\u003cT\u003e,\n\t\tminterest_model,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\n\n// For testing the module, we construct most of a mock runtime. This means\n// first constructing a configuration type (`Runtime`) which `impl`s each of the\n// configuration traits of modules we want to use.\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n}\n\npub type AccountId = u32;\nimpl system::Trait for Runtime {\n\ttype BaseCallFilter = ();\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = BlockNumber;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n}\n\ntype Amount = i128;\n\nimpl orml_tokens::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\ntype NativeCurrency = Currency\u003cRuntime, GetNativeCurrencyId\u003e;\n\nimpl orml_currencies::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cRuntime\u003e;\n\ttype NativeCurrency = NativeCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl liquidity_pools::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cRuntime\u003e;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\nimpl oracle::Trait for Runtime {\n\ttype Event = TestEvent;\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = MAX_MEMBERS;\n}\n\nimpl accounts::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MaxMembers = MaxMembers;\n}\n\nparameter_types! {\n\tpub const BlocksPerYear: u128 = 5256000u128;\n}\n\nimpl minterest_model::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype BlocksPerYear = BlocksPerYear;\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n}\n\npub type BlockNumber = u64;\n\npub type Controller = Module\u003cRuntime\u003e;\npub type TestPools = liquidity_pools::Module\u003cRuntime\u003e;\npub type System = frame_system::Module\u003cRuntime\u003e;\npub type Currencies = orml_currencies::Module\u003cRuntime\u003e;\npub const MAX_MEMBERS: u32 = 16;\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n\tpools: Vec\u003c(CurrencyId, Pool)\u003e,\n\tpool_user_data: Vec\u003c(CurrencyId, AccountId, PoolUserData)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t\tpools: vec![],\n\t\t\tpool_user_data: vec![],\n\t\t}\n\t}\n}\n\npub const ALICE: AccountId = 1;\npub fn alice() -\u003e Origin {\n\tOrigin::signed(ALICE)\n}\npub const BOB: AccountId = 2;\npub fn bob() -\u003e Origin {\n\tOrigin::signed(BOB)\n}\npub const ONE_HUNDRED: Balance = 100;\npub const DOLLARS: Balance = 1_000_000_000_000_000_000;\npub fn dollars\u003cT: Into\u003cu128\u003e\u003e(d: T) -\u003e Balance {\n\tDOLLARS.saturating_mul(d.into())\n}\n\nimpl ExtBuilder {\n\tpub fn user_balance(mut self, user: AccountId, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts.push((user, currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn pool_balance(mut self, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts\n\t\t\t.push((TestPools::pools_account_id(), currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn pool_total_borrowed(mut self, pool_id: CurrencyId, total_borrowed: Balance) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_total_insurance(mut self, pool_id: CurrencyId, total_insurance: Balance) -\u003e Self {\n\t\tself.endowed_accounts\n\t\t\t.push((TestPools::pools_account_id(), pool_id, total_insurance));\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\ttotal_insurance,\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_mock(mut self, pool_id: CurrencyId) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\tborrow_index: Rate::saturating_from_rational(2, 1),\n\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_user_data(\n\t\tmut self,\n\t\tpool_id: CurrencyId,\n\t\tuser: AccountId,\n\t\ttotal_borrowed: Balance,\n\t\tinterest_index: Rate,\n\t\tcollateral: bool,\n\t) -\u003e Self {\n\t\tself.pool_user_data.push((\n\t\t\tpool_id,\n\t\t\tuser,\n\t\t\tPoolUserData {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tinterest_index,\n\t\t\t\tcollateral,\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn alice_deposit_60_dot(self) -\u003e Self {\n\t\tself.user_balance(ALICE, CurrencyId::DOT, dollars(40_u128))\n\t\t\t.user_balance(ALICE, CurrencyId::MDOT, dollars(60_u128))\n\t\t\t.pool_balance(CurrencyId::DOT, dollars(60_u128))\n\t\t\t.pool_mock(CurrencyId::DOT)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, Balance::zero(), Rate::zero(), false)\n\t}\n\n\tpub fn alice_deposit_20_eth(self) -\u003e Self {\n\t\tself.user_balance(ALICE, CurrencyId::ETH, dollars(80_u128))\n\t\t\t.user_balance(ALICE, CurrencyId::METH, dollars(20_u128))\n\t\t\t.pool_balance(CurrencyId::ETH, dollars(20_u128))\n\t\t\t.pool_mock(CurrencyId::ETH)\n\t\t\t.pool_user_data(CurrencyId::ETH, ALICE, Balance::zero(), Rate::zero(), false)\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tGenesisConfig::\u003cRuntime\u003e {\n\t\t\tcontroller_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpause_keepers: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: true,\n\t\t\t\t\t\tredeem_paused: true,\n\t\t\t\t\t\tborrow_paused: true,\n\t\t\t\t\t\trepay_paused: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tliquidity_pools::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tpools: self.pools,\n\t\t\tpool_user_data: self.pool_user_data,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\taccounts::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tallowed_accounts: vec![(ALICE, ())],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tminterest_model::GenesisConfig {\n\t\t\tminterest_model_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[{"line":21,"address":[5470496,5470565],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[5470745,5471289,5472316,5471326,5470889,5472652,5472794,5473061,5473569,5473806,5472831,5472279,5473509,5471509,5471753,5473689,5473749,5473629,5472912,5473393,5472467,5471087,5473863,5473181,5471936,5472182,5472697,5472137,5470926,5471716],"length":1,"stats":{"Line":9},"fn_name":null},{"line":27,"address":[5471206,5470961,5470903,5471261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[5471639,5471303,5471361,5471691],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[5472066,5472112,5471788,5471730],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5472254,5472159],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[5472627,5472581,5472293,5472351],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[5472674,5472769],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[5472866,5472990,5472808,5473036],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[5473075,5473252,5473298,5473148],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[4967057],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[4967108],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[4967124],"length":1,"stats":{"Line":1},"fn_name":null},{"line":111,"address":[4967172],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[4967488,4967254,4967593],"length":1,"stats":{"Line":2},"fn_name":null},{"line":113,"address":[4967272],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[4967331],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[4967386],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[4967441],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":171,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":172,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":179,"address":[4951040],"length":1,"stats":{"Line":1},"fn_name":"alice"},{"line":180,"address":[4951049],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[4951104],"length":1,"stats":{"Line":1},"fn_name":"bob"},{"line":184,"address":[4951113],"length":1,"stats":{"Line":1},"fn_name":null},{"line":188,"address":[5470336],"length":1,"stats":{"Line":1},"fn_name":"dollars\u003cu128\u003e"},{"line":189,"address":[5470350],"length":1,"stats":{"Line":1},"fn_name":null},{"line":193,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":200,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":201,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":204,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":205,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":206,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":208,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":210,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":213,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":216,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":218,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":219,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":220,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":221,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":224,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":231,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":232,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":233,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":234,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":235,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":236,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":239,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":242,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":251,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":259,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":264,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":265,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":266,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":267,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":272,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":273,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":274,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":275,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":278,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":279,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":284,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":286,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":290,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":319,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":358,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":362,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":363,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":365,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":369,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":371,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":375,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":405,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":408,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":409,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":410,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":75,"coverable":100},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","controller","src","tests.rs"],"content":"//! Tests for the controller pallet.\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_err, assert_noop, assert_ok};\n\n#[test]\nfn accrue_interest_should_work() {\n\tExtBuilder::default()\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(80_u128))\n\t\t.pool_mock(CurrencyId::BTC)\n\t\t.pool_balance(CurrencyId::DOT, dollars(20_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Controller::accrue_interest_rate(CurrencyId::DOT));\n\n\t\t\tassert_eq!(Controller::controller_dates(CurrencyId::DOT).timestamp, 1);\n\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, 57_600_000_000);\n\t\t\tassert_eq!(\n\t\t\t\tController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT),\n\t\t\t\tSome((Rate::from_inner(139_680_000_267), Rate::from_inner(100_569_600_394)))\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t80_000_000_576_000_000_000\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::pools(CurrencyId::DOT).borrow_index,\n\t\t\t\tRate::from_inner(1_000_000_007_200_000_000)\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn accrue_interest_should_not_work() {\n\tExtBuilder::default()\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(80_u128))\n\t\t.pool_balance(CurrencyId::DOT, dollars(20_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tSystem::set_block_number(1);\n\n\t\t\tassert_ok!(Controller::accrue_interest_rate(CurrencyId::DOT));\n\t\t\tassert_eq!(Controller::controller_dates(CurrencyId::DOT).timestamp, 1);\n\n\t\t\tassert_ok!(Controller::set_max_borrow_rate(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\t1,\n\t\t\t\t1_000_000_000\n\t\t\t));\n\n\t\t\tSystem::set_block_number(20);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::accrue_interest_rate(CurrencyId::DOT),\n\t\t\t\tError::\u003cRuntime\u003e::BorrowRateIsTooHight\n\t\t\t);\n\n\t\t\tassert_ok!(Controller::set_max_borrow_rate(alice(), CurrencyId::DOT, 2, 1));\n\n\t\t\tassert_ok!(Controller::accrue_interest_rate(CurrencyId::DOT));\n\t\t});\n}\n\n#[test]\nfn calculate_block_delta_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// block_delta = 10 - 5 = 5\n\t\tassert_eq!(Controller::calculate_block_delta(10, 5), Ok(5));\n\n\t\t// Overflow in calculation: 5 - 10 = -5 \u003c 0\n\t\tassert_noop!(Controller::calculate_block_delta(5, 10), Error::\u003cRuntime\u003e::NumOverflow);\n\t});\n}\n\n#[test]\nfn calculate_interest_factor_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// interest_factor = 0.1 * 25 = 2.5\n\t\tassert_eq!(\n\t\t\tController::calculate_interest_factor(Rate::saturating_from_rational(1, 10), \u002625),\n\t\t\tOk(Rate::saturating_from_rational(25, 10))\n\t\t);\n\n\t\t// Overflow in calculation: block_delta * borrow_interest_rate\n\t\tassert_noop!(\n\t\t\tController::calculate_interest_factor(Rate::from_inner(u128::max_value()), \u002620),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_interest_accumulated_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// interest_accumulated = 0 * 100 = 0\n\t\tassert_eq!(\n\t\t\tController::calculate_interest_accumulated(Rate::from_inner(0), 100),\n\t\t\tOk(0)\n\t\t);\n\n\t\t// interest_accumulated = 0.03 * 200 = 6\n\t\tassert_eq!(\n\t\t\tController::calculate_interest_accumulated(\n\t\t\t\tRate::saturating_from_rational(3, 100), // eq 0.03 == 3%\n\t\t\t\t200\n\t\t\t),\n\t\t\tOk(6)\n\t\t);\n\n\t\t// Overflow in calculation: 1.1 * max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_interest_accumulated(Rate::saturating_from_rational(11, 10), Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_new_total_borrow_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// new_total_borrows = 15 + 100 = 115\n\t\tassert_eq!(Controller::calculate_new_total_borrow(15, 100), Ok(115));\n\n\t\t// Overflow in calculation: 1 + max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_new_total_borrow(1, Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_new_total_insurance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// total_insurance_new = 100 * 1.2 + 250 = 370\n\t\tassert_eq!(\n\t\t\tController::calculate_new_total_insurance(100, Rate::saturating_from_rational(12, 10), 250),\n\t\t\tOk(370)\n\t\t);\n\t\t// Overflow in calculation: max_value() * 1.1\n\t\tassert_noop!(\n\t\t\tController::calculate_new_total_insurance(Balance::max_value(), Rate::saturating_from_rational(11, 10), 1),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t\t// Overflow in calculation: 100 * 1.1 + max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_new_total_insurance(100, Rate::saturating_from_rational(1, 1), Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn borrow_balance_stored_with_zero_balance_should_work() {\n\tExtBuilder::default()\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, Balance::zero(), Rate::from_inner(0), true)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// If borrow_balance = 0 then borrow_index is likely also 0, return Ok(0)\n\t\t\tassert_eq!(\n\t\t\t\tController::borrow_balance_stored(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tOk(Balance::zero())\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn borrow_balance_stored_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, 100, Rate::saturating_from_rational(4, 1), true)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// recent_borrow_balance = 100 * 2 / 4 = 50\n\t\t\tassert_eq!(Controller::borrow_balance_stored(\u0026ALICE, CurrencyId::DOT), Ok(50));\n\t\t});\n}\n\n#[test]\nfn borrow_balance_stored_fails_if_num_overflow() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.pool_user_data(\n\t\t\tCurrencyId::DOT,\n\t\t\tALICE,\n\t\t\tBalance::max_value(),\n\t\t\tRate::saturating_from_rational(2, 1),\n\t\t\ttrue,\n\t\t)\n\t\t.pool_mock(CurrencyId::BTC)\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, 100, Rate::from_inner(0), true)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_noop!(\n\t\t\t\tController::borrow_balance_stored(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn calculate_utilization_rate_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// if current_total_borrowed_balance == 0 then return Ok(0)\n\t\tassert_eq!(\n\t\t\tController::calculate_utilization_rate(100, 0, 60),\n\t\t\tOk(Rate::from_inner(0))\n\t\t);\n\t\t// utilization_rate = 80 / (22 + 80 - 2) = 0.8\n\t\tassert_eq!(\n\t\t\tController::calculate_utilization_rate(22, 80, 2),\n\t\t\tOk(Rate::saturating_from_rational(8, 10))\n\t\t);\n\n\t\t// Overflow in calculation: total_balance + total_borrowed = max_value() + 80\n\t\tassert_noop!(\n\t\t\tController::calculate_utilization_rate(Balance::max_value(), 80, 2),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: total_balance_total_borrowed_sum - total_insurance = ... - max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_utilization_rate(22, 80, Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: total_borrows / 0\n\t\tassert_noop!(\n\t\t\tController::calculate_utilization_rate(100, 70, 170),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_supply_rate_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// supply_rate = 0.75 * 0.23 * (1 - 0.1) = 0.15525\n\t\tassert_eq!(\n\t\t\tController::calculate_supply_interest_rate(\n\t\t\t\tRate::saturating_from_rational(75, 100),\n\t\t\t\tRate::saturating_from_rational(23, 100),\n\t\t\t\tRate::saturating_from_rational(1, 10)\n\t\t\t),\n\t\t\tOk(Rate::saturating_from_rational(15525, 100_000))\n\t\t);\n\n\t\t// Overflow in calculation: one_minus_insurance_factor = 1 - 2\n\t\tassert_noop!(\n\t\t\tController::calculate_supply_interest_rate(\n\t\t\t\tRate::saturating_from_rational(75, 100),\n\t\t\t\tRate::saturating_from_rational(23, 100),\n\t\t\t\tRate::saturating_from_rational(2, 1)\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: max_value() * 2.3 * (1 - 0.1)\n\t\tassert_noop!(\n\t\t\tController::calculate_supply_interest_rate(\n\t\t\t\tRate::from_inner(u128::max_value()),\n\t\t\t\tRate::saturating_from_rational(23, 10),\n\t\t\t\tRate::saturating_from_rational(1, 10)\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_new_borrow_index_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// new_borrow_index = 0.0000063 * 1.28 + 1.28 = 1.280000008064\n\t\tassert_eq!(\n\t\t\tController::calculate_new_borrow_index(\n\t\t\t\tRate::saturating_from_rational(63u128, 10_000_000_000u128),\n\t\t\t\tRate::saturating_from_rational(128, 100)\n\t\t\t),\n\t\t\tOk(Rate::from_inner(1_280_000_008_064_000_000))\n\t\t);\n\n\t\t// Overflow in calculation: simple_interest_factor * max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_new_borrow_index(\n\t\t\t\tRate::saturating_from_rational(12, 10),\n\t\t\t\tRate::from_inner(u128::max_value())\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: simple_interest_factor_mul_borrow_index + max_value()\n\t\tassert_noop!(\n\t\t\tController::calculate_new_borrow_index(\n\t\t\t\tRate::saturating_from_rational(1, 1),\n\t\t\t\tRate::from_inner(u128::max_value())\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn mul_price_and_balance_add_to_prev_value_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// 20 + 20 * 0.9 = 38\n\t\tassert_eq!(\n\t\t\tController::mul_price_and_balance_add_to_prev_value(20, 20, Rate::saturating_from_rational(9, 10)),\n\t\t\tOk(38)\n\t\t);\n\t\t// 120_000 + 85_000 * 0.87 = 193_950\n\t\tassert_eq!(\n\t\t\tController::mul_price_and_balance_add_to_prev_value(\n\t\t\t\t120_000,\n\t\t\t\t85_000,\n\t\t\t\tRate::saturating_from_rational(87, 100)\n\t\t\t),\n\t\t\tOk(193950)\n\t\t);\n\n\t\t// Overflow in calculation: max_value() * 1.9\n\t\tassert_noop!(\n\t\t\tController::mul_price_and_balance_add_to_prev_value(\n\t\t\t\t100,\n\t\t\t\tBalance::max_value(),\n\t\t\t\tRate::saturating_from_rational(19, 10)\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: max_value() + 100 * 1.9\n\t\tassert_noop!(\n\t\t\tController::mul_price_and_balance_add_to_prev_value(\n\t\t\t\tBalance::max_value(),\n\t\t\t\t100,\n\t\t\t\tRate::saturating_from_rational(19, 10)\n\t\t\t),\n\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn get_hypothetical_account_liquidity_when_m_tokens_balance_is_zero_should_work() {\n\tExtBuilder::default()\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, Balance::zero(), Rate::from_inner(0), true)\n\t\t.pool_user_data(CurrencyId::BTC, BOB, Balance::zero(), Rate::from_inner(0), false)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Checking the function when called from redeem.\n\t\t\t// The function should return the shortfall to a large zero.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 5, 0),\n\t\t\t\tOk((0, 9))\n\t\t\t);\n\t\t\t// Checking the function when called from borrow.\n\t\t\t// The function should return the shortfall to a large zero.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 0, 10),\n\t\t\t\tOk((0, 20))\n\t\t\t);\n\t\t\t// Checking scenario: the user tries to take a borrow in a currency which is not\n\t\t\t// pool as available for collateral, and he fails.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026BOB, CurrencyId::BTC, 0, 10),\n\t\t\t\tOk((0, 20))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_hypothetical_account_liquidity_one_currency_from_redeem_should_work() {\n\tExtBuilder::default().alice_deposit_60_dot().build().execute_with(|| {\n\t\t// Checking the function when called from redeem.\n\t\t// collateral parameter is set to false, user can't redeem.\n\t\tassert_eq!(\n\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 5, 0),\n\t\t\tOk((0, 9))\n\t\t);\n\t\tassert_eq!(\n\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 60, 0),\n\t\t\tOk((0, 108))\n\t\t);\n\t\tassert_eq!(\n\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 200, 0),\n\t\t\tOk((0, 360))\n\t\t);\n\t});\n}\n\n#[test]\nfn get_hypothetical_account_liquidity_two_currencies_from_redeem_should_work() {\n\tExtBuilder::default()\n\t\t.alice_deposit_60_dot()\n\t\t.alice_deposit_20_eth()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Checking the function when called from redeem.\n\t\t\t// collateral parameter is set to false, user can't redeem.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::ETH, 15, 0),\n\t\t\t\tOk((0, 27))\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::ETH, 80, 0),\n\t\t\t\tOk((0, 144))\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::ETH, 100, 0),\n\t\t\t\tOk((0, 180))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_hypothetical_account_liquidity_two_currencies_from_borrow_should_work() {\n\tExtBuilder::default()\n\t\t.alice_deposit_20_eth()\n\t\t// ALICE deposit 60 DOT and borrow 30 DOT\n\t\t.user_balance(ALICE, CurrencyId::DOT, 70)\n\t\t.user_balance(ALICE, CurrencyId::MDOT, 60)\n\t\t.pool_balance(CurrencyId::DOT, 60)\n\t\t.pool_total_borrowed(CurrencyId::DOT, 30)\n\t\t.pool_user_data(CurrencyId::DOT, ALICE, 30, Rate::saturating_from_rational(1, 1), false)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Checking the function when called from borrow.\n\t\t\t// collateral parameter for DOT and ETH pool is set to false. User can't borrow.\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 0, 30),\n\t\t\t\tOk((0, 120))\n\t\t\t);\n\n\t\t\t// Alice set collateral parameter value to true for DOT pool. Alice can borrow.\n\t\t\tassert_ok!(\u003cLiquidityPools\u003cRuntime\u003e\u003e::enable_as_collateral_internal(\n\t\t\t\t\u0026ALICE,\n\t\t\t\tCurrencyId::DOT\n\t\t\t));\n\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 0, 50),\n\t\t\t\tOk((2, 0))\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::get_hypothetical_account_liquidity(\u0026ALICE, CurrencyId::DOT, 0, 100),\n\t\t\t\tOk((0, 98))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_liquidity_pool_exchange_rate_should_work() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, dollars(100_u128))\n\t\t.user_balance(ALICE, CurrencyId::MDOT, dollars(125_u128))\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(300_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// exchange_rate = (100 - 0 + 300) / 125 = 3.2\n\t\t\tassert_eq!(\n\t\t\t\tController::get_liquidity_pool_exchange_rate(CurrencyId::DOT),\n\t\t\t\tSome(Rate::saturating_from_rational(32, 10))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_liquidity_pool_borrow_and_supply_rates_less_than_kink() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, dollars(100_u128))\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(300_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// utilization_rate = 300 / (100 - 0 + 300) = 0.75 \u003c kink = 0.8\n\t\t\t// borrow_rate = 0.75 * 0.000_000_009 + 0 = 0.00000000675\n\t\t\t// supply_rate = 0.75 * 0.00_000_000_675 * (1 - 0.1) = 0.00000000455625\n\t\t\tassert_eq!(\n\t\t\t\tController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT),\n\t\t\t\tSome((Rate::from_inner(6750000000), Rate::from_inner(4556250000)))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_liquidity_pool_borrow_and_supply_rates_above_kink() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, dollars(100_u128))\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(500_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// utilization_rate = 500 / (100 - 0 + 500) = 0.83 \u003e kink = 0.8\n\t\t\t// borrow_rate = 0.83 * 0.8 * 0.000_000_207  + (0.8 * 0.000_000_009) + 0 = 0.0000001452\n\t\t\t// supply_rate = 0.83 * 0.0000001452 * (1 - 0.1) = 0.00000000455625\n\t\t\tassert_eq!(\n\t\t\t\tController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT),\n\t\t\t\tSome((Rate::from_inner(145199999999), Rate::from_inner(108899999999)))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_allowed_should_work() {\n\tExtBuilder::default().alice_deposit_60_dot().build().execute_with(|| {\n\t\tassert_ok!(Controller::redeem_allowed(CurrencyId::DOT, \u0026ALICE, dollars(40_u128)));\n\n\t\t// collateral parameter is set to true.\n\t\tassert_ok!(\u003cLiquidityPools\u003cRuntime\u003e\u003e::enable_as_collateral_internal(\n\t\t\t\u0026ALICE,\n\t\t\tCurrencyId::DOT\n\t\t));\n\n\t\tassert_err!(\n\t\t\tController::redeem_allowed(CurrencyId::DOT, \u0026ALICE, dollars(100_u128)),\n\t\t\tError::\u003cRuntime\u003e::InsufficientLiquidity\n\t\t);\n\t});\n}\n\n#[test]\nfn borrow_allowed_should_work() {\n\tExtBuilder::default().alice_deposit_60_dot().build().execute_with(|| {\n\t\t// collateral parameter is set to false. User can't borrow\n\t\tassert_err!(\n\t\t\tController::borrow_allowed(CurrencyId::DOT, \u0026ALICE, dollars(10_u128)),\n\t\t\tError::\u003cRuntime\u003e::InsufficientLiquidity\n\t\t);\n\n\t\t// collateral parameter is set to true. User can borrow.\n\t\tassert_ok!(\u003cLiquidityPools\u003cRuntime\u003e\u003e::enable_as_collateral_internal(\n\t\t\t\u0026ALICE,\n\t\t\tCurrencyId::DOT\n\t\t));\n\n\t\tassert_ok!(Controller::borrow_allowed(CurrencyId::DOT, \u0026ALICE, dollars(10_u128)));\n\n\t\tassert_noop!(\n\t\t\tController::borrow_allowed(CurrencyId::DOT, \u0026ALICE, dollars(999_u128)),\n\t\t\tError::\u003cRuntime\u003e::InsufficientLiquidity\n\t\t);\n\t});\n}\n\n#[test]\nfn is_operation_allowed_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Deposit),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Redeem),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Borrow),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Repay),\n\t\t\t\ttrue\n\t\t\t);\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Deposit\n\t\t\t));\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Redeem\n\t\t\t));\n\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Deposit),\n\t\t\t\tfalse\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Redeem),\n\t\t\t\tfalse\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Borrow),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tassert_eq!(\n\t\t\t\tController::is_operation_allowed(CurrencyId::DOT, Operation::Repay),\n\t\t\t\ttrue\n\t\t\t);\n\t\t});\n}\n\n/* ----------------------------------------------------------------------------------------- */\n\n// Admin functions\n\n#[test]\nfn set_insurance_factor_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE set insurance factor equal 2.0\n\t\t\tassert_ok!(Controller::set_insurance_factor(alice(), CurrencyId::DOT, 20, 10));\n\t\t\tlet expected_event = TestEvent::controller(Event::InsuranceFactorChanged);\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t\tassert_eq!(\n\t\t\t\tController::controller_dates(CurrencyId::DOT).insurance_factor,\n\t\t\t\tRate::saturating_from_rational(20, 10)\n\t\t\t);\n\n\t\t\t// ALICE set insurance factor equal 0.0\n\t\t\tassert_ok!(Controller::set_insurance_factor(alice(), CurrencyId::DOT, 0, 1));\n\t\t\tlet expected_event = TestEvent::controller(Event::InsuranceFactorChanged);\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t\tassert_eq!(\n\t\t\t\tController::controller_dates(CurrencyId::DOT).insurance_factor,\n\t\t\t\tRate::from_inner(0)\n\t\t\t);\n\n\t\t\t// Overflow in calculation: 20 / 0\n\t\t\tassert_noop!(\n\t\t\t\tController::set_insurance_factor(alice(), CurrencyId::DOT, 20, 0),\n\t\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t\t);\n\n\t\t\t// The dispatch origin of this call must be Administrator.\n\t\t\tassert_noop!(\n\t\t\t\tController::set_insurance_factor(bob(), CurrencyId::DOT, 20, 10),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::set_insurance_factor(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn set_max_borrow_rate_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE set max borrow rate equal 2.0\n\t\t\tassert_ok!(Controller::set_max_borrow_rate(alice(), CurrencyId::DOT, 20, 10));\n\t\t\tlet expected_event = TestEvent::controller(Event::MaxBorrowRateChanged);\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t\tassert_eq!(\n\t\t\t\tController::controller_dates(CurrencyId::DOT).max_borrow_rate,\n\t\t\t\tRate::saturating_from_rational(20, 10)\n\t\t\t);\n\n\t\t\t// ALICE can't set max borrow rate equal 0.0\n\t\t\tassert_noop!(\n\t\t\t\tController::set_max_borrow_rate(alice(), CurrencyId::DOT, 0, 1),\n\t\t\t\tError::\u003cRuntime\u003e::MaxBorrowRateCannotBeZero\n\t\t\t);\n\n\t\t\t// Overflow in calculation: 20 / 0\n\t\t\tassert_noop!(\n\t\t\t\tController::set_max_borrow_rate(alice(), CurrencyId::DOT, 20, 0),\n\t\t\t\tError::\u003cRuntime\u003e::NumOverflow\n\t\t\t);\n\n\t\t\t// The dispatch origin of this call must be Administrator.\n\t\t\tassert_noop!(\n\t\t\t\tController::set_max_borrow_rate(bob(), CurrencyId::DOT, 20, 10),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::set_max_borrow_rate(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn pause_specific_operation_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).deposit_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).redeem_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).borrow_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).repay_paused, false);\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Deposit\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsPaused(CurrencyId::DOT, Operation::Deposit));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Redeem\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsPaused(CurrencyId::DOT, Operation::Redeem));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Borrow\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsPaused(CurrencyId::DOT, Operation::Borrow));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::pause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tOperation::Repay\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsPaused(CurrencyId::DOT, Operation::Repay));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).deposit_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).redeem_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).borrow_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::DOT).repay_paused, true);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::pause_specific_operation(bob(), CurrencyId::DOT, Operation::Deposit),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\t\t\tassert_noop!(\n\t\t\t\tController::pause_specific_operation(alice(), CurrencyId::MDOT, Operation::Redeem),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn unpause_specific_operation_should_work() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.pool_mock(CurrencyId::KSM)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).deposit_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).redeem_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).borrow_paused, true);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).repay_paused, true);\n\n\t\t\tassert_ok!(Controller::unpause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tOperation::Deposit\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsUnPaused(CurrencyId::KSM, Operation::Deposit));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::unpause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tOperation::Redeem\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsUnPaused(CurrencyId::KSM, Operation::Redeem));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::unpause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tOperation::Borrow\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsUnPaused(CurrencyId::KSM, Operation::Borrow));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_ok!(Controller::unpause_specific_operation(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tOperation::Repay\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::controller(Event::OperationIsUnPaused(CurrencyId::KSM, Operation::Repay));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).deposit_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).redeem_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).borrow_paused, false);\n\t\t\tassert_eq!(Controller::pause_keepers(\u0026CurrencyId::KSM).repay_paused, false);\n\n\t\t\tassert_noop!(\n\t\t\t\tController::unpause_specific_operation(bob(), CurrencyId::DOT, Operation::Deposit),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\t\t\tassert_noop!(\n\t\t\t\tController::unpause_specific_operation(alice(), CurrencyId::MDOT, Operation::Redeem),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn deposit_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE deposit 100 DOT in pool insurance\n\t\t\tassert_ok!(Controller::deposit_insurance(alice(), CurrencyId::DOT, 100));\n\t\t\tlet expected_event = TestEvent::controller(Event::DepositedInsurance(CurrencyId::DOT, 100));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 100);\n\n\t\t\t// Bob is not added to the allow-list of admins, so this action is not available for him.\n\t\t\tassert_noop!(\n\t\t\t\tController::deposit_insurance(bob(), CurrencyId::DOT, 101),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn do_deposit_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.user_balance(BOB, CurrencyId::BTC, ONE_HUNDRED)\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.pool_mock(CurrencyId::BTC)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE deposit 60 DOT in pool insurance\n\t\t\tassert_ok!(Controller::do_deposit_insurance(\u0026ALICE, CurrencyId::DOT, 60));\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 60);\n\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 40);\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), 60);\n\n\t\t\t// ALICE deposit 5 DOT in pool insurance\n\t\t\tassert_ok!(Controller::do_deposit_insurance(\u0026ALICE, CurrencyId::DOT, 5));\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 65);\n\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 35);\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), 65);\n\n\t\t\t// Not enough balance to deposit insurance.\n\t\t\tassert_noop!(\n\t\t\t\tController::do_deposit_insurance(\u0026ALICE, CurrencyId::DOT, 101),\n\t\t\t\tError::\u003cRuntime\u003e::NotEnoughBalance\n\t\t\t);\n\n\t\t\t// There is no pool 'MDOT'.\n\t\t\tassert_noop!(\n\t\t\t\tController::do_deposit_insurance(\u0026ALICE, CurrencyId::MDOT, 5),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\n\t\t\t// Set BTC pool total insurance = max_value()\n\t\t\tassert_ok!(TestPools::set_pool_total_insurance(\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tBalance::max_value()\n\t\t\t));\n\n\t\t\t// Overflow in calculation: total_insurance = max_value() + 50\n\t\t\tassert_err!(\n\t\t\t\tController::do_deposit_insurance(\u0026BOB, CurrencyId::BTC, 50),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceOverflowed\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.pool_total_insurance(CurrencyId::DOT, 1000)\n\t\t.pool_balance(CurrencyId::DOT, 1000)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE redeem 100 DOT from pool insurance.\n\t\t\tassert_ok!(Controller::redeem_insurance(alice(), CurrencyId::DOT, 125));\n\t\t\tlet expected_event = TestEvent::controller(Event::RedeemedInsurance(CurrencyId::DOT, 125));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 875);\n\t\t\tassert_eq!(\n\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026TestPools::pools_account_id()),\n\t\t\t\t875,\n\t\t\t);\n\n\t\t\t// Bob is not added to the allow-list of admins, so this action is not available for him.\n\t\t\tassert_noop!(\n\t\t\t\tController::redeem_insurance(bob(), CurrencyId::DOT, 101),\n\t\t\t\tError::\u003cRuntime\u003e::RequireAdmin\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn do_redeem_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.pool_total_insurance(CurrencyId::DOT, 1000)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// ALICE redeem 150 DOT from pool insurance\n\t\t\tassert_ok!(Controller::do_redeem_insurance(\u0026ALICE, CurrencyId::DOT, 150));\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 850);\n\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 250);\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), 850);\n\n\t\t\t// ALICE redeem 300 DOT from pool insurance\n\t\t\tassert_ok!(Controller::do_redeem_insurance(\u0026ALICE, CurrencyId::DOT, 300));\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), 550);\n\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 550);\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), 550);\n\n\t\t\t// Not enough balance to redeem insurance: 550 - 600 \u003c 0\n\t\t\tassert_noop!(\n\t\t\t\tController::do_redeem_insurance(\u0026ALICE, CurrencyId::DOT, 600),\n\t\t\t\tError::\u003cRuntime\u003e::NotEnoughBalance\n\t\t\t);\n\n\t\t\t// There is no pool 'MDOT'.\n\t\t\tassert_noop!(\n\t\t\t\tController::do_redeem_insurance(\u0026ALICE, CurrencyId::MDOT, 5),\n\t\t\t\tError::\u003cRuntime\u003e::PoolNotFound\n\t\t\t);\n\n\t\t\t// Set DOT pool total insurance = max_value()\n\t\t\tassert_ok!(TestPools::set_pool_total_insurance(\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tBalance::max_value()\n\t\t\t));\n\t\t\t// Overflow in calculation: total_insurance = max_value() + 50\n\t\t\tassert_err!(\n\t\t\t\tController::do_deposit_insurance(\u0026ALICE, CurrencyId::DOT, 50),\n\t\t\t\tError::\u003cRuntime\u003e::BalanceOverflowed\n\t\t\t);\n\t\t});\n}\n","traces":[{"line":9,"address":[4549845,4549840],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":10,"address":[5348711,5348768,5348487,5348640,5348575],"length":1,"stats":{"Line":5},"fn_name":null},{"line":11,"address":[5348624,5348541,5348831],"length":1,"stats":{"Line":2},"fn_name":null},{"line":12,"address":[5348669,5348632],"length":1,"stats":{"Line":2},"fn_name":null},{"line":13,"address":[5348760,5348677,5348872],"length":1,"stats":{"Line":2},"fn_name":null},{"line":15,"address":[4549872],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":16,"address":[4549879],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[4549889],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4550170,4550347],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4550640,4550298,4550802],"length":1,"stats":{"Line":2},"fn_name":null},{"line":22,"address":[4551313,4551463],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4550753],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[4551095],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4551772,4551926],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4551421],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[4552189,4552350,4552246],"length":1,"stats":{"Line":2},"fn_name":null},{"line":31,"address":[4551877],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4552197],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[4552624,4552629],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":39,"address":[5349071,5349225,5349169,5348983],"length":1,"stats":{"Line":4},"fn_name":null},{"line":40,"address":[5349288,5349037,5349120],"length":1,"stats":{"Line":2},"fn_name":null},{"line":41,"address":[5349329,5349136,5349217],"length":1,"stats":{"Line":2},"fn_name":null},{"line":43,"address":[4552675,4552656],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":44,"address":[4552663],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[4552690],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4553172,4552971],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[4553473],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4553099],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[4553465],"length":1,"stats":{"Line":1},"fn_name":null},{"line":56,"address":[4553782],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[4553792,4553845,4553887],"length":1,"stats":{"Line":3},"fn_name":null},{"line":59,"address":[4553806],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[4553837],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4554907],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[4555243],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[4555552,4555557],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":71,"address":[4555616,4555584],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":73,"address":[4555638,4555768,4555591],"length":1,"stats":{"Line":2},"fn_name":null},{"line":76,"address":[4556144,4555741,4556087],"length":1,"stats":{"Line":3},"fn_name":null},{"line":81,"address":[4557189,4557184],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":82,"address":[4557216,4557256],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":84,"address":[4557382,4557517],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4557223,4557271],"length":1,"stats":{"Line":2},"fn_name":null},{"line":86,"address":[4557307],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4557490,4557925],"length":1,"stats":{"Line":2},"fn_name":null},{"line":91,"address":[4557820,4557879],"length":1,"stats":{"Line":2},"fn_name":null},{"line":92,"address":[4557917],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[4558997,4558992],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":99,"address":[4559024,4559068],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":101,"address":[4559276,4559129],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4559117,4559031],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[4559753,4559623],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[4559611],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[4559232],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[4559726,4560160],"length":1,"stats":{"Line":2},"fn_name":null},{"line":117,"address":[4560139,4560064],"length":1,"stats":{"Line":2},"fn_name":null},{"line":118,"address":[4560152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[4561216,4561221],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":125,"address":[4561248,4561322],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":127,"address":[4561285,4561344,4561474],"length":1,"stats":{"Line":2},"fn_name":null},{"line":130,"address":[4561447,4561851],"length":1,"stats":{"Line":2},"fn_name":null},{"line":131,"address":[4561817],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[4561843],"length":1,"stats":{"Line":1},"fn_name":null},{"line":138,"address":[4562928,4562933],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":139,"address":[4562960,4563000],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":141,"address":[4563206,4563076],"length":1,"stats":{"Line":1},"fn_name":null},{"line":142,"address":[4562967,4563015],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[4563629,4563179],"length":1,"stats":{"Line":2},"fn_name":null},{"line":147,"address":[4563561,4563519],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[4563621],"length":1,"stats":{"Line":1},"fn_name":null},{"line":151,"address":[4564857,4564720],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[4564792,4564744],"length":1,"stats":{"Line":2},"fn_name":null},{"line":153,"address":[4564849],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[4565984,4565989],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":160,"address":[5350071,5350173,5350266],"length":1,"stats":{"Line":3},"fn_name":null},{"line":161,"address":[5350117,5350258,5350329],"length":1,"stats":{"Line":2},"fn_name":null},{"line":163,"address":[4566016],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":165,"address":[4566112,4566206],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[4566030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[4566059],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[4566480,4566485],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":174,"address":[5350637,5350541,5350423,5350469],"length":1,"stats":{"Line":4},"fn_name":null},{"line":175,"address":[5350498,5350461],"length":1,"stats":{"Line":2},"fn_name":null},{"line":176,"address":[5350700,5350629,5350506],"length":1,"stats":{"Line":2},"fn_name":null},{"line":178,"address":[4566512],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":180,"address":[4566526,4566645],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[4566933,4566928],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":186,"address":[5351021,5350917,5351193,5351097,5350845,5350791],"length":1,"stats":{"Line":6},"fn_name":null},{"line":187,"address":[5350837,5350874],"length":1,"stats":{"Line":2},"fn_name":null},{"line":189,"address":[5350882],"length":1,"stats":{"Line":1},"fn_name":null},{"line":192,"address":[5350900],"length":1,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[5351050,5351013],"length":1,"stats":{"Line":2},"fn_name":null},{"line":196,"address":[5351185,5351297,5351058],"length":1,"stats":{"Line":2},"fn_name":null},{"line":198,"address":[4566983,4566960],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":199,"address":[4566967,4567083,4567044],"length":1,"stats":{"Line":3},"fn_name":null},{"line":200,"address":[4566998],"length":1,"stats":{"Line":1},"fn_name":null},{"line":201,"address":[4567036],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[4568133,4568128],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":208,"address":[4568216,4568160],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":210,"address":[4568480,4568310],"length":1,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[4568167],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[4568231],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[4568856,4568991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4568418],"length":1,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[4568781],"length":1,"stats":{"Line":1},"fn_name":null},{"line":221,"address":[4569375,4568964],"length":1,"stats":{"Line":2},"fn_name":null},{"line":222,"address":[4569294],"length":1,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[4569367],"length":1,"stats":{"Line":1},"fn_name":null},{"line":227,"address":[4570566,4570466],"length":1,"stats":{"Line":2},"fn_name":null},{"line":228,"address":[4570487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":229,"address":[4570558],"length":1,"stats":{"Line":1},"fn_name":null},{"line":233,"address":[4571657,4571777,4571735],"length":1,"stats":{"Line":3},"fn_name":null},{"line":234,"address":[4571676],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[4571727],"length":1,"stats":{"Line":1},"fn_name":null},{"line":241,"address":[4572949,4572944],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":242,"address":[4572976,4573016],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":244,"address":[4573235,4573370],"length":1,"stats":{"Line":1},"fn_name":null},{"line":245,"address":[4573093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":246,"address":[4572983],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[4573031],"length":1,"stats":{"Line":1},"fn_name":null},{"line":248,"address":[4573062],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[4573160],"length":1,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[4573866,4573343],"length":1,"stats":{"Line":2},"fn_name":null},{"line":255,"address":[4573789],"length":1,"stats":{"Line":1},"fn_name":null},{"line":256,"address":[4573681],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[4573714],"length":1,"stats":{"Line":1},"fn_name":null},{"line":258,"address":[4573766],"length":1,"stats":{"Line":1},"fn_name":null},{"line":260,"address":[4573858],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[4574957,4575180],"length":1,"stats":{"Line":2},"fn_name":null},{"line":265,"address":[4575103],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[4574978],"length":1,"stats":{"Line":1},"fn_name":null},{"line":267,"address":[4575047],"length":1,"stats":{"Line":1},"fn_name":null},{"line":268,"address":[4575080],"length":1,"stats":{"Line":1},"fn_name":null},{"line":270,"address":[4575172],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[4576320,4576325],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":277,"address":[4576404,4576352],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":279,"address":[4576578,4576713],"length":1,"stats":{"Line":1},"fn_name":null},{"line":280,"address":[4576490],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[4576378],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[4576419],"length":1,"stats":{"Line":1},"fn_name":null},{"line":284,"address":[4576495],"length":1,"stats":{"Line":1},"fn_name":null},{"line":288,"address":[4577163,4576686],"length":1,"stats":{"Line":2},"fn_name":null},{"line":289,"address":[4577148],"length":1,"stats":{"Line":1},"fn_name":null},{"line":290,"address":[4577024],"length":1,"stats":{"Line":1},"fn_name":null},{"line":291,"address":[4577068],"length":1,"stats":{"Line":1},"fn_name":null},{"line":293,"address":[4577155],"length":1,"stats":{"Line":1},"fn_name":null},{"line":297,"address":[4578421,4578254],"length":1,"stats":{"Line":2},"fn_name":null},{"line":298,"address":[4578406],"length":1,"stats":{"Line":1},"fn_name":null},{"line":299,"address":[4578278],"length":1,"stats":{"Line":1},"fn_name":null},{"line":300,"address":[4578326],"length":1,"stats":{"Line":1},"fn_name":null},{"line":302,"address":[4578413],"length":1,"stats":{"Line":1},"fn_name":null},{"line":308,"address":[4579541,4579536],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":309,"address":[4579568,4579608],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":311,"address":[4579696,4579843],"length":1,"stats":{"Line":1},"fn_name":null},{"line":312,"address":[4579575,4579623],"length":1,"stats":{"Line":2},"fn_name":null},{"line":316,"address":[4580336,4580206],"length":1,"stats":{"Line":1},"fn_name":null},{"line":317,"address":[4580144],"length":1,"stats":{"Line":1},"fn_name":null},{"line":320,"address":[4579799],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[4580756,4580309],"length":1,"stats":{"Line":2},"fn_name":null},{"line":327,"address":[4580691],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[4580649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":332,"address":[4580748],"length":1,"stats":{"Line":1},"fn_name":null},{"line":336,"address":[4581847,4581988],"length":1,"stats":{"Line":2},"fn_name":null},{"line":337,"address":[4581920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":340,"address":[4581878],"length":1,"stats":{"Line":1},"fn_name":null},{"line":342,"address":[4581980],"length":1,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[4583125,4583120],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":349,"address":[5352021,5351911,5352178,5352271],"length":1,"stats":{"Line":4},"fn_name":null},{"line":350,"address":[5352334,5351965,5352106],"length":1,"stats":{"Line":2},"fn_name":null},{"line":351,"address":[5352263,5352375,5352122],"length":1,"stats":{"Line":2},"fn_name":null},{"line":353,"address":[4583152],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":356,"address":[4583255,4583448],"length":1,"stats":{"Line":1},"fn_name":null},{"line":357,"address":[4583166],"length":1,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[4583946,4583756],"length":1,"stats":{"Line":1},"fn_name":null},{"line":363,"address":[4583365],"length":1,"stats":{"Line":1},"fn_name":null},{"line":368,"address":[4584224,4584328],"length":1,"stats":{"Line":1},"fn_name":null},{"line":369,"address":[4583866],"length":1,"stats":{"Line":1},"fn_name":null},{"line":376,"address":[4584608,4584613],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":377,"address":[4584640],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":380,"address":[4584743,4584948],"length":1,"stats":{"Line":1},"fn_name":null},{"line":381,"address":[4584654],"length":1,"stats":{"Line":1},"fn_name":null},{"line":384,"address":[4585256,4585458],"length":1,"stats":{"Line":1},"fn_name":null},{"line":385,"address":[4584853],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[4585736,4585840],"length":1,"stats":{"Line":1},"fn_name":null},{"line":389,"address":[4585366],"length":1,"stats":{"Line":1},"fn_name":null},{"line":396,"address":[4586117,4586112],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":397,"address":[5352615,5352645],"length":1,"stats":{"Line":2},"fn_name":null},{"line":401,"address":[4586144],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":404,"address":[4586452,4586247],"length":1,"stats":{"Line":1},"fn_name":null},{"line":405,"address":[4586158],"length":1,"stats":{"Line":1},"fn_name":null},{"line":408,"address":[4586760,4586962],"length":1,"stats":{"Line":1},"fn_name":null},{"line":409,"address":[4586357],"length":1,"stats":{"Line":1},"fn_name":null},{"line":412,"address":[4587344,4587240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":413,"address":[4586870],"length":1,"stats":{"Line":1},"fn_name":null},{"line":420,"address":[4587621,4587616],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":421,"address":[5352775,5352952,5352897,5353084,5352813,5352842,5353001,5353180],"length":1,"stats":{"Line":8},"fn_name":null},{"line":424,"address":[5352834],"length":1,"stats":{"Line":1},"fn_name":null},{"line":425,"address":[5352889],"length":1,"stats":{"Line":1},"fn_name":null},{"line":426,"address":[5352944],"length":1,"stats":{"Line":1},"fn_name":null},{"line":427,"address":[5352993,5353042],"length":1,"stats":{"Line":2},"fn_name":null},{"line":428,"address":[5353172,5353243,5353050],"length":1,"stats":{"Line":2},"fn_name":null},{"line":430,"address":[4587648],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":433,"address":[4587739,4587894],"length":1,"stats":{"Line":1},"fn_name":null},{"line":434,"address":[4587662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":439,"address":[4587857,4588199],"length":1,"stats":{"Line":2},"fn_name":null},{"line":441,"address":[4587849],"length":1,"stats":{"Line":1},"fn_name":null},{"line":444,"address":[4588715,4588531],"length":1,"stats":{"Line":1},"fn_name":null},{"line":445,"address":[4588454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":448,"address":[4588993,4589097],"length":1,"stats":{"Line":1},"fn_name":null},{"line":449,"address":[4588635],"length":1,"stats":{"Line":1},"fn_name":null},{"line":456,"address":[4589376,4589381],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":457,"address":[5353691,5353634,5353335,5353431,5353530],"length":1,"stats":{"Line":5},"fn_name":null},{"line":458,"address":[5353754,5353480,5353397],"length":1,"stats":{"Line":2},"fn_name":null},{"line":459,"address":[5353584,5353795,5353496],"length":1,"stats":{"Line":2},"fn_name":null},{"line":460,"address":[5353836,5353683,5353600],"length":1,"stats":{"Line":2},"fn_name":null},{"line":462,"address":[4589408],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":464,"address":[4589514,4589608],"length":1,"stats":{"Line":1},"fn_name":null},{"line":465,"address":[4589415],"length":1,"stats":{"Line":1},"fn_name":null},{"line":466,"address":[4589451],"length":1,"stats":{"Line":1},"fn_name":null},{"line":472,"address":[4589893,4589888],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":473,"address":[5354145,5353959,5354201,5354047],"length":1,"stats":{"Line":4},"fn_name":null},{"line":474,"address":[5354264,5354096,5354013],"length":1,"stats":{"Line":2},"fn_name":null},{"line":475,"address":[5354305,5354112,5354193],"length":1,"stats":{"Line":2},"fn_name":null},{"line":477,"address":[4589920],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":481,"address":[4590241,4590147],"length":1,"stats":{"Line":1},"fn_name":null},{"line":482,"address":[4589927],"length":1,"stats":{"Line":1},"fn_name":null},{"line":483,"address":[4589953],"length":1,"stats":{"Line":1},"fn_name":null},{"line":489,"address":[4590517,4590512],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":490,"address":[5354495,5354649,5354593,5354407],"length":1,"stats":{"Line":4},"fn_name":null},{"line":491,"address":[5354712,5354461,5354544],"length":1,"stats":{"Line":2},"fn_name":null},{"line":492,"address":[5354753,5354641,5354560],"length":1,"stats":{"Line":2},"fn_name":null},{"line":494,"address":[4590544],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":498,"address":[4590771,4590865],"length":1,"stats":{"Line":1},"fn_name":null},{"line":499,"address":[4590551],"length":1,"stats":{"Line":1},"fn_name":null},{"line":500,"address":[4590577],"length":1,"stats":{"Line":1},"fn_name":null},{"line":506,"address":[4591136,4591141],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":507,"address":[4591168],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":508,"address":[4591175],"length":1,"stats":{"Line":1},"fn_name":null},{"line":511,"address":[4591541],"length":1,"stats":{"Line":1},"fn_name":null},{"line":513,"address":[4591533],"length":1,"stats":{"Line":1},"fn_name":null},{"line":516,"address":[4591885,4592066],"length":1,"stats":{"Line":1},"fn_name":null},{"line":517,"address":[4591793],"length":1,"stats":{"Line":1},"fn_name":null},{"line":518,"address":[4591877],"length":1,"stats":{"Line":1},"fn_name":null},{"line":524,"address":[4592341,4592336],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":525,"address":[4592415,4592368],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":527,"address":[4592731,4592499],"length":1,"stats":{"Line":1},"fn_name":null},{"line":528,"address":[4592375,4592437],"length":1,"stats":{"Line":2},"fn_name":null},{"line":529,"address":[4592491],"length":1,"stats":{"Line":1},"fn_name":null},{"line":533,"address":[4592694,4593036],"length":1,"stats":{"Line":2},"fn_name":null},{"line":535,"address":[4592686],"length":1,"stats":{"Line":1},"fn_name":null},{"line":538,"address":[4593284],"length":1,"stats":{"Line":1},"fn_name":null},{"line":540,"address":[4593635,4593762],"length":1,"stats":{"Line":2},"fn_name":null},{"line":541,"address":[4593649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":542,"address":[4593754],"length":1,"stats":{"Line":1},"fn_name":null},{"line":548,"address":[4594832,4594837],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":549,"address":[5355149,5355111],"length":1,"stats":{"Line":2},"fn_name":null},{"line":550,"address":[5355141],"length":1,"stats":{"Line":1},"fn_name":null},{"line":552,"address":[4594864],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":553,"address":[4595085,4594927],"length":1,"stats":{"Line":1},"fn_name":null},{"line":554,"address":[4594871],"length":1,"stats":{"Line":1},"fn_name":null},{"line":557,"address":[4595544,4595386],"length":1,"stats":{"Line":1},"fn_name":null},{"line":558,"address":[4595017],"length":1,"stats":{"Line":1},"fn_name":null},{"line":561,"address":[4596003,4595845],"length":1,"stats":{"Line":1},"fn_name":null},{"line":562,"address":[4595476],"length":1,"stats":{"Line":1},"fn_name":null},{"line":565,"address":[4596304,4596467],"length":1,"stats":{"Line":1},"fn_name":null},{"line":566,"address":[4595935],"length":1,"stats":{"Line":1},"fn_name":null},{"line":570,"address":[4596776],"length":1,"stats":{"Line":1},"fn_name":null},{"line":571,"address":[4596394],"length":1,"stats":{"Line":1},"fn_name":null},{"line":572,"address":[4596760],"length":1,"stats":{"Line":1},"fn_name":null},{"line":573,"address":[4596768],"length":1,"stats":{"Line":1},"fn_name":null},{"line":575,"address":[4597136],"length":1,"stats":{"Line":1},"fn_name":null},{"line":576,"address":[4597067],"length":1,"stats":{"Line":1},"fn_name":null},{"line":577,"address":[4597120],"length":1,"stats":{"Line":1},"fn_name":null},{"line":578,"address":[4597128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":581,"address":[4597641,4597483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":582,"address":[4597427],"length":1,"stats":{"Line":1},"fn_name":null},{"line":585,"address":[4597942,4598100],"length":1,"stats":{"Line":1},"fn_name":null},{"line":586,"address":[4597573],"length":1,"stats":{"Line":1},"fn_name":null},{"line":589,"address":[4598401,4598550],"length":1,"stats":{"Line":1},"fn_name":null},{"line":590,"address":[4598032],"length":1,"stats":{"Line":1},"fn_name":null},{"line":593,"address":[4598922,4598818],"length":1,"stats":{"Line":1},"fn_name":null},{"line":594,"address":[4598485],"length":1,"stats":{"Line":1},"fn_name":null},{"line":605,"address":[4599189,4599184],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":606,"address":[5355309,5355271],"length":1,"stats":{"Line":2},"fn_name":null},{"line":607,"address":[5355301],"length":1,"stats":{"Line":1},"fn_name":null},{"line":609,"address":[4599312,4599374],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":611,"address":[4599389,4599319],"length":1,"stats":{"Line":2},"fn_name":null},{"line":612,"address":[4599706],"length":1,"stats":{"Line":1},"fn_name":null},{"line":613,"address":[4599770,4599216,4599230,4600022],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":614,"address":[4600276,4600052,4600107],"length":1,"stats":{"Line":2},"fn_name":null},{"line":615,"address":[4599991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":616,"address":[4600078],"length":1,"stats":{"Line":1},"fn_name":null},{"line":620,"address":[4600210,4600577],"length":1,"stats":{"Line":2},"fn_name":null},{"line":621,"address":[4600904],"length":1,"stats":{"Line":1},"fn_name":null},{"line":622,"address":[4599264,4601220,4600968,4599278],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":623,"address":[4601436,4601250,4601306],"length":1,"stats":{"Line":2},"fn_name":null},{"line":624,"address":[4601189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":625,"address":[4601258],"length":1,"stats":{"Line":1},"fn_name":null},{"line":629,"address":[4601920,4601409],"length":1,"stats":{"Line":2},"fn_name":null},{"line":630,"address":[4601737],"length":1,"stats":{"Line":1},"fn_name":null},{"line":631,"address":[4601912],"length":1,"stats":{"Line":1},"fn_name":null},{"line":635,"address":[4603181,4602999],"length":1,"stats":{"Line":2},"fn_name":null},{"line":636,"address":[4603018],"length":1,"stats":{"Line":1},"fn_name":null},{"line":637,"address":[4603173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":640,"address":[4604442,4604260],"length":1,"stats":{"Line":2},"fn_name":null},{"line":641,"address":[4604279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":642,"address":[4604434],"length":1,"stats":{"Line":1},"fn_name":null},{"line":648,"address":[4605669,4605664],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":649,"address":[5355469,5355431],"length":1,"stats":{"Line":2},"fn_name":null},{"line":650,"address":[5355461],"length":1,"stats":{"Line":1},"fn_name":null},{"line":652,"address":[4605744,4605806],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":654,"address":[4605821,4605751],"length":1,"stats":{"Line":2},"fn_name":null},{"line":655,"address":[4606138],"length":1,"stats":{"Line":1},"fn_name":null},{"line":656,"address":[4605710,4605696,4606454,4606202],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":657,"address":[4606669,4606484,4606539],"length":1,"stats":{"Line":2},"fn_name":null},{"line":658,"address":[4606423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":659,"address":[4606510],"length":1,"stats":{"Line":1},"fn_name":null},{"line":663,"address":[4606642,4607154],"length":1,"stats":{"Line":2},"fn_name":null},{"line":664,"address":[4606970],"length":1,"stats":{"Line":1},"fn_name":null},{"line":665,"address":[4607146],"length":1,"stats":{"Line":1},"fn_name":null},{"line":669,"address":[4608435,4608233],"length":1,"stats":{"Line":2},"fn_name":null},{"line":670,"address":[4608252],"length":1,"stats":{"Line":1},"fn_name":null},{"line":671,"address":[4608427],"length":1,"stats":{"Line":1},"fn_name":null},{"line":675,"address":[4609696,4609514],"length":1,"stats":{"Line":2},"fn_name":null},{"line":676,"address":[4609533],"length":1,"stats":{"Line":1},"fn_name":null},{"line":677,"address":[4609688],"length":1,"stats":{"Line":1},"fn_name":null},{"line":680,"address":[4610775,4610957],"length":1,"stats":{"Line":2},"fn_name":null},{"line":681,"address":[4610794],"length":1,"stats":{"Line":1},"fn_name":null},{"line":682,"address":[4610949],"length":1,"stats":{"Line":1},"fn_name":null},{"line":688,"address":[4612213,4612208],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":689,"address":[5355591,5355629],"length":1,"stats":{"Line":2},"fn_name":null},{"line":690,"address":[5355621],"length":1,"stats":{"Line":1},"fn_name":null},{"line":692,"address":[4612432,4612480],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":693,"address":[4612646,4612445,4612503],"length":1,"stats":{"Line":2},"fn_name":null},{"line":694,"address":[4612939,4613090,4612593],"length":1,"stats":{"Line":2},"fn_name":null},{"line":695,"address":[4613534,4613037,4613383],"length":1,"stats":{"Line":2},"fn_name":null},{"line":696,"address":[4613827,4613481,4613998],"length":1,"stats":{"Line":2},"fn_name":null},{"line":698,"address":[4614307],"length":1,"stats":{"Line":1},"fn_name":null},{"line":699,"address":[4613925],"length":1,"stats":{"Line":1},"fn_name":null},{"line":700,"address":[4614291],"length":1,"stats":{"Line":1},"fn_name":null},{"line":701,"address":[4614299],"length":1,"stats":{"Line":1},"fn_name":null},{"line":703,"address":[4614598],"length":1,"stats":{"Line":1},"fn_name":null},{"line":704,"address":[4612254,4614970,4612240,4614694],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":706,"address":[4615016],"length":1,"stats":{"Line":1},"fn_name":null},{"line":707,"address":[4614915],"length":1,"stats":{"Line":1},"fn_name":null},{"line":708,"address":[4615000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":709,"address":[4615008],"length":1,"stats":{"Line":1},"fn_name":null},{"line":711,"address":[4615307],"length":1,"stats":{"Line":1},"fn_name":null},{"line":712,"address":[4615403,4612288,4615679,4612302],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":714,"address":[4615725],"length":1,"stats":{"Line":1},"fn_name":null},{"line":715,"address":[4615624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":716,"address":[4615709],"length":1,"stats":{"Line":1},"fn_name":null},{"line":717,"address":[4615717],"length":1,"stats":{"Line":1},"fn_name":null},{"line":719,"address":[4616016],"length":1,"stats":{"Line":1},"fn_name":null},{"line":720,"address":[4612350,4616388,4612336,4616112],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":722,"address":[4616434],"length":1,"stats":{"Line":1},"fn_name":null},{"line":723,"address":[4616333],"length":1,"stats":{"Line":1},"fn_name":null},{"line":724,"address":[4616418],"length":1,"stats":{"Line":1},"fn_name":null},{"line":725,"address":[4616426],"length":1,"stats":{"Line":1},"fn_name":null},{"line":727,"address":[4616725],"length":1,"stats":{"Line":1},"fn_name":null},{"line":728,"address":[4612384,4616821,4617077,4612398],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":730,"address":[4617258,4617115,4617042],"length":1,"stats":{"Line":2},"fn_name":null},{"line":731,"address":[4617551,4617205,4617702],"length":1,"stats":{"Line":2},"fn_name":null},{"line":732,"address":[4617649,4618146,4617995],"length":1,"stats":{"Line":2},"fn_name":null},{"line":733,"address":[4618571,4618439,4618093],"length":1,"stats":{"Line":2},"fn_name":null},{"line":735,"address":[4618537,4619056],"length":1,"stats":{"Line":2},"fn_name":null},{"line":736,"address":[4618864],"length":1,"stats":{"Line":1},"fn_name":null},{"line":737,"address":[4619048],"length":1,"stats":{"Line":1},"fn_name":null},{"line":739,"address":[4620346,4620135],"length":1,"stats":{"Line":2},"fn_name":null},{"line":740,"address":[4620154],"length":1,"stats":{"Line":1},"fn_name":null},{"line":741,"address":[4620338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":747,"address":[4621552,4621557],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":748,"address":[5355826,5355789,5355751],"length":1,"stats":{"Line":3},"fn_name":null},{"line":749,"address":[5355781],"length":1,"stats":{"Line":1},"fn_name":null},{"line":750,"address":[5355818],"length":1,"stats":{"Line":1},"fn_name":null},{"line":752,"address":[4621776,4621824],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":753,"address":[4621990,4621847,4621789],"length":1,"stats":{"Line":2},"fn_name":null},{"line":754,"address":[4622283,4621937,4622434],"length":1,"stats":{"Line":2},"fn_name":null},{"line":755,"address":[4622878,4622381,4622727],"length":1,"stats":{"Line":2},"fn_name":null},{"line":756,"address":[4622825,4623171,4623342],"length":1,"stats":{"Line":2},"fn_name":null},{"line":758,"address":[4623651],"length":1,"stats":{"Line":1},"fn_name":null},{"line":759,"address":[4623269],"length":1,"stats":{"Line":1},"fn_name":null},{"line":760,"address":[4623635],"length":1,"stats":{"Line":1},"fn_name":null},{"line":761,"address":[4623643],"length":1,"stats":{"Line":1},"fn_name":null},{"line":763,"address":[4623942],"length":1,"stats":{"Line":1},"fn_name":null},{"line":764,"address":[4624038,4621584,4624314,4621598],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":766,"address":[4624360],"length":1,"stats":{"Line":1},"fn_name":null},{"line":767,"address":[4624259],"length":1,"stats":{"Line":1},"fn_name":null},{"line":768,"address":[4624344],"length":1,"stats":{"Line":1},"fn_name":null},{"line":769,"address":[4624352],"length":1,"stats":{"Line":1},"fn_name":null},{"line":771,"address":[4624651],"length":1,"stats":{"Line":1},"fn_name":null},{"line":772,"address":[4625023,4621646,4624747,4621632],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":774,"address":[4625069],"length":1,"stats":{"Line":1},"fn_name":null},{"line":775,"address":[4624968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":776,"address":[4625053],"length":1,"stats":{"Line":1},"fn_name":null},{"line":777,"address":[4625061],"length":1,"stats":{"Line":1},"fn_name":null},{"line":779,"address":[4625360],"length":1,"stats":{"Line":1},"fn_name":null},{"line":780,"address":[4625456,4625732,4621680,4621694],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":782,"address":[4625778],"length":1,"stats":{"Line":1},"fn_name":null},{"line":783,"address":[4625677],"length":1,"stats":{"Line":1},"fn_name":null},{"line":784,"address":[4625762],"length":1,"stats":{"Line":1},"fn_name":null},{"line":785,"address":[4625770],"length":1,"stats":{"Line":1},"fn_name":null},{"line":787,"address":[4626069],"length":1,"stats":{"Line":1},"fn_name":null},{"line":788,"address":[4621742,4621728,4626165,4626421],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":790,"address":[4626602,4626459,4626386],"length":1,"stats":{"Line":2},"fn_name":null},{"line":791,"address":[4627046,4626549,4626895],"length":1,"stats":{"Line":2},"fn_name":null},{"line":792,"address":[4627490,4627339,4626993],"length":1,"stats":{"Line":2},"fn_name":null},{"line":793,"address":[4627783,4627915,4627437],"length":1,"stats":{"Line":2},"fn_name":null},{"line":795,"address":[4628400,4627881],"length":1,"stats":{"Line":2},"fn_name":null},{"line":796,"address":[4628208],"length":1,"stats":{"Line":1},"fn_name":null},{"line":797,"address":[4628392],"length":1,"stats":{"Line":1},"fn_name":null},{"line":799,"address":[4629479,4629690],"length":1,"stats":{"Line":2},"fn_name":null},{"line":800,"address":[4629498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":801,"address":[4629682],"length":1,"stats":{"Line":1},"fn_name":null},{"line":807,"address":[4630896,4630901],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":808,"address":[5355981,5355943,5356036],"length":1,"stats":{"Line":3},"fn_name":null},{"line":809,"address":[5355973],"length":1,"stats":{"Line":1},"fn_name":null},{"line":810,"address":[5356028],"length":1,"stats":{"Line":1},"fn_name":null},{"line":812,"address":[4630976,4631038],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":814,"address":[4631053,4630983],"length":1,"stats":{"Line":2},"fn_name":null},{"line":815,"address":[4631354],"length":1,"stats":{"Line":1},"fn_name":null},{"line":816,"address":[4631458,4631718,4630942,4630928],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":818,"address":[4631756,4631679,4631895],"length":1,"stats":{"Line":2},"fn_name":null},{"line":821,"address":[4632335,4631861],"length":1,"stats":{"Line":2},"fn_name":null},{"line":822,"address":[4632188],"length":1,"stats":{"Line":1},"fn_name":null},{"line":823,"address":[4632327],"length":1,"stats":{"Line":1},"fn_name":null},{"line":829,"address":[4633408,4633413],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":830,"address":[5356299,5356151,5356244,5356189,5356336],"length":1,"stats":{"Line":5},"fn_name":null},{"line":831,"address":[5356181],"length":1,"stats":{"Line":1},"fn_name":null},{"line":832,"address":[5356236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":833,"address":[5356291],"length":1,"stats":{"Line":1},"fn_name":null},{"line":834,"address":[5356328],"length":1,"stats":{"Line":1},"fn_name":null},{"line":836,"address":[4633440,4633512],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":838,"address":[4633454,4633531],"length":1,"stats":{"Line":2},"fn_name":null},{"line":839,"address":[4633993,4633779],"length":1,"stats":{"Line":1},"fn_name":null},{"line":840,"address":[4634294,4634456,4633929],"length":1,"stats":{"Line":2},"fn_name":null},{"line":841,"address":[4634757,4634399,4634945],"length":1,"stats":{"Line":2},"fn_name":null},{"line":844,"address":[4634869,4635242],"length":1,"stats":{"Line":2},"fn_name":null},{"line":845,"address":[4635490,4635704],"length":1,"stats":{"Line":1},"fn_name":null},{"line":846,"address":[4635640,4636005,4636167],"length":1,"stats":{"Line":2},"fn_name":null},{"line":847,"address":[4636607,4636110,4636468],"length":1,"stats":{"Line":2},"fn_name":null},{"line":850,"address":[4636573,4636956,4636998],"length":1,"stats":{"Line":3},"fn_name":null},{"line":851,"address":[4636900],"length":1,"stats":{"Line":1},"fn_name":null},{"line":852,"address":[4636948],"length":1,"stats":{"Line":1},"fn_name":null},{"line":856,"address":[4638054,4638129,4638171],"length":1,"stats":{"Line":3},"fn_name":null},{"line":857,"address":[4638073],"length":1,"stats":{"Line":1},"fn_name":null},{"line":858,"address":[4638121],"length":1,"stats":{"Line":1},"fn_name":null},{"line":862,"address":[4639229],"length":1,"stats":{"Line":1},"fn_name":null},{"line":863,"address":[4639221],"length":1,"stats":{"Line":1},"fn_name":null},{"line":868,"address":[4639533,4639716],"length":1,"stats":{"Line":1},"fn_name":null},{"line":869,"address":[4639477],"length":1,"stats":{"Line":1},"fn_name":null},{"line":870,"address":[4639525],"length":1,"stats":{"Line":1},"fn_name":null},{"line":876,"address":[4640133,4640128],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":877,"address":[5356597,5356455,5356493,5356548],"length":1,"stats":{"Line":4},"fn_name":null},{"line":878,"address":[5356485],"length":1,"stats":{"Line":1},"fn_name":null},{"line":879,"address":[5356540],"length":1,"stats":{"Line":1},"fn_name":null},{"line":880,"address":[5356589],"length":1,"stats":{"Line":1},"fn_name":null},{"line":882,"address":[4640208,4640270],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":884,"address":[4640215,4640285],"length":1,"stats":{"Line":2},"fn_name":null},{"line":885,"address":[4640586],"length":1,"stats":{"Line":1},"fn_name":null},{"line":886,"address":[4640160,4640690,4640950,4640174],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":888,"address":[4640911,4640988,4641133],"length":1,"stats":{"Line":2},"fn_name":null},{"line":889,"address":[4641471,4641610],"length":1,"stats":{"Line":1},"fn_name":null},{"line":890,"address":[4641093,4641426],"length":1,"stats":{"Line":2},"fn_name":null},{"line":895,"address":[4642050,4641576],"length":1,"stats":{"Line":2},"fn_name":null},{"line":896,"address":[4641903],"length":1,"stats":{"Line":1},"fn_name":null},{"line":897,"address":[4642042],"length":1,"stats":{"Line":1},"fn_name":null},{"line":903,"address":[4643125,4643120],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":904,"address":[5356820,5356727,5356765],"length":1,"stats":{"Line":3},"fn_name":null},{"line":905,"address":[5356757],"length":1,"stats":{"Line":1},"fn_name":null},{"line":906,"address":[5356812],"length":1,"stats":{"Line":1},"fn_name":null},{"line":908,"address":[4643152,4643224],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":910,"address":[4643243,4643166],"length":1,"stats":{"Line":2},"fn_name":null},{"line":911,"address":[4643491,4643705],"length":1,"stats":{"Line":1},"fn_name":null},{"line":912,"address":[4644168,4643641,4644006],"length":1,"stats":{"Line":2},"fn_name":null},{"line":913,"address":[4644469,4644657,4644111],"length":1,"stats":{"Line":2},"fn_name":null},{"line":916,"address":[4644954,4644581],"length":1,"stats":{"Line":2},"fn_name":null},{"line":917,"address":[4645202,4645416],"length":1,"stats":{"Line":1},"fn_name":null},{"line":918,"address":[4645879,4645352,4645717],"length":1,"stats":{"Line":2},"fn_name":null},{"line":919,"address":[4646180,4645822,4646319],"length":1,"stats":{"Line":2},"fn_name":null},{"line":922,"address":[4646285,4646710,4646668],"length":1,"stats":{"Line":3},"fn_name":null},{"line":923,"address":[4646612],"length":1,"stats":{"Line":1},"fn_name":null},{"line":924,"address":[4646660],"length":1,"stats":{"Line":1},"fn_name":null},{"line":928,"address":[4647841,4647883,4647766],"length":1,"stats":{"Line":3},"fn_name":null},{"line":929,"address":[4647785],"length":1,"stats":{"Line":1},"fn_name":null},{"line":930,"address":[4647833],"length":1,"stats":{"Line":1},"fn_name":null},{"line":934,"address":[4648941],"length":1,"stats":{"Line":1},"fn_name":null},{"line":935,"address":[4648933],"length":1,"stats":{"Line":1},"fn_name":null},{"line":939,"address":[4649245,4649428],"length":1,"stats":{"Line":1},"fn_name":null},{"line":940,"address":[4649189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":941,"address":[4649237],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":491,"coverable":491},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\n#[cfg(test)]\nmod tests {\n\tuse frame_support::{assert_noop, assert_ok, impl_outer_origin, parameter_types};\n\tuse frame_system::{self as system};\n\tuse liquidity_pools::{Pool, PoolUserData};\n\tuse minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\n\tuse orml_currencies::Currency;\n\tuse orml_traits::MultiCurrency;\n\tuse pallet_traits::Borrowing;\n\tuse sp_core::H256;\n\tuse sp_runtime::{\n\t\ttesting::Header,\n\t\ttraits::{IdentityLookup, Zero},\n\t\tDispatchResult, FixedPointNumber, ModuleId, Perbill,\n\t};\n\n\tuse controller::{ControllerData, PauseKeeper};\n\tuse minterest_model::MinterestModelData;\n\tuse minterest_protocol::Error as MinterestProtocolError;\n\n\tmod controller_tests;\n\tmod liquidity_pools_tests;\n\tmod minterest_model_tests;\n\tmod minterest_protocol_tests;\n\tmod scenario_tests;\n\n\timpl_outer_origin! {\n\t\tpub enum Origin for Test {}\n\t}\n\n\t#[derive(Clone, PartialEq, Eq)]\n\tpub struct Test;\n\n\tparameter_types! {\n\t\tpub const BlockHashCount: u64 = 250;\n\t\tpub const MaximumBlockWeight: u32 = 1024;\n\t\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\t\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n\n\t}\n\n\tpub type AccountId = u32;\n\timpl system::Trait for Test {\n\t\ttype BaseCallFilter = ();\n\t\ttype Origin = Origin;\n\t\ttype Call = ();\n\t\ttype Index = u64;\n\t\ttype BlockNumber = u64;\n\t\ttype Hash = H256;\n\t\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\t\ttype AccountId = AccountId;\n\t\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\t\ttype Header = Header;\n\t\ttype Event = ();\n\t\ttype BlockHashCount = BlockHashCount;\n\t\ttype MaximumBlockWeight = MaximumBlockWeight;\n\t\ttype DbWeight = ();\n\t\ttype BlockExecutionWeight = ();\n\t\ttype ExtrinsicBaseWeight = ();\n\t\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\t\ttype MaximumBlockLength = MaximumBlockLength;\n\t\ttype AvailableBlockRatio = AvailableBlockRatio;\n\t\ttype Version = ();\n\t\ttype PalletInfo = ();\n\t\ttype AccountData = ();\n\t\ttype OnNewAccount = ();\n\t\ttype OnKilledAccount = ();\n\t\ttype SystemWeightInfo = ();\n\t}\n\n\tparameter_types! {\n\t\tpub const ExistentialDeposit: u64 = 1;\n\t}\n\n\tpub struct MockBorrowing;\n\timpl Borrowing\u003cAccountId\u003e for MockBorrowing {\n\t\tfn update_state_on_borrow(\n\t\t\t_who: \u0026AccountId,\n\t\t\t_underlying_asset_id: CurrencyId,\n\t\t\t_amount_borrowed: Balance,\n\t\t\t_account_borrows: Balance,\n\t\t) -\u003e DispatchResult {\n\t\t\tOk(())\n\t\t}\n\n\t\tfn update_state_on_repay(\n\t\t\t_who: \u0026AccountId,\n\t\t\t_underlying_asset_id: CurrencyId,\n\t\t\t_amount_borrowed: Balance,\n\t\t\t_account_borrows: Balance,\n\t\t) -\u003e DispatchResult {\n\t\t\tOk(())\n\t\t}\n\t}\n\n\ttype Amount = i128;\n\timpl orml_tokens::Trait for Test {\n\t\ttype Event = ();\n\t\ttype Balance = Balance;\n\t\ttype Amount = Amount;\n\t\ttype CurrencyId = CurrencyId;\n\t\ttype OnReceived = ();\n\t\ttype WeightInfo = ();\n\t}\n\n\tparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n\t}\n\n\ttype NativeCurrency = Currency\u003cTest, GetNativeCurrencyId\u003e;\n\n\timpl orml_currencies::Trait for Test {\n\t\ttype Event = ();\n\t\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\t\ttype NativeCurrency = NativeCurrency;\n\t\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\t\ttype WeightInfo = ();\n\t}\n\n\timpl m_tokens::Trait for Test {\n\t\ttype Event = ();\n\t\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\t}\n\n\tparameter_types! {\n\t\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\t\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\t\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t\t];\n\t}\n\n\timpl liquidity_pools::Trait for Test {\n\t\ttype Event = ();\n\t\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\t\ttype ModuleId = LiquidityPoolsModuleId;\n\t\ttype InitialExchangeRate = InitialExchangeRate;\n\t\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n\t}\n\n\timpl minterest_protocol::Trait for Test {\n\t\ttype Event = ();\n\t\ttype Borrowing = MockBorrowing;\n\t}\n\n\timpl controller::Trait for Test {\n\t\ttype Event = ();\n\t}\n\n\timpl oracle::Trait for Test {\n\t\ttype Event = ();\n\t}\n\n\tparameter_types! {\n\t\tpub const MaxMembers: u32 = MAX_MEMBERS;\n\t}\n\n\timpl accounts::Trait for Test {\n\t\ttype Event = ();\n\t\ttype MaxMembers = MaxMembers;\n\t}\n\n\tparameter_types! {\n\t\tpub const BlocksPerYear: u128 = 5256000;\n\t}\n\n\timpl minterest_model::Trait for Test {\n\t\ttype Event = ();\n\t\ttype BlocksPerYear = BlocksPerYear;\n\t}\n\n\tpub const ADMIN: AccountId = 0;\n\tpub const ALICE: AccountId = 1;\n\tpub const BOB: AccountId = 2;\n\tpub const ONE_HUNDRED: Balance = 100_000 * DOLLARS;\n\tpub const BALANCE_ZERO: Balance = 0;\n\tpub const DOLLARS: Balance = 1_000_000_000_000_000_000;\n\tpub const RATE_ZERO: Rate = Rate::from_inner(0);\n\tpub const MAX_MEMBERS: u32 = 16;\n\n\tpub type MinterestProtocol = minterest_protocol::Module\u003cTest\u003e;\n\tpub type TestPools = liquidity_pools::Module\u003cTest\u003e;\n\tpub type TestController = controller::Module\u003cTest\u003e;\n\tpub type Currencies = orml_currencies::Module\u003cTest\u003e;\n\tpub type System = frame_system::Module\u003cTest\u003e;\n\n\tpub fn admin() -\u003e Origin {\n\t\tOrigin::signed(ADMIN)\n\t}\n\tpub fn alice() -\u003e Origin {\n\t\tOrigin::signed(ALICE)\n\t}\n\n\tpub struct ExtBuilder {\n\t\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n\t\tpools: Vec\u003c(CurrencyId, Pool)\u003e,\n\t\tpool_user_data: Vec\u003c(CurrencyId, AccountId, PoolUserData)\u003e,\n\t}\n\n\timpl Default for ExtBuilder {\n\t\tfn default() -\u003e Self {\n\t\t\tSelf {\n\t\t\t\tendowed_accounts: vec![],\n\t\t\t\tpools: vec![],\n\t\t\t\tpool_user_data: vec![],\n\t\t\t}\n\t\t}\n\t}\n\n\timpl ExtBuilder {\n\t\tpub fn user_balance(mut self, user: AccountId, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\t\tself.endowed_accounts.push((user, currency_id, balance));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_balance(mut self, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\t\tself.endowed_accounts\n\t\t\t\t.push((TestPools::pools_account_id(), currency_id, balance));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_total_borrowed(mut self, pool_id: CurrencyId, total_borrowed: Balance) -\u003e Self {\n\t\t\tself.pools.push((\n\t\t\t\tpool_id,\n\t\t\t\tPool {\n\t\t\t\t\ttotal_borrowed,\n\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t},\n\t\t\t));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_total_insurance(mut self, pool_id: CurrencyId, total_insurance: Balance) -\u003e Self {\n\t\t\tself.endowed_accounts\n\t\t\t\t.push((TestPools::pools_account_id(), pool_id, total_insurance));\n\t\t\tself.pools.push((\n\t\t\t\tpool_id,\n\t\t\t\tPool {\n\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\ttotal_insurance,\n\t\t\t\t},\n\t\t\t));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_user_data(\n\t\t\tmut self,\n\t\t\tpool_id: CurrencyId,\n\t\t\tuser: AccountId,\n\t\t\ttotal_borrowed: Balance,\n\t\t\tinterest_index: Rate,\n\t\t\tcollateral: bool,\n\t\t) -\u003e Self {\n\t\t\tself.pool_user_data.push((\n\t\t\t\tpool_id,\n\t\t\t\tuser,\n\t\t\t\tPoolUserData {\n\t\t\t\t\ttotal_borrowed,\n\t\t\t\t\tinterest_index,\n\t\t\t\t\tcollateral,\n\t\t\t\t},\n\t\t\t));\n\t\t\tself\n\t\t}\n\n\t\tpub fn pool_initial(mut self, pool_id: CurrencyId) -\u003e Self {\n\t\t\tself.pools.push((\n\t\t\t\tpool_id,\n\t\t\t\tPool {\n\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t},\n\t\t\t));\n\t\t\tself\n\t\t}\n\n\t\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\t\tlet mut t = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\t\t\torml_tokens::GenesisConfig::\u003cTest\u003e {\n\t\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\tcontroller::GenesisConfig::\u003cTest\u003e {\n\t\t\t\tcontroller_dates: vec![\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\tControllerData {\n\t\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t\tControllerData {\n\t\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t\tControllerData {\n\t\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),\n\t\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000),\n\t\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t],\n\t\t\t\tpause_keepers: vec![\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\t\tdeposit_paused: true,\n\t\t\t\t\t\t\tredeem_paused: true,\n\t\t\t\t\t\t\tborrow_paused: true,\n\t\t\t\t\t\t\trepay_paused: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t],\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\tliquidity_pools::GenesisConfig::\u003cTest\u003e {\n\t\t\t\tpools: self.pools,\n\t\t\t\tpool_user_data: self.pool_user_data,\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\taccounts::GenesisConfig::\u003cTest\u003e {\n\t\t\t\tallowed_accounts: vec![(ADMIN, ())],\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\tminterest_model::GenesisConfig {\n\t\t\t\tminterest_model_dates: vec![\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t\t(\n\t\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\t],\n\t\t\t}\n\t\t\t.assimilate_storage(\u0026mut t)\n\t\t\t.unwrap();\n\n\t\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\t\text.execute_with(|| System::set_block_number(1));\n\t\t\text\n\t\t}\n\t}\n}\n","traces":[{"line":29,"address":[5265344,5265413],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[5457281],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[5265473],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[5265508],"length":1,"stats":{"Line":7},"fn_name":null},{"line":129,"address":[5265572],"length":1,"stats":{"Line":8},"fn_name":null},{"line":130,"address":[5265670,5265904,5266024],"length":1,"stats":{"Line":16},"fn_name":null},{"line":131,"address":[5265688],"length":1,"stats":{"Line":8},"fn_name":null},{"line":132,"address":[5265747],"length":1,"stats":{"Line":8},"fn_name":null},{"line":133,"address":[5265802],"length":1,"stats":{"Line":8},"fn_name":null},{"line":134,"address":[5265857],"length":1,"stats":{"Line":8},"fn_name":null},{"line":192,"address":[5448288],"length":1,"stats":{"Line":2},"fn_name":"admin"},{"line":193,"address":[5448294],"length":1,"stats":{"Line":2},"fn_name":null},{"line":195,"address":[5448352],"length":1,"stats":{"Line":1},"fn_name":"alice"},{"line":196,"address":[5448361],"length":1,"stats":{"Line":1},"fn_name":null},{"line":206,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":208,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":209,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":210,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":216,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":217,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":218,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":221,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":223,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":224,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":227,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":229,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":231,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":233,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":236,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":239,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":240,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":241,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":242,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":243,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":245,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":246,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":247,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":253,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":261,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":262,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":265,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":273,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":274,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":275,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":277,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":279,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":285,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":286,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":291,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":324,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":363,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":367,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":368,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":370,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":374,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":376,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":380,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":410,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":413,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":414,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":415,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":59,"coverable":81},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","controller_tests.rs"],"content":"///  Integration-tests for controller pallet.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t// Description of the scenario:\n\t// The user cannot disable collateral for a specific asset, if he does not have enough\n\t// collateral in other assets to cover all his borrowing:\n\t//\n\t// Alice has 60 DOT collateral and 40 ETH collateral, and she has 50 BTC borrowing.\n\t// Exchange rate for all assets equal 1.0.\n\t// 1. Alice can't disable DOT as collateral (because 40 ETH won't cover 50 BTC borrowing);\n\t// 2. Alice can disable ETH as collateral (because 60 DOT will cover 50 BTC borrowing);\n\t#[test]\n\tfn disable_collateral_internal_fails_if_not_cover_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.pool_initial(CurrencyId::DOT)\n\t\t\t.pool_initial(CurrencyId::BTC)\n\t\t\t.pool_initial(CurrencyId::ETH)\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::BTC, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::ETH, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// ALICE deposit 60 DOT, 50 BTC, 40 ETH.\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\talice(),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t60 * DOLLARS\n\t\t\t\t));\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\talice(),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t50 * DOLLARS\n\t\t\t\t));\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\talice(),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t40 * DOLLARS\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(11);\n\n\t\t\t\t// Alice enable her assets in pools as collateral.\n\t\t\t\tassert_ok!(MinterestProtocol::enable_as_collateral(alice(), CurrencyId::DOT));\n\t\t\t\tassert_ok!(MinterestProtocol::enable_as_collateral(alice(), CurrencyId::BTC));\n\t\t\t\tassert_ok!(MinterestProtocol::enable_as_collateral(alice(), CurrencyId::ETH));\n\n\t\t\t\tSystem::set_block_number(21);\n\n\t\t\t\t// Alice transfer her 50 MBTC to BOB.\n\t\t\t\tassert_ok!(Currencies::transfer(alice(), BOB, CurrencyId::MBTC, 50 * DOLLARS));\n\n\t\t\t\tSystem::set_block_number(31);\n\n\t\t\t\t// Alice borrow 50 BTC.\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(alice(), CurrencyId::BTC, 50 * DOLLARS));\n\n\t\t\t\tSystem::set_block_number(41);\n\n\t\t\t\t// Alice can't disable DOT as collateral (because ETH won't cover the borrowing).\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::disable_collateral(alice(), CurrencyId::DOT),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::CanotBeDisabledAsCollateral\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(51);\n\n\t\t\t\t// Alice can disable ETH as collateral (because DOT will cover the borrowing);\n\t\t\t\tassert_ok!(MinterestProtocol::disable_collateral(alice(), CurrencyId::ETH));\n\t\t\t});\n\t}\n\n\t// Extrinsic `set_insurance_factor`, description of scenario #2:\n\t// Pool insurance is increased if the insurance_factor is greater than zero.\n\t// 1. Alice deposit 40 DOT;\n\t// 2. Alice borrow 20 DOT;\n\t// 3. Set insurance factor equal 0.5.\n\t// 4. Alice repay full loan in DOTs, pool insurance increased.\n\t#[test]\n\tfn set_insurance_factor_greater_than_zero() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\talice_deposited_amount - alice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total insurance for DOT pool.\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, BALANCE_ZERO);\n\n\t\t\t\tSystem::set_block_number(10);\n\n\t\t\t\t// Set insurance factor equal 0.5.\n\t\t\t\tassert_ok!(TestController::set_insurance_factor(admin(), CurrencyId::DOT, 1, 2));\n\n\t\t\t\t// Alice repay full loan in DOTs.\n\t\t\t\tassert_ok!(MinterestProtocol::repay_all(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\tlet expected_interest_accumulated: Balance = 720_000_000_000_000;\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\talice_deposited_amount + expected_interest_accumulated\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tBALANCE_ZERO + (expected_interest_accumulated / 2)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `set_insurance_factor`, description of scenario #1:\n\t// Pool insurance does not increase if the insurance_factor is zero.\n\t// 1. Alice deposit 40 DOT;\n\t// 2. Alice borrow 20 DOT;\n\t// 3. Set insurance factor equal to zero.\n\t// 4. Alice repay full loan in DOTs, pool total_insurance = 0.\n\t#[test]\n\tfn set_insurance_factor_equal_zero() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\talice_deposited_amount - alice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total insurance for DOT pool.\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, BALANCE_ZERO);\n\n\t\t\t\tSystem::set_block_number(10);\n\n\t\t\t\t// Set insurance factor equal to zero.\n\t\t\t\tassert_ok!(TestController::set_insurance_factor(admin(), CurrencyId::DOT, 0, 1));\n\n\t\t\t\t// Alice repay full loan in DOTs.\n\t\t\t\tassert_ok!(MinterestProtocol::repay_all(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// Checking pool total insurance.\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, BALANCE_ZERO);\n\t\t\t});\n\t}\n}\n","traces":[{"line":17,"address":[5463653,5463648],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":18,"address":[4271207,4271133,4271244,4271516,4271170,4271095,4271608,4271424,4271304,4271364],"length":1,"stats":{"Line":10},"fn_name":null},{"line":19,"address":[4271125],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4271162],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4271199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4271236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4271296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[4271356],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[4271416],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4271508],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4271600],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[5463680,5463790],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":31,"address":[5463687,5463813,5463880],"length":1,"stats":{"Line":3},"fn_name":null},{"line":32,"address":[5463727],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[5463805],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[5464197,5464264],"length":1,"stats":{"Line":2},"fn_name":null},{"line":37,"address":[5464128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[5464189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[5464648,5464581],"length":1,"stats":{"Line":2},"fn_name":null},{"line":42,"address":[5464512],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[5464573],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[5464896],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[5464906],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[5465248],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[5465590],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[5465932],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[5468372,5465942],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[5466331],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[5466341,5468413],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[5466725],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[5466735,5466886],"length":1,"stats":{"Line":2},"fn_name":null},{"line":68,"address":[5466749],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[5466878],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[5467910],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[5467917],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[5468613,5468608],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":87,"address":[4271821,4271783,4271973,4271881],"length":1,"stats":{"Line":4},"fn_name":null},{"line":88,"address":[4271813],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[4271873],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4271965],"length":1,"stats":{"Line":1},"fn_name":null},{"line":92,"address":[5468640],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":94,"address":[5468657],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[5468743],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[5468682],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[5468735],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[5469042],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[5469062],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[5469148],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[5469087],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[5469140],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[5469744,5469589],"length":1,"stats":{"Line":1},"fn_name":null},{"line":113,"address":[5469447],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[5472220,5469504],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[5469695,5470037,5470180],"length":1,"stats":{"Line":2},"fn_name":null},{"line":119,"address":[5470150],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[5470473],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[5470848],"length":1,"stats":{"Line":1},"fn_name":null},{"line":127,"address":[5471200],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[5471494,5471339],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[5471220],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[5471274,5472250],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[5471757,5471838,5471960],"length":1,"stats":{"Line":2},"fn_name":null},{"line":135,"address":[5471445],"length":1,"stats":{"Line":1},"fn_name":null},{"line":136,"address":[5471782,5472280,5472310],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[4272112,4272134],"length":1,"stats":{"Line":3},"fn_name":"set_insurance_factor_equal_zero"},{"line":149,"address":[4272217,4272157,4272309,4272119],"length":1,"stats":{"Line":4},"fn_name":null},{"line":150,"address":[4272149],"length":1,"stats":{"Line":1},"fn_name":null},{"line":151,"address":[4272209],"length":1,"stats":{"Line":1},"fn_name":null},{"line":152,"address":[4272301],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[5472352],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":156,"address":[5472369],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[5472455],"length":1,"stats":{"Line":1},"fn_name":null},{"line":158,"address":[5472394],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[5472447],"length":1,"stats":{"Line":1},"fn_name":null},{"line":163,"address":[5472754],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[5472774],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[5472860],"length":1,"stats":{"Line":1},"fn_name":null},{"line":168,"address":[5472799],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[5472852],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[5473456,5473301],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[5473159],"length":1,"stats":{"Line":1},"fn_name":null},{"line":176,"address":[5475280,5473216,5475310],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[5473749,5473407,5473892],"length":1,"stats":{"Line":2},"fn_name":null},{"line":181,"address":[5473862],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[5474185],"length":1,"stats":{"Line":1},"fn_name":null},{"line":187,"address":[5474546],"length":1,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[5475020,5474864],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":87,"coverable":87},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","liquidity_pools_tests.rs"],"content":"///  Integration-tests for luquidity-pools pallet.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #1:\n\t#[test]\n\tfn get_exchange_rate_deposit_without_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after fn accrue_interest_rate called\n\t\t\t\tlet expected_amount_wrapped_tokens = 40_000 * DOLLARS;\n\t\t\t\tlet expected_exchange_rate_mock = Rate::one();\n\n\t\t\t\t// Checking if real exchange rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #2:\n\t#[test]\n\tfn get_exchange_rate_deposit_with_pool_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after fn accrue_interest_rate called\n\t\t\t\tlet expected_amount_wrapped_tokens = 40_000 * DOLLARS;\n\t\t\t\tlet expected_exchange_rate_mock = Rate::one();\n\n\t\t\t\t// Checking if real exchange rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #3:\n\t#[test]\n\tfn get_exchange_rate_deposit_and_borrow_without_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after fn accrue_interest_rate called\n\t\t\t\tlet expected_amount_wrapped_tokens = 40_000 * DOLLARS;\n\t\t\t\tlet expected_exchange_rate_mock = Rate::one();\n\n\t\t\t\t// Checking if real borrow interest rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #4:\n\t#[test]\n\tfn get_exchange_rate_deposit_and_borrow_with_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after fn accrue_interest_rate called\n\t\t\t\tlet expected_amount_wrapped_tokens = 40_000 * DOLLARS;\n\t\t\t\tlet expected_exchange_rate_mock = Rate::one();\n\n\t\t\t\t// Checking if real exchange rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock)\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Function `get_exchange_rate + calculate_exchange_rate` scenario #5:\n\t#[test]\n\tfn get_exchange_rate_few_deposits_and_borrows_with_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::DOT, BOB, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Bob deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Expected exchange rate based on params before fn accrue_interest_rate in block 4 called\n\t\t\t\tlet expected_exchange_rate_mock_block_number_3 = Rate::from_inner(1000000002025000000);\n\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock_block_number_3)\n\t\t\t\t);\n\n\t\t\t\t// Alice try to borrow from DOT pool\n\t\t\t\tlet bob_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Expected exchange rate \u0026\u0026 wrapped amount based on params after\n\t\t\t\t// fn accrue_interest_rate in block 4 called\n\t\t\t\tlet expected_amount_wrapped_tokens_alice = 40_000 * DOLLARS;\n\t\t\t\t// bob_deposited_amount/expected_exchange_rate_mock_block_number_3 = 59_999_999_878_500_000_246_037\n\t\t\t\tlet expected_amount_wrapped_tokens_bob = 59_999_999_878_500_000_246_037;\n\t\t\t\tlet expected_exchange_rate_mock_block_number_4 = Rate::from_inner(1000000002349000003);\n\n\t\t\t\t// Checking if real exchange rate \u0026\u0026 wrapped amount is equal to the expected\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_alice\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026BOB),\n\t\t\t\t\texpected_amount_wrapped_tokens_bob\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\t\tOk(expected_exchange_rate_mock_block_number_4)\n\t\t\t\t);\n\t\t\t});\n\t}\n}\n","traces":[{"line":10,"address":[4783728,4783733],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":11,"address":[5055405,5055465,5055367,5055557],"length":1,"stats":{"Line":4},"fn_name":null},{"line":12,"address":[5055397],"length":1,"stats":{"Line":1},"fn_name":null},{"line":13,"address":[5055457],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[5055549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":16,"address":[4783760],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":18,"address":[4783777],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[4783863],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4783802],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4783855],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[4784162],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4784192],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[4784291,4784437],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4784239],"length":1,"stats":{"Line":1},"fn_name":null},{"line":34,"address":[4784741,4784850],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[4784391],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4784705],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[4785120,4785125],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":44,"address":[5055741,5055801,5055893,5055703],"length":1,"stats":{"Line":4},"fn_name":null},{"line":45,"address":[5055733],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[5055793],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[5055885],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[4785152],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":51,"address":[4785169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4785255],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[4785194],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4785247],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[4785554],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[4785584],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4785829,4785683],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4785631],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[4786242,4786133],"length":1,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[4785783],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4786097],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4786512,4786517],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":77,"address":[5056229,5056077,5056137,5056039],"length":1,"stats":{"Line":4},"fn_name":null},{"line":78,"address":[5056069],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[5056129],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[5056221],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[4786544],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":84,"address":[4786561],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4786647],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[4786586],"length":1,"stats":{"Line":1},"fn_name":null},{"line":87,"address":[4786639],"length":1,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[4786946],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4786966],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[4787052],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[4786991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4787044],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4787351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":103,"address":[4787381],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[4787626,4787480],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[4787428],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[4788039,4787930],"length":1,"stats":{"Line":1},"fn_name":null},{"line":111,"address":[4787580],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[4787894],"length":1,"stats":{"Line":1},"fn_name":null},{"line":119,"address":[4788320,4788325],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":120,"address":[5056473,5056375,5056565,5056413],"length":1,"stats":{"Line":4},"fn_name":null},{"line":121,"address":[5056405],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[5056465],"length":1,"stats":{"Line":1},"fn_name":null},{"line":123,"address":[5056557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[4788352],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":127,"address":[4788369],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[4788455],"length":1,"stats":{"Line":1},"fn_name":null},{"line":129,"address":[4788394],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4788447],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[4788754],"length":1,"stats":{"Line":1},"fn_name":null},{"line":137,"address":[4788774],"length":1,"stats":{"Line":1},"fn_name":null},{"line":138,"address":[4788860],"length":1,"stats":{"Line":1},"fn_name":null},{"line":139,"address":[4788799],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[4788852],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[4789159],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[4789189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[4789288,4789434],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[4789236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[4789738,4789847],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[4789388],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[4789702],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[4790128,4790133],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":163,"address":[5056749,5056961,5056711,5056869,5057053,5056809],"length":1,"stats":{"Line":6},"fn_name":null},{"line":164,"address":[5056741],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[5056801],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[5056861],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[5056953],"length":1,"stats":{"Line":1},"fn_name":null},{"line":168,"address":[5057045],"length":1,"stats":{"Line":1},"fn_name":null},{"line":170,"address":[4790160],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":172,"address":[4790177],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[4790263],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[4790202],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[4790255],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[4790562],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[4790582],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[4790668],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[4790607],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[4790660],"length":1,"stats":{"Line":1},"fn_name":null},{"line":189,"address":[4790967],"length":1,"stats":{"Line":1},"fn_name":null},{"line":192,"address":[4790987],"length":1,"stats":{"Line":1},"fn_name":null},{"line":193,"address":[4791073],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[4791012],"length":1,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[4791065],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[4791372],"length":1,"stats":{"Line":1},"fn_name":null},{"line":202,"address":[4791382],"length":1,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[4791516,4791725],"length":1,"stats":{"Line":1},"fn_name":null},{"line":205,"address":[4791443],"length":1,"stats":{"Line":1},"fn_name":null},{"line":206,"address":[4791480],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4791634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[4792034],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[4791659],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[4792026],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[4792333],"length":1,"stats":{"Line":1},"fn_name":null},{"line":221,"address":[4792373],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[4792393],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[4792676,4792506],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[4792454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":229,"address":[4793129,4792977],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[4792612],"length":1,"stats":{"Line":1},"fn_name":null},{"line":233,"address":[4793542,4793433],"length":1,"stats":{"Line":1},"fn_name":null},{"line":234,"address":[4793080],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[4793397],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":119,"coverable":119},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","minterest_model_tests.rs"],"content":"//  Integration-tests for minterest model pallet.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #1:\n\t#[test]\n\tfn calculate_borrow_interest_rate_deposit_without_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit 40 DOT in pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 0 / (40_000 - 0 + 0) = 0 \u003c 0.8\n\t\t\t\t// borrow_rate = 0 * 0.000_000_009 + 0 = 0\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(Rate::zero(), borrow_rate);\n\t\t\t});\n\t}\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #2:\n\t#[test]\n\tfn calculate_borrow_interest_rate_deposit_with_pool_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit 40 DOT in pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 0 / (140_000 - 100_000 + 0) = 0 \u003c 0.8\n\t\t\t\t// borrow_rate = 0 * 0.000_000_009 + 0 = 0\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(Rate::zero(), borrow_rate);\n\t\t\t});\n\t}\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #3:\n\t#[test]\n\tfn calculate_borrow_interest_rate_deposit_and_borrow_without_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 20_000 / (20_000 - 0 + 20_000) = 0.5 \u003c kink = 0.8\n\t\t\t\t// borrow_rate = 0.5 * 0.000_000_009 + 0 = 45 * 10^(-10)\n\t\t\t\tlet expected_borrow_rate_mock = Rate::saturating_from_rational(45_u128, 10_000_000_000_u128);\n\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(expected_borrow_rate_mock, borrow_rate);\n\t\t\t});\n\t}\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #4:\n\t#[test]\n\tfn calculate_borrow_interest_rate_deposit_and_borrow_with_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 20_000 / (120_000 - 100_000 + 20_000) = 0.5 \u003c kink = 0.8\n\t\t\t\t// borrow_rate = 0.5 * 0.000_000_009 + 0 = 45 * 10^(-10)\n\t\t\t\tlet expected_borrow_rate_mock = Rate::saturating_from_rational(45_u128, 10_000_000_000_u128);\n\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(expected_borrow_rate_mock, borrow_rate);\n\t\t\t});\n\t}\n\n\t// Function `calculate_borrow_interest_rate + calculate_utilization_rate` scenario #5:\n\t#[test]\n\tfn calculate_borrow_interest_rate_few_deposits_and_borrows_with_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::DOT, BOB, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Bob deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice try to borrow from DOT pool\n\t\t\t\tlet bob_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// utilization_rate = 70_000 / (130_000 - 100_000 + 70_000) = 0.7 \u003c kink = 0.8\n\t\t\t\t// borrow_rate = 0.7 * 0.000_000_009 + 0 = 63 * 10^(-10) + accumulated_borrow\n\t\t\t\tlet expected_borrow_rate_mock = Rate::from_inner(6_300_000_004);\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\n\t\t\t\t// Checking if real borrow interest rate is equal to the expected\n\t\t\t\tassert_eq!(expected_borrow_rate_mock, borrow_rate);\n\t\t\t});\n\t}\n}\n","traces":[{"line":10,"address":[4486021,4486016],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":11,"address":[5057289,5057229,5057381,5057191],"length":1,"stats":{"Line":4},"fn_name":null},{"line":12,"address":[5057221],"length":1,"stats":{"Line":1},"fn_name":null},{"line":13,"address":[5057281],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[5057373],"length":1,"stats":{"Line":1},"fn_name":null},{"line":16,"address":[4486048],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":18,"address":[4486065],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[4486151],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4486090],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4486143],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4486507],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[4486426],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4486528,4486665],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[4486949,4486944],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":38,"address":[5057625,5057717,5057565,5057527],"length":1,"stats":{"Line":4},"fn_name":null},{"line":39,"address":[5057557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[5057617],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[5057709],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[4486976],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":45,"address":[4486993],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[4487079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4487018],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[4487071],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4487435],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[4487354],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[4487456,4487593],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4487877,4487872],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":65,"address":[5057863,5057901,5057961,5058053],"length":1,"stats":{"Line":4},"fn_name":null},{"line":66,"address":[5057893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[5057953],"length":1,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[5058045],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[4487904],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":72,"address":[4487921],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[4488007],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4487946],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4487999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[4488306],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[4488326],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[4488412],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[4488351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4488404],"length":1,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[4488706],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[4488811],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4488730],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4488832,4488941],"length":1,"stats":{"Line":1},"fn_name":null},{"line":103,"address":[4489216,4489221],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":104,"address":[5058199,5058237,5058389,5058297],"length":1,"stats":{"Line":4},"fn_name":null},{"line":105,"address":[5058229],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[5058289],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[5058381],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[4489248],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":111,"address":[4489265],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[4489351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":113,"address":[4489290],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[4489343],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[4489650],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[4489670],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[4489756],"length":1,"stats":{"Line":1},"fn_name":null},{"line":123,"address":[4489695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[4489748],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4490050],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[4490155],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[4490074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":136,"address":[4490176,4490285],"length":1,"stats":{"Line":1},"fn_name":null},{"line":142,"address":[4490565,4490560],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":143,"address":[5058693,5058785,5058535,5058877,5058573,5058633],"length":1,"stats":{"Line":6},"fn_name":null},{"line":144,"address":[5058565],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[5058625],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[5058685],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[5058777],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[5058869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[4490592],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":152,"address":[4490609],"length":1,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[4490695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[4490634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[4490687],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[4490994],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[4491014],"length":1,"stats":{"Line":1},"fn_name":null},{"line":163,"address":[4491100],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[4491039],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[4491092],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[4491399],"length":1,"stats":{"Line":1},"fn_name":null},{"line":172,"address":[4491419],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[4491505],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[4491444],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[4491497],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[4491804],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[4491824],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[4491910],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[4491849],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[4491902],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[4492185],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[4492305],"length":1,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[4492224],"length":1,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[4492326,4492435],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":95,"coverable":95},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","minterest_protocol_tests.rs"],"content":"///  Integration-tests for minterest protocol pallet.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t#[test]\n\tfn deposit_underlying_with_supplied_insurance_should_work() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// Calculate expected amount of wrapped tokens for Alice\n\t\t\t\tlet alice_expected_amount_wrapped_tokens =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount).unwrap();\n\n\t\t\t\t// Checking pool available liquidity increased by 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount\n\t\t\t\t);\n\n\t\t\t\t// Checking current free balance for DOT \u0026\u0026 MDOT\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_expected_amount_wrapped_tokens\n\t\t\t\t);\n\n\t\t\t\t// Checking current total insurance\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, ONE_HUNDRED);\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount = ONE_HUNDRED;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount\n\t\t\t\t));\n\n\t\t\t\t// Calculate expected amount of wrapped tokens for Bob\n\t\t\t\tlet bob_expected_amount_wrapped_tokens =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, bob_deposited_amount).unwrap();\n\n\t\t\t\t// Checking pool available liquidity increased by 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount + bob_deposited_amount\n\t\t\t\t);\n\n\t\t\t\t// Checking current free balance for DOT \u0026\u0026 MDOT\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), 40_000 * DOLLARS);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED - bob_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_expected_amount_wrapped_tokens\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026BOB),\n\t\t\t\t\tbob_expected_amount_wrapped_tokens\n\t\t\t\t);\n\n\t\t\t\t// Checking current total insurance\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_insurance, ONE_HUNDRED);\n\t\t\t});\n\t}\n\n\t#[test]\n\tfn deposit_underlying_overflow_while_convert_underline_to_wrap_should_work() {\n\t\tExtBuilder::default()\n\t\t\t// Set genesis to get exchange rate 0,00000000000000001\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::MDOT, DOLLARS)\n\t\t\t.pool_initial(CurrencyId::DOT)\n\t\t\t.pool_balance(CurrencyId::DOT, 5)\n\t\t\t.pool_total_borrowed(CurrencyId::DOT, 5)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice try to deposit ONE_HUNDRED to DOT pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::deposit_underlying(Origin::signed(ALICE), CurrencyId::DOT, ONE_HUNDRED),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::NumOverflow\n\t\t\t\t);\n\n\t\t\t\t// Alice deposit to DOT pool.\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t100\n\t\t\t\t));\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem_underlying`, description of scenario #1:\n\t// The user The user tries to redeem all assets in the first currency. He has loan in the first\n\t// currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 60 DOT;\n\t// 2. Alice deposit 50 ETH;\n\t// 3. Alice borrow 50 DOT;\n\t// 4. Alice can't `redeem_underlying` 60 DOT: 50 ETH * 0.9 collateral \u003c 50 DOT borrow;\n\t// 5. Alice deposit 10 ETH;\n\t// 6. Alice `redeem_underlying` 60 DOT;\n\t// 7. Alice can't `redeem_underlying` 60 ETH.\n\t#[test]\n\tfn redeem_underlying_with_current_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::ETH, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit 60 DOT to pool.\n\t\t\t\tlet alice_deposited_amount_in_dot = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit 50 ETH to pool.\n\t\t\t\tlet alice_deposited_amount_in_eth = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_deposited_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount_in_dot - alice_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\t// Checking Alice's free balance DOT \u0026\u0026 MDOT.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_eth\n\t\t\t\t);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_dot =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_dot).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_dot\n\t\t\t\t);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_eth =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_eth).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::METH, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Checking total borrow for Alice DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice try to redeem all from DOT pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice add liquidity to ETH pool\n\t\t\t\tlet alice_deposited_amount_in_eth_secondary = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_deposited_amount_in_eth_secondary\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(6);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tlet expected_amount_redeemed_underlying_assets = 60000019601999999880000;\n\t\t\t\tassert_ok!(MinterestProtocol::redeem_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\texpected_amount_redeemed_underlying_assets\n\t\t\t\t));\n\n\t\t\t\t// Checking free balance DOT/MDOT \u0026\u0026 ETH/METH for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t\t\t+ alice_borrowed_amount_in_dot\n\t\t\t\t\t\t+ expected_amount_redeemed_underlying_assets\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_eth - alice_deposited_amount_in_eth_secondary\n\t\t\t\t);\n\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE), 0);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_eth_summary = expected_amount_wrapped_tokens_in_eth\n\t\t\t\t\t+ TestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_eth_secondary).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::METH, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_eth_summary\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for DOT pool\n\t\t\t\tlet expected_borrow_interest_accumulated = 21779999999850000;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot + expected_borrow_interest_accumulated\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(7);\n\n\t\t\t\t// Alice try to redeem all from ETH pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\t\talice_deposited_amount_in_eth + alice_deposited_amount_in_eth_secondary\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem_underlying`, description of scenario #2:\n\t// The user tries to redeem all assets in the first currency. He has loan in the second currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 60 DOT;\n\t// 2. Alice borrow 50 ETH;\n\t// 3. Alice can't `redeem` 60 DOT: 0 DOT collateral \u003c 50 ETH borrow;\n\t#[test]\n\tfn redeem_underlying_with_another_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount_in_eth = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// // Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH for user.\n\t\t\t\t// Expected previously values\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem_underlying`, description of scenario #3:\n\t// The user tries to redeem all assets in the first currency. He has loan in the second\n\t// currency and deposit in the third currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 40 DOT;\n\t// 2. Alice deposit 40 BTC;\n\t// 3. Alice borrow 70 ETH;\n\t// 4. Alice can't `redeem_underlying` 40 DOT;\n\t// 5. Alice deposit 40 BTC;\n\t// 6. Alice redeem 40 DOT;\n\t// 7. Alice can't `redeem_underlying` 40 BTC;\n\t#[test]\n\tfn redeem_underlying_with_third_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::BTC, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit to BTC pool\n\t\t\t\tlet alice_deposited_amount_in_btc = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\talice_deposited_amount_in_btc\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount_in_eth = 70_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_btc\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Alice try to redeem all DOTs\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice add liquidity to BTC pool\n\t\t\t\tlet alice_deposited_amount_in_btc_secondary = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\talice_deposited_amount_in_btc_secondary\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(6);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tlet alice_current_balance_amount_in_m_dot = Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE);\n\t\t\t\tlet alice_redeemed_amount_in_dot =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_current_balance_amount_in_m_dot).unwrap();\n\t\t\t\tassert_ok!(MinterestProtocol::redeem_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_redeemed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\talice_deposited_amount_in_dot - alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_btc - alice_deposited_amount_in_btc_secondary\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(7);\n\n\t\t\t\t// Alice try to redeem all BTC.\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem_underlying(\n\t\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\t\talice_deposited_amount_in_btc_secondary\n\t\t\t\t\t),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem_underlying`, description of scenario #4:\n\t// It is possible to redeem assets from the pool insurance.\n\t// 1. Deposit 10 DOT to pool insurance;\n\t// 2. Alice deposit 20 DOT;\n\t// 3. Bob deposit 20 BTC;\n\t// 4. Bob deposit 10 DOT;\n\t// 5. Bob borrow 15 DOT;\n\t// 6. Alice redeem 20 DOT;\n\t// 7. DOT pool insurance equal 5 DOT;\n\t#[test]\n\tfn redeem_underlying_over_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::BTC, BOB, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, 10_000 * DOLLARS)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Bob deposit to BTC pool\n\t\t\t\tlet bob_deposited_amount_in_btc = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tbob_deposited_amount_in_btc\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Bob borrow from DOT pool\n\t\t\t\tlet bob_borrowed_amount_in_dot = 15_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Bob deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount_in_dot = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice redeem all DOTs.\n\t\t\t\tlet alice_current_balance_amount_in_m_dot = Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE);\n\t\t\t\t// Expected exchange rate 1000000006581250024\n\t\t\t\tlet alice_redeemed_amount_in_dot =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_current_balance_amount_in_m_dot).unwrap();\n\t\t\t\tassert_ok!(MinterestProtocol::redeem_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_redeemed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\t10_000 * DOLLARS + alice_deposited_amount_in_dot - alice_redeemed_amount_in_dot\n\t\t\t\t\t\t+ bob_deposited_amount_in_dot\n\t\t\t\t\t\t- bob_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED + bob_borrowed_amount_in_dot - bob_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED - bob_deposited_amount_in_btc\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem`, description of scenario #1:\n\t// The user tries to redeem all assets in the first currency. He has loan in the first currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 60 DOT;\n\t// 2. Alice deposit 50 ETH;\n\t// 3. Alice borrow 50 DOT;\n\t// 4. Alice can't `redeem` 60 DOT: 10 DOT * 0.9 + 50 ETH * 0.9 collateral \u003c 60 DOT redeem;\n\t// 5. Alice deposit 10 ETH;\n\t// 6. Alice `redeem` 60 DOT;\n\t// 7. Alice can't `redeem` 60 ETH.\n\t#[test]\n\tfn redeem_with_current_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, 100_000_000 * DOLLARS)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::ETH, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit to ETH pool\n\t\t\t\tlet alice_deposited_amount_in_eth = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_deposited_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount_in_dot - alice_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT in pool.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_eth\n\t\t\t\t);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_dot =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_dot).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_dot\n\t\t\t\t);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_eth =\n\t\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, alice_deposited_amount_in_eth).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::METH, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Checking total borrow for Alice DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice try to redeem all from DOT pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice add liquidity to ETH pool\n\t\t\t\tlet alice_deposited_amount_in_eth_secondary = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_deposited_amount_in_eth_secondary\n\t\t\t\t));\n\n\t\t\t\t// Bob add liquidity to ETH pool\n\t\t\t\tlet bob_deposited_amount_in_dot = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(6);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tassert_ok!(MinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// Checking free balance DOT/MDOT \u0026\u0026 ETH/METH in pool.\n\t\t\t\t// current_exchange_rate == 1000000221932654817\n\t\t\t\tlet expected_amount_redeemed_underlying_assets = 60000013315959289020000;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t\t\t+ alice_borrowed_amount_in_dot\n\t\t\t\t\t\t+ expected_amount_redeemed_underlying_assets\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_eth - alice_deposited_amount_in_eth_secondary\n\t\t\t\t);\n\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE), 0);\n\t\t\t\tlet expected_amount_wrapped_tokens_in_eth_summary = expected_amount_wrapped_tokens_in_eth\n\t\t\t\t\t+ TestPools::convert_to_wrapped(CurrencyId::ETH, alice_deposited_amount_in_eth_secondary).unwrap();\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::METH, \u0026ALICE),\n\t\t\t\t\texpected_amount_wrapped_tokens_in_eth_summary\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice DOT pool\n\t\t\t\tlet expected_amount_accumulated_in_dot = 14841428697992866;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for DOT pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_dot + expected_amount_accumulated_in_dot\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(7);\n\n\t\t\t\t// Alice try to redeem all from ETH pool\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::ETH),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem`, description of scenario #2:\n\t// The user tries to redeem all assets in the first currency. He has loan in the second currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 60 DOT;\n\t// 2. Alice borrow 50 ETH;\n\t// 3. Alice can't `redeem` 60 DOT: 0 DOT collateral \u003c 50 ETH borrow;\n\t#[test]\n\tfn redeem_with_another_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount_in_eth = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// // Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH for user.\n\t\t\t\t// Expected previously values\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem`, description of scenario #3:\n\t// The user tries to redeem all assets in the first currency. He has loan in the second\n\t// currency and deposit in the third currency.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 40 DOT;\n\t// 2. Alice deposit 40 BTC;\n\t// 3. Alice borrow 70 ETH;\n\t// 4. Alice can't `redeem` 40 DOT: (40 BTC * 0.9) collateral \u003c 70 ETH borrow;\n\t// 5. Alice deposit 40 BTC;\n\t// 6. Alice redeem 40 DOT: (80 BTC * 0.9) collateral \u003e 70 EHT borrow;\n\t// 7. Alice can't `redeem` 40 BTC: (40 BTC * 0.9) collateral \u003c 70 ETH borrow;\n\t#[test]\n\tfn redeem_with_third_currency_borrowing() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_user_data(CurrencyId::BTC, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice deposit to BTC pool\n\t\t\t\tlet alice_deposited_amount_in_btc = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\talice_deposited_amount_in_btc\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Alice borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount_in_eth = 70_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t));\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_btc\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice try to redeem all DOTs\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// Alice add liquidity to BTC pool\n\t\t\t\tlet alice_deposited_amount_in_btc_secondary = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\talice_deposited_amount_in_btc_secondary\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(6);\n\n\t\t\t\t// Alice redeem all DOTs\n\t\t\t\tlet alice_current_balance_amount_in_m_dot = Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE);\n\t\t\t\tlet alice_redeemed_amount_in_dot =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_current_balance_amount_in_m_dot).unwrap();\n\t\t\t\tassert_ok!(MinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 ETH \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_btc - alice_deposited_amount_in_btc_secondary\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::ETH, \u0026ALICE),\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for Alice ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\t\t\t\t// Checking total borrow for ETH pool\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::ETH).total_borrowed,\n\t\t\t\t\talice_borrowed_amount_in_eth\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(7);\n\n\t\t\t\t// Alice try to redeem all BTC.\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::BTC),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::RedeemControllerRejection\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `redeem`, description of scenario #4:\n\t// It is possible to redeem assets from the pool insurance.\n\t// 1. Deposit 10 DOT to pool insurance;\n\t// 2. Alice deposit 20 DOT;\n\t// 3. Bob deposit 20 BTC;\n\t// 4. Bob deposit 10 DOT;\n\t// 5. Bob borrow 15 DOT;\n\t// 6. Alice redeem 20 DOT, pool insurance equal 5 DOT;\n\t#[test]\n\tfn redeem_over_insurance() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(BOB, CurrencyId::BTC, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::DOT, BOB, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_user_data(CurrencyId::BTC, BOB, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_balance(CurrencyId::DOT, BALANCE_ZERO)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, 10_000 * DOLLARS)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount_in_dot = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Bob deposit to BTC pool\n\t\t\t\tlet bob_deposited_amount_in_btc = 20_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tbob_deposited_amount_in_btc\n\t\t\t\t));\n\n\t\t\t\t// Bob deposit to DOT pool\n\t\t\t\tlet bob_deposited_amount_in_dot = 10_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_deposited_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// Bob borrow from DOT pool\n\t\t\t\tlet bob_borrowed_amount_in_dot = 15_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(BOB),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tbob_borrowed_amount_in_dot\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// Alice redeem all DOTs.\n\t\t\t\tlet alice_current_balance_amount_in_m_dot = Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE);\n\n\t\t\t\tassert_ok!(MinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\tlet alice_redeemed_amount_in_dot =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_current_balance_amount_in_m_dot).unwrap();\n\n\t\t\t\t// Checking pool available liquidity.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\t10_000 * DOLLARS + alice_deposited_amount_in_dot - alice_redeemed_amount_in_dot\n\t\t\t\t\t\t+ bob_deposited_amount_in_dot\n\t\t\t\t\t\t- bob_borrowed_amount_in_dot\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 BTC for user.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount_in_dot + alice_redeemed_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED + bob_borrowed_amount_in_dot - bob_deposited_amount_in_dot\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::BTC, \u0026BOB),\n\t\t\t\t\tONE_HUNDRED - bob_deposited_amount_in_btc\n\t\t\t\t);\n\t\t\t});\n\t}\n\n\t// Extrinsic `borrow`, description of scenario #1:\n\t// The user cannot borrow without making a deposit first.\n\t// 1. Alice can't borrow 50 DOT: 0 collateral \u003c 50 DOT borrow;\n\t#[test]\n\tfn borrow_with_insufficient_collateral_no_deposits() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice try to borrow from DOT pool\n\t\t\t\tlet alice_borrowed_amount_in_dot = 50_000 * DOLLARS;\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::borrow(Origin::signed(ALICE), CurrencyId::DOT, alice_borrowed_amount_in_dot),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::BorrowControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), ONE_HUNDRED);\n\t\t\t});\n\t}\n\n\t// Extrinsic `borrow`, description of scenario #2:\n\t// The user cannot borrow in the second currency unless he has\n\t// not enabled the first currency as collateral.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 50 DOT;\n\t// 2. Alice can't borrow 50 ETH: 0 collateral \u003c 50 ETH borrow;\n\t#[test]\n\tfn borrow_without_collateral_in_second_currency() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, false)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice try to borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::borrow(Origin::signed(ALICE), CurrencyId::ETH, alice_borrowed_amount),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::BorrowControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::ETH), ONE_HUNDRED);\n\t\t\t});\n\t}\n\n\t// Extrinsic `borrow`, description of scenario #3:\n\t// The user cannot borrow in the second currency if the collateral in the first currency\n\t// is insufficient.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 50 DOT;\n\t// 2. Alice can't borrow 50 ETH: 50 DOT * 0.9 collateral \u003c 50 ETH borrow;\n\t#[test]\n\tfn borrow_with_insufficient_collateral_in_second_currency() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice try to borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_noop!(\n\t\t\t\t\tMinterestProtocol::borrow(Origin::signed(ALICE), CurrencyId::ETH, alice_borrowed_amount),\n\t\t\t\t\tMinterestProtocolError::\u003cTest\u003e::BorrowControllerRejection\n\t\t\t\t);\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::ETH), ONE_HUNDRED);\n\t\t\t});\n\t}\n\n\t// Extrinsic `borrow`, description of scenario #4:\n\t// The user can borrow in the second currency if the collateral in the first currency\n\t// is sufficient.\n\t// Initial exchange rate for all assets equal 1.0;\n\t// Collateral factor for all assets equal 0.9;\n\t// 1. Alice deposit 50 DOT;\n\t// 2. Alice can borrow 40 ETH: 50 DOT * 0.9 collateral \u003e 40 ETH borrow;\n\t#[test]\n\tfn borrow_with_sufficient_collateral_in_second_currency() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_total_insurance(CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_total_insurance(CurrencyId::ETH, ONE_HUNDRED)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// Alice deposit to DOT pool\n\t\t\t\tlet alice_deposited_amount = 50_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposited_amount\n\t\t\t\t));\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// Alice try to borrow from ETH pool\n\t\t\t\tlet alice_borrowed_amount = 40_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\talice_borrowed_amount\n\t\t\t\t));\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tONE_HUNDRED + alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::ETH),\n\t\t\t\t\tONE_HUNDRED - alice_borrowed_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\tONE_HUNDRED - alice_deposited_amount\n\t\t\t\t);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::ETH, \u0026ALICE), alice_borrowed_amount);\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::ETH).total_borrowed, alice_borrowed_amount);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::ETH, \u0026ALICE).total_borrowed,\n\t\t\t\t\talice_borrowed_amount\n\t\t\t\t);\n\t\t\t});\n\t}\n}\n","traces":[{"line":9,"address":[4479136,4479158],"length":1,"stats":{"Line":3},"fn_name":"deposit_underlying_with_supplied_insurance_should_work"},{"line":10,"address":[4479393,4479301,4479181,4479143,4479241],"length":1,"stats":{"Line":5},"fn_name":null},{"line":11,"address":[4479173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":12,"address":[4479233],"length":1,"stats":{"Line":1},"fn_name":null},{"line":13,"address":[4479293],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[4479385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":16,"address":[4793856],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":18,"address":[4793873],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[4793959],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4793898],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4793951],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4794258],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[4794459,4794629],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4794340],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4799789,4794394],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4795197,4795027],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[4794565],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[4794942,4799819],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[4795498,4795653],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[4795133],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[4795946,4795604,4796089],"length":1,"stats":{"Line":2},"fn_name":null},{"line":48,"address":[4796059],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[4796392],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4796478],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[4796417],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4796470],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[4796777],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4797214,4797044],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4796859],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[4799849,4796913],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4797150,4797684,4797515],"length":1,"stats":{"Line":2},"fn_name":null},{"line":70,"address":[4798224,4798054],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[4797620],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4799909,4797983,4799939],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4798695,4798525],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4798160],"length":1,"stats":{"Line":1},"fn_name":null},{"line":78,"address":[4798996,4799142],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[4798631],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[4799096,4799529,4799402],"length":1,"stats":{"Line":2},"fn_name":null},{"line":89,"address":[4479520,4479542],"length":1,"stats":{"Line":3},"fn_name":"deposit_underlying_overflow_while_convert_underline_to_wrap_should_work"},{"line":90,"address":[4479684,4479721,4479770,4479625,4479565,4479527],"length":1,"stats":{"Line":6},"fn_name":null},{"line":92,"address":[4479557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[4479617],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4479676],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[4479713],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[4479762],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[4799984,4800007],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":100,"address":[4800180,4799991],"length":1,"stats":{"Line":2},"fn_name":null},{"line":101,"address":[4800027],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4800172],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[4801271],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[4801204],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[4801263],"length":1,"stats":{"Line":1},"fn_name":null},{"line":127,"address":[4479926,4479904],"length":1,"stats":{"Line":3},"fn_name":"redeem_underlying_with_current_currency_borrowing"},{"line":128,"address":[4480161,4479911,4480253,4480009,4479949,4480069],"length":1,"stats":{"Line":6},"fn_name":null},{"line":129,"address":[4479941],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4480001],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[4480061],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[4480153],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[4480245],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[4801743,4801632],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":137,"address":[4801645],"length":1,"stats":{"Line":1},"fn_name":null},{"line":138,"address":[4801766],"length":1,"stats":{"Line":1},"fn_name":null},{"line":139,"address":[4801688],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[4801758],"length":1,"stats":{"Line":1},"fn_name":null},{"line":144,"address":[4802065],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[4802085],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[4802171],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[4802110],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[4802163],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[4802470],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[4802480],"length":1,"stats":{"Line":1},"fn_name":null},{"line":158,"address":[4802592],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[4802515],"length":1,"stats":{"Line":1},"fn_name":null},{"line":160,"address":[4802568],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[4802576],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[4803065,4803235],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[4802875],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[4814170,4802929],"length":1,"stats":{"Line":1},"fn_name":null},{"line":171,"address":[4803704,4803874],"length":1,"stats":{"Line":1},"fn_name":null},{"line":172,"address":[4803171],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[4803548,4814230],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[4804272,4804444],"length":1,"stats":{"Line":1},"fn_name":null},{"line":176,"address":[4803810],"length":1,"stats":{"Line":1},"fn_name":null},{"line":177,"address":[4814290,4804187],"length":1,"stats":{"Line":1},"fn_name":null},{"line":180,"address":[4804378,4804737],"length":1,"stats":{"Line":2},"fn_name":null},{"line":181,"address":[4804997,4804825],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[4804773],"length":1,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[4804931,4805290],"length":1,"stats":{"Line":2},"fn_name":null},{"line":187,"address":[4805378,4805538],"length":1,"stats":{"Line":1},"fn_name":null},{"line":188,"address":[4805326],"length":1,"stats":{"Line":1},"fn_name":null},{"line":193,"address":[4805839,4805994],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[4805484],"length":1,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[4806295,4806431],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[4805945],"length":1,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[4806401],"length":1,"stats":{"Line":1},"fn_name":null},{"line":206,"address":[4806896,4806724],"length":1,"stats":{"Line":2},"fn_name":null},{"line":207,"address":[4806822],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[4806743],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[4806814],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[4806888],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[4807980],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[4807997],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[4808101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":220,"address":[4808022],"length":1,"stats":{"Line":1},"fn_name":null},{"line":221,"address":[4808093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[4808383],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[4808400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":229,"address":[4808504],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[4808425],"length":1,"stats":{"Line":1},"fn_name":null},{"line":231,"address":[4808496],"length":1,"stats":{"Line":1},"fn_name":null},{"line":236,"address":[4809264,4809101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":237,"address":[4808781],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[4808948,4808879,4814362],"length":1,"stats":{"Line":2},"fn_name":null},{"line":239,"address":[4808924],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[4809828,4809991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":243,"address":[4809207,4809633],"length":1,"stats":{"Line":2},"fn_name":null},{"line":244,"address":[4809677,4814452],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[4810590,4809934,4810360],"length":1,"stats":{"Line":2},"fn_name":null},{"line":248,"address":[4810497,4811005,4814518],"length":1,"stats":{"Line":2},"fn_name":null},{"line":249,"address":[4810951,4810513],"length":1,"stats":{"Line":2},"fn_name":null},{"line":250,"address":[4811331,4811178],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[4811092],"length":1,"stats":{"Line":1},"fn_name":null},{"line":255,"address":[4811878,4811700],"length":1,"stats":{"Line":1},"fn_name":null},{"line":256,"address":[4811284],"length":1,"stats":{"Line":1},"fn_name":null},{"line":260,"address":[4811816],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[4812361,4812492],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[4811836],"length":1,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[4814551,4812247],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[4812474],"length":1,"stats":{"Line":1},"fn_name":null},{"line":269,"address":[4812853,4813099],"length":1,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[4813028],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[4812877],"length":1,"stats":{"Line":1},"fn_name":null},{"line":272,"address":[4812948],"length":1,"stats":{"Line":1},"fn_name":null},{"line":273,"address":[4812981,4814604],"length":1,"stats":{"Line":1},"fn_name":null},{"line":275,"address":[4813091],"length":1,"stats":{"Line":1},"fn_name":null},{"line":288,"address":[4480406,4480384],"length":1,"stats":{"Line":3},"fn_name":"redeem_underlying_with_another_currency_borrowing"},{"line":289,"address":[4480489,4480642,4480697,4480391,4480429,4480581],"length":1,"stats":{"Line":6},"fn_name":null},{"line":290,"address":[4480421],"length":1,"stats":{"Line":1},"fn_name":null},{"line":291,"address":[4480481],"length":1,"stats":{"Line":1},"fn_name":null},{"line":292,"address":[4480573],"length":1,"stats":{"Line":1},"fn_name":null},{"line":293,"address":[4480634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":294,"address":[4480689],"length":1,"stats":{"Line":1},"fn_name":null},{"line":296,"address":[4814817,4814720],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":298,"address":[4814737],"length":1,"stats":{"Line":1},"fn_name":null},{"line":299,"address":[4814840],"length":1,"stats":{"Line":1},"fn_name":null},{"line":300,"address":[4814762],"length":1,"stats":{"Line":1},"fn_name":null},{"line":301,"address":[4814832],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[4815139],"length":1,"stats":{"Line":1},"fn_name":null},{"line":308,"address":[4815149],"length":1,"stats":{"Line":1},"fn_name":null},{"line":309,"address":[4815261],"length":1,"stats":{"Line":1},"fn_name":null},{"line":310,"address":[4815184],"length":1,"stats":{"Line":1},"fn_name":null},{"line":311,"address":[4815237],"length":1,"stats":{"Line":1},"fn_name":null},{"line":312,"address":[4815245],"length":1,"stats":{"Line":1},"fn_name":null},{"line":316,"address":[4815693,4815863],"length":1,"stats":{"Line":1},"fn_name":null},{"line":317,"address":[4815544],"length":1,"stats":{"Line":1},"fn_name":null},{"line":318,"address":[4815608,4820956],"length":1,"stats":{"Line":1},"fn_name":null},{"line":320,"address":[4816324,4816164],"length":1,"stats":{"Line":1},"fn_name":null},{"line":321,"address":[4815799],"length":1,"stats":{"Line":1},"fn_name":null},{"line":325,"address":[4816625,4816780],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[4816270],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[4817081,4817217],"length":1,"stats":{"Line":1},"fn_name":null},{"line":331,"address":[4816731],"length":1,"stats":{"Line":1},"fn_name":null},{"line":335,"address":[4817187],"length":1,"stats":{"Line":1},"fn_name":null},{"line":338,"address":[4817510,4817682],"length":1,"stats":{"Line":2},"fn_name":null},{"line":339,"address":[4817608],"length":1,"stats":{"Line":1},"fn_name":null},{"line":340,"address":[4817529],"length":1,"stats":{"Line":1},"fn_name":null},{"line":341,"address":[4817600],"length":1,"stats":{"Line":1},"fn_name":null},{"line":344,"address":[4817674],"length":1,"stats":{"Line":1},"fn_name":null},{"line":349,"address":[4818944,4819107],"length":1,"stats":{"Line":1},"fn_name":null},{"line":350,"address":[4818761],"length":1,"stats":{"Line":1},"fn_name":null},{"line":351,"address":[4821058,4818859,4821028],"length":1,"stats":{"Line":1},"fn_name":null},{"line":353,"address":[4819661,4819508],"length":1,"stats":{"Line":1},"fn_name":null},{"line":354,"address":[4819050,4819476],"length":1,"stats":{"Line":2},"fn_name":null},{"line":359,"address":[4820178,4820030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":360,"address":[4819614],"length":1,"stats":{"Line":1},"fn_name":null},{"line":364,"address":[4820641,4820517],"length":1,"stats":{"Line":1},"fn_name":null},{"line":365,"address":[4820136],"length":1,"stats":{"Line":1},"fn_name":null},{"line":384,"address":[4480832,4480854],"length":1,"stats":{"Line":3},"fn_name":"redeem_underlying_with_third_currency_borrowing"},{"line":385,"address":[4480877,4481242,4481181,4481089,4480997,4480839,4480937],"length":1,"stats":{"Line":7},"fn_name":null},{"line":386,"address":[4480869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":387,"address":[4480929],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[4480989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":389,"address":[4481081],"length":1,"stats":{"Line":1},"fn_name":null},{"line":390,"address":[4481173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":391,"address":[4481234],"length":1,"stats":{"Line":1},"fn_name":null},{"line":393,"address":[4821104,4821207],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":395,"address":[4821127],"length":1,"stats":{"Line":1},"fn_name":null},{"line":396,"address":[4821230],"length":1,"stats":{"Line":1},"fn_name":null},{"line":397,"address":[4821152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":398,"address":[4821222],"length":1,"stats":{"Line":1},"fn_name":null},{"line":402,"address":[4821529],"length":1,"stats":{"Line":1},"fn_name":null},{"line":405,"address":[4821549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":406,"address":[4821635],"length":1,"stats":{"Line":1},"fn_name":null},{"line":407,"address":[4821574],"length":1,"stats":{"Line":1},"fn_name":null},{"line":408,"address":[4821627],"length":1,"stats":{"Line":1},"fn_name":null},{"line":412,"address":[4821934],"length":1,"stats":{"Line":1},"fn_name":null},{"line":415,"address":[4821944],"length":1,"stats":{"Line":1},"fn_name":null},{"line":416,"address":[4822056],"length":1,"stats":{"Line":1},"fn_name":null},{"line":417,"address":[4821979],"length":1,"stats":{"Line":1},"fn_name":null},{"line":418,"address":[4822032],"length":1,"stats":{"Line":1},"fn_name":null},{"line":419,"address":[4822040],"length":1,"stats":{"Line":1},"fn_name":null},{"line":422,"address":[4822339],"length":1,"stats":{"Line":1},"fn_name":null},{"line":425,"address":[4822668,4822498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":426,"address":[4822349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":427,"address":[4822413,4832025],"length":1,"stats":{"Line":1},"fn_name":null},{"line":429,"address":[4823066,4823236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":430,"address":[4822604],"length":1,"stats":{"Line":1},"fn_name":null},{"line":431,"address":[4822981,4832055],"length":1,"stats":{"Line":1},"fn_name":null},{"line":433,"address":[4823697,4823537],"length":1,"stats":{"Line":1},"fn_name":null},{"line":434,"address":[4823172],"length":1,"stats":{"Line":1},"fn_name":null},{"line":438,"address":[4823998,4824153],"length":1,"stats":{"Line":1},"fn_name":null},{"line":439,"address":[4823643],"length":1,"stats":{"Line":1},"fn_name":null},{"line":443,"address":[4824594,4824454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":444,"address":[4824104],"length":1,"stats":{"Line":1},"fn_name":null},{"line":449,"address":[4825045,4824560],"length":1,"stats":{"Line":2},"fn_name":null},{"line":450,"address":[4824971],"length":1,"stats":{"Line":1},"fn_name":null},{"line":451,"address":[4824892],"length":1,"stats":{"Line":1},"fn_name":null},{"line":452,"address":[4824963],"length":1,"stats":{"Line":1},"fn_name":null},{"line":455,"address":[4825037],"length":1,"stats":{"Line":1},"fn_name":null},{"line":458,"address":[4826129],"length":1,"stats":{"Line":1},"fn_name":null},{"line":461,"address":[4826146],"length":1,"stats":{"Line":1},"fn_name":null},{"line":462,"address":[4826250],"length":1,"stats":{"Line":1},"fn_name":null},{"line":463,"address":[4826171],"length":1,"stats":{"Line":1},"fn_name":null},{"line":464,"address":[4826242],"length":1,"stats":{"Line":1},"fn_name":null},{"line":468,"address":[4826532],"length":1,"stats":{"Line":1},"fn_name":null},{"line":471,"address":[4826539],"length":1,"stats":{"Line":1},"fn_name":null},{"line":473,"address":[4826617],"length":1,"stats":{"Line":1},"fn_name":null},{"line":474,"address":[4826805],"length":1,"stats":{"Line":1},"fn_name":null},{"line":475,"address":[4826726],"length":1,"stats":{"Line":1},"fn_name":null},{"line":476,"address":[4826797],"length":1,"stats":{"Line":1},"fn_name":null},{"line":481,"address":[4827426,4827263],"length":1,"stats":{"Line":1},"fn_name":null},{"line":482,"address":[4827082],"length":1,"stats":{"Line":1},"fn_name":null},{"line":483,"address":[4827171,4832127],"length":1,"stats":{"Line":1},"fn_name":null},{"line":486,"address":[4828158,4827995],"length":1,"stats":{"Line":1},"fn_name":null},{"line":487,"address":[4827369,4827795],"length":1,"stats":{"Line":2},"fn_name":null},{"line":488,"address":[4827839,4832157],"length":1,"stats":{"Line":1},"fn_name":null},{"line":490,"address":[4828885,4828722],"length":1,"stats":{"Line":1},"fn_name":null},{"line":491,"address":[4828101,4828527],"length":1,"stats":{"Line":2},"fn_name":null},{"line":492,"address":[4828571,4832217],"length":1,"stats":{"Line":1},"fn_name":null},{"line":494,"address":[4829439,4829286],"length":1,"stats":{"Line":1},"fn_name":null},{"line":495,"address":[4829254,4828828],"length":1,"stats":{"Line":2},"fn_name":null},{"line":499,"address":[4829956,4829808],"length":1,"stats":{"Line":1},"fn_name":null},{"line":500,"address":[4829392],"length":1,"stats":{"Line":1},"fn_name":null},{"line":504,"address":[4830454,4830325],"length":1,"stats":{"Line":1},"fn_name":null},{"line":505,"address":[4829914],"length":1,"stats":{"Line":1},"fn_name":null},{"line":509,"address":[4830436],"length":1,"stats":{"Line":1},"fn_name":null},{"line":512,"address":[4830992,4830815],"length":1,"stats":{"Line":2},"fn_name":null},{"line":513,"address":[4830918],"length":1,"stats":{"Line":1},"fn_name":null},{"line":514,"address":[4830839],"length":1,"stats":{"Line":1},"fn_name":null},{"line":515,"address":[4830910],"length":1,"stats":{"Line":1},"fn_name":null},{"line":518,"address":[4830984],"length":1,"stats":{"Line":1},"fn_name":null},{"line":533,"address":[4481406,4481376],"length":1,"stats":{"Line":3},"fn_name":"redeem_underlying_over_insurance"},{"line":534,"address":[4481701,4481429,4481489,4481383,4481862,4481925,4481549,4481609,4481793],"length":1,"stats":{"Line":9},"fn_name":null},{"line":535,"address":[4481421],"length":1,"stats":{"Line":1},"fn_name":null},{"line":536,"address":[4481481],"length":1,"stats":{"Line":1},"fn_name":null},{"line":537,"address":[4481541],"length":1,"stats":{"Line":1},"fn_name":null},{"line":538,"address":[4481601],"length":1,"stats":{"Line":1},"fn_name":null},{"line":539,"address":[4481693],"length":1,"stats":{"Line":1},"fn_name":null},{"line":540,"address":[4481846,4481785],"length":1,"stats":{"Line":2},"fn_name":null},{"line":541,"address":[4481917,4481988,4481854],"length":1,"stats":{"Line":2},"fn_name":null},{"line":543,"address":[4832368],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":545,"address":[4832385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":546,"address":[4832471],"length":1,"stats":{"Line":1},"fn_name":null},{"line":547,"address":[4832410],"length":1,"stats":{"Line":1},"fn_name":null},{"line":548,"address":[4832463],"length":1,"stats":{"Line":1},"fn_name":null},{"line":552,"address":[4832770],"length":1,"stats":{"Line":1},"fn_name":null},{"line":555,"address":[4832790],"length":1,"stats":{"Line":1},"fn_name":null},{"line":556,"address":[4832876],"length":1,"stats":{"Line":1},"fn_name":null},{"line":557,"address":[4832815],"length":1,"stats":{"Line":1},"fn_name":null},{"line":558,"address":[4832868],"length":1,"stats":{"Line":1},"fn_name":null},{"line":562,"address":[4833175],"length":1,"stats":{"Line":1},"fn_name":null},{"line":565,"address":[4833195],"length":1,"stats":{"Line":1},"fn_name":null},{"line":566,"address":[4833281],"length":1,"stats":{"Line":1},"fn_name":null},{"line":567,"address":[4833220],"length":1,"stats":{"Line":1},"fn_name":null},{"line":568,"address":[4833273],"length":1,"stats":{"Line":1},"fn_name":null},{"line":572,"address":[4833580],"length":1,"stats":{"Line":1},"fn_name":null},{"line":575,"address":[4833600],"length":1,"stats":{"Line":1},"fn_name":null},{"line":576,"address":[4833686],"length":1,"stats":{"Line":1},"fn_name":null},{"line":577,"address":[4833625],"length":1,"stats":{"Line":1},"fn_name":null},{"line":578,"address":[4833678],"length":1,"stats":{"Line":1},"fn_name":null},{"line":582,"address":[4833985],"length":1,"stats":{"Line":1},"fn_name":null},{"line":585,"address":[4833995],"length":1,"stats":{"Line":1},"fn_name":null},{"line":588,"address":[4834061],"length":1,"stats":{"Line":1},"fn_name":null},{"line":589,"address":[4834232],"length":1,"stats":{"Line":1},"fn_name":null},{"line":590,"address":[4834171],"length":1,"stats":{"Line":1},"fn_name":null},{"line":591,"address":[4834224],"length":1,"stats":{"Line":1},"fn_name":null},{"line":596,"address":[4835023,4834853],"length":1,"stats":{"Line":1},"fn_name":null},{"line":597,"address":[4834531],"length":1,"stats":{"Line":1},"fn_name":null},{"line":598,"address":[4834585,4837009],"length":1,"stats":{"Line":1},"fn_name":null},{"line":604,"address":[4835492,4835662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":605,"address":[4834959],"length":1,"stats":{"Line":1},"fn_name":null},{"line":606,"address":[4837129,4835336],"length":1,"stats":{"Line":1},"fn_name":null},{"line":608,"address":[4836273,4836103],"length":1,"stats":{"Line":1},"fn_name":null},{"line":609,"address":[4835598],"length":1,"stats":{"Line":1},"fn_name":null},{"line":610,"address":[4835972,4837189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":612,"address":[4836749,4836629],"length":1,"stats":{"Line":1},"fn_name":null},{"line":613,"address":[4836209],"length":1,"stats":{"Line":1},"fn_name":null},{"line":614,"address":[4836556,4837249,4837279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":631,"address":[4482064,4482094],"length":1,"stats":{"Line":3},"fn_name":"redeem_with_current_currency_borrowing"},{"line":632,"address":[4482321,4482413,4482505,4482177,4482245,4482071,4482117],"length":1,"stats":{"Line":7},"fn_name":null},{"line":633,"address":[4482109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":634,"address":[4482169,4482229],"length":1,"stats":{"Line":2},"fn_name":null},{"line":635,"address":[4482237,4482305,4482615],"length":1,"stats":{"Line":2},"fn_name":null},{"line":636,"address":[4482313],"length":1,"stats":{"Line":1},"fn_name":null},{"line":637,"address":[4482405],"length":1,"stats":{"Line":1},"fn_name":null},{"line":638,"address":[4482497],"length":1,"stats":{"Line":1},"fn_name":null},{"line":640,"address":[4837312,4837415],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":642,"address":[4837335],"length":1,"stats":{"Line":1},"fn_name":null},{"line":643,"address":[4837438],"length":1,"stats":{"Line":1},"fn_name":null},{"line":644,"address":[4837360],"length":1,"stats":{"Line":1},"fn_name":null},{"line":645,"address":[4837430],"length":1,"stats":{"Line":1},"fn_name":null},{"line":649,"address":[4837737],"length":1,"stats":{"Line":1},"fn_name":null},{"line":652,"address":[4837757],"length":1,"stats":{"Line":1},"fn_name":null},{"line":653,"address":[4837843],"length":1,"stats":{"Line":1},"fn_name":null},{"line":654,"address":[4837782],"length":1,"stats":{"Line":1},"fn_name":null},{"line":655,"address":[4837835],"length":1,"stats":{"Line":1},"fn_name":null},{"line":659,"address":[4838142],"length":1,"stats":{"Line":1},"fn_name":null},{"line":662,"address":[4838152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":663,"address":[4838264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":664,"address":[4838187],"length":1,"stats":{"Line":1},"fn_name":null},{"line":665,"address":[4838240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":666,"address":[4838248],"length":1,"stats":{"Line":1},"fn_name":null},{"line":670,"address":[4838907,4838737],"length":1,"stats":{"Line":1},"fn_name":null},{"line":671,"address":[4838547],"length":1,"stats":{"Line":1},"fn_name":null},{"line":672,"address":[4850081,4838601],"length":1,"stats":{"Line":1},"fn_name":null},{"line":676,"address":[4839546,4839376],"length":1,"stats":{"Line":1},"fn_name":null},{"line":677,"address":[4838843],"length":1,"stats":{"Line":1},"fn_name":null},{"line":678,"address":[4839220,4850141],"length":1,"stats":{"Line":1},"fn_name":null},{"line":680,"address":[4840116,4839944],"length":1,"stats":{"Line":1},"fn_name":null},{"line":681,"address":[4839482],"length":1,"stats":{"Line":1},"fn_name":null},{"line":682,"address":[4839859,4850201],"length":1,"stats":{"Line":1},"fn_name":null},{"line":685,"address":[4840050,4840409],"length":1,"stats":{"Line":2},"fn_name":null},{"line":686,"address":[4840497,4840669],"length":1,"stats":{"Line":1},"fn_name":null},{"line":687,"address":[4840445],"length":1,"stats":{"Line":1},"fn_name":null},{"line":691,"address":[4840962,4840603],"length":1,"stats":{"Line":2},"fn_name":null},{"line":692,"address":[4841050,4841210],"length":1,"stats":{"Line":1},"fn_name":null},{"line":693,"address":[4840998],"length":1,"stats":{"Line":1},"fn_name":null},{"line":698,"address":[4841666,4841511],"length":1,"stats":{"Line":1},"fn_name":null},{"line":699,"address":[4841156],"length":1,"stats":{"Line":1},"fn_name":null},{"line":703,"address":[4841967,4842103],"length":1,"stats":{"Line":1},"fn_name":null},{"line":704,"address":[4841617],"length":1,"stats":{"Line":1},"fn_name":null},{"line":708,"address":[4842073],"length":1,"stats":{"Line":1},"fn_name":null},{"line":711,"address":[4842552,4842396],"length":1,"stats":{"Line":2},"fn_name":null},{"line":712,"address":[4842415],"length":1,"stats":{"Line":1},"fn_name":null},{"line":713,"address":[4842544],"length":1,"stats":{"Line":1},"fn_name":null},{"line":716,"address":[4843636],"length":1,"stats":{"Line":1},"fn_name":null},{"line":719,"address":[4843653],"length":1,"stats":{"Line":1},"fn_name":null},{"line":720,"address":[4843757],"length":1,"stats":{"Line":1},"fn_name":null},{"line":721,"address":[4843678],"length":1,"stats":{"Line":1},"fn_name":null},{"line":722,"address":[4843749],"length":1,"stats":{"Line":1},"fn_name":null},{"line":727,"address":[4844044],"length":1,"stats":{"Line":1},"fn_name":null},{"line":728,"address":[4844148],"length":1,"stats":{"Line":1},"fn_name":null},{"line":729,"address":[4844069],"length":1,"stats":{"Line":1},"fn_name":null},{"line":730,"address":[4844140],"length":1,"stats":{"Line":1},"fn_name":null},{"line":734,"address":[4844430],"length":1,"stats":{"Line":1},"fn_name":null},{"line":737,"address":[4844442],"length":1,"stats":{"Line":1},"fn_name":null},{"line":741,"address":[4844792],"length":1,"stats":{"Line":1},"fn_name":null},{"line":742,"address":[4845132,4845295],"length":1,"stats":{"Line":1},"fn_name":null},{"line":743,"address":[4844812],"length":1,"stats":{"Line":1},"fn_name":null},{"line":744,"address":[4844979,4844910,4850273],"length":1,"stats":{"Line":2},"fn_name":null},{"line":745,"address":[4844955],"length":1,"stats":{"Line":1},"fn_name":null},{"line":748,"address":[4845859,4846022],"length":1,"stats":{"Line":1},"fn_name":null},{"line":749,"address":[4845238,4845664],"length":1,"stats":{"Line":2},"fn_name":null},{"line":750,"address":[4845708,4850363],"length":1,"stats":{"Line":1},"fn_name":null},{"line":753,"address":[4846621,4846391,4845965],"length":1,"stats":{"Line":2},"fn_name":null},{"line":754,"address":[4847036,4846528,4850429],"length":1,"stats":{"Line":2},"fn_name":null},{"line":755,"address":[4846982,4846544],"length":1,"stats":{"Line":2},"fn_name":null},{"line":756,"address":[4847392,4847209],"length":1,"stats":{"Line":1},"fn_name":null},{"line":757,"address":[4847123],"length":1,"stats":{"Line":1},"fn_name":null},{"line":761,"address":[4847325],"length":1,"stats":{"Line":1},"fn_name":null},{"line":762,"address":[4847761,4847909],"length":1,"stats":{"Line":1},"fn_name":null},{"line":763,"address":[4847345],"length":1,"stats":{"Line":1},"fn_name":null},{"line":767,"address":[4848523,4848392],"length":1,"stats":{"Line":1},"fn_name":null},{"line":768,"address":[4847867],"length":1,"stats":{"Line":1},"fn_name":null},{"line":769,"address":[4848278,4850462],"length":1,"stats":{"Line":1},"fn_name":null},{"line":772,"address":[4848505],"length":1,"stats":{"Line":1},"fn_name":null},{"line":775,"address":[4848884,4849045],"length":1,"stats":{"Line":2},"fn_name":null},{"line":776,"address":[4848908],"length":1,"stats":{"Line":1},"fn_name":null},{"line":777,"address":[4849037],"length":1,"stats":{"Line":1},"fn_name":null},{"line":790,"address":[4482726,4482704],"length":1,"stats":{"Line":3},"fn_name":"redeem_with_another_currency_borrowing"},{"line":791,"address":[4482809,4482901,4482749,4482962,4483017,4482711],"length":1,"stats":{"Line":6},"fn_name":null},{"line":792,"address":[4482741],"length":1,"stats":{"Line":1},"fn_name":null},{"line":793,"address":[4482801],"length":1,"stats":{"Line":1},"fn_name":null},{"line":794,"address":[4482893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":795,"address":[4482954],"length":1,"stats":{"Line":1},"fn_name":null},{"line":796,"address":[4483009],"length":1,"stats":{"Line":1},"fn_name":null},{"line":798,"address":[4850576,4850673],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":800,"address":[4850593],"length":1,"stats":{"Line":1},"fn_name":null},{"line":801,"address":[4850696],"length":1,"stats":{"Line":1},"fn_name":null},{"line":802,"address":[4850618],"length":1,"stats":{"Line":1},"fn_name":null},{"line":803,"address":[4850688],"length":1,"stats":{"Line":1},"fn_name":null},{"line":807,"address":[4850995],"length":1,"stats":{"Line":1},"fn_name":null},{"line":810,"address":[4851005],"length":1,"stats":{"Line":1},"fn_name":null},{"line":811,"address":[4851117],"length":1,"stats":{"Line":1},"fn_name":null},{"line":812,"address":[4851040],"length":1,"stats":{"Line":1},"fn_name":null},{"line":813,"address":[4851093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":814,"address":[4851101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":818,"address":[4851549,4851719],"length":1,"stats":{"Line":1},"fn_name":null},{"line":819,"address":[4851400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":820,"address":[4856796,4851464],"length":1,"stats":{"Line":1},"fn_name":null},{"line":822,"address":[4852020,4852180],"length":1,"stats":{"Line":1},"fn_name":null},{"line":823,"address":[4851655],"length":1,"stats":{"Line":1},"fn_name":null},{"line":827,"address":[4852481,4852636],"length":1,"stats":{"Line":1},"fn_name":null},{"line":828,"address":[4852126],"length":1,"stats":{"Line":1},"fn_name":null},{"line":832,"address":[4853073,4852937],"length":1,"stats":{"Line":1},"fn_name":null},{"line":833,"address":[4852587],"length":1,"stats":{"Line":1},"fn_name":null},{"line":837,"address":[4853043],"length":1,"stats":{"Line":1},"fn_name":null},{"line":840,"address":[4853522,4853366],"length":1,"stats":{"Line":2},"fn_name":null},{"line":841,"address":[4853385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":842,"address":[4853514],"length":1,"stats":{"Line":1},"fn_name":null},{"line":847,"address":[4854784,4854947],"length":1,"stats":{"Line":1},"fn_name":null},{"line":848,"address":[4854601],"length":1,"stats":{"Line":1},"fn_name":null},{"line":849,"address":[4854699,4856868,4856898],"length":1,"stats":{"Line":1},"fn_name":null},{"line":851,"address":[4855501,4855348],"length":1,"stats":{"Line":1},"fn_name":null},{"line":852,"address":[4855316,4854890],"length":1,"stats":{"Line":2},"fn_name":null},{"line":857,"address":[4856018,4855870],"length":1,"stats":{"Line":1},"fn_name":null},{"line":858,"address":[4855454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":862,"address":[4856481,4856357],"length":1,"stats":{"Line":1},"fn_name":null},{"line":863,"address":[4855976],"length":1,"stats":{"Line":1},"fn_name":null},{"line":882,"address":[4483174,4483152],"length":1,"stats":{"Line":3},"fn_name":"redeem_with_third_currency_borrowing"},{"line":883,"address":[4483562,4483197,4483501,4483409,4483317,4483257,4483159],"length":1,"stats":{"Line":7},"fn_name":null},{"line":884,"address":[4483189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":885,"address":[4483249],"length":1,"stats":{"Line":1},"fn_name":null},{"line":886,"address":[4483309],"length":1,"stats":{"Line":1},"fn_name":null},{"line":887,"address":[4483401],"length":1,"stats":{"Line":1},"fn_name":null},{"line":888,"address":[4483493],"length":1,"stats":{"Line":1},"fn_name":null},{"line":889,"address":[4483554],"length":1,"stats":{"Line":1},"fn_name":null},{"line":891,"address":[4856944,4857047],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":893,"address":[4856967],"length":1,"stats":{"Line":1},"fn_name":null},{"line":894,"address":[4857070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":895,"address":[4856992],"length":1,"stats":{"Line":1},"fn_name":null},{"line":896,"address":[4857062],"length":1,"stats":{"Line":1},"fn_name":null},{"line":900,"address":[4857369],"length":1,"stats":{"Line":1},"fn_name":null},{"line":903,"address":[4857389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":904,"address":[4857475],"length":1,"stats":{"Line":1},"fn_name":null},{"line":905,"address":[4857414],"length":1,"stats":{"Line":1},"fn_name":null},{"line":906,"address":[4857467],"length":1,"stats":{"Line":1},"fn_name":null},{"line":910,"address":[4857774],"length":1,"stats":{"Line":1},"fn_name":null},{"line":913,"address":[4857784],"length":1,"stats":{"Line":1},"fn_name":null},{"line":914,"address":[4857896],"length":1,"stats":{"Line":1},"fn_name":null},{"line":915,"address":[4857819],"length":1,"stats":{"Line":1},"fn_name":null},{"line":916,"address":[4857872],"length":1,"stats":{"Line":1},"fn_name":null},{"line":917,"address":[4857880],"length":1,"stats":{"Line":1},"fn_name":null},{"line":921,"address":[4858328,4858498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":922,"address":[4858179],"length":1,"stats":{"Line":1},"fn_name":null},{"line":923,"address":[4867158,4858243],"length":1,"stats":{"Line":1},"fn_name":null},{"line":925,"address":[4859066,4858896],"length":1,"stats":{"Line":1},"fn_name":null},{"line":926,"address":[4858434],"length":1,"stats":{"Line":1},"fn_name":null},{"line":927,"address":[4858811,4867188],"length":1,"stats":{"Line":1},"fn_name":null},{"line":929,"address":[4859367,4859527],"length":1,"stats":{"Line":1},"fn_name":null},{"line":930,"address":[4859002],"length":1,"stats":{"Line":1},"fn_name":null},{"line":934,"address":[4859983,4859828],"length":1,"stats":{"Line":1},"fn_name":null},{"line":935,"address":[4859473],"length":1,"stats":{"Line":1},"fn_name":null},{"line":939,"address":[4860420,4860284],"length":1,"stats":{"Line":1},"fn_name":null},{"line":940,"address":[4859934],"length":1,"stats":{"Line":1},"fn_name":null},{"line":944,"address":[4860390],"length":1,"stats":{"Line":1},"fn_name":null},{"line":947,"address":[4860713,4860869],"length":1,"stats":{"Line":2},"fn_name":null},{"line":948,"address":[4860732],"length":1,"stats":{"Line":1},"fn_name":null},{"line":949,"address":[4860861],"length":1,"stats":{"Line":1},"fn_name":null},{"line":952,"address":[4861953],"length":1,"stats":{"Line":1},"fn_name":null},{"line":955,"address":[4861970],"length":1,"stats":{"Line":1},"fn_name":null},{"line":956,"address":[4862074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":957,"address":[4861995],"length":1,"stats":{"Line":1},"fn_name":null},{"line":958,"address":[4862066],"length":1,"stats":{"Line":1},"fn_name":null},{"line":962,"address":[4862356],"length":1,"stats":{"Line":1},"fn_name":null},{"line":965,"address":[4862363],"length":1,"stats":{"Line":1},"fn_name":null},{"line":967,"address":[4862441],"length":1,"stats":{"Line":1},"fn_name":null},{"line":968,"address":[4862550],"length":1,"stats":{"Line":1},"fn_name":null},{"line":971,"address":[4863307,4863144],"length":1,"stats":{"Line":1},"fn_name":null},{"line":972,"address":[4862890],"length":1,"stats":{"Line":1},"fn_name":null},{"line":973,"address":[4867260,4862988],"length":1,"stats":{"Line":1},"fn_name":null},{"line":975,"address":[4863871,4864034],"length":1,"stats":{"Line":1},"fn_name":null},{"line":976,"address":[4863250,4863676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":977,"address":[4863720,4867320],"length":1,"stats":{"Line":1},"fn_name":null},{"line":979,"address":[4864588,4864435],"length":1,"stats":{"Line":1},"fn_name":null},{"line":980,"address":[4864403,4863977],"length":1,"stats":{"Line":2},"fn_name":null},{"line":984,"address":[4864957,4865105],"length":1,"stats":{"Line":1},"fn_name":null},{"line":985,"address":[4864541],"length":1,"stats":{"Line":1},"fn_name":null},{"line":989,"address":[4865474,4865603],"length":1,"stats":{"Line":1},"fn_name":null},{"line":990,"address":[4865063],"length":1,"stats":{"Line":1},"fn_name":null},{"line":994,"address":[4865585],"length":1,"stats":{"Line":1},"fn_name":null},{"line":997,"address":[4866125,4865964],"length":1,"stats":{"Line":2},"fn_name":null},{"line":998,"address":[4865988],"length":1,"stats":{"Line":1},"fn_name":null},{"line":999,"address":[4866117],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1013,"address":[4483726,4483696],"length":1,"stats":{"Line":3},"fn_name":"redeem_over_insurance"},{"line":1014,"address":[4484021,4483809,4483703,4483929,4483749,4484113,4483869,4484274,4484205,4484337],"length":1,"stats":{"Line":10},"fn_name":null},{"line":1015,"address":[4483741],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1016,"address":[4483801],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1017,"address":[4483861],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1018,"address":[4483921],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1019,"address":[4484013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1020,"address":[4484105],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1021,"address":[4484197,4484258],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1022,"address":[4484400,4484329,4484266],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1024,"address":[4867456],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":1026,"address":[4867473],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1027,"address":[4867559],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1028,"address":[4867498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1029,"address":[4867551],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1033,"address":[4867858],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1036,"address":[4867878],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1037,"address":[4867964],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1038,"address":[4867903],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1039,"address":[4867956],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1044,"address":[4868273],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1045,"address":[4868359],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1046,"address":[4868298],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1047,"address":[4868351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1051,"address":[4868658],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1054,"address":[4868678],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1055,"address":[4868764],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1056,"address":[4868703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1057,"address":[4868756],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1061,"address":[4869063],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1064,"address":[4869073],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1066,"address":[4869144],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1069,"address":[4869486],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1072,"address":[4870083,4869913],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1073,"address":[4869591],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1074,"address":[4872069,4869645],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1080,"address":[4870722,4870552],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1081,"address":[4870019],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1082,"address":[4872189,4870396],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1084,"address":[4871333,4871163],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1085,"address":[4870658],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1086,"address":[4872249,4871032],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1088,"address":[4871689,4871809],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1089,"address":[4871269],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1090,"address":[4872339,4872309,4871616],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1099,"address":[4484502,4484480],"length":1,"stats":{"Line":3},"fn_name":"borrow_with_insufficient_collateral_no_deposits"},{"line":1100,"address":[4484487,4484525,4484677,4484585],"length":1,"stats":{"Line":4},"fn_name":null},{"line":1101,"address":[4484517],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1102,"address":[4484577],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1103,"address":[4484669],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1105,"address":[4872384,4872437],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":1107,"address":[4872401],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1108,"address":[4872421,4872610],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1109,"address":[4872457],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1110,"address":[4872602],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1114,"address":[4873665,4873855],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1126,"address":[4484838,4484816],"length":1,"stats":{"Line":3},"fn_name":"borrow_without_collateral_in_second_currency"},{"line":1127,"address":[4485068,4484823,4485013,4484921,4484861],"length":1,"stats":{"Line":5},"fn_name":null},{"line":1128,"address":[4484853],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1129,"address":[4484913],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1130,"address":[4485005],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1131,"address":[4485060],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1133,"address":[4874353,4874256],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":1135,"address":[4874273],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1136,"address":[4874376],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1137,"address":[4874298],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1138,"address":[4874368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1142,"address":[4874675],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1145,"address":[4874695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1146,"address":[4874715,4874887],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1147,"address":[4874734],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1148,"address":[4874879],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1152,"address":[4876276,4876120],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1153,"address":[4875966],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1154,"address":[4876054,4877127,4877157],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1156,"address":[4876770,4876615,4876226],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1168,"address":[4485222,4485200],"length":1,"stats":{"Line":3},"fn_name":"borrow_with_insufficient_collateral_in_second_currency"},{"line":1169,"address":[4485245,4485207,4485397,4485305,4485452],"length":1,"stats":{"Line":5},"fn_name":null},{"line":1170,"address":[4485237],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1171,"address":[4485297],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1172,"address":[4485389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1173,"address":[4485444],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1175,"address":[4877200,4877297],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":1177,"address":[4877217],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1178,"address":[4877320],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1179,"address":[4877242],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1180,"address":[4877312],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1184,"address":[4877619],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1187,"address":[4877639],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1188,"address":[4877659,4877831],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1189,"address":[4877678],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1190,"address":[4877823],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1194,"address":[4879064,4879220],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1195,"address":[4878910],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1196,"address":[4880071,4878998,4880101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1198,"address":[4879559,4879170,4879714],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1210,"address":[4485584,4485606],"length":1,"stats":{"Line":3},"fn_name":"borrow_with_sufficient_collateral_in_second_currency"},{"line":1211,"address":[4485836,4485629,4485781,4485591,4485689],"length":1,"stats":{"Line":5},"fn_name":null},{"line":1212,"address":[4485621],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1213,"address":[4485681],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1214,"address":[4485773],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1215,"address":[4485828],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1217,"address":[4880144],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":1219,"address":[4880161],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1220,"address":[4880247],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1221,"address":[4880186],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1222,"address":[4880239],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1226,"address":[4880546],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1229,"address":[4880556],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1230,"address":[4880668],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1231,"address":[4880591],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1232,"address":[4880644],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1233,"address":[4880652],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1237,"address":[4881233,4881070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1238,"address":[4880951],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1239,"address":[4881005,4883929],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1241,"address":[4881636,4881806],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1242,"address":[4881176],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1243,"address":[4883959,4881526],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1245,"address":[4882204,4882374],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1246,"address":[4881742],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1247,"address":[4883989,4884019,4882119],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1249,"address":[4882830,4882310,4882675],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1250,"address":[4882781,4883281,4883125],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1251,"address":[4883669,4883549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1252,"address":[4883232],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":611,"coverable":611},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","integration-tests","src","tests","scenario_tests.rs"],"content":"//  Scenario Integration tests.\n\n#[cfg(test)]\n\nmod tests {\n\tuse crate::tests::*;\n\n\t// Description of scenario #1:\n\t// In this scenario, user uses four operations in the protocol (deposit, borrow, repay, redeem).\n\t// Changes to the main protocol parameters are also checked here.\n\t#[test]\n\tfn scenario_with_four_operations() {\n\t\tExtBuilder::default()\n\t\t\t.user_balance(ADMIN, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t\t.pool_user_data(CurrencyId::DOT, ALICE, BALANCE_ZERO, RATE_ZERO, true)\n\t\t\t.pool_initial(CurrencyId::DOT)\n\t\t\t.build()\n\t\t\t.execute_with(|| {\n\t\t\t\t// INITIAL PARAMS\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\tlet alice_dot_free_balance_start: Balance = ONE_HUNDRED;\n\t\t\t\tlet alice_m_dot_free_balance_start: Balance = BALANCE_ZERO;\n\t\t\t\tlet alice_dot_total_borrow_start: Balance = BALANCE_ZERO;\n\n\t\t\t\tlet pool_available_liquidity_start: Balance = BALANCE_ZERO;\n\t\t\t\tlet pool_m_dot_total_issuance_start: Balance = BALANCE_ZERO;\n\t\t\t\tlet pool_total_insurance_start: Balance = BALANCE_ZERO;\n\t\t\t\tlet pool_dot_total_borrow_start: Balance = BALANCE_ZERO;\n\n\t\t\t\t// ACTION: DEPOSIT INSURANCE\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Add liquidity to DOT pool from Insurance by Admin\n\t\t\t\tlet admin_deposit_amount_block_number_0: Balance = 100_000 * DOLLARS;\n\t\t\t\tassert_ok!(TestController::deposit_insurance(\n\t\t\t\t\tOrigin::signed(ADMIN),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tadmin_deposit_amount_block_number_0\n\t\t\t\t));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected: 100_000\n\t\t\t\tlet current_pool_available_liquidity_block_number_0: Balance =\n\t\t\t\t\tpool_available_liquidity_start + admin_deposit_amount_block_number_0;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_0\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Admin doesn't have to get wrapped token after adding liquidity from insurance.\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_total_issuance_start\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// Checking DOT pool Storage params\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).borrow_index, Rate::one());\n\t\t\t\t// Total insurance changed: 0 -\u003e 100 000\n\t\t\t\tlet pool_total_insurance_block_number_0 =\n\t\t\t\t\tpool_total_insurance_start + admin_deposit_amount_block_number_0;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_0\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\tpool_dot_total_borrow_start\n\t\t\t\t);\n\n\t\t\t\t// Checking controller params\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 0);\n\t\t\t\tassert_eq!(borrow_rate, RATE_ZERO);\n\n\t\t\t\t// Checking DOT pool User params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\talice_dot_total_borrow_start\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(1);\n\n\t\t\t\t// ACTION: DEPOSIT UNDERLYING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// ALICE deposit 60 000 to DOT pool\n\t\t\t\tlet alice_deposit_amount_block_number_1: Balance = 60_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_deposit_amount_block_number_1\n\t\t\t\t));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected: 160 000\n\t\t\t\tlet pool_available_liquidity_block_number_1: Balance =\n\t\t\t\t\tadmin_deposit_amount_block_number_0 + alice_deposit_amount_block_number_1;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tpool_available_liquidity_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Admin doesn't have to get wrapped token after adding liquidity from insurance.\n\t\t\t\t// Alice gets wrapped token after adding liquidity by exchange rate 1:1\n\t\t\t\t// Expected: 60 000\n\t\t\t\tlet pool_m_dot_free_balance_block_number_1: Balance =\n\t\t\t\t\tpool_m_dot_total_issuance_start + alice_deposit_amount_block_number_1;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// ALICE:\n\t\t\t\tlet alice_dot_free_balance_block_number_1: Balance =\n\t\t\t\t\talice_dot_free_balance_start - alice_deposit_amount_block_number_1;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_1\n\t\t\t\t);\n\t\t\t\tlet alice_m_dot_free_balance_block_number_1: Balance =\n\t\t\t\t\talice_m_dot_free_balance_start + alice_deposit_amount_block_number_1;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking DOT pool Storage params\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).borrow_index, Rate::one());\n\t\t\t\t// Expected: 100 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_0\n\t\t\t\t);\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_borrowed, BALANCE_ZERO);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 1);\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, RATE_ZERO);\n\n\t\t\t\t// Checking DOT pool User params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(2);\n\n\t\t\t\t// ACTION: BORROW\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t//  Alice borrow 30_000 from DOT pool.\n\t\t\t\tlet alice_borrow_amount_block_number_2: Balance = 30_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::borrow(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_borrow_amount_block_number_2\n\t\t\t\t));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected 130 000\n\t\t\t\tlet current_pool_available_liquidity_block_number_2: Balance =\n\t\t\t\t\tpool_available_liquidity_block_number_1 - alice_borrow_amount_block_number_2;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_2\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// ALICE:\n\t\t\t\t// Expected: 70 000\n\t\t\t\tlet alice_dot_free_balance_block_number_2: Balance =\n\t\t\t\t\talice_dot_free_balance_block_number_1 + alice_borrow_amount_block_number_2;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_2\n\t\t\t\t);\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking pool Storage params\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).borrow_index, Rate::one());\n\t\t\t\t// Expected: 100 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_0\n\t\t\t\t);\n\t\t\t\t// Total borrowed amount changed 0 -\u003e 30 000\n\t\t\t\tlet pool_dot_total_borrow_block_number_2: Balance =\n\t\t\t\t\tpool_dot_total_borrow_start + alice_borrow_amount_block_number_2;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\tpool_dot_total_borrow_block_number_2\n\t\t\t\t);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 2);\n\t\t\t\t// Borrow_rate changed: 0 -\u003e 45 * 10^(-10)\n\t\t\t\tlet expected_borrow_rate_block_number_2: Rate =\n\t\t\t\t\tRate::saturating_from_rational(45u128, 10_000_000_000u128);\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, expected_borrow_rate_block_number_2);\n\n\t\t\t\t// Checking DOT pool User params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\t// User total borrowed changed: 0 -\u003e 30 000\n\t\t\t\tlet alice_dot_total_borrow_block_number_2: Balance =\n\t\t\t\t\talice_dot_total_borrow_start + alice_borrow_amount_block_number_2;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_dot_total_borrow_block_number_2\n\t\t\t\t);\n\t\t\t\t// User interest index changed: 0 -\u003e 1\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tRate::one()\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(3);\n\n\t\t\t\t// ACTION: REPAY\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Alice repay part of her loan(15 000).\n\t\t\t\tlet alice_repay_amount_block_number_3: Balance = 15_000 * DOLLARS;\n\t\t\t\tassert_ok!(MinterestProtocol::repay(\n\t\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\talice_repay_amount_block_number_3\n\t\t\t\t));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected 145 000\n\t\t\t\tlet current_pool_available_liquidity_block_number_3: Balance =\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_2 + alice_repay_amount_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_3\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// ALICE:\n\t\t\t\t// Expected: 55 000\n\t\t\t\tlet alice_dot_free_balance_block_number_3: Balance =\n\t\t\t\t\talice_dot_free_balance_block_number_2 - alice_repay_amount_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_3\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\n\t\t\t\t// Checking pool Storage params\n\t\t\t\t// Expected: 1.000000004500000000\n\t\t\t\tlet pool_borrow_index_block_number_3: Rate =\n\t\t\t\t\tRate::saturating_from_rational(10_000_000_045u128, 10_000_000_000u128);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).borrow_index,\n\t\t\t\t\tpool_borrow_index_block_number_3\n\t\t\t\t);\n\t\t\t\t// Expected: 100_000,0000135\n\t\t\t\tlet insurance_accumulated_block_number_3: Balance = 13_500_000_000_000;\n\t\t\t\tlet pool_total_insurance_block_number_3: Balance =\n\t\t\t\t\tadmin_deposit_amount_block_number_0 + insurance_accumulated_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_3\n\t\t\t\t);\n\t\t\t\t// Expected: 15_000,000135\n\t\t\t\tlet borrow_accumulated_block_number_3: Balance = 135_000_000_000_000;\n\t\t\t\tlet pool_dot_total_borrow_block_number_3: Balance = pool_dot_total_borrow_block_number_2\n\t\t\t\t\t+ borrow_accumulated_block_number_3\n\t\t\t\t\t- alice_repay_amount_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\tpool_dot_total_borrow_block_number_3\n\t\t\t\t);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 3);\n\t\t\t\t// Borrow_rate changed: 0,0000000045 -\u003e 0,000000002250000015\n\t\t\t\tlet expected_borrow_rate_block_number_3: Rate =\n\t\t\t\t\tRate::saturating_from_rational(2_250_000_015u128, 1_000_000_000_000_000_000u128);\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, expected_borrow_rate_block_number_3);\n\n\t\t\t\t// Checking DOT pool User params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\tlet alice_dot_total_borrow_block_number_3: Balance = alice_dot_total_borrow_block_number_2\n\t\t\t\t\t+ borrow_accumulated_block_number_3\n\t\t\t\t\t- alice_repay_amount_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\talice_dot_total_borrow_block_number_3\n\t\t\t\t);\n\t\t\t\t// Interest_index changed: 0 -\u003e 1.000000004500000000\n\t\t\t\tlet user_interest_index_block_number_3: Rate = pool_borrow_index_block_number_3;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tuser_interest_index_block_number_3\n\t\t\t\t);\n\n\t\t\t\tSystem::set_block_number(4);\n\n\t\t\t\t// ACTION: REPAY_ALL\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Alice repay all loans.\n\t\t\t\tassert_ok!(MinterestProtocol::repay_all(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Real expected: \t\t160_000,000168750000528750\n\t\t\t\t// Currently expected:\t160_000,000168750000526875\n\t\t\t\t// FIXME: unavailable behavior. That is a reason of error below.\n\t\t\t\t// FIXME: borrow_accumulated_block_number_4 should be 33_750_000_528_750\n\t\t\t\t//\t\t\t\t\t\t\t\t\t\t   instead of 33_750_000_526_875\n\t\t\t\tlet borrow_accumulated_block_number_4: Balance = 33_750_000_526_875;\n\t\t\t\tlet current_pool_available_liquidity_block_number_4: Balance =\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_3\n\t\t\t\t\t\t+ alice_repay_amount_block_number_3\n\t\t\t\t\t\t+ borrow_accumulated_block_number_3\n\t\t\t\t\t\t+ borrow_accumulated_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_4\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::total_issuance(CurrencyId::MDOT),\n\t\t\t\t\tpool_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT for ADMIN\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\n\t\t\t\t// ALICE:\n\t\t\t\tlet alice_dot_free_balance_block_number_4: Balance = alice_dot_free_balance_block_number_3\n\t\t\t\t\t- alice_dot_total_borrow_block_number_3\n\t\t\t\t\t- borrow_accumulated_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_4\n\t\t\t\t);\n\t\t\t\t// Expected: 60 000\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::MDOT, \u0026ALICE),\n\t\t\t\t\talice_m_dot_free_balance_block_number_1\n\t\t\t\t);\n\t\t\t\t// Checking pool Storage params\n\t\t\t\t// Borrow_index changed: 1.000000004500000000 -\u003e 1,000000006750000025\n\t\t\t\tlet pool_borrow_index_block_number_4 =\n\t\t\t\t\tRate::saturating_from_rational(1_000_000_006_750_000_025u128, 1_000_000_000_000_000_000u128);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).borrow_index,\n\t\t\t\t\tpool_borrow_index_block_number_4\n\t\t\t\t);\n\t\t\t\tlet insurance_accumulated_block_number_4: Balance = 3_375_000_052_875;\n\t\t\t\tlet pool_total_insurance_block_number_4: Balance =\n\t\t\t\t\tpool_total_insurance_block_number_3 + insurance_accumulated_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_4\n\t\t\t\t);\n\n\t\t\t\t// FIXME: unavailable behavior.\n\t\t\t\t// TODO: should be fixed\n\t\t\t\t// It must be zero, but it is not.\n\t\t\t\t// 1875 left - 0 right\n\t\t\t\t// 15000000168750000528750 new borrow value accrue_interest\n\t\t\t\t// 15000000168750000526875 new user borrow value\n\t\t\t\tlet borrow_accumulated_block_number_4 = 33_750_000_528_750u128;\n\t\t\t\tlet alice_borrow_accumulated_block_number_4 = 33_750_000_526_875u128;\n\t\t\t\tlet pool_dot_total_borrow_block_number_4 = pool_dot_total_borrow_block_number_3\n\t\t\t\t\t+ borrow_accumulated_block_number_4\n\t\t\t\t\t- alice_dot_total_borrow_block_number_3\n\t\t\t\t\t- alice_borrow_accumulated_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_borrowed,\n\t\t\t\t\tpool_dot_total_borrow_block_number_4\n\t\t\t\t);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 4);\n\t\t\t\t// Borrow_rate changed: 0,000000002250000015 -\u003e 0,0\n\t\t\t\tlet expected_borrow_rate_block_number_4 = Rate::zero();\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, expected_borrow_rate_block_number_4);\n\n\t\t\t\t// Checking user pool Storage params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tlet user_interest_index_block_number_4: Rate = pool_borrow_index_block_number_4;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tuser_interest_index_block_number_4\n\t\t\t\t);\n\n\t\t\t\t// Check the underline amount before fn accrue_interest called\n\t\t\t\tlet alice_underlining_amount: Balance =\n\t\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MDOT, alice_m_dot_free_balance_block_number_1).unwrap();\n\n\t\t\t\tSystem::set_block_number(5);\n\n\t\t\t\t// ACTION: REDEEM\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Alice redeem all assets\n\t\t\t\tassert_ok!(MinterestProtocol::redeem(Origin::signed(ALICE), CurrencyId::DOT));\n\n\t\t\t\t// PARAMETERS CHECKING\n\t\t\t\t/* ------------------------------------------------------------------------------ */\n\n\t\t\t\t// Checking pool available liquidity\n\t\t\t\t// Expected: 160_000,000016875000046875\n\t\t\t\tlet current_pool_available_liquidity_block_number_5: Balance =\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_4 - alice_underlining_amount;\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\t\t\tcurrent_pool_available_liquidity_block_number_5\n\t\t\t\t);\n\n\t\t\t\t// Checking free balance MDOT in pool.\n\t\t\t\t// Expected: 0\n\t\t\t\tassert_eq!(Currencies::total_issuance(CurrencyId::MDOT), BALANCE_ZERO);\n\n\t\t\t\t// Checking free balance DOT \u0026\u0026 MDOT\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ADMIN), BALANCE_ZERO);\n\t\t\t\t// ALICE:\n\t\t\t\t// Expected 99_999,999983124999953125\n\t\t\t\tassert_eq!(\n\t\t\t\t\tCurrencies::free_balance(CurrencyId::DOT, \u0026ALICE),\n\t\t\t\t\talice_dot_free_balance_block_number_4 + alice_underlining_amount\n\t\t\t\t);\n\t\t\t\t// Expected: 0\n\t\t\t\tassert_eq!(Currencies::free_balance(CurrencyId::MDOT, \u0026ALICE), BALANCE_ZERO);\n\n\t\t\t\t// Checking pool Storage params\n\t\t\t\t// Expected: 1,000000006750000025\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).borrow_index,\n\t\t\t\t\tpool_borrow_index_block_number_4\n\t\t\t\t);\n\t\t\t\t// Expected: 100_000,000016875000052875\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pools(CurrencyId::DOT).total_insurance,\n\t\t\t\t\tpool_total_insurance_block_number_4\n\t\t\t\t);\n\t\t\t\t//FIXME: something went wrong.....\n\t\t\t\t//TODO: should be fixed\n\t\t\t\tassert_eq!(TestPools::pools(CurrencyId::DOT).total_borrowed, 1875);\n\n\t\t\t\t// Checking controller Storage params\n\t\t\t\tassert_eq!(TestController::controller_dates(CurrencyId::DOT).timestamp, 5);\n\t\t\t\t// borrow_rate changed: 0,000000002250000015 -\u003e 0\n\t\t\t\tlet (borrow_rate, _) =\n\t\t\t\t\tTestController::get_liquidity_pool_borrow_and_supply_rates(CurrencyId::DOT).unwrap_or_default();\n\t\t\t\tassert_eq!(borrow_rate, Rate::from_inner(0));\n\n\t\t\t\t// Checking user pool Storage params\n\t\t\t\t// ADMIN:\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ADMIN).interest_index,\n\t\t\t\t\tRATE_ZERO\n\t\t\t\t);\n\t\t\t\t// ALICE:\n\t\t\t\t// Expected: 0\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\t\t\tBALANCE_ZERO\n\t\t\t\t);\n\t\t\t\t// Expected: 1,000000006750000025\n\t\t\t\tassert_eq!(\n\t\t\t\t\tTestPools::pool_user_data(CurrencyId::DOT, ALICE).interest_index,\n\t\t\t\t\tuser_interest_index_block_number_4\n\t\t\t\t);\n\n\t\t\t\tassert_ok!(MinterestProtocol::deposit_underlying(\n\t\t\t\t\talice(),\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\t20 * DOLLARS,\n\t\t\t\t));\n\t\t\t});\n\t}\n}\n","traces":[{"line":12,"address":[5082821,5082816],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":13,"address":[5365364,5365111,5365212,5365272,5365151],"length":1,"stats":{"Line":5},"fn_name":null},{"line":14,"address":[5365143],"length":1,"stats":{"Line":1},"fn_name":null},{"line":15,"address":[5365204],"length":1,"stats":{"Line":1},"fn_name":null},{"line":16,"address":[5365264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[5365356],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[5083120,5082848],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":23,"address":[5082861],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[5082899],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[5082923],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[5082947],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[5082971],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[5082995],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[5083019],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[5083043],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[5083143],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[5083065],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[5083135],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[5083459,5129020],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[5083561,5083724],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[5083516],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[5084025,5084195],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[5083667],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[5084496,5084665,5084131],"length":1,"stats":{"Line":2},"fn_name":null},{"line":65,"address":[5085120,5084601,5084966],"length":1,"stats":{"Line":2},"fn_name":null},{"line":68,"address":[5085071,5085413,5085620],"length":1,"stats":{"Line":2},"fn_name":null},{"line":71,"address":[5085582,5085929,5129050],"length":1,"stats":{"Line":2},"fn_name":null},{"line":72,"address":[5086145,5085982],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[5085953],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[5086446,5086601],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[5086096],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[5086955],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[5086552,5086910],"length":1,"stats":{"Line":2},"fn_name":null},{"line":84,"address":[5087224,5086979],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[5087114,5087574,5087524],"length":1,"stats":{"Line":2},"fn_name":null},{"line":89,"address":[5088040,5087883],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[5087532],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[5088473,5088340],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[5087991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[5088450],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[5088784],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[5088870],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[5088809],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[5088862],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[5129080,5089186],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[5089288,5089483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":119,"address":[5089243],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[5089784,5089394,5129110],"length":1,"stats":{"Line":2},"fn_name":null},{"line":129,"address":[5089853,5090023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[5089808],"length":1,"stats":{"Line":1},"fn_name":null},{"line":136,"address":[5090324,5089959,5090493],"length":1,"stats":{"Line":2},"fn_name":null},{"line":137,"address":[5090429,5090984,5090794],"length":1,"stats":{"Line":2},"fn_name":null},{"line":141,"address":[5091285,5090919,5129140],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[5091529,5091361],"length":1,"stats":{"Line":1},"fn_name":null},{"line":143,"address":[5091309],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[5091484,5129170,5091830],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[5092061,5091906],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[5091854],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[5092012,5092354,5092548],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[5093012,5092849],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[5092506],"length":1,"stats":{"Line":1},"fn_name":null},{"line":160,"address":[5093467,5092963,5093313],"length":1,"stats":{"Line":2},"fn_name":null},{"line":163,"address":[5093418,5093767,5093908],"length":1,"stats":{"Line":2},"fn_name":null},{"line":164,"address":[5094269],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[5094217,5093859],"length":1,"stats":{"Line":2},"fn_name":null},{"line":166,"address":[5094293,5094437],"length":1,"stats":{"Line":1},"fn_name":null},{"line":170,"address":[5094746,5094902],"length":1,"stats":{"Line":1},"fn_name":null},{"line":171,"address":[5094395],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[5095359,5095202],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[5094853],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[5095668,5095827],"length":1,"stats":{"Line":1},"fn_name":null},{"line":180,"address":[5095312],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[5096127,5096260],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[5095773],"length":1,"stats":{"Line":1},"fn_name":null},{"line":188,"address":[5096237],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[5096571],"length":1,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[5096657],"length":1,"stats":{"Line":1},"fn_name":null},{"line":196,"address":[5096596],"length":1,"stats":{"Line":1},"fn_name":null},{"line":197,"address":[5096649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[5096956,5129200],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[5097265,5097102],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[5097057],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[5097566,5097736],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[5097208],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[5098206,5098037,5097672],"length":1,"stats":{"Line":2},"fn_name":null},{"line":223,"address":[5098701,5098142,5098507],"length":1,"stats":{"Line":2},"fn_name":null},{"line":228,"address":[5129230,5099002,5098612],"length":1,"stats":{"Line":2},"fn_name":null},{"line":229,"address":[5099078,5099248],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[5099026],"length":1,"stats":{"Line":1},"fn_name":null},{"line":234,"address":[5099704,5099549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[5099184],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[5099997,5099655,5100191],"length":1,"stats":{"Line":2},"fn_name":null},{"line":242,"address":[5100492,5100695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":243,"address":[5100149],"length":1,"stats":{"Line":1},"fn_name":null},{"line":248,"address":[5100996,5100606,5129260],"length":1,"stats":{"Line":2},"fn_name":null},{"line":249,"address":[5101057,5101212],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[5101020],"length":1,"stats":{"Line":1},"fn_name":null},{"line":255,"address":[5101163,5101667,5101512],"length":1,"stats":{"Line":2},"fn_name":null},{"line":258,"address":[5101623],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[5102050],"length":1,"stats":{"Line":1},"fn_name":null},{"line":260,"address":[5101960],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[5102226,5102074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":265,"address":[5102691,5102535],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[5102184],"length":1,"stats":{"Line":1},"fn_name":null},{"line":269,"address":[5103183,5102991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":270,"address":[5102642],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[5129290,5103492,5103101],"length":1,"stats":{"Line":2},"fn_name":null},{"line":277,"address":[5103718,5103558],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[5103516],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[5104060,5104011,5104186],"length":1,"stats":{"Line":2},"fn_name":null},{"line":283,"address":[5103664],"length":1,"stats":{"Line":1},"fn_name":null},{"line":284,"address":[5104019],"length":1,"stats":{"Line":1},"fn_name":null},{"line":287,"address":[5104163],"length":1,"stats":{"Line":1},"fn_name":null},{"line":293,"address":[5104497],"length":1,"stats":{"Line":1},"fn_name":null},{"line":294,"address":[5104583],"length":1,"stats":{"Line":1},"fn_name":null},{"line":295,"address":[5104522],"length":1,"stats":{"Line":1},"fn_name":null},{"line":296,"address":[5104575],"length":1,"stats":{"Line":1},"fn_name":null},{"line":306,"address":[5104882,5129320],"length":1,"stats":{"Line":1},"fn_name":null},{"line":307,"address":[5105028,5105191],"length":1,"stats":{"Line":1},"fn_name":null},{"line":308,"address":[5104983],"length":1,"stats":{"Line":1},"fn_name":null},{"line":314,"address":[5105492,5105662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":315,"address":[5105134],"length":1,"stats":{"Line":1},"fn_name":null},{"line":321,"address":[5105598,5105963,5106132],"length":1,"stats":{"Line":2},"fn_name":null},{"line":322,"address":[5106068,5106627,5106433],"length":1,"stats":{"Line":2},"fn_name":null},{"line":327,"address":[5106928,5129350,5106538],"length":1,"stats":{"Line":2},"fn_name":null},{"line":328,"address":[5107004,5107174],"length":1,"stats":{"Line":1},"fn_name":null},{"line":329,"address":[5106952],"length":1,"stats":{"Line":1},"fn_name":null},{"line":332,"address":[5107475,5107649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":333,"address":[5107110],"length":1,"stats":{"Line":1},"fn_name":null},{"line":340,"address":[5107605],"length":1,"stats":{"Line":1},"fn_name":null},{"line":341,"address":[5107971,5108173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":342,"address":[5107942],"length":1,"stats":{"Line":1},"fn_name":null},{"line":346,"address":[5108098],"length":1,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[5129380,5108482,5108135],"length":1,"stats":{"Line":2},"fn_name":null},{"line":349,"address":[5108755,5108535],"length":1,"stats":{"Line":1},"fn_name":null},{"line":350,"address":[5108506],"length":1,"stats":{"Line":1},"fn_name":null},{"line":354,"address":[5108659],"length":1,"stats":{"Line":1},"fn_name":null},{"line":355,"address":[5108679,5129410,5109066],"length":1,"stats":{"Line":2},"fn_name":null},{"line":358,"address":[5109183,5109338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":359,"address":[5109146],"length":1,"stats":{"Line":1},"fn_name":null},{"line":364,"address":[5109289,5109793,5109638],"length":1,"stats":{"Line":2},"fn_name":null},{"line":367,"address":[5109749],"length":1,"stats":{"Line":1},"fn_name":null},{"line":368,"address":[5110176],"length":1,"stats":{"Line":1},"fn_name":null},{"line":369,"address":[5110086],"length":1,"stats":{"Line":1},"fn_name":null},{"line":370,"address":[5110200,5110352],"length":1,"stats":{"Line":1},"fn_name":null},{"line":374,"address":[5110817,5110661],"length":1,"stats":{"Line":1},"fn_name":null},{"line":375,"address":[5110310],"length":1,"stats":{"Line":1},"fn_name":null},{"line":378,"address":[5111117,5111306],"length":1,"stats":{"Line":1},"fn_name":null},{"line":379,"address":[5110768],"length":1,"stats":{"Line":1},"fn_name":null},{"line":383,"address":[5129470,5111227,5111625],"length":1,"stats":{"Line":2},"fn_name":null},{"line":386,"address":[5111747,5111939],"length":1,"stats":{"Line":1},"fn_name":null},{"line":387,"address":[5111705],"length":1,"stats":{"Line":1},"fn_name":null},{"line":391,"address":[5111853],"length":1,"stats":{"Line":1},"fn_name":null},{"line":392,"address":[5112232,5112372],"length":1,"stats":{"Line":1},"fn_name":null},{"line":393,"address":[5111885],"length":1,"stats":{"Line":1},"fn_name":null},{"line":397,"address":[5112349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":403,"address":[5112678],"length":1,"stats":{"Line":1},"fn_name":null},{"line":414,"address":[5113030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":416,"address":[5113050,5129530],"length":1,"stats":{"Line":1},"fn_name":null},{"line":420,"address":[5113487,5113324],"length":1,"stats":{"Line":1},"fn_name":null},{"line":421,"address":[5113279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":427,"address":[5113958,5113788],"length":1,"stats":{"Line":1},"fn_name":null},{"line":428,"address":[5113430],"length":1,"stats":{"Line":1},"fn_name":null},{"line":433,"address":[5113894,5114259,5114428],"length":1,"stats":{"Line":2},"fn_name":null},{"line":434,"address":[5114364,5114925,5114729],"length":1,"stats":{"Line":2},"fn_name":null},{"line":437,"address":[5115236,5129620,5114866,5114834],"length":1,"stats":{"Line":3},"fn_name":null},{"line":438,"address":[5114850],"length":1,"stats":{"Line":1},"fn_name":null},{"line":440,"address":[5115366,5115536],"length":1,"stats":{"Line":1},"fn_name":null},{"line":441,"address":[5115314],"length":1,"stats":{"Line":1},"fn_name":null},{"line":445,"address":[5115837,5116011],"length":1,"stats":{"Line":1},"fn_name":null},{"line":446,"address":[5115472],"length":1,"stats":{"Line":1},"fn_name":null},{"line":452,"address":[5115967],"length":1,"stats":{"Line":1},"fn_name":null},{"line":453,"address":[5116549,5116333],"length":1,"stats":{"Line":1},"fn_name":null},{"line":454,"address":[5116304],"length":1,"stats":{"Line":1},"fn_name":null},{"line":457,"address":[5116460],"length":1,"stats":{"Line":1},"fn_name":null},{"line":459,"address":[5116858,5129680,5116480],"length":1,"stats":{"Line":2},"fn_name":null},{"line":460,"address":[5116911,5117161],"length":1,"stats":{"Line":1},"fn_name":null},{"line":461,"address":[5116882],"length":1,"stats":{"Line":1},"fn_name":null},{"line":471,"address":[5117035],"length":1,"stats":{"Line":1},"fn_name":null},{"line":472,"address":[5117065],"length":1,"stats":{"Line":1},"fn_name":null},{"line":473,"address":[5129710,5117478,5117085],"length":1,"stats":{"Line":2},"fn_name":null},{"line":475,"address":[5117454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":477,"address":[5117658,5117813],"length":1,"stats":{"Line":1},"fn_name":null},{"line":478,"address":[5117621],"length":1,"stats":{"Line":1},"fn_name":null},{"line":483,"address":[5118250,5118113,5117764],"length":1,"stats":{"Line":2},"fn_name":null},{"line":485,"address":[5118205],"length":1,"stats":{"Line":1},"fn_name":null},{"line":486,"address":[5118633],"length":1,"stats":{"Line":1},"fn_name":null},{"line":487,"address":[5118543],"length":1,"stats":{"Line":1},"fn_name":null},{"line":488,"address":[5118809,5118657],"length":1,"stats":{"Line":1},"fn_name":null},{"line":492,"address":[5119274,5119118],"length":1,"stats":{"Line":1},"fn_name":null},{"line":493,"address":[5118767],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[5119731,5119574],"length":1,"stats":{"Line":1},"fn_name":null},{"line":497,"address":[5119225],"length":1,"stats":{"Line":1},"fn_name":null},{"line":501,"address":[5120231,5120040],"length":1,"stats":{"Line":1},"fn_name":null},{"line":502,"address":[5119684],"length":1,"stats":{"Line":1},"fn_name":null},{"line":505,"address":[5120145],"length":1,"stats":{"Line":1},"fn_name":null},{"line":506,"address":[5120524,5120701],"length":1,"stats":{"Line":1},"fn_name":null},{"line":507,"address":[5120177],"length":1,"stats":{"Line":1},"fn_name":null},{"line":513,"address":[5120641,5121002],"length":1,"stats":{"Line":2},"fn_name":null},{"line":515,"address":[5121060],"length":1,"stats":{"Line":1},"fn_name":null},{"line":521,"address":[5121075],"length":1,"stats":{"Line":1},"fn_name":null},{"line":529,"address":[5129800,5121417],"length":1,"stats":{"Line":1},"fn_name":null},{"line":530,"address":[5121728,5121565],"length":1,"stats":{"Line":1},"fn_name":null},{"line":531,"address":[5121520],"length":1,"stats":{"Line":1},"fn_name":null},{"line":537,"address":[5121671,5122029,5122198],"length":1,"stats":{"Line":2},"fn_name":null},{"line":541,"address":[5122668,5122499,5122134],"length":1,"stats":{"Line":2},"fn_name":null},{"line":542,"address":[5122604,5123138,5122969],"length":1,"stats":{"Line":2},"fn_name":null},{"line":545,"address":[5123712,5123542],"length":1,"stats":{"Line":1},"fn_name":null},{"line":546,"address":[5123074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":547,"address":[5123431,5129830],"length":1,"stats":{"Line":1},"fn_name":null},{"line":550,"address":[5124013,5123648,5124167],"length":1,"stats":{"Line":2},"fn_name":null},{"line":554,"address":[5124460,5124619],"length":1,"stats":{"Line":1},"fn_name":null},{"line":555,"address":[5124118],"length":1,"stats":{"Line":1},"fn_name":null},{"line":559,"address":[5125083,5124920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":560,"address":[5124577],"length":1,"stats":{"Line":1},"fn_name":null},{"line":565,"address":[5125538,5125384,5125034],"length":1,"stats":{"Line":2},"fn_name":null},{"line":568,"address":[5125489,5125838,5125979],"length":1,"stats":{"Line":2},"fn_name":null},{"line":570,"address":[5126333],"length":1,"stats":{"Line":1},"fn_name":null},{"line":571,"address":[5126288,5125930],"length":1,"stats":{"Line":2},"fn_name":null},{"line":572,"address":[5126357,5126557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":576,"address":[5126866,5127022],"length":1,"stats":{"Line":1},"fn_name":null},{"line":577,"address":[5126515],"length":1,"stats":{"Line":1},"fn_name":null},{"line":580,"address":[5127322,5127479],"length":1,"stats":{"Line":1},"fn_name":null},{"line":581,"address":[5126973],"length":1,"stats":{"Line":1},"fn_name":null},{"line":586,"address":[5127788,5127947],"length":1,"stats":{"Line":1},"fn_name":null},{"line":587,"address":[5127432],"length":1,"stats":{"Line":1},"fn_name":null},{"line":591,"address":[5128228,5128404],"length":1,"stats":{"Line":1},"fn_name":null},{"line":592,"address":[5127893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":596,"address":[5128680,5128747],"length":1,"stats":{"Line":2},"fn_name":null},{"line":597,"address":[5128333],"length":1,"stats":{"Line":1},"fn_name":null},{"line":598,"address":[5128672],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":231,"coverable":231},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","liquidity-pools","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, traits::Get, IterableStorageDoubleMap};\nuse minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\nuse orml_traits::MultiCurrency;\nuse pallet_traits::Borrowing;\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::{\n\ttraits::{AccountIdConversion, CheckedDiv, CheckedMul, Zero},\n\tDispatchError, DispatchResult, FixedPointNumber, ModuleId, RuntimeDebug,\n};\nuse sp_std::{cmp::Ordering, result, vec::Vec};\n\n/// Pool metadata\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Default)]\npub struct Pool {\n\t/// The amount of underlying currently loaned out by the pool, and the amount upon which\n\t/// interest is accumulated to suppliers of the pool.\n\tpub total_borrowed: Balance,\n\n\t/// Accumulator of the total earned interest rate since the opening of the pool.\n\tpub borrow_index: Rate,\n\n\t/// Total amount of insurance of the underlying held in this pool.\n\tpub total_insurance: Balance,\n}\n\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, RuntimeDebug, Eq, PartialEq, Default)]\npub struct PoolUserData {\n\t/// Total balance (with accrued interest), after applying the most\n\t/// recent balance-changing action.\n\tpub total_borrowed: Balance,\n\n\t/// Global borrow_index as of the most recent balance-changing action.\n\tpub interest_index: Rate,\n\n\t/// Wheter or not pool as a collateral.\n\tpub collateral: bool,\n}\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\npub trait Trait: frame_system::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n\n\t/// The Liquidity Pool's module id, keep all assets in Pools.\n\ttype ModuleId: Get\u003cModuleId\u003e;\n\n\t/// The `MultiCurrency` implementation.\n\ttype MultiCurrency: MultiCurrency\u003cSelf::AccountId, Balance = Balance, CurrencyId = CurrencyId\u003e;\n\n\t/// Start exchange rate.\n\ttype InitialExchangeRate: Get\u003cRate\u003e;\n\n\t/// Enabled currency pairs.\n\ttype EnabledCurrencyPair: Get\u003cVec\u003cCurrencyPair\u003e\u003e;\n}\n\ndecl_event!(\n\tpub enum Event {}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t/// Number overflow in calculation.\n\tNumOverflow,\n\n\t/// The currency is not enabled in protocol.\n\tNotValidUnderlyingAssetId,\n\n\t/// The currency is not enabled in wrapped protocol.\n\tNotValidWrappedTokenId,\n\t}\n}\n\ndecl_storage! {\n\t trait Store for Module\u003cT: Trait\u003e as LiquidityPoolsStorage {\n\t\t /// Liquidity pool information: `(total_borrowed, borrow_index, total_insurance)`.\n\t\tpub Pools get(fn pools) config(): map hasher(blake2_128_concat) CurrencyId =\u003e Pool;\n\n\t\t/// Information about the user of the liquidity pool: `(total_borrowed, interest_index, collateral)`.\n\t\tpub PoolUserDates get(fn pool_user_data) config(): double_map\n\t\t\thasher(blake2_128_concat) CurrencyId,\n\t\t\thasher(blake2_128_concat) T::AccountId =\u003e PoolUserData;\n\t}\n}\n\ndecl_module! {\n\t\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\t\ttype Error = Error\u003cT\u003e;\n\t\t\tfn deposit_event() = default;\n\n\t\t\t/// The Liquidity Pool's module id, keep all assets in Pools.\n\t\t\tconst ModuleId: ModuleId = T::ModuleId::get();\n\n\t\t\t/// The Liquidity Pool's account id, keep all assets in Pools.\n\t\t\tconst PoolAccountId: T::AccountId = T::ModuleId::get().into_account();\n\n\t\t\t/// Enabled underlying asset IDs.\n\t\t\tconst EnabledUnderlyingAssetId: Vec\u003cCurrencyId\u003e = T::EnabledCurrencyPair::get()\n\t\t\t\t.iter()\n\t\t\t\t.map(|currency_pair| currency_pair.underlying_id)\n\t\t\t\t.collect();\n\n\t\t\t/// Enabled wrapped token IDs.\n\t\t\tconst EnabledWrappedTokensId: Vec\u003cCurrencyId\u003e = T::EnabledCurrencyPair::get()\n\t\t\t\t.iter()\n\t\t\t\t.map(|currency_pair| currency_pair.wrapped_id)\n\t\t\t\t.collect();\n\t}\n}\n\ntype RateResult = result::Result\u003cRate, DispatchError\u003e;\ntype CurrencyIdResult = result::Result\u003cCurrencyId, DispatchError\u003e;\ntype BalanceResult = result::Result\u003cBalance, DispatchError\u003e;\n\n// Dispatchable calls implementation\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Converts a specified number of underlying assets into wrapped tokens.\n\t/// The calculation is based on the exchange rate.\n\t///\n\t/// - `underlying_asset_id`: CurrencyId of underlying assets to be converted to wrapped tokens.\n\t/// - `underlying_amount`: The amount of underlying assets to be converted to wrapped tokens.\n\t/// Returns `wrapped_amount = underlying_amount / exchange_rate`\n\tpub fn convert_to_wrapped(underlying_asset_id: CurrencyId, underlying_amount: Balance) -\u003e BalanceResult {\n\t\tlet exchange_rate = Self::get_exchange_rate(underlying_asset_id)?;\n\n\t\tlet wrapped_amount = Rate::from_inner(underlying_amount)\n\t\t\t.checked_div(\u0026exchange_rate)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(wrapped_amount)\n\t}\n\n\t/// Converts a specified number of wrapped tokens into underlying assets.\n\t/// The calculation is based on the exchange rate.\n\t///\n\t/// - `wrapped_id`: CurrencyId of the wrapped tokens to be converted to underlying assets.\n\t/// - `wrapped_amount`: The amount of wrapped tokens to be converted to underlying assets.\n\t///\n\t/// Returns `underlying_amount = wrapped_amount * exchange_rate`\n\tpub fn convert_from_wrapped(wrapped_id: CurrencyId, wrapped_amount: Balance) -\u003e BalanceResult {\n\t\tlet underlying_asset_id = Self::get_underlying_asset_id_by_wrapped_id(\u0026wrapped_id)?;\n\t\tlet exchange_rate = Self::get_exchange_rate(underlying_asset_id)?;\n\n\t\tlet underlying_amount = Rate::from_inner(wrapped_amount)\n\t\t\t.checked_mul(\u0026exchange_rate)\n\t\t\t.map(|x| x.into_inner())\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tOk(underlying_amount)\n\t}\n\n\t/// Gets the exchange rate between a mToken and the underlying asset.\n\t/// This function does not accrue interest before calculating the exchange rate.\n\t/// - `underlying_asset_id`: CurrencyId of underlying assets for which the exchange rate\n\t/// is calculated.\n\t///\n\t/// returns `exchange_rate` between a mToken and the underlying asset.\n\tpub fn get_exchange_rate(underlying_asset_id: CurrencyId) -\u003e RateResult {\n\t\tlet wrapped_asset_id = Self::get_wrapped_id_by_underlying_asset_id(\u0026underlying_asset_id)?;\n\t\t// Current the total amount of cash the pool has.\n\t\tlet total_cash = Self::get_pool_available_liquidity(underlying_asset_id);\n\n\t\t// Current total number of tokens in circulation.\n\t\tlet total_supply = T::MultiCurrency::total_issuance(wrapped_asset_id);\n\n\t\t// Current total amount of insurance of the underlying held in this pool.\n\t\tlet total_insurance = Self::get_pool_total_insurance(underlying_asset_id);\n\n\t\t// Current the amount of underlying currently loaned out by the pool.\n\t\tlet total_borrowed = Self::get_pool_total_borrowed(underlying_asset_id);\n\n\t\tlet current_exchange_rate =\n\t\t\tSelf::calculate_exchange_rate(total_cash, total_supply, total_insurance, total_borrowed)?;\n\n\t\tOk(current_exchange_rate)\n\t}\n\n\t/// Calculates the exchange rate from the underlying to the mToken.\n\t/// - `total_cash`: The total amount of cash the pool has.\n\t/// - `total_supply`: Total number of tokens in circulation.\n\t/// - `total_insurance`: Total amount of insurance of the underlying held in the pool.\n\t/// - `total_borrowed`: Total amount of outstanding borrows of the underlying in this pool.\n\t///\n\t/// returns `exchange_rate = (total_cash + total_borrowed - total_insurance) / total_supply`.\n\tfn calculate_exchange_rate(\n\t\ttotal_cash: Balance,\n\t\ttotal_supply: Balance,\n\t\ttotal_insurance: Balance,\n\t\ttotal_borrowed: Balance,\n\t) -\u003e RateResult {\n\t\tlet rate = match total_supply.cmp(\u0026Balance::zero()) {\n\t\t\t// If there are no tokens minted: exchangeRate = InitialExchangeRate.\n\t\t\tOrdering::Equal =\u003e T::InitialExchangeRate::get(),\n\n\t\t\t// Otherwise: exchange_rate = (total_cash + total_borrowed - total_insurance) / total_supply\n\t\t\t_ =\u003e Rate::saturating_from_rational(\n\t\t\t\ttotal_cash\n\t\t\t\t\t.checked_add(total_borrowed)\n\t\t\t\t\t.and_then(|v| v.checked_sub(total_insurance))\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?,\n\t\t\t\ttotal_supply,\n\t\t\t),\n\t\t};\n\n\t\tOk(rate)\n\t}\n\n\t/// Check if enabled underlying asset id.\n\tpub fn is_enabled_underlying_asset_id(underlying_asset_id: CurrencyId) -\u003e bool {\n\t\tT::EnabledCurrencyPair::get()\n\t\t\t.iter()\n\t\t\t.any(|pair| pair.underlying_id == underlying_asset_id)\n\t}\n\n\t/// Gets the wrapped token ID from the underlying asset ID.\n\tpub fn get_wrapped_id_by_underlying_asset_id(asset_id: \u0026CurrencyId) -\u003e CurrencyIdResult {\n\t\tlet enabled_currency_pair = T::EnabledCurrencyPair::get();\n\n\t\tlet currency_pair = *enabled_currency_pair\n\t\t\t.iter()\n\t\t\t.find(|currency_pair| currency_pair.underlying_id == *asset_id)\n\t\t\t.ok_or(Error::\u003cT\u003e::NotValidUnderlyingAssetId)?;\n\n\t\tOk(currency_pair.wrapped_id)\n\t}\n\n\t/// Gets the underlying asset ID from the wrapped token ID.\n\tpub fn get_underlying_asset_id_by_wrapped_id(wrapped_id: \u0026CurrencyId) -\u003e CurrencyIdResult {\n\t\tlet enabled_currency_pair = T::EnabledCurrencyPair::get();\n\n\t\tlet currency_pair = *enabled_currency_pair\n\t\t\t.iter()\n\t\t\t.find(|currency_pair| currency_pair.wrapped_id == *wrapped_id)\n\t\t\t.ok_or(Error::\u003cT\u003e::NotValidWrappedTokenId)?;\n\n\t\tOk(currency_pair.underlying_id)\n\t}\n}\n\n// Storage setters for LiquidityPools\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Sets the total borrowed value in the pool.\n\tfn set_pool_total_borrowed(pool_id: CurrencyId, new_total_borrows: Balance) -\u003e DispatchResult {\n\t\tPools::mutate(pool_id, |pool| pool.total_borrowed = new_total_borrows);\n\t\tOk(())\n\t}\n\n\t/// Sets the borrow index in the pool.\n\tpub fn set_pool_borrow_index(pool_id: CurrencyId, new_borrow_index: Rate) -\u003e DispatchResult {\n\t\tPools::mutate(pool_id, |pool| pool.borrow_index = new_borrow_index);\n\t\tOk(())\n\t}\n\n\t/// Sets the total insurance in the pool.\n\tpub fn set_pool_total_insurance(pool_id: CurrencyId, new_total_insurance: Balance) -\u003e DispatchResult {\n\t\tPools::mutate(pool_id, |r| r.total_insurance = new_total_insurance);\n\t\tOk(())\n\t}\n\n\t/// Sets the total borrowed and interest index for user.\n\tfn set_user_total_borrowed_and_interest_index(\n\t\twho: \u0026T::AccountId,\n\t\tpool_id: CurrencyId,\n\t\tnew_total_borrows: Balance,\n\t\tnew_interest_index: Rate,\n\t) -\u003e DispatchResult {\n\t\tPoolUserDates::\u003cT\u003e::mutate(pool_id, who, |p| {\n\t\t\tp.total_borrowed = new_total_borrows;\n\t\t\tp.interest_index = new_interest_index;\n\t\t});\n\t\tOk(())\n\t}\n\n\t/// Sets the total borrowed and the total insurance in the pool.\n\tpub fn set_accrual_interest_params(\n\t\tunderlying_asset_id: CurrencyId,\n\t\tnew_total_borrow_balance: Balance,\n\t\tnew_total_insurance: Balance,\n\t) -\u003e DispatchResult {\n\t\tPools::mutate(underlying_asset_id, |r| {\n\t\t\tr.total_borrowed = new_total_borrow_balance;\n\t\t\tr.total_insurance = new_total_insurance;\n\t\t});\n\t\tOk(())\n\t}\n\n\t/// Sets the parameter `collateral` to `true`.\n\tpub fn enable_as_collateral_internal(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e DispatchResult {\n\t\tPoolUserDates::\u003cT\u003e::mutate(pool_id, who, |p| p.collateral = true);\n\t\tOk(())\n\t}\n\n\t/// Sets the parameter `collateral` to `false`.\n\tpub fn disable_collateral_internal(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e DispatchResult {\n\t\tPoolUserDates::\u003cT\u003e::mutate(pool_id, who, |p| p.collateral = false);\n\t\tOk(())\n\t}\n}\n\n// Storage getters for LiquidityPools\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Gets module account id.\n\tpub fn pools_account_id() -\u003e T::AccountId {\n\t\tT::ModuleId::get().into_account()\n\t}\n\n\t/// Gets current the total amount of cash the pool has.\n\tpub fn get_pool_available_liquidity(pool_id: CurrencyId) -\u003e Balance {\n\t\tlet module_account_id = Self::pools_account_id();\n\t\tT::MultiCurrency::free_balance(pool_id, \u0026module_account_id)\n\t}\n\n\t/// Gets current the amount of underlying currently loaned out by the pool.\n\tpub fn get_pool_total_borrowed(pool_id: CurrencyId) -\u003e Balance {\n\t\tSelf::pools(pool_id).total_borrowed\n\t}\n\n\t/// Gets current total amount of insurance of the underlying held in this pool.\n\tpub fn get_pool_total_insurance(pool_id: CurrencyId) -\u003e Balance {\n\t\tSelf::pools(pool_id).total_insurance\n\t}\n\n\t/// Accumulator of the total earned interest rate since the opening of the pool\n\tpub fn get_pool_borrow_index(pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::pools(pool_id).borrow_index\n\t}\n\n\t/// Global borrow_index as of the most recent balance-changing action\n\tpub fn get_user_borrow_index(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e Rate {\n\t\tSelf::pool_user_data(pool_id, who).interest_index\n\t}\n\n\t/// Gets total user borrowing.\n\tpub fn get_user_total_borrowed(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e Balance {\n\t\tSelf::pool_user_data(pool_id, who).total_borrowed\n\t}\n\n\t/// Checks if the user has enabled the pool as collateral.\n\tpub fn check_user_available_collateral(who: \u0026T::AccountId, pool_id: CurrencyId) -\u003e bool {\n\t\tSelf::pool_user_data(pool_id, who).collateral\n\t}\n\n\t/// Check if pool exists\n\tpub fn pool_exists(underlying_asset_id: \u0026CurrencyId) -\u003e bool {\n\t\tPools::contains_key(underlying_asset_id)\n\t}\n\n\t// TODO: Maybe implement using a binary tree?\n\tpub fn get_pool_members(underlying_asset_id: CurrencyId) -\u003e result::Result\u003cVec\u003cT::AccountId\u003e, DispatchError\u003e {\n\t\tlet user_vec: Vec\u003cT::AccountId\u003e = PoolUserDates::\u003cT\u003e::iter_prefix(underlying_asset_id)\n\t\t\t.map(|(account, _)| account)\n\t\t\t.collect();\n\t\tOk(user_vec)\n\t}\n}\n\n// Trait Borrowing for LiquidityPools\nimpl\u003cT: Trait\u003e Borrowing\u003cT::AccountId\u003e for Module\u003cT\u003e {\n\t/// Updates the new borrower balance and pool total borrow balances during the borrow operation.\n\t/// Also sets the global borrow_index to user interest index.\n\t/// - `who`: The AccountId whose borrow balance should be calculated.\n\t/// - `pool_id`: PoolID whose total borrow balance should be calculated.\n\t/// - `borrow_amount`: The amount of the underlying asset to borrow.\n\t/// - `account_borrows`: The borrow balance of account.\n\t///\n\t/// calculates: `account_borrows_new = account_borrows + borrow_amount`,\n\t///             `total_borrows_new = total_borrows + borrow_amount`.\n\tfn update_state_on_borrow(\n\t\twho: \u0026T::AccountId,\n\t\tpool_id: CurrencyId,\n\t\tborrow_amount: Balance,\n\t\taccount_borrows: Balance,\n\t) -\u003e DispatchResult {\n\t\tlet pool_borrow_index = Self::get_pool_borrow_index(pool_id);\n\t\tlet pool_total_borrowed = Self::get_pool_total_borrowed(pool_id);\n\n\t\t// Calculate the new borrower and total borrow balances, failing on overflow:\n\t\t// account_borrows_new = account_borrows + borrow_amount\n\t\t// total_borrows_new = total_borrows + borrow_amount\n\t\tlet account_borrow_new = account_borrows\n\t\t\t.checked_add(borrow_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\tlet new_total_borrows = pool_total_borrowed\n\t\t\t.checked_add(borrow_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t// Write the previously calculated values into storage.\n\t\tSelf::set_pool_total_borrowed(pool_id, new_total_borrows)?;\n\n\t\tSelf::set_user_total_borrowed_and_interest_index(\u0026who, pool_id, account_borrow_new, pool_borrow_index)?;\n\n\t\tOk(())\n\t}\n\n\t/// Updates the new borrower balance and pool total borrow balances during the repay operation.\n\t/// Also sets the global borrow_index to user interest index.\n\t/// - `who`: The AccountId whose borrow balance should be calculated.\n\t/// - `pool_id`: PoolID whose total borrow balance should be calculated.\n\t/// - `repay_amount`: The amount of the underlying asset to repay.\n\t/// - `account_borrows`: The borrow balance of account.\n\t///\n\t/// calculates: `account_borrows_new = account_borrows - borrow_amount`,\n\t///             `total_borrows_new = total_borrows - borrow_amount`.\n\tfn update_state_on_repay(\n\t\twho: \u0026T::AccountId,\n\t\tpool_id: CurrencyId,\n\t\trepay_amount: Balance,\n\t\taccount_borrows: Balance,\n\t) -\u003e DispatchResult {\n\t\tlet pool_borrow_index = Self::get_pool_borrow_index(pool_id);\n\n\t\t// Calculate the new borrower and total borrow balances, failing on overflow:\n\t\t// account_borrows_new = account_borrows - repay_amount\n\t\t// total_borrows_new = total_borrows - repay_amount\n\t\tlet account_borrow_new = account_borrows\n\t\t\t.checked_sub(repay_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\tlet total_borrows_new = Self::get_pool_total_borrowed(pool_id)\n\t\t\t.checked_sub(repay_amount)\n\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t// Write the previously calculated values into storage.\n\t\tSelf::set_pool_total_borrowed(pool_id, total_borrows_new)?;\n\t\tSelf::set_user_total_borrowed_and_interest_index(\u0026who, pool_id, account_borrow_new, pool_borrow_index)?;\n\n\t\tOk(())\n\t}\n}\n","traces":[{"line":84,"address":[4290608,4290944,4290432,4290704,4290512,4290528,4290624,4290631,4290960,4290837,4290928,4290896,4290981,4290816,4290711],"length":1,"stats":{"Line":441},"fn_name":"module_prefix"},{"line":102,"address":[4259189],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[4259269,4259303],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[4259809,4259743,4259698],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[4259965,4259952],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}\u003cnode_minterest_runtime::Runtime\u003e"},{"line":114,"address":[4259439,4259394,4259505],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[4259648,4259661],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}\u003cnode_minterest_runtime::Runtime\u003e"},{"line":133,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":134,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":136,"address":[],"length":0,"stats":{"Line":57},"fn_name":null},{"line":137,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[],"length":0,"stats":{"Line":27},"fn_name":null},{"line":139,"address":[],"length":0,"stats":{"Line":26},"fn_name":null},{"line":141,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":151,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":152,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":153,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":155,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":156,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":158,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":160,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":169,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":172,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":175,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":178,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":181,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":183,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":184,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":196,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":202,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":204,"address":[],"length":0,"stats":{"Line":29},"fn_name":null},{"line":208,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":209,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":211,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":212,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":216,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":220,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":221,"address":[],"length":0,"stats":{"Line":66},"fn_name":null},{"line":223,"address":[],"length":0,"stats":{"Line":50},"fn_name":null},{"line":227,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":228,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":230,"address":[],"length":0,"stats":{"Line":63},"fn_name":null},{"line":231,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[],"length":0,"stats":{"Line":39},"fn_name":null},{"line":233,"address":[],"length":0,"stats":{"Line":29},"fn_name":null},{"line":235,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":239,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":240,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":242,"address":[],"length":0,"stats":{"Line":46},"fn_name":null},{"line":243,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[],"length":0,"stats":{"Line":27},"fn_name":null},{"line":245,"address":[],"length":0,"stats":{"Line":25},"fn_name":null},{"line":247,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":254,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":255,"address":[],"length":0,"stats":{"Line":25},"fn_name":null},{"line":256,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":260,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":261,"address":[],"length":0,"stats":{"Line":47},"fn_name":null},{"line":262,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":266,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":267,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":268,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":272,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":278,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":279,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":280,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":282,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":286,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":291,"address":[],"length":0,"stats":{"Line":32},"fn_name":null},{"line":292,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":293,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":295,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":299,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":300,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":301,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":305,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":306,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":307,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":314,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":315,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":319,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":320,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":321,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":325,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":326,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":330,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":331,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":335,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":336,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":340,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":341,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":345,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":346,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":350,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":351,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":355,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":356,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":360,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":361,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":362,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":364,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":379,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":385,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":386,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":391,"address":[],"length":0,"stats":{"Line":33},"fn_name":null},{"line":392,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":393,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":394,"address":[],"length":0,"stats":{"Line":20},"fn_name":null},{"line":395,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":396,"address":[],"length":0,"stats":{"Line":22},"fn_name":null},{"line":399,"address":[],"length":0,"stats":{"Line":22},"fn_name":null},{"line":401,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":403,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":415,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":421,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":426,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":427,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":428,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":429,"address":[],"length":0,"stats":{"Line":20},"fn_name":null},{"line":430,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":431,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":434,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":435,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":437,"address":[],"length":0,"stats":{"Line":5},"fn_name":null}],"covered":108,"coverable":128},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","liquidity-pools","src","mock.rs"],"content":"#![cfg(test)]\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\npub use minterest_primitives::{Balance, CurrencyId, CurrencyPair};\nuse orml_currencies::Currency;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\nuse crate::GenesisConfig;\n\nmod liquidity_pools {\n\tpub use crate::Event;\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\tliquidity_pools,\n\t\torml_currencies\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Test;\n\n// For testing the module, we construct most of a mock runtime. This means\n// first constructing a configuration type (`Test`) which `impl`s each of the\n// configuration traits of modules we want to use.\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n}\n\npub type AccountId = u32;\nimpl frame_system::Trait for Test {\n\ttype BaseCallFilter = ();\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\t// type Hash = Hash;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = u32;\n\t// type Lookup = IdentityLookup\u003cAccountId\u003e;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\t// type Header = generic::Header\u003cBlockNumber, BlakeTwo256\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\t// type DbWeight = RocksDbWeight;\n\ttype DbWeight = ();\n\t// type BlockExecutionWeight = BlockExecutionWeight;\n\ttype BlockExecutionWeight = ();\n\t// type ExtrinsicBaseWeight = ExtrinsicBaseWeight;\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\t// type Version = Version;\n\ttype Version = ();\n\t// type PalletInfo = PalletInfo;\n\ttype PalletInfo = ();\n\t// type AccountData = pallet_balances::AccountData\u003cBalance\u003e;\n\ttype AccountData = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype SystemWeightInfo = ();\n}\n\nimpl orml_tokens::Trait for Test {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\ntype NativeCurrency = Currency\u003cTest, GetNativeCurrencyId\u003e;\n\nimpl orml_currencies::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype NativeCurrency = NativeCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\n\npub type System = frame_system::Module\u003cTest\u003e;\n\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n\tpools: Vec\u003c(CurrencyId, Pool)\u003e,\n\tpool_user_data: Vec\u003c(CurrencyId, AccountId, PoolUserData)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t\tpools: vec![],\n\t\t\tpool_user_data: vec![],\n\t\t}\n\t}\n}\n\ntype Amount = i128;\npub type TestPools = Module\u003cTest\u003e;\npub const ALICE: AccountId = 1;\npub const DOLLARS: Balance = 1_000_000_000_000_000_000;\npub const ONE_HUNDRED_DOLLARS: Balance = 100 * DOLLARS;\npub const ONE_HUNDRED: Balance = 100;\npub const TEN_THOUSAND: Balance = 10_000 * DOLLARS;\n\nimpl ExtBuilder {\n\tpub fn user_balance(mut self, user: AccountId, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts.push((user, currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn pool_balance(mut self, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts\n\t\t\t.push((TestPools::pools_account_id(), currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn pool_with_params(\n\t\tmut self,\n\t\tpool_id: CurrencyId,\n\t\ttotal_borrowed: Balance,\n\t\tborrow_index: Rate,\n\t\ttotal_insurance: Balance,\n\t) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tborrow_index,\n\t\t\t\ttotal_insurance,\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_user_data_with_params(\n\t\tmut self,\n\t\tpool_id: CurrencyId,\n\t\tuser: AccountId,\n\t\ttotal_borrowed: Balance,\n\t\tinterest_index: Rate,\n\t\tcollateral: bool,\n\t) -\u003e Self {\n\t\tself.pool_user_data.push((\n\t\t\tpool_id,\n\t\t\tuser,\n\t\t\tPoolUserData {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tinterest_index,\n\t\t\t\tcollateral,\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_mock(mut self, pool_id: CurrencyId) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed: Balance::default(),\n\t\t\t\tborrow_index: Rate::default(),\n\t\t\t\ttotal_insurance: Balance::default(),\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn pool_total_borrowed(mut self, pool_id: CurrencyId, total_borrowed: Balance) -\u003e Self {\n\t\tself.pools.push((\n\t\t\tpool_id,\n\t\t\tPool {\n\t\t\t\ttotal_borrowed,\n\t\t\t\tborrow_index: Rate::one(),\n\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t},\n\t\t));\n\t\tself\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cTest\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tGenesisConfig::\u003cTest\u003e {\n\t\t\tpools: self.pools,\n\t\t\tpool_user_data: self.pool_user_data,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tlet mut ext = sp_io::TestExternalities::new(t);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[{"line":16,"address":[5278245,5278176],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[5278318,5278537,5278483,5278429],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[4428641],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[4428676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[4428692],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[4428740],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[4429161,4428822,4429056],"length":1,"stats":{"Line":6},"fn_name":null},{"line":109,"address":[4428840],"length":1,"stats":{"Line":3},"fn_name":null},{"line":110,"address":[4428899],"length":1,"stats":{"Line":3},"fn_name":null},{"line":111,"address":[4428954],"length":1,"stats":{"Line":3},"fn_name":null},{"line":112,"address":[4429009],"length":1,"stats":{"Line":3},"fn_name":null},{"line":131,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":133,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":134,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":149,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":150,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":151,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":154,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":156,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":157,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":160,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":168,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":170,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":187,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":200,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":202,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":212,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":226,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":228,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":233,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":235,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":238,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":239,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":240,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":46,"coverable":65},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","liquidity-pools","src","tests.rs"],"content":"#![cfg(test)]\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_err, assert_noop, assert_ok};\nuse sp_arithmetic::FixedPointNumber;\n\nfn dollars\u003cT: Into\u003cu128\u003e\u003e(d: T) -\u003e Balance {\n\t1_000_000_000_000_000_000_u128.saturating_mul(d.into())\n}\n\n#[test]\nfn set_pool_total_borrowed_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set pool_total_borrowed eq 100 DOT\n\t\tassert_ok!(TestPools::set_pool_total_borrowed(CurrencyId::DOT, ONE_HUNDRED_DOLLARS));\n\t\tassert_eq!(\u003cPools\u003e::get(CurrencyId::DOT).total_borrowed, ONE_HUNDRED_DOLLARS);\n\t});\n}\n\n#[test]\nfn set_pool_borrow_index_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set pool_borrow_index eq 0.25\n\t\tassert_ok!(TestPools::set_pool_borrow_index(\n\t\t\tCurrencyId::DOT,\n\t\t\tRate::saturating_from_rational(25, 100)\n\t\t));\n\t\tassert_eq!(\n\t\t\t\u003cPools\u003e::get(CurrencyId::DOT).borrow_index,\n\t\t\tRate::saturating_from_rational(25, 100)\n\t\t);\n\t});\n}\n\n#[test]\nfn set_pool_total_insurance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set pool_total_insurance eq 100 DOT.\n\t\tassert_ok!(TestPools::set_pool_total_insurance(\n\t\t\tCurrencyId::DOT,\n\t\t\tONE_HUNDRED_DOLLARS\n\t\t));\n\t\tassert_eq!(\u003cPools\u003e::get(CurrencyId::DOT).total_insurance, ONE_HUNDRED_DOLLARS);\n\t});\n}\n\n#[test]\nfn set_user_total_borrowed_and_interest_index_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set user_total_borrowed eq 100 DOT and user_interest_index eq 0.33.\n\t\tassert_ok!(TestPools::set_user_total_borrowed_and_interest_index(\n\t\t\t\u0026ALICE,\n\t\t\tCurrencyId::DOT,\n\t\t\tONE_HUNDRED_DOLLARS,\n\t\t\tRate::saturating_from_rational(33, 100)\n\t\t));\n\t\tassert_eq!(\n\t\t\t\u003cPoolUserDates\u003cTest\u003e\u003e::get(CurrencyId::DOT, ALICE).total_borrowed,\n\t\t\tONE_HUNDRED_DOLLARS\n\t\t);\n\t\tassert_eq!(\n\t\t\t\u003cPoolUserDates\u003cTest\u003e\u003e::get(CurrencyId::DOT, ALICE).interest_index,\n\t\t\tRate::saturating_from_rational(33, 100)\n\t\t);\n\t});\n}\n\n#[test]\nfn set_accrual_interest_params_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Set pool total_borrowed eq 100 DOT and pool total_insurance eq 10_000 DOT.\n\t\tassert_ok!(TestPools::set_accrual_interest_params(\n\t\t\tCurrencyId::DOT,\n\t\t\tONE_HUNDRED_DOLLARS,\n\t\t\tTEN_THOUSAND\n\t\t));\n\t\tassert_eq!(\u003cPools\u003e::get(CurrencyId::DOT).total_borrowed, ONE_HUNDRED_DOLLARS);\n\t\tassert_eq!(\u003cPools\u003e::get(CurrencyId::DOT).total_insurance, TEN_THOUSAND);\n\t});\n}\n\n#[test]\nfn enable_as_collateral_internal_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice enable as collateral DOT pool.\n\t\tassert_ok!(TestPools::enable_as_collateral_internal(\u0026ALICE, CurrencyId::DOT));\n\n\t\tassert!(\u003cPoolUserDates\u003cTest\u003e\u003e::get(CurrencyId::DOT, ALICE).collateral);\n\t});\n}\n\n#[test]\nfn disable_collateral_internal_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice disable collateral DOT pool.\n\t\tassert_ok!(TestPools::disable_collateral_internal(\u0026ALICE, CurrencyId::DOT));\n\n\t\tassert!(!\u003cPoolUserDates\u003cTest\u003e\u003e::get(CurrencyId::DOT, ALICE).collateral);\n\t});\n}\n\n#[test]\nfn get_pool_available_liquidity_should_work() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, TEN_THOUSAND)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TestPools::get_pool_available_liquidity(CurrencyId::DOT), TEN_THOUSAND);\n\t\t});\n}\n\n#[test]\nfn get_pool_total_borrowed_should_work() {\n\tExtBuilder::default()\n\t\t.pool_with_params(CurrencyId::DOT, TEN_THOUSAND, Rate::default(), Balance::default())\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), TEN_THOUSAND);\n\t\t});\n}\n\n#[test]\nfn get_pool_total_insurance_should_work() {\n\tExtBuilder::default()\n\t\t.pool_with_params(CurrencyId::DOT, Balance::default(), Rate::default(), TEN_THOUSAND)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TestPools::get_pool_total_insurance(CurrencyId::DOT), TEN_THOUSAND);\n\t\t});\n}\n\n#[test]\nfn get_pool_borrow_index_should_work() {\n\tExtBuilder::default()\n\t\t.pool_with_params(\n\t\t\tCurrencyId::DOT,\n\t\t\tBalance::default(),\n\t\t\tRate::saturating_from_rational(125, 100),\n\t\t\tBalance::default(),\n\t\t)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_pool_borrow_index(CurrencyId::DOT),\n\t\t\t\tRate::saturating_from_rational(125, 100)\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_user_total_borrowed_should_work() {\n\tExtBuilder::default()\n\t\t.pool_user_data_with_params(CurrencyId::DOT, ALICE, ONE_HUNDRED_DOLLARS, Rate::default(), true)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tONE_HUNDRED_DOLLARS\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn check_user_available_collateral_should_work() {\n\tExtBuilder::default()\n\t\t.pool_user_data_with_params(CurrencyId::DOT, ALICE, Balance::default(), Rate::default(), false)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// collateral parameter is set to false\n\t\t\tassert!(!TestPools::check_user_available_collateral(\u0026ALICE, CurrencyId::DOT));\n\n\t\t\t// set collateral parameter to true\n\t\t\tassert_ok!(TestPools::enable_as_collateral_internal(\u0026ALICE, CurrencyId::DOT));\n\n\t\t\tassert!(TestPools::check_user_available_collateral(\u0026ALICE, CurrencyId::DOT));\n\t\t});\n}\n\n#[test]\nfn pool_should_exists() {\n\tExtBuilder::default()\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(TestPools::pool_exists(\u0026CurrencyId::DOT), true);\n\t\t\tassert_eq!(TestPools::pool_exists(\u0026CurrencyId::MDOT), false);\n\t\t});\n}\n\n#[test]\nfn update_state_on_borrow_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED_DOLLARS)\n\t\t.pool_mock(CurrencyId::DOT)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::from_inner(0)\n\t\t\t);\n\n\t\t\t// Alice borrow 60 DOT\n\t\t\tassert_ok!(TestPools::update_state_on_borrow(\u0026ALICE, CurrencyId::DOT, 60, 0));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 60);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 60);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::default()\n\t\t\t);\n\n\t\t\tassert_ok!(TestPools::set_pool_borrow_index(\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tRate::saturating_from_rational(1, 5)\n\t\t\t));\n\n\t\t\t// ALice borrow 30 DOT\n\t\t\tassert_ok!(TestPools::update_state_on_borrow(\u0026ALICE, CurrencyId::DOT, 30, 60));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 90);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 90);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::saturating_from_rational(1, 5)\n\t\t\t);\n\n\t\t\t// Overflow in calculation: account_borrow_new = 90 + max_value()\n\t\t\tassert_noop!(\n\t\t\t\tTestPools::update_state_on_borrow(\u0026ALICE, CurrencyId::DOT, Balance::max_value(), 90),\n\t\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn update_state_on_repay_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::from_inner(0)\n\t\t\t);\n\t\t\tassert_ok!(TestPools::update_state_on_borrow(\u0026ALICE, CurrencyId::DOT, 60, 0));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 60);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 60);\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_user_borrow_index(\u0026ALICE, CurrencyId::DOT),\n\t\t\t\tRate::default()\n\t\t\t);\n\n\t\t\tassert_ok!(TestPools::update_state_on_repay(\u0026ALICE, CurrencyId::DOT, 30, 60));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 30);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 30);\n\n\t\t\tassert_ok!(TestPools::update_state_on_repay(\u0026ALICE, CurrencyId::DOT, 10, 30));\n\t\t\tassert_eq!(TestPools::get_pool_total_borrowed(CurrencyId::DOT), 20);\n\t\t\tassert_eq!(TestPools::get_user_total_borrowed(\u0026ALICE, CurrencyId::DOT), 20);\n\n\t\t\tassert_noop!(\n\t\t\t\tTestPools::update_state_on_repay(\u0026ALICE, CurrencyId::DOT, 100, 20),\n\t\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn convert_to_wrapped_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.user_balance(ALICE, CurrencyId::MDOT, ONE_HUNDRED)\n\t\t.pool_total_borrowed(CurrencyId::DOT, 40)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// exchange_rate = 40 / 100 = 0.4\n\t\t\tassert_eq!(TestPools::convert_to_wrapped(CurrencyId::DOT, 10), Ok(25));\n\n\t\t\t// Overflow in calculation: wrapped_amount = max_value() / exchange_rate,\n\t\t\t// when exchange_rate \u003c 1\n\t\t\tassert_err!(\n\t\t\t\tTestPools::convert_to_wrapped(CurrencyId::DOT, Balance::max_value()),\n\t\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn convert_from_wrapped_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::DOT, ONE_HUNDRED)\n\t\t.user_balance(ALICE, CurrencyId::MDOT, ONE_HUNDRED)\n\t\t.user_balance(ALICE, CurrencyId::MBTC, 1)\n\t\t.pool_balance(CurrencyId::BTC, 100)\n\t\t.pool_total_borrowed(CurrencyId::DOT, 40)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// underlying_amount = 10 * 0.4 = 4\n\t\t\tassert_eq!(TestPools::convert_from_wrapped(CurrencyId::MDOT, 10), Ok(4));\n\n\t\t\t// Overflow in calculation: underlying_amount = max_value() * exchange_rate\n\t\t\tassert_err!(\n\t\t\t\tTestPools::convert_from_wrapped(CurrencyId::MBTC, Balance::max_value()),\n\t\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn calculate_exchange_rate_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// exchange_rate = (102 - 2 + 20) / 100 = 1.2\n\t\tassert_eq!(\n\t\t\tTestPools::calculate_exchange_rate(102, 100, 2, 20),\n\t\t\tOk(Rate::saturating_from_rational(12, 10))\n\t\t);\n\t\t// If there are no tokens minted: exchangeRate = InitialExchangeRate = 1.0\n\t\tassert_eq!(\n\t\t\tTestPools::calculate_exchange_rate(102, 0, 2, 0),\n\t\t\tOk(Rate::saturating_from_rational(1, 1))\n\t\t);\n\n\t\t// Overflow in calculation: total_cash + total_borrowed\n\t\tassert_noop!(\n\t\t\tTestPools::calculate_exchange_rate(Balance::max_value(), 100, 100, 100),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// Overflow in calculation: cash_plus_borrows - total_insurance\n\t\tassert_noop!(\n\t\t\tTestPools::calculate_exchange_rate(100, 100, Balance::max_value(), 100),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn get_exchange_rate_should_work() {\n\tExtBuilder::default()\n\t\t.pool_balance(CurrencyId::DOT, dollars(100_u128))\n\t\t.user_balance(ALICE, CurrencyId::MDOT, dollars(125_u128))\n\t\t.pool_total_borrowed(CurrencyId::DOT, dollars(300_u128))\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// exchange_rate = (100 - 0 + 300) / 125 = 3.2\n\t\t\tassert_eq!(\n\t\t\t\tTestPools::get_exchange_rate(CurrencyId::DOT),\n\t\t\t\tOk(Rate::saturating_from_rational(32, 10))\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn get_wrapped_id_by_underlying_asset_id_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_eq!(\n\t\t\tTestPools::get_wrapped_id_by_underlying_asset_id(\u0026CurrencyId::DOT),\n\t\t\tOk(CurrencyId::MDOT)\n\t\t);\n\t\tassert_noop!(\n\t\t\tTestPools::get_wrapped_id_by_underlying_asset_id(\u0026CurrencyId::MDOT),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn get_underlying_asset_id_by_wrapped_id_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_eq!(\n\t\t\tTestPools::get_underlying_asset_id_by_wrapped_id(\u0026CurrencyId::MDOT),\n\t\t\tOk(CurrencyId::DOT)\n\t\t);\n\t\tassert_noop!(\n\t\t\tTestPools::get_underlying_asset_id_by_wrapped_id(\u0026CurrencyId::DOT),\n\t\t\tError::\u003cTest\u003e::NotValidWrappedTokenId\n\t\t);\n\t});\n}\n","traces":[{"line":9,"address":[4213040],"length":1,"stats":{"Line":1},"fn_name":"dollars\u003cu128\u003e"},{"line":10,"address":[4213054],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[4213136,4213141],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":15,"address":[4213168],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":17,"address":[4213175],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[4213440,4213596],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4213861,4213856],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":24,"address":[4213888],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":26,"address":[4213931],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4213895],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[4213903],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[4214273,4214377,4214224],"length":1,"stats":{"Line":2},"fn_name":null},{"line":31,"address":[4214195],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4214247],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[4214661,4214656],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":39,"address":[4214688],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":41,"address":[4214703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[4214695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4214960,4215116],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4215381,4215376],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":51,"address":[4215408],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":53,"address":[4215461],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[4215415],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4215423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[4215987,4215831],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[4215789],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4216247,4216296,4216400],"length":1,"stats":{"Line":2},"fn_name":null},{"line":64,"address":[4215933],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[4216270],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[4216677,4216672],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":72,"address":[4216704],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":74,"address":[4216719],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4216711],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[4217207,4217025],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[4217161,4217467,4217594],"length":1,"stats":{"Line":2},"fn_name":null},{"line":85,"address":[4217856,4217861],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":86,"address":[4217888],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":88,"address":[4217902],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4218141,4218226,4218196],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[4218240,4218245],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":96,"address":[4218272],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":98,"address":[4218286],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[4218525,4218582,4218612],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[4218629,4218624],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":106,"address":[5239261,5239223],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[5239253],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[4218656],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":110,"address":[4218663,4218800],"length":1,"stats":{"Line":1},"fn_name":null},{"line":115,"address":[4219056,4219061],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":116,"address":[5239584,5239487,5239399],"length":1,"stats":{"Line":3},"fn_name":null},{"line":117,"address":[5239576,5239445,5239647],"length":1,"stats":{"Line":2},"fn_name":null},{"line":119,"address":[4219088],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":120,"address":[4219232,4219095],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[4219488,4219493],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":126,"address":[5239735,5239918,5239823],"length":1,"stats":{"Line":3},"fn_name":null},{"line":127,"address":[5239781,5239981,5239910],"length":1,"stats":{"Line":2},"fn_name":null},{"line":129,"address":[4219520],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":130,"address":[4219664,4219527],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[4219920,4219925],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":136,"address":[5240186,5240277,5240071],"length":1,"stats":{"Line":3},"fn_name":null},{"line":138,"address":[5240117],"length":1,"stats":{"Line":1},"fn_name":null},{"line":139,"address":[5240125],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[5240152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[5240169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":144,"address":[4219952],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":145,"address":[4220103,4220009],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[4219959],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[4219994],"length":1,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[4220384,4220389],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":154,"address":[5240596,5240423,5240494],"length":1,"stats":{"Line":3},"fn_name":null},{"line":155,"address":[5240659,5240469,5240588],"length":1,"stats":{"Line":2},"fn_name":null},{"line":157,"address":[4220416],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":158,"address":[4220567,4220460],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[4220423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[4220832,4220837],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":167,"address":[5240831,5240743,5240924],"length":1,"stats":{"Line":3},"fn_name":null},{"line":168,"address":[5240987,5240789,5240916],"length":1,"stats":{"Line":2},"fn_name":null},{"line":170,"address":[4220864],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":172,"address":[4220944,4220878],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[4220919,4220978],"length":1,"stats":{"Line":2},"fn_name":null},{"line":177,"address":[4221243,4221197,4221273],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[4221285,4221280],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":183,"address":[5241117,5241079],"length":1,"stats":{"Line":2},"fn_name":null},{"line":184,"address":[5241109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[4221312],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":187,"address":[4221458,4221319],"length":1,"stats":{"Line":1},"fn_name":null},{"line":188,"address":[4221726,4221830,4221420],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[4222101,4222096],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":194,"address":[5241277,5241239,5241337],"length":1,"stats":{"Line":3},"fn_name":null},{"line":195,"address":[5241269],"length":1,"stats":{"Line":1},"fn_name":null},{"line":196,"address":[5241329],"length":1,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[4222128,4222181],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":199,"address":[4222444,4222231],"length":1,"stats":{"Line":1},"fn_name":null},{"line":200,"address":[4222135],"length":1,"stats":{"Line":1},"fn_name":null},{"line":201,"address":[4222196],"length":1,"stats":{"Line":1},"fn_name":null},{"line":205,"address":[4222349,4222749],"length":1,"stats":{"Line":2},"fn_name":null},{"line":206,"address":[4222997,4223211],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[4223512,4223147,4223681],"length":1,"stats":{"Line":2},"fn_name":null},{"line":208,"address":[4224158,4223995],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[4223617],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4223974],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[4224459],"length":1,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[4224106],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[4224114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[4224757],"length":1,"stats":{"Line":1},"fn_name":null},{"line":220,"address":[4225081,4225295],"length":1,"stats":{"Line":1},"fn_name":null},{"line":221,"address":[4225596,4225231,4225765],"length":1,"stats":{"Line":2},"fn_name":null},{"line":222,"address":[4226227,4226089],"length":1,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[4225701],"length":1,"stats":{"Line":1},"fn_name":null},{"line":224,"address":[4226068],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[4226622,4226200],"length":1,"stats":{"Line":2},"fn_name":null},{"line":229,"address":[4226528],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[4226614],"length":1,"stats":{"Line":1},"fn_name":null},{"line":236,"address":[4227680,4227685],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":237,"address":[5241447,5241485],"length":1,"stats":{"Line":2},"fn_name":null},{"line":238,"address":[5241477],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[4227765,4227712],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":241,"address":[4227815,4228028],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[4227719],"length":1,"stats":{"Line":1},"fn_name":null},{"line":243,"address":[4227780],"length":1,"stats":{"Line":1},"fn_name":null},{"line":245,"address":[4227933,4228333],"length":1,"stats":{"Line":2},"fn_name":null},{"line":246,"address":[4228581,4228795],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[4229265,4228731,4229096],"length":1,"stats":{"Line":2},"fn_name":null},{"line":248,"address":[4229782,4229579],"length":1,"stats":{"Line":1},"fn_name":null},{"line":249,"address":[4229201],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[4229558],"length":1,"stats":{"Line":1},"fn_name":null},{"line":253,"address":[4230087,4229697],"length":1,"stats":{"Line":2},"fn_name":null},{"line":254,"address":[4230549,4230335],"length":1,"stats":{"Line":1},"fn_name":null},{"line":255,"address":[4230850,4230485,4231054],"length":1,"stats":{"Line":2},"fn_name":null},{"line":257,"address":[4231351,4230962],"length":1,"stats":{"Line":2},"fn_name":null},{"line":258,"address":[4231599,4231813],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[4231749,4232114,4232253],"length":1,"stats":{"Line":2},"fn_name":null},{"line":261,"address":[4232219,4232660,4232618],"length":1,"stats":{"Line":3},"fn_name":null},{"line":262,"address":[4232546],"length":1,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[4232610],"length":1,"stats":{"Line":1},"fn_name":null},{"line":269,"address":[4233696,4233701],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":270,"address":[5241661,5241623,5241771,5241716],"length":1,"stats":{"Line":4},"fn_name":null},{"line":271,"address":[5241653],"length":1,"stats":{"Line":1},"fn_name":null},{"line":272,"address":[5241708],"length":1,"stats":{"Line":1},"fn_name":null},{"line":273,"address":[5241763],"length":1,"stats":{"Line":1},"fn_name":null},{"line":275,"address":[4233728],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":277,"address":[4233889,4233735],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[4234198,4234391],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[4233871,4234157],"length":1,"stats":{"Line":2},"fn_name":null},{"line":283,"address":[4234190],"length":1,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[4234677,4234672],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":290,"address":[5242114,5242163,5241949,5241911,5242004,5242059],"length":1,"stats":{"Line":6},"fn_name":null},{"line":291,"address":[5241941],"length":1,"stats":{"Line":1},"fn_name":null},{"line":292,"address":[5241996],"length":1,"stats":{"Line":1},"fn_name":null},{"line":293,"address":[5242051],"length":1,"stats":{"Line":1},"fn_name":null},{"line":294,"address":[5242106],"length":1,"stats":{"Line":1},"fn_name":null},{"line":295,"address":[5242155],"length":1,"stats":{"Line":1},"fn_name":null},{"line":297,"address":[4234704],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":299,"address":[4234865,4234711],"length":1,"stats":{"Line":1},"fn_name":null},{"line":302,"address":[4235367,4235174],"length":1,"stats":{"Line":1},"fn_name":null},{"line":303,"address":[4235133,4234847],"length":1,"stats":{"Line":2},"fn_name":null},{"line":304,"address":[4235166],"length":1,"stats":{"Line":1},"fn_name":null},{"line":310,"address":[4235648,4235653],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":311,"address":[4235754,4235680],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":313,"address":[4236028,4235844],"length":1,"stats":{"Line":1},"fn_name":null},{"line":314,"address":[4235687],"length":1,"stats":{"Line":1},"fn_name":null},{"line":315,"address":[4235769],"length":1,"stats":{"Line":1},"fn_name":null},{"line":318,"address":[4236538,4236403],"length":1,"stats":{"Line":1},"fn_name":null},{"line":319,"address":[4235952],"length":1,"stats":{"Line":1},"fn_name":null},{"line":320,"address":[4236329],"length":1,"stats":{"Line":1},"fn_name":null},{"line":324,"address":[4236956,4236511],"length":1,"stats":{"Line":2},"fn_name":null},{"line":325,"address":[4236841],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[4236948],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[4238177,4238047],"length":1,"stats":{"Line":2},"fn_name":null},{"line":331,"address":[4238068],"length":1,"stats":{"Line":1},"fn_name":null},{"line":332,"address":[4238169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":338,"address":[4239333,4239328],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":339,"address":[5242779,5242722,5242618,5242423,5242519],"length":1,"stats":{"Line":5},"fn_name":null},{"line":340,"address":[5242842,5242485,5242568],"length":1,"stats":{"Line":2},"fn_name":null},{"line":341,"address":[5242672,5242883,5242584],"length":1,"stats":{"Line":2},"fn_name":null},{"line":342,"address":[5242688,5242771,5242924],"length":1,"stats":{"Line":2},"fn_name":null},{"line":344,"address":[4239360],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":346,"address":[4239550,4239456],"length":1,"stats":{"Line":1},"fn_name":null},{"line":347,"address":[4239367],"length":1,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[4239393],"length":1,"stats":{"Line":1},"fn_name":null},{"line":354,"address":[4239829,4239824],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":355,"address":[4239885,4239856],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":356,"address":[4240037,4239907],"length":1,"stats":{"Line":1},"fn_name":null},{"line":357,"address":[4239863],"length":1,"stats":{"Line":1},"fn_name":null},{"line":360,"address":[4240368,4240410,4240010],"length":1,"stats":{"Line":3},"fn_name":null},{"line":361,"address":[4240338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[4240360],"length":1,"stats":{"Line":1},"fn_name":null},{"line":368,"address":[4241445,4241440],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":369,"address":[4241501,4241472],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":370,"address":[4241523,4241653],"length":1,"stats":{"Line":1},"fn_name":null},{"line":371,"address":[4241479],"length":1,"stats":{"Line":1},"fn_name":null},{"line":374,"address":[4242026,4241626,4241984],"length":1,"stats":{"Line":3},"fn_name":null},{"line":375,"address":[4241954],"length":1,"stats":{"Line":1},"fn_name":null},{"line":376,"address":[4241976],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":194,"coverable":194},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","m-tokens","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, ensure};\nuse frame_system::{self as system, ensure_signed};\nuse minterest_primitives::{Balance, CurrencyId};\nuse orml_traits::MultiCurrency;\nuse orml_utilities::with_transaction_result;\nuse sp_runtime::traits::StaticLookup;\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\npub trait Trait: system::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n\n\t/// The `MultiCurrency` implementation for wrapped.\n\ttype MultiCurrency: MultiCurrency\u003cSelf::AccountId, Balance = Balance, CurrencyId = CurrencyId\u003e;\n}\n\ndecl_event! {\n\tpub enum Event\u003cT\u003e\n\twhere\n\t\tAccountId = \u003cT as system::Trait\u003e::AccountId,\n\t{\n\t\t/// Approval is made. [currency_id, owner, spender, amount]\n\t\tApproval(CurrencyId, AccountId, AccountId, Balance),\n\t}\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as MTokens {\n\t\t/// Allowance for an account and token.\n\t\tAllowance get(fn allowance): map hasher(blake2_128_concat) (CurrencyId, T::AccountId, T::AccountId) =\u003e Balance;\n\t}\n}\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// Overflow in calculating allowance.\n\t\tOverflowAllowance,\n\n\t\t/// Allowance does not exist.\n\t\tAllowanceDoesNotExist,\n\n\t\t/// Not enough allowance.\n\t\tNotEnoughAllowance,\n\n\t\t/// Underflow in calculating allowance.\n\t\tUnderflowAllowance,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\t\tfn deposit_event() = default;\n\n\t\t/// Allows `spender` to withdraw from the caller's account multiple times, up to\n\t\t/// the `value` amount.\n\t\t///\n\t\t/// If this function is called again it overwrites the current allowance with `value`.\n\t\t#[weight = 10_000]\n\t\tfn approve(origin,\n\t\t\tspender: \u003cT::Lookup as StaticLookup\u003e::Source,\n\t\t\tcurrency_id: CurrencyId,\n\t\t\t#[compact] value: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\t\tlet spender = T::Lookup::lookup(spender)?;\n\n\t\t\t\tlet allowance = Self::allowance((currency_id, sender.clone(), spender.clone()));\n\t\t\t\tlet updated_allowance = allowance.checked_add(value)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::OverflowAllowance)?;\n\t\t\t\t\u003cAllowance\u003cT\u003e\u003e::insert((currency_id, sender.clone(), spender.clone()), updated_allowance);\n\n\t\t\t\tSelf::deposit_event(RawEvent::Approval(currency_id, sender, spender, value));\n\t\t\t\tOk(())\n\t\t\t})?\n\t\t}\n\n\t\t/// Transfers `value` tokens on the behalf of `from` to the account `to`.\n\t\t#[weight = 10_000]\n\t\tfn transfer_from(_origin,\n\t\t\tfrom: T::AccountId,\n\t\t\tto: T::AccountId,\n\t\t\tcurrency_id: CurrencyId,\n\t\t\t#[compact] value: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tensure!(\n\t\t\t\t\t\u003cAllowance\u003cT\u003e\u003e::contains_key((currency_id, from.clone(), to.clone())),\n\t\t\t\t\tError::\u003cT\u003e::AllowanceDoesNotExist\n\t\t\t\t );\n\t\t\t\tlet allowance = Self::allowance((currency_id, from.clone(), to.clone()));\n\t\t\t\tensure!(\n\t\t\t\t\tallowance \u003e= value,\n\t\t\t\t\tError::\u003cT\u003e::NotEnoughAllowance\n\t\t\t\t);\n\n\t\t\t\tlet updated_allowance = allowance.checked_sub(value)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::UnderflowAllowance)?;\n\n\t\t\t\tT::MultiCurrency::transfer(currency_id, \u0026from, \u0026to, value)?;\n\t\t\t\t\u003cAllowance\u003cT\u003e\u003e::insert((currency_id, from.clone(), to.clone()), updated_allowance);\n\n\t\t\t\tSelf::deposit_event(RawEvent::Approval(currency_id, from.clone(), to.clone(), value));\n\t\t\t\tOk(())\n\t\t\t})?\n\t\t}\n\n\t}\n}\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {}\n","traces":[{"line":29,"address":[4607847,4607430,4607163,4607988,4608105,4607579],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[4655968,4648768,4637360,4637280,4637364,4655872,4648775,4648882,4637296,4653072,4637200,4655952,4655896,4653076,4637315],"length":1,"stats":{"Line":56},"fn_name":"module_prefix\u003cnode_minterest_runtime::Runtime\u003e"},{"line":56,"address":[4655639,4654251,4654874,4654589,4653821,4654164,4653984,4654727,4655439,4655111,4655474,4653289,4655265,4653668,4653433,4654405],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[4642450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[4650809,4650986,4651513,4651392,4651065],"length":1,"stats":{"Line":17},"fn_name":"{{closure}}\u003cnode_minterest_runtime::Runtime\u003e"},{"line":72,"address":[4651402,4651544,4651766,4651751,4651704],"length":1,"stats":{"Line":14},"fn_name":null},{"line":73,"address":[4651644,4651806,4651941,4652006],"length":1,"stats":{"Line":15},"fn_name":null},{"line":75,"address":[4652046,4651911],"length":1,"stats":{"Line":14},"fn_name":null},{"line":76,"address":[4652319,4652238,4652189,4652419],"length":1,"stats":{"Line":21},"fn_name":null},{"line":77,"address":[4612466,4612202,4612272,4612393],"length":1,"stats":{"Line":16},"fn_name":null},{"line":78,"address":[4612479,4612347],"length":1,"stats":{"Line":14},"fn_name":null},{"line":80,"address":[4612562],"length":1,"stats":{"Line":7},"fn_name":null},{"line":81,"address":[4612669],"length":1,"stats":{"Line":7},"fn_name":null},{"line":86,"address":[4642819],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[4646795,4646716,4646602,4647163,4647104],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}\u003cnode_minterest_runtime::Runtime\u003e"},{"line":94,"address":[4647434,4647398,4647351],"length":1,"stats":{"Line":6},"fn_name":null},{"line":95,"address":[4647114,4647183],"length":1,"stats":{"Line":8},"fn_name":null},{"line":96,"address":[4615364],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[4615340,4615455],"length":1,"stats":{"Line":6},"fn_name":null},{"line":99,"address":[4615591,4615657],"length":1,"stats":{"Line":4},"fn_name":null},{"line":100,"address":[4615560],"length":1,"stats":{"Line":3},"fn_name":null},{"line":101,"address":[4615649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[4615606,4615810,4615931,4615731],"length":1,"stats":{"Line":6},"fn_name":null},{"line":105,"address":[4615933,4615723,4615791],"length":1,"stats":{"Line":4},"fn_name":null},{"line":107,"address":[4615863,4615988,4616064],"length":1,"stats":{"Line":3},"fn_name":null},{"line":108,"address":[4616211,4616037],"length":1,"stats":{"Line":2},"fn_name":null},{"line":110,"address":[4616297],"length":1,"stats":{"Line":1},"fn_name":null},{"line":111,"address":[4616434],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":24,"coverable":28},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","m-tokens","src","mock.rs"],"content":"/// Mocks for the m-tokens module.\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\npub use minterest_primitives::{Balance, CurrencyId};\nuse orml_currencies::Currency;\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Runtime {}\n}\n\nmod m_tokens {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Runtime {\n\t\tframe_system\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e, orml_currencies\u003cT\u003e,\n\t\tm_tokens\u003cT\u003e,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Runtime;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\ntype AccountId = u32;\n\nimpl frame_system::Trait for Runtime {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype AccountData = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\npub type System = frame_system::Module\u003cRuntime\u003e;\n\ntype Amount = i128;\n\nimpl orml_tokens::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\ntype NativeCurrency = Currency\u003cRuntime, GetNativeCurrencyId\u003e;\n\nimpl orml_currencies::Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cRuntime\u003e;\n\ttype NativeCurrency = NativeCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\n\nimpl Trait for Runtime {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_currencies::Module\u003cRuntime\u003e;\n}\n\npub const ALICE: AccountId = 1;\npub const BOB: AccountId = 2;\npub type MTokens = Module\u003cRuntime\u003e;\npub const ONE_MILL: Balance = 1_000_000;\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![],\n\t\t}\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn balances(mut self, endowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e) -\u003e Self {\n\t\tself.endowed_accounts = endowed_accounts;\n\t\tself\n\t}\n\n\tpub fn one_million_mint_and_mdot_for_alice(self) -\u003e Self {\n\t\tself.balances(vec![\n\t\t\t(ALICE, CurrencyId::MINT, ONE_MILL),\n\t\t\t(ALICE, CurrencyId::MDOT, ONE_MILL),\n\t\t])\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut storage = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut storage)\n\t\t.unwrap();\n\n\t\tlet mut ext = sp_io::TestExternalities::new(storage);\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[{"line":10,"address":[5144032,5144101],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[5144339,5144393,5144285,5144174],"length":1,"stats":{"Line":15},"fn_name":null},{"line":32,"address":[4623969],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[5144449],"length":1,"stats":{"Line":2},"fn_name":null},{"line":106,"address":[4616656],"length":1,"stats":{"Line":5},"fn_name":"default"},{"line":108,"address":[4616663],"length":1,"stats":{"Line":6},"fn_name":null},{"line":114,"address":[4616785,4616736],"length":1,"stats":{"Line":2},"fn_name":"balances"},{"line":115,"address":[4616743,4616797,4616838],"length":1,"stats":{"Line":4},"fn_name":null},{"line":116,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":119,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":120,"address":[4617073,4617155,4616938],"length":1,"stats":{"Line":6},"fn_name":null},{"line":121,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":122,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":126,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":127,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[],"length":0,"stats":{"Line":7},"fn_name":null},{"line":134,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":138,"address":[],"length":0,"stats":{"Line":21},"fn_name":null},{"line":139,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":16,"coverable":20},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","m-tokens","src","tests.rs"],"content":"/// Unit tests for the m-tokens module.\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_noop, assert_ok};\n\n#[test]\nfn approve_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 33));\n\t\tassert_ok!(MTokens::approve(Origin::signed(BOB), ALICE, CurrencyId::MKSM, 45));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 33);\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MKSM, BOB, ALICE)), 45);\n\t});\n}\n\n#[test]\nfn double_approve_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::METH, 33));\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::METH, 67));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::METH, ALICE, BOB)), 100);\n\t});\n}\n\n#[test]\nfn approve_fails_if_overflow() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\tassert_noop!(\n\t\t\tMTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, Balance::max_value()),\n\t\t\tError::\u003cRuntime\u003e::OverflowAllowance\n\t\t);\n\t});\n}\n\n#[test]\nfn transfer_from_should_work() {\n\tExtBuilder::default()\n\t\t.one_million_mint_and_mdot_for_alice()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\t\tassert_ok!(MTokens::transfer_from(\n\t\t\t\tOrigin::signed(ALICE),\n\t\t\t\tALICE,\n\t\t\t\tBOB,\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\t50\n\t\t\t));\n\t\t});\n}\n\n#[test]\nfn transfer_from_not_enough_allowance() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\tassert_noop!(\n\t\t\tMTokens::transfer_from(Origin::signed(ALICE), ALICE, BOB, CurrencyId::MDOT, 101),\n\t\t\tError::\u003cRuntime\u003e::NotEnoughAllowance\n\t\t);\n\t});\n}\n\n#[test]\nfn transfer_from_fails_if_balance_too_low() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\tassert_noop!(\n\t\t\tMTokens::transfer_from(Origin::signed(ALICE), ALICE, BOB, CurrencyId::MDOT, 50),\n\t\t\torml_tokens::Error::\u003cRuntime\u003e::BalanceTooLow\n\t\t);\n\t});\n}\n\n#[test]\nfn transfer_from_fails_if_allowance_does_not_exist() {\n\tExtBuilder::default()\n\t\t.one_million_mint_and_mdot_for_alice()\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\tassert_ok!(MTokens::approve(Origin::signed(ALICE), BOB, CurrencyId::MDOT, 100));\n\t\t\tassert_eq!(MTokens::allowance((CurrencyId::MDOT, ALICE, BOB)), 100);\n\t\t\tassert_noop!(\n\t\t\t\tMTokens::transfer_from(Origin::signed(ALICE), ALICE, BOB, CurrencyId::DOT, 50),\n\t\t\t\tError::\u003cRuntime\u003e::AllowanceDoesNotExist\n\t\t\t);\n\t\t});\n}\n","traces":[{"line":8,"address":[4526640,4526645],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":9,"address":[4526672],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":10,"address":[4526684],"length":1,"stats":{"Line":1},"fn_name":null},{"line":11,"address":[4527049],"length":1,"stats":{"Line":1},"fn_name":null},{"line":12,"address":[4527409,4527667],"length":1,"stats":{"Line":1},"fn_name":null},{"line":13,"address":[4527583,4527935,4528054],"length":1,"stats":{"Line":2},"fn_name":null},{"line":18,"address":[4528325,4528320],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":19,"address":[4528352],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":20,"address":[4528364],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4528705],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4529235,4529041],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4529509,4529504],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":28,"address":[4529536,4529611],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":29,"address":[4529543,4529626],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[4530147,4529933],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4530113,4530642],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[4530569,4531650,4530445],"length":1,"stats":{"Line":2},"fn_name":null},{"line":33,"address":[4530634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[4531765,4531760],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":40,"address":[4695239,4695269],"length":1,"stats":{"Line":2},"fn_name":null},{"line":43,"address":[4531792],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":44,"address":[4531804],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4532140,4532389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[4532657],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4532319],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4532649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[4532960,4532965],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":58,"address":[4533059,4532992],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":59,"address":[4533004,4533074],"length":1,"stats":{"Line":2},"fn_name":null},{"line":60,"address":[4533595,4533381],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[4533561,4534064],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[4533893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4534056],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[4535125,4535120],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":70,"address":[4535219,4535152],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":71,"address":[4535164,4535234],"length":1,"stats":{"Line":2},"fn_name":null},{"line":72,"address":[4535541,4535755],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[4535721,4536224],"length":1,"stats":{"Line":2},"fn_name":null},{"line":74,"address":[4536053],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4536216],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[4537285,4537280],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":82,"address":[4695653,4695623],"length":1,"stats":{"Line":2},"fn_name":null},{"line":85,"address":[4537312,4537379],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":86,"address":[4537324,4537394],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[4537701,4537915],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4537881,4538384],"length":1,"stats":{"Line":2},"fn_name":null},{"line":89,"address":[4538213],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4538376],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":48,"coverable":48},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-model","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, ensure, traits::Get};\nuse frame_system::{self as system, ensure_signed};\nuse minterest_primitives::{CurrencyId, Rate};\nuse orml_utilities::with_transaction_result;\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\nuse sp_runtime::{\n\ttraits::{CheckedAdd, CheckedDiv, CheckedMul},\n\tDispatchError, DispatchResult, FixedPointNumber, RuntimeDebug,\n};\nuse sp_std::{cmp::Ordering, result};\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\n#[derive(Encode, Decode, Clone, RuntimeDebug, Eq, PartialEq, Default)]\npub struct MinterestModelData {\n\t/// The utilization point at which the jump multiplier is applied\n\tpub kink: Rate,\n\n\t/// The base interest rate which is the y-intercept when utilization rate is 0\n\tpub base_rate_per_block: Rate,\n\n\t/// The multiplier of utilization rate that gives the slope of the interest rate\n\tpub multiplier_per_block: Rate,\n\n\t/// The multiplierPerBlock after hitting a specified utilization point\n\tpub jump_multiplier_per_block: Rate,\n}\n\ntype Accounts\u003cT\u003e = accounts::Module\u003cT\u003e;\ntype LiquidityPools\u003cT\u003e = liquidity_pools::Module\u003cT\u003e;\n\npub trait Trait: system::Trait + accounts::Trait + liquidity_pools::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n\n\t/// The approximate number of blocks per year\n\ttype BlocksPerYear: Get\u003cu128\u003e;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as MinterestModel {\n\t\t/// The Minterest Model data information: `(kink, base_rate_per_block, multiplier_per_block, jump_multiplier_per_block)`.\n\t\tpub MinterestModelDates get(fn minterest_model_dates) config(): map hasher(blake2_128_concat) CurrencyId =\u003e MinterestModelData;\n\t}\n}\n\ndecl_event!(\n\tpub enum Event {\n\t\t/// JumpMultiplierPerBlock has been successfully changed.\n\t\tJumpMultiplierPerBlockHasChanged,\n\n\t\t/// BaseRatePerBlock has been successfully changed.\n\t\tBaseRatePerBlockHasChanged,\n\n\t\t/// MultiplierPerBlock has been successfully changed.\n\t\tMultiplierPerBlockHasChanged,\n\n\t\t/// Parameter `kink` has been successfully changed.\n\t\tKinkHasChanged,\n\t}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The currency is not enabled in protocol.\n\t\tNotValidUnderlyingAssetId,\n\n\t\t/// Number overflow in calculation.\n\t\tNumOverflow,\n\n\t\t/// Base rate per block cannot be set to 0 at the same time as Multiplier per block.\n\t\tBaseRatePerBlockCannotBeZero,\n\n\t\t/// Multiplier per block cannot be set to 0 at the same time as Base rate per block.\n\t\tMultiplierPerBlockCannotBeZero,\n\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\tRequireAdmin,\n\n\t\t/// Parameter `kink` cannot be more than one.\n\t\tKinkCannotBeMoreThanOne,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\n\t\t/// Set JumpMultiplierPerBlock from JumpMultiplierPerYear.\n\t\t/// - `pool_id`: PoolID for which the parameter value is being set.\n\t\t/// - `jump_multiplier_rate_per_year_n`: numerator.\n\t\t/// - `jump_multiplier_rate_per_year_d`: divider.\n\t\t///\n\t\t/// `jump_multiplier_per_block = (jump_multiplier_rate_per_year_n / jump_multiplier_rate_per_year_d) / blocks_per_year`\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_jump_multiplier_per_block(origin, pool_id: CurrencyId, jump_multiplier_rate_per_year_n: u128, jump_multiplier_rate_per_year_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\t// jump_multiplier_per_block = (jump_multiplier_rate_per_year_n / jump_multiplier_rate_per_year_d) / blocks_per_year\n\t\t\tlet new_jump_multiplier_per_year = Rate::checked_from_rational(jump_multiplier_rate_per_year_n, jump_multiplier_rate_per_year_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\tlet new_jump_multiplier_per_block = new_jump_multiplier_per_year\n\t\t\t\t.checked_div(\u0026Rate::from_inner(T::BlocksPerYear::get()))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t// Write the previously calculated values into storage.\n\t\t\tMinterestModelDates::mutate(pool_id, |r| r.jump_multiplier_per_block = new_jump_multiplier_per_block);\n\n\t\t\tSelf::deposit_event(Event::JumpMultiplierPerBlockHasChanged);\n\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Set BaseRatePerBlock from BaseRatePerYear.\n\t\t/// - `pool_id`: PoolID for which the parameter value is being set.\n\t\t/// - `base_rate_per_year_n`: numerator.\n\t\t/// - `base_rate_per_year_d`: divider.\n\t\t///\n\t\t/// `base_rate_per_block = base_rate_per_year_n / base_rate_per_year_d`\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_base_rate_per_block(origin, pool_id: CurrencyId, base_rate_per_year_n: u128, base_rate_per_year_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\tlet new_base_rate_per_year = Rate::checked_from_rational(base_rate_per_year_n, base_rate_per_year_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\tlet new_base_rate_per_block = new_base_rate_per_year\n\t\t\t\t.checked_div(\u0026Rate::from_inner(T::BlocksPerYear::get()))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t// Base rate per block cannot be set to 0 at the same time as Multiplier per block.\n\t\t\tif new_base_rate_per_block.is_zero() {\n\t\t\t\tensure!(!Self::minterest_model_dates(pool_id).multiplier_per_block.is_zero(), Error::\u003cT\u003e::BaseRatePerBlockCannotBeZero);\n\t\t\t}\n\n\t\t\t// Write the previously calculated values into storage.\n\t\t\tMinterestModelDates::mutate(pool_id, |r| r.base_rate_per_block = new_base_rate_per_block);\n\n\t\t\tSelf::deposit_event(Event::BaseRatePerBlockHasChanged);\n\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Set MultiplierPerBlock from MultiplierPerYear.\n\t\t/// - `pool_id`: PoolID for which the parameter value is being set.\n\t\t/// - `multiplier_rate_per_year_n`: numerator.\n\t\t/// - `multiplier_rate_per_year_d`: divider.\n\t\t///\n\t\t/// `multiplier_per_block = (multiplier_rate_per_year_n / multiplier_rate_per_year_d) / blocks_per_year`\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_multiplier_per_block(origin, pool_id: CurrencyId, multiplier_rate_per_year_n: u128, multiplier_rate_per_year_d: u128) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\tlet new_multiplier_per_year = Rate::checked_from_rational(multiplier_rate_per_year_n, multiplier_rate_per_year_d)\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\tlet new_multiplier_per_block = new_multiplier_per_year\n\t\t\t\t.checked_div(\u0026Rate::from_inner(T::BlocksPerYear::get()))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t// Multiplier per block cannot be set to 0 at the same time as Base rate per block .\n\t\t\tif new_multiplier_per_block.is_zero() {\n\t\t\t\tensure!(!Self::minterest_model_dates(pool_id).base_rate_per_block.is_zero(), Error::\u003cT\u003e::MultiplierPerBlockCannotBeZero);\n\t\t\t}\n\n\t\t\t// Write the previously calculated values into storage.\n\t\t\tMinterestModelDates::mutate(pool_id, |r| r.multiplier_per_block = new_multiplier_per_block);\n\t\t\tSelf::deposit_event(Event::MultiplierPerBlockHasChanged);\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Set parameter `kink`.\n\t\t/// - `pool_id`: PoolID for which the parameter value is being set.\n\t\t/// - `kink_nominator`: numerator.\n\t\t/// - `kink_divider`: divider.\n\t\t///\n\t\t/// `kink = kink_nominator / kink_divider`\n\t\t/// The dispatch origin of this call must be Administrator.\n\t\t#[weight = 0]\n\t\tpub fn set_kink(origin, pool_id: CurrencyId, kink_nominator: u128, kink_divider: u128) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\t\tensure!(\u003cAccounts\u003cT\u003e\u003e::is_admin_internal(\u0026sender), Error::\u003cT\u003e::RequireAdmin);\n\n\t\t\t\tensure!(\n\t\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t\t);\n\n\t\t\t\tensure!(kink_nominator \u003c= kink_divider, Error::\u003cT\u003e::KinkCannotBeMoreThanOne);\n\n\t\t\t\tlet new_kink = Rate::checked_from_rational(kink_nominator, kink_divider)\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t\t// Write the previously calculated values into storage.\n\t\t\t\tMinterestModelDates::mutate(pool_id, |r| r.kink = new_kink);\n\t\t\t\tSelf::deposit_event(Event::KinkHasChanged);\n\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\t}\n}\n\ntype RateResult = result::Result\u003cRate, DispatchError\u003e;\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\t/// Calculates the current borrow rate per block.\n\t/// - `underlying_asset_id`: Asset ID for which the borrow interest rate is calculated.\n\t/// - `utilization_rate`: Current Utilization rate value.\n\t///\n\t/// returns `borrow_interest_rate`.\n\tpub fn calculate_borrow_interest_rate(underlying_asset_id: CurrencyId, utilization_rate: Rate) -\u003e RateResult {\n\t\tlet kink = Self::minterest_model_dates(underlying_asset_id).kink;\n\t\tlet multiplier_per_block = Self::minterest_model_dates(underlying_asset_id).multiplier_per_block;\n\t\tlet base_rate_per_block = Self::minterest_model_dates(underlying_asset_id).base_rate_per_block;\n\n\t\t// if utilization_rate \u003e kink:\n\t\t// normal_rate = kink * multiplier_per_block + base_rate_per_block\n\t\t// excess_util = utilization_rate * kink\n\t\t// borrow_rate = excess_util * jump_multiplier_per_block + normal_rate\n\t\t//\n\t\t// if utilization_rate \u003c= kink:\n\t\t// borrow_rate = utilization_rate * multiplier_per_block + base_rate_per_block\n\t\tlet borrow_interest_rate = match utilization_rate.cmp(\u0026kink) {\n\t\t\tOrdering::Greater =\u003e {\n\t\t\t\tlet jump_multiplier_per_block =\n\t\t\t\t\tSelf::minterest_model_dates(underlying_asset_id).jump_multiplier_per_block;\n\t\t\t\tlet normal_rate = kink\n\t\t\t\t\t.checked_mul(\u0026multiplier_per_block)\n\t\t\t\t\t.and_then(|v| v.checked_add(\u0026base_rate_per_block))\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\tlet excess_util = utilization_rate.checked_mul(\u0026kink).ok_or(Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\t\texcess_util\n\t\t\t\t\t.checked_mul(\u0026jump_multiplier_per_block)\n\t\t\t\t\t.and_then(|v| v.checked_add(\u0026normal_rate))\n\t\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?\n\t\t\t}\n\t\t\t_ =\u003e utilization_rate\n\t\t\t\t.checked_mul(\u0026multiplier_per_block)\n\t\t\t\t.and_then(|v| v.checked_add(\u0026base_rate_per_block))\n\t\t\t\t.ok_or(Error::\u003cT\u003e::NumOverflow)?,\n\t\t};\n\n\t\tOk(borrow_interest_rate)\n\t}\n}\n","traces":[{"line":48,"address":[4853200,4853248,4853436,4853296,4853308,4853262,4853424,4853456,4853212],"length":1,"stats":{"Line":278},"fn_name":"minterest_model_dates\u003cminterest_model::mock::Test,minterest_primitives::CurrencyId\u003e"},{"line":55,"address":[4853694,4853800,4853850,4853747,4853966],"length":1,"stats":{"Line":5},"fn_name":null},{"line":93,"address":[4762253,4761032,4763045,4760888,4763304,4762933,4764128,4762045,4763842,4761601,4763151,4763542,4762685,4762308,4761656,4761222,4763497,4761874,4763985,4761393,4762526,4762887,4763639],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[4769542],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[4856778,4856891,4856947,4856813,4856701],"length":1,"stats":{"Line":3},"fn_name":null},{"line":109,"address":[4857032,4857108,4857005,4856880],"length":1,"stats":{"Line":4},"fn_name":null},{"line":111,"address":[4857117,4857185],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[4857018],"length":1,"stats":{"Line":1},"fn_name":null},{"line":113,"address":[4857177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[4857155,4857410,4857345,4857264],"length":1,"stats":{"Line":3},"fn_name":null},{"line":118,"address":[4857412,4857256,4857326],"length":1,"stats":{"Line":3},"fn_name":null},{"line":119,"address":[4857751,4857533,4857662,4857582],"length":1,"stats":{"Line":3},"fn_name":null},{"line":120,"address":[4857476,4857393],"length":1,"stats":{"Line":2},"fn_name":null},{"line":121,"address":[4857753,4857643,4857574],"length":1,"stats":{"Line":2},"fn_name":null},{"line":124,"address":[4857718,4858077,4858064],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003cminterest_model::mock::Test\u003e"},{"line":126,"address":[4857815],"length":1,"stats":{"Line":1},"fn_name":null},{"line":128,"address":[4857846],"length":1,"stats":{"Line":1},"fn_name":null},{"line":138,"address":[4769945],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[4860319,4860185,4860150,4860263,4860073],"length":1,"stats":{"Line":6},"fn_name":null},{"line":141,"address":[4860404,4860480,4860252,4860377],"length":1,"stats":{"Line":6},"fn_name":null},{"line":143,"address":[4860489,4860557],"length":1,"stats":{"Line":3},"fn_name":null},{"line":144,"address":[4860390],"length":1,"stats":{"Line":2},"fn_name":null},{"line":145,"address":[4860549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[4860782,4860527,4860717,4860636],"length":1,"stats":{"Line":6},"fn_name":null},{"line":149,"address":[4860628,4860698,4860784],"length":1,"stats":{"Line":5},"fn_name":null},{"line":150,"address":[4860905,4861036,4860955,4861107],"length":1,"stats":{"Line":6},"fn_name":null},{"line":151,"address":[4860765,4860848],"length":1,"stats":{"Line":4},"fn_name":null},{"line":152,"address":[4861017,4860947,4861109],"length":1,"stats":{"Line":4},"fn_name":null},{"line":155,"address":[4861248,4861084,4861177],"length":1,"stats":{"Line":5},"fn_name":null},{"line":156,"address":[4861250,4861195],"length":1,"stats":{"Line":2},"fn_name":null},{"line":160,"address":[4861337,4861629,4861616],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003cminterest_model::mock::Test\u003e"},{"line":162,"address":[4861370],"length":1,"stats":{"Line":2},"fn_name":null},{"line":164,"address":[4861401],"length":1,"stats":{"Line":2},"fn_name":null},{"line":174,"address":[4770312],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[4863815,4863625,4863871,4863737,4863702],"length":1,"stats":{"Line":3},"fn_name":null},{"line":177,"address":[4864032,4863929,4863956,4863804],"length":1,"stats":{"Line":4},"fn_name":null},{"line":179,"address":[4864041,4864109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":180,"address":[4863942],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[4864101],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[4864334,4864079,4864269,4864188],"length":1,"stats":{"Line":3},"fn_name":null},{"line":185,"address":[4864180,4864336,4864250],"length":1,"stats":{"Line":3},"fn_name":null},{"line":186,"address":[4864507,4864659,4864588,4864457],"length":1,"stats":{"Line":3},"fn_name":null},{"line":187,"address":[4864317,4864400],"length":1,"stats":{"Line":2},"fn_name":null},{"line":188,"address":[4864661,4864499,4864569],"length":1,"stats":{"Line":2},"fn_name":null},{"line":191,"address":[4864636,4864800,4864729],"length":1,"stats":{"Line":3},"fn_name":null},{"line":192,"address":[4864802,4864747],"length":1,"stats":{"Line":2},"fn_name":null},{"line":196,"address":[4865168,4865181,4864889],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003cminterest_model::mock::Test\u003e"},{"line":197,"address":[4864922],"length":1,"stats":{"Line":2},"fn_name":null},{"line":198,"address":[4864953],"length":1,"stats":{"Line":2},"fn_name":null},{"line":208,"address":[4770670],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[4867552,4867203,4866991,4867124,4867617],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003cminterest_model::mock::Test\u003e"},{"line":211,"address":[4867701,4867640,4867742,4867562],"length":1,"stats":{"Line":2},"fn_name":null},{"line":212,"address":[4867789,4867862,4867760,4867690],"length":1,"stats":{"Line":4},"fn_name":null},{"line":214,"address":[4867938,4867871],"length":1,"stats":{"Line":2},"fn_name":null},{"line":215,"address":[4867771],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4867930],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[4867882,4868068],"length":1,"stats":{"Line":2},"fn_name":null},{"line":221,"address":[4868152,4868011,4868324,4868233],"length":1,"stats":{"Line":3},"fn_name":null},{"line":222,"address":[4868326,4868144,4868214],"length":1,"stats":{"Line":3},"fn_name":null},{"line":225,"address":[4868286,4867520,4867533],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003cminterest_model::mock::Test\u003e"},{"line":226,"address":[4868385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[4868413],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":243,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":244,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":245,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":254,"address":[],"length":0,"stats":{"Line":36},"fn_name":null},{"line":255,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":256,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":257,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":259,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":261,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":262,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":264,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":265,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[],"length":0,"stats":{"Line":13},"fn_name":null},{"line":267,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":269,"address":[],"length":0,"stats":{"Line":69},"fn_name":null},{"line":270,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[],"length":0,"stats":{"Line":45},"fn_name":null},{"line":272,"address":[],"length":0,"stats":{"Line":31},"fn_name":null},{"line":275,"address":[],"length":0,"stats":{"Line":17},"fn_name":null}],"covered":73,"coverable":84},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-model","src","mock.rs"],"content":"/// Mocks for the minterest-model pallet.\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\nuse sp_core::H256;\nuse sp_runtime::{testing::Header, traits::IdentityLookup, ModuleId, Perbill};\n\nuse super::*;\n\nimpl_outer_origin! {\n\tpub enum Origin for Test {}\n}\n\nmod minterest_model {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e,\n\t\tminterest_model,\n\t\taccounts\u003cT\u003e,\n\t\tliquidity_pools,\n\t}\n}\n\n#[derive(Clone, PartialEq, Eq, Debug)]\npub struct Test;\n\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n}\n\ntype AccountId = u32;\n\nimpl system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype AccountData = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n}\n\nimpl orml_tokens::Trait for Test {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = MAX_MEMBERS;\n}\n\nimpl accounts::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MaxMembers = MaxMembers;\n}\n\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl liquidity_pools::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\nparameter_types! {\n\tpub const BlocksPerYear: u128 = BLOCKS_PER_YEAR;\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype BlocksPerYear = BlocksPerYear;\n}\n\ntype Amount = i128;\n\npub type TestMinterestModel = Module\u003cTest\u003e;\npub type System = frame_system::Module\u003cTest\u003e;\npub const BLOCKS_PER_YEAR: u128 = 5_256_000;\npub const MAX_MEMBERS: u32 = 16;\npub const ALICE: AccountId = 1;\npub fn alice() -\u003e Origin {\n\tOrigin::signed(ALICE)\n}\npub const BOB: AccountId = 2;\npub fn bob() -\u003e Origin {\n\tOrigin::signed(BOB)\n}\n\npub fn new_test_ext() -\u003e sp_io::TestExternalities {\n\tlet mut t = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\tcrate::GenesisConfig {\n\t\tminterest_model_dates: vec![\n\t\t\t(\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tMinterestModelData {\n\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t},\n\t\t\t),\n\t\t\t(\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tMinterestModelData {\n\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t},\n\t\t\t),\n\t\t\t(\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tMinterestModelData {\n\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t},\n\t\t\t),\n\t\t],\n\t}\n\t.assimilate_storage(\u0026mut t)\n\t.unwrap();\n\n\taccounts::GenesisConfig::\u003cTest\u003e {\n\t\tallowed_accounts: vec![(ALICE, ())],\n\t}\n\t.assimilate_storage(\u0026mut t)\n\t.unwrap();\n\n\tlet mut ext: sp_io::TestExternalities = t.into();\n\text.execute_with(|| System::set_block_number(1));\n\text\n}\n","traces":[{"line":9,"address":[5014960,5015029],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[5015751,5015209,5016385,5017054,5015714,5015934,5016135,5016422,5016652,5015390,5016503,5016172,5016881,5016240,5017162,5015536,5017108,5016997,5015353],"length":1,"stats":{"Line":8},"fn_name":null},{"line":19,"address":[5015425,5015689,5015643,5015367],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[5015728,5016110,5015786,5016064],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[5016149,5016207,5016314,5016360],"length":1,"stats":{"Line":3},"fn_name":null},{"line":22,"address":[5016457,5016399,5016581,5016627],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[5016787,5016674],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[4630337],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[4630404],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[4630452],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[5017608,5017254,5017488],"length":1,"stats":{"Line":8},"fn_name":null},{"line":93,"address":[4630552],"length":1,"stats":{"Line":4},"fn_name":null},{"line":94,"address":[4630611],"length":1,"stats":{"Line":4},"fn_name":null},{"line":95,"address":[4630666],"length":1,"stats":{"Line":4},"fn_name":null},{"line":96,"address":[4630721],"length":1,"stats":{"Line":4},"fn_name":null},{"line":124,"address":[4622096],"length":1,"stats":{"Line":4},"fn_name":"alice"},{"line":125,"address":[4622105],"length":1,"stats":{"Line":4},"fn_name":null},{"line":128,"address":[4622160],"length":1,"stats":{"Line":1},"fn_name":"bob"},{"line":129,"address":[4622169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[4622224,4622278],"length":1,"stats":{"Line":2},"fn_name":"new_test_ext"},{"line":133,"address":[4622309,4622235],"length":1,"stats":{"Line":9},"fn_name":null},{"line":136,"address":[4623336,4624084,4622399],"length":1,"stats":{"Line":14},"fn_name":null},{"line":170,"address":[4623704],"length":1,"stats":{"Line":7},"fn_name":null},{"line":175,"address":[4623876],"length":1,"stats":{"Line":7},"fn_name":null},{"line":176,"address":[4623995],"length":1,"stats":{"Line":21},"fn_name":null}],"covered":17,"coverable":25},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-model","src","tests.rs"],"content":"//! Tests for the minterest-model pallet.\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_noop, assert_ok};\n\nfn multiplier_per_block_equal_max_value() -\u003e MinterestModelData {\n\tMinterestModelData {\n\t\tkink: Rate::saturating_from_rational(12, 10),\n\t\tbase_rate_per_block: Rate::from_inner(0),\n\t\tmultiplier_per_block: Rate::from_inner(u128::max_value()),\n\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t}\n}\n\nfn base_rate_per_block_equal_max_value() -\u003e MinterestModelData {\n\tMinterestModelData {\n\t\tkink: Rate::saturating_from_rational(12, 10),\n\t\tbase_rate_per_block: Rate::from_inner(u128::max_value()),\n\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t}\n}\n\n#[test]\nfn set_base_rate_per_block_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\t// Can be set to 0.0\n\t\tassert_ok!(TestMinterestModel::set_base_rate_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t0,\n\t\t\t1\n\t\t));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).base_rate_per_block,\n\t\t\tRate::from_inner(0)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::BaseRatePerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// ALICE set Baser rate per block equal 2.0\n\t\tassert_ok!(TestMinterestModel::set_base_rate_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t20,\n\t\t\t10\n\t\t));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).base_rate_per_block,\n\t\t\tRate::saturating_from_rational(2_000_000_000_000_000_000u128, BLOCKS_PER_YEAR)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::BaseRatePerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// Base rate per block cannot be set to 0 at the same time as Multiplier per block.\n\t\tassert_ok!(TestMinterestModel::set_multiplier_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t0,\n\t\t\t1\n\t\t));\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::DOT, 0, 1),\n\t\t\tError::\u003cTest\u003e::BaseRatePerBlockCannotBeZero\n\t\t);\n\n\t\t// Overflow in calculation: 20 / 0\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::DOT, 20, 0),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// The dispatch origin of this call must be Administrator.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(bob(), CurrencyId::DOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::RequireAdmin\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn set_multiplier_per_block_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\t// Set Base rate per block equal 2.0\n\t\tassert_ok!(TestMinterestModel::set_base_rate_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t20,\n\t\t\t10\n\t\t));\n\n\t\t// Can be set to 0.0\n\t\tassert_ok!(TestMinterestModel::set_multiplier_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t0,\n\t\t\t10\n\t\t));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).multiplier_per_block,\n\t\t\tRate::from_inner(0)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::MultiplierPerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// Alice set Multiplier per block equal 2.0 / 5_256_000\n\t\tassert_ok!(TestMinterestModel::set_multiplier_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t20,\n\t\t\t10\n\t\t));\n\t\tlet expected_event = TestEvent::minterest_model(Event::MultiplierPerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).multiplier_per_block,\n\t\t\tRate::saturating_from_rational(2_000_000_000_000_000_000u128, BLOCKS_PER_YEAR)\n\t\t);\n\n\t\t//  Multiplier per block cannot be set to 0 at the same time as Base rate per block.\n\t\tassert_ok!(TestMinterestModel::set_base_rate_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t0,\n\t\t\t1\n\t\t));\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_multiplier_per_block(alice(), CurrencyId::DOT, 0, 1),\n\t\t\tError::\u003cTest\u003e::MultiplierPerBlockCannotBeZero\n\t\t);\n\n\t\t// Overflow in calculation: 20 / 0\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_multiplier_per_block(alice(), CurrencyId::DOT, 20, 0),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// The dispatch origin of this call must be Administrator.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_multiplier_per_block(bob(), CurrencyId::DOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::RequireAdmin\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn set_jump_multiplier_per_block_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(TestMinterestModel::set_jump_multiplier_per_block(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\t20,\n\t\t\t10\n\t\t));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).jump_multiplier_per_block,\n\t\t\tRate::saturating_from_rational(2_000_000_000_000_000_000u128, BLOCKS_PER_YEAR)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::JumpMultiplierPerBlockHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// Overflow in calculation: 20 / 0\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_jump_multiplier_per_block(alice(), CurrencyId::DOT, 20, 0),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// The dispatch origin of this call must be Administrator.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_jump_multiplier_per_block(bob(), CurrencyId::DOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::RequireAdmin\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_base_rate_per_block(alice(), CurrencyId::MDOT, 20, 10),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn set_kink_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\tassert_ok!(TestMinterestModel::set_kink(alice(), CurrencyId::DOT, 8, 10));\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::minterest_model_dates(CurrencyId::DOT).kink,\n\t\t\tRate::saturating_from_rational(8, 10)\n\t\t);\n\t\tlet expected_event = TestEvent::minterest_model(Event::KinkHasChanged);\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t// Overflow in calculation: 0 / 0\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_kink(alice(), CurrencyId::DOT, 0, 0),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\n\t\t// The dispatch origin of this call must be Administrator.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_kink(bob(), CurrencyId::DOT, 8, 10),\n\t\t\tError::\u003cTest\u003e::RequireAdmin\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_kink(alice(), CurrencyId::MDOT, 8, 10),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// Parameter `kink` cannot be more than one.\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::set_kink(alice(), CurrencyId::DOT, 18, 10),\n\t\t\tError::\u003cTest\u003e::KinkCannotBeMoreThanOne\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_borrow_interest_rate_should_work() {\n\tnew_test_ext().execute_with(|| {\n\t\t// Utilization rate less or equal than kink:\n\t\t// utilization_rate = 0.42\n\t\t// borrow_interest_rate = 0,42 * multiplier_per_block + base_rate_per_block\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::calculate_borrow_interest_rate(\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tRate::saturating_from_rational(42, 100)\n\t\t\t),\n\t\t\tOk(Rate::from_inner(3_780_000_000))\n\t\t);\n\n\t\t// Utilization rate larger than kink:\n\t\t// utilization_rate = 0.9\n\t\t// borrow_interest_rate = 0.9 * 0.8 * jump_multiplier_per_block +\n\t\t// + (0.8 * multiplier_per_block) + base_rate_per_block\n\t\tassert_eq!(\n\t\t\tTestMinterestModel::calculate_borrow_interest_rate(CurrencyId::DOT, Rate::saturating_from_rational(9, 10)),\n\t\t\tOk(Rate::from_inner(156_240_000_000))\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_borrow_interest_rate_fails_if_overflow_kink_mul_multiplier() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet minterest_model_data = multiplier_per_block_equal_max_value();\n\t\t\u003cMinterestModelDates\u003e::insert(CurrencyId::KSM, minterest_model_data.clone());\n\t\t// utilization_rate \u003e kink.\n\t\t// Overflow in calculation: kink * multiplier_per_block = 1.01 * max_value()\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::calculate_borrow_interest_rate(\n\t\t\t\tCurrencyId::KSM,\n\t\t\t\tRate::saturating_from_rational(101, 100)\n\t\t\t),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\t});\n}\n\n#[test]\nfn calculate_borrow_interest_rate_fails_if_overflow_add_base_rate_per_block() {\n\tnew_test_ext().execute_with(|| {\n\t\tlet minterest_model_data = base_rate_per_block_equal_max_value();\n\t\t\u003cMinterestModelDates\u003e::insert(CurrencyId::KSM, minterest_model_data.clone());\n\t\t// utilization_rate \u003e kink.\n\t\t// Overflow in calculation: kink_mul_multiplier + base_rate_per_block = ... + max_value()\n\t\tassert_noop!(\n\t\t\tTestMinterestModel::calculate_borrow_interest_rate(CurrencyId::KSM, Rate::saturating_from_rational(9, 10)),\n\t\t\tError::\u003cTest\u003e::NumOverflow\n\t\t);\n\t});\n}\n","traces":[{"line":8,"address":[4570576],"length":1,"stats":{"Line":1},"fn_name":"multiplier_per_block_equal_max_value"},{"line":10,"address":[4570583],"length":1,"stats":{"Line":1},"fn_name":null},{"line":11,"address":[4570620],"length":1,"stats":{"Line":1},"fn_name":null},{"line":12,"address":[4570649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":13,"address":[4570683],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[4570800],"length":1,"stats":{"Line":1},"fn_name":"base_rate_per_block_equal_max_value"},{"line":19,"address":[4570807],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[4570844],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[4570878],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4570903],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4538416,4538421],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":28,"address":[4538612,4538544],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":30,"address":[4538635],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[4538557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4538627],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[4539039,4539198,4538983],"length":1,"stats":{"Line":2},"fn_name":null},{"line":37,"address":[4538954],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[4538991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[4539142],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[4538448,4539507,4539172,4538462,4539762],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":44,"address":[4539800],"length":1,"stats":{"Line":1},"fn_name":null},{"line":45,"address":[4539707],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[4539792],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4540240,4540138,4540399],"length":1,"stats":{"Line":2},"fn_name":null},{"line":51,"address":[4540109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[4540173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4540343],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[4540708,4540963,4538510,4538496,4540373],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":58,"address":[4541001],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[4540908],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[4540993],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4541518,4541320],"length":1,"stats":{"Line":2},"fn_name":null},{"line":65,"address":[4541334],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[4541510],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[4542799,4542597],"length":1,"stats":{"Line":2},"fn_name":null},{"line":71,"address":[4542616],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4542791],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4544060,4543878],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[4543897],"length":1,"stats":{"Line":1},"fn_name":null},{"line":78,"address":[4544052],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[4545321,4545139],"length":1,"stats":{"Line":2},"fn_name":null},{"line":83,"address":[4545158],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[4545313],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[4546592,4546597],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":91,"address":[4546720,4546788],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":93,"address":[4546811],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4546733],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[4546803],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[4547181],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4547120],"length":1,"stats":{"Line":1},"fn_name":null},{"line":103,"address":[4547173],"length":1,"stats":{"Line":1},"fn_name":null},{"line":107,"address":[4547585,4547744,4547529],"length":1,"stats":{"Line":2},"fn_name":null},{"line":108,"address":[4547500],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[4547537],"length":1,"stats":{"Line":1},"fn_name":null},{"line":111,"address":[4547688],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[4547718,4546624,4546638,4548308,4548053],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":115,"address":[4548346],"length":1,"stats":{"Line":1},"fn_name":null},{"line":116,"address":[4548253],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[4548338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[4548655],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[4548685,4548937,4546686,4546672],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":123,"address":[4548967,4549238,4549069],"length":1,"stats":{"Line":2},"fn_name":null},{"line":124,"address":[4548906],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[4549002],"length":1,"stats":{"Line":1},"fn_name":null},{"line":129,"address":[4549547],"length":1,"stats":{"Line":1},"fn_name":null},{"line":130,"address":[4549172],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[4549539],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[4549866,4550064],"length":1,"stats":{"Line":2},"fn_name":null},{"line":136,"address":[4549880],"length":1,"stats":{"Line":1},"fn_name":null},{"line":137,"address":[4550056],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[4551143,4551345],"length":1,"stats":{"Line":2},"fn_name":null},{"line":142,"address":[4551162],"length":1,"stats":{"Line":1},"fn_name":null},{"line":143,"address":[4551337],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[4552424,4552606],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[4552443],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[4552598],"length":1,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[4553867,4553685],"length":1,"stats":{"Line":2},"fn_name":null},{"line":154,"address":[4553704],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[4553859],"length":1,"stats":{"Line":1},"fn_name":null},{"line":161,"address":[4555152,4555157],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":162,"address":[4555294,4555232],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":163,"address":[4555317],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[4555239],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[4555309],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[4555655,4555757,4555916],"length":1,"stats":{"Line":2},"fn_name":null},{"line":170,"address":[4555626],"length":1,"stats":{"Line":1},"fn_name":null},{"line":171,"address":[4555690],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[4555860],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[4555198,4555890,4556225,4555184,4556441],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":177,"address":[4556425,4556654],"length":1,"stats":{"Line":2},"fn_name":null},{"line":178,"address":[4556471],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[4556646],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[4557733,4557915],"length":1,"stats":{"Line":2},"fn_name":null},{"line":184,"address":[4557752],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[4557907],"length":1,"stats":{"Line":1},"fn_name":null},{"line":189,"address":[4559176,4558994],"length":1,"stats":{"Line":2},"fn_name":null},{"line":190,"address":[4559013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[4559168],"length":1,"stats":{"Line":1},"fn_name":null},{"line":197,"address":[4560373,4560368],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":198,"address":[4560448,4560510],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":199,"address":[4560525,4560455],"length":1,"stats":{"Line":2},"fn_name":null},{"line":200,"address":[4560926,4561085],"length":1,"stats":{"Line":1},"fn_name":null},{"line":201,"address":[4560842],"length":1,"stats":{"Line":1},"fn_name":null},{"line":202,"address":[4560897],"length":1,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[4561029],"length":1,"stats":{"Line":1},"fn_name":null},{"line":205,"address":[4560400,4561059,4561394,4561610,4560414],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}"},{"line":208,"address":[4561594,4561826],"length":1,"stats":{"Line":2},"fn_name":null},{"line":209,"address":[4561640],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4561818],"length":1,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[4562905,4563087],"length":1,"stats":{"Line":2},"fn_name":null},{"line":215,"address":[4562924],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4563079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":220,"address":[4564348,4564166],"length":1,"stats":{"Line":2},"fn_name":null},{"line":221,"address":[4564185],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[4564340],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[4565609,4565427],"length":1,"stats":{"Line":2},"fn_name":null},{"line":227,"address":[4565446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[4565601],"length":1,"stats":{"Line":1},"fn_name":null},{"line":234,"address":[4566869,4566864],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":235,"address":[4566896],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":239,"address":[4567059,4567216],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[4566942],"length":1,"stats":{"Line":1},"fn_name":null},{"line":241,"address":[4566903],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[4566911],"length":1,"stats":{"Line":1},"fn_name":null},{"line":244,"address":[4566981],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[4567594,4567703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[4567167,4567487],"length":1,"stats":{"Line":2},"fn_name":null},{"line":253,"address":[4567523],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[4567984,4567989],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":260,"address":[4568038,4568016],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":261,"address":[4568023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[4568053],"length":1,"stats":{"Line":1},"fn_name":null},{"line":265,"address":[4568103,4568224],"length":1,"stats":{"Line":2},"fn_name":null},{"line":266,"address":[4568158],"length":1,"stats":{"Line":1},"fn_name":null},{"line":267,"address":[4568117],"length":1,"stats":{"Line":1},"fn_name":null},{"line":268,"address":[4568135],"length":1,"stats":{"Line":1},"fn_name":null},{"line":270,"address":[4568216],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[4569285,4569280],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":277,"address":[4569334,4569312],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":278,"address":[4569319],"length":1,"stats":{"Line":1},"fn_name":null},{"line":279,"address":[4569349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[4569520,4569399],"length":1,"stats":{"Line":2},"fn_name":null},{"line":283,"address":[4569413],"length":1,"stats":{"Line":1},"fn_name":null},{"line":284,"address":[4569512],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":144,"coverable":144},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-protocol","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage, ensure};\nuse frame_system::{self as system, ensure_signed};\nuse minterest_primitives::{Balance, CurrencyId, Operation};\nuse orml_traits::MultiCurrency;\nuse orml_utilities::with_transaction_result;\nuse pallet_traits::Borrowing;\nuse sp_runtime::{traits::Zero, DispatchError, DispatchResult};\nuse sp_std::cmp::Ordering;\nuse sp_std::result;\n\n#[cfg(test)]\nmod mock;\n#[cfg(test)]\nmod tests;\n\npub trait Trait: liquidity_pools::Trait + controller::Trait {\n\t/// The overarching event type.\n\ttype Event: From\u003cEvent\u003cSelf\u003e\u003e + Into\u003c\u003cSelf as system::Trait\u003e::Event\u003e;\n\n\t/// Basic borrowing functions\n\ttype Borrowing: Borrowing\u003cSelf::AccountId\u003e;\n}\n\ntype LiquidityPools\u003cT\u003e = liquidity_pools::Module\u003cT\u003e;\ntype Controller\u003cT\u003e = controller::Module\u003cT\u003e;\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as MinterestProtocol {\n\t}\n}\n\ndecl_event!(\n\tpub enum Event\u003cT\u003e where\n\t\t\u003cT as system::Trait\u003e::AccountId,\n\t{\n\t\t/// Underlying assets added to pool and wrapped tokens minted: \\[who, underlying_asset_id, underlying_amount, wrapped_currency_id, wrapped_amount\\]\n\t\tDeposited(AccountId, CurrencyId, Balance, CurrencyId, Balance),\n\n\t\t/// Underlying assets and wrapped tokens redeemed: \\[who, underlying_asset_id, underlying_amount, wrapped_currency_id, wrapped_amount\\]\n\t\tRedeemed(AccountId, CurrencyId, Balance, CurrencyId, Balance),\n\n\t\t/// Borrowed a specific amount of the pool currency: \\[who, underlying_asset_id, the_amount_to_be_borrowed\\]\n\t\tBorrowed(AccountId, CurrencyId, Balance),\n\n\t\t/// Repaid a borrow on the specific pool, for the specified amount: \\[who, underlying_asset_id, the_amount_repaid\\]\n\t\tRepaid(AccountId, CurrencyId, Balance),\n\n\t\t/// The user allowed the assets in the pool to be used as collateral: \\[who, pool_id\\]\n\t\tPoolEnabledAsCollateral(AccountId, CurrencyId),\n\n\t\t/// The user denies use the assets in pool as collateral: \\[who, pool_id\\]\n\t\tPoolDisabledCollateral(AccountId, CurrencyId),\n\t}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t\t/// The currency is not enabled in protocol.\n\t\tNotValidUnderlyingAssetId,\n\n\t\t/// The currency is not enabled in wrapped protocol.\n\t\tNotValidWrappedTokenId,\n\n\t\t/// There is not enough liquidity available in the pool.\n\t\tNotEnoughLiquidityAvailable,\n\n\t\t/// Insufficient wrapped tokens in the user account.\n\t\tNotEnoughWrappedTokens,\n\n\t\t/// User did not make deposit (no mTokens).\n\t\tNumberOfWrappedTokensIsZero,\n\n\t\t/// Insufficient underlying assets in the user account.\n\t\tNotEnoughUnderlyingsAssets,\n\n\t\t/// Number overflow in calculation.\n\t\tNumOverflow,\n\n\t\t/// An internal failure occurred in the execution of the Accrue Interest function.\n\t\tAccrueInterestFailed,\n\n\t\t/// Deposit was blocked due to Controller rejection.\n\t\tDepositControllerRejection,\n\n\t\t/// Redeem was blocked due to Controller rejection.\n\t\tRedeemControllerRejection,\n\n\t\t/// Borrow was blocked due to Controller rejection.\n\t\tBorrowControllerRejection,\n\n\t\t/// Repay was blocked due to Controller rejection.\n\t\tRepayBorrowControllerRejection,\n\n\t\t/// Transaction with zero balance is not allowed.\n\t\tZeroBalanceTransaction,\n\n\t\t/// User is trying repay more than he borrowed.\n\t\tRepayAmountToBig,\n\n\t\t/// This pool is already collateral.\n\t\tAlreadyCollateral,\n\n\t\t/// This pool has already been disabled as a collateral.\n\t\tAlreadyDisabledCollateral,\n\n\t\t/// The user has an outstanding borrow. Cannot be disabled as collateral.\n\t\tCanotBeDisabledAsCollateral,\n\n\t\t/// The user has not deposited funds into the pool.\n\t\tCanotBeEnabledAsCollateral,\n\n\t\t/// Operation (deposit, redeem, borrow, repay) is paused.\n\t\tOperationPaused,\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\t\tfn deposit_event() = default;\n\n\t\t/// Transfers an asset into the protocol. The user receives a quantity of mTokens equal\n\t\t/// to the underlying tokens supplied, divided by the current Exchange Rate.\n\t\t///\n\t\t/// - `underlying_asset_id`: CurrencyId of underlying assets to be transferred into the protocol.\n\t\t/// - `underlying_amount`: The amount of the asset to be supplied, in units of the underlying asset.\n\t\t#[weight = 10_000]\n\t\tpub fn deposit_underlying(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t\t#[compact] underlying_amount: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet (_, wrapped_id, wrapped_amount) = Self::do_deposit(\u0026who, underlying_asset_id, underlying_amount)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Deposited(who, underlying_asset_id, underlying_amount, wrapped_id, wrapped_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Converts ALL mTokens into a specified quantity of the underlying asset, and returns them\n\t\t/// to the user. The amount of underlying tokens received is equal to the quantity of\n\t\t/// mTokens redeemed, multiplied by the current Exchange Rate.\n\t\t///\n\t\t/// - `underlying_asset_id`: CurrencyId of underlying assets to be redeemed.\n\t\t#[weight = 10_000]\n\t\tpub fn redeem(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet (underlying_amount, wrapped_id, wrapped_amount) = Self::do_redeem(\u0026who, underlying_asset_id, Balance::zero(), Balance::zero(), true)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Redeemed(who, underlying_asset_id, underlying_amount, wrapped_id, wrapped_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Converts mTokens into a specified quantity of the underlying asset, and returns them to\n\t\t/// the user. The amount of mTokens redeemed is equal to the quantity of underlying tokens\n\t\t/// received, divided by the current Exchange Rate.\n\t\t///\n\t\t/// - `underlying_asset_id`: CurrencyId of underlying assets to be redeemed.\n\t\t/// - `underlying_amount`: The number of underlying assets to be redeemed.\n\t\t#[weight = 10_000]\n\t\tpub fn redeem_underlying(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t\t#[compact] underlying_amount: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet (_, wrapped_id, wrapped_amount) = Self::do_redeem(\u0026who, underlying_asset_id, underlying_amount, Balance::zero(), false)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Redeemed(who, underlying_asset_id, underlying_amount, wrapped_id, wrapped_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Converts a specified quantity of mTokens into the underlying asset, and returns them to the user.\n\t\t/// The amount of underlying tokens received is equal to the quantity of mTokens redeemed,\n\t\t/// multiplied by the current Exchange Rate.\n\t\t///\n\t\t/// - `wrapped_id`: CurrencyId of mTokens to be redeemed.\n\t\t/// - `wrapped_amount`: The number of mTokens to be redeemed.\n\t\t#[weight = 10_000]\n\t\tpub fn redeem_wrapped(origin, wrapped_id: CurrencyId, #[compact] wrapped_amount: Balance) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet underlying_asset_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_underlying_asset_id_by_wrapped_id(\u0026wrapped_id).map_err(|_| Error::\u003cT\u003e::NotValidWrappedTokenId)?;\n\t\t\t\tlet (underlying_amount, wrapped_id, _) = Self::do_redeem(\u0026who, underlying_asset_id, Balance::zero(), wrapped_amount, false)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Redeemed(who, underlying_asset_id, underlying_amount, wrapped_id, wrapped_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Borrowing a specific amount of the pool currency, provided that the borrower already\n\t\t/// deposited enough collateral.\n\t\t///\n\t\t/// - `underlying_asset_id`: The currency ID of the underlying asset to be borrowed.\n\t\t/// - `underlying_amount`: The amount of the underlying asset to be borrowed.\n\t\t#[weight = 10_000]\n\t\tpub fn borrow(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t\t#[compact] borrow_amount: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tSelf::do_borrow(\u0026who, underlying_asset_id, borrow_amount)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Borrowed(who, underlying_asset_id, borrow_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Repays a borrow on the specific pool, for the specified amount.\n\t\t///\n\t\t/// - `underlying_asset_id`: The currency ID of the underlying asset to be repaid.\n\t\t/// - `repay_amount`: The amount of the underlying asset to be repaid.\n\t\t#[weight = 10_000]\n\t\tpub fn repay(\n\t\t\torigin,\n\t\t\tunderlying_asset_id: CurrencyId,\n\t\t\t#[compact] repay_amount: Balance\n\t\t) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tSelf::do_repay(\u0026who, \u0026who, underlying_asset_id, repay_amount, false)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Repaid(who, underlying_asset_id, repay_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Repays a borrow on the specific pool, for the all amount.\n\t\t///\n\t\t/// - `underlying_asset_id`: The currency ID of the underlying asset to be repaid.\n\t\t#[weight = 10_000]\n\t\tpub fn repay_all(origin, underlying_asset_id: CurrencyId) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet repay_amount = Self::do_repay(\u0026who, \u0026who, underlying_asset_id, Balance::zero(), true)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Repaid(who, underlying_asset_id, repay_amount));\n\t\t\t\tOk(())\n\t\t\t})?;\n\t\t}\n\n\t\t/// Transfers an asset into the protocol, reducing the target user's borrow balance.\n\t\t///\n\t\t/// - `underlying_asset_id`: The currency ID of the underlying asset to be repaid.\n\t\t/// - `borrower`: The account which borrowed the asset to be repaid.\n\t\t/// - `repay_amount`: The amount of the underlying borrowed asset to be repaid.\n\t\t#[weight = 10_000]\n\t\tpub fn repay_on_behalf(origin, underlying_asset_id: CurrencyId, borrower: T::AccountId, repay_amount: Balance) {\n\t\t\twith_transaction_result(|| {\n\t\t\t\tlet who = ensure_signed(origin)?;\n\t\t\t\tlet repay_amount = Self::do_repay(\u0026who, \u0026borrower, underlying_asset_id, repay_amount, false)?;\n\t\t\t\tSelf::deposit_event(RawEvent::Repaid(who, underlying_asset_id, repay_amount));\n\t\t\t\tOk(())\n\t\t\t})?\n\t\t}\n\n\t\t/// Sender allowed the assets in the pool to be used as collateral.\n\t\t#[weight = 10_000]\n\t\tpub fn enable_as_collateral(origin, pool_id: CurrencyId) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\tensure!(!\u003cLiquidityPools\u003cT\u003e\u003e::check_user_available_collateral(\u0026sender, pool_id), Error::\u003cT\u003e::AlreadyCollateral);\n\n\t\t\t// If user does not have assets in the pool, then he cannot enable as collateral the pool.\n\t\t\tlet wrapped_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_wrapped_id_by_underlying_asset_id(\u0026pool_id)?;\n\t\t\tlet user_wrapped_balance = T::MultiCurrency::free_balance(wrapped_id, \u0026sender);\n\t\t\tensure!(user_wrapped_balance \u003e 0, Error::\u003cT\u003e::CanotBeEnabledAsCollateral);\n\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::enable_as_collateral_internal(\u0026sender, pool_id)?;\n\t\t\tSelf::deposit_event(RawEvent::PoolEnabledAsCollateral(sender, pool_id));\n\t\t\tOk(())\n\t\t}\n\n\t\t/// Sender has denies use the assets in pool as collateral.\n\t\t#[weight = 10_000]\n\t\tpub fn disable_collateral(origin, pool_id: CurrencyId) -\u003e DispatchResult {\n\t\t\tlet sender = ensure_signed(origin)?;\n\t\t\tensure!(\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(pool_id),\n\t\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\tensure!(\u003cLiquidityPools\u003cT\u003e\u003e::check_user_available_collateral(\u0026sender, pool_id), Error::\u003cT\u003e::AlreadyDisabledCollateral);\n\n\t\t\tlet wrapped_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_wrapped_id_by_underlying_asset_id(\u0026pool_id)?;\n\t\t\tlet user_balance_wrapped_tokens = T::MultiCurrency::free_balance(wrapped_id, \u0026sender);\n\t\t\tlet user_balance_disabled_asset = \u003cLiquidityPools\u003cT\u003e\u003e::convert_from_wrapped(wrapped_id, user_balance_wrapped_tokens)?;\n\n\t\t\t// Check if the user will have enough collateral if he removes one of the collaterals.\n\t\t\tlet (_, shortfall) = \u003cController\u003cT\u003e\u003e::get_hypothetical_account_liquidity(\u0026sender, pool_id, user_balance_disabled_asset, 0)?;\n\t\t\tensure!(!(shortfall \u003e 0), Error::\u003cT\u003e::CanotBeDisabledAsCollateral);\n\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::disable_collateral_internal(\u0026sender, pool_id)?;\n\t\t\tSelf::deposit_event(RawEvent::PoolDisabledCollateral(sender, pool_id));\n\t\t\tOk(())\n\t\t}\n\t}\n}\n\ntype TokensResult = result::Result\u003c(Balance, CurrencyId, Balance), DispatchError\u003e;\ntype BalanceResult = result::Result\u003cBalance, DispatchError\u003e;\n\n// Dispatchable calls implementation\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tfn do_deposit(who: \u0026T::AccountId, underlying_asset_id: CurrencyId, underlying_amount: Balance) -\u003e TokensResult {\n\t\tensure!(\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\tensure!(underlying_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\n\t\tensure!(\n\t\t\tunderlying_amount \u003c= T::MultiCurrency::free_balance(underlying_asset_id, \u0026who),\n\t\t\tError::\u003cT\u003e::NotEnoughLiquidityAvailable\n\t\t);\n\n\t\t\u003cController\u003cT\u003e\u003e::accrue_interest_rate(underlying_asset_id).map_err(|_| Error::\u003cT\u003e::AccrueInterestFailed)?;\n\n\t\t// Fail if deposit not allowed\n\t\tensure!(\n\t\t\t\u003cController\u003cT\u003e\u003e::is_operation_allowed(underlying_asset_id, Operation::Deposit),\n\t\t\tError::\u003cT\u003e::OperationPaused\n\t\t);\n\n\t\tlet wrapped_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_wrapped_id_by_underlying_asset_id(\u0026underlying_asset_id)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NotValidUnderlyingAssetId)?;\n\n\t\tlet wrapped_amount = \u003cLiquidityPools\u003cT\u003e\u003e::convert_to_wrapped(underlying_asset_id, underlying_amount)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\n\t\tT::MultiCurrency::transfer(\n\t\t\tunderlying_asset_id,\n\t\t\t\u0026who,\n\t\t\t\u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(),\n\t\t\tunderlying_amount,\n\t\t)?;\n\n\t\tT::MultiCurrency::deposit(wrapped_id, \u0026who, wrapped_amount)?;\n\n\t\tOk((underlying_amount, wrapped_id, wrapped_amount))\n\t}\n\n\tfn do_redeem(\n\t\twho: \u0026T::AccountId,\n\t\tunderlying_asset_id: CurrencyId,\n\t\tmut underlying_amount: Balance,\n\t\twrapped_amount: Balance,\n\t\tall_assets: bool,\n\t) -\u003e TokensResult {\n\t\tensure!(\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t\u003cController\u003cT\u003e\u003e::accrue_interest_rate(underlying_asset_id).map_err(|_| Error::\u003cT\u003e::AccrueInterestFailed)?;\n\n\t\tlet wrapped_id = \u003cLiquidityPools\u003cT\u003e\u003e::get_wrapped_id_by_underlying_asset_id(\u0026underlying_asset_id)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NotValidUnderlyingAssetId)?;\n\n\t\tlet wrapped_amount = match (underlying_amount, wrapped_amount, all_assets) {\n\t\t\t(0, 0, true) =\u003e {\n\t\t\t\tlet total_wrapped_amount = T::MultiCurrency::free_balance(wrapped_id, \u0026who);\n\t\t\t\tensure!(!total_wrapped_amount.is_zero(), Error::\u003cT\u003e::NumberOfWrappedTokensIsZero);\n\t\t\t\tunderlying_amount = \u003cLiquidityPools\u003cT\u003e\u003e::convert_from_wrapped(wrapped_id, total_wrapped_amount)\n\t\t\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\ttotal_wrapped_amount\n\t\t\t}\n\t\t\t(_, 0, false) =\u003e {\n\t\t\t\tensure!(underlying_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\t\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::convert_to_wrapped(underlying_asset_id, underlying_amount)\n\t\t\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?\n\t\t\t}\n\t\t\t_ =\u003e {\n\t\t\t\tensure!(wrapped_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\t\t\t\tunderlying_amount = \u003cLiquidityPools\u003cT\u003e\u003e::convert_from_wrapped(wrapped_id, wrapped_amount)\n\t\t\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\t\t\t\twrapped_amount\n\t\t\t}\n\t\t};\n\n\t\tensure!(\n\t\t\tunderlying_amount \u003c= \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_available_liquidity(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotEnoughLiquidityAvailable\n\t\t);\n\n\t\tensure!(\n\t\t\twrapped_amount \u003c= T::MultiCurrency::free_balance(wrapped_id, \u0026who),\n\t\t\tError::\u003cT\u003e::NotEnoughWrappedTokens\n\t\t);\n\n\t\t// Fail if redeem not allowed\n\t\tensure!(\n\t\t\t\u003cController\u003cT\u003e\u003e::is_operation_allowed(underlying_asset_id, Operation::Redeem),\n\t\t\tError::\u003cT\u003e::OperationPaused\n\t\t);\n\t\t\u003cController\u003cT\u003e\u003e::redeem_allowed(underlying_asset_id, \u0026who, wrapped_amount)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::RedeemControllerRejection)?;\n\n\t\tT::MultiCurrency::withdraw(wrapped_id, \u0026who, wrapped_amount)?;\n\n\t\tT::MultiCurrency::transfer(\n\t\t\tunderlying_asset_id,\n\t\t\t\u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(),\n\t\t\t\u0026who,\n\t\t\tunderlying_amount,\n\t\t)?;\n\n\t\tOk((underlying_amount, wrapped_id, wrapped_amount))\n\t}\n\n\t/// Users borrow assets from the protocol to their own address\n\t///\n\t/// - `who`: the address of the user who borrows.\n\t/// - `underlying_asset_id`: the currency ID of the underlying asset to borrow.\n\t/// - `underlying_amount`: the amount of the underlying asset to borrow.\n\tfn do_borrow(who: \u0026T::AccountId, underlying_asset_id: CurrencyId, borrow_amount: Balance) -\u003e DispatchResult {\n\t\tensure!(\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\tlet pool_available_liquidity = \u003cLiquidityPools\u003cT\u003e\u003e::get_pool_available_liquidity(underlying_asset_id);\n\n\t\t// Raise an error if protocol has insufficient underlying cash.\n\t\tensure!(\n\t\t\tborrow_amount \u003c= pool_available_liquidity,\n\t\t\tError::\u003cT\u003e::NotEnoughLiquidityAvailable\n\t\t);\n\n\t\tensure!(borrow_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\n\t\t\u003cController\u003cT\u003e\u003e::accrue_interest_rate(underlying_asset_id).map_err(|_| Error::\u003cT\u003e::AccrueInterestFailed)?;\n\n\t\t// Fail if borrow not allowed.\n\t\tensure!(\n\t\t\t\u003cController\u003cT\u003e\u003e::is_operation_allowed(underlying_asset_id, Operation::Borrow),\n\t\t\tError::\u003cT\u003e::OperationPaused\n\t\t);\n\t\t\u003cController\u003cT\u003e\u003e::borrow_allowed(underlying_asset_id, \u0026who, borrow_amount)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::BorrowControllerRejection)?;\n\n\t\t// Fetch the amount the borrower owes, with accumulated interest.\n\t\tlet account_borrows =\n\t\t\t\u003cController\u003cT\u003e\u003e::borrow_balance_stored(\u0026who, underlying_asset_id).map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::update_state_on_borrow(\u0026who, underlying_asset_id, borrow_amount, account_borrows)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\n\t\t// Transfer the borrow_amount from the protocol account to the borrower's account.\n\t\tT::MultiCurrency::transfer(\n\t\t\tunderlying_asset_id,\n\t\t\t\u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(),\n\t\t\t\u0026who,\n\t\t\tborrow_amount,\n\t\t)?;\n\n\t\tOk(())\n\t}\n\n\t/// Sender repays their own borrow\n\t///\n\t/// - `who`: the account paying off the borrow.\n\t/// - `borrower`: the account with the debt being payed off.\n\t/// - `underlying_asset_id`: the currency ID of the underlying asset to repay.\n\t/// - `repay_amount`: the amount of the underlying asset to repay.\n\tfn do_repay(\n\t\twho: \u0026T::AccountId,\n\t\tborrower: \u0026T::AccountId,\n\t\tunderlying_asset_id: CurrencyId,\n\t\tmut repay_amount: Balance,\n\t\tall_assets: bool,\n\t) -\u003e BalanceResult {\n\t\tensure!(\n\t\t\t\u003cLiquidityPools\u003cT\u003e\u003e::is_enabled_underlying_asset_id(underlying_asset_id),\n\t\t\tError::\u003cT\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\tif !all_assets {\n\t\t\tensure!(repay_amount \u003e Balance::zero(), Error::\u003cT\u003e::ZeroBalanceTransaction);\n\t\t}\n\n\t\t\u003cController\u003cT\u003e\u003e::accrue_interest_rate(underlying_asset_id).map_err(|_| Error::\u003cT\u003e::AccrueInterestFailed)?;\n\n\t\t// Fail if repay_borrow not allowed\n\t\tensure!(\n\t\t\t\u003cController\u003cT\u003e\u003e::is_operation_allowed(underlying_asset_id, Operation::Repay),\n\t\t\tError::\u003cT\u003e::OperationPaused\n\t\t);\n\n\t\t// Fetch the amount the borrower owes, with accumulated interest\n\t\tlet account_borrows = \u003cController\u003cT\u003e\u003e::borrow_balance_stored(\u0026borrower, underlying_asset_id)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::NumOverflow)?;\n\n\t\trepay_amount = match repay_amount.cmp(\u0026Balance::zero()) {\n\t\t\tOrdering::Equal =\u003e account_borrows,\n\t\t\t_ =\u003e repay_amount,\n\t\t};\n\n\t\tensure!(\n\t\t\trepay_amount \u003c= T::MultiCurrency::free_balance(underlying_asset_id, \u0026who),\n\t\t\tError::\u003cT\u003e::NotEnoughUnderlyingsAssets\n\t\t);\n\n\t\t\u003cLiquidityPools\u003cT\u003e\u003e::update_state_on_repay(\u0026borrower, underlying_asset_id, repay_amount, account_borrows)\n\t\t\t.map_err(|_| Error::\u003cT\u003e::RepayAmountToBig)?;\n\n\t\t// Transfer the repay_amount from the borrower's account to the protocol account.\n\t\tT::MultiCurrency::transfer(\n\t\t\tunderlying_asset_id,\n\t\t\t\u0026who,\n\t\t\t\u0026\u003cLiquidityPools\u003cT\u003e\u003e::pools_account_id(),\n\t\t\trepay_amount,\n\t\t)?;\n\n\t\tOk(repay_amount)\n\t}\n}\n","traces":[{"line":29,"address":[4934400,4934384,4934293,4934272,4934352],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":34,"address":[5372563,5374045,5375706,5372041,5375293,5373565,5376183,5374242,5375683,5375270,5374865,5373043,5374674],"length":1,"stats":{"Line":9},"fn_name":null},{"line":39,"address":[5372666,5380836,5382929,5372046,5371816,5378164,5372324,5372776,5383156,5372476,5375892,5371994,5372151,5377783,5372719,5371875,5380455],"length":1,"stats":{"Line":6},"fn_name":null},{"line":42,"address":[5383297,5378790,5383521,5372818,5373153,5381095,5372996,5373478,5375897,5373778,5378409,5373326,5373048,5372877,5373721,5381476,5373668],"length":1,"stats":{"Line":6},"fn_name":null},{"line":45,"address":[5383641,5374050,5374350,5374407,5381735,5373998,5373820,5381968,5373879,5375902,5379268,5379035,5374297,5374155],"length":1,"stats":{"Line":6},"fn_name":null},{"line":48,"address":[5374973,5374778,5375021,5374508,5382275,5374679,5375907,5379574,5374449,5374627,5383822,5379344,5382045,5374920],"length":1,"stats":{"Line":6},"fn_name":null},{"line":51,"address":[5379647,5384003,5375275,5375323,5382518,5375119,5375226,5375371,5375419,5375912,5382349,5379815,5375060],"length":1,"stats":{"Line":6},"fn_name":null},{"line":54,"address":[5375781,5379996,5375532,5375829,5375688,5375917,5382854,5379831,5375639,5375736,5382534,5382700,5384121,5375458],"length":1,"stats":{"Line":6},"fn_name":null},{"line":119,"address":[6488017,6486502,6490530,6490049,6490002,6489550,6489392,6487673,6490737,6490967,6489831,6489140,6488551,6488178,6490256,6486229,6490900,6485896,6490620,6487512,6487827,6487007,6490393,6489699,6489188,6486050,6490483,6488933,6486663,6489438,6485735,6489654,6486284,6487168,6489761,6488326,6490119,6487322,6488754,6486817,6488505,6490346,6490667,6485401,6485545,6490209],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[6508863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[5387276,5387159,5387355,5387664,5387737],"length":1,"stats":{"Line":35},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":136,"address":[5387856,5387912,5387897,5387674,5387760],"length":1,"stats":{"Line":28},"fn_name":null},{"line":137,"address":[5388221,5388346,5387818,5387949],"length":1,"stats":{"Line":27},"fn_name":null},{"line":138,"address":[5388106],"length":1,"stats":{"Line":14},"fn_name":null},{"line":139,"address":[5388356],"length":1,"stats":{"Line":14},"fn_name":null},{"line":148,"address":[6509316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[5390656,5390347,5390729,5390167,5390268],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":154,"address":[5390895,5390880,5390839,5390752,5390666],"length":1,"stats":{"Line":6},"fn_name":null},{"line":155,"address":[5391441,5390916,5391316,5390810],"length":1,"stats":{"Line":8},"fn_name":null},{"line":156,"address":[5391210],"length":1,"stats":{"Line":3},"fn_name":null},{"line":157,"address":[5391451],"length":1,"stats":{"Line":3},"fn_name":null},{"line":167,"address":[6509609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[5393467,5393271,5393388,5393849,5393776],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":174,"address":[5394021,5393980,5393872,5394036,5393786],"length":1,"stats":{"Line":6},"fn_name":null},{"line":175,"address":[5393930,5394542,5394417,5394057],"length":1,"stats":{"Line":8},"fn_name":null},{"line":176,"address":[5394302],"length":1,"stats":{"Line":3},"fn_name":null},{"line":177,"address":[5394552],"length":1,"stats":{"Line":3},"fn_name":null},{"line":187,"address":[6510085],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[5396912,5396492,5396571,5396375,5396985],"length":1,"stats":{"Line":4},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":190,"address":[5397141,5396922,5397126,5397008,5397085],"length":1,"stats":{"Line":2},"fn_name":null},{"line":191,"address":[5396880,5397377,5397066,5396884,5397303,5397170],"length":1,"stats":{"Line":6},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":192,"address":[5397387,5397745,5397286],"length":1,"stats":{"Line":3},"fn_name":null},{"line":193,"address":[5397635],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[5397864],"length":1,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[6510561],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[5399883,5400192,5400265,5399687,5399804],"length":1,"stats":{"Line":22},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":210,"address":[5400381,5400202,5400437,5400422,5400288],"length":1,"stats":{"Line":16},"fn_name":null},{"line":211,"address":[5400468,5400584,5400346,5400703],"length":1,"stats":{"Line":16},"fn_name":null},{"line":212,"address":[5400495],"length":1,"stats":{"Line":8},"fn_name":null},{"line":213,"address":[5400713],"length":1,"stats":{"Line":5},"fn_name":null},{"line":221,"address":[6511037],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[5402731,5402652,5403113,5403040,5402535],"length":1,"stats":{"Line":9},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":228,"address":[5403287,5403050,5403136,5403246,5403302],"length":1,"stats":{"Line":6},"fn_name":null},{"line":229,"address":[5403591,5403336,5403472,5403194],"length":1,"stats":{"Line":7},"fn_name":null},{"line":230,"address":[5403383],"length":1,"stats":{"Line":3},"fn_name":null},{"line":231,"address":[5403601],"length":1,"stats":{"Line":3},"fn_name":null},{"line":238,"address":[6511490],"length":1,"stats":{"Line":0},"fn_name":null},{"line":240,"address":[5405595,5405977,5405516,5405904,5405415],"length":1,"stats":{"Line":13},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":241,"address":[5406000,5406143,5405914,5406128,5406087],"length":1,"stats":{"Line":10},"fn_name":null},{"line":242,"address":[5406388,5406513,5406164,5406058],"length":1,"stats":{"Line":11},"fn_name":null},{"line":243,"address":[5406307],"length":1,"stats":{"Line":4},"fn_name":null},{"line":244,"address":[5406523],"length":1,"stats":{"Line":4},"fn_name":null},{"line":253,"address":[6511779],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[5408953,5408582,5408503,5408880,5408370],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}\u003cminterest_protocol::mock::Test\u003e"},{"line":256,"address":[5409143,5409087,5408976,5409128,5408890],"length":1,"stats":{"Line":2},"fn_name":null},{"line":257,"address":[5409437,5409177,5409318,5409034],"length":1,"stats":{"Line":3},"fn_name":null},{"line":258,"address":[5409240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[5409447],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[6512091],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[5411497,5411411,5411299,5411550,5411376],"length":1,"stats":{"Line":9},"fn_name":null},{"line":267,"address":[5411751,5411669,5411628],"length":1,"stats":{"Line":5},"fn_name":null},{"line":268,"address":[5411478],"length":1,"stats":{"Line":3},"fn_name":null},{"line":269,"address":[5411661],"length":1,"stats":{"Line":1},"fn_name":null},{"line":272,"address":[5411760,5411634,5411791],"length":1,"stats":{"Line":7},"fn_name":null},{"line":275,"address":[5411962,5411920,5411784,5411886],"length":1,"stats":{"Line":9},"fn_name":null},{"line":276,"address":[5411912,5411944,5412085],"length":1,"stats":{"Line":9},"fn_name":null},{"line":277,"address":[5412151,5412106],"length":1,"stats":{"Line":4},"fn_name":null},{"line":279,"address":[5412246,5412120,5412335],"length":1,"stats":{"Line":8},"fn_name":null},{"line":280,"address":[5412276],"length":1,"stats":{"Line":4},"fn_name":null},{"line":281,"address":[5412460],"length":1,"stats":{"Line":4},"fn_name":null},{"line":285,"address":[6512334],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[5414537,5414788,5414735,5414614,5414649],"length":1,"stats":{"Line":6},"fn_name":null},{"line":288,"address":[5414866,5414907,5414989],"length":1,"stats":{"Line":5},"fn_name":null},{"line":289,"address":[5414716],"length":1,"stats":{"Line":2},"fn_name":null},{"line":290,"address":[5414899],"length":1,"stats":{"Line":1},"fn_name":null},{"line":293,"address":[5414872,5415027,5414998],"length":1,"stats":{"Line":5},"fn_name":null},{"line":295,"address":[5415201,5415020,5415122],"length":1,"stats":{"Line":4},"fn_name":null},{"line":296,"address":[5415169,5415325],"length":1,"stats":{"Line":4},"fn_name":null},{"line":297,"address":[5415350,5415518],"length":1,"stats":{"Line":2},"fn_name":null},{"line":300,"address":[5415459,5415653,5415784],"length":1,"stats":{"Line":4},"fn_name":null},{"line":301,"address":[5415757,5415932],"length":1,"stats":{"Line":3},"fn_name":null},{"line":303,"address":[5416027,5416116,5415901],"length":1,"stats":{"Line":4},"fn_name":null},{"line":304,"address":[5416057],"length":1,"stats":{"Line":2},"fn_name":null},{"line":305,"address":[5416241],"length":1,"stats":{"Line":2},"fn_name":null},{"line":315,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":316,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":317,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":318,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":321,"address":[],"length":0,"stats":{"Line":29},"fn_name":null},{"line":323,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":324,"address":[],"length":0,"stats":{"Line":28},"fn_name":null},{"line":325,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":328,"address":[],"length":0,"stats":{"Line":25},"fn_name":null},{"line":331,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":332,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":333,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":336,"address":[],"length":0,"stats":{"Line":36},"fn_name":null},{"line":337,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":339,"address":[],"length":0,"stats":{"Line":42},"fn_name":null},{"line":340,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":343,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":344,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":345,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":346,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":349,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":351,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":354,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":361,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":362,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":363,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":366,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":368,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":369,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":371,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":372,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":373,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":374,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":375,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":376,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":377,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":379,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":380,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":381,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":382,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":384,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":385,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":386,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":387,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":388,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":392,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":393,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":394,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":397,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":398,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":399,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":403,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":404,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":405,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":407,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":408,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":410,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":413,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":414,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":415,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":416,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":419,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":427,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":428,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":429,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":430,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":433,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":436,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":437,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":438,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":441,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":443,"address":[],"length":0,"stats":{"Line":12},"fn_name":null},{"line":446,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":447,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":448,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":450,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":451,"address":[],"length":0,"stats":{"Line":17},"fn_name":null},{"line":454,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":455,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":457,"address":[],"length":0,"stats":{"Line":18},"fn_name":null},{"line":458,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":462,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":463,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":464,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":465,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":468,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":477,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":484,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":485,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":486,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":489,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":490,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":493,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":496,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":497,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":498,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":502,"address":[],"length":0,"stats":{"Line":14},"fn_name":null},{"line":503,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":505,"address":[],"length":0,"stats":{"Line":19},"fn_name":null},{"line":506,"address":[],"length":0,"stats":{"Line":10},"fn_name":null},{"line":507,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":510,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":511,"address":[],"length":0,"stats":{"Line":5},"fn_name":null},{"line":512,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":515,"address":[],"length":0,"stats":{"Line":9},"fn_name":null},{"line":516,"address":[],"length":0,"stats":{"Line":11},"fn_name":null},{"line":520,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":521,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":522,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":523,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":526,"address":[],"length":0,"stats":{"Line":4},"fn_name":null}],"covered":177,"coverable":195},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-protocol","src","mock.rs"],"content":"//! Mocks for the minterest-protocol module.\n\nuse frame_support::{impl_outer_event, impl_outer_origin, parameter_types};\nuse liquidity_pools::{Pool, PoolUserData};\nuse minterest_primitives::{Balance, CurrencyId, CurrencyPair, Rate};\nuse orml_currencies::Currency;\nuse sp_core::H256;\nuse sp_runtime::{\n\ttesting::Header,\n\ttraits::{IdentityLookup, Zero},\n\tFixedPointNumber, ModuleId, Perbill,\n};\n\nuse super::*;\nuse controller::{ControllerData, PauseKeeper};\n\nmod minterest_protocol {\n\tpub use crate::Event;\n}\n\nimpl_outer_event! {\n\tpub enum TestEvent for Test {\n\t\tframe_system\u003cT\u003e,\n\t\torml_tokens\u003cT\u003e,\n\t\torml_currencies\u003cT\u003e,\n\t\tliquidity_pools,\n\t\tminterest_protocol\u003cT\u003e,\n\t\tcontroller,\n\t\toracle,\n\t\taccounts\u003cT\u003e,\n\t\tminterest_model,\n\t}\n}\n\nimpl_outer_origin! {\n\tpub enum Origin for Test where system = frame_system {}\n}\n\n#[derive(Clone, PartialEq, Eq)]\npub struct Test;\nparameter_types! {\n\tpub const BlockHashCount: u64 = 250;\n\tpub const MaximumBlockWeight: u32 = 1024;\n\tpub const MaximumBlockLength: u32 = 2 * 1024;\n\tpub const AvailableBlockRatio: Perbill = Perbill::one();\n}\n\npub type AccountId = u32;\nimpl frame_system::Trait for Test {\n\ttype Origin = Origin;\n\ttype Call = ();\n\ttype Index = u64;\n\ttype BlockNumber = u64;\n\ttype Hash = H256;\n\ttype Hashing = ::sp_runtime::traits::BlakeTwo256;\n\ttype AccountId = AccountId;\n\ttype Lookup = IdentityLookup\u003cSelf::AccountId\u003e;\n\ttype Header = Header;\n\ttype Event = TestEvent;\n\ttype BlockHashCount = BlockHashCount;\n\ttype MaximumExtrinsicWeight = MaximumBlockWeight;\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\ttype DbWeight = ();\n\ttype BlockExecutionWeight = ();\n\ttype ExtrinsicBaseWeight = ();\n\ttype MaximumBlockLength = MaximumBlockLength;\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\ttype Version = ();\n\ttype PalletInfo = ();\n\ttype OnNewAccount = ();\n\ttype OnKilledAccount = ();\n\ttype AccountData = ();\n\ttype BaseCallFilter = ();\n\ttype SystemWeightInfo = ();\n}\n\nparameter_types! {\n\tpub const ExistentialDeposit: u64 = 1;\n}\n\nimpl orml_tokens::Trait for Test {\n\ttype Event = TestEvent;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetNativeCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\ntype NativeCurrency = Currency\u003cTest, GetNativeCurrencyId\u003e;\n\nimpl orml_currencies::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype NativeCurrency = NativeCurrency;\n\ttype GetNativeCurrencyId = GetNativeCurrencyId;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n\tpub const InitialExchangeRate: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl liquidity_pools::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MultiCurrency = orml_tokens::Module\u003cTest\u003e;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\nimpl controller::Trait for Test {\n\ttype Event = TestEvent;\n}\n\nimpl oracle::Trait for Test {\n\ttype Event = TestEvent;\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = MAX_MEMBERS;\n}\n\nimpl accounts::Trait for Test {\n\ttype Event = TestEvent;\n\ttype MaxMembers = MaxMembers;\n}\n\nparameter_types! {\n\tpub const BlocksPerYear: u128 = 5256000;\n}\n\nimpl minterest_model::Trait for Test {\n\ttype Event = TestEvent;\n\ttype BlocksPerYear = BlocksPerYear;\n}\n\nimpl Trait for Test {\n\ttype Event = TestEvent;\n\ttype Borrowing = MockBorrowing;\n}\n\npub struct MockBorrowing;\nimpl Borrowing\u003cAccountId\u003e for MockBorrowing {\n\tfn update_state_on_borrow(\n\t\t_who: \u0026AccountId,\n\t\t_underlying_asset_id: CurrencyId,\n\t\t_amount_borrowed: Balance,\n\t\t_account_borrows: Balance,\n\t) -\u003e DispatchResult {\n\t\tOk(())\n\t}\n\n\tfn update_state_on_repay(\n\t\t_who: \u0026AccountId,\n\t\t_underlying_asset_id: CurrencyId,\n\t\t_amount_borrowed: Balance,\n\t\t_account_borrows: Balance,\n\t) -\u003e DispatchResult {\n\t\tOk(())\n\t}\n}\n\ntype Amount = i128;\n\npub const ALICE: AccountId = 1;\npub fn alice() -\u003e Origin {\n\tOrigin::signed(ALICE)\n}\npub const BOB: AccountId = 2;\npub fn bob() -\u003e Origin {\n\tOrigin::signed(BOB)\n}\npub const DOLLARS: Balance = 1_000_000_000_000_000_000;\npub const ONE_MILL_DOLLARS: Balance = 1_000_000 * DOLLARS;\npub const ONE_HUNDRED_DOLLARS: Balance = 100 * DOLLARS;\npub const TEN_THOUSAND_DOLLARS: Balance = 10_000 * DOLLARS;\npub const MAX_MEMBERS: u32 = 16;\npub type TestProtocol = Module\u003cTest\u003e;\npub type TestPools = liquidity_pools::Module\u003cTest\u003e;\npub type Currencies = orml_currencies::Module\u003cTest\u003e;\npub type System = frame_system::Module\u003cTest\u003e;\n\npub struct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![\n\t\t\t\t// seed: initial DOTs. Initial MINT to pay for gas.\n\t\t\t\t(ALICE, CurrencyId::MINT, ONE_MILL_DOLLARS),\n\t\t\t\t(ALICE, CurrencyId::DOT, ONE_HUNDRED_DOLLARS),\n\t\t\t\t(ALICE, CurrencyId::ETH, ONE_HUNDRED_DOLLARS),\n\t\t\t\t(ALICE, CurrencyId::KSM, ONE_HUNDRED_DOLLARS),\n\t\t\t\t(BOB, CurrencyId::MINT, ONE_MILL_DOLLARS),\n\t\t\t\t(BOB, CurrencyId::DOT, ONE_HUNDRED_DOLLARS),\n\t\t\t\t// seed: initial insurance, equal 10_000$\n\t\t\t\t(TestPools::pools_account_id(), CurrencyId::ETH, TEN_THOUSAND_DOLLARS),\n\t\t\t\t(TestPools::pools_account_id(), CurrencyId::DOT, TEN_THOUSAND_DOLLARS),\n\t\t\t\t// seed: initial insurance = 10_000$, initial pool balance = 1_000_000$\n\t\t\t\t(TestPools::pools_account_id(), CurrencyId::KSM, ONE_MILL_DOLLARS),\n\t\t\t],\n\t\t}\n\t}\n}\nimpl ExtBuilder {\n\tpub fn user_balance(mut self, user: AccountId, currency_id: CurrencyId, balance: Balance) -\u003e Self {\n\t\tself.endowed_accounts.push((user, currency_id, balance));\n\t\tself\n\t}\n\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default().build_storage::\u003cTest\u003e().unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cTest\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tliquidity_pools::GenesisConfig::\u003cTest\u003e {\n\t\t\tpools: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\t\ttotal_insurance: TEN_THOUSAND_DOLLARS,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\t\ttotal_insurance: TEN_THOUSAND_DOLLARS,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::saturating_from_rational(1, 1),\n\t\t\t\t\t\ttotal_insurance: TEN_THOUSAND_DOLLARS,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpool_user_data: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tALICE,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tALICE,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tALICE,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tALICE,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tBOB,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tBOB,\n\t\t\t\t\tPoolUserData {\n\t\t\t\t\t\ttotal_borrowed: 0,\n\t\t\t\t\t\tinterest_index: Rate::from_inner(0),\n\t\t\t\t\t\tcollateral: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tcontroller::GenesisConfig::\u003cTest\u003e {\n\t\t\tcontroller_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpause_keepers: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: true,\n\t\t\t\t\t\tredeem_paused: true,\n\t\t\t\t\t\tborrow_paused: true,\n\t\t\t\t\t\trepay_paused: true,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\taccounts::GenesisConfig::\u003cTest\u003e {\n\t\t\tallowed_accounts: vec![(ALICE, ())],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tlet mut ext: sp_io::TestExternalities = t.into();\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n","traces":[{"line":21,"address":[5437734,5439865,5439095,5440042,5438101,5438650,5436681,5437551,5438880,5437992,5437081,5438499,5439364,5439805,5439685,5439925,5439569,5439745,5438138,5439985,5436537,5440099,5437514,5439014,5438977,5438835,5437118,5436879,5436718,5437301,5438284,5438462,5439244,5437947],"length":1,"stats":{"Line":15},"fn_name":null},{"line":23,"address":[5436695,5436998,5436753,5437053],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[5437095,5437486,5437431,5437153],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[5437864,5437919,5437586,5437528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[5438073,5437969],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[5438115,5438173,5438437,5438391],"length":1,"stats":{"Line":2},"fn_name":null},{"line":28,"address":[5438764,5438810,5438534,5438476],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[5438857,5438952],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5439173,5439049,5439219,5438991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[5439258,5439331,5439435,5439480],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[5440277,5440208],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[4241569],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[5440337],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[4241636],"length":1,"stats":{"Line":8},"fn_name":null},{"line":106,"address":[4241684],"length":1,"stats":{"Line":5},"fn_name":null},{"line":107,"address":[4242000,4241766,4242105],"length":1,"stats":{"Line":4},"fn_name":null},{"line":108,"address":[4241784],"length":1,"stats":{"Line":2},"fn_name":null},{"line":109,"address":[4241843],"length":1,"stats":{"Line":2},"fn_name":null},{"line":110,"address":[4241898],"length":1,"stats":{"Line":2},"fn_name":null},{"line":111,"address":[4241953],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[4226240],"length":1,"stats":{"Line":2},"fn_name":"alice"},{"line":179,"address":[4226249],"length":1,"stats":{"Line":5},"fn_name":null},{"line":182,"address":[4226304],"length":1,"stats":{"Line":1},"fn_name":"bob"},{"line":183,"address":[4226313],"length":1,"stats":{"Line":1},"fn_name":null},{"line":200,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":202,"address":[],"length":0,"stats":{"Line":15},"fn_name":null},{"line":220,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":221,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":222,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":225,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":226,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":229,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":231,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":261,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":318,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":360,"address":[],"length":0,"stats":{"Line":16},"fn_name":null},{"line":399,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":403,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":405,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":408,"address":[],"length":0,"stats":{"Line":8},"fn_name":null},{"line":409,"address":[],"length":0,"stats":{"Line":24},"fn_name":null},{"line":410,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":29,"coverable":48},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","minterest-protocol","src","tests.rs"],"content":"//! Tests for the minterest-protocol pallet.\n\nuse super::*;\nuse mock::*;\n\nuse frame_support::{assert_noop, assert_ok};\n\nfn dollars\u003cT: Into\u003cu128\u003e\u003e(d: T) -\u003e Balance {\n\tDOLLARS.saturating_mul(d.into())\n}\n\n#[test]\nfn deposit_underlying_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::KSM, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposit 60 DOT; exchange_rate = 1.0\n\t\t\t// wrapped_amount = 60.0 DOT / 1.0 = 60.0\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(60_u128)\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Deposited(\n\t\t\t\tALICE,\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(60_u128),\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\tdollars(60_u128),\n\t\t\t));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\n\t\t\t// MDOT pool does not exist.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::deposit_underlying(alice(), CurrencyId::MDOT, 10),\n\t\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\t// Alice has 100 ETH on her account, so she cannot make a deposit 150 ETH.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::deposit_underlying(alice(), CurrencyId::ETH, dollars(150_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\n\t\t\t// Transaction with zero balance is not allowed.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::deposit_underlying(alice(), CurrencyId::DOT, Balance::zero()),\n\t\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t\t);\n\n\t\t\t// All operations in the KSM pool are paused.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::deposit_underlying(alice(), CurrencyId::KSM, dollars(10_u128)),\n\t\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposit 60 DOT; exchange_rate = 1.0\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\n\t\t// Alice redeem all 60 MDOT; exchange_rate = 1.0\n\t\tassert_ok!(TestProtocol::redeem(alice(), CurrencyId::DOT));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Redeemed(\n\t\t\tALICE,\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128),\n\t\t\tCurrencyId::MDOT,\n\t\t\tdollars(60_u128),\n\t\t));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn redeem_should_not_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::MKSM, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Bob has 0 MDOT on her account, so she cannot make a redeem.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem(bob(), CurrencyId::DOT),\n\t\t\t\tError::\u003cTest\u003e::NumberOfWrappedTokensIsZero\n\t\t\t);\n\n\t\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem(alice(), CurrencyId::MDOT),\n\t\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\t// All operations in the KSM pool are paused.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem(alice(), CurrencyId::KSM),\n\t\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_fails_if_low_balance_in_pool() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::BTC, TEN_THOUSAND_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 10_000$ to BTC pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tTEN_THOUSAND_DOLLARS\n\t\t\t));\n\n\t\t\t// Alice borrowed 100$ from BTC pool:\n\t\t\t// pool_total_liquidity = 10_000 - 100 = 9_900$\n\t\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS));\n\n\t\t\t// Alice has 10_000 MBTC. exchange_rate = 1.0\n\t\t\t// Alice is trying to change all her 10_000 MBTC tokens to BTC. She can't do it because:\n\t\t\t// pool_total_liquidity = 9_900 \u003c 10_000 * 1.0 = 10_000\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem(alice(), CurrencyId::BTC),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_underlying_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::MKSM, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 60 DOT to the pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(60_u128)\n\t\t\t));\n\n\t\t\t// Alice can't redeem 100 DOT, because 100 DOT equal 100 * 1.0 = 100 MDOT\n\t\t\t// And she has 60 MDOT on her balance.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::DOT, dollars(100_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughWrappedTokens\n\t\t\t);\n\n\t\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::MDOT, dollars(20_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t\t);\n\n\t\t\t// Transaction with zero balance is not allowed.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::DOT, Balance::zero()),\n\t\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t\t);\n\n\t\t\t// All operations in the KSM pool are paused.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::KSM, dollars(10_u128)),\n\t\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t\t);\n\n\t\t\tassert_ok!(TestProtocol::redeem_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(30_u128)\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Redeemed(\n\t\t\t\tALICE,\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(30_u128),\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\tdollars(30_u128),\n\t\t\t));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t});\n}\n\n#[test]\nfn redeem_underlying_fails_if_low_balance_in_pool() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::BTC, TEN_THOUSAND_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 10_000$ to BTC pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tTEN_THOUSAND_DOLLARS\n\t\t\t));\n\n\t\t\t// Alice borrowed 100$ from BTC pool:\n\t\t\t// pool_total_liquidity = 10_000 - 100 = 9_900$\n\t\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS));\n\n\t\t\t// Alice has 10_000 MBTC. exchange_rate = 1.0\n\t\t\t// Alice is trying to change all her 10_000 MBTC tokens to BTC. She can't do it because:\n\t\t\t// pool_total_liquidity = 9_900 BTC \u003c 10_000 BTC\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_underlying(alice(), CurrencyId::BTC, TEN_THOUSAND_DOLLARS),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn redeem_wrapped_should_work() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::MKSM, ONE_HUNDRED_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 60 DOT to the pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(60_u128)\n\t\t\t));\n\n\t\t\t// Alice has 60 MDOT. She can't redeem 100 MDOT.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::MDOT, dollars(100_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughWrappedTokens\n\t\t\t);\n\n\t\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::DOT, dollars(20_u128)),\n\t\t\t\tError::\u003cTest\u003e::NotValidWrappedTokenId\n\t\t\t);\n\n\t\t\t// Transaction with zero balance is not allowed.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::MDOT, Balance::zero()),\n\t\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t\t);\n\n\t\t\t// All operations in the KSM pool are paused.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::MKSM, dollars(10_u128)),\n\t\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t\t);\n\n\t\t\tassert_ok!(TestProtocol::redeem_wrapped(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\tdollars(35_u128)\n\t\t\t));\n\t\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Redeemed(\n\t\t\t\tALICE,\n\t\t\t\tCurrencyId::DOT,\n\t\t\t\tdollars(35_u128),\n\t\t\t\tCurrencyId::MDOT,\n\t\t\t\tdollars(35_u128),\n\t\t\t));\n\t\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\t});\n}\n\n#[test]\nfn redeem_wrapped_fails_if_low_balance_in_pool() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::BTC, TEN_THOUSAND_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 10_000$ to BTC pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tTEN_THOUSAND_DOLLARS\n\t\t\t));\n\n\t\t\t// Alice borrowed 100$ from BTC pool:\n\t\t\t// pool_total_liquidity = 10_000 - 100 = 9_900$\n\t\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS));\n\n\t\t\t// Alice has 10_000 MBTC. exchange_rate = 1.0\n\t\t\t// Alice is trying to change all her 10_000 MBTC tokens to BTC. She can't do it because:\n\t\t\t// pool_total_liquidity = 9_900 BTC \u003c 10_000 MBTC * 1.0 = 10_000 BTC\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::redeem_wrapped(alice(), CurrencyId::MBTC, TEN_THOUSAND_DOLLARS),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn borrow_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\t\t// total_pool_liquidity = 10_000 (insurance) + 60 = 10_060\n\t\tassert_eq!(\n\t\t\tTestPools::get_pool_available_liquidity(CurrencyId::DOT),\n\t\t\tdollars(10_060_u128)\n\t\t);\n\n\t\t// Alice cannot borrow 100 DOT because she deposited 60 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::borrow(alice(), CurrencyId::DOT, dollars(100_u128)),\n\t\t\tError::\u003cTest\u003e::BorrowControllerRejection\n\t\t);\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestProtocol::borrow(alice(), CurrencyId::MDOT, dollars(60_u128)),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// Transaction with zero balance is not allowed.\n\t\tassert_noop!(\n\t\t\tTestProtocol::borrow(alice(), CurrencyId::DOT, Balance::zero()),\n\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t);\n\n\t\t// All operations in the KSM pool are paused.\n\t\tassert_noop!(\n\t\t\tTestProtocol::borrow(alice(), CurrencyId::KSM, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t);\n\n\t\t// Alice borrowed 30 DOT\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\t\tlet expected_event =\n\t\t\tTestEvent::minterest_protocol(RawEvent::Borrowed(ALICE, CurrencyId::DOT, dollars(30_u128)));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn borrow_fails_if_low_balance_in_pool() {\n\tExtBuilder::default()\n\t\t.user_balance(ALICE, CurrencyId::BTC, TEN_THOUSAND_DOLLARS)\n\t\t.build()\n\t\t.execute_with(|| {\n\t\t\t// Alice deposited 100$ to BTC pool.\n\t\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\t\talice(),\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\tONE_HUNDRED_DOLLARS\n\t\t\t));\n\n\t\t\t// set total_pool_liquidity = 50 DOT\n\t\t\tassert_ok!(Currencies::withdraw(\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\u0026TestPools::pools_account_id(),\n\t\t\t\tdollars(50_u128)\n\t\t\t));\n\n\t\t\t// Alice cannot borrow 100 BTC because there is 50 BTC in the pool.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\n\t\t\t// set total_pool_liquidity = 0 DOT\n\t\t\tassert_ok!(Currencies::withdraw(\n\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\u0026TestPools::pools_account_id(),\n\t\t\t\tdollars(50_u128)\n\t\t\t));\n\n\t\t\t// Alice cannot borrow 100 BTC because there is 0 BTC in the pool.\n\t\t\tassert_noop!(\n\t\t\t\tTestProtocol::borrow(alice(), CurrencyId::BTC, ONE_HUNDRED_DOLLARS),\n\t\t\t\tError::\u003cTest\u003e::NotEnoughLiquidityAvailable\n\t\t\t);\n\t\t});\n}\n\n#[test]\nfn repay_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\t\t// Alice borrowed 30 DOT from the pool.\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\t\t// Alice balance = 70 DOT\n\t\tassert_eq!(Currencies::free_balance(CurrencyId::DOT, \u0026ALICE), dollars(70_u128));\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::MDOT, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// Alice cannot repay 100 DOT, because she only have 70 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::DOT, dollars(100_u128)),\n\t\t\tError::\u003cTest\u003e::NotEnoughUnderlyingsAssets\n\t\t);\n\n\t\t// Alice cannot repay 70 DOT, because she only borrowed 60 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::DOT, dollars(70_u128)),\n\t\t\tError::\u003cTest\u003e::RepayAmountToBig\n\t\t);\n\n\t\t// Transaction with zero balance is not allowed.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::DOT, Balance::zero()),\n\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t);\n\n\t\t// All operations in the KSM pool are paused.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay(alice(), CurrencyId::KSM, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t);\n\n\t\t// Alice repaid 20 DOT. Her borrow_balance = 10 DOT.\n\t\tassert_ok!(TestProtocol::repay(alice(), CurrencyId::DOT, dollars(20_u128)));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Repaid(ALICE, CurrencyId::DOT, dollars(20_u128)));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn repay_all_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\t\t// Alice borrowed 30 DOT from the pool.\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_all(alice(), CurrencyId::MDOT),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// All operations in the KSM pool are paused.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_all(alice(), CurrencyId::KSM),\n\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t);\n\n\t\t// Alice repaid all 30 DOT.\n\t\tassert_ok!(TestProtocol::repay_all(alice(), CurrencyId::DOT));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Repaid(ALICE, CurrencyId::DOT, dollars(30_u128)));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn repay_all_fails_if_not_enough_underlying_assets() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\t\t// Alice borrowed 30 DOT from the pool.\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\n\t\t// Alice deposited 70 DOT to the pool. Now she have 0 DOT in her account.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(70_u128)\n\t\t));\n\n\t\t// Insufficient DOT in the ALICE account for repay 30 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_all(alice(), CurrencyId::DOT),\n\t\t\tError::\u003cTest\u003e::NotEnoughUnderlyingsAssets\n\t\t);\n\t});\n}\n\n#[test]\nfn repay_on_behalf_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice deposited 60 DOT to the pool.\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::DOT,\n\t\t\tdollars(60_u128)\n\t\t));\n\n\t\t// Alice borrowed 30 DOT from the pool.\n\t\tassert_ok!(TestProtocol::borrow(alice(), CurrencyId::DOT, dollars(30_u128)));\n\n\t\t// MDOT is wrong CurrencyId for underlying assets.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::MDOT, ALICE, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\n\t\t// Bob can't pay off the 120 DOT debt for Alice, because he has 100 DOT in his account.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::DOT, ALICE, dollars(120_u128)),\n\t\t\tError::\u003cTest\u003e::NotEnoughUnderlyingsAssets\n\t\t);\n\n\t\t// Bob cannot repay 100 DOT, because Alice only borrowed 60 DOT.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::DOT, ALICE, dollars(100_u128)),\n\t\t\tError::\u003cTest\u003e::RepayAmountToBig\n\t\t);\n\n\t\t// Transaction with zero balance is not allowed.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::DOT, ALICE, Balance::zero()),\n\t\t\tError::\u003cTest\u003e::ZeroBalanceTransaction\n\t\t);\n\n\t\t// All operations in the KSM pool are paused.\n\t\tassert_noop!(\n\t\t\tTestProtocol::repay_on_behalf(bob(), CurrencyId::KSM, ALICE, dollars(10_u128)),\n\t\t\tError::\u003cTest\u003e::OperationPaused\n\t\t);\n\n\t\t// Bob repaid 20 DOT for Alice.\n\t\tassert_ok!(TestProtocol::repay_on_behalf(\n\t\t\tbob(),\n\t\t\tCurrencyId::DOT,\n\t\t\tALICE,\n\t\t\tdollars(20_u128)\n\t\t));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::Repaid(BOB, CurrencyId::DOT, dollars(20_u128)));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t});\n}\n\n#[test]\nfn enable_as_collateral_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\t// Alice cannot enable as collateral ETH pool, because she has not deposited funds into the pool.\n\t\tassert_noop!(\n\t\t\tTestProtocol::enable_as_collateral(alice(), CurrencyId::ETH),\n\t\t\tError::\u003cTest\u003e::CanotBeEnabledAsCollateral\n\t\t);\n\n\t\t// Alice deposit 60 ETH\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::ETH,\n\t\t\tdollars(60_u128)\n\t\t));\n\n\t\t// Alice enable as collateral her ETH pool.\n\t\tassert_ok!(TestProtocol::enable_as_collateral(alice(), CurrencyId::ETH));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::PoolEnabledAsCollateral(ALICE, CurrencyId::ETH));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert!(TestPools::check_user_available_collateral(\u0026ALICE, CurrencyId::ETH));\n\n\t\t// ETH pool is already collateral.\n\t\tassert_noop!(\n\t\t\tTestProtocol::enable_as_collateral(alice(), CurrencyId::ETH),\n\t\t\tError::\u003cTest\u003e::AlreadyCollateral\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tTestProtocol::enable_as_collateral(alice(), CurrencyId::MDOT),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n\n#[test]\nfn disable_collateral_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_noop!(\n\t\t\tTestProtocol::disable_collateral(alice(), CurrencyId::ETH),\n\t\t\tError::\u003cTest\u003e::AlreadyDisabledCollateral\n\t\t);\n\n\t\t// Alice deposit 60 ETH\n\t\tassert_ok!(TestProtocol::deposit_underlying(\n\t\t\talice(),\n\t\t\tCurrencyId::ETH,\n\t\t\tdollars(60_u128)\n\t\t));\n\n\t\t// Alice enable as collateral her ETH pool.\n\t\tassert_ok!(TestProtocol::enable_as_collateral(alice(), CurrencyId::ETH));\n\n\t\t// Alice disable collateral her ETH pool.\n\t\tassert_ok!(TestProtocol::disable_collateral(alice(), CurrencyId::ETH));\n\t\tlet expected_event = TestEvent::minterest_protocol(RawEvent::PoolDisabledCollateral(ALICE, CurrencyId::ETH));\n\t\tassert!(System::events().iter().any(|record| record.event == expected_event));\n\t\tassert!(!TestPools::check_user_available_collateral(\u0026ALICE, CurrencyId::ETH));\n\n\t\tassert_noop!(\n\t\t\tTestProtocol::disable_collateral(alice(), CurrencyId::ETH),\n\t\t\tError::\u003cTest\u003e::AlreadyDisabledCollateral\n\t\t);\n\n\t\tassert_noop!(\n\t\t\tTestProtocol::disable_collateral(alice(), CurrencyId::MDOT),\n\t\t\tError::\u003cTest\u003e::NotValidUnderlyingAssetId\n\t\t);\n\t});\n}\n","traces":[{"line":8,"address":[4325568],"length":1,"stats":{"Line":3},"fn_name":"dollars\u003cu128\u003e"},{"line":9,"address":[4325582],"length":1,"stats":{"Line":3},"fn_name":null},{"line":13,"address":[4325669,4325664],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":14,"address":[5440951,5440989],"length":1,"stats":{"Line":2},"fn_name":null},{"line":15,"address":[5440981],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[4325744,4325846],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":20,"address":[4325968,4325901,4325751],"length":1,"stats":{"Line":3},"fn_name":null},{"line":21,"address":[4325783],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[4325861],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[4325878],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[4326292],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[4326216],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[4326233],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4326254],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[4326271],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4325696,4326435,4326672,4325710],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":35,"address":[4326656,4326849],"length":1,"stats":{"Line":2},"fn_name":null},{"line":36,"address":[4326702],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[4326841],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[4328156,4327928],"length":1,"stats":{"Line":2},"fn_name":null},{"line":42,"address":[4331870,4328085,4327947],"length":1,"stats":{"Line":2},"fn_name":null},{"line":43,"address":[4328148],"length":1,"stats":{"Line":1},"fn_name":null},{"line":47,"address":[4329454,4329235],"length":1,"stats":{"Line":2},"fn_name":null},{"line":48,"address":[4331911,4329254,4329383],"length":1,"stats":{"Line":2},"fn_name":null},{"line":49,"address":[4329446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[4330761,4330533],"length":1,"stats":{"Line":2},"fn_name":null},{"line":54,"address":[4330690,4331952,4330552],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[4330753],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[4332261,4332256],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":62,"address":[4332414,4332336],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":64,"address":[4332469,4332536,4332343],"length":1,"stats":{"Line":3},"fn_name":null},{"line":65,"address":[4332351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[4332429],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[4332446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[4332772],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4333154],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4333090],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4333107],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4333122],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[4333139],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[4333478,4332288,4333285,4332302],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":84,"address":[4333600,4333605],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":85,"address":[5441255,5441293],"length":1,"stats":{"Line":2},"fn_name":null},{"line":86,"address":[5441285],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4333632,4333655],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":90,"address":[4333807,4333639],"length":1,"stats":{"Line":2},"fn_name":null},{"line":91,"address":[4333670],"length":1,"stats":{"Line":1},"fn_name":null},{"line":92,"address":[4333799],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[4334886,4335042],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[4334905],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[4335034],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[4336277,4336121],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[4336140],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[4336269],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[4337440,4337445],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":111,"address":[5441469,5441431],"length":1,"stats":{"Line":2},"fn_name":null},{"line":112,"address":[5441461],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[4337534,4337472],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":116,"address":[4337557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[4337479],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[4337549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[4337856],"length":1,"stats":{"Line":1},"fn_name":null},{"line":129,"address":[4338216,4338367],"length":1,"stats":{"Line":2},"fn_name":null},{"line":130,"address":[4338230],"length":1,"stats":{"Line":1},"fn_name":null},{"line":131,"address":[4338359],"length":1,"stats":{"Line":1},"fn_name":null},{"line":137,"address":[4339424,4339429],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":138,"address":[5441645,5441607],"length":1,"stats":{"Line":2},"fn_name":null},{"line":139,"address":[5441637],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[4339622,4339504],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":143,"address":[4339511,4339744,4339677],"length":1,"stats":{"Line":3},"fn_name":null},{"line":144,"address":[4339559],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[4339637],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[4339654],"length":1,"stats":{"Line":1},"fn_name":null},{"line":151,"address":[4340215,4339992],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[4340006,4346135,4340144],"length":1,"stats":{"Line":2},"fn_name":null},{"line":153,"address":[4340207],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[4341294,4341522],"length":1,"stats":{"Line":2},"fn_name":null},{"line":158,"address":[4341313,4346176,4341451],"length":1,"stats":{"Line":2},"fn_name":null},{"line":159,"address":[4341514],"length":1,"stats":{"Line":1},"fn_name":null},{"line":163,"address":[4342820,4342601],"length":1,"stats":{"Line":2},"fn_name":null},{"line":164,"address":[4342620,4342749,4346217],"length":1,"stats":{"Line":2},"fn_name":null},{"line":165,"address":[4342812],"length":1,"stats":{"Line":1},"fn_name":null},{"line":169,"address":[4344127,4343899],"length":1,"stats":{"Line":2},"fn_name":null},{"line":170,"address":[4343918,4344056,4346258],"length":1,"stats":{"Line":2},"fn_name":null},{"line":171,"address":[4344119],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[4345313,4345374],"length":1,"stats":{"Line":2},"fn_name":null},{"line":175,"address":[4345206],"length":1,"stats":{"Line":1},"fn_name":null},{"line":176,"address":[4345271],"length":1,"stats":{"Line":1},"fn_name":null},{"line":177,"address":[4345296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[4345650],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[4345582],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[4345599],"length":1,"stats":{"Line":1},"fn_name":null},{"line":183,"address":[4345616],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[4345633],"length":1,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[4346001,4339470,4339456,4345801],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":191,"address":[4346661,4346656],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":192,"address":[5441821,5441783],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[5441813],"length":1,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[4346688,4346750],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":197,"address":[4346773],"length":1,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[4346695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[4346765],"length":1,"stats":{"Line":1},"fn_name":null},{"line":205,"address":[4347072],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4347599,4347432],"length":1,"stats":{"Line":2},"fn_name":null},{"line":211,"address":[4347446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[4347591],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[4348661,4348656],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":219,"address":[5441997,5441959],"length":1,"stats":{"Line":2},"fn_name":null},{"line":220,"address":[5441989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[4348736,4348854],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":224,"address":[4348909,4348743,4348976],"length":1,"stats":{"Line":3},"fn_name":null},{"line":225,"address":[4348791],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[4348869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":227,"address":[4348886],"length":1,"stats":{"Line":1},"fn_name":null},{"line":231,"address":[4349224,4349447],"length":1,"stats":{"Line":2},"fn_name":null},{"line":232,"address":[4355367,4349376,4349238],"length":1,"stats":{"Line":2},"fn_name":null},{"line":233,"address":[4349439],"length":1,"stats":{"Line":1},"fn_name":null},{"line":237,"address":[4350754,4350526],"length":1,"stats":{"Line":2},"fn_name":null},{"line":238,"address":[4350683,4350545,4355408],"length":1,"stats":{"Line":2},"fn_name":null},{"line":239,"address":[4350746],"length":1,"stats":{"Line":1},"fn_name":null},{"line":243,"address":[4352052,4351833],"length":1,"stats":{"Line":2},"fn_name":null},{"line":244,"address":[4355449,4351852,4351981],"length":1,"stats":{"Line":2},"fn_name":null},{"line":245,"address":[4352044],"length":1,"stats":{"Line":1},"fn_name":null},{"line":249,"address":[4353359,4353131],"length":1,"stats":{"Line":2},"fn_name":null},{"line":250,"address":[4353288,4355490,4353150],"length":1,"stats":{"Line":2},"fn_name":null},{"line":251,"address":[4353351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[4354545,4354606],"length":1,"stats":{"Line":2},"fn_name":null},{"line":255,"address":[4354438],"length":1,"stats":{"Line":1},"fn_name":null},{"line":256,"address":[4354503],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[4354528],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[4354882],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[4354814],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[4354831],"length":1,"stats":{"Line":1},"fn_name":null},{"line":263,"address":[4354848],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[4354865],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[4348702,4355233,4355033,4348688],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":271,"address":[4355893,4355888],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":272,"address":[5442135,5442173],"length":1,"stats":{"Line":2},"fn_name":null},{"line":273,"address":[5442165],"length":1,"stats":{"Line":1},"fn_name":null},{"line":275,"address":[4355982,4355920],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":277,"address":[4356005],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[4355927],"length":1,"stats":{"Line":1},"fn_name":null},{"line":279,"address":[4355997],"length":1,"stats":{"Line":1},"fn_name":null},{"line":285,"address":[4356304],"length":1,"stats":{"Line":1},"fn_name":null},{"line":290,"address":[4356664,4356831],"length":1,"stats":{"Line":2},"fn_name":null},{"line":291,"address":[4356678],"length":1,"stats":{"Line":1},"fn_name":null},{"line":292,"address":[4356823],"length":1,"stats":{"Line":1},"fn_name":null},{"line":298,"address":[4357893,4357888],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":299,"address":[4358086,4357968],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":301,"address":[4357975,4358141,4358208],"length":1,"stats":{"Line":3},"fn_name":null},{"line":302,"address":[4358023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":303,"address":[4358101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":304,"address":[4358118],"length":1,"stats":{"Line":1},"fn_name":null},{"line":307,"address":[4358531,4358671],"length":1,"stats":{"Line":1},"fn_name":null},{"line":308,"address":[4358456],"length":1,"stats":{"Line":1},"fn_name":null},{"line":309,"address":[4358502],"length":1,"stats":{"Line":1},"fn_name":null},{"line":313,"address":[4359173,4358637],"length":1,"stats":{"Line":2},"fn_name":null},{"line":314,"address":[4359102,4365013,4358964],"length":1,"stats":{"Line":2},"fn_name":null},{"line":315,"address":[4359165],"length":1,"stats":{"Line":1},"fn_name":null},{"line":319,"address":[4360252,4360480],"length":1,"stats":{"Line":2},"fn_name":null},{"line":320,"address":[4360271,4365054,4360409],"length":1,"stats":{"Line":2},"fn_name":null},{"line":321,"address":[4360472],"length":1,"stats":{"Line":1},"fn_name":null},{"line":325,"address":[4361778,4361559],"length":1,"stats":{"Line":2},"fn_name":null},{"line":326,"address":[4361578,4361707,4365095],"length":1,"stats":{"Line":2},"fn_name":null},{"line":327,"address":[4361770],"length":1,"stats":{"Line":1},"fn_name":null},{"line":331,"address":[4363085,4362857],"length":1,"stats":{"Line":2},"fn_name":null},{"line":332,"address":[4363014,4365136,4362876],"length":1,"stats":{"Line":2},"fn_name":null},{"line":333,"address":[4363077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":337,"address":[4364158,4365177],"length":1,"stats":{"Line":1},"fn_name":null},{"line":339,"address":[4364528],"length":1,"stats":{"Line":1},"fn_name":null},{"line":340,"address":[4364879,4357934,4357920,4364679],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":345,"address":[4365520,4365525],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":346,"address":[5442477,5442439],"length":1,"stats":{"Line":2},"fn_name":null},{"line":347,"address":[5442469],"length":1,"stats":{"Line":1},"fn_name":null},{"line":349,"address":[4365614,4365552],"length":1,"stats":{"Line":1},"fn_name":"{{closure}}"},{"line":351,"address":[4365637],"length":1,"stats":{"Line":1},"fn_name":null},{"line":352,"address":[4365559],"length":1,"stats":{"Line":1},"fn_name":null},{"line":353,"address":[4365629],"length":1,"stats":{"Line":1},"fn_name":null},{"line":358,"address":[4365986],"length":1,"stats":{"Line":1},"fn_name":null},{"line":359,"address":[4365936],"length":1,"stats":{"Line":1},"fn_name":null},{"line":360,"address":[4365944],"length":1,"stats":{"Line":1},"fn_name":null},{"line":361,"address":[4365965],"length":1,"stats":{"Line":1},"fn_name":null},{"line":365,"address":[4366452,4366285],"length":1,"stats":{"Line":2},"fn_name":null},{"line":366,"address":[4366299],"length":1,"stats":{"Line":1},"fn_name":null},{"line":367,"address":[4366444],"length":1,"stats":{"Line":1},"fn_name":null},{"line":371,"address":[4367599],"length":1,"stats":{"Line":1},"fn_name":null},{"line":372,"address":[4367531],"length":1,"stats":{"Line":1},"fn_name":null},{"line":373,"address":[4367539],"length":1,"stats":{"Line":1},"fn_name":null},{"line":374,"address":[4367576],"length":1,"stats":{"Line":1},"fn_name":null},{"line":378,"address":[4368048,4367876],"length":1,"stats":{"Line":2},"fn_name":null},{"line":379,"address":[4367895],"length":1,"stats":{"Line":1},"fn_name":null},{"line":380,"address":[4368040],"length":1,"stats":{"Line":1},"fn_name":null},{"line":386,"address":[4369168,4369173],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":387,"address":[4369248,4369388],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":389,"address":[4369261,4369443,4369510],"length":1,"stats":{"Line":3},"fn_name":null},{"line":390,"address":[4369325],"length":1,"stats":{"Line":1},"fn_name":null},{"line":391,"address":[4369403],"length":1,"stats":{"Line":1},"fn_name":null},{"line":392,"address":[4369420],"length":1,"stats":{"Line":1},"fn_name":null},{"line":395,"address":[4378070,4369758],"length":1,"stats":{"Line":1},"fn_name":null},{"line":397,"address":[4370174,4370396],"length":1,"stats":{"Line":1},"fn_name":null},{"line":400,"address":[4370362,4370898],"length":1,"stats":{"Line":2},"fn_name":null},{"line":401,"address":[4370827,4378111,4370689],"length":1,"stats":{"Line":2},"fn_name":null},{"line":402,"address":[4370890],"length":1,"stats":{"Line":1},"fn_name":null},{"line":406,"address":[4372205,4371977],"length":1,"stats":{"Line":2},"fn_name":null},{"line":407,"address":[4378152,4371996,4372134],"length":1,"stats":{"Line":2},"fn_name":null},{"line":408,"address":[4372197],"length":1,"stats":{"Line":1},"fn_name":null},{"line":412,"address":[4373284,4373512],"length":1,"stats":{"Line":2},"fn_name":null},{"line":413,"address":[4378193,4373303,4373441],"length":1,"stats":{"Line":2},"fn_name":null},{"line":414,"address":[4373504],"length":1,"stats":{"Line":1},"fn_name":null},{"line":418,"address":[4374591,4374810],"length":1,"stats":{"Line":2},"fn_name":null},{"line":419,"address":[4374739,4378234,4374610],"length":1,"stats":{"Line":2},"fn_name":null},{"line":420,"address":[4374802],"length":1,"stats":{"Line":1},"fn_name":null},{"line":424,"address":[4376117,4375889],"length":1,"stats":{"Line":2},"fn_name":null},{"line":425,"address":[4378275,4376046,4375908],"length":1,"stats":{"Line":2},"fn_name":null},{"line":426,"address":[4376109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":430,"address":[4378316,4377196],"length":1,"stats":{"Line":1},"fn_name":null},{"line":431,"address":[4377566],"length":1,"stats":{"Line":1},"fn_name":null},{"line":432,"address":[4369214,4369200,4377717,4377917],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":437,"address":[4378752,4378757],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":438,"address":[4378832,4378918],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":440,"address":[4379040,4378839,4378973],"length":1,"stats":{"Line":3},"fn_name":null},{"line":441,"address":[4378855],"length":1,"stats":{"Line":1},"fn_name":null},{"line":442,"address":[4378933],"length":1,"stats":{"Line":1},"fn_name":null},{"line":443,"address":[4378950],"length":1,"stats":{"Line":1},"fn_name":null},{"line":446,"address":[4382914,4379288],"length":1,"stats":{"Line":1},"fn_name":null},{"line":449,"address":[4379704,4379855],"length":1,"stats":{"Line":2},"fn_name":null},{"line":450,"address":[4379718],"length":1,"stats":{"Line":1},"fn_name":null},{"line":451,"address":[4379847],"length":1,"stats":{"Line":1},"fn_name":null},{"line":455,"address":[4381090,4380934],"length":1,"stats":{"Line":2},"fn_name":null},{"line":456,"address":[4380953],"length":1,"stats":{"Line":1},"fn_name":null},{"line":457,"address":[4381082],"length":1,"stats":{"Line":1},"fn_name":null},{"line":461,"address":[4382157],"length":1,"stats":{"Line":1},"fn_name":null},{"line":462,"address":[4382467],"length":1,"stats":{"Line":1},"fn_name":null},{"line":463,"address":[4378784,4378798,4382818,4382618],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":468,"address":[4383109,4383104],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":469,"address":[4383136,4383230],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":471,"address":[4383143,4383352,4383285],"length":1,"stats":{"Line":3},"fn_name":null},{"line":472,"address":[4383167],"length":1,"stats":{"Line":1},"fn_name":null},{"line":473,"address":[4383245],"length":1,"stats":{"Line":1},"fn_name":null},{"line":474,"address":[4383262],"length":1,"stats":{"Line":1},"fn_name":null},{"line":477,"address":[4385635,4383600],"length":1,"stats":{"Line":1},"fn_name":null},{"line":480,"address":[4384184,4384117],"length":1,"stats":{"Line":2},"fn_name":null},{"line":481,"address":[4384016],"length":1,"stats":{"Line":1},"fn_name":null},{"line":482,"address":[4384077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":483,"address":[4384094],"length":1,"stats":{"Line":1},"fn_name":null},{"line":487,"address":[4384583,4384432],"length":1,"stats":{"Line":2},"fn_name":null},{"line":488,"address":[4384446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":489,"address":[4384575],"length":1,"stats":{"Line":1},"fn_name":null},{"line":495,"address":[4385824,4385829],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":496,"address":[4386044,4385904],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":498,"address":[4385917,4386166,4386099],"length":1,"stats":{"Line":3},"fn_name":null},{"line":499,"address":[4385981],"length":1,"stats":{"Line":1},"fn_name":null},{"line":500,"address":[4386059],"length":1,"stats":{"Line":1},"fn_name":null},{"line":501,"address":[4386076],"length":1,"stats":{"Line":1},"fn_name":null},{"line":505,"address":[4394255,4386414],"length":1,"stats":{"Line":1},"fn_name":null},{"line":508,"address":[4387058,4386830],"length":1,"stats":{"Line":2},"fn_name":null},{"line":509,"address":[4394296,4386982,4386844],"length":1,"stats":{"Line":2},"fn_name":null},{"line":510,"address":[4387050],"length":1,"stats":{"Line":1},"fn_name":null},{"line":514,"address":[4388137,4388370],"length":1,"stats":{"Line":2},"fn_name":null},{"line":515,"address":[4394337,4388294,4388156],"length":1,"stats":{"Line":2},"fn_name":null},{"line":516,"address":[4388362],"length":1,"stats":{"Line":1},"fn_name":null},{"line":520,"address":[4389682,4389449],"length":1,"stats":{"Line":2},"fn_name":null},{"line":521,"address":[4389606,4389468,4394378],"length":1,"stats":{"Line":2},"fn_name":null},{"line":522,"address":[4389674],"length":1,"stats":{"Line":1},"fn_name":null},{"line":526,"address":[4390985,4390761],"length":1,"stats":{"Line":2},"fn_name":null},{"line":527,"address":[4390909,4394419,4390780],"length":1,"stats":{"Line":2},"fn_name":null},{"line":528,"address":[4390977],"length":1,"stats":{"Line":1},"fn_name":null},{"line":532,"address":[4392064,4392297],"length":1,"stats":{"Line":2},"fn_name":null},{"line":533,"address":[4394460,4392221,4392083],"length":1,"stats":{"Line":2},"fn_name":null},{"line":534,"address":[4392289],"length":1,"stats":{"Line":1},"fn_name":null},{"line":538,"address":[4393477,4393543],"length":1,"stats":{"Line":2},"fn_name":null},{"line":539,"address":[4393376],"length":1,"stats":{"Line":1},"fn_name":null},{"line":540,"address":[4393435],"length":1,"stats":{"Line":1},"fn_name":null},{"line":542,"address":[4393460],"length":1,"stats":{"Line":1},"fn_name":null},{"line":544,"address":[4393751],"length":1,"stats":{"Line":1},"fn_name":null},{"line":545,"address":[4394102,4385870,4385856,4393902],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":550,"address":[4394928,4394933],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":551,"address":[4395008,4395039],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":553,"address":[4395191,4395015],"length":1,"stats":{"Line":2},"fn_name":null},{"line":554,"address":[4395054],"length":1,"stats":{"Line":1},"fn_name":null},{"line":555,"address":[4395183],"length":1,"stats":{"Line":1},"fn_name":null},{"line":559,"address":[4396389,4396456],"length":1,"stats":{"Line":2},"fn_name":null},{"line":560,"address":[4396270],"length":1,"stats":{"Line":1},"fn_name":null},{"line":561,"address":[4396341],"length":1,"stats":{"Line":1},"fn_name":null},{"line":562,"address":[4396366],"length":1,"stats":{"Line":1},"fn_name":null},{"line":566,"address":[4396682],"length":1,"stats":{"Line":1},"fn_name":null},{"line":567,"address":[4397022],"length":1,"stats":{"Line":1},"fn_name":null},{"line":568,"address":[4394974,4394960,4397121,4397375],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":569,"address":[4397338,4397440,4397415],"length":1,"stats":{"Line":2},"fn_name":null},{"line":572,"address":[4397610,4397421],"length":1,"stats":{"Line":2},"fn_name":null},{"line":573,"address":[4397473],"length":1,"stats":{"Line":1},"fn_name":null},{"line":574,"address":[4397602],"length":1,"stats":{"Line":1},"fn_name":null},{"line":577,"address":[4398689,4398845],"length":1,"stats":{"Line":2},"fn_name":null},{"line":578,"address":[4398708],"length":1,"stats":{"Line":1},"fn_name":null},{"line":579,"address":[4398837],"length":1,"stats":{"Line":1},"fn_name":null},{"line":585,"address":[4400096,4400101],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":586,"address":[4400207,4400176],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":587,"address":[4400183,4400359],"length":1,"stats":{"Line":2},"fn_name":null},{"line":588,"address":[4400222],"length":1,"stats":{"Line":1},"fn_name":null},{"line":589,"address":[4400351],"length":1,"stats":{"Line":1},"fn_name":null},{"line":593,"address":[4401557,4401624],"length":1,"stats":{"Line":2},"fn_name":null},{"line":594,"address":[4401438],"length":1,"stats":{"Line":1},"fn_name":null},{"line":595,"address":[4401509],"length":1,"stats":{"Line":1},"fn_name":null},{"line":596,"address":[4401534],"length":1,"stats":{"Line":1},"fn_name":null},{"line":600,"address":[4401850],"length":1,"stats":{"Line":1},"fn_name":null},{"line":603,"address":[4402190],"length":1,"stats":{"Line":1},"fn_name":null},{"line":604,"address":[4402530],"length":1,"stats":{"Line":1},"fn_name":null},{"line":605,"address":[4402883,4400128,4402629,4400142],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":606,"address":[4402846,4402950,4402923],"length":1,"stats":{"Line":2},"fn_name":null},{"line":608,"address":[4402931,4403120],"length":1,"stats":{"Line":2},"fn_name":null},{"line":609,"address":[4402983],"length":1,"stats":{"Line":1},"fn_name":null},{"line":610,"address":[4403112],"length":1,"stats":{"Line":1},"fn_name":null},{"line":613,"address":[4404355,4404199],"length":1,"stats":{"Line":2},"fn_name":null},{"line":614,"address":[4404218],"length":1,"stats":{"Line":1},"fn_name":null},{"line":615,"address":[4404347],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":315,"coverable":315},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","oracle","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse frame_support::{decl_error, decl_event, decl_module, decl_storage};\nuse minterest_primitives::{CurrencyId, Price};\nuse sp_runtime::DispatchError;\nuse sp_std::result;\n\npub trait Trait: frame_system::Trait {\n\ttype Event: From\u003cEvent\u003e + Into\u003c\u003cSelf as frame_system::Trait\u003e::Event\u003e;\n}\n\ndecl_storage! {\n\ttrait Store for Module\u003cT: Trait\u003e as Exchange {\n\t}\n}\n\ndecl_event!(\n\tpub enum Event {}\n);\n\ndecl_error! {\n\tpub enum Error for Module\u003cT: Trait\u003e {\n\t}\n}\n\ndecl_module! {\n\tpub struct Module\u003cT: Trait\u003e for enum Call where origin: T::Origin {\n\t\ttype Error = Error\u003cT\u003e;\n\n\t\tfn deposit_event() = default;\n\t}\n}\n\ntype PriceResult = result::Result\u003cPrice, DispatchError\u003e;\n\nimpl\u003cT: Trait\u003e Module\u003cT\u003e {\n\tpub fn get_underlying_price(_underlying_asset_id: CurrencyId) -\u003e PriceResult {\n\t\tlet price_nine_dollars = 2_00u128 * 10_000_000_000_000_000;\n\t\tOk(Price::from_inner(price_nine_dollars)) // Price = 2.00 USD\n\t}\n}\n","traces":[{"line":12,"address":[4211136,4211157,4211264,4211248,4211216],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":37,"address":[6276352],"length":1,"stats":{"Line":11},"fn_name":"get_underlying_price\u003cnode_minterest_runtime::Runtime\u003e"},{"line":38,"address":[5327398],"length":1,"stats":{"Line":4},"fn_name":null},{"line":39,"address":[4712772],"length":1,"stats":{"Line":11},"fn_name":null}],"covered":3,"coverable":4},{"path":["/","home","lut1k","Projects","minterest-chain-node","pallets","traits","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse minterest_primitives::{Balance, CurrencyId};\nuse sp_runtime::DispatchResult;\n\n/// An abstraction of basic borrowing functions\npub trait Borrowing\u003cAccountId\u003e {\n\t/// Updates the state of the core as a consequence of a borrow action.\n\tfn update_state_on_borrow(\n\t\twho: \u0026AccountId,\n\t\tunderlying_asset_id: CurrencyId,\n\t\tamount_borrowed: Balance,\n\t\taccount_borrows: Balance,\n\t) -\u003e DispatchResult;\n\n\t/// updates the state of the core as a consequence of a repay action.\n\tfn update_state_on_repay(\n\t\twho: \u0026AccountId,\n\t\tunderlying_asset_id: CurrencyId,\n\t\trepay_amount: Balance,\n\t\taccount_borrows: Balance,\n\t) -\u003e DispatchResult;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","primitives","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n\nuse codec::{Decode, Encode};\nuse sp_runtime::{\n\tgeneric,\n\ttraits::{IdentifyAccount, Verify},\n\tFixedU128, MultiSignature, RuntimeDebug,\n};\n\n#[cfg(feature = \"std\")]\nuse serde::{Deserialize, Serialize};\n\n/// An index to a block.\npub type BlockNumber = u32;\n\n/// Alias to 512-bit hash when used in the context of a transaction signature on the chain.\npub type Signature = MultiSignature;\n\n/// Some way of identifying an account on the chain. We intentionally make it equivalent\n/// to the public key of our transaction signing scheme.\npub type AccountId = \u003c\u003cSignature as Verify\u003e::Signer as IdentifyAccount\u003e::AccountId;\n\n/// The type for looking up accounts. We don't expect more than 4 billion of them, but you\n/// never know...\npub type AccountIndex = u32;\n\n/// Balance of an account.\npub type Balance = u128;\n\n/// Index of a transaction in the chain.\npub type Index = u32;\n\n/// A hash of some data used by the chain.\npub type Hash = sp_core::H256;\n\n/// Digest item type.\npub type DigestItem = generic::DigestItem\u003cHash\u003e;\n\n/// Signed version of Balance\npub type Amount = i128;\n\n/// Exchange Rate\npub type Rate = FixedU128;\n\n/// Token Price\npub type Price = FixedU128;\n\n#[derive(Encode, Decode, Eq, PartialEq, Copy, Clone, RuntimeDebug, PartialOrd, Ord)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub enum CurrencyId {\n\tMINT = 0,\n\tDOT,\n\tKSM,\n\tBTC,\n\tETH,\n\tMDOT,\n\tMKSM,\n\tMBTC,\n\tMETH,\n}\n\n#[derive(Encode, Decode, Eq, PartialEq, Copy, Clone, RuntimeDebug, PartialOrd, Ord)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub struct CurrencyPair {\n\tpub underlying_id: CurrencyId,\n\tpub wrapped_id: CurrencyId,\n}\n\nimpl CurrencyPair {\n\tpub fn new(underlying_id: CurrencyId, wrapped_id: CurrencyId) -\u003e Self {\n\t\tSelf {\n\t\t\tunderlying_id,\n\t\t\twrapped_id,\n\t\t}\n\t}\n}\n\n#[derive(Encode, Decode, Eq, PartialEq, Copy, Clone, RuntimeDebug, PartialOrd, Ord)]\n#[cfg_attr(feature = \"std\", derive(Serialize, Deserialize))]\npub enum Operation {\n\tDeposit,\n\tRedeem,\n\tBorrow,\n\tRepay,\n}\n","traces":[{"line":70,"address":[4217504],"length":1,"stats":{"Line":19},"fn_name":"new"}],"covered":1,"coverable":1},{"path":["/","home","lut1k","Projects","minterest-chain-node","rpc","src","lib.rs"],"content":"use std::sync::Arc;\n\nuse node_minterest_runtime::{opaque::Block, AccountId, Balance, Index};\npub use sc_rpc_api::DenyUnsafe;\nuse sp_api::ProvideRuntimeApi;\nuse sp_block_builder::BlockBuilder;\nuse sp_blockchain::{Error as BlockChainError, HeaderBackend, HeaderMetadata};\nuse sp_transaction_pool::TransactionPool;\n\n/// Full client dependencies.\npub struct FullDeps\u003cC, P\u003e {\n\t/// The client instance to use.\n\tpub client: Arc\u003cC\u003e,\n\t/// Transaction pool instance.\n\tpub pool: Arc\u003cP\u003e,\n\t/// Whether to deny unsafe calls\n\tpub deny_unsafe: DenyUnsafe,\n}\n\n/// Instantiate all full RPC extensions.\npub fn create_full\u003cC, P\u003e(deps: FullDeps\u003cC, P\u003e) -\u003e jsonrpc_core::IoHandler\u003csc_rpc::Metadata\u003e\nwhere\n\tC: ProvideRuntimeApi\u003cBlock\u003e,\n\tC: HeaderBackend\u003cBlock\u003e + HeaderMetadata\u003cBlock, Error = BlockChainError\u003e + 'static,\n\tC: Send + Sync + 'static,\n\tC::Api: substrate_frame_rpc_system::AccountNonceApi\u003cBlock, AccountId, Index\u003e,\n\tC::Api: pallet_transaction_payment_rpc::TransactionPaymentRuntimeApi\u003cBlock, Balance\u003e,\n\tC::Api: controller_rpc::ControllerRuntimeApi\u003cBlock\u003e,\n\tC::Api: BlockBuilder\u003cBlock\u003e,\n\tP: TransactionPool + 'static,\n{\n\tuse controller_rpc::{Controller, ControllerApi};\n\tuse pallet_transaction_payment_rpc::{TransactionPayment, TransactionPaymentApi};\n\tuse substrate_frame_rpc_system::{FullSystem, SystemApi};\n\n\tlet mut io = jsonrpc_core::IoHandler::default();\n\tlet FullDeps {\n\t\tclient,\n\t\tpool,\n\t\tdeny_unsafe,\n\t} = deps;\n\n\tio.extend_with(SystemApi::to_delegate(FullSystem::new(\n\t\tclient.clone(),\n\t\tpool,\n\t\tdeny_unsafe,\n\t)));\n\n\tio.extend_with(TransactionPaymentApi::to_delegate(TransactionPayment::new(\n\t\tclient.clone(),\n\t)));\n\n\tio.extend_with(ControllerApi::to_delegate(Controller::new(client)));\n\t// Extend this RPC with a custom API by using the following syntax.\n\t// `YourRpcStruct` should have a reference to a client, which is needed\n\t// to call into the runtime.\n\t// `io.extend_with(YourRpcTrait::to_delegate(YourRpcStruct::new(ReferenceToClient, ...)));`\n\n\tio\n}\n","traces":[{"line":21,"address":[10100176,10100746],"length":1,"stats":{"Line":0},"fn_name":"create_full\u003csc_service::client::client::Client\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_service::client::call_executor::LocalCallExecutor\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_executor::native_executor::NativeExecutor\u003cminterest_service::Executor\u003e\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e, node_minterest_runtime::RuntimeApi\u003e,sc_transaction_pool::BasicPool\u003csc_transaction_pool::api::FullChainApi\u003csc_service::client::client::Client\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_service::client::call_executor::LocalCallExecutor\u003csc_client_db::Backend\u003csp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sc_executor::native_executor::NativeExecutor\u003cminterest_service::Executor\u003e\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e, node_minterest_runtime::RuntimeApi\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e, sp_runtime::generic::block::Block\u003csp_runtime::generic::header::Header\u003cu32, sp_runtime::traits::BlakeTwo256\u003e, sp_runtime::OpaqueExtrinsic\u003e\u003e\u003e"},{"line":36,"address":[24359210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[10337332],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[24359309],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[10100314],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[24359353,24359430],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[24359370],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[24359413],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[24359498,24359532],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[24359515],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[24359589],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":11},{"path":["/","home","lut1k","Projects","minterest-chain-node","runtime","build.rs"],"content":"use wasm_builder_runner::WasmBuilder;\n\nfn main() {\n\tWasmBuilder::new()\n\t\t.with_current_project()\n\t\t.with_wasm_builder_from_crates(\"2.0.0\")\n\t\t.export_heap_base()\n\t\t.import_memory()\n\t\t.build()\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","runtime","src","constants.rs"],"content":"//! A set of constant values used in runtime.\n\nuse minterest_primitives::Rate;\n\n/// Money matters.\npub mod currency {\n\tuse minterest_primitives::Balance;\n\n\tpub const DOLLARS: Balance = 1_000_000_000_000_000_000;\n\tpub const CENTS: Balance = DOLLARS / 100;\n\tpub const MILLICENTS: Balance = CENTS / 1000;\n}\n\n/// Time.\npub mod time {\n\tuse minterest_primitives::BlockNumber;\n\tpub const MILLISECS_PER_BLOCK: u64 = 6000;\n\n\tpub const SLOT_DURATION: u64 = MILLISECS_PER_BLOCK;\n\n\t// Time is measured by number of blocks.\n\tpub const MINUTES: BlockNumber = 60_000 / (MILLISECS_PER_BLOCK as BlockNumber);\n\tpub const HOURS: BlockNumber = MINUTES * 60;\n\tpub const DAYS: BlockNumber = HOURS * 24;\n\n\tpub const SECONDS_PER_YEAR: u128 = 365 * DAYS as u128;\n\tpub const BLOCKS_PER_YEAR: u128 = SECONDS_PER_YEAR / MILLISECS_PER_BLOCK as u128;\n\t// BLOCKS_PER_YEAR has to be 5256000\n}\n\n/// A maximum number of admins. When membership reaches this number, no new members may join.\npub const MAX_MEMBERS: u32 = 16;\n\n/// Initial exchange rate: 100%\npub const INITIAL_EXCHANGE_RATE: Rate = Rate::from_inner(1_000_000_000_000_000_000);\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","lut1k","Projects","minterest-chain-node","runtime","src","lib.rs"],"content":"#![cfg_attr(not(feature = \"std\"), no_std)]\n// `construct_runtime!` does a lot of recursion and requires us to increase the limit to 256.\n#![recursion_limit = \"256\"]\n// The `large_enum_variant` warning originates from `construct_runtime` macro.\n#![allow(clippy::large_enum_variant)]\n\n// Make the WASM binary available.\n#[cfg(feature = \"std\")]\ninclude!(concat!(env!(\"OUT_DIR\"), \"/wasm_binary.rs\"));\n\nmod constants;\n#[cfg(test)]\nmod tests;\n\npub use controller_rpc_runtime_api::PoolState;\nuse orml_currencies::BasicCurrencyAdapter;\nuse pallet_grandpa::fg_primitives;\nuse pallet_grandpa::{AuthorityId as GrandpaId, AuthorityList as GrandpaAuthorityList};\nuse sp_api::impl_runtime_apis;\nuse sp_consensus_aura::sr25519::AuthorityId as AuraId;\nuse sp_core::{crypto::KeyTypeId, OpaqueMetadata};\nuse sp_runtime::traits::{BlakeTwo256, Block as BlockT, IdentityLookup, NumberFor, Saturating};\nuse sp_runtime::{\n\tcreate_runtime_str, generic, impl_opaque_keys,\n\ttransaction_validity::{TransactionSource, TransactionValidity},\n\tApplyExtrinsicResult, ModuleId,\n};\nuse sp_std::prelude::*;\n#[cfg(feature = \"std\")]\nuse sp_version::NativeVersion;\nuse sp_version::RuntimeVersion;\n\npub use minterest_primitives::{\n\tAccountId, AccountIndex, Amount, Balance, BlockNumber, CurrencyId, CurrencyPair, DigestItem, Hash, Index, Rate,\n\tSignature,\n};\n\n// A few exports that help ease life for downstream crates.\npub use frame_support::{\n\tconstruct_runtime, parameter_types,\n\ttraits::{KeyOwnerProofSystem, Randomness},\n\tweights::{\n\t\tconstants::{BlockExecutionWeight, ExtrinsicBaseWeight, RocksDbWeight, WEIGHT_PER_SECOND},\n\t\tIdentityFee, Weight,\n\t},\n\tStorageValue,\n};\npub use pallet_balances::Call as BalancesCall;\npub use pallet_timestamp::Call as TimestampCall;\n#[cfg(any(feature = \"std\", test))]\npub use sp_runtime::BuildStorage;\npub use sp_runtime::{Perbill, Permill};\n\npub use constants::{currency::*, time::*, *};\n\n/// Opaque types. These are used by the CLI to instantiate machinery that don't need to know\n/// the specifics of the runtime. They can then be made to be agnostic over specific formats\n/// of data like extrinsics, allowing for them to continue syncing the network through upgrades\n/// to even the core data structures.\npub mod opaque {\n\tuse super::*;\n\n\tpub use sp_runtime::OpaqueExtrinsic as UncheckedExtrinsic;\n\n\t/// Opaque block header type.\n\tpub type Header = generic::Header\u003cBlockNumber, BlakeTwo256\u003e;\n\t/// Opaque block type.\n\tpub type Block = generic::Block\u003cHeader, UncheckedExtrinsic\u003e;\n\t/// Opaque block identifier type.\n\tpub type BlockId = generic::BlockId\u003cBlock\u003e;\n\n\timpl_opaque_keys! {\n\t\tpub struct SessionKeys {\n\t\t\tpub aura: Aura,\n\t\t\tpub grandpa: Grandpa,\n\t\t}\n\t}\n}\n\npub const VERSION: RuntimeVersion = RuntimeVersion {\n\tspec_name: create_runtime_str!(\"node-minterest\"),\n\timpl_name: create_runtime_str!(\"node-minterest\"),\n\tauthoring_version: 1,\n\tspec_version: 1,\n\timpl_version: 1,\n\tapis: RUNTIME_API_VERSIONS,\n\ttransaction_version: 1,\n};\n\n/// The version information used to identify this runtime when compiled natively.\n#[cfg(feature = \"std\")]\npub fn native_version() -\u003e NativeVersion {\n\tNativeVersion {\n\t\truntime_version: VERSION,\n\t\tcan_author_with: Default::default(),\n\t}\n}\n\n// Module accounts of runtime\nparameter_types! {\n\tpub const LiquidityPoolsModuleId: ModuleId = ModuleId(*b\"min/pool\");\n}\n\nparameter_types! {\n\tpub const BlockHashCount: BlockNumber = 2400;\n\t/// We allow for 2 seconds of compute with a 6 second average block time.\n\tpub const MaximumBlockWeight: Weight = 2 * WEIGHT_PER_SECOND;\n\tpub const AvailableBlockRatio: Perbill = Perbill::from_percent(75);\n\t/// Assume 10% of weight for average on_initialize calls.\n\tpub MaximumExtrinsicWeight: Weight = AvailableBlockRatio::get()\n\t\t.saturating_sub(Perbill::from_percent(10)) * MaximumBlockWeight::get();\n\tpub const MaximumBlockLength: u32 = 5 * 1024 * 1024;\n\tpub const Version: RuntimeVersion = VERSION;\n}\n\n// Configure FRAME pallets to include in runtime.\n\nimpl frame_system::Trait for Runtime {\n\t/// The basic call filter to use in dispatchable.\n\ttype BaseCallFilter = ();\n\t/// The identifier used to distinguish between accounts.\n\ttype AccountId = AccountId;\n\t/// The aggregated dispatch type that is available for extrinsics.\n\ttype Call = Call;\n\t/// The lookup mechanism to get account ID from whatever is passed in dispatchers.\n\ttype Lookup = IdentityLookup\u003cAccountId\u003e;\n\t/// The index type for storing how many extrinsics an account has signed.\n\ttype Index = Index;\n\t/// The index type for blocks.\n\ttype BlockNumber = BlockNumber;\n\t/// The type for hashing blocks and tries.\n\ttype Hash = Hash;\n\t/// The hashing algorithm used.\n\ttype Hashing = BlakeTwo256;\n\t/// The header type.\n\ttype Header = generic::Header\u003cBlockNumber, BlakeTwo256\u003e;\n\t/// The ubiquitous event type.\n\ttype Event = Event;\n\t/// The ubiquitous origin type.\n\ttype Origin = Origin;\n\t/// Maximum number of block number to block hash mappings to keep (oldest pruned first).\n\ttype BlockHashCount = BlockHashCount;\n\t/// Maximum weight of each block.\n\ttype MaximumBlockWeight = MaximumBlockWeight;\n\t/// The weight of database operations that the runtime can invoke.\n\ttype DbWeight = RocksDbWeight;\n\t/// The weight of the overhead invoked on the block import process, independent of the\n\t/// extrinsics included in that block.\n\ttype BlockExecutionWeight = BlockExecutionWeight;\n\t/// The base weight of any extrinsic processed by the runtime, independent of the\n\t/// logic of that extrinsic. (Signature verification, nonce increment, fee, etc...)\n\ttype ExtrinsicBaseWeight = ExtrinsicBaseWeight;\n\t/// The maximum weight that a single extrinsic of `Normal` dispatch class can have,\n\t/// idependent of the logic of that extrinsics. (Roughly max block weight - average on\n\t/// initialize cost).\n\ttype MaximumExtrinsicWeight = MaximumExtrinsicWeight;\n\t/// Maximum size of all encoded transactions (in bytes) that are allowed in one block.\n\ttype MaximumBlockLength = MaximumBlockLength;\n\t/// Portion of the block weight that is available to all normal transactions.\n\ttype AvailableBlockRatio = AvailableBlockRatio;\n\t/// Version of the runtime.\n\ttype Version = Version;\n\t/// Converts a module to the index of the module in `construct_runtime!`.\n\t///\n\t/// This type is being generated by `construct_runtime!`.\n\ttype PalletInfo = PalletInfo;\n\t/// What to do if a new account is created.\n\ttype OnNewAccount = ();\n\t/// What to do if an account is fully reaped from the system.\n\ttype OnKilledAccount = ();\n\t/// The data to be stored in an account.\n\ttype AccountData = pallet_balances::AccountData\u003cBalance\u003e;\n\t/// Weight information for the extrinsics of this pallet.\n\ttype SystemWeightInfo = ();\n}\n\nimpl pallet_aura::Trait for Runtime {\n\ttype AuthorityId = AuraId;\n}\n\nimpl pallet_grandpa::Trait for Runtime {\n\ttype Event = Event;\n\ttype Call = Call;\n\n\ttype KeyOwnerProofSystem = ();\n\n\ttype KeyOwnerProof = \u003cSelf::KeyOwnerProofSystem as KeyOwnerProofSystem\u003c(KeyTypeId, GrandpaId)\u003e\u003e::Proof;\n\n\ttype KeyOwnerIdentification =\n\t\t\u003cSelf::KeyOwnerProofSystem as KeyOwnerProofSystem\u003c(KeyTypeId, GrandpaId)\u003e\u003e::IdentificationTuple;\n\n\ttype HandleEquivocation = ();\n\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const MinimumPeriod: u64 = SLOT_DURATION / 2;\n}\n\nimpl pallet_timestamp::Trait for Runtime {\n\t/// A timestamp: milliseconds since the unix epoch.\n\ttype Moment = u64;\n\ttype OnTimestampSet = Aura;\n\ttype MinimumPeriod = MinimumPeriod;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const ExistentialDeposit: u128 = 500;\n\tpub const MaxLocks: u32 = 50;\n}\n\nimpl pallet_balances::Trait for Runtime {\n\ttype MaxLocks = MaxLocks;\n\t/// The type for recording an account's balance.\n\ttype Balance = Balance;\n\t/// The ubiquitous event type.\n\ttype Event = Event;\n\ttype DustRemoval = ();\n\ttype ExistentialDeposit = ExistentialDeposit;\n\ttype AccountStore = System;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const TransactionByteFee: Balance = 1;\n}\n\nimpl pallet_transaction_payment::Trait for Runtime {\n\ttype Currency = Balances;\n\ttype OnTransactionPayment = ();\n\ttype TransactionByteFee = TransactionByteFee;\n\ttype WeightToFee = IdentityFee\u003cBalance\u003e;\n\ttype FeeMultiplierUpdate = ();\n}\n\nimpl pallet_sudo::Trait for Runtime {\n\ttype Event = Event;\n\ttype Call = Call;\n}\n\nimpl m_tokens::Trait for Runtime {\n\ttype Event = Event;\n\ttype MultiCurrency = Currencies;\n}\n\nimpl minterest_protocol::Trait for Runtime {\n\ttype Event = Event;\n\ttype Borrowing = liquidity_pools::Module\u003cRuntime\u003e;\n}\n\nimpl orml_tokens::Trait for Runtime {\n\ttype Event = Event;\n\ttype Balance = Balance;\n\ttype Amount = Amount;\n\ttype CurrencyId = CurrencyId;\n\ttype OnReceived = ();\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const GetMinterestCurrencyId: CurrencyId = CurrencyId::MINT;\n}\n\npub type MinterestToken = BasicCurrencyAdapter\u003cRuntime, Balances, Amount, BlockNumber\u003e;\n\nimpl orml_currencies::Trait for Runtime {\n\ttype Event = Event;\n\ttype MultiCurrency = Tokens;\n\ttype NativeCurrency = MinterestToken;\n\ttype GetNativeCurrencyId = GetMinterestCurrencyId;\n\ttype WeightInfo = ();\n}\n\nparameter_types! {\n\tpub const InitialExchangeRate: Rate = INITIAL_EXCHANGE_RATE;\n\tpub EnabledCurrencyPair: Vec\u003cCurrencyPair\u003e = vec![\n\t\tCurrencyPair::new(CurrencyId::DOT, CurrencyId::MDOT),\n\t\tCurrencyPair::new(CurrencyId::KSM, CurrencyId::MKSM),\n\t\tCurrencyPair::new(CurrencyId::BTC, CurrencyId::MBTC),\n\t\tCurrencyPair::new(CurrencyId::ETH, CurrencyId::METH),\n\t];\n}\n\nimpl liquidity_pools::Trait for Runtime {\n\ttype Event = Event;\n\ttype MultiCurrency = Currencies;\n\ttype ModuleId = LiquidityPoolsModuleId;\n\ttype InitialExchangeRate = InitialExchangeRate;\n\ttype EnabledCurrencyPair = EnabledCurrencyPair;\n}\n\nimpl controller::Trait for Runtime {\n\ttype Event = Event;\n}\n\nparameter_types! {\n\tpub const MaxMembers: u32 = MAX_MEMBERS;\n}\n\nimpl accounts::Trait for Runtime {\n\ttype Event = Event;\n\ttype MaxMembers = MaxMembers;\n}\n\nimpl oracle::Trait for Runtime {\n\ttype Event = Event;\n}\n\nparameter_types! {\n\tpub const BlocksPerYear: u128 = BLOCKS_PER_YEAR;\n}\n\nimpl minterest_model::Trait for Runtime {\n\ttype Event = Event;\n\ttype BlocksPerYear = BlocksPerYear;\n}\n\n// Create the runtime by composing the FRAME pallets that were previously configured.\nconstruct_runtime!(\n\tpub enum Runtime where\n\t\tBlock = Block,\n\t\tNodeBlock = opaque::Block,\n\t\tUncheckedExtrinsic = UncheckedExtrinsic\n\t{\n\t\tSystem: frame_system::{Module, Call, Config, Storage, Event\u003cT\u003e},\n\t\tRandomnessCollectiveFlip: pallet_randomness_collective_flip::{Module, Call, Storage},\n\t\tTimestamp: pallet_timestamp::{Module, Call, Storage, Inherent},\n\t\tAura: pallet_aura::{Module, Config\u003cT\u003e, Inherent},\n\t\tGrandpa: pallet_grandpa::{Module, Call, Storage, Config, Event},\n\t\tBalances: pallet_balances::{Module, Call, Storage, Config\u003cT\u003e, Event\u003cT\u003e},\n\t\tTransactionPayment: pallet_transaction_payment::{Module, Storage},\n\t\tSudo: pallet_sudo::{Module, Call, Config\u003cT\u003e, Storage, Event\u003cT\u003e},\n\t\t//ORML palletts\n\t\tTokens: orml_tokens::{Module, Storage, Call, Event\u003cT\u003e, Config\u003cT\u003e},\n\t\tCurrencies: orml_currencies::{Module, Call, Event\u003cT\u003e},\n\t\t// Minterest pallets\n\t\tMTokens: m_tokens::{Module, Storage, Call, Event\u003cT\u003e},\n\t\tMinterestProtocol: minterest_protocol::{Module, Storage, Call, Event\u003cT\u003e},\n\t\tLiquidityPools: liquidity_pools::{Module, Storage, Call, Event, Config\u003cT\u003e},\n\t\tController: controller::{Module, Storage, Call, Event, Config\u003cT\u003e},\n\t\tAccounts: accounts::{Module, Storage, Call, Event\u003cT\u003e, Config\u003cT\u003e},\n\t\tOracle: oracle::{Module, Storage, Call, Event},\n\t\tMinterestModel: minterest_model::{Module, Storage, Call, Event, Config},\n\t}\n);\n\n/// The address format for describing accounts.\npub type Address = AccountId;\n/// Block header type as expected by this runtime.\npub type Header = generic::Header\u003cBlockNumber, BlakeTwo256\u003e;\n/// Block type as expected by this runtime.\npub type Block = generic::Block\u003cHeader, UncheckedExtrinsic\u003e;\n/// A Block signed with a Justification\npub type SignedBlock = generic::SignedBlock\u003cBlock\u003e;\n/// BlockId type as expected by this runtime.\npub type BlockId = generic::BlockId\u003cBlock\u003e;\n/// The SignedExtension to the basic transaction logic.\npub type SignedExtra = (\n\tframe_system::CheckSpecVersion\u003cRuntime\u003e,\n\tframe_system::CheckTxVersion\u003cRuntime\u003e,\n\tframe_system::CheckGenesis\u003cRuntime\u003e,\n\tframe_system::CheckEra\u003cRuntime\u003e,\n\tframe_system::CheckNonce\u003cRuntime\u003e,\n\tframe_system::CheckWeight\u003cRuntime\u003e,\n\tpallet_transaction_payment::ChargeTransactionPayment\u003cRuntime\u003e,\n);\n/// Unchecked extrinsic type as expected by this runtime.\npub type UncheckedExtrinsic = generic::UncheckedExtrinsic\u003cAddress, Call, Signature, SignedExtra\u003e;\n/// Extrinsic type that has already been checked.\npub type CheckedExtrinsic = generic::CheckedExtrinsic\u003cAccountId, Call, SignedExtra\u003e;\n/// Executive: handles dispatch to the various modules.\npub type Executive =\n\tframe_executive::Executive\u003cRuntime, Block, frame_system::ChainContext\u003cRuntime\u003e, Runtime, AllModules\u003e;\n\nimpl_runtime_apis! {\n\timpl sp_api::Core\u003cBlock\u003e for Runtime {\n\t\tfn version() -\u003e RuntimeVersion {\n\t\t\tVERSION\n\t\t}\n\n\t\tfn execute_block(block: Block) {\n\t\t\tExecutive::execute_block(block)\n\t\t}\n\n\t\tfn initialize_block(header: \u0026\u003cBlock as BlockT\u003e::Header) {\n\t\t\tExecutive::initialize_block(header)\n\t\t}\n\t}\n\n\timpl sp_api::Metadata\u003cBlock\u003e for Runtime {\n\t\tfn metadata() -\u003e OpaqueMetadata {\n\t\t\tRuntime::metadata().into()\n\t\t}\n\t}\n\n\timpl sp_block_builder::BlockBuilder\u003cBlock\u003e for Runtime {\n\t\tfn apply_extrinsic(extrinsic: \u003cBlock as BlockT\u003e::Extrinsic) -\u003e ApplyExtrinsicResult {\n\t\t\tExecutive::apply_extrinsic(extrinsic)\n\t\t}\n\n\t\tfn finalize_block() -\u003e \u003cBlock as BlockT\u003e::Header {\n\t\t\tExecutive::finalize_block()\n\t\t}\n\n\t\tfn inherent_extrinsics(data: sp_inherents::InherentData) -\u003e Vec\u003c\u003cBlock as BlockT\u003e::Extrinsic\u003e {\n\t\t\tdata.create_extrinsics()\n\t\t}\n\n\t\tfn check_inherents(\n\t\t\tblock: Block,\n\t\t\tdata: sp_inherents::InherentData,\n\t\t) -\u003e sp_inherents::CheckInherentsResult {\n\t\t\tdata.check_extrinsics(\u0026block)\n\t\t}\n\n\t\tfn random_seed() -\u003e \u003cBlock as BlockT\u003e::Hash {\n\t\t\tRandomnessCollectiveFlip::random_seed()\n\t\t}\n\t}\n\n\timpl sp_transaction_pool::runtime_api::TaggedTransactionQueue\u003cBlock\u003e for Runtime {\n\t\tfn validate_transaction(\n\t\t\tsource: TransactionSource,\n\t\t\ttx: \u003cBlock as BlockT\u003e::Extrinsic,\n\t\t) -\u003e TransactionValidity {\n\t\t\tExecutive::validate_transaction(source, tx)\n\t\t}\n\t}\n\n\timpl sp_offchain::OffchainWorkerApi\u003cBlock\u003e for Runtime {\n\t\tfn offchain_worker(header: \u0026\u003cBlock as BlockT\u003e::Header) {\n\t\t\tExecutive::offchain_worker(header)\n\t\t}\n\t}\n\n\timpl sp_consensus_aura::AuraApi\u003cBlock, AuraId\u003e for Runtime {\n\t\tfn slot_duration() -\u003e u64 {\n\t\t\tAura::slot_duration()\n\t\t}\n\n\t\tfn authorities() -\u003e Vec\u003cAuraId\u003e {\n\t\t\tAura::authorities()\n\t\t}\n\t}\n\n\timpl sp_session::SessionKeys\u003cBlock\u003e for Runtime {\n\t\tfn generate_session_keys(seed: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Vec\u003cu8\u003e {\n\t\t\topaque::SessionKeys::generate(seed)\n\t\t}\n\n\t\tfn decode_session_keys(\n\t\t\tencoded: Vec\u003cu8\u003e,\n\t\t) -\u003e Option\u003cVec\u003c(Vec\u003cu8\u003e, KeyTypeId)\u003e\u003e {\n\t\t\topaque::SessionKeys::decode_into_raw_public_keys(\u0026encoded)\n\t\t}\n\t}\n\n\timpl fg_primitives::GrandpaApi\u003cBlock\u003e for Runtime {\n\t\tfn grandpa_authorities() -\u003e GrandpaAuthorityList {\n\t\t\tGrandpa::grandpa_authorities()\n\t\t}\n\n\t\tfn submit_report_equivocation_unsigned_extrinsic(\n\t\t\t_equivocation_proof: fg_primitives::EquivocationProof\u003c\n\t\t\t\t\u003cBlock as BlockT\u003e::Hash,\n\t\t\t\tNumberFor\u003cBlock\u003e,\n\t\t\t\u003e,\n\t\t\t_key_owner_proof: fg_primitives::OpaqueKeyOwnershipProof,\n\t\t) -\u003e Option\u003c()\u003e {\n\t\t\tNone\n\t\t}\n\n\t\tfn generate_key_ownership_proof(\n\t\t\t_set_id: fg_primitives::SetId,\n\t\t\t_authority_id: GrandpaId,\n\t\t) -\u003e Option\u003cfg_primitives::OpaqueKeyOwnershipProof\u003e {\n\t\t\t// NOTE: this is the only implementation possible since we've\n\t\t\t// defined our key owner proof type as a bottom type (i.e. a type\n\t\t\t// with no values).\n\t\t\tNone\n\t\t}\n\t}\n\n\timpl frame_system_rpc_runtime_api::AccountNonceApi\u003cBlock, AccountId, Index\u003e for Runtime {\n\t\tfn account_nonce(account: AccountId) -\u003e Index {\n\t\t\tSystem::account_nonce(account)\n\t\t}\n\t}\n\n\timpl pallet_transaction_payment_rpc_runtime_api::TransactionPaymentApi\u003cBlock, Balance\u003e for Runtime {\n\t\tfn query_info(\n\t\t\tuxt: \u003cBlock as BlockT\u003e::Extrinsic,\n\t\t\tlen: u32,\n\t\t) -\u003e pallet_transaction_payment_rpc_runtime_api::RuntimeDispatchInfo\u003cBalance\u003e {\n\t\t\tTransactionPayment::query_info(uxt, len)\n\t\t}\n\t}\n\n\timpl controller_rpc_runtime_api::ControllerApi\u003cBlock\u003e for Runtime {\n\t\tfn liquidity_pool_state(pool_id: CurrencyId) -\u003e Option\u003cPoolState\u003e {\n\t\t\tlet exchange_rate = Controller::get_liquidity_pool_exchange_rate(pool_id)?;\n\t\t\tlet (borrow_rate, supply_rate) = Controller::get_liquidity_pool_borrow_and_supply_rates(pool_id)?;\n\n\t\t\tSome(PoolState { exchange_rate, borrow_rate, supply_rate })\n\t\t}\n\t}\n\n\t#[cfg(feature = \"runtime-benchmarks\")]\n\timpl frame_benchmarking::Benchmark\u003cBlock\u003e for Runtime {\n\t\tfn dispatch_benchmark(\n\t\t\tconfig: frame_benchmarking::BenchmarkConfig\n\t\t) -\u003e Result\u003cVec\u003cframe_benchmarking::BenchmarkBatch\u003e, sp_runtime::RuntimeString\u003e {\n\t\t\tuse frame_benchmarking::{Benchmarking, BenchmarkBatch, add_benchmark, TrackedStorageKey};\n\n\t\t\tuse frame_system_benchmarking::Module as SystemBench;\n\t\t\timpl frame_system_benchmarking::Trait for Runtime {}\n\n\t\t\tlet whitelist: Vec\u003cTrackedStorageKey\u003e = vec![\n\t\t\t\t// Block Number\n\t\t\t\thex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef702a5c1b19ab7a04f536c519aca4983ac\").to_vec().into(),\n\t\t\t\t// Total Issuance\n\t\t\t\thex_literal::hex!(\"c2261276cc9d1f8598ea4b6a74b15c2f57c875e4cff74148e4628f264b974c80\").to_vec().into(),\n\t\t\t\t// Execution Phase\n\t\t\t\thex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef7ff553b5a9862a516939d82b3d3d8661a\").to_vec().into(),\n\t\t\t\t// Event Count\n\t\t\t\thex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef70a98fdbe9ce6c55837576c60c7af3850\").to_vec().into(),\n\t\t\t\t// System Events\n\t\t\t\thex_literal::hex!(\"26aa394eea5630e07c48ae0c9558cef780d41e5e16056765bc8461851072c9d7\").to_vec().into(),\n\t\t\t];\n\n\t\t\tlet mut batches = Vec::\u003cBenchmarkBatch\u003e::new();\n\t\t\tlet params = (\u0026config, \u0026whitelist);\n\n\t\t\tadd_benchmark!(params, batches, frame_system, SystemBench::\u003cRuntime\u003e);\n\t\t\tadd_benchmark!(params, batches, pallet_balances, Balances);\n\t\t\tadd_benchmark!(params, batches, pallet_timestamp, Timestamp);\n\n\t\t\tif batches.is_empty() { return Err(\"Benchmark not found for this pallet.\".into()) }\n\t\t\tOk(batches)\n\t\t}\n\t}\n}\n","traces":[{"line":72,"address":[5322386,5322069,5322429,5321810],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[5999680],"length":1,"stats":{"Line":0},"fn_name":"native_version"},{"line":95,"address":[5999687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[5999796],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[5999873],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[5999969,5999940,5999908],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[5999917,5999950],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[6000020],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[6000116],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[6000166,6000505,6000400],"length":1,"stats":{"Line":2},"fn_name":null},{"line":279,"address":[6000184],"length":1,"stats":{"Line":1},"fn_name":null},{"line":280,"address":[6000243],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[6000298],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[6000353],"length":1,"stats":{"Line":1},"fn_name":null},{"line":321,"address":[5518640,5518645],"length":1,"stats":{"Line":17},"fn_name":"{{closure}}"},{"line":377,"address":[4932695,4948494,4939940,4937164,4932640,4946181,4936219,4938835,4938918,4934954,4944690,4945306,4942160,4944017,4943912,4941280,4939835,4943255,4947350,4948139,4945772,4941363,4934619,4947030,4936821,4935357,4939408,4944271,4944773,4937567,4946198,4938416,4940861,4946627,4938162,4943509],"length":1,"stats":{"Line":0},"fn_name":"dispatch"},{"line":379,"address":[6031872],"length":1,"stats":{"Line":0},"fn_name":"version"},{"line":380,"address":[6031876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":383,"address":[4934876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":384,"address":[6031911],"length":1,"stats":{"Line":0},"fn_name":null},{"line":387,"address":[6031968],"length":1,"stats":{"Line":0},"fn_name":"initialize_block"},{"line":388,"address":[6031973],"length":1,"stats":{"Line":0},"fn_name":null},{"line":393,"address":[6031984],"length":1,"stats":{"Line":0},"fn_name":"metadata"},{"line":394,"address":[6031991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":399,"address":[6032048],"length":1,"stats":{"Line":0},"fn_name":"apply_extrinsic"},{"line":400,"address":[6032058],"length":1,"stats":{"Line":0},"fn_name":null},{"line":403,"address":[6032128],"length":1,"stats":{"Line":0},"fn_name":"finalize_block"},{"line":404,"address":[6032136],"length":1,"stats":{"Line":0},"fn_name":null},{"line":407,"address":[6032160,6032184],"length":1,"stats":{"Line":0},"fn_name":"inherent_extrinsics"},{"line":408,"address":[6032177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":411,"address":[6032256,6032295],"length":1,"stats":{"Line":0},"fn_name":"check_inherents"},{"line":412,"address":[4939274,4939167],"length":1,"stats":{"Line":0},"fn_name":null},{"line":413,"address":[4939336,4939234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":415,"address":[6032268],"length":1,"stats":{"Line":0},"fn_name":null},{"line":418,"address":[6032400],"length":1,"stats":{"Line":0},"fn_name":"random_seed"},{"line":419,"address":[6032408],"length":1,"stats":{"Line":0},"fn_name":null},{"line":424,"address":[6032432],"length":1,"stats":{"Line":0},"fn_name":"validate_transaction"},{"line":425,"address":[4940682],"length":1,"stats":{"Line":0},"fn_name":null},{"line":426,"address":[4940693],"length":1,"stats":{"Line":0},"fn_name":null},{"line":428,"address":[6032450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":433,"address":[6032544],"length":1,"stats":{"Line":0},"fn_name":"offchain_worker"},{"line":434,"address":[6032549],"length":1,"stats":{"Line":0},"fn_name":null},{"line":439,"address":[6032560],"length":1,"stats":{"Line":0},"fn_name":"slot_duration"},{"line":440,"address":[6032561],"length":1,"stats":{"Line":0},"fn_name":null},{"line":443,"address":[6032576],"length":1,"stats":{"Line":0},"fn_name":"authorities"},{"line":444,"address":[6032584],"length":1,"stats":{"Line":0},"fn_name":null},{"line":449,"address":[4943453],"length":1,"stats":{"Line":0},"fn_name":null},{"line":450,"address":[6032615],"length":1,"stats":{"Line":0},"fn_name":null},{"line":453,"address":[6032672,6032717],"length":1,"stats":{"Line":0},"fn_name":"decode_session_keys"},{"line":454,"address":[4944215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":456,"address":[6032679,6032743],"length":1,"stats":{"Line":0},"fn_name":null},{"line":461,"address":[6032800],"length":1,"stats":{"Line":0},"fn_name":"grandpa_authorities"},{"line":462,"address":[6032808],"length":1,"stats":{"Line":0},"fn_name":null},{"line":465,"address":[6032832],"length":1,"stats":{"Line":0},"fn_name":"submit_report_equivocation_unsigned_extrinsic"},{"line":466,"address":[4945662,4945568],"length":1,"stats":{"Line":0},"fn_name":null},{"line":470,"address":[4945708,4945614],"length":1,"stats":{"Line":0},"fn_name":null},{"line":472,"address":[6032836],"length":1,"stats":{"Line":0},"fn_name":null},{"line":475,"address":[6032880],"length":1,"stats":{"Line":0},"fn_name":"generate_key_ownership_proof"},{"line":476,"address":[4946483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":477,"address":[4946499],"length":1,"stats":{"Line":0},"fn_name":null},{"line":482,"address":[6032888],"length":1,"stats":{"Line":0},"fn_name":null},{"line":487,"address":[4947286],"length":1,"stats":{"Line":0},"fn_name":null},{"line":488,"address":[6032916],"length":1,"stats":{"Line":0},"fn_name":null},{"line":493,"address":[6032976],"length":1,"stats":{"Line":0},"fn_name":"query_info"},{"line":494,"address":[4948047,4947964],"length":1,"stats":{"Line":0},"fn_name":null},{"line":495,"address":[4948031],"length":1,"stats":{"Line":0},"fn_name":null},{"line":497,"address":[6032993],"length":1,"stats":{"Line":0},"fn_name":null},{"line":502,"address":[6033072],"length":1,"stats":{"Line":1},"fn_name":"liquidity_pool_state"},{"line":503,"address":[6033282,6033090,6033254],"length":1,"stats":{"Line":1},"fn_name":null},{"line":504,"address":[6033523,6033222,6033291],"length":1,"stats":{"Line":2},"fn_name":null},{"line":506,"address":[6033418],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":13,"coverable":71},{"path":["/","home","lut1k","Projects","minterest-chain-node","runtime","src","tests.rs"],"content":"use crate::{\n\tAccountId, Balance, Block,\n\tCurrencyId::{self, DOT, ETH},\n\tRate, Runtime, DOLLARS,\n};\nuse controller::{ControllerData, PauseKeeper};\nuse controller_rpc_runtime_api::runtime_decl_for_ControllerApi::ControllerApi;\nuse controller_rpc_runtime_api::PoolState;\nuse frame_support::{assert_noop, assert_ok, parameter_types};\nuse liquidity_pools::Pool;\nuse minterest_model::MinterestModelData;\nuse minterest_primitives::{Operation, Price};\nuse orml_traits::MultiCurrency;\nuse sp_runtime::traits::Zero;\nuse sp_runtime::FixedPointNumber;\n\ntype MinterestProtocol = minterest_protocol::Module\u003cRuntime\u003e;\ntype LiquidityPools = liquidity_pools::Module\u003cRuntime\u003e;\ntype Controller = controller::Module\u003cRuntime\u003e;\ntype Currencies = orml_currencies::Module\u003cRuntime\u003e;\ntype System = frame_system::Module\u003cRuntime\u003e;\n\nparameter_types! {\n\tpub ALICE: AccountId = AccountId::from([1u8; 32]);\n\tpub BOB: AccountId = AccountId::from([2u8; 32]);\n\tpub CHARLIE: AccountId = AccountId::from([3u8; 32]);\n}\n\nstruct ExtBuilder {\n\tendowed_accounts: Vec\u003c(AccountId, CurrencyId, Balance)\u003e,\n}\n\nimpl Default for ExtBuilder {\n\tfn default() -\u003e Self {\n\t\tSelf {\n\t\t\tendowed_accounts: vec![\n\t\t\t\t// seed: initial assets. Initial MINT to pay for gas.\n\t\t\t\t(ALICE::get(), CurrencyId::MINT, 100_000 * DOLLARS),\n\t\t\t\t(ALICE::get(), CurrencyId::DOT, 100_000 * DOLLARS),\n\t\t\t\t(ALICE::get(), CurrencyId::ETH, 100_000 * DOLLARS),\n\t\t\t\t(BOB::get(), CurrencyId::MINT, 100_000 * DOLLARS),\n\t\t\t\t(BOB::get(), CurrencyId::DOT, 100_000 * DOLLARS),\n\t\t\t\t(BOB::get(), CurrencyId::ETH, 100_000 * DOLLARS),\n\t\t\t\t(CHARLIE::get(), CurrencyId::MINT, 100_000 * DOLLARS),\n\t\t\t\t(CHARLIE::get(), CurrencyId::DOT, 100_000 * DOLLARS),\n\t\t\t\t(CHARLIE::get(), CurrencyId::ETH, 100_000 * DOLLARS),\n\t\t\t],\n\t\t}\n\t}\n}\n\nimpl ExtBuilder {\n\tpub fn build(self) -\u003e sp_io::TestExternalities {\n\t\tlet mut t = frame_system::GenesisConfig::default()\n\t\t\t.build_storage::\u003cRuntime\u003e()\n\t\t\t.unwrap();\n\n\t\torml_tokens::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tendowed_accounts: self.endowed_accounts,\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tliquidity_pools::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tpools: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: Rate::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpool_user_data: vec![],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tcontroller::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tcontroller_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: Rate::saturating_from_rational(1, 10),  // 10%\n\t\t\t\t\t\tmax_borrow_rate: Rate::saturating_from_rational(5, 1000), // 0.5%\n\t\t\t\t\t\tcollateral_factor: Rate::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpause_keepers: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tminterest_model::GenesisConfig {\n\t\t\tminterest_model_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: Rate::saturating_from_rational(8, 10),\n\t\t\t\t\t\tbase_rate_per_block: Rate::zero(),\n\t\t\t\t\t\tmultiplier_per_block: Rate::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: Rate::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\taccounts::GenesisConfig::\u003cRuntime\u003e {\n\t\t\tallowed_accounts: vec![(ALICE::get(), ())],\n\t\t}\n\t\t.assimilate_storage(\u0026mut t)\n\t\t.unwrap();\n\n\t\tlet mut ext: sp_io::TestExternalities = t.into();\n\t\text.execute_with(|| System::set_block_number(1));\n\t\text\n\t}\n}\n\nfn pool_balance(pool_id: CurrencyId) -\u003e Balance {\n\tCurrencies::free_balance(pool_id, \u0026LiquidityPools::pools_account_id())\n}\n\nfn pool_total_insurance(pool_id: CurrencyId) -\u003e Balance {\n\tLiquidityPools::pools(pool_id).total_insurance\n}\n\nfn liquidity_pool_state_rpc(currency_id: CurrencyId) -\u003e Option\u003cPoolState\u003e {\n\t\u003cRuntime as ControllerApi\u003cBlock\u003e\u003e::liquidity_pool_state(currency_id)\n}\n\nfn dollars(amount: u128) -\u003e u128 {\n\tamount.saturating_mul(Price::accuracy())\n}\n\nfn alice() -\u003e \u003cRuntime as frame_system::Trait\u003e::Origin {\n\t\u003cRuntime as frame_system::Trait\u003e::Origin::signed((ALICE::get()).clone())\n}\n\nfn bob() -\u003e \u003cRuntime as frame_system::Trait\u003e::Origin {\n\t\u003cRuntime as frame_system::Trait\u003e::Origin::signed((BOB::get()).clone())\n}\n\nfn charlie() -\u003e \u003cRuntime as frame_system::Trait\u003e::Origin {\n\t\u003cRuntime as frame_system::Trait\u003e::Origin::signed((CHARLIE::get()).clone())\n}\n\n#[test]\nfn test_rates_using_rpc() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(Controller::deposit_insurance(alice(), DOT, dollars(100_000)));\n\t\tassert_ok!(Controller::deposit_insurance(alice(), ETH, dollars(100_000)));\n\t\tassert_eq!(pool_total_insurance(DOT), dollars(100_000));\n\t\tassert_eq!(pool_total_insurance(ETH), dollars(100_000));\n\n\t\tSystem::set_block_number(10);\n\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), DOT, dollars(50_000)));\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), ETH, dollars(70_000)));\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(bob(), DOT));\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(bob(), ETH));\n\t\t// exchange_rate = (150 - 100 + 0) / 50 = 1\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::one(),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\n\t\tSystem::set_block_number(20);\n\n\t\tassert_ok!(MinterestProtocol::borrow(bob(), DOT, dollars(100_000)));\n\t\tassert_ok!(MinterestProtocol::repay(bob(), DOT, dollars(30_000)));\n\t\tassert_eq!(pool_balance(DOT), dollars(80_000));\n\t\t// exchange_rate = (80 - 100 + 70) / 50 = 1\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::one(),\n\t\t\t\tborrow_rate: Rate::from_inner(239_040_000_000),\n\t\t\t\tsupply_rate: Rate::from_inner(301_190_400_000)\n\t\t\t})\n\t\t);\n\n\t\tSystem::set_block_number(30);\n\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(charlie(), DOT, dollars(20_000)));\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(charlie(), ETH, dollars(30_000)));\n\t\t// supply rate and borrow rate decreased\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_003_011_904_000_000),\n\t\t\t\tborrow_rate: Rate::from_inner(172_800_039_584),\n\t\t\t\tsupply_rate: Rate::from_inner(155_520_072_800)\n\t\t\t})\n\t\t);\n\n\t\tSystem::set_block_number(40);\n\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(charlie(), DOT));\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(charlie(), ETH));\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), DOT, dollars(20_000)));\n\t\t// supply rate and borrow rate increased\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_004_567_109_412_126),\n\t\t\t\tborrow_rate: Rate::from_inner(220_114_178_542),\n\t\t\t\tsupply_rate: Rate::from_inner(254_703_421_247)\n\t\t\t})\n\t\t);\n\t});\n}\n\n#[test]\nfn demo_scenario_n2_without_insurance_should_work() {\n\tExtBuilder::default().build().execute_with(|| {\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(alice(), DOT, 100_000 * DOLLARS));\n\t\tSystem::set_block_number(200);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(alice(), ETH, 100_000 * DOLLARS));\n\t\tSystem::set_block_number(600);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), DOT, 80_000 * DOLLARS));\n\t\tSystem::set_block_number(1000);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), ETH, 50_000 * DOLLARS));\n\t\tSystem::set_block_number(2000);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(charlie(), DOT, 100_000 * DOLLARS));\n\t\tSystem::set_block_number(3000);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(charlie(), ETH, 50_000 * DOLLARS));\n\t\tSystem::set_block_number(4000);\n\n\t\tassert_noop!(\n\t\t\tMinterestProtocol::borrow(charlie(), DOT, 20_000 * DOLLARS),\n\t\t\tminterest_protocol::Error::\u003cRuntime\u003e::BorrowControllerRejection\n\t\t);\n\t\tSystem::set_block_number(4100);\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(charlie(), DOT));\n\t\tSystem::set_block_number(4200);\n\t\tassert_ok!(MinterestProtocol::enable_as_collateral(charlie(), ETH));\n\t\tSystem::set_block_number(4300);\n\t\tassert_ok!(Controller::pause_specific_operation(alice(), DOT, Operation::Borrow));\n\t\tSystem::set_block_number(4400);\n\t\tassert_noop!(\n\t\t\tMinterestProtocol::borrow(charlie(), DOT, 20_000 * DOLLARS),\n\t\t\tminterest_protocol::Error::\u003cRuntime\u003e::OperationPaused\n\t\t);\n\t\tSystem::set_block_number(5000);\n\t\tassert_ok!(Controller::unpause_specific_operation(alice(), DOT, Operation::Borrow));\n\n\t\tSystem::set_block_number(6000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), DOT, 20_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::one(),\n\t\t\t\tborrow_rate: Rate::from_inner(642857142),\n\t\t\t\tsupply_rate: Rate::from_inner(41326530)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(7000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), ETH, 10_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::one(),\n\t\t\t\tborrow_rate: Rate::from_inner(450000000),\n\t\t\t\tsupply_rate: Rate::from_inner(20250000)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(8000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), ETH, 20_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000000020250000000),\n\t\t\t\tborrow_rate: Rate::from_inner(1350000175),\n\t\t\t\tsupply_rate: Rate::from_inner(182250047)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(9000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), ETH, 70_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000000202500050963),\n\t\t\t\tborrow_rate: Rate::from_inner(4500001113),\n\t\t\t\tsupply_rate: Rate::from_inner(2025001001)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(10000);\n\t\tassert_ok!(MinterestProtocol::repay(charlie(), ETH, 50_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000002227501463063),\n\t\t\t\tborrow_rate: Rate::from_inner(2250017263),\n\t\t\t\tsupply_rate: Rate::from_inner(506257768)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(11000);\n\t\tassert_ok!(MinterestProtocol::borrow(charlie(), DOT, 50_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000000206632652786),\n\t\t\t\tborrow_rate: Rate::from_inner(2250001601),\n\t\t\t\tsupply_rate: Rate::from_inner(506250720)\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(12000);\n\t\tassert_ok!(MinterestProtocol::repay(charlie(), DOT, 70_000 * DOLLARS));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1000000712883477935),\n\t\t\t\tborrow_rate: Rate::from_inner(7128),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(13000);\n\t\tassert_ok!(MinterestProtocol::deposit_underlying(bob(), ETH, 10_000 * DOLLARS));\n\t\tSystem::set_block_number(13500);\n\t\tassert_ok!(MinterestProtocol::redeem(charlie(), ETH));\n\t\tSystem::set_block_number(14000);\n\t\tassert_ok!(MinterestProtocol::repay_all(charlie(), ETH));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_004_371_397_298_691),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(15000);\n\t\tassert_ok!(MinterestProtocol::redeem_underlying(charlie(), DOT, 50_000 * DOLLARS));\n\t\tSystem::set_block_number(16000);\n\t\tassert_ok!(MinterestProtocol::repay_all(charlie(), DOT));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_000_712_883_477_957),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t\tSystem::set_block_number(17000);\n\t\tassert_ok!(MinterestProtocol::redeem(charlie(), DOT));\n\t\tSystem::set_block_number(18000);\n\t\tassert_ok!(MinterestProtocol::redeem_underlying(bob(), DOT, 40_000 * DOLLARS));\n\t\tSystem::set_block_number(19000);\n\t\tassert_ok!(MinterestProtocol::redeem(bob(), DOT));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(DOT),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_000_712_883_477_958),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t\tassert_ok!(MinterestProtocol::redeem(bob(), ETH));\n\t\tassert_eq!(\n\t\t\tliquidity_pool_state_rpc(ETH),\n\t\t\tSome(PoolState {\n\t\t\t\texchange_rate: Rate::from_inner(1_000_004_371_397_298_690),\n\t\t\t\tborrow_rate: Rate::zero(),\n\t\t\t\tsupply_rate: Rate::zero()\n\t\t\t})\n\t\t);\n\t});\n}\n","traces":[{"line":24,"address":[5100689],"length":1,"stats":{"Line":2},"fn_name":null},{"line":25,"address":[5100769],"length":1,"stats":{"Line":2},"fn_name":null},{"line":26,"address":[5100849],"length":1,"stats":{"Line":2},"fn_name":null},{"line":34,"address":[5094887,5094832],"length":1,"stats":{"Line":2},"fn_name":"default"},{"line":36,"address":[5096086,5094857,5095706],"length":1,"stats":{"Line":4},"fn_name":null},{"line":53,"address":[5099690,5096128],"length":1,"stats":{"Line":2},"fn_name":"build"},{"line":54,"address":[5096139],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[5096308],"length":1,"stats":{"Line":2},"fn_name":null},{"line":61,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":83,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":109,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":130,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[],"length":0,"stats":{"Line":4},"fn_name":null},{"line":155,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":161,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[],"length":0,"stats":{"Line":2},"fn_name":null},{"line":165,"address":[],"length":0,"stats":{"Line":6},"fn_name":null},{"line":166,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[5100144],"length":1,"stats":{"Line":1},"fn_name":"pool_balance"},{"line":171,"address":[5100153],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[5100224],"length":1,"stats":{"Line":1},"fn_name":"pool_total_insurance"},{"line":175,"address":[5100233],"length":1,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[5100288],"length":1,"stats":{"Line":1},"fn_name":"liquidity_pool_state_rpc"},{"line":179,"address":[5100300],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[5100336],"length":1,"stats":{"Line":1},"fn_name":"dollars"},{"line":183,"address":[5100360],"length":1,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[5100432],"length":1,"stats":{"Line":2},"fn_name":"alice"},{"line":187,"address":[5100439],"length":1,"stats":{"Line":2},"fn_name":null},{"line":190,"address":[5100512],"length":1,"stats":{"Line":1},"fn_name":"bob"},{"line":191,"address":[5100519],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[5100592],"length":1,"stats":{"Line":1},"fn_name":"charlie"},{"line":195,"address":[5100599],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[4457696,4457701],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":200,"address":[4457728,4457836],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":201,"address":[4466711,4457741,4457851],"length":1,"stats":{"Line":2},"fn_name":null},{"line":202,"address":[4458206,4466752],"length":1,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[4458820,4458582],"length":1,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[4458763,4459122,4459287],"length":1,"stats":{"Line":2},"fn_name":null},{"line":206,"address":[4459257],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[4466793,4459580],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[4466834,4459956],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[4460332],"length":1,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[4460634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[4461323,4461189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[4460936],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[4461039],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[4460965],"length":1,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[4460987],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[4461009],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[4461300],"length":1,"stats":{"Line":1},"fn_name":null},{"line":224,"address":[4461624,4466875],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[4462000,4466916],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[4462376,4462606],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[4463291,4463157],"length":1,"stats":{"Line":1},"fn_name":null},{"line":229,"address":[4462557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[4463007],"length":1,"stats":{"Line":1},"fn_name":null},{"line":231,"address":[4462899],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[4462921],"length":1,"stats":{"Line":1},"fn_name":null},{"line":233,"address":[4462960],"length":1,"stats":{"Line":1},"fn_name":null},{"line":237,"address":[4463268],"length":1,"stats":{"Line":1},"fn_name":null},{"line":239,"address":[4466957,4463592],"length":1,"stats":{"Line":1},"fn_name":null},{"line":240,"address":[4466998,4463968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[4464648,4464782],"length":1,"stats":{"Line":1},"fn_name":null},{"line":243,"address":[4464344],"length":1,"stats":{"Line":1},"fn_name":null},{"line":244,"address":[4464498],"length":1,"stats":{"Line":1},"fn_name":null},{"line":245,"address":[4464373],"length":1,"stats":{"Line":1},"fn_name":null},{"line":246,"address":[4464412],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[4464451],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[4464759],"length":1,"stats":{"Line":1},"fn_name":null},{"line":253,"address":[4465083],"length":1,"stats":{"Line":1},"fn_name":null},{"line":254,"address":[4465385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":255,"address":[4465687,4467039],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[4466443,4466334],"length":1,"stats":{"Line":1},"fn_name":null},{"line":258,"address":[4466063],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[4466199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":260,"address":[4466092],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[4466128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[4466161],"length":1,"stats":{"Line":1},"fn_name":null},{"line":269,"address":[4467264,4467269],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":270,"address":[4467476,4467296],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":271,"address":[4467491,4486768,4467309],"length":1,"stats":{"Line":2},"fn_name":null},{"line":272,"address":[4467814],"length":1,"stats":{"Line":1},"fn_name":null},{"line":273,"address":[4486809,4467824],"length":1,"stats":{"Line":1},"fn_name":null},{"line":274,"address":[4468168],"length":1,"stats":{"Line":1},"fn_name":null},{"line":275,"address":[4468178,4486850],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[4468522],"length":1,"stats":{"Line":1},"fn_name":null},{"line":277,"address":[4486891,4468532],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[4468876],"length":1,"stats":{"Line":1},"fn_name":null},{"line":279,"address":[4468886,4486932],"length":1,"stats":{"Line":1},"fn_name":null},{"line":280,"address":[4469230],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[4486973,4469240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[4469584],"length":1,"stats":{"Line":1},"fn_name":null},{"line":284,"address":[4469594,4469729],"length":1,"stats":{"Line":2},"fn_name":null},{"line":285,"address":[4469616,4469713,4487014],"length":1,"stats":{"Line":2},"fn_name":null},{"line":286,"address":[4469721],"length":1,"stats":{"Line":1},"fn_name":null},{"line":288,"address":[4470813],"length":1,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[4470828],"length":1,"stats":{"Line":1},"fn_name":null},{"line":290,"address":[4471109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":291,"address":[4471124],"length":1,"stats":{"Line":1},"fn_name":null},{"line":292,"address":[4471405],"length":1,"stats":{"Line":1},"fn_name":null},{"line":293,"address":[4471420],"length":1,"stats":{"Line":1},"fn_name":null},{"line":294,"address":[4471717],"length":1,"stats":{"Line":1},"fn_name":null},{"line":295,"address":[4471724,4471864],"length":1,"stats":{"Line":2},"fn_name":null},{"line":296,"address":[4471848,4471751,4487055],"length":1,"stats":{"Line":2},"fn_name":null},{"line":297,"address":[4471856],"length":1,"stats":{"Line":1},"fn_name":null},{"line":299,"address":[4472948],"length":1,"stats":{"Line":1},"fn_name":null},{"line":300,"address":[4472963],"length":1,"stats":{"Line":1},"fn_name":null},{"line":302,"address":[4473260],"length":1,"stats":{"Line":1},"fn_name":null},{"line":303,"address":[4487096,4473275],"length":1,"stats":{"Line":1},"fn_name":null},{"line":304,"address":[4474013,4473885],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[4473591],"length":1,"stats":{"Line":1},"fn_name":null},{"line":306,"address":[4473729],"length":1,"stats":{"Line":1},"fn_name":null},{"line":307,"address":[4473622],"length":1,"stats":{"Line":1},"fn_name":null},{"line":308,"address":[4473649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":309,"address":[4473685],"length":1,"stats":{"Line":1},"fn_name":null},{"line":312,"address":[4473995],"length":1,"stats":{"Line":1},"fn_name":null},{"line":313,"address":[4487137,4474373],"length":1,"stats":{"Line":1},"fn_name":null},{"line":314,"address":[4474983,4475111],"length":1,"stats":{"Line":1},"fn_name":null},{"line":315,"address":[4474689],"length":1,"stats":{"Line":1},"fn_name":null},{"line":316,"address":[4474827],"length":1,"stats":{"Line":1},"fn_name":null},{"line":317,"address":[4474720],"length":1,"stats":{"Line":1},"fn_name":null},{"line":318,"address":[4474747],"length":1,"stats":{"Line":1},"fn_name":null},{"line":319,"address":[4474783],"length":1,"stats":{"Line":1},"fn_name":null},{"line":322,"address":[4475093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":323,"address":[4487178,4475471],"length":1,"stats":{"Line":1},"fn_name":null},{"line":324,"address":[4476095,4476223],"length":1,"stats":{"Line":1},"fn_name":null},{"line":325,"address":[4475787],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[4475939],"length":1,"stats":{"Line":1},"fn_name":null},{"line":327,"address":[4475818],"length":1,"stats":{"Line":1},"fn_name":null},{"line":328,"address":[4475859],"length":1,"stats":{"Line":1},"fn_name":null},{"line":329,"address":[4475895],"length":1,"stats":{"Line":1},"fn_name":null},{"line":332,"address":[4476205],"length":1,"stats":{"Line":1},"fn_name":null},{"line":333,"address":[4487219,4476583],"length":1,"stats":{"Line":1},"fn_name":null},{"line":334,"address":[4477340,4477212],"length":1,"stats":{"Line":1},"fn_name":null},{"line":335,"address":[4476899],"length":1,"stats":{"Line":1},"fn_name":null},{"line":336,"address":[4477056],"length":1,"stats":{"Line":1},"fn_name":null},{"line":337,"address":[4476930],"length":1,"stats":{"Line":1},"fn_name":null},{"line":338,"address":[4476971],"length":1,"stats":{"Line":1},"fn_name":null},{"line":339,"address":[4477012],"length":1,"stats":{"Line":1},"fn_name":null},{"line":342,"address":[4477322],"length":1,"stats":{"Line":1},"fn_name":null},{"line":343,"address":[4487260,4477700],"length":1,"stats":{"Line":1},"fn_name":null},{"line":344,"address":[4478452,4478324],"length":1,"stats":{"Line":1},"fn_name":null},{"line":345,"address":[4478016],"length":1,"stats":{"Line":1},"fn_name":null},{"line":346,"address":[4478168],"length":1,"stats":{"Line":1},"fn_name":null},{"line":347,"address":[4478047],"length":1,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[4478088],"length":1,"stats":{"Line":1},"fn_name":null},{"line":349,"address":[4478124],"length":1,"stats":{"Line":1},"fn_name":null},{"line":352,"address":[4478434],"length":1,"stats":{"Line":1},"fn_name":null},{"line":353,"address":[4487301,4478812],"length":1,"stats":{"Line":1},"fn_name":null},{"line":354,"address":[4479436,4479564],"length":1,"stats":{"Line":1},"fn_name":null},{"line":355,"address":[4479128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":356,"address":[4479280],"length":1,"stats":{"Line":1},"fn_name":null},{"line":357,"address":[4479159],"length":1,"stats":{"Line":1},"fn_name":null},{"line":358,"address":[4479200],"length":1,"stats":{"Line":1},"fn_name":null},{"line":359,"address":[4479236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[4479546],"length":1,"stats":{"Line":1},"fn_name":null},{"line":363,"address":[4487342,4479924],"length":1,"stats":{"Line":1},"fn_name":null},{"line":364,"address":[4480539,4480667],"length":1,"stats":{"Line":1},"fn_name":null},{"line":365,"address":[4480240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":366,"address":[4480383],"length":1,"stats":{"Line":1},"fn_name":null},{"line":367,"address":[4480271],"length":1,"stats":{"Line":1},"fn_name":null},{"line":368,"address":[4480312],"length":1,"stats":{"Line":1},"fn_name":null},{"line":369,"address":[4480348],"length":1,"stats":{"Line":1},"fn_name":null},{"line":372,"address":[4480649],"length":1,"stats":{"Line":1},"fn_name":null},{"line":373,"address":[4481027,4487383],"length":1,"stats":{"Line":1},"fn_name":null},{"line":374,"address":[4481348],"length":1,"stats":{"Line":1},"fn_name":null},{"line":375,"address":[4481363],"length":1,"stats":{"Line":1},"fn_name":null},{"line":376,"address":[4481644],"length":1,"stats":{"Line":1},"fn_name":null},{"line":377,"address":[4481659],"length":1,"stats":{"Line":1},"fn_name":null},{"line":378,"address":[4482353,4482225],"length":1,"stats":{"Line":1},"fn_name":null},{"line":379,"address":[4481935],"length":1,"stats":{"Line":1},"fn_name":null},{"line":380,"address":[4482069],"length":1,"stats":{"Line":1},"fn_name":null},{"line":381,"address":[4481966],"length":1,"stats":{"Line":1},"fn_name":null},{"line":382,"address":[4482007],"length":1,"stats":{"Line":1},"fn_name":null},{"line":383,"address":[4482034],"length":1,"stats":{"Line":1},"fn_name":null},{"line":386,"address":[4482335],"length":1,"stats":{"Line":1},"fn_name":null},{"line":387,"address":[4487424,4482713],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[4483034],"length":1,"stats":{"Line":1},"fn_name":null},{"line":389,"address":[4483049],"length":1,"stats":{"Line":1},"fn_name":null},{"line":390,"address":[4483743,4483615],"length":1,"stats":{"Line":1},"fn_name":null},{"line":391,"address":[4483325],"length":1,"stats":{"Line":1},"fn_name":null},{"line":392,"address":[4483459],"length":1,"stats":{"Line":1},"fn_name":null},{"line":393,"address":[4483356],"length":1,"stats":{"Line":1},"fn_name":null},{"line":394,"address":[4483397],"length":1,"stats":{"Line":1},"fn_name":null},{"line":395,"address":[4483424],"length":1,"stats":{"Line":1},"fn_name":null},{"line":398,"address":[4483725],"length":1,"stats":{"Line":1},"fn_name":null},{"line":399,"address":[4484103],"length":1,"stats":{"Line":1},"fn_name":null},{"line":400,"address":[4484384],"length":1,"stats":{"Line":1},"fn_name":null},{"line":401,"address":[4484399,4487465],"length":1,"stats":{"Line":1},"fn_name":null},{"line":402,"address":[4484720],"length":1,"stats":{"Line":1},"fn_name":null},{"line":403,"address":[4484735],"length":1,"stats":{"Line":1},"fn_name":null},{"line":404,"address":[4485432,4485301],"length":1,"stats":{"Line":1},"fn_name":null},{"line":405,"address":[4485011],"length":1,"stats":{"Line":1},"fn_name":null},{"line":406,"address":[4485145],"length":1,"stats":{"Line":1},"fn_name":null},{"line":407,"address":[4485042],"length":1,"stats":{"Line":1},"fn_name":null},{"line":408,"address":[4485083],"length":1,"stats":{"Line":1},"fn_name":null},{"line":409,"address":[4485110],"length":1,"stats":{"Line":1},"fn_name":null},{"line":412,"address":[4485414,4485784],"length":1,"stats":{"Line":2},"fn_name":null},{"line":413,"address":[4486445,4486325],"length":1,"stats":{"Line":1},"fn_name":null},{"line":414,"address":[4486053],"length":1,"stats":{"Line":1},"fn_name":null},{"line":415,"address":[4486178],"length":1,"stats":{"Line":1},"fn_name":null},{"line":416,"address":[4486084],"length":1,"stats":{"Line":1},"fn_name":null},{"line":417,"address":[4486125],"length":1,"stats":{"Line":1},"fn_name":null},{"line":418,"address":[4486149],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":202,"coverable":208},{"path":["/","home","lut1k","Projects","minterest-chain-node","service","src","chain_spec.rs"],"content":"use controller::{ControllerData, PauseKeeper};\nuse hex_literal::hex;\nuse liquidity_pools::Pool;\nuse minterest_model::MinterestModelData;\nuse node_minterest_runtime::{\n\tAccountId, AccountsConfig, AuraConfig, Balance, BalancesConfig, ControllerConfig, CurrencyId, GenesisConfig,\n\tGrandpaConfig, LiquidityPoolsConfig, MinterestModelConfig, Signature, SudoConfig, SystemConfig, TokensConfig,\n\tDOLLARS, WASM_BINARY,\n};\nuse sc_service::ChainType;\nuse sc_telemetry::TelemetryEndpoints;\nuse serde_json::map::Map;\nuse sp_consensus_aura::sr25519::AuthorityId as AuraId;\nuse sp_core::{sr25519, Pair, Public};\nuse sp_finality_grandpa::AuthorityId as GrandpaId;\nuse sp_runtime::{\n\ttraits::{IdentifyAccount, Verify, Zero},\n\tFixedPointNumber, FixedU128,\n};\n\n// The URL for the telemetry server.\n// const STAGING_TELEMETRY_URL: \u0026str = \"wss://telemetry.polkadot.io/submit/\";\n\nconst INITIAL_BALANCE: u128 = 100_000 * DOLLARS;\n\n// The URL for the telemetry server.\nconst STAGING_TELEMETRY_URL: \u0026str = \"wss://telemetry.polkadot.io/submit/\";\n\n/// Specialized `ChainSpec`. This is a specialization of the general Substrate ChainSpec type.\npub type ChainSpec = sc_service::GenericChainSpec\u003cGenesisConfig\u003e;\n\n/// Generate a crypto pair from seed.\npub fn get_from_seed\u003cTPublic: Public\u003e(seed: \u0026str) -\u003e \u003cTPublic::Pair as Pair\u003e::Public {\n\tTPublic::Pair::from_string(\u0026format!(\"//{}\", seed), None)\n\t\t.expect(\"static values are valid; qed\")\n\t\t.public()\n}\n\ntype AccountPublic = \u003cSignature as Verify\u003e::Signer;\n\n/// Generate an account ID from seed.\npub fn get_account_id_from_seed\u003cTPublic: Public\u003e(seed: \u0026str) -\u003e AccountId\nwhere\n\tAccountPublic: From\u003c\u003cTPublic::Pair as Pair\u003e::Public\u003e,\n{\n\tAccountPublic::from(get_from_seed::\u003cTPublic\u003e(seed)).into_account()\n}\n\n/// Generate an Aura authority key.\npub fn authority_keys_from_seed(seed: \u0026str) -\u003e (AuraId, GrandpaId) {\n\t(get_from_seed::\u003cAuraId\u003e(seed), get_from_seed::\u003cGrandpaId\u003e(seed))\n}\n\npub fn development_config() -\u003e Result\u003cChainSpec, String\u003e {\n\tlet mut properties = Map::new();\n\tproperties.insert(\"tokenSymbol\".into(), \"MNT\".into());\n\tproperties.insert(\"tokenDecimals\".into(), 18.into());\n\n\tlet wasm_binary = WASM_BINARY.ok_or_else(|| \"Development wasm binary not available\".to_string())?;\n\n\tOk(ChainSpec::from_genesis(\n\t\t// Name\n\t\t\"Development\",\n\t\t// ID\n\t\t\"dev\",\n\t\tChainType::Development,\n\t\tmove || {\n\t\t\ttestnet_genesis(\n\t\t\t\twasm_binary,\n\t\t\t\t// Initial PoA authorities\n\t\t\t\tvec![authority_keys_from_seed(\"Alice\")],\n\t\t\t\t// Sudo account\n\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t// Pre-funded accounts\n\t\t\t\tvec![\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob//stash\"),\n\t\t\t\t],\n\t\t\t\ttrue,\n\t\t\t)\n\t\t},\n\t\t// Bootnodes\n\t\tvec![],\n\t\t// Telemetry\n\t\tNone,\n\t\t// Protocol ID\n\t\tNone,\n\t\t// Properties\n\t\tSome(properties),\n\t\t// Extensions\n\t\tNone,\n\t))\n}\n\npub fn local_testnet_config() -\u003e Result\u003cChainSpec, String\u003e {\n\tlet mut properties = Map::new();\n\tproperties.insert(\"tokenSymbol\".into(), \"MNT\".into());\n\tproperties.insert(\"tokenDecimals\".into(), 18.into());\n\n\tlet wasm_binary = WASM_BINARY.ok_or_else(|| \"Development wasm binary not available\".to_string())?;\n\n\tOk(ChainSpec::from_genesis(\n\t\t// Name\n\t\t\"Local Testnet\",\n\t\t// ID\n\t\t\"local_testnet\",\n\t\tChainType::Local,\n\t\tmove || {\n\t\t\ttestnet_genesis(\n\t\t\t\twasm_binary,\n\t\t\t\t// Initial PoA authorities\n\t\t\t\tvec![authority_keys_from_seed(\"Alice\"), authority_keys_from_seed(\"Bob\")],\n\t\t\t\t// Sudo account\n\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t// Pre-funded accounts\n\t\t\t\tvec![\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Charlie\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Dave\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Eve\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Ferdie\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Charlie//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Dave//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Eve//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Ferdie//stash\"),\n\t\t\t\t],\n\t\t\t\ttrue,\n\t\t\t)\n\t\t},\n\t\t// Bootnodes\n\t\tvec![],\n\t\t// Telemetry\n\t\tNone,\n\t\t// Protocol ID\n\t\tNone,\n\t\t// Properties\n\t\tSome(properties),\n\t\t// Extensions\n\t\tNone,\n\t))\n}\n\npub fn minterest_turbo_testnet_config() -\u003e Result\u003cChainSpec, String\u003e {\n\tlet mut properties = Map::new();\n\tproperties.insert(\"tokenSymbol\".into(), \"MNT\".into());\n\tproperties.insert(\"tokenDecimals\".into(), 18.into());\n\n\tlet wasm_binary = WASM_BINARY.ok_or_else(|| \"Development wasm binary not available\".to_string())?;\n\n\tOk(ChainSpec::from_genesis(\n\t\t\"Minterest Turbo\",\n\t\t\"turbo-latest\",\n\t\tChainType::Live,\n\t\tmove || {\n\t\t\ttestnet_genesis(\n\t\t\t\twasm_binary,\n\t\t\t\t// Initial PoA authorities\n\t\t\t\tvec![authority_keys_from_seed(\"Alice\")],\n\t\t\t\t// Sudo account\n\t\t\t\t// 5ER9G3d2V4EEq8VjEbjkGbMdgprvtCntTYu9itCRJNHTkWYX\n\t\t\t\thex![\"680ee3a95d0b19619d9483fdee34f5d0016fbadd7145d016464f6bfbb993b46b\"].into(),\n\t\t\t\t// Pre-funded accounts\n\t\t\t\tvec![\n\t\t\t\t\thex![\"680ee3a95d0b19619d9483fdee34f5d0016fbadd7145d016464f6bfbb993b46b\"].into(),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice//stash\"),\n\t\t\t\t\tget_account_id_from_seed::\u003csr25519::Public\u003e(\"Bob//stash\"),\n\t\t\t\t],\n\t\t\t\ttrue,\n\t\t\t)\n\t\t},\n\t\t// Bootnodes\n\t\tvec![],\n\t\t// Telemetry\n\t\tSome(\n\t\t\tTelemetryEndpoints::new(vec![(STAGING_TELEMETRY_URL.to_string(), 0)])\n\t\t\t\t.expect(\"Staging telemetry url is valid; qed\"),\n\t\t),\n\t\t// Protocol ID\n\t\tSome(\"turbo-latest\"),\n\t\t// Properties\n\t\tSome(properties),\n\t\t// Extensions\n\t\tDefault::default(),\n\t))\n}\n\n/// Configure initial storage state for FRAME modules.\nfn testnet_genesis(\n\twasm_binary: \u0026[u8],\n\tinitial_authorities: Vec\u003c(AuraId, GrandpaId)\u003e,\n\troot_key: AccountId,\n\tendowed_accounts: Vec\u003cAccountId\u003e,\n\t_enable_println: bool,\n) -\u003e GenesisConfig {\n\tGenesisConfig {\n\t\tframe_system: Some(SystemConfig {\n\t\t\t// Add Wasm runtime to storage.\n\t\t\tcode: wasm_binary.to_vec(),\n\t\t\tchanges_trie_config: Default::default(),\n\t\t}),\n\t\tpallet_balances: Some(BalancesConfig {\n\t\t\t// Configure endowed accounts with initial balance of 1 \u003c\u003c 60.\n\t\t\tbalances: endowed_accounts.iter().cloned().map(|k| (k, 1 \u003c\u003c 60)).collect(),\n\t\t}),\n\t\tpallet_aura: Some(AuraConfig {\n\t\t\tauthorities: initial_authorities.iter().map(|x| (x.0.clone())).collect(),\n\t\t}),\n\t\tpallet_grandpa: Some(GrandpaConfig {\n\t\t\tauthorities: initial_authorities.iter().map(|x| (x.1.clone(), 1)).collect(),\n\t\t}),\n\t\tpallet_sudo: Some(SudoConfig {\n\t\t\t// Assign network admin rights.\n\t\t\tkey: root_key,\n\t\t}),\n\t\torml_tokens: Some(TokensConfig {\n\t\t\tendowed_accounts: endowed_accounts\n\t\t\t\t.iter()\n\t\t\t\t.flat_map(|x| {\n\t\t\t\t\tvec![\n\t\t\t\t\t\t(x.clone(), CurrencyId::DOT, INITIAL_BALANCE),\n\t\t\t\t\t\t(x.clone(), CurrencyId::ETH, INITIAL_BALANCE),\n\t\t\t\t\t]\n\t\t\t\t})\n\t\t\t\t.collect(),\n\t\t}),\n\t\tliquidity_pools: Some(LiquidityPoolsConfig {\n\t\t\tpools: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: FixedU128::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: FixedU128::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: FixedU128::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tPool {\n\t\t\t\t\t\ttotal_borrowed: Balance::zero(),\n\t\t\t\t\t\tborrow_index: FixedU128::one(),\n\t\t\t\t\t\ttotal_insurance: Balance::zero(),\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpool_user_data: vec![],\n\t\t}),\n\t\tcontroller: Some(ControllerConfig {\n\t\t\tcontroller_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: FixedU128::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: FixedU128::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: FixedU128::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: FixedU128::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: FixedU128::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: FixedU128::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: FixedU128::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: FixedU128::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: FixedU128::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tControllerData {\n\t\t\t\t\t\ttimestamp: 0,\n\t\t\t\t\t\tinsurance_factor: FixedU128::saturating_from_rational(1, 10),\n\t\t\t\t\t\tmax_borrow_rate: FixedU128::saturating_from_rational(5, 1000),\n\t\t\t\t\t\tcollateral_factor: FixedU128::saturating_from_rational(9, 10), // 90%\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t\tpause_keepers: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tPauseKeeper {\n\t\t\t\t\t\tdeposit_paused: false,\n\t\t\t\t\t\tredeem_paused: false,\n\t\t\t\t\t\tborrow_paused: false,\n\t\t\t\t\t\trepay_paused: false,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}),\n\t\taccounts: Some(AccountsConfig {\n\t\t\tallowed_accounts: vec![(get_account_id_from_seed::\u003csr25519::Public\u003e(\"Alice\"), ())],\n\t\t}),\n\t\tminterest_model: Some(MinterestModelConfig {\n\t\t\tminterest_model_dates: vec![\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::ETH,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: FixedU128::saturating_from_rational(8, 10), // 0.8 = 80 %\n\t\t\t\t\t\tbase_rate_per_block: FixedU128::zero(),\n\t\t\t\t\t\tmultiplier_per_block: FixedU128::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: FixedU128::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::DOT,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: FixedU128::saturating_from_rational(8, 10), // 0.8 = 80 %\n\t\t\t\t\t\tbase_rate_per_block: FixedU128::zero(),\n\t\t\t\t\t\tmultiplier_per_block: FixedU128::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: FixedU128::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::KSM,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: FixedU128::saturating_from_rational(8, 10), // 0.8 = 80 %\n\t\t\t\t\t\tbase_rate_per_block: FixedU128::zero(),\n\t\t\t\t\t\tmultiplier_per_block: FixedU128::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: FixedU128::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\t(\n\t\t\t\t\tCurrencyId::BTC,\n\t\t\t\t\tMinterestModelData {\n\t\t\t\t\t\tkink: FixedU128::saturating_from_rational(8, 10), // 0.8 = 80 %\n\t\t\t\t\t\tbase_rate_per_block: FixedU128::zero(),\n\t\t\t\t\t\tmultiplier_per_block: FixedU128::saturating_from_rational(9, 1_000_000_000), // 0.047304 PerYear\n\t\t\t\t\t\tjump_multiplier_per_block: FixedU128::saturating_from_rational(207, 1_000_000_000), // 1.09 PerYear\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t],\n\t\t}),\n\t}\n}\n","traces":[{"line":33,"address":[22983690,22983600,22984096,22983194,22983104,22984186],"length":1,"stats":{"Line":0},"fn_name":"get_from_seed\u003csp_core::sr25519::Public\u003e"},{"line":34,"address":[22983936,22984432,22983221,22983627,22983440,22983717,22984123,22983131,22984213],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[22984592],"length":1,"stats":{"Line":0},"fn_name":"get_account_id_from_seed\u003csp_core::sr25519::Public\u003e"},{"line":46,"address":[22984609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[5314800],"length":1,"stats":{"Line":0},"fn_name":"authority_keys_from_seed"},{"line":51,"address":[5314817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[5314960,5315035],"length":1,"stats":{"Line":0},"fn_name":"development_config"},{"line":55,"address":[5314970],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[5316025,5315050],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[5315185,5316061],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[5315315,5315499,5315618,5315652],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[5315931,5315764],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[5315441],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[5315461],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[22985185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[22984738],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[22984839,22984769,22985266],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[22984896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[22985054,22984933,22985319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[22984946],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[22984973],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[22985000],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[22985027],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[5315477],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[5315654],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[5315666],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[5315678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[5315756],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[5316224,5316299],"length":1,"stats":{"Line":0},"fn_name":"local_testnet_config"},{"line":98,"address":[5316234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[5317289,5316314],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[5317325,5316449],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[5316882,5316579,5316763,5316916],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[5317195,5317028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[5316705],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[5316725],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[22986439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[22985458],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[22986520,22985489,22985559],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[22985694],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[22986573,22985731,22986068],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[22985744],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[22985771],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[22985798],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[22985825],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[22985852],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[22985879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[22985906],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[22985933],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[22985960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[22985987],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[22986014],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[22986041],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[5316741],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[5316918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[5316930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[5316942],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[5317020],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[5317488,5317587],"length":1,"stats":{"Line":0},"fn_name":"minterest_turbo_testnet_config"},{"line":149,"address":[5317498],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[5318968,5317602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[5319004,5317737],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[5318051,5317867,5318170,5318204],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[5318874,5318654],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[5317993],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[5318013],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[22987722],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[22986706],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[22986737,22987803,22986807],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[22986864],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[22987561,22987157,22987856],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[22987170],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[22987453],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[22987480],"length":1,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[22987507],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[22987534],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[5318029],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[5318206,5318451],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[5318382,5319100,5318224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[5318491],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[5318518],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[5318604],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[5319344,5319454],"length":1,"stats":{"Line":0},"fn_name":"testnet_genesis"},{"line":203,"address":[5319590],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[5319917],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[5320140],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[5320363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":218,"address":[5320458],"length":1,"stats":{"Line":0},"fn_name":null},{"line":222,"address":[5320673],"length":1,"stats":{"Line":0},"fn_name":null},{"line":233,"address":[5322005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[5323978],"length":1,"stats":{"Line":0},"fn_name":null},{"line":348,"address":[5324265],"length":1,"stats":{"Line":0},"fn_name":null},{"line":351,"address":[5325959],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":93},{"path":["/","home","lut1k","Projects","minterest-chain-node","service","src","lib.rs"],"content":"//! Service and ServiceFactory implementation. Specialized wrapper over substrate service.\n// Disable the following lints\n#![allow(clippy::type_complexity)]\n\nuse node_minterest_runtime::{self, opaque::Block, RuntimeApi};\nuse sc_client_api::{ExecutorProvider, RemoteBackend};\nuse sc_executor::native_executor_instance;\npub use sc_executor::NativeExecutor;\nuse sc_finality_grandpa::{FinalityProofProvider as GrandpaFinalityProofProvider, SharedVoterState};\nuse sc_service::{error::Error as ServiceError, Configuration, TaskManager};\nuse sp_consensus_aura::sr25519::AuthorityPair as AuraPair;\nuse sp_inherents::InherentDataProviders;\nuse std::sync::Arc;\nuse std::time::Duration;\n\npub mod chain_spec;\n\n// Our native executor instance.\nnative_executor_instance!(\n\tpub Executor,\n\tnode_minterest_runtime::api::dispatch,\n\tnode_minterest_runtime::native_version,\n\tframe_benchmarking::benchmarking::HostFunctions,\n);\n\ntype FullClient = sc_service::TFullClient\u003cBlock, RuntimeApi, Executor\u003e;\ntype FullBackend = sc_service::TFullBackend\u003cBlock\u003e;\ntype FullSelectChain = sc_consensus::LongestChain\u003cFullBackend, Block\u003e;\n\npub fn new_partial(\n\tconfig: \u0026Configuration,\n) -\u003e Result\u003c\n\tsc_service::PartialComponents\u003c\n\t\tFullClient,\n\t\tFullBackend,\n\t\tFullSelectChain,\n\t\tsp_consensus::DefaultImportQueue\u003cBlock, FullClient\u003e,\n\t\tsc_transaction_pool::FullPool\u003cBlock, FullClient\u003e,\n\t\t(\n\t\t\tsc_consensus_aura::AuraBlockImport\u003c\n\t\t\t\tBlock,\n\t\t\t\tFullClient,\n\t\t\t\tsc_finality_grandpa::GrandpaBlockImport\u003cFullBackend, Block, FullClient, FullSelectChain\u003e,\n\t\t\t\tAuraPair,\n\t\t\t\u003e,\n\t\t\tsc_finality_grandpa::LinkHalf\u003cBlock, FullClient, FullSelectChain\u003e,\n\t\t),\n\t\u003e,\n\tServiceError,\n\u003e {\n\tlet inherent_data_providers = sp_inherents::InherentDataProviders::new();\n\n\tlet (client, backend, keystore, task_manager) = sc_service::new_full_parts::\u003cBlock, RuntimeApi, Executor\u003e(\u0026config)?;\n\tlet client = Arc::new(client);\n\n\tlet select_chain = sc_consensus::LongestChain::new(backend.clone());\n\n\tlet transaction_pool = sc_transaction_pool::BasicPool::new_full(\n\t\tconfig.transaction_pool.clone(),\n\t\tconfig.prometheus_registry(),\n\t\ttask_manager.spawn_handle(),\n\t\tclient.clone(),\n\t);\n\n\tlet (grandpa_block_import, grandpa_link) =\n\t\tsc_finality_grandpa::block_import(client.clone(), \u0026(client.clone() as Arc\u003c_\u003e), select_chain.clone())?;\n\n\tlet aura_block_import =\n\t\tsc_consensus_aura::AuraBlockImport::\u003c_, _, _, AuraPair\u003e::new(grandpa_block_import.clone(), client.clone());\n\n\tlet import_queue = sc_consensus_aura::import_queue::\u003c_, _, _, AuraPair, _, _\u003e(\n\t\tsc_consensus_aura::slot_duration(\u0026*client)?,\n\t\taura_block_import.clone(),\n\t\tSome(Box::new(grandpa_block_import)),\n\t\tNone,\n\t\tclient.clone(),\n\t\tinherent_data_providers.clone(),\n\t\t\u0026task_manager.spawn_handle(),\n\t\tconfig.prometheus_registry(),\n\t\tsp_consensus::CanAuthorWithNativeVersion::new(client.executor().clone()),\n\t)?;\n\n\tOk(sc_service::PartialComponents {\n\t\tclient,\n\t\tbackend,\n\t\ttask_manager,\n\t\timport_queue,\n\t\tkeystore,\n\t\tselect_chain,\n\t\ttransaction_pool,\n\t\tinherent_data_providers,\n\t\tother: (aura_block_import, grandpa_link),\n\t})\n}\n\n/// Builds a new service for a full client.\npub fn new_full(config: Configuration) -\u003e Result\u003cTaskManager, ServiceError\u003e {\n\tlet sc_service::PartialComponents {\n\t\tclient,\n\t\tbackend,\n\t\tmut task_manager,\n\t\timport_queue,\n\t\tkeystore,\n\t\tselect_chain,\n\t\ttransaction_pool,\n\t\tinherent_data_providers,\n\t\tother: (block_import, grandpa_link),\n\t} = new_partial(\u0026config)?;\n\n\tlet finality_proof_provider = GrandpaFinalityProofProvider::new_for_service(backend.clone(), client.clone());\n\n\tlet (network, network_status_sinks, system_rpc_tx, network_starter) =\n\t\tsc_service::build_network(sc_service::BuildNetworkParams {\n\t\t\tconfig: \u0026config,\n\t\t\tclient: client.clone(),\n\t\t\ttransaction_pool: transaction_pool.clone(),\n\t\t\tspawn_handle: task_manager.spawn_handle(),\n\t\t\timport_queue,\n\t\t\ton_demand: None,\n\t\t\tblock_announce_validator_builder: None,\n\t\t\tfinality_proof_request_builder: None,\n\t\t\tfinality_proof_provider: Some(finality_proof_provider),\n\t\t})?;\n\n\tif config.offchain_worker.enabled {\n\t\tsc_service::build_offchain_workers(\n\t\t\t\u0026config,\n\t\t\tbackend.clone(),\n\t\t\ttask_manager.spawn_handle(),\n\t\t\tclient.clone(),\n\t\t\tnetwork.clone(),\n\t\t);\n\t}\n\n\tlet role = config.role.clone();\n\tlet force_authoring = config.force_authoring;\n\tlet name = config.network.node_name.clone();\n\tlet enable_grandpa = !config.disable_grandpa;\n\tlet prometheus_registry = config.prometheus_registry().cloned();\n\tlet telemetry_connection_sinks = sc_service::TelemetryConnectionSinks::default();\n\n\tlet rpc_extensions_builder = {\n\t\tlet client = client.clone();\n\t\tlet pool = transaction_pool.clone();\n\n\t\tBox::new(move |deny_unsafe, _| {\n\t\t\tlet deps = minterest_rpc::FullDeps {\n\t\t\t\tclient: client.clone(),\n\t\t\t\tpool: pool.clone(),\n\t\t\t\tdeny_unsafe,\n\t\t\t};\n\n\t\t\tminterest_rpc::create_full(deps)\n\t\t})\n\t};\n\n\tsc_service::spawn_tasks(sc_service::SpawnTasksParams {\n\t\tnetwork: network.clone(),\n\t\tclient: client.clone(),\n\t\tkeystore: keystore.clone(),\n\t\ttask_manager: \u0026mut task_manager,\n\t\ttransaction_pool: transaction_pool.clone(),\n\t\ttelemetry_connection_sinks: telemetry_connection_sinks.clone(),\n\t\trpc_extensions_builder,\n\t\ton_demand: None,\n\t\tremote_blockchain: None,\n\t\tbackend,\n\t\tnetwork_status_sinks,\n\t\tsystem_rpc_tx,\n\t\tconfig,\n\t})?;\n\n\tif role.is_authority() {\n\t\tlet proposer =\n\t\t\tsc_basic_authorship::ProposerFactory::new(client.clone(), transaction_pool, prometheus_registry.as_ref());\n\n\t\tlet can_author_with = sp_consensus::CanAuthorWithNativeVersion::new(client.executor().clone());\n\n\t\tlet aura = sc_consensus_aura::start_aura::\u003c_, _, _, _, _, AuraPair, _, _, _\u003e(\n\t\t\tsc_consensus_aura::slot_duration(\u0026*client)?,\n\t\t\tclient.clone(),\n\t\t\tselect_chain,\n\t\t\tblock_import,\n\t\t\tproposer,\n\t\t\tnetwork.clone(),\n\t\t\tinherent_data_providers.clone(),\n\t\t\tforce_authoring,\n\t\t\tkeystore.clone(),\n\t\t\tcan_author_with,\n\t\t)?;\n\n\t\t// the AURA authoring task is considered essential, i.e. if it\n\t\t// fails we take down the service with it.\n\t\ttask_manager.spawn_essential_handle().spawn_blocking(\"aura\", aura);\n\t}\n\n\t// if the node isn't actively participating in consensus then it doesn't\n\t// need a keystore, regardless of which protocol we use below.\n\tlet keystore = if role.is_authority() {\n\t\tSome(keystore as sp_core::traits::BareCryptoStorePtr)\n\t} else {\n\t\tNone\n\t};\n\n\tlet grandpa_config = sc_finality_grandpa::Config {\n\t\t// FIXME #1578 make this available through chainspec\n\t\tgossip_duration: Duration::from_millis(333),\n\t\tjustification_period: 512,\n\t\tname: Some(name),\n\t\tobserver_enabled: false,\n\t\tkeystore,\n\t\tis_authority: role.is_network_authority(),\n\t};\n\n\tif enable_grandpa {\n\t\t// start the full GRANDPA voter\n\t\t// NOTE: non-authorities could run the GRANDPA observer protocol, but at\n\t\t// this point the full voter should provide better guarantees of block\n\t\t// and vote data availability than the observer. The observer has not\n\t\t// been tested extensively yet and having most nodes in a network run it\n\t\t// could lead to finality stalls.\n\t\tlet grandpa_config = sc_finality_grandpa::GrandpaParams {\n\t\t\tconfig: grandpa_config,\n\t\t\tlink: grandpa_link,\n\t\t\tnetwork,\n\t\t\tinherent_data_providers,\n\t\t\ttelemetry_on_connect: Some(telemetry_connection_sinks.on_connect_stream()),\n\t\t\tvoting_rule: sc_finality_grandpa::VotingRulesBuilder::default().build(),\n\t\t\tprometheus_registry,\n\t\t\tshared_voter_state: SharedVoterState::empty(),\n\t\t};\n\n\t\t// the GRANDPA voter task is considered infallible, i.e.\n\t\t// if it fails we take down the service with it.\n\t\ttask_manager\n\t\t\t.spawn_essential_handle()\n\t\t\t.spawn_blocking(\"grandpa-voter\", sc_finality_grandpa::run_grandpa_voter(grandpa_config)?);\n\t} else {\n\t\tsc_finality_grandpa::setup_disabled_grandpa(client, \u0026inherent_data_providers, network)?;\n\t}\n\n\tnetwork_starter.start_network();\n\tOk(task_manager)\n}\n\n/// Builds a new service for a light client.\npub fn new_light(config: Configuration) -\u003e Result\u003cTaskManager, ServiceError\u003e {\n\tlet (client, backend, keystore, mut task_manager, on_demand) =\n\t\tsc_service::new_light_parts::\u003cBlock, RuntimeApi, Executor\u003e(\u0026config)?;\n\n\tlet transaction_pool = Arc::new(sc_transaction_pool::BasicPool::new_light(\n\t\tconfig.transaction_pool.clone(),\n\t\tconfig.prometheus_registry(),\n\t\ttask_manager.spawn_handle(),\n\t\tclient.clone(),\n\t\ton_demand.clone(),\n\t));\n\n\tlet grandpa_block_import = sc_finality_grandpa::light_block_import(\n\t\tclient.clone(),\n\t\tbackend.clone(),\n\t\t\u0026(client.clone() as Arc\u003c_\u003e),\n\t\tArc::new(on_demand.checker().clone()) as Arc\u003c_\u003e,\n\t)?;\n\tlet finality_proof_import = grandpa_block_import.clone();\n\tlet finality_proof_request_builder = finality_proof_import.create_finality_proof_request_builder();\n\n\tlet import_queue = sc_consensus_aura::import_queue::\u003c_, _, _, AuraPair, _, _\u003e(\n\t\tsc_consensus_aura::slot_duration(\u0026*client)?,\n\t\tgrandpa_block_import,\n\t\tNone,\n\t\tSome(Box::new(finality_proof_import)),\n\t\tclient.clone(),\n\t\tInherentDataProviders::new(),\n\t\t\u0026task_manager.spawn_handle(),\n\t\tconfig.prometheus_registry(),\n\t\tsp_consensus::NeverCanAuthor,\n\t)?;\n\n\tlet finality_proof_provider = GrandpaFinalityProofProvider::new_for_service(backend.clone(), client.clone());\n\n\tlet (network, network_status_sinks, system_rpc_tx, network_starter) =\n\t\tsc_service::build_network(sc_service::BuildNetworkParams {\n\t\t\tconfig: \u0026config,\n\t\t\tclient: client.clone(),\n\t\t\ttransaction_pool: transaction_pool.clone(),\n\t\t\tspawn_handle: task_manager.spawn_handle(),\n\t\t\timport_queue,\n\t\t\ton_demand: Some(on_demand.clone()),\n\t\t\tblock_announce_validator_builder: None,\n\t\t\tfinality_proof_request_builder: Some(finality_proof_request_builder),\n\t\t\tfinality_proof_provider: Some(finality_proof_provider),\n\t\t})?;\n\n\tif config.offchain_worker.enabled {\n\t\tsc_service::build_offchain_workers(\n\t\t\t\u0026config,\n\t\t\tbackend.clone(),\n\t\t\ttask_manager.spawn_handle(),\n\t\t\tclient.clone(),\n\t\t\tnetwork.clone(),\n\t\t);\n\t}\n\n\tsc_service::spawn_tasks(sc_service::SpawnTasksParams {\n\t\tremote_blockchain: Some(backend.remote_blockchain()),\n\t\ttransaction_pool,\n\t\ttask_manager: \u0026mut task_manager,\n\t\ton_demand: Some(on_demand),\n\t\trpc_extensions_builder: Box::new(|_, _| ()),\n\t\ttelemetry_connection_sinks: sc_service::TelemetryConnectionSinks::default(),\n\t\tconfig,\n\t\tclient,\n\t\tkeystore,\n\t\tbackend,\n\t\tnetwork,\n\t\tnetwork_status_sinks,\n\t\tsystem_rpc_tx,\n\t})?;\n\n\tnetwork_starter.start_network();\n\n\tOk(task_manager)\n}\n","traces":[{"line":30,"address":[17575208,17575072],"length":1,"stats":{"Line":0},"fn_name":"new_partial"},{"line":51,"address":[17575096],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[17575285,17575223,17575875,17575664,17575852],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[17575568,17575950],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[17576027,17575966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[17576035],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[17576065],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[17576107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[17576150],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[17576661],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[17579837,17577240],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[17577405,17577431,17577333,17577714,17577481],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[17577471,17577719],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[17577727,17577917],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[17577956],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[17578056,17577984],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[17578126,17578080],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[17578142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[17578192],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[17578357,17578251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[17579432],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[17579046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[17579054],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[17579062],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[17579146],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[17579200],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[17579208],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[17579216],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[17579224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[17579232],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[17580963,17580592],"length":1,"stats":{"Line":0},"fn_name":"new_full"},{"line":98,"address":[17581658,17581847,17580609,17580994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[17581137],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[17581161],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[17581185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[17581232],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[17581304],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[17581328],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[17581352],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[17581376],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[17581400],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[17582030,17590575,17581640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[17583087,17582790,17582425,17582822],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[17582155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[17582194],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[17582225],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[17582270],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[17582342],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[17582354],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[17582366],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[17582378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[17583567,17583069,17583858],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[17583580],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[17583619],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[17583662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[17583709],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[17583868],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[17583898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[17583911],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[17583962],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[17583978,17584034],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[17584073],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[17584112],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[17584201,17584159],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[5326890,5326816],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":147,"address":[5326951],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[5326861,5326910],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[5326920],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[5326981],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[17585232,17584866,17585307,17585261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[17584401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[17584482,17584440],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[17584498,17584536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[17584590,17584552],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[17584606],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[17584636],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[17584652],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[17584664],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[17584676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[17584692],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[17584716],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[17584756],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[17585656],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[17585708,17591317],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[17585908],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[17586008,17586141,17586374,17586091],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[17586387,17586123],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[17586403],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[17586435],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[17586579],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[17586635],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[17586682,17586756],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[17586780],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[17586795],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[17587239,17587480],"length":1,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[17587693,17587634],"length":1,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[17587702],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[17587673],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[17587747],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[17587784],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[17587896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[17589614,17588117,17589558],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[17588409],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[17588476,17588571],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[17588626],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[17589253,17588924],"length":1,"stats":{"Line":0},"fn_name":null},{"line":237,"address":[17589531,17589299,17588970,17589085],"length":1,"stats":{"Line":0},"fn_name":null},{"line":239,"address":[17589579,17589619,17588143],"length":1,"stats":{"Line":0},"fn_name":null},{"line":242,"address":[17589770],"length":1,"stats":{"Line":0},"fn_name":null},{"line":243,"address":[17589797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[17593152,17593429],"length":1,"stats":{"Line":0},"fn_name":"new_light"},{"line":248,"address":[17593603],"length":1,"stats":{"Line":0},"fn_name":null},{"line":251,"address":[17594197,17594292],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[17593746],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[17594065],"length":1,"stats":{"Line":0},"fn_name":null},{"line":254,"address":[17594092],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[17594135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[17594182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[17594339],"length":1,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[17594378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[17594417,17594458],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[17594614,17594543,17594505],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[17595267],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[17595290],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[17595361,17595447,17595686,17595932,17595875],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[17595463],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[17595527],"length":1,"stats":{"Line":0},"fn_name":null},{"line":272,"address":[17595547,17595937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[17596079,17595984],"length":1,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[17596095],"length":1,"stats":{"Line":0},"fn_name":null},{"line":275,"address":[17596130],"length":1,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[17596191],"length":1,"stats":{"Line":0},"fn_name":null},{"line":280,"address":[17596960,17600920],"length":1,"stats":{"Line":0},"fn_name":null},{"line":282,"address":[17597960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[17597108],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[17597147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[17597178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[17597223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[17597303,17597341],"length":1,"stats":{"Line":0},"fn_name":null},{"line":290,"address":[17597349],"length":1,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[17597361],"length":1,"stats":{"Line":0},"fn_name":null},{"line":292,"address":[17597401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[17598690,17598112,17598399],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[17598412],"length":1,"stats":{"Line":0},"fn_name":null},{"line":299,"address":[17598451],"length":1,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[17598494],"length":1,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[17598541],"length":1,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[17599653,17599607,17599198],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[17598700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":307,"address":[17598778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":309,"address":[17598802],"length":1,"stats":{"Line":0},"fn_name":null},{"line":310,"address":[5327131,5327104],"length":1,"stats":{"Line":0},"fn_name":"{{closure}}"},{"line":311,"address":[17598947],"length":1,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[17598977],"length":1,"stats":{"Line":0},"fn_name":null},{"line":313,"address":[17599054],"length":1,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[17599070],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[17599086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":316,"address":[17599102],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[17599118],"length":1,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[17599142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":321,"address":[17599863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[17599890],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":162},{"path":["/","home","lut1k","Projects","minterest-chain-node","src","main.rs"],"content":"fn main() -\u003e minterest_cli::Result\u003c()\u003e {\n\tminterest_cli::run()\n}\n","traces":[{"line":1,"address":[4273232],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":2,"address":[4273240],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":2}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, pathToString(file.path)),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('div', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('pre', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>